<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Eventos - Integrado</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='20' cy='20' r='10' fill='%234f46e5'/><circle cx='80' cy='30' r='8' fill='%234f46e5'/><circle cx='50' cy='70' r='12' fill='%234f46e5'/><line x1='20' y1='20' x2='80' y2='30' stroke='%234f46e5' stroke-width='5'/><line x1='80' y1='30' x2='50' y2='70' stroke='%234f46e5' stroke-width='5'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --glow-color: hsl(224, 88%, 66%);
            --primary: #4f46e5;
            --secondary: #a855f7;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-muted: #6b7280;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Light gray background */
            color: #1f2937;
            /* gray-800 */
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .header-title {
            background: linear-gradient(to right, #4f46e5, #a855f7);
            /* Indigo to Purple */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .modal-box.glassmorphism {
            background: rgba(255, 255, 255, 0.75);
        }

        .shiny-btn {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 51%, #4f46e5 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(60, 78, 224, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(60, 78, 224, 0.6);
        }

        .shiny-btn-purple {
            background-image: linear-gradient(to right, #8b5cf6 0%, #c084fc 51%, #8b5cf6 100%);
            box-shadow: 0 4px 15px 0 rgba(139, 92, 246, 0.4);
        }

        .shiny-btn-purple:hover {
            box-shadow: 0 8px 25px 0 rgba(139, 92, 246, 0.6);
        }

        .form-input {
            background-color: #f9fafb;
            /* gray-50 */
            border: 1px solid #d1d5db;
            /* gray-300 */
            color: #1f2937;
            border-radius: 0.375rem;
            /* rounded-md */
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4f46e5;
            border-color: #4f46e5;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .stage-badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
        }

        #modal-overlay.hidden,
        #gemini-modal.hidden,
        #api-key-modal.hidden {
            display: none;
        }

        .sort-indicator {
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .sort-indicator.active {
            opacity: 1;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-enter {
            animation: toast-in 0.5s ease-out forwards;
        }

        /* --- NOVO: ESTILOS DO FUNIL --- */
        .funnel-stage {
            padding: 0.5rem 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-radius: 0.375rem;
            width: 95%;
            /* Mobile first */
            border: 2px solid transparent;
        }

        @media (min-width: 768px) {
            .funnel-stage {
                width: 16.66%;
                /* 1/6 */
                margin-left: -0.75rem;
                /* Overlap them */
                clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%);
            }

            .funnel-stage:first-child {
                margin-left: 0;
                clip-path: polygon(0 0, 100% 0, 85% 100%, 0 100%);
            }

            .funnel-stage:last-child {
                clip-path: polygon(0 0, 100% 0, 100% 100%, 15% 100%);
            }
        }

        /* Cores Padrão (Pendentes) */
        .funnel-stage {
            background-color: #d1d5db;
            /* gray-300 */
            color: #4b5563;
            /* gray-600 */
            border-color: #f0f2f5;
            /* Cor do body para sobrepor */
        }

        /* Cores Ativas (Concluídas) */
        .funnel-stage.active {
            background-color: #4f46e5;
            /* indigo-600 */
            color: white;
            border-color: #4f46e5;
            z-index: 10;
            transform: scale(1.03);
        }

        /* --- FIM ESTILOS DO FUNIL --- */

        /* --- MUDANÇA 3: Estilos para <details> (remover marcador padrão) --- */
        summary {
            list-style: none;
            /* Remove default marker */
        }

        summary::-webkit-details-marker {
            display: none;
            /* Remove default marker for Chrome */
        }

        /* --- FIM ESTILOS <details> --- */

        /* [NOVO] Estilos para Bottom Navigation Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 var(--safe-area-inset-bottom);
            z-index: 1000;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding-bottom: 80px;
            }

            #client-list-container {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <canvas id="particles-js"></canvas>

    <div class="container mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl header-title">CRM</h1>
            <p class="text-gray-500 mt-2">Gestão da Jornada do Cliente</p>
            <div class="absolute top-0 left-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Dashboard.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Dashboard">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
            <div class="absolute top-0 right-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Agenda de eventos.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Agenda de Eventos">
                    <i class="fa-solid fa-calendar-days"></i>
                </button>
                <button onclick="window.location.href='./Sistema Gestão Financeira.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Gestão Financeira">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="bg-indigo-200/80 text-indigo-700 w-10 h-10 rounded-full cursor-default"
                    title="Você está no CRM">
                    <i class="fas fa-users"></i>
                </button>
                <button id="settings-btn"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <div id="client-list-container"
                    class="lg:col-span-12 glassmorphism p-6 rounded-lg transition-all duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Clientes</h2>
                        <button id="add-client-btn" class="shiny-btn font-bold py-2 px-4 rounded-lg text-sm">
                            <i class="fas fa-plus mr-2"></i>Novo Cliente
                        </button>
                    </div>
                    <div class="mb-4">
                        <button id="global-analysis-btn"
                            class="w-full shiny-btn shiny-btn-purple font-bold py-2 px-4 rounded-lg transition duration-300">✨
                            Análise Geral com IA</button>
                    </div>
                    <div class="relative mb-4">
                        <input type="text" id="search-bar" placeholder="Buscar por Nome ou Telefone..."
                            class="form-input w-full pl-10 pr-4 py-2 rounded-lg">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <div id="client-list-header"
                        class="grid grid-cols-6 items-center text-xs font-semibold text-gray-500 p-2 border-b-2 border-gray-200/50 mb-2">
                        <div id="sort-by-name" class="cursor-pointer hover:text-gray-800">
                            Cliente <span class="sort-indicator"></span>
                        </div>
                        <div id="sort-by-phone" class="cursor-pointer hover:text-gray-800">
                            Telefone <span class="sort-indicator"></span>
                        </div>
                        <div id="filter-by-company" class="cursor-pointer text-center hover:text-gray-800">
                            Empresa <span id="company-filter-label" class="text-blue-600 font-bold"></span>
                        </div>
                        <div id="sort-by-negotiation" class="cursor-pointer text-center hover:text-gray-800">
                            Negociação <span class="sort-indicator"></span>
                        </div>
                        <div id="sort-by-followup" class="cursor-pointer text-center hover:text-gray-800">
                            Follow-up <span class="sort-indicator"></span>
                        </div>
                        <div id="sort-by-event" class="cursor-pointer text-right hover:text-gray-800">
                            Próx. Evento <span class="sort-indicator"></span>
                        </div>
                    </div>
                    <div id="client-list" class="space-y-2 h-[60vh] overflow-y-auto pr-2">
                        <!-- Clientes serão inseridos aqui via JS -->
                    </div>
                </div>

                <!-- Painel de Detalhes do Cliente (Inicialmente oculto) -->
                <div id="main-content"
                    class="lg:col-span-8 glassmorphism p-6 rounded-lg h-[75vh] overflow-y-auto hidden relative">

                    <!-- Botão de Fechar (Fica fixo no canto) -->
                    <button id="close-detail-view-btn"
                        class="sticky top-6 right-6 z-20 float-right text-gray-500 hover:text-gray-800 text-2xl font-bold transition-transform hover:scale-110"
                        title="Fechar Detalhes">×</button>

                    <!-- View: Boas-vindas -->
                    <div id="welcome-view">
                        <h2 class="text-2xl font-semibold text-gray-900">Bem-vindo(a) ao seu CRM!</h2>
                        <p class="mt-2 text-gray-600">Selecione um cliente na lista à esquerda para ver os detalhes ou
                            clique em "+ Novo Cliente" para começar a cadastrar.</p>
                        <div class="mt-8 p-6 bg-blue-100/50 border-l-4 border-blue-500 rounded-r-lg">
                            <h3 class="font-semibold text-blue-800">Dica Rápida</h3>
                            <p class="text-blue-700 mt-1">Clique em "Análise Geral com IA" para receber insights sobre
                                todos os seus clientes.</p>
                        </div>
                    </div>

                    <!-- View: Detalhes do Cliente -->
                    <div id="detail-view" class="hidden">
                        <!-- Cabeçalho do Cliente -->
                        <div class="flex justify-between items-start">
                            <div class="flex items-center space-x-4">
                                <img id="detail-foto" src="https://placehold.co/80x80/EFEFEF/AAAAAA?text=Foto"
                                    class="w-20 h-20 rounded-full object-cover bg-gray-200">
                                <div>
                                    <h2 id="detail-nome" class="text-3xl font-bold text-gray-900"></h2>
                                    <p id="detail-tipoEvento" class="text-gray-500 text-lg"></p>
                                </div>
                            </div>
                            <div class="flex space-x-2 flex-shrink-0 pr-12">
                                <button id="edit-client-btn"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Editar</button>
                                <button id="delete-client-btn"
                                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Excluir</button>
                            </div>
                        </div>

                        <!-- Botões de Ação Rápida (IA e WhatsApp) -->
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button id="gemini-summary-btn"
                                class="shiny-btn shiny-btn-purple text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">✨
                                Resumir Cliente</button>
                            <button id="gemini-relationship-btn"
                                class="shiny-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">✨
                                Gerar Mensagens</button>
                            <button id="whatsapp-btn"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm flex items-center gap-2">
                                <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                            </button>
                        </div>

                        <!-- Seção: Jornada do Cliente (Funil Visual) -->
                        <details class="mt-6 border-t border-gray-200/50 pt-6 group" open>
                            <summary
                                class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none group-open:mb-4">
                                <i
                                    class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                Jornada do Cliente
                            </summary>
                            <div id="visual-funnel">
                                <div class="flex flex-col md:flex-row items-center justify-center md:space-x-1">
                                    <div class="funnel-stage" data-stage="1"><span>1. Apres.</span></div>
                                    <div class="funnel-stage" data-stage="2"><span>2. Sondagem</span></div>
                                    <div class="funnel-stage" data-stage="3"><span>3. Proposta</span></div>
                                    <div class="funnel-stage" data-stage="4"><span>4. Negoc.</span></div>
                                    <div class="funnel-stage" data-stage="5"><span>5. Ganho</span></div>
                                    <div class="funnel-stage" data-stage="6"><span>6. Pós-venda</span></div>
                                </div>
                                <div id="funnel-loss-indicator" class="text-center mt-2 hidden">
                                    <span class="stage-badge bg-red-600 text-white">Locação Perdida</span>
                                </div>
                            </div>
                        </details>

                        <!-- Conteúdo Principal dos Detalhes (Abas) -->
                        <div class="mt-6 border-t border-gray-200/50 pt-6 space-y-8">

                            <!-- Seção: Histórico e Estágio Atual -->
                            <details class="group" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-4">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Histórico e Estágio Atual
                                </summary>
                                <div class="mb-6">
                                    <label class="font-medium text-gray-500 text-sm">Estágio Atual</label>
                                    <div id="detail-estagio" class="mt-1 text-gray-900"></div>
                                </div>
                                <div>
                                    <!-- Lista de Conversas -->
                                    <div id="conversation-history-list"
                                        class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-2">
                                        <!-- Registros de conversa entram aqui -->
                                    </div>
                                    <!-- Formulário de Novo Registro -->
                                    <div class="p-4 bg-gray-50/50 rounded-lg border border-gray-200/50 space-y-3">
                                        <h4 class="font-semibold text-gray-700">Adicionar Novo Registro</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                            <div class="md:col-span-1">
                                                <label for="convo-date"
                                                    class="text-sm font-medium text-gray-600">Data</label>
                                                <input type="date" id="convo-date" class="form-input w-full text-sm">
                                            </div>
                                            <div class="md:col-span-1">
                                                <label for="convo-time"
                                                    class="text-sm font-medium text-gray-600">Hora</label>
                                                <input type="time" id="convo-time" class="form-input w-full text-sm">
                                            </div>
                                            <div class="md:col-span-2">
                                                <!-- Espaço reservado -->
                                            </div>
                                            <div class="md:col-span-4">
                                                <label for="convo-desc"
                                                    class="text-sm font-medium text-gray-600">Descrição</label>
                                                <textarea id="convo-desc" rows="2" class="form-input w-full text-sm"
                                                    placeholder="Descreva o contato..."></textarea>
                                            </div>
                                        </div>
                                        <!-- MUDANÇA: Botões de Ação do Histórico -->
                                        <div class="flex flex-wrap gap-2">
                                            <button id="add-convo-btn"
                                                class="shiny-btn text-sm font-bold py-2 px-4 rounded-lg">
                                                <i class="fas fa-plus mr-2"></i>Adicionar Registro
                                            </button>
                                            <!-- MUDANÇA: Botão de Criar Flow-Up REMOVIDO DAQUI -->
                                        </div>
                                        <!-- MUDANÇA: Caixa de Sugestão de Follow-up (oculta) -->
                                        <div id="history-followup-suggestion-box"
                                            class="hidden mt-4 p-3 bg-indigo-50/50 border border-indigo-200 rounded-lg space-y-3">
                                            <p id="history-followup-suggestion-text" class="text-sm text-gray-800"></p>
                                            <div class="flex space-x-2">
                                                <button id="confirm-suggested-followup-btn"
                                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded-md">Adicionar
                                                    Flow-up</button>
                                                <button id="cancel-suggested-followup-btn"
                                                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-1 px-3 rounded-md">Cancelar</button>
                                            </div>
                                        </div>
                                        <!-- FIM DA MUDANÇA -->
                                    </div>
                                </div>
                            </details>

                            <!-- Seção: Acompanhamento (Follow-up) -->
                            <details class="group border-t pt-6" id="detail-followup-container-wrapper" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-2">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Acompanhamento (Follow-up)
                                </summary>
                                <div class="p-4 bg-yellow-100/50 border-l-4 border-yellow-500 rounded-r-lg"
                                    id="detail-followup-container">
                                    <h3 class="font-semibold text-yellow-800 flex items-center mb-2">
                                        <i class="fas fa-clock mr-2"></i> Próximo Acompanhamento
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <dt class="font-medium text-gray-500">Data</dt>
                                            <dd id="detail-followUpDate" class="mt-1 text-gray-900 font-bold"></dd>
                                        </div>
                                        <div>
                                            <dt class="font-medium text-gray-500">Notas</dt>
                                            <dd id="detail-followUpNotes" class="mt-1 text-gray-900"></dd>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- Seção: Dados Gerais -->
                            <details class="group border-t pt-6" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-4">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Dados Gerais
                                </summary>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div id="detail-cpf-container">
                                        <dt class="font-medium text-gray-500" id="detail-cpf-label">CPF</dt>
                                        <dd id="detail-cpf" class="mt-1 text-gray-900"></dd>
                                    </div>
                                    <div id="detail-rg-container">
                                        <dt class="font-medium text-gray-500">RG</dt>
                                        <dd id="detail-rg" class="mt-1 text-gray-900"></dd>
                                    </div>
                                    <div id="detail-nascimento-container">
                                        <dt class="font-medium text-gray-500">Nascimento (Cliente)</dt>
                                        <dd id="detail-nascimentoCliente" class="mt-1 text-gray-900"></dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-500">Origem do Lead</dt>
                                        <dd id="detail-origem" class="mt-1 text-gray-900"></dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-500">Empresa</dt>
                                        <dd id="detail-company" class="mt-1 text-gray-900 font-semibold"></dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-500">Data de Negociação</dt>
                                        <dd id="detail-dataNegociacao" class="mt-1 text-gray-900"></dd>
                                    </div>
                                </div>
                            </details>

                            <!-- Seção: Representante (PJ) -->
                            <div id="detail-pj-rep-container" class="hidden border-t pt-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Representante Legal</h3>
                                <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <dt class="font-medium text-gray-500">Nome do Representante</dt>
                                        <dd id="detail-rep-nome" class="mt-1 text-gray-900"></dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-500">CPF do Representante</dt>
                                        <dd id="detail-rep-cpf" class="mt-1 text-gray-900"></dd>
                                    </div>
                                </dl>
                            </div>

                            <!-- Seção: Contato -->
                            <details class="border-t pt-6 group" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-4">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Contato
                                </summary>
                                <div>
                                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="md:col-span-2">
                                            <dt class="font-medium text-gray-500" id="detail-address-label">Endereço
                                                Residencial</dt>
                                            <dd id="detail-enderecoResidencial" class="mt-1 text-gray-900"></dd>
                                        </div>
                                        <div>
                                            <dt class="font-medium text-gray-500">Telefone Principal</dt>
                                            <dd id="detail-telefone" class="mt-1 text-gray-900"></dd>
                                        </div>
                                        <div>
                                            <dt class="font-medium text-gray-500">Telefone Reserva</dt>
                                            <dd id="detail-telefoneReserva" class="mt-1 text-gray-900"></dd>
                                        </div>
                                        <div>
                                            <dt class="font-medium text-gray-500">Email</dt>
                                            <dd id="detail-email" class="mt-1 text-gray-900"></dd>
                                        </div>
                                        <div>
                                            <dt class="font-medium text-gray-500">Instagram</dt>
                                            <dd id="detail-instagram" class="mt-1 text-gray-900"></dd>
                                        </div>
                                    </dl>
                                </div>
                            </details>

                            <!-- Seção: Eventos do Cliente -->
                            <details class="border-t pt-6 group" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-4">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Eventos do Cliente
                                </summary>
                                <div>
                                    <div id="detail-historico-fechamento" class="mt-2 text-gray-900 space-y-4"></div>
                                </div>
                            </details>

                            <!-- Seção: Dados Detalhados da Jornada -->
                            <div class="border-t pt-6">
                                <details id="stage-data-details"
                                    class="bg-gray-50/50 p-4 rounded-md border border-gray-200/50 group">
                                    <summary
                                        class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none group-open:mb-4">
                                        <i
                                            class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                        Ver Dados Detalhados da Jornada
                                    </summary>
                                    <dl id="stage-data-list"
                                        class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <!-- Dados de estágios específicos entram aqui -->
                                    </dl>
                                </details>
                            </div>

                            <!-- Seção: Anotações Gerais -->
                            <details class="border-t pt-6 group" open>
                                <summary
                                    class="font-semibold text-lg text-gray-800 cursor-pointer hover:text-indigo-600 list-none mb-4">
                                    <i
                                        class="fas fa-chevron-right group-open:rotate-90 transition-transform duration-200 mr-2 text-sm"></i>
                                    Anotações e Histórico Geral
                                </summary>
                                <div>
                                    <div id="detail-anotacoes"
                                        class="mt-1 text-gray-900 whitespace-pre-wrap bg-gray-50/50 p-3 rounded-md h-48 overflow-y-auto">
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Adicionar/Editar Cliente -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-box glassmorphism w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200/50">
                <h2 id="form-title" class="text-2xl font-semibold text-gray-900"></h2>
            </div>
            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto">
                <form id="client-form" class="space-y-8">
                    <input type="hidden" id="client-id">

                    <!-- Tipo de Cliente -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Cliente</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" id="client-type-pf" name="client-type" value="PF"
                                    class="form-radio h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                    checked>
                                <span class="ml-2 text-sm text-gray-700">Pessoa Física</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" id="client-type-pj" name="client-type" value="PJ"
                                    class="form-radio h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-700">Pessoa Jurídica</span>
                            </label>
                        </div>
                    </div>

                    <!-- Campos Pessoa Física (PF) -->
                    <div id="pf-fields">
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Dados
                            Pessoais do Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="md:col-span-1 flex flex-col items-center justify-center">
                                <img id="fotoPreview" src="https://placehold.co/128x128/EFEFEF/AAAAAA?text=Foto"
                                    class="w-32 h-32 rounded-full object-cover bg-gray-200 mb-2">
                                <label for="fotoUpload"
                                    class="cursor-pointer bg-white/50 py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-white/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <span>Carregar Foto</span>
                                    <input id="fotoUpload" name="fotoUpload" type="file" class="sr-only"
                                        accept="image/*">
                                </label>
                            </div>
                            <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome
                                        Completo</label>
                                    <input type="text" id="nome" class="form-input mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="cpf" class="block text-sm font-medium text-gray-700">CPF</label>
                                    <input type="text" id="cpf" class="form-input mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="rg" class="block text-sm font-medium text-gray-700">RG</label>
                                    <input type="text" id="rg" class="form-input mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="dataNascimento" class="block text-sm font-medium text-gray-700">Data de
                                        Nascimento</label>
                                    <input type="date" id="dataNascimento" class="form-input mt-1 block w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos Pessoa Jurídica (PJ) -->
                    <div id="pj-fields" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Dados da
                            Empresa</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="pj-nome" class="block text-sm font-medium text-gray-700">Razão Social / Nome
                                    da Empresa</label>
                                <input type="text" id="pj-nome" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="pj-cnpj" class="block text-sm font-medium text-gray-700">CNPJ</label>
                                <input type="text" id="pj-cnpj" class="form-input mt-1 block w-full">
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-md font-medium text-gray-700 mb-4">Representante Legal</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="pj-rep-nome" class="block text-sm font-medium text-gray-700">Nome
                                        Completo</label>
                                    <input type="text" id="pj-rep-nome" class="form-input mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="pj-rep-cpf" class="block text-sm font-medium text-gray-700">CPF</label>
                                    <input type="text" id="pj-rep-cpf" class="form-input mt-1 block w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contato e Endereço -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Contato e
                            Endereço</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone
                                    Principal</label>
                                <input type="tel" id="telefone" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="telefoneReserva" class="block text-sm font-medium text-gray-700">Telefone
                                    Reserva</label>
                                <input type="tel" id="telefoneReserva" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="instagram" class="block text-sm font-medium text-gray-700">Instagram</label>
                                <input type="text" id="instagram" placeholder="@seuperfil"
                                    class="form-input mt-1 block w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label for="enderecoResidencial" class="block text-sm font-medium text-gray-700"
                                    id="endereco-label">Endereço Residencial</label>
                                <input type="text" id="enderecoResidencial" class="form-input mt-1 block w-full">
                            </div>
                        </div>
                    </div>

                    <!-- Dados Comerciais -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Dados
                            Comerciais</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="company" class="block text-sm font-medium text-gray-700">Empresa</label>
                                <select id="company" class="form-input mt-1 block w-full" required></select>
                            </div>
                            <div>
                                <label for="origem" class="block text-sm font-medium text-gray-700">Origem do
                                    Lead</label>
                                <input type="text" id="origem" placeholder="Ex: Instagram, Indicação"
                                    class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="dataNegociacao" class="block text-sm font-medium text-gray-700">Data de
                                    Negociação</label>
                                <input type="date" id="dataNegociacao" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="estagio" class="block text-sm font-medium text-gray-700">Estágio da
                                    Jornada</label>
                                <select id="estagio" class="form-input mt-1 block w-full" required></select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tipoEvento" class="block text-sm font-medium text-gray-700">Tipo de Evento
                                    Principal</label>
                                <input type="text" id="tipoEvento" placeholder="Ex: Festa Infantil, Confraternização"
                                    class="form-input mt-1 block w-full">
                            </div>
                            <div class="md:col-span-3">
                                <div class="flex items-center pt-2">
                                    <input type="checkbox" id="marcarComoRecorrente"
                                        class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="marcarComoRecorrente" class="ml-2 block text-sm text-gray-900">Marcar
                                        como Cliente Recorrente/Ativo?</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos Específicos do Estágio -->
                    <div id="stage-specific-fields">
                        <!-- Conteúdo dinâmico com base no estágio -->
                    </div>

                    <!-- Acompanhamento (Follow-up) -->
                    <div>
                        <div class="flex justify-between items-center border-b border-gray-200/50 pb-2 mb-4">
                            <h3 class="text-lg font-medium text-gray-800">Acompanhamento (Follow-up)</h3>
                            <button type="button" id="ai-suggest-followup-btn"
                                class="shiny-btn shiny-btn-purple text-white font-bold py-1 px-3 rounded-lg transition duration-300 text-xs flex items-center gap-1">
                                ✨ Sugerir
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="followUpDate" class="block text-sm font-medium text-gray-700">Próximo
                                    Follow-up</label>
                                <input type="date" id="followUpDate" class="form-input mt-1 block w-full">
                            </div>
                            <div>
                                <label for="followUpNotes" class="block text-sm font-medium text-gray-700">Notas do
                                    Follow-up</label>
                                <input type="text" id="followUpNotes" placeholder="O que devo fazer?"
                                    class="form-input mt-1 block w-full">
                            </div>
                        </div>
                    </div>

                    <!-- Eventos Agendados / Realizados -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Eventos
                            Agendados / Realizados</h3>
                        <div id="eventos-fechados-container" class="space-y-6">
                            <!-- Eventos adicionados via JS -->
                        </div>
                        <button type="button" id="add-closed-event-btn"
                            class="mt-4 bg-gray-200/50 hover:bg-gray-300/50 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 border border-gray-300">+
                            Adicionar Evento ao Histórico</button>
                    </div>

                    <!-- Anotações -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">Anotações e
                            Histórico Geral</h3>
                        <textarea id="anotacoes" rows="5" class="form-input mt-1 block w-full"
                            placeholder="Insira aqui todo o histórico, negociações, e pontos importantes sobre o cliente... A IA usará isso para sugerir o follow-up."></textarea>
                    </div>
                </form>
            </div>
            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50/50 border-t border-gray-200/50 flex justify-end space-x-4">
                <button type="button" id="cancel-btn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancelar</button>
                <button type="submit" form="client-form"
                    class="shiny-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Salvar
                    Cliente</button>
            </div>
        </div>
    </div>

    <!-- Modal: Resposta da IA (Gemini) -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-box glassmorphism w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-modal-title" class="text-2xl font-semibold text-gray-900">✨ Assistente IA</h2>
                <button id="gemini-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto">
                <!-- Conteúdo da IA entra aqui -->
            </div>
            <div id="gemini-modal-footer"
                class="p-4 bg-gray-50/50 border-t border-gray-200/50 flex justify-end space-x-4">
                <button id="gemini-copy-btn" class="shiny-btn py-2 px-4 rounded-lg">Copiar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Configurar Chave da API -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-900">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-6">Para usar os recursos de IA, você precisa de uma chave de API do
                Google AI Studio. A chave será salva apenas no seu navegador.</p>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave da
                        API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui"
                        class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-50">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="ml-3"></p>
    </div>


    <script type="module">
        import { api } from './js/api.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // ======== CONFIGURAÇÃO INICIAL (FUNIL DE VENDAS ATUALIZADO) ========
            const estagios = {
                1: { text: '1. Apresentação (Quebra-gelo)', color: 'bg-gray-200 text-gray-800' },
                2: { text: '2. Sondagem / Qualificação', color: 'bg-blue-200 text-blue-800' },
                3: { text: '3. Demonstração / Proposta', color: 'bg-indigo-200 text-indigo-800' },
                4: { text: '4. Negociação / Fechamento', color: 'bg-purple-200 text-purple-800' },
                5: { text: '5. Locação Agendada (Ganho)', color: 'bg-green-600 text-white' }, // Ganho
                6: { text: '6. Pós-vendas / Feedback', color: 'bg-teal-200 text-teal-800' },
                99: { text: '99. Locação Perdida', color: 'bg-red-600 text-white' } // Perdido
            };
            // ======================================


            // Referências ao DOM
            const clientListEl = document.getElementById('client-list');
            // NOVOS: Referências de Layout
            const clientListContainer = document.getElementById('client-list-container');
            const mainContent = document.getElementById('main-content');

            const welcomeView = document.getElementById('welcome-view');
            const detailView = document.getElementById('detail-view');
            const clientForm = document.getElementById('client-form');
            const addClientBtn = document.getElementById('add-client-btn');
            const editClientBtn = document.getElementById('edit-client-btn');
            const deleteClientBtn = document.getElementById('delete-client-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const formTitle = document.getElementById('form-title');
            const modalOverlay = document.getElementById('modal-overlay');
            const addClosedEventBtn = document.getElementById('add-closed-event-btn');
            const eventosFechadosContainer = document.getElementById('eventos-fechados-container');
            const estagioSelect = document.getElementById('estagio');
            const marcarComoRecorrenteCheckbox = document.getElementById('marcarComoRecorrente');
            const fotoUploadInput = document.getElementById('fotoUpload');
            const fotoPreviewImg = document.getElementById('fotoPreview');
            const companySelect = document.getElementById('company');
            const sortByNameBtn = document.getElementById('sort-by-name');
            const sortByEventBtn = document.getElementById('sort-by-event');
            const sortByNegotiationBtn = document.getElementById('sort-by-negotiation');
            const sortByFollowUpBtn = document.getElementById('sort-by-followup');
            const filterByCompanyBtn = document.getElementById('filter-by-company');
            const companyFilterLabel = document.getElementById('company-filter-label');
            const globalAnalysisBtn = document.getElementById('global-analysis-btn');
            const stageSpecificFieldsDiv = document.getElementById('stage-specific-fields');
            // NOVO: Referência da barra de pesquisa
            const searchBar = document.getElementById('search-bar');

            // PF/PJ Form Elements
            const clientTypePfRadio = document.getElementById('client-type-pf');
            const clientTypePjRadio = document.getElementById('client-type-pj');
            const pfFieldsDiv = document.getElementById('pf-fields');
            const pjFieldsDiv = document.getElementById('pj-fields');
            const nomeInput = document.getElementById('nome');
            const pjNomeInput = document.getElementById('pj-nome');
            const enderecoLabel = document.getElementById('endereco-label');

            // Gemini Modal & API Key Elements
            const geminiModal = document.getElementById('gemini-modal');
            const geminiModalTitle = document.getElementById('gemini-modal-title');
            const geminiModalContent = document.getElementById('gemini-modal-content');
            const geminiModalFooter = document.getElementById('gemini-modal-footer');
            const geminiCloseBtn = document.getElementById('gemini-close-btn');
            const geminiCopyBtn = document.getElementById('gemini-copy-btn');
            const geminiSummaryBtn = document.getElementById('gemini-summary-btn');
            const geminiRelationshipBtn = document.getElementById('gemini-relationship-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const apiKeyModal = document.getElementById('api-key-modal');
            const cancelApiKeyBtn = document.getElementById('cancel-api-key-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            // Variáveis de estado
            let clients = [];
            let companies = [];
            let toysList = [];
            let currentClientId = null;
            let viewState = {
                sortKey: 'name', // name | event | negotiation | followup | phone
                sortDir: 'asc',  // asc | desc
                companyFilterIndex: 0 // index in FILTER_CYCLE
            };

            let FILTER_CYCLE = ['Todas'];

            // --- Funções Auxiliares ---
            const getClientNextEventDate = (client) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (!client.historicoEventosFechados) return null;
                const futureEvents = client.historicoEventosFechados
                    .filter(e => e.dataEvento && new Date(e.dataEvento + 'T00:00:00') >= today)
                    .sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));
                return futureEvents.length > 0 ? new Date(futureEvents[0].dataEvento + 'T00:00:00') : null;
            };


            // --- Funções Principais ---
            const loadData = async () => {
                const apiClients = await api.getClientes();
                clients = apiClients || [];

                // Data migration / enrichment
                clients.forEach(client => {
                    // Garante que o histórico de conversas exista
                    if (!client.conversationHistory) {
                        client.conversationHistory = [];
                    }
                    if (client.clientType) {
                        if (client.estagio === 7) {
                            client.estagio = 6;
                        }
                        return;
                    }
                    if (client.anotacoes && client.anotacoes.includes('[PJ]')) {
                        client.clientType = 'PJ';
                    } else {
                        client.clientType = 'PF';
                    }
                });

                const agendaCompaniesJSON = localStorage.getItem('companies');
                companies = agendaCompaniesJSON ? JSON.parse(agendaCompaniesJSON) : [];
                FILTER_CYCLE = ['Todas', ...companies.map(c => c.name)];

                const apiToys = await api.getBrinquedos();
                toysList = apiToys ? apiToys.map(t => t.name).sort() : [];

                // Log de debug para verificação de carregamento
                console.log('📦 Dados carregados da API (CRM):', {
                    clients: clients.length,
                    companies: companies.length,
                    toys: toysList.length
                });
            };

            const saveClients = () => {
                localStorage.setItem('crmToyClients_v8', JSON.stringify(clients));
            };

            const renderClientList = () => {
                clientListEl.innerHTML = '';

                const companyFilter = FILTER_CYCLE[viewState.companyFilterIndex];
                const searchTerm = searchBar.value.toLowerCase().trim();

                let processedClients = [...clients];

                // 1. Filtrar por Pesquisa (Nome ou Telefone)
                if (searchTerm) {
                    processedClients = processedClients.filter(client => {
                        const nome = client.nome.toLowerCase();
                        const telefone = client.telefone ? client.telefone.replace(/[\(\)\-\s]/g, '') : ''; // Limpa telefone
                        const searchTermClean = searchTerm.replace(/[\(\)\-\s]/g, '');
                        return nome.includes(searchTerm) || telefone.includes(searchTermClean);
                    });
                }

                // 2. Filtrar por Empresa
                if (companyFilter !== 'Todas') {
                    processedClients = processedClients.filter(client => client.company === companyFilter);
                }

                // 2. Pré-processar com data do próximo evento E follow-up para exibição e ordenação
                processedClients.forEach(client => {
                    const nextEvent = getClientNextEventDate(client);
                    client.nextEventDateForSort = nextEvent;
                    client.nextEventDateForDisplay = nextEvent ? nextEvent.toLocaleDateString('pt-BR') : '';

                    // Lógica de Follow-up
                    const followUpDate = client.followUpDate ? new Date(client.followUpDate + 'T00:00:00') : null;
                    client.followUpDateForSort = followUpDate;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (followUpDate) {
                        if (followUpDate < today) {
                            client.followUpStatus = 'VENCIDO';
                            client.followUpColor = 'bg-red-500 text-white';
                        } else if (followUpDate <= new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000))) { // Próximos 7 dias
                            client.followUpStatus = 'HOJE/EM BREVE';
                            client.followUpColor = 'bg-orange-500 text-white';
                        } else {
                            client.followUpStatus = 'AGENDADO';
                            client.followUpColor = 'bg-yellow-500 text-gray-900';
                        }
                        client.followUpDateForDisplay = followUpDate.toLocaleDateString('pt-BR');
                    } else {
                        client.followUpStatus = null;
                        client.followUpDateForDisplay = '';
                    }
                });

                // 3. Ordenar
                if (viewState.sortKey === 'name') {
                    processedClients.sort((a, b) => a.nome.localeCompare(b.nome));
                } else if (viewState.sortKey === 'phone') { // ADICIONADO: Ordenar por telefone
                    processedClients.sort((a, b) => (a.telefone || '').localeCompare(b.telefone || ''));
                } else if (viewState.sortKey === 'event') {
                    processedClients.sort((a, b) => {
                        const dateA = a.nextEventDateForSort;
                        const dateB = b.nextEventDateForSort;
                        if (dateA && dateB) return dateA - dateB;
                        if (dateA) return -1;
                        if (dateB) return 1;
                        return 0;
                    });
                } else if (viewState.sortKey === 'negotiation') {
                    processedClients.sort((a, b) => {
                        const dateA = a.dataNegociacao ? new Date(a.dataNegociacao) : null;
                        const dateB = b.dataNegociacao ? new Date(b.dataNegociacao) : null;
                        if (dateA && dateB) return dateB - dateA; // Default to most recent first
                        if (dateA) return -1;
                        if (dateB) return 1;
                        return 0;
                    });
                } else if (viewState.sortKey === 'followup') {
                    processedClients.sort((a, b) => {
                        const dateA = a.followUpDateForSort;
                        const dateB = b.followUpDateForSort;
                        if (dateA && dateB) return dateA - dateB; // Mais próximo primeiro
                        if (dateA) return -1; // Clientes com data vêm primeiro
                        if (dateB) return 1;
                        return 0; // Clientes sem data ficam juntos no final
                    });
                }

                if (viewState.sortDir === 'desc') {
                    processedClients.reverse();
                }

                // 4. Atualizar UI do cabeçalho
                document.querySelectorAll('.sort-indicator').forEach(el => {
                    el.textContent = '';
                    el.classList.remove('active');
                });
                const activeIndicator = document.querySelector(`#sort-by-${viewState.sortKey} .sort-indicator`);
                if (activeIndicator) {
                    activeIndicator.textContent = viewState.sortDir === 'asc' ? ' ▲' : ' ▼';
                    activeIndicator.classList.add('active');
                }
                companyFilterLabel.textContent = `(${companyFilter})`;


                if (processedClients.length === 0) {
                    clientListEl.innerHTML = '<p class="text-gray-500 text-center mt-4">Nenhum cliente encontrado.</p>';
                    return;
                }

                processedClients.forEach(client => {
                    const clientDiv = document.createElement('div');
                    const isActive = client.id === currentClientId;
                    clientDiv.className = `p-3 border border-gray-200/50 rounded-lg cursor-pointer hover:bg-white/50 transition duration-200 ${isActive ? 'bg-blue-100/50 border-blue-400' : ''}`;
                    clientDiv.dataset.id = client.id;
                    clientDiv.id = `client-list-item-${client.id}`; // Adicionado ID para scroll

                    const estagioInfo = estagios[client.estagio];
                    const negotiationDateDisplay = client.dataNegociacao ? new Date(client.dataNegociacao + 'T00:00:00').toLocaleDateString('pt-BR') : '';
                    const pjBadge = client.clientType === 'PJ' ? `<span class="stage-badge bg-gray-600 text-white ml-2">PJ</span>` : '';

                    clientDiv.innerHTML = `
                <div class="grid grid-cols-6 items-start text-sm">
                    <div class="font-semibold text-gray-800 truncate pr-1">${client.nome}</div>
                    <div class="text-left text-gray-500 truncate px-1 text-xs">${client.telefone || ''}</div>
                    <div class="text-center text-gray-500 truncate px-1 text-xs">${client.company || ''}</div>
                    <div class="text-center text-gray-500 truncate px-1 text-xs">${negotiationDateDisplay}</div>
                    <div class="text-center text-gray-500 truncate px-1 text-xs">
                        ${client.followUpDateForDisplay}
                        ${client.followUpStatus ? `<span class="stage-badge mt-1 block ${client.followUpColor}">${client.followUpStatus}</span>` : ''}
                    </div>
                    <div class="text-right text-gray-500 truncate pl-1 text-xs">${client.nextEventDateForDisplay}</div>
                </div>
                 <div class="mt-2 flex items-center space-x-2">
                    <span class="stage-badge ${estagioInfo.color}">${estagioInfo.text}</span>
                    ${client.isRecorrente ? `<span class="stage-badge bg-green-200 text-green-800">Recorrente</span>` : ''}
                    ${pjBadge}
                </div>
            `;
                    clientDiv.addEventListener('click', () => {
                        currentClientId = client.id;
                        showClientDetails(client.id);
                        renderClientList(); // Re-render para destacar o item ativo
                    });
                    clientListEl.appendChild(clientDiv);
                });
            };

            // ===================================================================
            // NOVO: Funções para o Histórico de Conversas
            // ===================================================================
            const renderConversationHistory = (clientId) => {
                const client = clients.find(c => c.id === clientId);
                if (!client) return;

                const listEl = document.getElementById('conversation-history-list');
                listEl.innerHTML = '';

                if (!client.conversationHistory || client.conversationHistory.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-sm text-center p-3">Nenhum registro de conversa.</p>';
                    return;
                }

                // Ordena do mais recente para o mais antigo
                const sortedHistory = [...client.conversationHistory].sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
                    const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
                    return dateB - dateA;
                });

                sortedHistory.forEach((entry, index) => {
                    // O `originalIndex` é necessário para a exclusão, pois o `index` vem do array ordenado
                    const originalIndex = client.conversationHistory.indexOf(entry);
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'bg-white/50 p-3 rounded-md border border-gray-200/50 text-sm';

                    const entryDate = entry.date ? new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data não informada';

                    // MUDANÇA: Adicionado botão "Criar Flow-Up" e wrapper para ele
                    entryDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="font-semibold text-gray-700">
                        <i class="fas fa-calendar-alt mr-2 text-gray-400"></i>${entryDate}
                        <span class="ml-2 text-gray-500 font-medium">${entry.time || ''}</span>
                    </div>
                    <button data-index="${originalIndex}" class="delete-convo-btn text-red-400 hover:text-red-600 font-bold text-lg leading-none">×</button>
                </div>
                <p class="mt-2 text-gray-800 whitespace-pre-wrap">${entry.description}</p>
                
                <!-- MUDANÇA: Botão de Flow-Up movido para cá -->
                <div class="mt-2 text-right">
                    <button 
                        data-description="${encodeURIComponent(entry.description)}" 
                        class="suggest-followup-from-entry-btn shiny-btn shiny-btn-purple text-xs font-bold py-1 px-3 rounded-lg">
                        ✨ Criar Flow-Up
                    </button>
                </div>
            `;
                    listEl.appendChild(entryDiv);
                });

                // Adiciona event listeners aos botões de exclusão
                listEl.querySelectorAll('.delete-convo-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const indexToDelete = parseInt(btn.dataset.index);
                        client.conversationHistory.splice(indexToDelete, 1);
                        saveClients();
                        renderConversationHistory(clientId); // Re-renderiza a lista
                    });
                });

                // MUDANÇA: Adiciona event listeners aos novos botões de "Criar Flow-Up"
                listEl.querySelectorAll('.suggest-followup-from-entry-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const description = decodeURIComponent(e.currentTarget.dataset.description);
                        if (!client) return;
                        // Chama a função de IA com a descrição específica deste registro
                        handleSuggestFollowUpFromDescription(client, description, e.currentTarget);
                    });
                });
            };

            const setupConversationHandler = (clientId) => {
                const addBtn = document.getElementById('add-convo-btn');
                const dateInput = document.getElementById('convo-date');
                const timeInput = document.getElementById('convo-time');
                const descInput = document.getElementById('convo-desc');

                // Preenche data e hora atuais como padrão
                const now = new Date();
                dateInput.value = now.toISOString().split('T')[0];
                timeInput.value = now.toTimeString().slice(0, 5);

                // Clona o botão para remover listeners antigos e evitar duplicação
                const newAddBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newAddBtn, addBtn);

                newAddBtn.addEventListener('click', () => {
                    const date = dateInput.value;
                    const time = timeInput.value;
                    const description = descInput.value.trim();

                    if (!description) {
                        showToast('A descrição do contato é obrigatória.', true);
                        return;
                    }
                    if (!date) {
                        showToast('A data do contato é obrigatória.', true);
                        return;
                    }

                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        if (!client.conversationHistory) {
                            client.conversationHistory = [];
                        }
                        client.conversationHistory.push({ date, time, description });
                        saveClients();
                        renderConversationHistory(clientId);

                        // Limpa o campo de descrição e reseta data/hora
                        descInput.value = '';
                        dateInput.value = now.toISOString().split('T')[0];
                        timeInput.value = now.toTimeString().slice(0, 5);

                        // Limpa a sugestão de follow-up se houver
                        document.getElementById('history-followup-suggestion-box').classList.add('hidden');
                    }
                });
            };


            const showClientDetails = (id) => {
                // NOVO: Ajusta o layout do grid
                clientListContainer.classList.remove('lg:col-span-12');
                clientListContainer.classList.add('lg:col-span-4');
                mainContent.classList.remove('hidden');

                const client = clients.find(c => c.id === id);
                if (!client) {
                    currentClientId = null;
                    showView(welcomeView);
                    return;
                }

                // --- NOVO: Lógica do Funil Visual ---
                const currentStage = parseInt(client.estagio);
                const funnelStages = document.querySelectorAll('.funnel-stage');
                funnelStages.forEach(stageEl => {
                    const stageNum = parseInt(stageEl.dataset.stage);
                    if (stageNum <= currentStage && currentStage !== 99) {
                        stageEl.classList.add('active');
                    } else {
                        stageEl.classList.remove('active');
                    }
                });
                // Lógica para 'Perdido'
                const funnelLossIndicator = document.getElementById('funnel-loss-indicator');
                if (currentStage === 99) {
                    funnelLossIndicator.classList.remove('hidden');
                } else {
                    funnelLossIndicator.classList.add('hidden');
                }
                // --- FIM LÓGICA FUNIL ---


                const isPJ = client.clientType === 'PJ';

                // Parse PJ data from notes if necessary
                let pjData = {};
                if (isPJ) {
                    const cnpjMatch = client.anotacoes?.match(/\[PJ\] CNPJ: (.*?)(,|$|\n)/);
                    const repMatch = client.anotacoes?.match(/Rep\.: (.*?) \(CPF: (.*?)\)/);
                    pjData.cnpj = cnpjMatch ? cnpjMatch[1].trim() : 'N/A';
                    pjData.repName = repMatch ? repMatch[1].trim() : 'N/A';
                    pjData.repCpf = repMatch ? repMatch[2].trim() : 'N/A';
                }

                // Preenche Follow-up
                const fDate = client.followUpDate ? new Date(client.followUpDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                document.getElementById('detail-followUpDate').textContent = fDate;
                document.getElementById('detail-followUpNotes').textContent = client.followUpNotes || 'Nenhuma nota de acompanhamento.';

                const followUpContainerWrapper = document.getElementById('detail-followup-container-wrapper');
                const followUpContainer = document.getElementById('detail-followup-container');

                followUpContainer.classList.remove('bg-yellow-100/50', 'border-yellow-500', 'bg-red-100/50', 'border-red-500', 'bg-orange-100/50', 'border-orange-500');
                followUpContainer.querySelector('h3').classList.remove('text-yellow-800', 'text-red-800', 'text-orange-800');


                if (client.followUpDate) {
                    followUpContainerWrapper.classList.remove('hidden');
                    const followUpDateObj = client.followUpDate ? new Date(client.followUpDate + 'T00:00:00') : null;
                    const today = new Date(); today.setHours(0, 0, 0, 0);

                    if (followUpDateObj && followUpDateObj < today) {
                        followUpContainer.classList.add('bg-red-100/50', 'border-red-500');
                        followUpContainer.querySelector('h3').classList.add('text-red-800');
                    } else if (followUpDateObj && followUpDateObj <= new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000))) {
                        followUpContainer.classList.add('bg-orange-100/50', 'border-orange-500');
                        followUpContainer.querySelector('h3').classList.add('text-orange-800');
                    } else {
                        followUpContainer.classList.add('bg-yellow-100/50', 'border-yellow-500');
                        followUpContainer.querySelector('h3').classList.add('text-yellow-800');
                    }
                } else {
                    followUpContainerWrapper.classList.add('hidden');
                }


                // Preenche dados básicos
                document.getElementById('detail-foto').src = client.fotoUrl || 'https://placehold.co/80x80/EFEFEF/AAAAAA?text=Foto';
                document.getElementById('detail-nome').textContent = client.nome;
                document.getElementById('detail-tipoEvento').textContent = client.tipoEvento || 'Tipo de evento não informado';

                document.getElementById('detail-origem').textContent = client.origem || 'N/A';
                document.getElementById('detail-company').textContent = client.company || 'N/A';
                document.getElementById('detail-dataNegociacao').textContent = client.dataNegociacao ? new Date(client.dataNegociacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';

                document.getElementById('detail-enderecoResidencial').textContent = client.enderecoResidencial || 'N/A';
                document.getElementById('detail-telefone').textContent = client.telefone || 'N/A';
                document.getElementById('detail-telefoneReserva').textContent = client.telefoneReserva || 'N/A';
                document.getElementById('detail-email').textContent = client.email || 'N/A';
                document.getElementById('detail-instagram').textContent = client.instagram || 'N/A';

                // Show/hide and update fields based on client type
                document.getElementById('detail-cpf-container').style.display = isPJ ? 'block' : 'block';
                document.getElementById('detail-rg-container').style.display = isPJ ? 'none' : 'block';
                document.getElementById('detail-nascimento-container').style.display = isPJ ? 'none' : 'block';
                document.getElementById('detail-pj-rep-container').style.display = isPJ ? 'block' : 'none';

                if (isPJ) {
                    document.getElementById('detail-cpf-label').textContent = 'CNPJ';
                    document.getElementById('detail-cpf').textContent = pjData.cnpj;
                    document.getElementById('detail-address-label').textContent = 'Endereço da Sede';
                    document.getElementById('detail-rep-nome').textContent = pjData.repName;
                    document.getElementById('detail-rep-cpf').textContent = pjData.repCpf;
                } else {
                    document.getElementById('detail-cpf-label').textContent = 'CPF';
                    document.getElementById('detail-cpf').textContent = client.cpf || 'N/A';
                    document.getElementById('detail-rg').textContent = client.rg || 'N/A';
                    document.getElementById('detail-nascimentoCliente').textContent = client.dataNascimento ? new Date(client.dataNascimento + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                    document.getElementById('detail-address-label').textContent = 'Endereço Residencial';
                }

                // Estágio como Dropdown
                const estagioDetailEl = document.getElementById('detail-estagio');
                estagioDetailEl.innerHTML = '';
                const estagioDetailSelect = document.createElement('select');
                estagioDetailSelect.className = 'form-input w-full';
                for (const key in estagios) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = estagios[key].text;
                    if (key == client.estagio) option.selected = true;
                    estagioDetailSelect.appendChild(option);
                }
                estagioDetailSelect.addEventListener('change', (e) => {
                    client.estagio = parseInt(e.target.value);
                    saveClients();
                    renderClientList();
                    showClientDetails(client.id);
                });
                estagioDetailEl.appendChild(estagioDetailSelect);

                document.getElementById('detail-anotacoes').textContent = client.anotacoes || 'Nenhuma anotação.';

                // Preenche histórico de eventos fechados
                const historicoEl = document.getElementById('detail-historico-fechamento');
                historicoEl.innerHTML = '';
                if (client.historicoEventosFechados && client.historicoEventosFechados.length > 0) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const futureEvents = client.historicoEventosFechados
                        .filter(e => e.dataEvento && new Date(e.dataEvento + 'T00:00:00') >= today)
                        .sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));

                    const nextEventId = futureEvents.length > 0 ? futureEvents[0].id : null;

                    client.historicoEventosFechados.sort((a, b) => new Date(b.dataEvento) - new Date(a.dataEvento)).forEach(evento => {
                        const eventDate = evento.dataEvento ? new Date(evento.dataEvento + 'T00:00:00') : null;
                        const isPast = eventDate && eventDate < today;
                        const isNextEvent = evento.id === nextEventId;

                        let statusBadge, cardClasses, titleClasses, totalClasses;

                        if (isNextEvent) {
                            statusBadge = '<span class="stage-badge bg-green-500 text-white">Próximo Evento</span>';
                            cardClasses = 'bg-green-50/50 border-green-300';
                            titleClasses = 'font-semibold text-green-800';
                            totalClasses = 'font-bold text-lg text-green-700 mt-2';
                        } else if (isPast) {
                            statusBadge = '<span class="stage-badge bg-gray-500 text-white">Realizado</span>';
                            cardClasses = 'bg-gray-100/50 border-gray-200';
                            titleClasses = 'font-semibold text-gray-700';
                            totalClasses = 'font-bold text-lg text-gray-600 mt-2';
                        } else { // Outro evento futuro
                            statusBadge = '<span class="stage-badge bg-blue-500 text-white">Agendado</span>';
                            cardClasses = 'bg-blue-50/50 border-blue-200';
                            titleClasses = 'font-semibold text-blue-800';
                            totalClasses = 'font-bold text-lg text-blue-700 mt-2';
                        }

                        const dataFormatada = evento.dataEvento ? eventDate.toLocaleDateString('pt-BR') : 'N/A';
                        const valorFormatado = evento.valorTotal ? 'R$ ' + parseFloat(evento.valorTotal).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A';
                        let brinquedosHtml = '<ul>';
                        (evento.brinquedosAlugados || []).forEach(b => {
                            brinquedosHtml += `<li class="text-sm text-gray-700">- ${b.nome} (R$ ${parseFloat(b.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</li>`;
                        });
                        brinquedosHtml += '</ul>';
                        const aniversarioFormatado = evento.nascimentoAniversariante ? new Date(evento.nascimentoAniversariante + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';

                        let feedbackHtml = '';
                        if (isPast && evento.feedbackCliente) {
                            feedbackHtml = `
                        <div class="mt-4 border-t pt-2">
                            <p class="font-medium text-gray-800">Feedback do Cliente:</p>
                            <p class="text-sm text-gray-600 italic whitespace-pre-wrap">"${evento.feedbackCliente}"</p>
                             <button class="analyze-feedback-btn mt-2 text-sm bg-purple-100/50 text-purple-800 hover:bg-purple-200/50 font-semibold py-1 px-3 rounded-md" data-feedback="${encodeURIComponent(evento.feedbackCliente)}">✨ Analisar Feedback</button>
                        </div>
                    `;
                        }

                        historicoEl.innerHTML += `
                    <div class="${cardClasses} p-4 rounded-lg border">
                        <div class="flex justify-between items-center">
                             <p class="${titleClasses}">Evento de ${dataFormatada}</p>
                             ${statusBadge}
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><p class="font-semibold">Aniversariante:</p> ${evento.nomeAniversariante || ''} (Nasc: ${aniversarioFormatado})</div>
                            <div><p class="font-semibold">Horário:</p> ${evento.horarioInicio || ''} às ${evento.horarioTermino || ''}</div>
                            <div class="md:col-span-2"><p class="font-semibold">Endereço:</p> ${evento.enderecoEvento || ''}, CEP: ${evento.cep || ''}</div>
                            ${evento.googleMaps ? `<div class="md:col-span-2"><a href="${evento.googleMaps}" target="_blank" class="text-blue-600 hover:underline">Ver no Google Maps</a></div>` : ''}
                        </div>
                        <div class="mt-4 border-t pt-2">
                            <p class="font-medium text-gray-800">Brinquedos Alugados:</p>
                            ${brinquedosHtml}
                        </div>
                        ${feedbackHtml}
                        <p class="text-right ${totalClasses}">Total: ${valorFormatado}</p>
                    </div>
                `;
                    });
                    historicoEl.querySelectorAll('.analyze-feedback-btn').forEach(btn => btn.addEventListener('click', handleFeedbackAnalysis));
                } else {
                    historicoEl.innerHTML = '<p class="text-gray-700 p-4 bg-gray-50/50 rounded-md">Nenhum evento fechado no histórico.</p>';
                }

                // --- NOVO: Lógica da Aba Recolhível ---
                const dataListEl = document.getElementById('stage-data-list');
                dataListEl.innerHTML = '';
                let stageDataHtml = '';

                const addDataToList = (label, value) => {
                    if (value) {
                        return `
                    <div class="py-2">
                        <dt class="font-medium text-gray-500 text-sm">${label}</dt>
                        <dd class="mt-1 text-gray-900">${value}</dd>
                    </div>
                `;
                    }
                    return '';
                };

                // Adiciona dados com base no estágio
                stageDataHtml += addDataToList('Data Prevista (Sondagem)', client.eventDate ? new Date(client.eventDate + 'T00:00:00').toLocaleDateString('pt-BR') : '');
                stageDataHtml += addDataToList('Local (Sondagem)', client.eventLocation);
                stageDataHtml += addDataToList('Brinquedos Desejados (Sondagem)', client.desiredToys ? client.desiredToys.replace(/\n/g, '<br>') : '');
                stageDataHtml += addDataToList('Valor Estimado (Negociação)', client.estimatedValue ? 'R$ ' + parseFloat(client.estimatedValue).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '');
                stageDataHtml += addDataToList('Motivo da Perda', client.lossReason);

                if (stageDataHtml === '') {
                    dataListEl.innerHTML = '<p class="text-gray-600 mt-2">Nenhum dado de jornada específico coletado.</p>';
                } else {
                    dataListEl.innerHTML = stageDataHtml;
                }

                // NOVO: Renderiza e configura o histórico de conversas
                renderConversationHistory(id);
                setupConversationHandler(id);

                // ===================================================================
                // MUDANÇA: Adiciona listeners para os novos botões de Flow-Up do Histórico
                // ===================================================================
                //const suggestBtn = document.getElementById('ai-suggest-followup-from-history-btn'); // MUDANÇA: Botão e listener removidos
                const confirmBtn = document.getElementById('confirm-suggested-followup-btn');
                const cancelBtn = document.getElementById('cancel-suggested-followup-btn');
                const suggestionBox = document.getElementById('history-followup-suggestion-box');

                if (confirmBtn) {
                    // Não precisa clonar, pois o listener é simples e a caixa é recriada/oculta
                    confirmBtn.onclick = () => {
                        const { date, time, note } = suggestionBox.dataset;
                        if (client && date && note) {
                            client.followUpDate = date;
                            client.followUpNotes = `[${time || 's/ hora'}] ${note}`;
                            saveClients();
                            renderClientList();
                            showClientDetails(client.id); // Recarrega a view de detalhes
                            showToast("Follow-up salvo com sucesso!", false);
                            suggestionBox.classList.add('hidden'); // Oculta a caixa
                        } else {
                            showToast("Erro ao salvar sugestão. Tente novamente.", true);
                        }
                    };
                }

                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        suggestionBox.classList.add('hidden');
                        suggestionBox.removeAttribute('data-date');
                        suggestionBox.removeAttribute('data-time');
                        suggestionBox.removeAttribute('data-note');
                    };
                }
                // ===================================================================
                // FIM DA MUDANÇA
                // ===================================================================


                // MUDANÇA 2: Adiciona funcionalidade ao botão WhatsApp
                const whatsappBtn = document.getElementById('whatsapp-btn');
                whatsappBtn.onclick = () => {
                    let telefone = client.telefone || '';
                    telefone = telefone.replace(/\D/g, ''); // Remove tudo que não é dígito

                    if (telefone) {
                        if (telefone.length <= 11) {
                            telefone = '55' + telefone;
                        }
                        const whatsappUrl = `https://wa.me/${telefone}`;
                        window.open(whatsappUrl, '_blank');
                    } else {
                        showToast('Cliente não possui um telefone principal cadastrado.', true);
                    }
                };

                showView(detailView);
            };

            const showForm = (mode, id = null) => {
                clientListContainer.classList.remove('lg:col-span-12');
                clientListContainer.classList.add('lg:col-span-4');
                mainContent.classList.remove('hidden');
                if (mode === 'add') {
                    showView(welcomeView);
                }

                clientForm.reset();
                eventosFechadosContainer.innerHTML = '';
                fotoPreviewImg.src = 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Foto';

                document.getElementById('followUpDate').value = '';
                document.getElementById('followUpNotes').value = '';

                let client = null;

                if (mode === 'add') {
                    formTitle.textContent = 'Adicionar Novo Cliente';
                    document.getElementById('client-id').value = '';
                    clientTypePfRadio.checked = true;
                } else {
                    formTitle.textContent = 'Editar Cliente';
                    client = clients.find(c => c.id === id);
                    if (!client) return;

                    const isPJ = client.clientType === 'PJ';
                    clientTypePfRadio.checked = !isPJ;
                    clientTypePjRadio.checked = isPJ;

                    document.getElementById('client-id').value = client.id;
                    fotoPreviewImg.src = client.fotoUrl || 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Foto';
                    document.getElementById('telefone').value = client.telefone || '';
                    document.getElementById('telefoneReserva').value = client.telefoneReserva || '';
                    document.getElementById('email').value = client.email || '';
                    document.getElementById('instagram').value = client.instagram || '';
                    document.getElementById('enderecoResidencial').value = client.enderecoResidencial || '';
                    document.getElementById('estagio').value = client.estagio;
                    document.getElementById('origem').value = client.origem || '';
                    document.getElementById('dataNegociacao').value = client.dataNegociacao || '';
                    document.getElementById('company').value = client.company || '';
                    document.getElementById('tipoEvento').value = client.tipoEvento || '';
                    document.getElementById('marcarComoRecorrente').checked = client.isRecorrente || false;
                    document.getElementById('anotacoes').value = client.anotacoes || '';
                    document.getElementById('followUpDate').value = client.followUpDate || '';
                    document.getElementById('followUpNotes').value = client.followUpNotes || '';

                    if (isPJ) {
                        const cnpjMatch = client.anotacoes?.match(/\[PJ\] CNPJ: (.*?)(,|$|\n)/);
                        const repMatch = client.anotacoes?.match(/Rep\.: (.*?) \(CPF: (.*?)\)/);

                        pjNomeInput.value = client.nome;
                        document.getElementById('pj-cnpj').value = cnpjMatch ? cnpjMatch[1].trim() : '';
                        document.getElementById('pj-rep-nome').value = repMatch ? repMatch[1].trim() : '';
                        document.getElementById('pj-rep-cpf').value = repMatch ? repMatch[2].trim() : client.cpf;
                    } else {
                        nomeInput.value = client.nome;
                        document.getElementById('cpf').value = client.cpf || '';
                        document.getElementById('rg').value = client.rg || '';
                        document.getElementById('dataNascimento').value = client.dataNascimento || '';
                    }

                    if (client.historicoEventosFechados && client.historicoEventosFechados.length > 0) {
                        client.historicoEventosFechados.forEach(evento => addClosedEventField(evento));
                    }
                }

                toggleClientFormFields();
                renderStageSpecificFields(client);

                modalOverlay.classList.remove('hidden');
            };

            const renderStageSpecificFields = (client = {}) => {
                const stage = parseInt(estagioSelect.value);
                stageSpecificFieldsDiv.innerHTML = '';

                let htmlContent = '';
                let title = '';

                const getData = (key) => client[key] || '';

                switch (stage) {
                    case 2:
                        title = 'Detalhes da Sondagem (Brinquedos e Evento)';
                        htmlContent = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-gray-700">Data Prevista do Evento</label>
                            <input type="date" id="eventDate" class="form-input mt-1 block w-full" value="${getData('eventDate')}">
                        </div>
                        <div>
                            <label for="eventLocation" class="block text-sm font-medium text-gray-700">Local (Cidade/Bairro)</label>
                            <input type="text" id="eventLocation" placeholder="Ex: Parque Ibirapuera, SP" class="form-input mt-1 block w-full" value="${getData('eventLocation')}">
                        </div>
                        <div class="md:col-span-2">
                            <label for="desiredToys" class="block text-sm font-medium text-gray-700">Brinquedos Desejados (Lista)</label>
                            <textarea id="desiredToys" rows="2" class="form-input mt-1 block w-full" placeholder="Pula-pula, piscina de bolinhas, escorrega...">${getData('desiredToys')}</textarea>
                        </div>
                    </div>
                `;
                        break;
                    case 4:
                        title = 'Proposta e Valores de Negociação';
                        htmlContent = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="estimatedValue" class="block text-sm font-medium text-gray-700">Valor Estimado de Fechamento (R$)</label>
                            <input type="number" id="estimatedValue" step="0.01" class="form-input mt-1 block w-full" value="${getData('estimatedValue')}">
                        </div>
                    </div>
                `;
                        break;
                    case 99:
                        title = 'Análise de Perda';
                        htmlContent = `
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="lossReason" class="block text-sm font-medium text-gray-700">Motivo da Locação Perdida</label>
                            <textarea id="lossReason" rows="2" class="form-input mt-1 block w-full" placeholder="Preço, concorrente, evento cancelado, etc.">${getData('lossReason')}</textarea>
                        </div>
                    </div>
                `;
                        break;
                    default:
                        break;
                }

                if (htmlContent) {
                    stageSpecificFieldsDiv.innerHTML = `
                <div>
                    <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200/50 pb-2 mb-4">${title}</h3>
                    ${htmlContent}
                </div>
            `;
                }
            };

            const collectStageSpecificData = (clientData) => {
                const stage = parseInt(document.getElementById('estagio').value);

                delete clientData.eventDate;
                delete clientData.eventLocation;
                delete clientData.desiredToys;
                delete clientData.estimatedValue;
                delete clientData.lossReason;

                switch (stage) {
                    case 2:
                        clientData.eventDate = document.getElementById('eventDate')?.value || '';
                        clientData.eventLocation = document.getElementById('eventLocation')?.value || '';
                        clientData.desiredToys = document.getElementById('desiredToys')?.value || '';
                        break;
                    case 4:
                        clientData.estimatedValue = parseFloat(document.getElementById('estimatedValue')?.value) || 0;
                        break;
                    case 99:
                        clientData.lossReason = document.getElementById('lossReason')?.value || '';
                        break;
                }
            }


            const handleFormSubmit = (e) => {
                e.preventDefault();
                const idInput = document.getElementById('client-id').value;
                const id = idInput ? parseFloat(idInput) : null;
                const fotoData = document.getElementById('fotoPreview').src;
                const clientType = document.querySelector('input[name="client-type"]:checked').value;

                const clientData = {
                    clientType: clientType,
                    fotoUrl: (fotoData.startsWith('data:image')) ? fotoData : (fotoData.startsWith('https://placehold.co') ? '' : fotoData),
                    telefone: document.getElementById('telefone').value,
                    telefoneReserva: document.getElementById('telefoneReserva').value,
                    email: document.getElementById('email').value,
                    instagram: document.getElementById('instagram').value,
                    enderecoResidencial: document.getElementById('enderecoResidencial').value,
                    estagio: parseInt(document.getElementById('estagio').value),
                    origem: document.getElementById('origem').value,
                    dataNegociacao: document.getElementById('dataNegociacao').value,
                    company: document.getElementById('company').value,
                    tipoEvento: document.getElementById('tipoEvento').value,
                    isRecorrente: document.getElementById('marcarComoRecorrente').checked,
                    anotacoes: document.getElementById('anotacoes').value,
                    followUpDate: document.getElementById('followUpDate').value,
                    followUpNotes: document.getElementById('followUpNotes').value,
                    historicoEventosFechados: []
                };

                collectStageSpecificData(clientData);

                if (clientType === 'PJ') {
                    clientData.nome = document.getElementById('pj-nome').value;
                    const cnpj = document.getElementById('pj-cnpj').value;
                    const repName = document.getElementById('pj-rep-nome').value;
                    const repCpf = document.getElementById('pj-rep-cpf').value;
                    clientData.cpf = repCpf;

                    const pjNote = `[PJ] CNPJ: ${cnpj}, Rep.: ${repName} (CPF: ${repCpf})`;
                    if (clientData.anotacoes) {
                        const notesWithoutPJ = clientData.anotacoes.split('\n').filter(line => !line.startsWith('[PJ]')).join('\n');
                        clientData.anotacoes = notesWithoutPJ + '\n' + pjNote;
                    } else {
                        clientData.anotacoes = pjNote;
                    }
                } else {
                    clientData.nome = document.getElementById('nome').value;
                    clientData.cpf = document.getElementById('cpf').value;
                    clientData.rg = document.getElementById('rg').value;
                    clientData.dataNascimento = document.getElementById('dataNascimento').value;
                }

                document.querySelectorAll('.closed-event-entry').forEach(eventoEl => {
                    const eventoId = eventoEl.dataset.id;
                    const brinquedosAlugados = [];
                    let valorTotal = 0;
                    eventoEl.querySelectorAll('.toy-entry').forEach(brinquedoEl => {
                        const nome = brinquedoEl.querySelector('.toy-select').value;
                        const valor = parseFloat(brinquedoEl.querySelector('.toy-value').value) || 0;
                        if (nome) {
                            brinquedosAlugados.push({ nome, valor });
                            valorTotal += valor;
                        }
                    });

                    clientData.historicoEventosFechados.push({
                        id: eventoId,
                        dataEvento: eventoEl.querySelector('.closed-event-date').value,
                        enderecoEvento: eventoEl.querySelector('.closed-event-address').value,
                        cep: eventoEl.querySelector('.closed-event-cep').value,
                        googleMaps: eventoEl.querySelector('.closed-event-maps').value,
                        horarioInicio: eventoEl.querySelector('.closed-event-start-time').value,
                        horarioTermino: eventoEl.querySelector('.closed-event-end-time').value,
                        nomeAniversariante: eventoEl.querySelector('.celebrant-name').value,
                        nascimentoAniversariante: eventoEl.querySelector('.celebrant-birthdate').value,
                        feedbackCliente: eventoEl.querySelector('.feedback-textarea').value,
                        brinquedosAlugados: brinquedosAlugados,
                        valorTotal: valorTotal
                    });
                });

                let updatedClient;
                if (id) {
                    const originalClient = clients.find(c => c.id == id);
                    const oldEventIds = (originalClient.historicoEventosFechados || []).map(e => Number(e.id));
                    const newEventIds = clientData.historicoEventosFechados.map(e => Number(e.id));

                    const deletedEventIds = oldEventIds.filter(oldId => !newEventIds.includes(oldId));

                    if (deletedEventIds.length > 0) {
                        let agendaEvents = JSON.parse(localStorage.getItem('events')) || [];
                        agendaEvents = agendaEvents.filter(event => !deletedEventIds.includes(Number(event.id)));
                        localStorage.setItem('events', JSON.stringify(agendaEvents));
                        showToast('Eventos removidos também da Agenda!', false);
                    }

                    const index = clients.findIndex(c => c.id == id);
                    // Mantém o histórico de conversas existente ao salvar o formulário principal
                    clientData.conversationHistory = clients[index].conversationHistory || [];
                    clients[index] = { ...clients[index], ...clientData };
                    updatedClient = clients[index];
                    currentClientId = id;
                } else {
                    const newClient = { id: Date.now(), createdAt: Date.now(), conversationHistory: [], ...clientData };
                    clients.push(newClient);
                    updatedClient = newClient;
                    currentClientId = newClient.id;
                }

                saveClients();
                syncClientEventsToAgenda(updatedClient);

                closeModal();
                renderClientList();
                showClientDetails(currentClientId);
            };

            // --- Funções Auxiliares de UI ---
            const showView = (viewToShow) => ([welcomeView, detailView].forEach(view => view.classList.add('hidden')), viewToShow.classList.remove('hidden'));

            const closeDetailView = () => {
                clientListContainer.classList.add('lg:col-span-12');
                clientListContainer.classList.remove('lg:col-span-4');
                mainContent.classList.add('hidden');
                currentClientId = null;
                renderClientList();
            };

            const closeModal = () => {
                modalOverlay.classList.add('hidden');

                const idInput = document.getElementById('client-id').value;
                if (idInput === '') {
                    closeDetailView();
                }
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    fotoPreviewImg.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const addClosedEventField = (evento = {}) => {
                const eventoId = evento.id || Date.now();
                const div = document.createElement('div');
                div.className = 'closed-event-entry p-4 bg-gray-50/50 rounded-md border border-gray-200/50 space-y-4';
                div.dataset.id = eventoId;

                div.innerHTML = `
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-gray-800">Detalhes do Evento</h4>
                <button type="button" class="remove-event-btn bg-red-100 text-red-700 hover:bg-red-200 font-bold py-1 px-3 rounded-md">× Remover Evento</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Data do Evento</label>
                    <input type="date" value="${evento.dataEvento || ''}" class="closed-event-date form-input mt-1 w-full">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                         <label class="block text-sm font-medium text-gray-700">Início</label>
                        <input type="time" value="${evento.horarioInicio || ''}" class="closed-event-start-time form-input mt-1 w-full">
                    </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700">Término</label>
                        <input type="time" value="${evento.horarioTermino || ''}" class="closed-event-end-time form-input mt-1 w-full">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Endereço do Evento</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${evento.enderecoEvento || ''}" class="closed-event-address form-input mt-1 w-full">
                        <button type="button" class="search-maps-btn bg-blue-100/50 hover:bg-blue-200/50 text-blue-800 text-sm font-semibold py-2 px-3 rounded-md mt-1 border border-blue-200">Buscar no Mapa</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" value="${evento.cep || ''}" class="closed-event-cep form-input mt-1 w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Link Google Maps</label>
                    <input type="text" value="${evento.googleMaps || ''}" class="closed-event-maps form-input mt-1 w-full">
                </div>
            </div>

            <div class="border-t pt-4">
                 <h5 class="font-semibold text-gray-700 mb-2">Aniversariante</h5>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" value="${evento.nomeAniversariante || ''}" class="celebrant-name form-input mt-1 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
                        <input type="date" value="${evento.nascimentoAniversariante || ''}" class="celebrant-birthdate form-input mt-1 w-full">
                    </div>
                </div>
            </div>

            <div class="brinquedos-container border-t pt-4 space-y-2">
                <h5 class="font-semibold text-gray-700">Brinquedos Alugados</h5>
            </div>
            <button type="button" class="add-toy-btn text-sm font-semibold text-blue-600 hover:text-blue-800">+ Adicionar Brinquedo</button>
            <p class="text-right font-bold">Total do Evento: <span class="total-event-value">R$ 0,00</span></p>

            <div class="border-t pt-4">
                 <label class="block text-sm font-medium text-gray-700">Feedback do Cliente (após o evento)</label>
                 <textarea class="feedback-textarea form-input mt-1 block w-full" rows="3" placeholder="Insira o feedback recebido do cliente aqui...">${evento.feedbackCliente || ''}</textarea>
            </div>
        `;
                eventosFechadosContainer.appendChild(div);

                div.querySelector('.search-maps-btn').addEventListener('click', (e) => {
                    const addressInput = e.target.parentElement.querySelector('.closed-event-address');
                    const address = addressInput.value;
                    if (address) {
                        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                        window.open(url, '_blank');
                    } else {
                        showToast('Por favor, insira um endereço para buscar.', true);
                    }
                });

                const brinquedosContainer = div.querySelector('.brinquedos-container');
                const totalValueEl = div.querySelector('.total-event-value');

                const updateEventTotal = () => {
                    let total = 0;
                    div.querySelectorAll('.toy-value').forEach(input => {
                        total += parseFloat(input.value) || 0;
                    });
                    totalValueEl.textContent = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };

                const addToyField = (brinquedo = {}) => {
                    const toyDiv = document.createElement('div');
                    toyDiv.className = 'flex items-center space-x-2 toy-entry';
                    const toyOptions = ['', ...toysList].map(t => `<option value="${t}" ${t === brinquedo.nome ? 'selected' : ''}>${t || 'Selecione...'}</option>`).join('');
                    toyDiv.innerHTML = `
                <select class="toy-select form-input mt-1 block w-full">${toyOptions}</select>
                <input type="number" value="${brinquedo.valor || ''}" placeholder="Valor (R$)" class="toy-value form-input mt-1 w-40">
                <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-semibold p-2">×</button>
            `;
                    brinquedosContainer.appendChild(toyDiv);
                    toyDiv.querySelector('.remove-btn').addEventListener('click', () => {
                        toyDiv.remove();
                        updateEventTotal();
                    });
                    toyDiv.querySelector('.toy-value').addEventListener('input', updateEventTotal);
                };

                if (evento.brinquedosAlugados && evento.brinquedosAlugados.length > 0) {
                    evento.brinquedosAlugados.forEach(b => addToyField(b));
                } else {
                    addToyField();
                }
                updateEventTotal();

                div.querySelector('.add-toy-btn').addEventListener('click', () => addToyField());
                div.querySelector('.remove-event-btn').addEventListener('click', () => div.remove());
            };

            const handleDeleteClient = () => {
                if (!currentClientId) return;
                const clientToDelete = clients.find(c => c.id === currentClientId);

                if (!clientToDelete) return;

                // MUDANÇA: Substituído confirm() por um modal customizado (ou, por simplicidade no exemplo, um prompt simples)
                // O ideal seria um modal customizado, mas 'confirm()' é mais simples de manter no exemplo.
                // NOTA: Em um ambiente de produção real, 'confirm()' pode ser bloqueado em iframes.
                // Vamos manter o confirm() por enquanto, assumindo que funciona no ambiente de teste.
                if (!confirm(`Tem certeza que deseja EXCLUIR o cliente ${clientToDelete.nome} e todo o seu histórico? Esta ação é irreversível.`)) return;

                let agendaEvents = JSON.parse(localStorage.getItem('events')) || [];
                const updatedAgendaEvents = agendaEvents.filter(e => e.clientName.toLowerCase() !== clientToDelete.nome.toLowerCase());
                localStorage.setItem('events', JSON.stringify(updatedAgendaEvents));

                clients = clients.filter(c => c.id !== currentClientId);
                saveClients();

                showToast(`Cliente ${clientToDelete.nome} e seus eventos foram removidos.`, false);

                currentClientId = null;
                renderClientList();

                closeDetailView();
            };

            // ===================================================================
            // FUNÇÃO: Sincroniza eventos do CRM para a Agenda
            // ===================================================================
            const syncClientEventsToAgenda = (crmClient) => {
                let agendaEvents = JSON.parse(localStorage.getItem('events')) || [];
                const agendaCompanies = JSON.parse(localStorage.getItem('companies')) || [];
                const agendaToys = JSON.parse(localStorage.getItem('toys')) || [];

                const crmEventIds = (crmClient.historicoEventosFechados || []).map(e => Number(e.id));

                const updatedAgendaEvents = agendaEvents.filter(agendaEvent => {
                    const isSameClient = agendaEvent.clientName && (agendaEvent.clientName.toLowerCase() === crmClient.nome.toLowerCase());
                    return !isSameClient || (isSameClient && crmEventIds.includes(Number(agendaEvent.id)));
                });


                (crmClient.historicoEventosFechados || []).forEach(crmEvent => {
                    if (!crmEvent.dataEvento || !crmEvent.horarioInicio || !crmEvent.horarioTermino) {
                        return;
                    }
                    const eventId = Number(crmEvent.id);
                    const company = agendaCompanies.find(c => c.name === crmClient.company);

                    const agendaEventObject = {
                        id: eventId,
                        date: crmEvent.dataEvento,
                        yourCompanyId: company ? company.id : null,
                        clientAddress: crmEvent.enderecoEvento || crmClient.enderecoResidencial || '',
                        eventObservations: crmEvent.feedbackCliente || '',
                        toys: (crmEvent.brinquedosAlugados || []).map(crmToy => {
                            const toyInfo = agendaToys.find(t => t.name === crmToy.nome);
                            return {
                                id: toyInfo ? toyInfo.id : Date.now() + Math.random(),
                                quantity: 1,
                                price: crmToy.valor || 0
                            };
                        }),
                        startTime: crmEvent.horarioInicio,
                        endTime: crmEvent.horarioTermino,
                        price: crmEvent.valorTotal,
                        subtotal: crmEvent.valorTotal,
                        discountType: 'fixed',
                        discountValue: 0
                    };

                    if (crmClient.clientType === 'PJ') {
                        const cnpjMatch = crmClient.anotacoes?.match(/CNPJ: (.*?)(,|$|\n)/);
                        const repMatch = crmClient.anotacoes?.match(/Rep\.: (.*?) \(CPF: (.*?)\)/);

                        agendaEventObject.clientType = 'PJ';
                        agendaEventObject.clientName = crmClient.nome;
                        agendaEventObject.cnpj = cnpjMatch ? cnpjMatch[1].trim() : '';
                        agendaEventObject.companyAddress = crmClient.enderecoResidencial;
                        agendaEventObject.repName = repMatch ? repMatch[1].trim() : '';
                        agendaEventObject.repCpf = repMatch ? repMatch[2].trim() : crmClient.cpf;
                        agendaEventObject.repPhone = crmClient.telefone;
                        agendaEventObject.repPhoneBackup = crmClient.telefoneReserva;
                    } else {
                        agendaEventObject.clientType = 'PF';
                        agendaEventObject.clientName = crmClient.nome;
                        agendaEventObject.clientCpf = crmClient.cpf;
                        agendaEventObject.clientRg = crmClient.rg;
                        agendaEventObject.clientPhone = crmClient.telefone;
                        agendaEventObject.clientPhoneBackup = crmClient.telefoneReserva;
                    }

                    const existingEventIndex = updatedAgendaEvents.findIndex(e => Number(e.id) === eventId);
                    if (existingEventIndex > -1) {
                        updatedAgendaEvents[existingEventIndex] = agendaEventObject;
                    } else {
                        updatedAgendaEvents.push(agendaEventObject);
                    }
                });

                localStorage.setItem('events', JSON.stringify(updatedAgendaEvents));
                showToast('Eventos sincronizados com a Agenda!', false);
            };

            // --- Gemini API & API Key Functions ---
            const showToast = (message, isError = true) => {
                toastMessage.textContent = message;
                toast.classList.toggle('bg-red-600', isError);
                toast.classList.toggle('bg-green-600', !isError);
                toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                toast.classList.remove('hidden');
                toast.classList.add('toast-enter');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('toast-enter');
                }, 5000);
            };

            const getApiKey = () => localStorage.getItem('geminiApiKey');

            const showApiKeyModal = () => {
                const currentKey = getApiKey();
                apiKeyInput.value = currentKey || '';
                apiKeyModal.classList.remove('hidden');
            };

            const saveApiKey = () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    apiKeyModal.classList.add('hidden');
                    showToast("Chave da API salva com sucesso!", false);
                } else {
                    showToast("Por favor, insira uma chave da API.");
                }
            };

            const callGeminiAPI = async (prompt) => {
                const apiKey = getApiKey();
                if (!apiKey) {
                    showToast("Chave da API do Gemini não configurada.");
                    showApiKeyModal();
                    return;
                }

                geminiModal.classList.remove('hidden');
                geminiModalContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loader"></div></div>';
                geminiModalFooter.classList.add('hidden');

                // Use o gemini-2.5-flash-preview-09-2025
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorResult = await response.json();
                        console.error("Erro da API Gemini:", errorResult);
                        const errorMessage = errorResult.error?.message.includes("API key not valid")
                            ? "Sua chave da API é inválida. Verifique nas configurações."
                            : `Erro da API: ${errorResult.error?.message || response.statusText}`;
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        geminiModalContent.innerHTML = `<div class="whitespace-pre-wrap p-2 bg-gray-100/50 rounded">${text}</div>`;
                        geminiModalFooter.classList.remove('hidden');
                    } else {
                        const blockReason = result.candidates?.[0]?.finishReason;
                        const safetyRatings = result.candidates?.[0]?.safetyRatings;
                        console.warn('Resposta da IA vazia ou bloqueada:', { blockReason, safetyRatings });
                        geminiModalContent.innerHTML = `<p class="text-red-500">Não foi possível obter uma resposta da IA (Motivo: ${blockReason || 'Vazio'}). Tente novamente.</p>`;
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    geminiModalContent.innerHTML = `<p class="text-red-500">Ocorreu um erro ao chamar a IA: ${error.message}</p>`;
                }
            };

            const handleGenerateSummary = () => {
                if (!currentClientId) return;
                const client = clients.find(c => c.id === currentClientId);
                if (!client) return;

                const pastEventsCount = client.historicoEventosFechados?.filter(e => e.dataEvento && new Date(e.dataEvento) < new Date()).length || 0;
                const futureEventsCount = client.historicoEventosFechados?.filter(e => e.dataEvento && new Date(e.dataEvento) >= new Date()).length || 0;

                const prompt = `
            Resuma o perfil e o histórico do cliente a seguir em um parágrafo conciso (máximo de 3 frases). Destaque a importância do cliente e possíveis próximas ações.
            Dados do Cliente:
            - Nome: ${client.nome}
            - Empresa de Contato: ${client.company}
            - Estágio Atual: ${estagios[client.estagio].text}
            - Eventos Realizados: ${pastEventsCount}
            - Próximos Eventos Agendados: ${futureEventsCount}
            - Anotações Importantes: ${client.anotacoes || 'Nenhuma'}
        `;

                geminiModalTitle.textContent = `✨ Resumo de ${client.nome}`;
                callGeminiAPI(prompt.trim());
            };

            const handleRelationshipMessage = () => {
                if (!currentClientId) return;
                const client = clients.find(c => c.id === currentClientId);
                if (!client) return;

                const stage = client.estagio;
                let promptContext = '';

                if (stage === 1 || stage === 2) {
                    promptContext = `
                O cliente está em fase inicial (Apresentação/Sondagem).
                **TAREFA:** Gere 2 (duas) opções de mensagem de follow-up para reengajar o cliente, perguntando se ele teve tempo de analisar a proposta inicial ou se precisa de mais alguma informação sobre os brinquedos.
                Seja breve e proativo.
            `;
                } else if (stage === 3 || stage === 4) {
                    promptContext = `
                O cliente está em fase de negociação (Proposta/Negociação).
                **TAREFA:** Gere 2 (duas) opções de mensagem de follow-up para quebrar o silêncio ou impulsionar o fechamento.
                Uma opção deve ser mais suave (ex: "Alguma novidade?"), e a outra pode oferecer um pequeno incentivo (ex: "Consigo manter o valor X se fecharmos hoje").
            `;
                } else if (stage === 5 || stage === 6) {
                    const pastEvents = client.historicoEventosFechados?.filter(e => e.dataEvento && new Date(e.dataEvento + 'T00:00:00') < new Date()) || [];
                    if (pastEvents.length > 0) {
                        promptContext = `
                    O cliente já realizou um evento (Pós-venda).
                    **TAREFA:** Gere 2 (duas) opções de mensagem.
                    1. Uma mensagem de pós-venda para pedir feedback sobre o último evento.
                    2. Uma mensagem de reativação (upsell), sugerindo uma nova locação para um próximo evento ou aniversário.
                `;
                    } else {
                        promptContext = `
                    O cliente acabou de fechar um evento (Locação Agendada).
                    **TAREFA:** Gere 2 (duas) opções de mensagem.
                    1. Uma mensagem de confirmação, agradecendo a confiança e confirmando os detalhes básicos (sem ser muito longa).
                    2. Uma mensagem para ser enviada 1-2 dias antes do evento, confirmando que está tudo certo.
                `;
                    }
                } else if (stage === 99) {
                    promptContext = `
                Esta locação foi marcada como "Perdida". Motivo: ${client.lossReason || 'Não informado'}.
                **TAREFA:** Gere 1 (uma) mensagem de "recuperação" para ser enviada após algum tempo. A mensagem deve ser amigável, sem pressão,
                apenas para reabrir o canal e dizer que estamos à disposição para uma futura oportunidade.
            `;
                } else {
                    promptContext = `
                **TAREFA:** Gere 2 (duas) mensagens curtas e amigáveis para o cliente '${client.nome}'.
                1.  **MENSAGEM DE PÓS-VENDA:** Crie uma mensagem para ser enviada alguns dias após um evento, agradecendo pela preferência e pedindo um feedback.
                2.  **MENSAGEM DE REATIVAÇÃO:** Crie uma mensagem para relembrar a data e oferecendo os serviços novamente para uma futura festa.
            `;
                }


                const prompt = `
            Aja como um(a) gerente de relacionamento amigável da '${client.company || 'nossa empresa'}', uma empresa de locação de brinquedos.
            O cliente é '${client.nome}' e seu estágio atual é '${estagios[client.estagio].text}'.

            ${promptContext}

            Formate a resposta de forma clara, com títulos para cada mensagem sugerida.
        `;

                geminiModalTitle.textContent = `✨ Sugestões de Mensagem (Fase: ${estagios[client.estagio].text})`;
                callGeminiAPI(prompt.trim());
            };


            const handleFeedbackAnalysis = (e) => {
                const feedback = decodeURIComponent(e.target.dataset.feedback);
                if (!feedback) return;

                const prompt = `
            Analise o seguinte feedback de um cliente sobre um serviço de locação de brinquedos.
            Resuma os pontos principais e identifique claramente os "Pontos Positivos" e os "Pontos a Melhorar".
            Seja direto e objetivo.

            Feedback: "${feedback}"
        `;
                geminiModalTitle.textContent = `✨ Análise de Feedback`;
                callGeminiAPI(prompt.trim());
            };

            const handleGlobalAnalysis = () => {
                if (clients.length === 0) {
                    showToast("Não há clientes cadastrados para analisar.", true);
                    return;
                }

                const totalClients = clients.length;
                const clientsByCompany = clients.reduce((acc, client) => {
                    if (client.company) acc[client.company] = (acc[client.company] || 0) + 1;
                    return acc;
                }, {});
                const clientsByStage = clients.reduce((acc, client) => {
                    const stageName = estagios[client.estagio]?.text || 'Estágio Desconhecido';
                    acc[stageName] = (acc[stageName] || 0) + 1;
                    return acc;
                }, {});

                const allToys = clients.flatMap(c => c.historicoEventosFechados?.flatMap(e => (e.brinquedosAlugados || []).map(b => b.nome)) || []);
                const toyPopularity = allToys.reduce((acc, toy) => {
                    if (toy) acc[toy] = (acc[toy] || 0) + 1;
                    return acc;
                }, {});

                const allFeedbacks = clients.flatMap(c => c.historicoEventosFechados?.map(e => e.feedbackCliente).filter(Boolean) || []);

                const prompt = `
            Aja como um consultor de negócios analisando os dados de um CRM de uma empresa de locação de brinquedos.
            Abaixo estão os dados consolidados de todos os clientes.

            **Dados Gerais:**
            - Número Total de Clientes: ${totalClients}
            - Clientes por Empresa: ${JSON.stringify(clientsByCompany)}
            - Clientes por Estágio no Funil: ${JSON.stringify(clientsByStage)}
            - Popularidade dos Brinquedos (número de vezes alugado): ${JSON.stringify(toyPopularity)}
            - Amostra de Feedbacks Recebidos: [${allFeedbacks.slice(0, 5).join('; ')}]

            **Sua Tarefa:**
            Baseado nos dados acima, forneça uma análise estratégica em 3 partes:
            1.  **Pontos Fortes:** Identifique 2-3 pontos que a empresa está mandando bem. (Ex: alta taxa de clientes fiéis, popularidade de um brinquedo específico, etc.).
            2.  **Pontos a Melhorar:** Identifique 2-3 oportunidades ou pontos fracos. (Ex: muitos clientes parados em um estágio específico, baixa variedade de brinquedos populares, etc.).
            3.  **Sugestões Acionáveis:** Dê 2-3 sugestões práticas e diretas que o dono do negócio pode implementar para crescer, baseadas nos pontos fortes e fracos identificados.

            Seja conciso e use uma linguagem de negócios fácil de entender.
        `;

                geminiModalTitle.textContent = `✨ Análise Geral dos Clientes`;
                callGeminiAPI(prompt.trim());
            };

            // ===================================================================
            // MUDANÇA: Função renomeada e modificada para aceitar descrição e elemento do botão
            // ===================================================================
            const handleSuggestFollowUpFromDescription = async (client, description, btnElement) => {
                if (!description) {
                    showToast("Não há descrição para a IA analisar.", true);
                    return;
                }

                const apiKey = getApiKey();
                if (!apiKey) {
                    showToast("Chave da API do Gemini não configurada.", true);
                    showApiKeyModal();
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const prompt = `
            Aja como um assistente de CRM. Analise a descrição de um contato com um cliente e sugira um follow-up.
            Data de Hoje: ${today}
            Cliente: ${client.nome}
            Descrição do Contato:
            ---
            ${description}
            ---
            
            Sugira uma data (AAAA-MM-DD), uma hora (HH:MM) e uma breve nota de ação (máximo 10 palavras).
            - Se o cliente pediu para "retornar amanhã", use a data de amanhã.
            - Se o cliente disse "semana que vem", sugira 7 dias.
            - Se disse "início da semana", sugira a próxima segunda-feira.
            - Se disse "daqui a 2 dias", calcule 2 dias.
            - Se não houver menção de data, sugira 3 dias a partir de hoje.
            - Para a hora, se não mencionada, sugira um horário comercial (ex: 10:00 ou 14:00).
            
            Responda APENAS no formato JSON:
            {
                "suggestedDate": "AAAA-MM-DD",
                "suggestedTime": "HH:MM",
                "suggestedNote": "Breve descrição da ação"
            }
        `;

                const btn = btnElement; // MUDANÇA: Usa o elemento do botão passado como argumento
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>';
                btn.disabled = true;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorResult = await response.json();
                        console.error("Erro da API Gemini:", errorResult);
                        throw new Error(errorResult.error?.message || "Erro na resposta da API.");
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const suggestion = JSON.parse(jsonText);

                        if (suggestion.suggestedDate && suggestion.suggestedNote && suggestion.suggestedTime) {
                            const suggestionBox = document.getElementById('history-followup-suggestion-box');
                            const suggestionText = document.getElementById('history-followup-suggestion-text');

                            const displayDate = new Date(suggestion.suggestedDate + 'T' + suggestion.suggestedTime + ':00').toLocaleDateString('pt-BR');

                            suggestionText.innerHTML = `Sugestão: <strong>${displayDate} às ${suggestion.suggestedTime}</strong><br>Nota: <em>${suggestion.suggestedNote}</em>`;

                            suggestionBox.dataset.date = suggestion.suggestedDate;
                            suggestionBox.dataset.time = suggestion.suggestedTime;
                            suggestionBox.dataset.note = suggestion.suggestedNote;

                            suggestionBox.classList.remove('hidden');
                        } else {
                            throw new Error("Resposta da IA em formato inesperado.");
                        }
                    } else {
                        const blockReason = result.candidates?.[0]?.finishReason;
                        console.warn('Resposta da IA vazia ou bloqueada:', { blockReason });
                        throw new Error(`A IA não retornou uma sugestão (Motivo: ${blockReason || 'Vazio'}).`);
                    }
                } catch (error) {
                    console.error("Erro ao sugerir follow-up do histórico:", error);
                    showToast(`Erro ao sugerir: ${error.message}`, true);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };


            const copyToClipboard = () => {
                const contentEl = geminiModalContent.querySelector('div');
                if (!contentEl) return;
                const content = contentEl.innerText;

                try {
                    navigator.clipboard.writeText(content).then(() => {
                        geminiCopyBtn.textContent = 'Copiado!';
                        setTimeout(() => {
                            geminiCopyBtn.textContent = 'Copiar';
                        }, 2000);
                    }).catch(err => {
                        console.warn('Falha no Clipboard API, usando fallback:', err);
                        copyFallback(content);
                    });
                } catch (err) {
                    console.warn('Clipboard API indisponível, usando fallback:', err);
                    copyFallback(content);
                }
            };

            const copyFallback = (text) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = 0;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    geminiCopyBtn.textContent = 'Copiado!';
                    setTimeout(() => {
                        geminiCopyBtn.textContent = 'Copiar';
                    }, 2000);
                } catch (err) {
                    console.error('Falha no fallback de cópia:', err);
                    showToast('Falha ao copiar. Copie manualmente.');
                }
                document.body.removeChild(textArea);
            };


            const handleUrlParameters = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const clientIdParam = urlParams.get('clientId');
                if (clientIdParam) {
                    const clientId = parseFloat(clientIdParam);
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        currentClientId = clientId;
                        showClientDetails(clientId);
                        renderClientList();

                        setTimeout(() => {
                            const clientElement = document.getElementById(`client-list-item-${clientId}`);
                            if (clientElement) {
                                clientElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 100);
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            };

            const toggleClientFormFields = () => {
                const isPJ = clientTypePjRadio.checked;
                pfFieldsDiv.style.display = isPJ ? 'none' : 'block';
                pjFieldsDiv.style.display = isPJ ? 'block' : 'none';

                nomeInput.required = !isPJ;
                pjNomeInput.required = isPJ;

                enderecoLabel.textContent = isPJ ? 'Endereço da Sede' : 'Endereço Residencial';
            };


            // --- Setup e Event Listeners ---
            const init = async () => {
                await loadData();

                for (const key in estagios) {
                    estagioSelect.innerHTML += `<option value="${key}">${estagios[key].text}</option>`;
                }
                companySelect.innerHTML = '<option value="">Sem empresa</option>' + companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                addClientBtn.addEventListener('click', () => showForm('add'));
                editClientBtn.addEventListener('click', () => { if (currentClientId) showForm('edit', currentClientId); });
                deleteClientBtn.addEventListener('click', handleDeleteClient);
                cancelBtn.addEventListener('click', closeModal);
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
                clientForm.addEventListener('submit', handleFormSubmit);
                addClosedEventBtn.addEventListener('click', () => addClosedEventField());
                fotoUploadInput.addEventListener('change', handlePhotoUpload);

                estagioSelect.addEventListener('change', () => {
                    const currentClient = clients.find(c => c.id === parseFloat(document.getElementById('client-id').value));
                    renderStageSpecificFields(currentClient);
                });

                clientTypePfRadio.addEventListener('change', toggleClientFormFields);
                clientTypePjRadio.addEventListener('change', toggleClientFormFields);

                geminiSummaryBtn.addEventListener('click', handleGenerateSummary);
                geminiRelationshipBtn.addEventListener('click', handleRelationshipMessage);
                globalAnalysisBtn.addEventListener('click', handleGlobalAnalysis);
                geminiCloseBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
                geminiCopyBtn.addEventListener('click', copyToClipboard);
                settingsBtn.addEventListener('click', showApiKeyModal);
                cancelApiKeyBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
                saveApiKeyBtn.addEventListener('click', saveApiKey);
                window.addEventListener('click', (e) => {
                    if (e.target == apiKeyModal) apiKeyModal.classList.add('hidden');
                    if (e.target == geminiModal) geminiModal.classList.add('hidden');
                });

                searchBar.addEventListener('input', renderClientList);

                const closeDetailViewBtn = document.getElementById('close-detail-view-btn');
                closeDetailViewBtn.addEventListener('click', closeDetailView);


                sortByNameBtn.addEventListener('click', () => {
                    if (viewState.sortKey === 'name') {
                        viewState.sortDir = viewState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        viewState.sortKey = 'name';
                        viewState.sortDir = 'asc';
                    }
                    renderClientList();
                });
                sortByNegotiationBtn.addEventListener('click', () => {
                    if (viewState.sortKey === 'negotiation') {
                        viewState.sortDir = viewState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        viewState.sortKey = 'negotiation';
                        viewState.sortDir = 'desc';
                    }
                    renderClientList();
                });
                sortByFollowUpBtn.addEventListener('click', () => {
                    if (viewState.sortKey === 'followup') {
                        viewState.sortDir = viewState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        viewState.sortKey = 'followup';
                        viewState.sortDir = 'asc';
                    }
                    renderClientList();
                });
                sortByEventBtn.addEventListener('click', () => {
                    if (viewState.sortKey === 'event') {
                        viewState.sortDir = viewState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        viewState.sortKey = 'event';
                        viewState.sortDir = 'asc';
                    }
                    renderClientList();
                });
                filterByCompanyBtn.addEventListener('click', () => {
                    viewState.companyFilterIndex = (viewState.companyFilterIndex + 1) % FILTER_CYCLE.length;
                    renderClientList();
                });

                const sortByPhoneBtn = document.getElementById('sort-by-phone');
                sortByPhoneBtn.addEventListener('click', () => {
                    if (viewState.sortKey === 'phone') {
                        viewState.sortDir = viewState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        viewState.sortKey = 'phone';
                        viewState.sortDir = 'asc';
                    }
                    renderClientList();
                });

                // Botão de Sugestão de Follow-up (do formulário principal)
                document.getElementById('ai-suggest-followup-btn').addEventListener('click', async () => {
                    const anotacoes = document.getElementById('anotacoes').value;
                    const clienteNome = document.getElementById('nome').value || document.getElementById('pj-nome').value;
                    const estagioAtual = estagios[document.getElementById('estagio').value].text;
                    const today = new Date().toISOString().split('T')[0];

                    if (!anotacoes) {
                        showToast("Por favor, preencha as anotações primeiro para a IA analisar.", true);
                        return;
                    }

                    const prompt = `
                Aja como um assistente de CRM inteligente. Analise as anotações de um cliente e sugira um próximo follow-up.
                Data de Hoje: ${today}
                Cliente: ${clienteNome}
                Estágio Atual: ${estagioAtual}
                Anotações:
                ---
                ${anotacoes}
                ---
                
                Baseado nas anotações, sugira uma data (formato AAAA-MM-DD) e uma breve nota de ação (máximo 10 palavras) para o próximo follow-up.
                Se o cliente mencionou uma data específica, use-a.
                Se o cliente pareceu indeciso, sugira 2-3 dias.
                Se a anotação é sobre um evento que acabou de acontecer, sugira um follow-up em 7 dias para feedback.
                Se não houver contexto claro, sugira um follow-up em 5 dias.

                Responda APENAS no seguinte formato JSON, sem nenhum outro texto:
                {
                    "suggestedDate": "AAAA-MM-DD",
                    "suggestedNote": "Breve descrição da ação"
                }
            `;

                    const btn = document.getElementById('ai-suggest-followup-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>';
                    btn.disabled = true;

                    const apiKey = getApiKey();
                    if (!apiKey) {
                        showToast("Chave da API do Gemini não configurada.", true);
                        showApiKeyModal();
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorResult = await response.json();
                            console.error("Erro da API Gemini:", errorResult);
                            throw new Error(errorResult.error?.message || "Erro na resposta da API.");
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                            const suggestion = JSON.parse(jsonText);

                            if (suggestion.suggestedDate && suggestion.suggestedNote) {
                                document.getElementById('followUpDate').value = suggestion.suggestedDate;
                                document.getElementById('followUpNotes').value = suggestion.suggestedNote;
                                showToast("Follow-up sugerido pela IA!", false);
                            } else {
                                throw new Error("Resposta da IA em formato inesperado.");
                            }
                        } else {
                            const blockReason = result.candidates?.[0]?.finishReason;
                            console.warn('Resposta da IA vazia ou bloqueada:', { blockReason });
                            throw new Error(`A IA não retornou uma sugestão (Motivo: ${blockReason || 'Vazio'}).`);
                        }
                    } catch (error) {
                        console.error("Erro ao sugerir follow-up:", error);
                        showToast(`Erro ao sugerir: ${error.message}`, true);
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                });


                renderClientList();
                handleUrlParameters();
            };

            init();

            // --- PARTICLE BACKGROUND SCRIPT ---
            const canvas = document.getElementById('particles-js'); const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particlesArray; let mouse = { x: null, y: null, radius: (canvas.height / 80) * (canvas.width / 80) };
            window.addEventListener('mousemove', (event) => { mouse.x = event.x; mouse.y = event.y; });
            class Particle { constructor(x, y, directionX, directionY, size, color) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = 'rgba(100, 116, 139, 0.4)'; ctx.fill(); } update() { if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX; if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY; let dx = mouse.x - this.x; let dy = mouse.y - this.y; let distance = Math.sqrt(dx * dx + dy * dy); if (distance < mouse.radius + this.size) { if (mouse.x < this.x && this.x < canvas.width - this.size * 10) this.x += 1; if (mouse.x > this.x && this.x > this.size * 10) this.x -= 1; if (mouse.y < this.y && this.y < canvas.height - this.size * 10) this.y += 1; if (mouse.y > this.y && this.y > this.size * 10) this.y -= 1; } this.x += this.directionX; this.y += this.directionY; this.draw(); } }
            function initParticles() { particlesArray = []; let numberOfParticles = (canvas.height * canvas.width) / 9000; for (let i = 0; i < numberOfParticles; i++) { let size = (Math.random() * 2) + 1; let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2); let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2); let directionX = (Math.random() * .4) - .2; let directionY = (Math.random() * .4) - .2; particlesArray.push(new Particle(x, y, directionX, directionY, size, 'rgba(100, 116, 139, 0.4)')); } }
            function connectParticles() { let opacityValue = 1; for (let a = 0; a < particlesArray.length; a++) { for (let b = a; b < particlesArray.length; b++) { let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y)); if (distance < (canvas.width / 7) * (canvas.height / 7)) { opacityValue = 1 - (distance / 20000); ctx.strokeStyle = `rgba(100, 116, 139, ${opacityValue * 0.5})`; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke(); } } } }
            function animateParticles() { requestAnimationFrame(animateParticles); ctx.clearRect(0, 0, innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update(); connectParticles(); }
            window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; mouse.radius = ((canvas.height / 80) * (canvas.width / 80)); initParticles(); });
            window.addEventListener('mouseout', () => { mouse.x = undefined; mouse.y = undefined; });
            initParticles(); animateParticles();
        });
    </script>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="bottom-nav">
        <a href="./Dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </a>
        <a href="./Agenda de eventos.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Agenda</span>
        </a>
        <a href="./Sistema Gestão Financeira.html" class="nav-item">
            <i class="fas fa-wallet"></i>
            <span>Financeiro</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
    </nav>

    <!-- Sistema de Autenticação -->

    <script src="js/protect.js"></script>

</body>

</html>