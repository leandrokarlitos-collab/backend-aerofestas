<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportar Dados Financeiros</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">üí∞ Exportar Dados do Sistema Financeiro</h1>
        
        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
            <h2 class="font-bold mb-2">‚ö†Ô∏è IMPORTANTE:</h2>
            <p class="text-sm mb-2">Este arquivo deve ser aberto a partir da pasta <code class="bg-gray-200 px-2 py-1 rounded">example/</code> onde os dados do Sistema de Gest√£o Financeira est√£o armazenados.</p>
            <p class="text-sm">Os dados financeiros s√£o SEPARADOS dos dados da Agenda de Eventos!</p>
        </div>

        <div id="status" class="mb-6"></div>

        <button onclick="exportarDadosFinanceiros()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-lg font-bold text-lg">
            üí∞ Exportar Dados Financeiros
        </button>

        <div class="mt-6 p-4 bg-gray-50 rounded">
            <h3 class="font-bold mb-2">üìù O que ser√° exportado:</h3>
            <ul class="list-disc list-inside text-sm space-y-1">
                <li>financeDataV30 (vers√£o mais recente)</li>
                <li>financeDataV29, V22, V23, V21 (vers√µes anteriores, se existirem)</li>
                <li>Todos os eventos, monitores, gastos, contas fixas, etc.</li>
            </ul>
        </div>
    </div>

    <script>
        function exportarDadosFinanceiros() {
            const statusEl = document.getElementById('status');
            
            try {
                // Verificar todas as vers√µes
                const versoes = ['financeDataV30', 'financeDataV29', 'financeDataV22', 'financeDataV23', 'financeDataV21'];
                const dadosFinanceiros = {};
                let encontrou = false;
                
                versoes.forEach(versao => {
                    const dados = localStorage.getItem(versao);
                    if (dados) {
                        encontrou = true;
                        dadosFinanceiros[versao] = JSON.parse(dados);
                    }
                });

                if (!encontrou) {
                    statusEl.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-500 rounded">
                        <h3 class="font-bold text-red-800 mb-2">‚ùå Nenhum dado financeiro encontrado!</h3>
                        <div class="text-sm">
                            <p class="mb-2">Poss√≠veis causas:</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Este arquivo n√£o est√° sendo aberto da pasta example/</li>
                                <li>Os dados financeiros nunca foram salvos aqui</li>
                                <li>Voc√™ est√° no navegador/perfil errado</li>
                            </ul>
                            <p class="mt-3">Todas as chaves dispon√≠veis:</p>
                            <div class="text-xs bg-white p-2 rounded mt-2">
                                ${Object.keys(localStorage).join(', ') || 'Nenhuma'}
                            </div>
                        </div>
                    </div>`;
                    return;
                }

                // Criar arquivo JSON
                const json = JSON.stringify(dadosFinanceiros, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Criar link de download
                const a = document.createElement('a');
                a.href = url;
                a.download = `dados-financeiros-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                // Limpar
                URL.revokeObjectURL(url);

                // Analisar dados exportados
                const versaoMaisRecente = dadosFinanceiros.financeDataV30 || dadosFinanceiros.financeDataV29 || dadosFinanceiros.financeDataV22 || dadosFinanceiros.financeDataV23 || dadosFinanceiros.financeDataV21;
                
                const eventos = versaoMaisRecente.eventos || [];
                const monitores = versaoMaisRecente.monitores || [];
                const gastos = versaoMaisRecente.gastos || [];
                
                // Eventos por m√™s
                const eventosPorMes = {};
                eventos.forEach(e => {
                    if (e.data) {
                        const mes = e.data.substring(0, 7);
                        eventosPorMes[mes] = (eventosPorMes[mes] || 0) + 1;
                    }
                });

                statusEl.innerHTML = `<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Dados financeiros exportados com sucesso!</h3>
                    <div class="text-sm space-y-2">
                        <div><strong>Vers√µes exportadas:</strong> ${Object.keys(dadosFinanceiros).join(', ')}</div>
                        <div class="mt-2 pt-2 border-t border-green-200">
                            <strong>Conte√∫do da vers√£o mais recente:</strong>
                            <ul class="ml-4 space-y-1 mt-1">
                                <li>üìÖ Eventos: ${eventos.length}</li>
                                <li>üë®‚Äçüíº Monitores: ${monitores.length}</li>
                                <li>üí∏ Gastos: ${gastos.length}</li>
                                <li>üìä M√™s Selecionado: ${versaoMaisRecente.selectedMonth || 'N√£o definido'}</li>
                            </ul>
                        </div>
                        <div class="mt-2 pt-2 border-t border-green-200">
                            <strong>Eventos por m√™s:</strong>
                            <div class="ml-4 space-y-1 mt-1 max-h-32 overflow-auto">
                                ${Object.keys(eventosPorMes).sort().map(mes => 
                                    `<div>${mes}: ${eventosPorMes[mes]} evento(s)${mes.endsWith('-12') ? ' üéÑ' : ''}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-green-200">
                        <strong>Arquivo salvo:</strong> <code class="bg-gray-200 px-2 py-1 rounded">${a.download}</code>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded">
                        <p class="text-sm font-bold mb-2">Pr√≥ximo passo:</p>
                        <ol class="list-decimal list-inside text-sm">
                            <li>Acesse: <code class="bg-gray-200 px-2 py-1 rounded">http://localhost:3000/importar-dados-financeiros.html</code></li>
                            <li>Carregue o arquivo <code class="bg-gray-200 px-2 py-1 rounded">${a.download}</code></li>
                            <li>Clique em "Importar Dados Financeiros"</li>
                        </ol>
                    </div>
                </div>`;

            } catch (error) {
                statusEl.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-500 rounded">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Erro ao exportar</h3>
                    <div class="text-sm">${error.message}</div>
                    <pre class="mt-2 text-xs bg-white p-2 rounded overflow-auto">${error.stack}</pre>
                </div>`;
            }
        }

        // Verificar dados ao carregar
        window.addEventListener('load', () => {
            const statusEl = document.getElementById('status');
            
            try {
                const versoes = ['financeDataV30', 'financeDataV29', 'financeDataV22', 'financeDataV23', 'financeDataV21'];
                let encontrou = false;
                let versaoEncontrada = '';
                let dadosVersao = null;
                
                for (const versao of versoes) {
                    const dados = localStorage.getItem(versao);
                    if (dados) {
                        encontrou = true;
                        versaoEncontrada = versao;
                        dadosVersao = JSON.parse(dados);
                        break;
                    }
                }

                if (encontrou && dadosVersao) {
                    const eventos = dadosVersao.eventos || [];
                    const monitores = dadosVersao.monitores || [];
                    const gastos = dadosVersao.gastos || [];
                    
                    // Contar eventos de dezembro
                    const eventosDezembro = eventos.filter(e => 
                        e.data && (e.data.startsWith('2025-12') || e.data.startsWith('2024-12'))
                    ).length;

                    statusEl.innerHTML = `<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
                        <h3 class="font-bold text-green-800 mb-2">‚úÖ Dados financeiros encontrados!</h3>
                        <div class="text-sm space-y-1">
                            <div>Vers√£o: <strong>${versaoEncontrada}</strong></div>
                            <div>üìÖ Eventos: ${eventos.length}</div>
                            <div>üë®‚Äçüíº Monitores: ${monitores.length}</div>
                            <div>üí∏ Gastos: ${gastos.length}</div>
                            <div class="mt-2 pt-2 border-t border-green-200">
                                <strong>Dezembro:</strong> ${eventosDezembro} evento(s) üéÑ
                            </div>
                        </div>
                    </div>`;
                } else {
                    statusEl.innerHTML = `<div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                        <h3 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Nenhum dado financeiro encontrado</h3>
                        <div class="text-sm">Certifique-se de abrir este arquivo a partir da pasta <code>example/</code>.</div>
                    </div>`;
                }
            } catch (error) {
                statusEl.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-500 rounded">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Erro ao verificar dados</h3>
                    <div class="text-sm">${error.message}</div>
                </div>`;
            }
        });
    </script>
</body>
</html>

