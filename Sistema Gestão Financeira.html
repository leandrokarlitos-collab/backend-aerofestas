<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira v30 - Categorias Din√¢micas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='20' cy='20' r='10' fill='%234f46e5'/><circle cx='80' cy='30' r='8' fill='%234f46e5'/><circle cx='50' cy='70' r='12' fill='%234f46e5'/><line x1='20' y1='20' x2='80' y2='30' stroke='%234f46e5' stroke-width='5'/><line x1='80' y1='30' x2='50' y2='70' stroke='%234f46e5' stroke-width='5'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
window.jsPDF = window.jspdf.jsPDF;

document.addEventListener('DOMContentLoaded', () => {
  const exportBtn = document.getElementById('export-gastos-pdf-btn');
  if (!exportBtn) return;

  exportBtn.addEventListener('click', () => {
    try {
      const tabelaOriginal = document.getElementById('tabela-gastos');
      if (!tabelaOriginal) {
        alert('Tabela de gastos n√£o encontrada.');
        return;
      }



      // --- Clonar a tabela e remover coluna "A√ß√µes" ---
      const tabelaClone = tabelaOriginal.cloneNode(true);
      const colIndex = Array.from(
        tabelaOriginal.querySelectorAll('th')
      ).findIndex(th => th.textContent.trim().toLowerCase() === 'a√ß√µes');
      
      if (colIndex !== -1) {
        tabelaClone.querySelectorAll('tr').forEach(row => {
          row.deleteCell(colIndex);
        });
      }

      // --- Criar o PDF ---
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: 'a4'
      });

      // --- Cabe√ßalho elegante ---
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(20);
      doc.setTextColor(63, 81, 181);
      doc.text('Relat√≥rio de Gastos', 40, 55);

      doc.setDrawColor(79, 70, 229);
      doc.setLineWidth(1);
      doc.line(40, 65, 555, 65);

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(90, 90, 90);
      doc.text(`Empresa: Aero & ABC Festas`, 40, 80);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 40, 95);

      // --- Tabela estilizada ---
      doc.autoTable({
        html: tabelaClone,
        startY: 115,
        theme: 'grid',
        styles: {
          fontSize: 10,
          cellPadding: 6,
          lineColor: [220, 220, 220],
          textColor: [40, 40, 40],
        },
        headStyles: {
          fillColor: [63, 81, 181],
          textColor: 255,
          fontStyle: 'bold',
          halign: 'center',
        },
        bodyStyles: {
          halign: 'center',
        },
        columnStyles: {
          // Coluna de valores (√∫ltima)
          [tabelaClone.rows[0].cells.length - 1]: {
            halign: 'right',
            fontStyle: 'bold',
            textColor: [40, 40, 40],
          },
        },
        alternateRowStyles: { fillColor: [250, 250, 255] },
        margin: { left: 40, right: 40 },
      });

      // --- Rodap√© minimalista ---
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        const pageHeight = doc.internal.pageSize.height;
        doc.setFontSize(9);
        doc.setTextColor(150);
        doc.text(
          `P√°gina ${i} de ${pageCount}`,
          doc.internal.pageSize.width - 80,
          pageHeight - 20
        );
      }

      // --- Salvar PDF ---
      const nomeArquivo = `Relat√≥rio_Gastos_${new Date()
        .toISOString()
        .slice(0, 10)}.pdf`;
      doc.save(nomeArquivo);
    } catch (err) {
      console.error('Erro ao exportar PDF:', err);
      alert('Erro ao exportar PDF. Veja o console para mais detalhes.');
    }
  });
});
</script>



    <style>
        :root {
            --glow-color: hsl(224, 88%, 66%);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1f2937;
        }
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .header-title {
            background: linear-gradient(to right, #4f46e5, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .modal-box.glassmorphism {
             background: rgba(255, 255, 255, 0.85);
        }
        .shiny-btn {
             position: relative;
             border: 2px solid transparent;
             background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 51%, #4f46e5 100%);
             background-size: 200% auto;
             color: white;
             box-shadow: 0 4px 15px 0 rgba(60, 78, 224, 0.4);
             transition: all 0.4s ease;
        }
        .shiny-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(60, 78, 224, 0.6);
        }
        .shiny-btn-red {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #dc2626 0%, #ef4444 51%, #dc2626 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(239, 68, 68, 0.4);
            transition: all 0.4s ease;
        }
        .shiny-btn-red:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(239, 68, 68, 0.6);
        }
        .shiny-btn-red:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
       .shiny-btn:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .form-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #1f2937;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .form-input::placeholder { color: #6b7280; }
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4f46e5;
            border-color: #4f46e5;
        }
        /* Page transitions */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom styles for tables */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid rgba(200, 200, 200, 0.5); }
        thead th { background-color: rgba(236, 240, 241, 0.5); font-weight: 600; color: #374151; }
        tbody tr:hover { background-color: rgba(243, 244, 246, 0.4); }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; transition: color 0.2s; padding: 0;}
        .delete-btn { color: #ef4444; } .delete-btn:hover { color: #b91c1c; }
        .edit-btn { color: #f59e0b; } .edit-btn:hover { color: #b45309; }
        .action-btn:disabled { color: #9ca3af; cursor: not-allowed; }

        /* Gemini Button Style */
        .gemini-btn {
            background-color: transparent;
            color: #6366f1;
            border: 2px solid #6366f1;
            padding: 10px 15px;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .gemini-btn:hover {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #4f46e5; border-radius: 50%; display: block; box-sizing: border-box; animation: rotation 1s linear infinite; margin: 20px auto; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Animation */
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter {
            animation: toast-in 0.5s ease-out forwards;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }

        /* Estilos do Menu de Monitores */
        #monitors-sidebar.collapsed {
            width: 0px;
            padding: 0;
            overflow: hidden;
            margin-left: -1.5rem; /* Compensa o gap */
        }
        #monitors-sidebar.collapsed .sidebar-content {
            opacity: 0;
        }
        #sidebar-toggle-btn.collapsed .fa-chevron-left {
            transform: rotate(180deg);
        }
        #monitors-sidebar-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: #374151;
        }
        #monitors-sidebar-list a:hover {
            background-color: rgba(230, 230, 245, 0.7);
        }

        /* Abas de Configura√ß√£o de Sal√°rio */
        .config-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .config-tab-btn.active {
            background-color: white;
            color: #4f46e5;
            border-color: #4f46e5;
        }
        .config-tab-btn:not(.active) {
            background-color: transparent;
            color: #4b5563;
        }
        .config-tab-content {
            display: none;
        }
        .config-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <canvas id="particles-js"></canvas>

    <div class="container mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl header-title">Gest√£o Financeira</h1>
            <p class="text-gray-500 mt-2">Aero & ABC Festas</p>
            <div class="absolute top-0 left-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Dashboard.html'" class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors" title="Acessar Dashboard">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
             <div class="absolute top-0 right-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Agenda de eventos.html'" class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors" title="Acessar Agenda de Eventos">
                    <i class="fa-solid fa-calendar-days"></i>
                </button>
                 <button onclick="window.location.href='./Sistema Gest√£o Financeira.html'" class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors" title="Acessar Gest√£o Financeira">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button onclick="window.location.href='./Sistema de CRM.html'" class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors" title="Acessar CRM">
                    <i class="fas fa-users"></i>
                </button>
                <button id="settings-btn" class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors" title="Configura√ß√µes">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <nav class="flex justify-center mb-8 space-x-1 md:space-x-2 flex-wrap">
            <button data-target="dashboard" class="nav-link active shiny-btn px-4 py-2 rounded-md text-sm md:text-base mb-2"><i class="fa-solid fa-chart-pie mr-2"></i> Dashboard</button>
            <button data-target="entradas" class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i class="fa-solid fa-calendar-check mr-2"></i> Entradas</button>
            <button data-target="gastos" class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i class="fa-solid fa-cart-shopping mr-2"></i> Gastos</button>
            <button data-target="contas-fixas" class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i class="fa-solid fa-file-invoice-dollar mr-2"></i> Contas Fixas</button>
            <button data-target="monitores" class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i class="fa-solid fa-users mr-2"></i> Monitores</button>
            <button data-target="salarios" class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i class="fa-solid fa-money-bill-wave mr-2"></i> Sal√°rios</button>
        </nav>

        <div class="month-filter-container glassmorphism p-4 rounded-lg mb-8 flex justify-center items-center gap-4">
            <button class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg" data-direction="-1">&lt;</button>
            <input type="month" class="month-filter form-input text-center font-semibold text-indigo-600 border-none shadow-inner" id="month-filter-global">
            <button class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg" data-direction="1">&gt;</button>
        </div>

        <main>
            <div id="page-dashboard" class="page active">
                <section id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glassmorphism p-6 rounded-lg text-center">
                        <h3 class="font-semibold text-gray-600 mb-2"><i class="fa-solid fa-arrow-up mr-2 text-emerald-500"></i>Receitas do M√™s</h3>
                        <p id="total-receitas" class="text-4xl font-bold text-emerald-600">R$ 0,00</p>
                        <div id="receitas-comparison" class="text-xs mt-2 space-y-1"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center">
                        <h3 class="font-semibold text-gray-600 mb-2"><i class="fa-solid fa-arrow-down mr-2 text-red-500"></i>Despesas do M√™s</h3>
                        <p id="total-despesas" class="text-4xl font-bold text-red-500">R$ 0,00</p>
                        <div id="despesas-comparison" class="text-xs mt-2 space-y-1"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center">
                        <h3 class="font-semibold text-gray-600 mb-2"><i class="fa-solid fa-scale-balanced mr-2 text-blue-500"></i>Saldo do M√™s</h3>
                        <p id="saldo-total" class="text-4xl font-bold text-blue-600">R$ 0,00</p>
                        <div id="saldo-comparison" class="text-xs mt-2 space-y-1"></div>
                    </div>
                     <div class="glassmorphism p-6 rounded-lg text-center flex flex-col justify-center items-center">
                        <h3 class="font-semibold text-indigo-600 mb-3"><i class="fa-solid fa-brain mr-2"></i>An√°lise do M√™s (IA)</h3>
                        <button onclick="openChat('dashboard')" class="gemini-btn w-full">‚ú® Gerar Relat√≥rio</button>
                    </div>
                </section>
                <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-lg"><h3 class="text-center font-bold text-gray-700 mb-4">Receita por Empresa (M√™s)</h3><canvas id="empresas-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg"><h3 class="text-center font-bold text-gray-700 mb-4">Distribui√ß√£o de Despesas (M√™s)</h3><canvas id="despesas-gerais-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg"><h3 class="text-center font-bold text-gray-700 mb-4">Gastos & Compras (M√™s)</h3><canvas id="gastos-compras-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg"><h3 class="text-center font-bold text-gray-700 mb-4">Contas Fixas (M√™s)</h3><canvas id="contas-fixas-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg lg:col-span-2"><h3 class="text-center font-bold text-gray-700 mb-4">Pagamentos Monitores (M√™s)</h3><canvas id="pagamentos-monitores-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg lg:col-span-2"><h3 class="text-center font-bold text-gray-700 mb-4">Fluxo de Caixa Di√°rio (M√™s)</h3><canvas id="daily-chart"></canvas></div>
                    <div class="glassmorphism p-6 rounded-lg lg:col-span-2"><h3 class="text-center font-bold text-gray-700 mb-4">M√©dia Geral de Desempenho dos Monitores</h3><canvas id="monitor-geral-performance-chart"></canvas></div>
                </section>
            </div>

            <div id="page-entradas" class="page">
                 <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Entradas Registradas no M√™s</h2>
                        <button id="open-entrada-modal-btn" class="shiny-btn px-4 py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i> Nova Entrada Manual</button>
                        <button id="export-entradas-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md mr-2">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>

                    </div>
                    <p class="text-sm text-gray-500 mb-4">Entradas marcadas com üìÖ foram importadas automaticamente da Agenda de Eventos.</p>
                    <div class="table-wrapper"><table id="tabela-eventos"><thead><tr><th>Data</th><th>Empresa</th><th>Contratante</th><th>Local</th><th>Itens</th><th>Valor Total</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                 </section>
            </div>

            <div id="page-gastos" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Gastos Registrados no M√™s</h2>
                        <div>
                            <button id="open-gasto-modal-btn" class="shiny-btn px-4 py-2 rounded-md mr-2"><i class="fa-solid fa-plus mr-2"></i> Lan√ßar Novo Gasto</button>
                             <button id="export-gastos-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md text-sm md:text-base mr-2">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                            </button>
                            <button onclick="openChat('gastos')" class="gemini-btn"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analisar com IA</button>
                        </div>
                   </div>
                    <div class="table-wrapper"><table id="tabela-gastos"><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Conta</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastro de Contas de Sa√≠da</h2>
                    <form id="form-cadastro-conta" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div><label for="cadastro-conta-nome" class="block text-sm font-medium text-gray-700">Nome da Conta</label><input type="text" id="cadastro-conta-nome" placeholder="Ex: Conta Principal" required class="form-input w-full mt-1"></div>
                        <div><label for="cadastro-conta-banco" class="block text-sm font-medium text-gray-700">Institui√ß√£o/Banco</label><input type="text" id="cadastro-conta-banco" placeholder="Ex: Banco Inter" required class="form-input w-full mt-1"></div>
                        <div><label for="cadastro-conta-tipo" class="block text-sm font-medium text-gray-700">Tipo</label><select id="cadastro-conta-tipo" required class="form-input w-full mt-1"><option>Conta Corrente</option><option>Conta Poupan√ßa</option><option>Conta de Pagamentos</option><option>Outros</option></select></div>
                        <div><label for="cadastro-conta-agencia" class="block text-sm font-medium text-gray-700">Ag√™ncia (Opcional)</label><input type="text" id="cadastro-conta-agencia" placeholder="0001" class="form-input w-full mt-1"></div>
                        <div><label for="cadastro-conta-numero" class="block text-sm font-medium text-gray-700">N¬∫ da Conta (Opcional)</label><input type="text" id="cadastro-conta-numero" placeholder="12345-6" class="form-input w-full mt-1"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-save mr-2"></i> Salvar Conta</button>
                    </form>
                    <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Contas Cadastradas</h3>
                    <div class="table-wrapper"><table id="tabela-contas-db"><thead><tr><th>Nome</th><th>Institui√ß√£o</th><th>Tipo</th><th>Ag√™ncia/Conta</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
                
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Gerenciamento de Categorias de Gastos</h2>
                    <form id="form-gasto-categoria" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="gasto-categoria-nome" class="block text-sm font-medium text-gray-700">Nome da Nova Categoria</label>
                            <input type="text" id="gasto-categoria-nome" placeholder="Ex: Limpeza" required class="form-input w-full mt-1">
                        </div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-save mr-2"></i> Salvar Categoria</button>
                    </form>
                    <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Categorias de Gastos Cadastradas</h3>
                    <div class="table-wrapper"><table id="tabela-gasto-categorias-db"><thead><tr><th>Nome</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
            </div>
            
            <div id="page-contas-fixas" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastrar Nova Conta Fixa</h2>
                    <form id="form-conta-fixa" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div><label for="conta-fixa-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text" id="conta-fixa-descricao" required class="form-input w-full mt-1" placeholder="Ex: Aluguel do galp√£o"></div>
                        <div><label for="conta-fixa-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" id="conta-fixa-valor" step="0.01" required class="form-input w-full mt-1" placeholder="750.00"></div>
                        <div><label for="conta-fixa-dia-vencimento" class="block text-sm font-medium text-gray-700">Dia do Vencimento</label><input type="number" id="conta-fixa-dia-vencimento" min="1" max="31" required class="form-input w-full mt-1" placeholder="10"></div>
                        <div>
                            <label for="conta-fixa-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                            <select id="conta-fixa-categoria" required class="form-input w-full mt-1">
                                <option value="">-- Selecione --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="conta-fixa-tipo-recorrencia" class="block text-sm font-medium text-gray-700">Tipo de Recorr√™ncia</label>
                            <select id="conta-fixa-tipo-recorrencia" required class="form-input w-full mt-1">
                                <option value="permanente" selected>Permanente (Cont√≠nua)</option>
                                <option value="parcelada">Parcelada (Com Fim)</option>
                            </select>
                        </div>
                        
                        <div id="conta-fixa-parcelamento-container" class="hidden md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="conta-fixa-data-inicio" class="block text-sm font-medium text-gray-700">M√™s de In√≠cio (YYYY-MM)</label>
                                <input type="month" id="conta-fixa-data-inicio" class="form-input w-full mt-1">
                            </div>
                            <div>
                                <label for="conta-fixa-num-parcelas" class="block text-sm font-medium text-gray-700">N¬∫ de Parcelas</label>
                                <input type="number" id="conta-fixa-num-parcelas" min="1" step="1" class="form-input w-full mt-1" placeholder="12">
                            </div>
                        </div>
                        
                        <div class="lg:col-span-4">
                            <label for="conta-fixa-anexo" class="block text-sm font-medium text-gray-700">Anexar Boletos/Faturas (Opcional)</label>
                            <input type="file" id="conta-fixa-anexo" multiple class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        </div>
                        <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-4"><i class="fa-solid fa-plus mr-2"></i> Adicionar Conta Fixa</button>
                    </form>
                </section>
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lan√ßamento de Contas Fixas do M√™s</h2>
                    <p class="text-sm text-gray-500 mb-4">Aqui s√£o listadas as contas (permanentes ou parcelas) ativas para o m√™s selecionado.</p>
                    <div class="table-wrapper"><table id="tabela-contas-fixas-mes"><thead><tr><th>Descri√ß√£o</th><th>Valor Previsto</th><th>Vencimento</th><th>Status</th><th>Valor Pago</th><th>Data Pag.</th><th class="text-center"><i class="fa-solid fa-paperclip"></i></th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div>
                </section>
                
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Gerenciamento de Categorias de Contas Fixas</h2>
                    <form id="form-conta-fixa-categoria" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="cf-categoria-nome" class="block text-sm font-medium text-gray-700">Nome da Nova Categoria</label>
                            <input type="text" id="cf-categoria-nome" placeholder="Ex: Impostos MEI" required class="form-input w-full mt-1">
                        </div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-save mr-2"></i> Salvar Categoria</button>
                    </form>
                    <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Categorias de Contas Fixas Cadastradas</h3>
                    <div class="table-wrapper"><table id="tabela-cf-categorias-db"><thead><tr><th>Nome</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
                
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Contas Fixas Cadastradas (Banco de Dados)</h2>
                    <div class="table-wrapper"><table id="tabela-contas-fixas-db"><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Dia Venc.</th><th>Categoria</th><th>Recorr√™ncia</th><th>Anexos</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
            </div>

            <div id="page-monitores" class="page">
                 <div class="flex gap-6 relative">
                     <button id="sidebar-toggle-btn" class="absolute top-4 -left-3 z-20 bg-white/80 w-8 h-8 rounded-full shadow-md flex items-center justify-center text-indigo-600 transition-transform duration-300 hover:scale-110">
                        <i class="fas fa-chevron-left transition-transform duration-300"></i>
                    </button>
                    
                    <aside id="monitors-sidebar" class="glassmorphism p-4 rounded-lg h-fit transition-all duration-300 ease-in-out w-72 flex-shrink-0">
                         <div class="flex justify-between items-center mb-4 transition-opacity duration-300 sidebar-content">
                             <h3 class="text-xl font-bold text-gray-800">Monitores</h3>
                             <button id="add-monitor-btn" class="shiny-btn rounded-full w-10 h-10 flex items-center justify-center" title="Adicionar Novo Monitor">
                                 <i class="fa-solid fa-plus"></i>
                         </div>
                         <div id="monitors-sidebar-list" class="space-y-1 transition-opacity duration-300 sidebar-content">
                             </div>
                    </aside>
                    
                     <main id="monitors-main-content" class="flex-grow space-y-8 transition-all duration-300">
                        <section class="glassmorphism p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Monitores Cadastrados</h3>
                            <p class="text-sm text-gray-500 mb-4">Veja detalhes, edite ou exclua um monitor clicando em sua foto/nome no menu √† esquerda ou usando os bot√µes de a√ß√£o abaixo.</p>
                            <div class="table-wrapper"><table id="tabela-monitores-db"><thead><tr><th>Nome</th><th>Possui CNH?</th><th>M√©dia Desempenho</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                        </section>
                         <section class="glassmorphism p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Desempenho dos Monitores (M√™s Selecionado)</h3>
                            <div class="w-full h-80"><canvas id="monitor-event-performance-chart"></canvas></div>
                        </section>
                        <section class="glassmorphism p-6 rounded-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lan√ßar Pagamento & Avalia√ß√£o</h2>
                             <form id="form-pagamento-monitor" class="space-y-4">
                                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="pagamento-monitor-data" class="block text-sm font-medium text-gray-700">Data do Evento</label><input type="date" id="pagamento-monitor-data" required class="form-input w-full mt-1"></div>
                                    <div class="lg:col-span-2"><label for="monitor-select" class="block text-sm font-medium text-gray-700">Selecione o Monitor</label><select id="monitor-select" required class="form-input w-full mt-1"></select></div>
                                    <div>
                                        <label for="pagamento-monitor-diaria" class="block text-sm font-medium text-gray-700">Valor da Di√°ria</label>
                                        <select id="pagamento-monitor-diaria" required class="form-input w-full mt-1">
                                            <option value="80">R$ 80,00</option>
                                            <option value="90">R$ 90,00</option>
                                            <option value="100" selected>R$ 100,00</option>
                                            <option value="120">R$ 120,00</option>
                                            <option value="outro">Outro Valor</option>
                                        </select>
                                        <div id="pagamento-monitor-diaria-outro-wrapper" class="hidden mt-2">
                                            <input type="number" id="pagamento-monitor-diaria-outro" placeholder="Digite o valor" step="0.01" class="form-input w-full">
                                        </div>
                                    </div>
                                    <div><label for="pagamento-monitor-entrada" class="block text-sm font-medium text-gray-700">Hora Entrada</label><input type="time" id="pagamento-monitor-entrada" required class="form-input w-full mt-1"></div>
                                    <div><label for="pagamento-monitor-saida" class="block text-sm font-medium text-gray-700">Hora Sa√≠da</label><input type="time" id="pagamento-monitor-saida" required class="form-input w-full mt-1"></div>
                                    <div class="lg:col-span-2"><label for="pagamento-monitor-status" class="block text-sm font-medium text-gray-700">Status do Pagamento</label><select id="pagamento-monitor-status" required class="form-input w-full mt-1"><option value="Executado" selected>Executado</option><option value="Pendente">Pendente</option></select></div>
                                    
                                    <div class="lg:col-span-2 flex items-center pt-4">
                                        <input type="checkbox" id="pagamento-monitor-motorista" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <label for="pagamento-monitor-motorista" class="ml-2 block text-sm text-gray-900">Adicional de Motorista?</label>
                                    </div>
                                    <div id="motorista-adicional-fields" class="hidden lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                        <div><label for="pagamento-monitor-eventos" class="block text-sm font-medium text-gray-700">N¬∫ Eventos Entregues</label><input type="number" id="pagamento-monitor-eventos" min="0" step="0.1" class="form-input w-full mt-1" value="0"></div>
                                        <p class="text-sm text-gray-600 pt-5 font-medium">Adicional: <span id="valor-adicional-motorista">R$ 0,00</span></p>
                                    </div>
                                </div>
        
                                <div id="pagamento-avaliacao-container" class="hidden border-t pt-4 mt-4">
                                     <h4 class="font-semibold text-gray-800 mb-2">Avalia√ß√£o de Desempenho do Evento</h4>
                                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                                         <div><label for="pagamento-nota-descricao" class="text-xs">Evento/Descri√ß√£o</label><input type="text" id="pagamento-nota-descricao" class="form-input w-full text-sm p-1.5" placeholder="Ex: Festa da Maria"></div>
                                         <div id="pagamento-checklist-container" class="sm:col-span-2 border p-3 rounded-md bg-gray-50/50"></div>
                                         <div class="sm:col-span-2 text-right font-bold text-gray-700">Nota Calculada: <span id="pagamento-nota-calculada" class="text-indigo-600 text-lg">0.0</span> / 10</div>
                                         <div class="sm:col-span-2"><label for="pagamento-nota-obs" class="text-xs">Observa√ß√µes</label><textarea id="pagamento-nota-obs" class="form-input w-full text-sm p-1.5" rows="2"></textarea></div>
                                     </div>
                                </div>
                                
                                <button type="submit" class="shiny-btn py-2.5 rounded-md w-full mt-4"><i class="fa-solid fa-calculator mr-2"></i> Lan√ßar Pagamento e Salvar Avalia√ß√£o</button>
                            </form>
                            <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Hist√≥rico de Pagamentos (M√™s Selecionado)</h3>
                            <div class="table-wrapper"><table id="tabela-pagamentos-monitores"><thead><tr><th>Data</th><th>Nome</th><th>Valor Base</th><th>Adicional Motorista</th><th>Adicional HE</th><th>Valor Total</th><th>Status</th><th>Nota Evento</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                            <button id="export-monitores-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md mr-2">
                                <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                            </button>

                        </section>
                    </main>
                </div>
            </div> <div id="page-salarios" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">C√°lculo de Sal√°rio</h2>
                        <button id="open-salarios-config-modal-btn" class="gemini-btn px-4 py-2 rounded-md">
                            <i class="fa-solid fa-gear mr-2"></i> Configura√ß√µes
                        </button>
                           <button id="export-salarios-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>
                    </div>

                    <div class="mb-6">
                        <label for="salario-funcionario-select" class="block text-sm font-medium text-gray-700 mb-1">Selecionar Funcion√°rio</label>
                        <select id="salario-funcionario-select" class="form-input w-full max-w-md"></select>
                    </div>
                    
                    <div id="salario-calculo-container" class="hidden">
                        <h3 id="salario-nome-funcionario" class="text-xl font-bold text-gray-800 mb-6"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i class="fa-solid fa-arrow-up mr-2 text-emerald-500"></i>Entradas Totais (M√™s)</h3>
                                <p id="salario-total-entradas" class="text-3xl font-bold text-emerald-600">R$ 0,00</p>
                            </div>
                            
                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i class="fa-solid fa-percentage mr-2 text-indigo-500"></i>Comiss√£o Calculada</h3>
                                <p id="salario-comissao" class="text-3xl font-bold text-indigo-600">R$ 0,00</p>
                                <p id="salario-comissao-percentual" class="text-sm text-gray-500 mt-1">Faixa de 0%</p>
                            </div>

                            <div class="glassmorphism p-5 rounded-lg border-2 border-green-300 bg-green-50/30">
                                <h3 class="font-semibold text-gray-700 mb-2"><i class="fa-solid fa-sack-dollar mr-2 text-green-600"></i>Sal√°rio Total a Pagar</h3>
                                <p id="salario-total-pagar" class="text-3xl font-bold text-green-700">R$ 0,00</p>
                            </div>
                        </div>

                        <div class="bg-white/50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Detalhamento do Sal√°rio</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Sal√°rio Fixo</span>
                                    <span id="salario-fixo" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Alimenta√ß√£o (VA)</span>
                                    <span id="salario-va" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Transporte (VT)</span>
                                    <span id="salario-vt" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                                    <span class="text-blue-800">Comiss√£o (Baseada nas Entradas)</span>
                                    <span id="salario-comissao-detalhe" class="font-bold text-blue-800">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-green-100 border-t-2 border-green-300 rounded-md mt-4">
                                    <span class="text-lg font-bold text-green-800">Total Bruto</span>
                                    <span id="salario-total-detalhe" class="text-xl font-extrabold text-green-800">R$ 0,00</span>
                                </div>
                            </div>

                            <div class="mt-8 text-center">
                                <button id="btn-lancar-salario" class="shiny-btn px-8 py-3 rounded-md text-lg font-semibold w-full md:w-auto">
                                    <i class="fa-solid fa-arrow-down-to-bracket mr-2"></i> Lan√ßar Sal√°rio como Despesa
                                </button>
                                <p id="salario-lancado-msg" class="text-green-600 font-semibold mt-4 hidden">
                                    <i class="fa-solid fa-check-circle mr-2"></i> Sal√°rio j√° lan√ßado como despesa para este m√™s.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="salario-selecione-msg" class="text-center p-10 bg-white/50 rounded-lg">
                        <i class="fa-solid fa-user-check text-4xl text-gray-400 mb-4"></i>
                        <p class="font-semibold text-gray-600">Selecione um funcion√°rio acima para calcular o sal√°rio.</p>
                        <p class="text-sm text-gray-500 mt-2">N√£o h√° funcion√°rios cadastrados? Use o bot√£o <i class="fa-solid fa-gear"></i> Configura√ß√µes.</p>
                    </div>

                </section>
            </div> </main>
    </div>
    
    <div id="add-entrada-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Nova Entrada Manual</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-evento" class="space-y-4 pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label for="evento-data" class="block text-sm font-medium text-gray-700">Data</label><input type="date" id="evento-data" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-empresa" class="block text-sm font-medium text-gray-700">Empresa</label><select id="evento-empresa" required class="form-input w-full mt-1"><option>Aero Festas</option><option>ABC Festas</option></select></div>
                    <div><label for="evento-contratante" class="block text-sm font-medium text-gray-700">Contratante</label><input type="text" id="evento-contratante" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-local" class="block text-sm font-medium text-gray-700">Local</label><input type="text" id="evento-local" required class="form-input w-full mt-1"></div>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-semibold mb-2">Itens do Evento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-7"><label for="item-nome" class="block text-sm font-medium text-gray-700">Nome do Item</label><input type="text" id="item-nome" class="form-input w-full mt-1"></div>
                        <div class="md:col-span-3"><label for="item-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" id="item-valor" step="0.01" class="form-input w-full mt-1"></div>
                        <button type="button" id="btn-add-item" class="md:col-span-2 shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i> Add</button>
                    </div>
                    <ul id="itens-temp-list" class="mt-4 space-y-2"></ul>
                </div>
                <button type="submit" class="w-full shiny-btn py-2.5 rounded-md font-bold"><i class="fa-solid fa-save mr-2"></i> Salvar Evento Completo</button>
            </form>
        </div>
    </div>
    
    <div id="add-gasto-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Novo Gasto</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-gasto" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                <div><label for="gasto-data" class="block text-sm font-medium text-gray-700">Data</label><input type="date" id="gasto-data" required class="form-input w-full mt-1"></div>
                <div><label for="gasto-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text" id="gasto-descricao" required class="form-input w-full mt-1"></div>
                <div>
                    <label for="gasto-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="gasto-categoria" required class="form-input w-full mt-1">
                         <option value="">-- Selecione --</option>
                    </select>
                </div>
                <div><label for="gasto-conta" class="block text-sm font-medium text-gray-700">Conta de Sa√≠da</label><select id="gasto-conta" required class="form-input w-full mt-1"></select></div>
                <div><label for="gasto-pagamento" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label><select id="gasto-pagamento" required class="form-input w-full mt-1"><option>PIX</option><option>Cart√£o de Cr√©dito</option><option>Dinheiro</option><option>Boleto</option></select></div>
                <div><label for="gasto-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number" id="gasto-valor" step="0.01" required class="form-input w-full mt-1"></div>
                <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-3"><i class="fa-solid fa-plus mr-2"></i> Adicionar Gasto</button>
            </form>
        </div>
    </div>
    
    <div id="lancamento-conta-fixa-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Pagamento de Conta Fixa</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-lancamento-conta-fixa">
                <p class="text-gray-700 mb-4">Confirme ou altere os dados para o lan√ßamento.</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <input type="text" id="lancamento-cf-descricao" class="form-input w-full mt-1 bg-gray-200" readonly>
                    </div>
                    <div>
                        <label for="lancamento-cf-data" class="block text-sm font-medium text-gray-700">Data do Pagamento</label>
                        <input type="date" id="lancamento-cf-data" required class="form-input w-full mt-1">
                    </div>
                    <div>
                        <label for="lancamento-cf-valor" class="block text-sm font-medium text-gray-700">Valor Pago (R$)</label>
                        <input type="number" step="0.01" id="lancamento-cf-valor" required class="form-input w-full mt-1">
                    </div>
                     <div>
                        <label for="lancamento-cf-conta" class="block text-sm font-medium text-gray-700">Conta de Sa√≠da</label>
                        <select id="lancamento-cf-conta" required class="form-input w-full mt-1"></select>
                    </div>
                    <div>
                        <label for="lancamento-cf-comprovante" class="block text-sm font-medium text-gray-700">Anexar Comprovantes (Opcional)</label>
                        <input type="file" id="lancamento-cf-comprovante" multiple class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                </div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i class="fa-solid fa-check mr-2"></i>Confirmar Lan√ßamento</button>
            </form>
        </div>
    </div>

    <div id="add-monitor-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Cadastrar Novo Monitor</h2>
                <button class="add-monitor-close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-cadastro-monitor" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-start pt-4">
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                   <div><label for="cadastro-monitor-nome" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="cadastro-monitor-nome" required class="form-input w-full mt-1"></div>
                   <div><label for="cadastro-monitor-nascimento" class="block text-sm font-medium text-gray-700">Data de Nascimento (Opcional)</label><input type="date" id="cadastro-monitor-nascimento" class="form-input w-full mt-1"></div>
                   <div><label for="cadastro-monitor-telefone" class="block text-sm font-medium text-gray-700">Telefone (WhatsApp)</label><input type="tel" id="cadastro-monitor-telefone" placeholder="(62) 99999-9999" class="form-input w-full mt-1"></div>
                   <div><label for="cadastro-monitor-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="cadastro-monitor-email" placeholder="email@exemplo.com" class="form-input w-full mt-1"></div>
                   <div class="md:col-span-2"><label for="cadastro-monitor-endereco" class="block text-sm font-medium text-gray-700">Endere√ßo</label><input type="text" id="cadastro-monitor-endereco" class="form-input w-full mt-1"></div>
                   <div>
                       <label for="cadastro-monitor-cnh" class="block text-sm font-medium text-gray-700">Possui CNH?</label>
                       <select id="cadastro-monitor-cnh" class="form-input w-full mt-1">
                           <option value="nao" selected>N√£o</option>
                           <option value="sim">Sim</option>
                       </select>
                   </div>
                   <div id="cadastro-monitor-cnh-categoria-wrapper" class="hidden">
                       <label for="cadastro-monitor-cnh-categoria" class="block text-sm font-medium text-gray-700">Categoria CNH</label>
                       <input type="text" id="cadastro-monitor-cnh-categoria" class="form-input w-full mt-1" placeholder="Ex: AB">
                   </div>
                   <div class="md:col-span-2">
                        <label for="cadastro-monitor-observacoes" class="block text-sm font-medium text-gray-700">Observa√ß√µes</label>
                        <textarea id="cadastro-monitor-observacoes" class="form-input w-full mt-1" rows="3" placeholder="Anota√ß√µes sobre o monitor..."></textarea>
                   </div>
                </div>
                 <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                   <div><label for="cadastro-monitor-perfil-foto" class="block text-sm font-medium text-gray-700">Foto de Perfil</label><input type="file" id="cadastro-monitor-perfil-foto" accept="image/*" class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                   <div><label for="cadastro-monitor-doc-foto" class="block text-sm font-medium text-gray-700">Foto do Documento (CNH/RG)</label><input type="file" id="cadastro-monitor-doc-foto" accept="image/*" class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                   <div class="flex items-start space-x-4">
                       <div>
                           <p class="text-xs text-center text-gray-600 mb-1">Preview Perfil</p>
                           <img id="perfil-foto-preview" src="https://placehold.co/128x128/e0e0e0/757575?text=Perfil" class="w-32 h-32 object-cover rounded-full border p-1 bg-gray-50" alt="Pr√©-visualiza√ß√£o do perfil">
                       </div>
                        <div>
                           <p class="text-xs text-center text-gray-600 mb-1">Preview Doc</p>
                           <img id="doc-foto-preview" src="https://placehold.co/128x128/e0e0e0/757575?text=Doc" class="w-32 h-32 object-cover rounded-md border p-1 bg-gray-50" alt="Pr√©-visualiza√ß√£o do documento">
                       </div>
                   </div>
                </div>
                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <h4 class="font-semibold text-gray-800 mb-2">Habilidades Iniciais (0-10)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div><label for="habilidade-forca" class="block text-sm font-medium text-gray-700">For√ßa</label><input type="number" id="habilidade-forca" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-agilidade" class="block text-sm font-medium text-gray-700">Agilidade</label><input type="number" id="habilidade-agilidade" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-proatividade" class="block text-sm font-medium text-gray-700">Proatividade</label><input type="number" id="habilidade-proatividade" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-comunicacao" class="block text-sm font-medium text-gray-700">Comunica√ß√£o</label><input type="number" id="habilidade-comunicacao" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-disponibilidade" class="block text-sm font-medium text-gray-700">Disponibilidade</label><input type="number" id="habilidade-disponibilidade" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-respeito" class="block text-sm font-medium text-gray-700">Respeito</label><input type="number" id="habilidade-respeito" min="0" max="10" step="1" value="5" class="form-input w-full mt-1"></div>
                    </div>
                </div>
                <button type="submit" class="md:col-span-2 shiny-btn py-2.5 rounded-md mt-2"><i class="fa-solid fa-user-plus mr-2"></i> Salvar Monitor</button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Editar Item</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="modal-form">
                <div id="modal-form-content" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i class="fa-solid fa-save mr-2"></i>Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div id="monitor-details-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="monitor-details-title" class="text-2xl font-bold text-gray-900">Detalhes do Monitor</h2>
                <button class="monitor-details-close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="monitor-details-body" class="bg-white/60 p-4 rounded-md flex-grow overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="attachment-viewer-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-6 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="attachment-viewer-title" class="text-2xl font-bold text-gray-900">Visualizar Anexos</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="attachment-viewer-content" class="flex-grow overflow-y-auto bg-white/50 rounded p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
        </div>
    </div>

    <div id="salarios-config-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Configura√ß√µes de Sal√°rios</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="mb-4 border-b border-gray-300/50 flex space-x-2">
                <button class="config-tab-btn active" data-target="config-tab-funcionarios">
                    <i class="fa-solid fa-user-tie mr-2"></i> Funcion√°rios
                </button>
                <button class="config-tab-btn" data-target="config-tab-comissao">
                    <i class="fa-solid fa-percentage mr-2"></i> Faixas de Comiss√£o
                </button>
            </div>

            <div id="config-tab-funcionarios" class="config-tab-content active space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Novo Funcion√°rio</h3>
                    <form id="form-add-funcionario" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div><label for="funcionario-nome" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="funcionario-nome" required class="form-input w-full mt-1" placeholder="Nome do Funcion√°rio"></div>
                        <div><label for="funcionario-salario" class="block text-sm font-medium text-gray-700">Sal√°rio Fixo (R$)</label><input type="number" id="funcionario-salario" step="0.01" required class="form-input w-full mt-1" placeholder="2200.00"></div>
                        <div><label for="funcionario-va" class="block text-sm font-medium text-gray-700">Vale Alimenta√ß√£o (R$)</label><input type="number" id="funcionario-va" step="0.01" required class="form-input w-full mt-1" placeholder="390.00"></div>
                        <div><label for="funcionario-vt" class="block text-sm font-medium text-gray-700">Vale Transporte (R$)</label><input type="number" id="funcionario-vt" step="0.01" required class="form-input w-full mt-1" placeholder="223.60"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-4"><i class="fa-solid fa-plus mr-2"></i> Adicionar Funcion√°rio</button>
                    </form>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Funcion√°rios Cadastrados</h3>
                    <div class="table-wrapper"><table id="tabela-funcionarios-config"><thead><tr><th>Nome</th><th>Sal√°rio Fixo</th><th>VA</th><th>VT</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
            </div>

            <div id="config-tab-comissao" class="config-tab-content space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Adicionar Nova Faixa de Comiss√£o</h3>
                    <form id="form-add-comissao" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="comissao-atevalor" class="block text-sm font-medium text-gray-700">Faturamento AT√â (R$)</label><input type="number" id="comissao-atevalor" step="0.01" required class="form-input w-full mt-1" placeholder="45000"></div>
                        <div><label for="comissao-percentual" class="block text-sm font-medium text-gray-700">Percentual (%)</label><input type="number" id="comissao-percentual" step="0.1" required class="form-input w-full mt-1" placeholder="2.5"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i> Adicionar Faixa</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Dica: Para "acima de R$ 95.000", cadastre uma faixa com valor "At√©" muito alto (ex: 9999999).</p>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Faixas de Comiss√£o Atuais</h3>
                    <div class="table-wrapper"><table id="tabela-comissao-config"><thead><tr><th>Faturamento At√© (R$)</th><th>Percentual</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
                </section>
            </div>

        </div>
    </div>
    <div id="chat-fab" class="fixed bottom-6 right-6 shiny-btn rounded-full w-16 h-16 flex items-center justify-center cursor-pointer shadow-2xl transition-transform duration-300 hover:scale-110 z-40" title="Assistente IA">
        <i id="chat-fab-icon" class="fa-solid fa-chart-pie text-2xl"></i>
    </div>
    <div id="chat-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism w-full max-w-lg h-[80vh] flex flex-col">
             <div class="flex justify-between items-center mb-4 border-b border-gray-200/50 pb-2">
                <h2 id="chat-title" class="text-xl font-bold text-gray-900">Assistente IA</h2>
                <button id="chat-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto p-2 space-y-4">
                 </div>
            <div class="mt-4 flex space-x-2">
                <input type="text" id="chat-input" class="form-input w-full" placeholder="Fa√ßa uma pergunta...">
                <button id="send-chat-btn" class="shiny-btn px-4 rounded-md"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-900">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-6">Para usar os recursos de IA, voc√™ precisa de uma chave de API do Google AI Studio. A chave ser√° salva apenas no seu navegador.</p>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave da API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui" class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-50">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="ml-3"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const getById = id => document.getElementById(id);

        let dailyChartInstance, empresasChartInstance, monitorGeralChartInstance, monitorEventChartInstance, radarChartInstance;
        let gastosComprasChartInstance, contasFixasChartInstance, pagamentosMonitoresChartInstance, despesasGiaisChartInstance;
        
        // --- L√ìGINA DE MIGRA√á√ÉO DE DADOS CORRIGIDA ---
        const CURRENT_STORAGE_KEY = 'financeDataV30'; // Chave desta vers√£o (v30)
        const V29_KEY = 'financeDataV29'; // Chave da v29
        const V23_KEY = 'financeDataV23';
        const V22_KEY = 'financeDataV22'; 

        let stateData = localStorage.getItem(CURRENT_STORAGE_KEY); // 1. Tenta carregar a v30

        if (!stateData) {
            // 2. Se n√£o achou, tenta a v29
            stateData = localStorage.getItem(V29_KEY);
            if (stateData) {
                 console.log(`Dados da v29 encontrados. Migrando para ${CURRENT_STORAGE_KEY}.`);
                 localStorage.setItem(CURRENT_STORAGE_KEY, stateData);
                 localStorage.removeItem(V29_KEY);
            } else {
                 // 3. Se n√£o achou, TENTA PRIORITARIAMENTE a v22 (onde os dados bons est√£o)
                stateData = localStorage.getItem(V22_KEY);
                if (stateData) {
                    console.log(`Dados bons da v22 encontrados! Migrando para ${CURRENT_STORAGE_KEY}.`);
                    localStorage.setItem(CURRENT_STORAGE_KEY, stateData); // Salva os dados bons na v30
                    localStorage.removeItem(V22_KEY); // Remove a v22
                    localStorage.removeItem(V23_KEY); // Remove a v23 (que podia estar vazia/errada)
                } else {
                    // 4. Se a v22 *realmente* n√£o existe, tenta a v23 (caso a migra√ß√£o anterior tenha dado certo)
                    stateData = localStorage.getItem(V23_KEY);
                    if (stateData) {
                        console.log(`Dados da v23 encontrados. Migrando para ${CURRENT_STORAGE_KEY}.`);
                        localStorage.setItem(CURRENT_STORAGE_KEY, stateData); // Salva os dados da v23 na v30
                        localStorage.removeItem(V23_KEY); // Remove a v23
                    }
                }
            }
        }
        // --- FIM DA L√ìGICA DE MIGRA√á√ÉO ---

        let state = JSON.parse(stateData) || {
            monitores: [], pagamentosMonitores: [], eventos: [], gastos: [], contas: [], contasFixas: [],
            funcionarios: [], 
            faixasComissao: [],
            gastoCategorias: [], // NOVO v30
            contaFixaCategorias: [], // NOVO v30
            currentEventItems: [], 
            selectedMonth: new Date().toISOString().slice(0, 7)
        };
        
        // Log de debug para verifica√ß√£o de carregamento
        console.log('üì¶ Dados carregados do localStorage (Financeiro):', {
            monitores: state.monitores?.length || 0,
            eventos: state.eventos?.length || 0,
            gastos: state.gastos?.length || 0,
            contasFixas: state.contasFixas?.length || 0,
            version: CURRENT_STORAGE_KEY
        });
        
        // --- DATA MIGRATION ---
        const migrateData = () => {
            let needsSave = false;
            
            // Migra√ß√µes v22 (contas fixas, etc.)
            if (state.monitores && Array.isArray(state.monitores)) {
                state.monitores.forEach(monitor => {
                    if (!monitor.desempenho) { monitor.desempenho = []; needsSave = true; }
                    if (!monitor.fotoPerfil) { monitor.fotoPerfil = null; needsSave = true; }
                    if (!monitor.telefone) { monitor.telefone = ''; needsSave = true; }
                    if (!monitor.email) { monitor.email = ''; needsSave = true; }
                    if (monitor.cnhCategoria === undefined) { monitor.cnhCategoria = ''; needsSave = true; }
                    if (!monitor.habilidades) { monitor.habilidades = { forca: 5, agilidade: 5, proatividade: 5, comunicacao: 5, disponibilidade: 5, respeito: 5 }; needsSave = true; }
                    if (monitor.habilidades && monitor.habilidades.respeito === undefined) { monitor.habilidades.respeito = 5; needsSave = true; }
                });
            }
            if (state.pagamentosMonitores && Array.isArray(state.pagamentosMonitores)) {
                state.pagamentosMonitores.forEach(pag => {
                    if (pag.statusPagamento === undefined) { pag.statusPagamento = 'Executado'; needsSave = true; }
                    if (pag.horaEntrada === undefined) { pag.horaEntrada = ''; needsSave = true; }
                    if (pag.horaSaida === undefined) { pag.horaSaida = ''; needsSave = true; }
                    if (pag.horasExtras === undefined) { pag.horasExtras = 0; needsSave = true; }
                });
            }
             if (state.gastos && Array.isArray(state.gastos)) {
                state.gastos.forEach(gasto => {
                    if (gasto.comprovantes === undefined) { gasto.comprovantes = []; needsSave = true; }
                    // Remove lan√ßamentos de sal√°rio antigos e hardcoded para for√ßar o rec√°lculo/relan√ßamento
                    if (gasto.isSalario && !gasto.funcionarioId) {
                        state.gastos = state.gastos.filter(g => g.id !== gasto.id);
                        needsSave = true;
                    }
                });
            }
            if (state.contasFixas && Array.isArray(state.contasFixas)) {
                state.contasFixas.forEach(cf => {
                    if (cf.anexo && !Array.isArray(cf.anexos)) { cf.anexos = [{ data: cf.anexo, name: cf.nomeAnexo || 'arquivo.bin', type: '' }]; delete cf.anexo; delete cf.nomeAnexo; needsSave = true; }
                    if (cf.anexos === undefined) { cf.anexos = []; needsSave = true; }
                    if (cf.tipoRecorrencia === undefined) { cf.tipoRecorrencia = 'permanente'; cf.dataInicio = null; cf.numParcelas = null; needsSave = true; }
                });
            }
            
            // --- Migra√ß√£o v29 (Sal√°rios Din√¢micos) ---
            if (!state.funcionarios) { state.funcionarios = []; needsSave = true; }
            if (!state.faixasComissao) { state.faixasComissao = []; needsSave = true; }

            // Preenche com dados iniciais se estiver vazio (migra o funcion√°rio 1)
            if (state.funcionarios.length === 0) {
                state.funcionarios = [
                    { id: 'func-default-1', nome: 'Funcion√°rio 1', salarioFixo: 2200, va: 390, vt: 223.60 }
                ];
                needsSave = true;
            }
            // Preenche as faixas de comiss√£o (com a faixa de 5% inclu√≠da)
            if (state.faixasComissao.length === 0) {
                state.faixasComissao = [
                    { id: 'com-1', ateValor: 45000, percentual: 0.02 },
                    { id: 'com-2', ateValor: 55000, percentual: 0.025 },
                    { id: 'com-3', ateValor: 65000, percentual: 0.03 },
                    { id: 'com-4', ateValor: 75000, percentual: 0.035 },
                    { id: 'com-5', ateValor: 85000, percentual: 0.04 },
                    { id: 'com-6', ateValor: 95000, percentual: 0.045 },
                    { id: 'com-7', ateValor: 99999999, percentual: 0.05 } // Faixa "acima de" (5%)
                ];
                needsSave = true;
            }
            
            // --- Migra√ß√£o v30 (Categorias Din√¢micas) ---
            if (!state.gastoCategorias) { state.gastoCategorias = []; needsSave = true; }
            if (!state.contaFixaCategorias) { state.contaFixaCategorias = []; needsSave = true; }

            if (state.gastoCategorias.length === 0) {
                state.gastoCategorias = [
                    { id: 'gc-1', nome: 'Transporte' },
                    { id: 'gc-2', nome: 'Combust√≠vel' },
                    { id: 'gc-3', nome: 'Manuten√ß√£o' },
                    { id: 'gc-4', nome: 'Alimenta√ß√£o' },
                    { id: 'gc-5', nome: 'Insumos' },
                    { id: 'gc-6', nome: 'Marketing' },
                    { id: 'gc-7', nome: 'Impostos' },
                    { id: 'gc-8', nome: 'Outros' }
                ];
                needsSave = true;
            }
            if (state.contaFixaCategorias.length === 0) {
                state.contaFixaCategorias = [
                    { id: 'cfc-1', nome: 'Aluguel' },
                    { id: 'cfc-2', nome: 'Energia' },
                    { id: 'cfc-3', nome: '√Ågua' },
                    { id: 'cfc-4', nome: 'Internet' },
                    { id: 'cfc-5', nome: 'Telefone' },
                    { id: 'cfc-6', nome: 'Software' },
                    { id: 'cfc-7', nome: 'Sal√°rios' },
                    { id: 'cfc-8', nome: 'Marketing Fixo' },
                    { id: 'cfc-9', nome: 'Outros' }
                ];
                needsSave = true;
            }
            // --- Fim Migra√ß√£o v30 ---
            
            if(needsSave) saveData();
        };

        const formatarMoeda = valor => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatarData = dataStr => new Date(dataStr + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'});
        const formatarPercentual = valor => `${(valor * 100).toFixed(1).replace('.', ',')}%`;
        const formatarMesAno = dataStr => {
            if (!dataStr || dataStr.length !== 7) return 'N/A';
            const [year, month] = dataStr.split('-');
            return `${month}/${year}`;
        }
        const dataParaInput = dateStr => dateStr ? new Date(dateStr).toISOString().split('T')[0] : '';
        const saveData = () => localStorage.setItem(CURRENT_STORAGE_KEY, JSON.stringify(state));
        
        const getScoreColor = (score) => {
            if (score === null || score === undefined) return { bg: 'bg-gray-200', text: 'text-gray-800' };
            if (score <= 3) return { bg: 'bg-red-200', text: 'text-red-800' };
            if (score <= 5) return { bg: 'bg-orange-300', text: 'text-orange-800' };
            if (score <= 7) return { bg: 'bg-amber-200', text: 'text-amber-800' };
            if (score <= 8.9) return { bg: 'bg-green-200', text: 'text-green-800' };
            return { bg: 'bg-yellow-300', text: 'text-yellow-800' }; // Dourado
        };
        const getScoreColorHex = (score) => {
             if (score === null || score === undefined) return '#e5e7eb'; // gray-200
             if (score <= 3) return '#fecaca'; // red-200
             if (score <= 5) return '#fdba74'; // orange-300
             if (score <= 7) return '#fde68a'; // amber-200
             if (score <= 8.9) return '#bbf7d0'; // green-200
             return '#fcd34d'; // yellow-300
        };


        const showToast = (message, isError = true) => {
            const toast = getById('toast');
            const toastMessage = getById('toast-message');
            const toastIcon = getById('toast-icon');
            toastMessage.textContent = message;
            toast.classList.toggle('bg-red-600', isError);
            toast.classList.toggle('bg-green-600', !isError);
            toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
            toast.classList.remove('hidden');
            toast.classList.add('toast-enter');
            setTimeout(() => {
                 toast.classList.add('hidden');
                 toast.classList.remove('toast-enter');
            }, 4000);
        };

        // --- L√ìGICA DE NAVEGA√á√ÉO ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const chatFabIcon = getById('chat-fab-icon');
        const pageIcons = {
            dashboard: 'fa-chart-pie',
            entradas: 'fa-calendar-check',
            gastos: 'fa-cart-shopping',
            'contas-fixas': 'fa-file-invoice-dollar',
            monitores: 'fa-user-astronaut',
            salarios: 'fa-money-bill-wave'
        };

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                const targetId = link.dataset.target;
                pages.forEach(page => page.classList.toggle('active', page.id === `page-${targetId}`));
                navLinks.forEach(nav => {
                    if (nav.dataset.target === targetId) {
                        nav.classList.add('active', 'shiny-btn');
                        nav.classList.remove('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    } else {
                        nav.classList.remove('active', 'shiny-btn');
                        nav.classList.add('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    }
                });
                // Update FAB icon
                chatFabIcon.className = `fa-solid ${pageIcons[targetId]} text-2xl`;
            });
        });

        // --- FILTRO DE M√äS ---
        const monthFilterInput = getById('month-filter-global');
        const updateMonthFilterInputs = () => { monthFilterInput.value = state.selectedMonth; };
        
        const setupMonthFilters = () => {
            monthFilterInput.addEventListener('change', e => { state.selectedMonth = e.target.value; renderAll(); });
            document.querySelectorAll('.month-nav-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const direction = parseInt(button.dataset.direction, 10);
                    const [year, month] = state.selectedMonth.split('-').map(Number);
                    const currentDate = new Date(year, month - 1, 15);
                    currentDate.setMonth(currentDate.getMonth() + direction);
                    const newYear = currentDate.getFullYear();
                    const newMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                    state.selectedMonth = `${newYear}-${newMonth}`;
                    renderAll();
                });
            });
        };

        // --- L√ìGICA DE DADOS ---
        const getFilteredData = (dataType) => {
            if (!state.selectedMonth) return state[dataType];
            return state[dataType].filter(item => item.data && item.data.startsWith(state.selectedMonth));
        };

        // --- RENDERIZA√á√ÉO ---
        const renderDashboard = () => {
            const [currentYear, currentMonthNum] = state.selectedMonth.split('-').map(Number);

            // --- Current Month Data ---
            const filteredEventos = getFilteredData('eventos');
            const filteredGastos = getFilteredData('gastos');
            const filteredPagamentosMonitores = getFilteredData('pagamentosMonitores');

            const currentReceitas = filteredEventos.reduce((acc, ev) => acc + ev.valor, 0);
            
            const currentDespesas = filteredGastos.reduce((acc, g) => acc + g.valor, 0) 
                                  + filteredPagamentosMonitores.reduce((acc, p) => acc + p.pagamento, 0);

            const currentSaldo = currentReceitas - currentDespesas;

            getById('total-receitas').textContent = formatarMoeda(currentReceitas);
            getById('total-despesas').textContent = formatarMoeda(currentDespesas);
            getById('saldo-total').textContent = formatarMoeda(currentSaldo);

            // --- Comparison Data Calculation ---
            const prevMonthDate = new Date(currentYear, currentMonthNum - 1, 1);
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonthStr = `${prevMonthDate.getFullYear()}-${(prevMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;

            const lastYearMonthStr = `${currentYear - 1}-${currentMonthNum.toString().padStart(2, '0')}`;

            const getTotalsForMonth = (monthStr) => {
                const eventos = state.eventos.filter(item => item.data && item.data.startsWith(monthStr));
                const gastos = state.gastos.filter(item => item.data && item.data.startsWith(monthStr));
                const pagamentos = state.pagamentosMonitores.filter(item => item.data && item.data.startsWith(monthStr));
                const receitas = eventos.reduce((acc, ev) => acc + ev.valor, 0);
                const despesas = gastos.reduce((acc, g) => acc + g.valor, 0) + pagamentos.reduce((acc, p) => acc + p.pagamento, 0);
                return { receitas, despesas, saldo: receitas - despesas };
            };
            
            const prevMonthTotals = getTotalsForMonth(prevMonthStr);
            const lastYearTotals = getTotalsForMonth(lastYearMonthStr);

            // --- Yearly Average Calculation ---
            const yearEventos = state.eventos.filter(i => i.data && i.data.startsWith(currentYear.toString()));
            const yearGastos = state.gastos.filter(i => i.data && i.data.startsWith(currentYear.toString()));
            const yearPagamentos = state.pagamentosMonitores.filter(i => i.data && i.data.startsWith(currentYear.toString()));

            const monthsWithData = new Set([...yearEventos, ...yearGastos, ...yearPagamentos].map(i => i.data.substring(0, 7)));
            const numMonths = monthsWithData.size || 1;

            const totalYearReceitas = yearEventos.reduce((acc, ev) => acc + ev.valor, 0);
            const totalYearDespesas = yearGastos.reduce((acc, g) => acc + g.valor, 0) + yearPagamentos.reduce((acc, p) => acc + p.pagamento, 0);
            
            const avgYearlyTotals = {
                receitas: totalYearReceitas / numMonths,
                despesas: totalYearDespesas / numMonths,
                saldo: (totalYearReceitas - totalYearDespesas) / numMonths
            };

            // --- Percentage Calculation & Rendering ---
            const calculatePercentageChange = (current, previous) => {
                if (previous === 0 || previous === null || previous === undefined) {
                    return current !== 0 ? { value: Infinity, text: 'Novo' } : { value: 0, text: '-' };
                }
                const change = ((current - previous) / Math.abs(previous)) * 100;
                return { value: change, text: `${change > 0 ? '+' : ''}${change.toFixed(1)}%` };
            };

            const renderComparison = (change, isInverse = false) => {
                let colorClass = 'text-gray-500';
                let icon = '<i class="fa-solid fa-minus mx-1"></i>';

                if (change.value > 0) {
                    colorClass = isInverse ? 'text-red-500' : 'text-emerald-500';
                    icon = '<i class="fa-solid fa-arrow-up mx-1"></i>';
                } else if (change.value < 0) {
                    colorClass = isInverse ? 'text-emerald-500' : 'text-red-500';
                    icon = '<i class="fa-solid fa-arrow-down mx-1"></i>';
                }
                
                if (change.value === Infinity) {
                    colorClass = isInverse ? 'text-red-500' : 'text-emerald-500';
                    icon = '<i class="fa-solid fa-star mx-1"></i>';
                }

                return `<span class="font-semibold ${colorClass}">${icon}${change.text}</span>`;
            };

            const comparisonData = [
                { id: 'receitas-comparison', current: currentReceitas, prev: prevMonthTotals.receitas, lastYear: lastYearTotals.receitas, avg: avgYearlyTotals.receitas, inverse: false },
                { id: 'despesas-comparison', current: currentDespesas, prev: prevMonthTotals.despesas, lastYear: lastYearTotals.despesas, avg: avgYearlyTotals.despesas, inverse: true },
                { id: 'saldo-comparison', current: currentSaldo, prev: prevMonthTotals.saldo, lastYear: lastYearTotals.saldo, avg: avgYearlyTotals.saldo, inverse: false }
            ];

            comparisonData.forEach(data => {
                const prevChange = calculatePercentageChange(data.current, data.prev);
                const lastYearChange = calculatePercentageChange(data.current, data.lastYear);
                const avgChange = calculatePercentageChange(data.current, data.avg);

                const comparisonEl = getById(data.id);
                if (comparisonEl) {
                    comparisonEl.innerHTML = `
                        <div class="flex justify-between items-center px-2">
                            <span class="text-gray-500">vs M√™s Ant.</span>
                            ${renderComparison(prevChange, data.inverse)}
                        </div>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-gray-500">vs Ano Ant.</span>
                            ${renderComparison(lastYearChange, data.inverse)}
                        </div>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-gray-500">vs M√©dia Ano</span>
                            ${renderComparison(avgChange, data.inverse)}
                        </div>
                    `;
                }
            });
        };
        
        const createActionButtons = (item, tipo) => {
            // Desabilita bot√µes para gastos de sal√°rio lan√ßados automaticamente
            if (tipo === 'gastos' && item.isSalario) {
                return `<div class="flex space-x-4">
                            <button class="action-btn text-gray-400" disabled title="Edi√ß√£o desabilitada para lan√ßamento de sal√°rio"><i class="fa-solid fa-pencil"></i></button>
                            <button class="action-btn delete-btn" onclick="handleDelete('${item.id}', '${tipo}')"><i class="fa-solid fa-trash-can"></i></button>
                        </div>`;
            }
            return `<div class="flex space-x-4">
                        <button class="action-btn edit-btn" onclick="handleEdit('${item.id}', '${tipo}')"><i class="fa-solid fa-pencil"></i></button>
                        <button class="action-btn delete-btn" onclick="handleDelete('${item.id}', '${tipo}')"><i class="fa-solid fa-trash-can"></i></button>
                    </div>`;
        };
        
        const renderContasFixasTables = () => {
            // Tabela de Contas Fixas Cadastradas (DB)
            getById('tabela-contas-fixas-db').querySelector('tbody').innerHTML = state.contasFixas.map(cf => {
                const anexoHtml = cf.anexos && cf.anexos.length > 0
                    ? `<button onclick="openAttachmentViewer('${cf.id}', 'contasFixas')" class="text-indigo-600 hover:text-indigo-800 text-lg" title="Ver ${cf.anexos.length} anexo(s)">
                           <i class="fa-solid fa-folder-open"></i> <span class="text-sm font-bold">${cf.anexos.length}</span>
                       </button>`
                    : `<span class="text-gray-400">-</span>`;
                
                let recorrenciaHtml = '<span class="px-2 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-full">Permanente</span>';
                if (cf.tipoRecorrencia === 'parcelada') {
                    recorrenciaHtml = `<span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-200 rounded-full">${cf.numParcelas || 'N/A'}x</span> 
                                        <span class="text-xs text-gray-600">(In√≠cio: ${formatarMesAno(cf.dataInicio)})</span>`;
                }

                return `<tr>
                            <td>${cf.descricao}</td>
                            <td>${formatarMoeda(cf.valor)}</td>
                            <td>${cf.diaVencimento}</td>
                            <td>${cf.categoria}</td>
                            <td>${recorrenciaHtml}</td>
                            <td class="text-center">${anexoHtml}</td>
                            <td>${createActionButtons(cf, 'contasFixas')}</td>
                        </tr>`;
            }).join('');

            // Tabela de Lan√ßamento de Contas Fixas do M√™s (Filtrada)
            const [year, month] = state.selectedMonth.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, 1);
            const gastosDoMes = state.gastos.filter(g => g.data.startsWith(state.selectedMonth));

            const contasFixasDoMes = state.contasFixas.filter(cf => {
                const tipo = cf.tipoRecorrencia || 'permanente';
                if (tipo === 'permanente') return true;
                if (tipo === 'parcelada' && cf.dataInicio && cf.numParcelas) {
                    try {
                        const [startYear, startMonthNum] = cf.dataInicio.split('-').map(Number);
                        const startDate = new Date(startYear, startMonthNum - 1, 1);
                        const endDate = new Date(startDate);
                        endDate.setMonth(endDate.getMonth() + parseInt(cf.numParcelas));
                        return selectedDate >= startDate && selectedDate < endDate;
                    } catch (e) { console.error("Erro ao calcular data da parcela:", e, cf); return false; }
                }
                return true;
            });

            getById('tabela-contas-fixas-mes').querySelector('tbody').innerHTML = contasFixasDoMes.map(cf => {
                const vencimento = `${String(cf.diaVencimento).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                let descricaoHtml = cf.descricao;
                if (cf.tipoRecorrencia === 'parcelada') {
                    const [startYear, startMonthNum] = cf.dataInicio.split('-').map(Number);
                    const monthsDiff = (year - startYear) * 12 + (month - startMonthNum);
                    const currentInstallment = monthsDiff + 1;
                    descricaoHtml += ` <span class="text-xs text-gray-500 font-normal">(Parcela ${currentInstallment} de ${cf.numParcelas})</span>`;
                }
                const gastoCorrespondente = gastosDoMes.find(g => g.contaFixaId === cf.id);
                const isPaid = !!gastoCorrespondente;
                const statusHtml = isPaid ? `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Lan√ßado</span>` : `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Pendente</span>`;
                const actionHtml = isPaid ? `<button class="action-btn text-gray-400" disabled title="Gasto j√° lan√ßado"><i class="fa-solid fa-check"></i> Lan√ßado</button>` : `<button class="shiny-btn text-sm py-1 px-2" onclick="lancarGastoFixo('${cf.id}')">Lan√ßar</button>`;
                const valorPagoHtml = isPaid ? formatarMoeda(gastoCorrespondente.valor) : '-';
                const dataPagHtml = isPaid ? formatarData(gastoCorrespondente.data) : '-';
                const comprovantes = gastoCorrespondente?.comprovantes;
                const comprovanteHtml = comprovantes && comprovantes.length > 0
                    ? `<button onclick="openAttachmentViewer('${gastoCorrespondente.id}', 'gastos')" class="text-indigo-600 hover:text-indigo-800 text-lg" title="Ver ${comprovantes.length} comprovante(s)">
                           <i class="fa-solid fa-receipt"></i> <span class="text-sm font-bold">${comprovantes.length}</span>
                       </button>`
                    : `-`;
                return `<tr>
                    <td>${descricaoHtml}</td>
                    <td>${formatarMoeda(cf.valor)}</td>
                    <td>${vencimento}</td>
                    <td>${statusHtml}</td>
                    <td>${valorPagoHtml}</td>
                    <td>${dataPagHtml}</td>
                    <td class="text-center">${comprovanteHtml}</td>
                    <td>${actionHtml}</td>
                </tr>`;
            }).join('');
            
            // Tabela de Categorias de Contas Fixas
             getById('tabela-cf-categorias-db').querySelector('tbody').innerHTML = state.contaFixaCategorias.map(c => `
                <tr>
                    <td>${c.nome}</td>
                    <td>${createActionButtons(c, 'contaFixaCategorias')}</td>
                </tr>
            `).join('');
        };

        const renderTables = () => {
            // Tabela de Eventos
            getById('tabela-eventos').querySelector('tbody').innerHTML = getFilteredData('eventos').map(ev => {
                const itemsHtml = ev.items && ev.items.length > 0 ? `<ul class="item-list-cell">${ev.items.map(item => `<li>${item.nome}</li>`).join('')}</ul>` : '';
                const contratanteHtml = ev.isSynced ? `<span>üìÖ ${ev.contratante}</span>` : ev.contratante;
                return `<tr><td>${formatarData(ev.data)}</td><td>${ev.empresa}</td><td>${contratanteHtml}</td><td>${ev.local}</td><td>${itemsHtml}</td><td>${formatarMoeda(ev.valor)}</td><td>${createActionButtons(ev, 'eventos')}</td></tr>`;
            }).join('');
            
            // Tabela de Gastos
            getById('tabela-gastos').querySelector('tbody').innerHTML = getFilteredData('gastos').sort((a,b) => new Date(a.data) - new Date(b.data)).map(g => {
                const trClass = g.isSalario ? 'bg-indigo-50/50' : '';
                const descHtml = g.isSalario ? `<span class="font-semibold text-indigo-700"><i class="fa-solid fa-money-bill-wave mr-2"></i>${g.descricao}</span>` : g.descricao;
                return `<tr class="${trClass}">
                            <td>${formatarData(g.data)}</td>
                            <td>${descHtml}</td>
                            <td>${g.categoria}</td>
                            <td>${g.conta}</td>
                            <td>${g.pagamento}</td>
                            <td>${formatarMoeda(g.valor)}</td>
                            <td>${createActionButtons(g, 'gastos')}</td>
                        </tr>`;
            }).join('');
            
            // Tabela de Monitores
            getById('tabela-monitores-db').querySelector('tbody').innerHTML = state.monitores.map(m => {
                const avgScore = m.desempenho.length ? m.desempenho.reduce((acc, nota) => acc + parseFloat(nota.nota), 0) / m.desempenho.length : null;
                const scoreColors = getScoreColor(avgScore);
                const avgScoreHtml = avgScore !== null ? `<span class="px-2 py-1 text-xs font-bold ${scoreColors.bg} ${scoreColors.text} rounded-full">${avgScore.toFixed(1)}</span>` : '-';
                return `<tr>
                    <td>${m.nome}</td>
                    <td>${m.cnh ? '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Sim</span>' : '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">N√£o</span>'}</td>
                    <td>${avgScoreHtml}</td>
                    <td><div class="flex space-x-4"><button class="action-btn text-sky-500 hover:text-sky-700" onclick="handleView('${m.id}', 'monitores')" title="Ver Detalhes"><i class="fa-solid fa-eye"></i></button><button class="action-btn edit-btn" onclick="handleEdit('${m.id}', 'monitores')" title="Editar"><i class="fa-solid fa-pencil"></i></button><button class="action-btn delete-btn" onclick="handleDelete('${m.id}', 'monitores')" title="Excluir"><i class="fa-solid fa-trash-can"></i></button></div></td>
                </tr>`;
            }).join('');
            
            // Tabela de Pagamentos
            getById('tabela-pagamentos-monitores').querySelector('tbody').innerHTML = getFilteredData('pagamentosMonitores').map(p => {
                const monitor = state.monitores.find(m => m.id === p.monitorId);
                const notaDoDia = monitor?.desempenho.find(d => d.data === p.data && d.pagamentoId === p.id);
                const score = notaDoDia ? parseFloat(notaDoDia.nota) : null;
                const pagScoreColors = getScoreColor(score);
                const notaHtml = score !== null ? `<span class="px-2 py-1 text-xs font-bold ${pagScoreColors.bg} ${pagScoreColors.text} rounded-full">${score.toFixed(1)}</span>` : '-';
                const status = p.statusPagamento || 'Executado';
                const statusClass = status === 'Executado' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
                const statusHtml = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${status}</span>`;
                return `<tr>
                    <td>${formatarData(p.data)}</td>
                    <td>${p.nome}</td>
                    <td>${formatarMoeda(p.valorBase)}</td>
                    <td>${formatarMoeda(p.adicional)}</td>
                    <td>${formatarMoeda(p.horasExtras)}</td>
                    <td>${formatarMoeda(p.pagamento)}</td>
                    <td>${statusHtml}</td>
                    <td>${notaHtml}</td>
                    <td>${createActionButtons(p, 'pagamentosMonitores')}</td>
                </tr>`;
            }).join('');

            // Tabela de Contas
            getById('tabela-contas-db').querySelector('tbody').innerHTML = state.contas.map(c => {
                const agenciaConta = (c.agencia || c.numero) ? `${c.agencia || ''} / ${c.numero || ''}` : '-';
                return `<tr><td>${c.nome}</td><td>${c.banco}</td><td>${c.tipo}</td><td>${agenciaConta}</td><td>${createActionButtons(c, 'contas')}</td></tr>`;
            }).join('');
            
            // Tabela de Categorias de Gastos
            getById('tabela-gasto-categorias-db').querySelector('tbody').innerHTML = state.gastoCategorias.map(c => `
                <tr>
                    <td>${c.nome}</td>
                    <td>${createActionButtons(c, 'gastoCategorias')}</td>
                </tr>
            `).join('');
            
            renderContasFixasTables();
        };
        
        // --- SE√á√ÉO DE SAL√ÅRIOS (ATUALIZADA) ---
        
        // Fun√ß√£o recalcula a comiss√£o com base nas faixas do state
        const calcularComissao = (totalEntradas) => {
            const faixasOrdenadas = [...state.faixasComissao].sort((a, b) => a.ateValor - b.ateValor);
            const faixaEncontrada = faixasOrdenadas.find(f => totalEntradas <= f.ateValor);

            if (faixaEncontrada) {
                const comissao = totalEntradas * faixaEncontrada.percentual;
                const faixaDesc = `(${formatarPercentual(faixaEncontrada.percentual)} sobre ${formatarMoeda(totalEntradas)})`;
                return { comissao, percentual: faixaEncontrada.percentual, faixaDesc };
            }
            // Retorna 0 se nenhuma faixa for encontrada (ex: faturamento abaixo da menor faixa)
            const menorFaixa = faixasOrdenadas[0];
            if (menorFaixa && totalEntradas < menorFaixa.ateValor) {
                 return { comissao: 0, percentual: 0, faixaDesc: `(Abaixo da 1¬™ faixa de ${formatarMoeda(menorFaixa.ateValor)})` };
            }
            
            return { comissao: 0, percentual: 0, faixaDesc: "Nenhuma faixa aplic√°vel" };
        };

        // Renderiza a se√ß√£o de sal√°rios (agora din√¢mica)
        const renderSalarios = () => {
            const select = getById('salario-funcionario-select');
            const selectedEmployeeId = select.value;
            const container = getById('salario-calculo-container');
            const msgSelecione = getById('salario-selecione-msg');

            if (!selectedEmployeeId) {
                container.classList.add('hidden');
                msgSelecione.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            msgSelecione.classList.add('hidden');

            const funcionario = state.funcionarios.find(f => f.id === selectedEmployeeId);
            if (!funcionario) return;

            getById('salario-nome-funcionario').textContent = `C√°lculo para: ${funcionario.nome}`;

            const filteredEventos = getFilteredData('eventos');
            const totalEntradas = filteredEventos.reduce((acc, ev) => acc + ev.valor, 0);
            const { comissao, faixaDesc } = calcularComissao(totalEntradas);
            
            const salarioFixo = funcionario.salarioFixo || 0;
            const va = funcionario.va || 0;
            const vt = funcionario.vt || 0;
            const totalPagar = salarioFixo + va + vt + comissao;

            // Atualiza os cards de resumo
            getById('salario-total-entradas').textContent = formatarMoeda(totalEntradas);
            getById('salario-comissao').textContent = formatarMoeda(comissao);
            getById('salario-comissao-percentual').textContent = faixaDesc;
            getById('salario-total-pagar').textContent = formatarMoeda(totalPagar);

            // Atualiza o detalhamento
            getById('salario-fixo').textContent = formatarMoeda(salarioFixo);
            getById('salario-va').textContent = formatarMoeda(va);
            getById('salario-vt').textContent = formatarMoeda(vt);
            getById('salario-comissao-detalhe').textContent = formatarMoeda(comissao);
            getById('salario-total-detalhe').textContent = formatarMoeda(totalPagar);

            // Verifica se o sal√°rio j√° foi lan√ßado
            const idSalarioLancado = `salario-${funcionario.id}-${state.selectedMonth}`;
            const gastoSalario = state.gastos.find(g => g.id === idSalarioLancado);
            
            const btnLancar = getById('btn-lancar-salario');
            const msgLancado = getById('salario-lancado-msg');

            if (gastoSalario) {
                btnLancar.disabled = true;
                btnLancar.textContent = 'Sal√°rio Lan√ßado';
                msgLancado.classList.remove('hidden');
            } else {
                btnLancar.disabled = false;
                btnLancar.innerHTML = '<i class="fa-solid fa-arrow-down-to-bracket mr-2"></i> Lan√ßar Sal√°rio como Despesa';
                msgLancado.classList.add('hidden');
            }
        };

        // Renderiza as tabelas dentro do Modal de Configura√ß√£o de Sal√°rios
        const renderSalariosConfigTables = () => {
            // Tabela de Funcion√°rios
            getById('tabela-funcionarios-config').querySelector('tbody').innerHTML = state.funcionarios.map(f => `
                <tr>
                    <td>${f.nome}</td>
                    <td>${formatarMoeda(f.salarioFixo)}</td>
                    <td>${formatarMoeda(f.va)}</td>
                    <td>${formatarMoeda(f.vt)}</td>
                    <td>${createActionButtons(f, 'funcionarios')}</td>
                </tr>
            `).join('');

            // Tabela de Comiss√µes
            getById('tabela-comissao-config').querySelector('tbody').innerHTML = [...state.faixasComissao].sort((a,b) => a.ateValor - b.ateValor).map((f, index) => `
                <tr>
                    <td>${f.ateValor === 99999999 ? 'Acima de...' : formatarMoeda(f.ateValor)}</td>
                    <td>${formatarPercentual(f.percentual)}</td>
                    <td><button class="action-btn delete-btn" onclick="deleteFaixaComissao('${f.id}')"><i class="fa-solid fa-trash-can"></i></button></td>
                </tr>
            `).join('');
        };

        // --- FIM SE√á√ÉO SAL√ÅRIOS ---


        const renderCharts = () => {
            const filteredEventos = getFilteredData('eventos');
            const filteredGastos = getFilteredData('gastos');
            const filteredPagamentosMonitores = getFilteredData('pagamentosMonitores');

            // Pie chart - Receitas
            const receitaPorEmpresa = filteredEventos.reduce((acc, evento) => { acc[evento.empresa] = (acc[evento.empresa] || 0) + evento.valor; return acc; }, {});
            if (empresasChartInstance) empresasChartInstance.destroy();
            empresasChartInstance = new Chart(getById('empresas-chart'), { type: 'pie', data: { labels: Object.keys(receitaPorEmpresa), datasets: [{ data: Object.values(receitaPorEmpresa), backgroundColor: ['#4f46e5', '#f59e0b', '#10b981'] }] }, options: { responsive: true, maintainAspectRatio: true } });
            
            // Categorias de Contas Fixas (para filtrar o gr√°fico)
            const fixedCostCategories = state.contaFixaCategorias.map(c => c.nome);

            // Pie chart - Distribui√ß√£o de Despesas
            const totalGastosCompras = filteredGastos
                .filter(g => !fixedCostCategories.includes(g.categoria))
                .reduce((acc, gasto) => acc + gasto.valor, 0);
            
            const totalContasFixasESalarios = filteredGastos
                .filter(g => fixedCostCategories.includes(g.categoria))
                .reduce((acc, gasto) => acc + gasto.valor, 0);
                
            const totalPagamentosMonitoresChart = filteredPagamentosMonitores
                .reduce((acc, p) => acc + p.pagamento, 0);

            if (despesasGiaisChartInstance) despesasGiaisChartInstance.destroy();
            despesasGiaisChartInstance = new Chart(getById('despesas-gerais-chart'), {
                type: 'pie',
                data: {
                    labels: ['Gastos e Compras', 'Contas Fixas & Sal√°rios', 'Pagamentos Monitores'],
                    datasets: [{
                        data: [totalGastosCompras, totalContasFixasESalarios, totalPagamentosMonitoresChart],
                        backgroundColor: ['#ef4444', '#f97316', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Bar chart - Gastos & Compras
            const gastosCompras = filteredGastos.filter(g => !fixedCostCategories.includes(g.categoria));
            const gastosComprasPorCategoria = gastosCompras.reduce((acc, gasto) => {
                acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.valor;
                return acc;
            }, {});

            if (gastosComprasChartInstance) gastosComprasChartInstance.destroy();
            gastosComprasChartInstance = new Chart(getById('gastos-compras-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(gastosComprasPorCategoria),
                    datasets: [{
                        label: 'Valor Gasto',
                        data: Object.values(gastosComprasPorCategoria),
                        backgroundColor: '#ef4444',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            // Bar chart - Contas Fixas (Inclui Sal√°rios)
            const contasFixasPagas = filteredGastos.filter(g => fixedCostCategories.includes(g.categoria));
            const contasFixasPorCategoria = contasFixasPagas.reduce((acc, gasto) => {
                acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.valor;
                return acc;
            }, {});

            if (contasFixasChartInstance) contasFixasChartInstance.destroy();
            contasFixasChartInstance = new Chart(getById('contas-fixas-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(contasFixasPorCategoria),
                    datasets: [{
                        label: 'Valor Gasto',
                        data: Object.values(contasFixasPorCategoria),
                        backgroundColor: '#f97316',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            // Bar chart - Pagamentos Monitores
            const pagamentosPorMonitor = filteredPagamentosMonitores.reduce((acc, p) => {
                acc[p.nome] = (acc[p.nome] || 0) + p.pagamento;
                return acc;
            }, {});

            if (pagamentosMonitoresChartInstance) pagamentosMonitoresChartInstance.destroy();
            pagamentosMonitoresChartInstance = new Chart(getById('pagamentos-monitores-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(pagamentosPorMonitor),
                    datasets: [{
                        label: 'Total Pago',
                        data: Object.values(pagamentosPorMonitor),
                        backgroundColor: '#8b5cf6',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });


            // Bar chart (Fluxo de Caixa)
            const dailyData = {};
            const [year, month] = state.selectedMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            labels.forEach(day => { dailyData[day] = { receitas: 0, despesas: 0 }; });
            filteredEventos.forEach(ev => { const day = new Date(ev.data + 'T00:00:00').getUTCDate(); if(dailyData[day]) dailyData[day].receitas += ev.valor; });
            const allDespesas = [...filteredGastos, ...filteredPagamentosMonitores];
            allDespesas.forEach(d => { const day = new Date(d.data + 'T00:00:00').getUTCDate(); if(dailyData[day]) dailyData[day].despesas += (d.valor || d.pagamento); });

            if (dailyChartInstance) dailyChartInstance.destroy();
            dailyChartInstance = new Chart(getById('daily-chart'), { type: 'bar', data: { labels: labels, datasets: [ { label: 'Receitas', data: labels.map(day => dailyData[day].receitas), backgroundColor: 'rgba(16, 185, 129, 0.7)' }, { label: 'Despesas', data: labels.map(day => dailyData[day].despesas), backgroundColor: 'rgba(239, 68, 68, 0.7)' } ] }, options: { responsive: true, maintainAspectRatio: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
        
            renderMonitorCharts();
        };

        const renderMonitorCharts = () => {
            // Chart 1: M√©dia Geral de Desempenho (Dashboard)
            const monitoresComMedia = state.monitores.map(m => {
                const avgScore = m.desempenho.length ? m.desempenho.reduce((acc, nota) => acc + parseFloat(nota.nota), 0) / m.desempenho.length : 0;
                return { nome: m.nome, media: avgScore };
            }).sort((a,b) => b.media - a.media);

            if (monitorGeralChartInstance) monitorGeralChartInstance.destroy();
            monitorGeralChartInstance = new Chart(getById('monitor-geral-performance-chart'), {
                type: 'bar',
                data: {
                    labels: monitoresComMedia.map(m => m.nome),
                    datasets: [{
                        label: 'M√©dia Geral',
                        data: monitoresComMedia.map(m => m.media),
                        backgroundColor: monitoresComMedia.map(m => getScoreColorHex(m.media)),
                        borderColor: monitoresComMedia.map(m => getScoreColorHex(m.media)),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 10 } } }
            });

            // Chart 2: M√©dia do M√™s (P√°gina Monitores)
             const filteredPagamentos = getFilteredData('pagamentosMonitores');
             const mediaMesMonitores = {};
             state.monitores.forEach(m => {
                 const pagamentosDoMonitorNoMes = filteredPagamentos.filter(p => p.monitorId === m.id);
                 if (pagamentosDoMonitorNoMes.length > 0) {
                     const notasDoMes = m.desempenho.filter(d => pagamentosDoMonitorNoMes.some(p => p.id === d.pagamentoId));
                     if (notasDoMes.length > 0) {
                         const avgScore = notasDoMes.reduce((acc, nota) => acc + parseFloat(nota.nota), 0) / notasDoMes.length;
                         mediaMesMonitores[m.nome] = avgScore;
                     }
                 }
             });

            const monitoresMesArray = Object.keys(mediaMesMonitores).map(nome => ({ nome, media: mediaMesMonitores[nome] })).sort((a,b) => b.media - a.media);

            if (monitorEventChartInstance) monitorEventChartInstance.destroy();
            monitorEventChartInstance = new Chart(getById('monitor-event-performance-chart'), {
                 type: 'bar',
                 data: {
                     labels: monitoresMesArray.map(m => m.nome),
                     datasets: [{
                         label: `M√©dia de Desempenho em ${state.selectedMonth}`,
                         data: monitoresMesArray.map(m => m.media),
                         backgroundColor: monitoresMesArray.map(m => getScoreColorHex(m.media)),
                     }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 10 } } }
            });
        };

        const renderMonitorsSidebar = () => {
            const sidebarList = getById('monitors-sidebar-list');
            sidebarList.innerHTML = state.monitores.map(m => {
                 const avgScore = m.desempenho.length ? m.desempenho.reduce((acc, nota) => acc + parseFloat(nota.nota), 0) / m.desempenho.length : null;
                const scoreColors = getScoreColor(avgScore);
                const avgScoreHtml = avgScore !== null ? `<span class="px-1.5 py-0.5 text-xs font-bold ${scoreColors.bg} ${scoreColors.text} rounded-full">${avgScore.toFixed(1)}</span>` : '';

                return `<a href="#" onclick="handleView('${m.id}', 'monitores')">
                            <img src="${m.fotoPerfil || 'https://placehold.co/128x128/e0e0e0/757575?text=Perfil'}" class="w-8 h-8 object-cover rounded-full">
                            <span class="font-semibold text-sm flex-grow">${m.nome.split(' ')[0]}</span>
                            ${avgScoreHtml}
                        </a>`;
            }).join('');
        }
        
        const populateSelectWithOptions = (selectId, options, placeholder) => {
            const select = getById(selectId);
            select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.id;
                opt.textContent = option.nome;
                select.appendChild(opt);
            });
        };
        
        // NOVO: Popula os selects de categoria
        const populateCategorySelects = () => {
            const gastoCatSelect = getById('gasto-categoria');
            gastoCatSelect.innerHTML = '<option value="">-- Selecione --</option>';
            state.gastoCategorias.forEach(c => gastoCatSelect.innerHTML += `<option value="${c.nome}">${c.nome}</option>`);
            
            const cfCatSelect = getById('conta-fixa-categoria');
            cfCatSelect.innerHTML = '<option value="">-- Selecione --</option>';
            state.contaFixaCategorias.forEach(c => cfCatSelect.innerHTML += `<option value="${c.nome}">${c.nome}</option>`);
        };
        
        const renderAll = () => {
            updateMonthFilterInputs();
            renderDashboard(); 
            renderTables(); 
            renderSalarios(); 
            renderCharts(); 
            renderMonitorsSidebar();
            renderSalariosConfigTables(); // Atualiza tabelas do modal
            populateSelectWithOptions('monitor-select', state.monitores, 'Selecione um monitor');
            populateSelectWithOptions('gasto-conta', state.contas, 'Selecione uma conta');
            populateSelectWithOptions('lancamento-cf-conta', state.contas, 'Selecione uma conta');
            populateSelectWithOptions('salario-funcionario-select', state.funcionarios, 'Selecione um funcion√°rio');
            populateCategorySelects(); // NOVO: Popula selects de categoria
            saveData(); 
        };

        // --- L√ìGICA DE CADASTROS E FORMUL√ÅRIOS ---
        const readFileAsDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ data: reader.result, name: file.name, type: file.type });
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const renderTempItems = () => { getById('itens-temp-list').innerHTML = state.currentEventItems.map((item, index) => `<li class="flex justify-between items-center bg-gray-100/50 p-2 rounded-md"><span>${item.nome} - ${formatarMoeda(item.valor)}</span><button type="button" class="action-btn delete-btn" onclick="removeTempItem(${index})"><i class="fa-solid fa-times"></i></button></li>`).join(''); };
        window.removeTempItem = (index) => { state.currentEventItems.splice(index, 1); renderTempItems(); };
        getById('btn-add-item').addEventListener('click', () => { const nome = getById('item-nome').value; const valor = parseFloat(getById('item-valor').value); if (nome && valor > 0) { state.currentEventItems.push({ nome, valor }); renderTempItems(); getById('item-nome').value = ''; getById('item-valor').value = ''; getById('item-nome').focus(); } });
        getById('form-evento').addEventListener('submit', e => { e.preventDefault(); if (state.currentEventItems.length === 0) { showToast('Adicione pelo menos um item ao evento.'); return; } const valorTotal = state.currentEventItems.reduce((acc, item) => acc + item.valor, 0); state.eventos.push({ id: Date.now().toString(), data: getById('evento-data').value, empresa: getById('evento-empresa').value, contratante: getById('evento-contratante').value, local: getById('evento-local').value, items: state.currentEventItems, valor: valorTotal }); state.currentEventItems = []; renderTempItems(); getById('form-evento').reset(); hideModal(getById('add-entrada-modal')); renderAll(); showToast('Evento salvo com sucesso!', false);});
        getById('form-gasto').addEventListener('submit', e => { e.preventDefault(); const contaId = getById('gasto-conta').value; const contaSelecionada = state.contas.find(c => c.id === contaId); if (!contaSelecionada) { showToast('Por favor, selecione uma conta de sa√≠da v√°lida.'); return; } const categoria = getById('gasto-categoria').value; if (!categoria) { showToast('Por favor, selecione uma categoria.'); return; } state.gastos.push({ id: Date.now().toString(), data: getById('gasto-data').value, descricao: getById('gasto-descricao').value, categoria: categoria, contaId: contaSelecionada.id, conta: contaSelecionada.nome, pagamento: getById('gasto-pagamento').value, valor: parseFloat(getById('gasto-valor').value), comprovantes: [] }); e.target.reset(); hideModal(getById('add-gasto-modal')); renderAll(); showToast('Gasto adicionado com sucesso!', false);});
        getById('form-cadastro-conta').addEventListener('submit', e => { e.preventDefault(); state.contas.push({ id: Date.now().toString(), nome: getById('cadastro-conta-nome').value, banco: getById('cadastro-conta-banco').value, tipo: getById('cadastro-conta-tipo').value, agencia: getById('cadastro-conta-agencia').value, numero: getById('cadastro-conta-numero').value }); e.target.reset(); renderAll(); showToast('Conta salva com sucesso!', false); });
        
        // NOVO: Handlers para forms de categoria
        getById('form-gasto-categoria').addEventListener('submit', e => {
            e.preventDefault();
            const nome = getById('gasto-categoria-nome').value.trim();
            if (nome && !state.gastoCategorias.some(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                state.gastoCategorias.push({ id: `gc-${Date.now()}`, nome });
                e.target.reset();
                renderAll();
                showToast('Categoria de gasto salva!', false);
            } else if (nome) {
                showToast('Essa categoria j√° existe.');
            }
        });

        getById('form-conta-fixa-categoria').addEventListener('submit', e => {
            e.preventDefault();
            const nome = getById('cf-categoria-nome').value.trim();
            if (nome && !state.contaFixaCategorias.some(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                state.contaFixaCategorias.push({ id: `cfc-${Date.now()}`, nome });
                e.target.reset();
                renderAll();
                showToast('Categoria de conta fixa salva!', false);
            } else if (nome) {
                showToast('Essa categoria j√° existe.');
            }
        });
        
        const tipoRecorrenciaSelect = getById('conta-fixa-tipo-recorrencia');
        const parcelamentoContainer = getById('conta-fixa-parcelamento-container');
        tipoRecorrenciaSelect.addEventListener('change', () => {
            const isParcelada = tipoRecorrenciaSelect.value === 'parcelada';
            parcelamentoContainer.classList.toggle('hidden', !isParcelada);
            getById('conta-fixa-data-inicio').required = isParcelada;
            getById('conta-fixa-num-parcelas').required = isParcelada;
        });

        getById('form-conta-fixa').addEventListener('submit', async e => {
            e.preventDefault();
            const categoria = getById('conta-fixa-categoria').value;
            if (!categoria) {
                showToast('Por favor, selecione uma categoria para a conta fixa.');
                return;
            }
            const anexoInput = getById('conta-fixa-anexo');
            const files = anexoInput.files;
            let anexos = [];
            if (files.length > 0) {
                try {
                    const filePromises = Array.from(files).map(readFileAsDataURL);
                    anexos = await Promise.all(filePromises);
                } catch (error) { console.error("Erro ao ler arquivos:", error); showToast('Houve um erro ao processar os anexos.'); return; }
            }
            const tipoRecorrencia = getById('conta-fixa-tipo-recorrencia').value;
            const dataInicio = getById('conta-fixa-data-inicio').value;
            const numParcelas = parseInt(getById('conta-fixa-num-parcelas').value);
            if (tipoRecorrencia === 'parcelada' && (!dataInicio || isNaN(numParcelas) || numParcelas < 1)) {
                showToast('Para contas parceladas, preencha o M√™s de In√≠cio e um N¬∫ de Parcelas v√°lido.');
                return;
            }
            state.contasFixas.push({
                id: Date.now().toString(),
                descricao: getById('conta-fixa-descricao').value,
                valor: parseFloat(getById('conta-fixa-valor').value),
                diaVencimento: parseInt(getById('conta-fixa-dia-vencimento').value),
                categoria: categoria,
                anexos: anexos,
                tipoRecorrencia: tipoRecorrencia,
                dataInicio: tipoRecorrencia === 'parcelada' ? dataInicio : null,
                numParcelas: tipoRecorrencia === 'parcelada' ? numParcelas : null
            });
            e.target.reset();
            parcelamentoContainer.classList.add('hidden');
            renderAll();
            showToast('Conta fixa cadastrada com sucesso!', false);
        });
        
        // --- SE√á√ÉO MONITORES ---
        const setupFileInput = (inputId, previewId) => {
            getById(inputId).addEventListener('change', (e) => {
                const file = e.target.files[0];
                const preview = getById(previewId);
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { preview.src = event.target.result; };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = `https://placehold.co/128x128/e0e0e0/757575?text=${previewId.includes('perfil') ? 'Perfil' : 'Doc'}`;
                }
            });
        };
        setupFileInput('cadastro-monitor-perfil-foto', 'perfil-foto-preview');
        setupFileInput('cadastro-monitor-doc-foto', 'doc-foto-preview');

        const cnhSelect = getById('cadastro-monitor-cnh');
        const cnhCategoriaWrapper = getById('cadastro-monitor-cnh-categoria-wrapper');
        cnhSelect.addEventListener('change', () => {
            cnhCategoriaWrapper.classList.toggle('hidden', cnhSelect.value !== 'sim');
        });

        getById('form-cadastro-monitor').addEventListener('submit', e => { 
            e.preventDefault(); 
            const perfilFotoSrc = getById('perfil-foto-preview').src;
            const docFotoSrc = getById('doc-foto-preview').src;
            const hasCnh = getById('cadastro-monitor-cnh').value === 'sim';
            state.monitores.push({ 
                id: Date.now().toString(), 
                nome: getById('cadastro-monitor-nome').value, 
                nascimento: getById('cadastro-monitor-nascimento').value, 
                telefone: getById('cadastro-monitor-telefone').value,
                email: getById('cadastro-monitor-email').value,
                endereco: getById('cadastro-monitor-endereco').value, 
                observacoes: getById('cadastro-monitor-observacoes').value,
                cnh: hasCnh, 
                cnhCategoria: hasCnh ? getById('cadastro-monitor-cnh-categoria').value : '',
                fotoPerfil: perfilFotoSrc.startsWith('data:image') ? perfilFotoSrc : null,
                fotoDocumento: docFotoSrc.startsWith('data:image') ? docFotoSrc : null,
                desempenho: [],
                habilidades: {
                    forca: parseFloat(getById('habilidade-forca').value),
                    agilidade: parseFloat(getById('habilidade-agilidade').value),
                    proatividade: parseFloat(getById('habilidade-proatividade').value),
                    comunicacao: parseFloat(getById('habilidade-comunicacao').value),
                    disponibilidade: parseFloat(getById('habilidade-disponibilidade').value),
                    respeito: parseFloat(getById('habilidade-respeito').value)
                }
            }); 
            e.target.reset(); 
            getById('perfil-foto-preview').src = 'https://placehold.co/128x128/e0e0e0/757575?text=Perfil';
            getById('doc-foto-preview').src = 'https://placehold.co/128x128/e0e0e0/757575?text=Doc';
            cnhCategoriaWrapper.classList.add('hidden');
            hideModal(getById('add-monitor-modal'));
            renderAll(); 
            showToast('Monitor cadastrado!', false); 
        });
        
        const diariaSelect = getById('pagamento-monitor-diaria');
        const diariaOutroWrapper = getById('pagamento-monitor-diaria-outro-wrapper');
        diariaSelect.addEventListener('change', () => {
            diariaOutroWrapper.classList.toggle('hidden', diariaSelect.value !== 'outro');
            if (diariaSelect.value === 'outro') {
                getById('pagamento-monitor-diaria-outro').focus();
            }
        });

        const motoristaCheckbox = getById('pagamento-monitor-motorista'); const motoristaFields = getById('motorista-adicional-fields'); const eventosInput = getById('pagamento-monitor-eventos'); const adicionalDisplay = getById('valor-adicional-motorista');
        motoristaCheckbox.addEventListener('change', () => { motoristaFields.classList.toggle('hidden', !motoristaCheckbox.checked); if (!motoristaCheckbox.checked) { eventosInput.value = '0'; adicionalDisplay.textContent = formatarMoeda(0); } });
        eventosInput.addEventListener('input', () => { const eventos = parseFloat(eventosInput.value) || 0; adicionalDisplay.textContent = formatarMoeda(eventos * 20); });
        
        getById('form-pagamento-monitor').addEventListener('submit', e => { 
            e.preventDefault(); 
            const monitorId = getById('monitor-select').value; 
            if (!monitorId) { showToast('Por favor, selecione um monitor.'); return; } 
            const data = getById('pagamento-monitor-data').value; 
            if (!data) { showToast('Por favor, selecione a data do evento.'); return; } 
            
            const monitor = state.monitores.find(m => m.id === monitorId); 
            let valorDiaria;
            if (diariaSelect.value === 'outro') {
                valorDiaria = parseFloat(getById('pagamento-monitor-diaria-outro').value);
                if (isNaN(valorDiaria) || valorDiaria <= 0) { showToast('Por favor, insira um valor de di√°ria personalizado v√°lido.'); return; }
            } else {
                valorDiaria = parseFloat(diariaSelect.value);
            }
            
            const horaEntrada = getById('pagamento-monitor-entrada').value;
            const horaSaida = getById('pagamento-monitor-saida').value;
            let horasExtrasValor = 0;
            if(horaEntrada && horaSaida){
                let entrada = new Date(`1970-01-01T${horaEntrada}:00`);
                let saida = new Date(`1970-01-01T${horaSaida}:00`);
                if (saida < entrada) saida.setDate(saida.getDate() + 1);
                const diffMilissegundos = saida - entrada;
                const horasTrabalhadas = diffMilissegundos / (1000 * 60 * 60);
                if (horasTrabalhadas > 11) {
                    const horasExtras = horasTrabalhadas - 11;
                    const valorHora = valorDiaria / 10;
                    horasExtrasValor = horasExtras * valorHora;
                }
            }

            const foiMotorista = getById('pagamento-monitor-motorista').checked; 
            const eventosEntregues = foiMotorista ? (parseFloat(getById('pagamento-monitor-eventos').value) || 0) : 0; 
            const adicionalMotorista = eventosEntregues * 20; 
            const pagamentoTotal = valorDiaria + adicionalMotorista + horasExtrasValor; 
            const pagamentoId = Date.now().toString();
            const statusPagamento = getById('pagamento-monitor-status').value;
            
            state.pagamentosMonitores.push({ id: pagamentoId, monitorId: monitor.id, nome: monitor.nome, data: data, valorBase: valorDiaria, adicional: adicionalMotorista, horasExtras: horasExtrasValor, pagamento: pagamentoTotal, horaEntrada: horaEntrada, horaSaida: horaSaida, statusPagamento: statusPagamento }); 
            
            // Salvar Avalia√ß√£o
            const descricao = getById('pagamento-nota-descricao').value;
            const nota = getById('pagamento-nota-calculada').textContent;
            const obs = getById('pagamento-nota-obs').value;
            const detalhesAvaliacao = {};
            checklistItems.forEach(item => {
                const radioChecked = document.querySelector(`input[name="pagamento-${item.name}"]:checked`);
                detalhesAvaliacao[item.name] = { label: item.label, pontosGanhos: parseFloat(radioChecked.value), pontosMax: item.points };
            });
            if (!descricao) { showToast("Preencha a Descri√ß√£o do Evento para salvar a avalia√ß√£o."); return; }
            monitor.desempenho.push({ id: Date.now().toString(), pagamentoId: pagamentoId, data, descricao, nota, obs, detalhes: detalhesAvaliacao });
            monitor.desempenho.sort((a,b) => new Date(b.data) - new Date(a.data));
            e.target.reset(); 
            diariaOutroWrapper.classList.add('hidden');
            motoristaCheckbox.checked = false; 
            motoristaFields.classList.add('hidden'); 
            eventosInput.value = '0'; 
            adicionalDisplay.textContent = formatarMoeda(0); 
            getById('pagamento-monitor-data').value = new Date().toISOString().split('T')[0];
            getById('pagamento-avaliacao-container').classList.add('hidden');
            renderAll(); 
            showToast('Pagamento e Avalia√ß√£o salvos!', false); 
        });

        const avaliacaoContainer = getById('pagamento-avaliacao-container');
        getById('monitor-select').addEventListener('change', (e) => {
            avaliacaoContainer.classList.toggle('hidden', !e.target.value);
        });

        // --- L√ìGICA DE LAN√áAMENTO DE SAL√ÅRIO (ATUALIZADA) ---
        getById('salario-funcionario-select').addEventListener('change', renderSalarios);
        
        getById('btn-lancar-salario').addEventListener('click', () => {
            const selectedEmployeeId = getById('salario-funcionario-select').value;
            if (!selectedEmployeeId) {
                showToast('Selecione um funcion√°rio para lan√ßar o sal√°rio.');
                return;
            }
            const funcionario = state.funcionarios.find(f => f.id === selectedEmployeeId);
            if (!funcionario) return;

            const idSalarioLancado = `salario-${funcionario.id}-${state.selectedMonth}`;
            if (state.gastos.some(g => g.id === idSalarioLancado)) {
                showToast('Este sal√°rio j√° foi lan√ßado para este funcion√°rio neste m√™s.');
                return;
            }
            if (state.contas.length === 0) {
                showToast('Cadastre uma "Conta de Sa√≠da" na aba "Gastos" para poder lan√ßar o sal√°rio.');
                return;
            }

            const filteredEventos = getFilteredData('eventos');
            const totalEntradas = filteredEventos.reduce((acc, ev) => acc + ev.valor, 0);
            const { comissao } = calcularComissao(totalEntradas);
            const totalPagar = (funcionario.salarioFixo || 0) + (funcionario.va || 0) + (funcionario.vt || 0) + comissao;
            const contaSaida = state.contas[0];
            const [year, month] = state.selectedMonth.split('-').map(Number);
            const ultimoDiaDoMes = new Date(year, month, 0).getDate();
            const dataLancamento = `${state.selectedMonth}-${String(ultimoDiaDoMes).padStart(2, '0')}`;
            
            // Categoria Sal√°rios
            const catSalarios = state.contaFixaCategorias.find(c => c.nome.toLowerCase() === 'sal√°rios');
            if (!catSalarios) {
                showToast('Categoria "Sal√°rios" n√£o encontrada. Adicione-a em "Contas Fixas" > "Gerenciamento de Categorias".');
                return;
            }

            state.gastos.push({
                id: idSalarioLancado,
                data: dataLancamento,
                descricao: `Pagamento Sal√°rio ${funcionario.nome} - M√™s ${formatarMesAno(state.selectedMonth)}`,
                categoria: catSalarios.nome, // Usa a categoria din√¢mica
                contaId: contaSaida.id,
                conta: contaSaida.nome,
                pagamento: 'Transfer√™ncia',
                valor: totalPagar,
                comprovantes: [],
                isSalario: true,
                funcionarioId: funcionario.id // Link para o funcion√°rio
            });
            showToast('Sal√°rio lan√ßado como despesa com sucesso!', false);
            renderAll();
        });
        
        // --- L√ìGICA DE DELETAR, EDITAR E VISUALIZAR ---
        window.handleDelete = (id, tipo) => { 
            if (confirm(`Tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.`)) { 
                if (tipo === 'monitores' && state.pagamentosMonitores.some(p => p.monitorId === id)) { showToast('Este monitor n√£o pode ser exclu√≠do pois possui pagamentos registrados.'); return; } 
                if (tipo === 'contas' && state.gastos.some(g => g.contaId === id)) { showToast('Esta conta n√£o pode ser exclu√≠da pois est√° em uso em um ou mais gastos.'); return; }
                if (tipo === 'contasFixas' && state.gastos.some(g => g.contaFixaId === id)) { showToast('Esta conta n√£o pode ser exclu√≠da pois j√° existem gastos lan√ßados a partir dela.'); return; }
                if (tipo === 'funcionarios' && state.gastos.some(g => g.funcionarioId === id)) { showToast('Este funcion√°rio n√£o pode ser exclu√≠do pois possui sal√°rios lan√ßados.'); return; }
                
                // Verifica√ß√£o de Categoria de Gasto
                if (tipo === 'gastoCategorias') {
                    const item = state.gastoCategorias.find(i => i.id === id);
                    if (item && state.gastos.some(g => g.categoria === item.nome)) {
                        showToast('Esta categoria n√£o pode ser exclu√≠da pois est√° em uso em um ou mais gastos.'); return;
                    }
                }
                // Verifica√ß√£o de Categoria de Conta Fixa
                if (tipo === 'contaFixaCategorias') {
                    const item = state.contaFixaCategorias.find(i => i.id === id);
                    if (item && (state.contasFixas.some(cf => cf.categoria === item.nome) || state.gastos.some(g => g.categoria === item.nome))) {
                        showToast('Esta categoria n√£o pode ser exclu√≠da pois est√° em uso.'); return;
                    }
                }
                
                if (tipo === 'pagamentosMonitores') {
                    const pag = state.pagamentosMonitores.find(p => p.id === id);
                    if (pag) {
                        const monitor = state.monitores.find(m => m.id === pag.monitorId);
                        if (monitor) monitor.desempenho = monitor.desempenho.filter(d => d.pagamentoId !== id);
                    }
                }
                state[tipo] = state[tipo].filter(item => item.id !== id); 
                renderAll(); 
                showToast('Item exclu√≠do com sucesso!', false);
            } 
        };
        
        window.deleteFaixaComissao = (id) => {
             if (confirm(`Tem certeza que deseja excluir esta faixa de comiss√£o?`)) { 
                state.faixasComissao = state.faixasComissao.filter(f => f.id !== id);
                renderAll();
                showToast('Faixa de comiss√£o exclu√≠da!', false);
             }
        };

        const editModal = getById('edit-modal'); const modalForm = getById('modal-form'); const modalContent = getById('modal-form-content');
        const monitorDetailsModal = getById('monitor-details-modal'); const monitorDetailsBody = getById('monitor-details-body');
        const monitorDetailsTitle = getById('monitor-details-title');
        const hideModal = (modalEl) => modalEl.classList.add('hidden');
        const showModal = (modalEl) => modalEl.classList.remove('hidden');

        window.openAttachmentViewer = (itemId, type) => {
            let item; let attachments = []; let titleText = 'Anexos';
            if (type === 'contasFixas') { item = state.contasFixas.find(cf => cf.id === itemId); attachments = item?.anexos || []; titleText = `Anexos de "${item.descricao}"`; } 
            else if (type === 'gastos') { item = state.gastos.find(g => g.id === itemId); attachments = item?.comprovantes || []; titleText = `Comprovantes de "${item.descricao}"`; }
            if (!item || attachments.length === 0) { showToast('Nenhum anexo encontrado.'); return; }
            const modal = getById('attachment-viewer-modal'); const title = getById('attachment-viewer-title'); const content = getById('attachment-viewer-content');
            title.textContent = titleText; content.innerHTML = '';
            attachments.forEach(file => {
                const fileCard = document.createElement('div');
                fileCard.className = 'bg-white rounded-lg p-2 shadow flex flex-col items-center justify-center text-center border';
                let previewHtml = '';
                if (file.type.startsWith('image/')) { previewHtml = `<img src="${file.data}" alt="${file.name}" class="w-full h-32 object-contain mb-2 rounded cursor-pointer" onclick="window.open('${file.data}')">`; } 
                else if (file.type === 'application/pdf') { previewHtml = `<a href="${file.data}" target="_blank" class="w-full h-32 flex items-center justify-center bg-gray-100 rounded mb-2"><i class="fa-solid fa-file-pdf text-5xl text-red-500"></i></a>`; } 
                else { previewHtml = `<div class="w-full h-32 flex items-center justify-center bg-gray-100 rounded mb-2"><i class="fa-solid fa-file-lines text-5xl text-gray-500"></i></div>`; }
                fileCard.innerHTML = `${previewHtml} <p class="text-xs font-semibold break-all w-full truncate my-2" title="${file.name}">${file.name}</p> <a href="${file.data}" download="${file.name}" class="text-sm shiny-btn text-white font-bold py-1 px-3 rounded-md w-full text-center" style="font-size: 0.8rem;">Baixar</a>`;
                content.appendChild(fileCard);
            });
            showModal(modal);
        };

        window.handleView = (id, tipo) => {
            if (tipo !== 'monitores') return;
            const monitor = state.monitores.find(m => m.id === id);
            if (!monitor) return;
            monitorDetailsTitle.textContent = `Detalhes de ${monitor.nome.split(' ')[0]}`;
            const notasHtml = monitor.desempenho && monitor.desempenho.length > 0
                ? monitor.desempenho.map(nota => {
                    const scoreColors = getScoreColor(parseFloat(nota.nota));
                    let detalhesHtml = '';
                    if (nota.detalhes) {
                        detalhesHtml = `<details class="mt-2 text-xs"><summary class="cursor-pointer text-indigo-600 font-semibold">Ver crit√©rios de avalia√ß√£o</summary><ul class="mt-1 pl-2 border-l-2 border-indigo-100">
                                    ${Object.values(nota.detalhes).map(detalhe => `<li class="flex justify-between items-center py-0.5"><span>${detalhe.label}:</span><span class="font-medium ${detalhe.pontosGanhos > 0 ? 'text-green-600' : 'text-red-600'}">${detalhe.pontosGanhos > 0 ? 'Sim' : 'N√£o'} (${detalhe.pontosGanhos.toFixed(1)} / ${detalhe.pontosMax.toFixed(1)} pts)</span></li>`).join('')}
                                </ul></details>`;
                    }
                    return `<li class="p-3 bg-gray-50 rounded-md border border-gray-200/60"><div class="flex justify-between items-start">
                                <div><p class="font-semibold text-gray-800">${nota.descricao || 'Nota de Desempenho'}</p><p class="text-sm text-gray-500">${formatarData(nota.data)} - Nota: <span class="font-bold px-1.5 py-0.5 rounded-full ${scoreColors.bg} ${scoreColors.text}">${parseFloat(nota.nota).toFixed(1)}</span></p><p class="text-sm text-gray-700 mt-1">${nota.obs || ''}</p>${detalhesHtml}</div>
                                <button class="action-btn delete-btn ml-4" onclick="excluirNotaDesempenho('${id}', '${nota.id}')" title="Excluir nota"><i class="fa-solid fa-trash-can"></i></button>
                            </div></li>`
                }).join('')
                : '<p class="text-sm text-gray-500 text-center p-4">Nenhum hist√≥rico de desempenho registrado.</p>';
            const whatsappNumber = monitor.telefone.replace(/\D/g, '');
            const whatsappLink = whatsappNumber ? `https://wa.me/55${whatsappNumber}` : '#';
            const cnhText = monitor.cnh ? `Possui CNH (Cat. ${monitor.cnhCategoria || 'N/A'})` : 'N√£o possui CNH';
            monitorDetailsBody.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-2 space-y-4"><div class="flex flex-col items-center"><img src="${monitor.fotoPerfil || 'https://placehold.co/128x128/e0e0e0/757575?text=Perfil'}" class="w-32 h-32 object-cover rounded-full border-2 border-indigo-200 p-1 mb-4" alt="Foto de ${monitor.nome}"><h3 class="text-xl font-bold text-gray-800 text-center">${monitor.nome}</h3><p class="text-sm text-gray-500">${cnhText}</p></div><div><p class="text-xs font-medium text-gray-500">Contato</p><p class="text-gray-800 flex items-center"><i class="fa-solid fa-phone w-4 mr-2 text-gray-400"></i>${monitor.telefone || 'N√£o informado'}</p>${whatsappNumber ? `<a href="${whatsappLink}" target="_blank" class="text-sm inline-flex items-center text-green-600 hover:text-green-800 font-semibold mt-1"><i class="fa-brands fa-whatsapp mr-2"></i>Enviar Mensagem</a>` : ''}<p class="text-gray-800 flex items-center mt-2"><i class="fa-solid fa-envelope w-4 mr-2 text-gray-400"></i>${monitor.email || 'N√£o informado'}</p></div><div><p class="text-xs font-medium text-gray-500">Endere√ßo</p><p class="text-gray-800">${monitor.endereco || 'N√£o informado'}</p></div><div><p class="text-xs font-medium text-gray-500">Observa√ß√µes</p><p class="text-gray-800 whitespace-pre-wrap">${monitor.observacoes || 'Nenhuma observa√ß√£o.'}</p></div><details class="bg-gray-50 rounded border"><summary class="p-2 cursor-pointer font-semibold text-sm text-gray-700">Ver Documento</summary><div class="p-2">${monitor.fotoDocumento ? `<img src="${monitor.fotoDocumento}" class="w-full rounded-md border p-1" alt="Documento de ${monitor.nome}">` : '<p class="text-gray-800 text-sm">Nenhum documento salvo.</p>'}</div></details></div><div class="lg:col-span-3"><div class="flex justify-between items-center mb-2"><h4 class="text-lg font-bold text-gray-800">Mapa de Habilidades</h4><button class="action-btn edit-btn" onclick="handleEdit('${id}', 'habilidades')" title="Editar Habilidades"><i class="fa-solid fa-pencil"></i></button></div><div class="w-full h-64 md:h-80"><canvas id="radar-chart"></canvas></div><div class="border-t border-gray-200 mt-6 pt-4"><h4 class="text-lg font-bold text-gray-800 mb-3">Hist√≥rico de Desempenho</h4><ul class="space-y-3 max-h-48 overflow-y-auto pr-2">${notasHtml}</ul></div></div></div>`;
            const ctx = getById('radar-chart').getContext('2d');
            if (radarChartInstance) { radarChartInstance.destroy(); }
            radarChartInstance = new Chart(ctx, { type: 'radar', data: { labels: ['For√ßa', 'Agilidade', 'Proatividade', 'Comunica√ß√£o', 'Disponibilidade', 'Respeito'], datasets: [{ label: 'Pontua√ß√£o', data: Object.values(monitor.habilidades), fill: true, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgb(79, 70, 229)', pointBackgroundColor: 'rgb(79, 70, 229)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(79, 70, 229)' }] }, options: { maintainAspectRatio: false, scales: { r: { angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, pointLabels: { font: { size: 12, weight: 'bold' } }, suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2, backdropColor: 'rgba(255, 255, 255, 0.6)'} } }, plugins: { legend: { display: false } } } });
            showModal(monitorDetailsModal);
        };
        
        window.excluirNotaDesempenho = (monitorId, notaId) => {
             if (confirm("Tem certeza que deseja excluir esta nota de desempenho?")) {
                const monitor = state.monitores.find(m => m.id === monitorId);
                if (!monitor) return;
                monitor.desempenho = monitor.desempenho.filter(n => n.id !== notaId);
                saveData();
                showToast("Nota exclu√≠da!", false);
                handleView(monitorId, 'monitores');
                renderAll(); 
             }
        };

        window.handleEdit = (id, tipo) => {
            const item = (tipo === 'habilidades' || tipo === 'monitores') 
                ? state.monitores.find(i => i.id === id) 
                : (tipo === 'funcionarios')
                    ? state.funcionarios.find(i => i.id === id)
                    : state[tipo].find(i => i.id === id);
            
            if(!item) return;
            if (item.isSalario) { showToast("Lan√ßamentos de sal√°rio n√£o podem ser editados, apenas exclu√≠dos."); return; }
            if(item.isSynced) { window.location.href = `./Agenda de eventos.html?editEvent=${item.id.replace('agenda-', '')}`; return; }
            
            let formHtml = '';
            getById('modal-title').textContent = `Editar ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
            const createFormGroup = (label, input) => `<div class="w-full"><label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>${input}</div>`;
            
            if (tipo === 'eventos') { formHtml = createFormGroup('Data', `<input type="date" id="edit-data" value="${dataParaInput(item.data)}" class="form-input w-full">`) + createFormGroup('Empresa', `<select id="edit-empresa" class="form-input w-full"><option>Aero Festas</option><option>ABC Festas</option></select>`) + createFormGroup('Contratante', `<input type="text" id="edit-contratante" value="${item.contratante}" class="form-input w-full">`) + createFormGroup('Local', `<input type="text" id="edit-local" value="${item.local}" class="form-input w-full">`) + `<p class="sm:col-span-2 text-sm text-gray-500">Obs: Itens e valores n√£o podem ser editados aqui.</p>`; }
            else if (tipo === 'gastos') { 
                const contasOptions = state.contas.map(c => `<option value="${c.id}" ${c.id === item.contaId ? 'selected' : ''}>${c.nome}</option>`).join(''); 
                const gastoCatOptions = state.gastoCategorias.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                formHtml = createFormGroup('Data', `<input type="date" id="edit-data" value="${dataParaInput(item.data)}" class="form-input w-full">`) + 
                           createFormGroup('Descri√ß√£o', `<input type="text" id="edit-descricao" value="${item.descricao}" class="form-input w-full">`) + 
                           createFormGroup('Categoria', `<select id="edit-categoria" class="form-input w-full">${gastoCatOptions}</select>`) + 
                           createFormGroup('Conta', `<select id="edit-conta" class="form-input w-full">${contasOptions}</select>`) + 
                           createFormGroup('Pagamento', `<select id="edit-pagamento" class="form-input w-full"><option>PIX</option><option>Cart√£o de Cr√©dito</option><option>Dinheiro</option><option>Boleto</option></select>`) + 
                           createFormGroup('Valor', `<input type="number" id="edit-valor" value="${item.valor}" class="form-input w-full">`); 
            }
            else if (tipo === 'monitores') { formHtml = createFormGroup('Nome', `<input type="text" id="edit-nome" value="${item.nome}" class="form-input w-full">`) + createFormGroup('Nascimento', `<input type="date" id="edit-nascimento" value="${dataParaInput(item.nascimento)}" class="form-input w-full">`) + createFormGroup('Endere√ßo', `<input type="text" id="edit-endereco" value="${item.endereco || ''}" class="form-input w-full">`) + createFormGroup('Telefone', `<input type="tel" id="edit-telefone" value="${item.telefone || ''}" class="form-input w-full">`) + createFormGroup('Email', `<input type="email" id="edit-email" value="${item.email || ''}" class="form-input w-full">`) + createFormGroup('Possui CNH?', `<select id="edit-cnh" class="form-input w-full"><option value="nao">N√£o</option><option value="sim">Sim</option></select>`) + `<div id="edit-cnh-categoria-wrapper" class="${item.cnh ? '' : 'hidden'}">${createFormGroup('Categoria CNH', `<input type="text" id="edit-cnh-categoria" value="${item.cnhCategoria || ''}" class="form-input w-full" placeholder="Ex: AB">`)}</div>` + createFormGroup('Observa√ß√µes', `<textarea id="edit-observacoes" class="form-input w-full" rows="3">${item.observacoes || ''}</textarea>`) + `<p class="sm:col-span-2 text-sm text-gray-500">Para alterar as fotos, cadastre o monitor novamente.</p>`; }
            else if (tipo === 'habilidades') { formHtml = Object.keys(item.habilidades).map(key => createFormGroup(key.charAt(0).toUpperCase() + key.slice(1), `<input type="range" id="edit-habilidade-${key}" value="${item.habilidades[key]}" min="0" max="10" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><span id="edit-habilidade-${key}-val" class="text-sm font-bold text-indigo-600">${item.habilidades[key]}</span>`)).join(''); }
            else if (tipo === 'pagamentosMonitores') { const eventosEntregues = (item.adicional || 0) / 20; formHtml = createFormGroup('Data', `<input type="date" id="edit-data" value="${dataParaInput(item.data)}" class="form-input w-full">`) + createFormGroup('Valor Base', `<select id="edit-valorBase" class="form-input w-full"><option value="80">R$ 80</option><option value="90">R$ 90</option><option value="100">R$ 100</option><option value="120">R$ 120</option></select>`) + createFormGroup('Eventos Entregues (Motorista)', `<input type="number" id="edit-adicionalEventos" value="${eventosEntregues}" min="0" step="0.1" class="form-input w-full">`) + createFormGroup('Hora Entrada', `<input type="time" id="edit-horaEntrada" value="${item.horaEntrada || ''}" class="form-input w-full">`) + createFormGroup('Hora Sa√≠da', `<input type="time" id="edit-horaSaida" value="${item.horaSaida || ''}" class="form-input w-full">`) + createFormGroup('Status Pagamento', `<select id="edit-statusPagamento" class="form-input w-full"><option value="Executado">Executado</option><option value="Pendente">Pendente</option></select>`) + `<p class="sm:col-span-2 text-sm text-gray-500">O valor total ser√° recalculado. Deixe 'Eventos Entregues' como 0 se n√£o foi motorista.</p>`; }
            else if (tipo === 'contas') { formHtml = createFormGroup('Nome da Conta', `<input type="text" id="edit-conta-nome" value="${item.nome}" class="form-input w-full">`) + createFormGroup('Institui√ß√£o/Banco', `<input type="text" id="edit-conta-banco" value="${item.banco}" class="form-input w-full">`) + createFormGroup('Tipo de Conta', `<select id="edit-conta-tipo" class="form-input w-full"><option>Conta Corrente</option><option>Conta Poupan√ßa</option><option>Conta de Pagamentos</option><option>Outros</option></select>`) + createFormGroup('Ag√™ncia', `<input type="text" id="edit-conta-agencia" value="${item.agencia || ''}" class="form-input w-full">`) + createFormGroup('N¬∫ da Conta', `<input type="text" id="edit-conta-numero" value="${item.numero || ''}" class="form-input w-full">`); }
            else if (tipo === 'funcionarios') { formHtml = createFormGroup('Nome', `<input type="text" id="edit-func-nome" value="${item.nome}" class="form-input w-full">`) + createFormGroup('Sal√°rio Fixo (R$)', `<input type="number" id="edit-func-salario" value="${item.salarioFixo}" step="0.01" class="form-input w-full">`) + createFormGroup('Vale Alimenta√ß√£o (R$)', `<input type="number" id="edit-func-va" value="${item.va}" step="0.01" class="form-input w-full">`) + createFormGroup('Vale Transporte (R$)', `<input type="number" id="edit-func-vt" value="${item.vt}" step="0.01" class="form-input w-full">`); }
            else if (tipo === 'contasFixas') {
                const cfCatOptions = state.contaFixaCategorias.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                let parcelamentoHtml = `<div class="sm:col-span-2"><label for="edit-cf-tipo-recorrencia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Recorr√™ncia</label><select id="edit-cf-tipo-recorrencia" class="form-input w-full"><option value="permanente">Permanente (Cont√≠nua)</option><option value="parcelada">Parcelada (Com Fim)</option></select></div><div id="edit-cf-parcelamento-container" class="hidden sm:col-span-2 grid grid-cols-2 gap-4 items-end"><div><label for="edit-cf-data-inicio" class="block text-sm font-medium text-gray-700 mb-1">M√™s de In√≠cio</label><input type="month" id="edit-cf-data-inicio" value="${item.dataInicio || ''}" class="form-input w-full"></div><div><label for="edit-cf-num-parcelas" class="block text-sm font-medium text-gray-700 mb-1">N¬∫ de Parcelas</label><input type="number" id="edit-cf-num-parcelas" value="${item.numParcelas || ''}" min="1" step="1" class="form-input w-full"></div></div>`;
                let anexoHtml = `<div class="sm:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Adicionar Novos Anexos</label><input type="file" id="edit-cf-anexo" multiple class="form-input w-full text-sm file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>`;
                if (item.anexos && item.anexos.length > 0) {
                    anexoHtml += `<div class="sm:col-span-2 mt-2"><p class="text-sm font-medium text-gray-700 mb-1">Anexos Atuais</p><ul class="space-y-1 text-sm">`;
                    item.anexos.forEach((anexo, index) => { anexoHtml += `<li class="flex justify-between items-center bg-gray-100 p-1 rounded"><span class="truncate" title="${anexo.name}">${anexo.name}</span><label class="flex items-center text-red-600 cursor-pointer"><input type="checkbox" value="${index}" class="remove-anexo-checkbox h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"><span class="ml-1">Remover</span></label></li>`; });
                    anexoHtml += `</ul></div>`;
                }
                formHtml = createFormGroup('Descri√ß√£o', `<input type="text" id="edit-cf-descricao" value="${item.descricao}" class="form-input w-full">`) + 
                           createFormGroup('Valor', `<input type="number" id="edit-cf-valor" value="${item.valor}" step="0.01" class="form-input w-full">`) + 
                           createFormGroup('Dia Vencimento', `<input type="number" id="edit-cf-dia" value="${item.diaVencimento}" min="1" max="31" class="form-input w-full">`) + 
                           createFormGroup('Categoria', `<select id="edit-cf-categoria" class="form-input w-full">${cfCatOptions}</select>`) + 
                           parcelamentoHtml + anexoHtml; 
            }
            modalContent.innerHTML = formHtml;
            
            // Define os valores dos selects e adiciona listeners
            if (tipo === 'eventos') getById('edit-empresa').value = item.empresa; 
            if (tipo === 'gastos') { getById('edit-categoria').value = item.categoria; getById('edit-pagamento').value = item.pagamento; }
            if (tipo === 'contas') { getById('edit-conta-tipo').value = item.tipo; }
            if (tipo === 'contasFixas') { 
                getById('edit-cf-categoria').value = item.categoria; 
                const editTipoRec = getById('edit-cf-tipo-recorrencia');
                const editParcelContainer = getById('edit-cf-parcelamento-container');
                const tipoRec = item.tipoRecorrencia || 'permanente';
                editTipoRec.value = tipoRec;
                const toggleEditParcelContainer = () => {
                    const isParcelada = editTipoRec.value === 'parcelada';
                    editParcelContainer.classList.toggle('hidden', !isParcelada);
                    getById('edit-cf-data-inicio').required = isParcelada;
                    getById('edit-cf-num-parcelas').required = isParcelada;
                };
                toggleEditParcelContainer();
                editTipoRec.addEventListener('change', toggleEditParcelContainer);
            }
            if (tipo === 'monitores') { 
                getById('edit-cnh').value = item.cnh ? 'sim' : 'nao'; 
                const editCnhSelect = getById('edit-cnh');
                const editCnhCategoriaWrapper = getById('edit-cnh-categoria-wrapper');
                editCnhSelect.addEventListener('change', () => {
                    editCnhCategoriaWrapper.classList.toggle('hidden', editCnhSelect.value !== 'sim');
                });
            }
            if (tipo === 'pagamentosMonitores') { getById('edit-valorBase').value = item.valorBase; getById('edit-statusPagamento').value = item.statusPagamento || 'Executado'; }
            if (tipo === 'habilidades') {
                Object.keys(item.habilidades).forEach(key => {
                    const slider = getById(`edit-habilidade-${key}`);
                    const display = getById(`edit-habilidade-${key}-val`);
                    slider.addEventListener('input', () => { display.textContent = slider.value; });
                });
            }

            modalForm.onsubmit = async e => {
                e.preventDefault();
                let index = -1;
                
                if (tipo === 'habilidades' || tipo === 'monitores') { index = state.monitores.findIndex(i => i.id === id); }
                else if (tipo === 'funcionarios') { index = state.funcionarios.findIndex(i => i.id === id); }
                else { index = state[tipo].findIndex(i => i.id === id); }
                
                if (index === -1) { hideModal(editModal); return; }

                if (tipo === 'eventos') { 
                    Object.assign(state.eventos[index], { data: getById('edit-data').value, empresa: getById('edit-empresa').value, contratante: getById('edit-contratante').value, local: getById('edit-local').value }); 
                } else if (tipo === 'gastos') { 
                    const contaId = getById('edit-conta').value; 
                    const contaSelecionada = state.contas.find(c => c.id === contaId); 
                    Object.assign(state.gastos[index], { data: getById('edit-data').value, descricao: getById('edit-descricao').value, categoria: getById('edit-categoria').value, contaId: contaId, conta: contaSelecionada.nome, pagamento: getById('edit-pagamento').value, valor: parseFloat(getById('edit-valor').value) }); 
                } else if (tipo === 'monitores') {
                    const hasCnh = getById('edit-cnh').value === 'sim';
                    Object.assign(state.monitores[index], { 
                        nome: getById('edit-nome').value, 
                        nascimento: getById('edit-nascimento').value, 
                        endereco: getById('edit-endereco').value,
                        telefone: getById('edit-telefone').value,
                        email: getById('edit-email').value,
                        cnh: hasCnh, 
                        cnhCategoria: hasCnh ? getById('edit-cnh-categoria').value : '',
                        observacoes: getById('edit-observacoes').value
                    });
                    hideModal(monitorDetailsModal); // Esconde o modal de detalhes se estiver aberto
                } else if (tipo === 'habilidades') {
                    Object.keys(item.habilidades).forEach(key => { item.habilidades[key] = parseFloat(getById(`edit-habilidade-${key}`).value); });
                    handleView(id, 'monitores'); // Re-renderiza o modal de detalhes
                } else if (tipo === 'pagamentosMonitores') { 
                    const valorBase = parseFloat(getById('edit-valorBase').value); 
                    const adicionalEventos = parseFloat(getById('edit-adicionalEventos').value) || 0; 
                    const adicional = adicionalEventos * 20; 
                    const horaEntrada = getById('edit-horaEntrada').value; 
                    const horaSaida = getById('edit-horaSaida').value;
                    let horasExtrasValor = 0;
                    if(horaEntrada && horaSaida){
                        let entrada = new Date(`1970-01-01T${horaEntrada}:00`);
                        let saida = new Date(`1970-01-01T${horaSaida}:00`);
                        if (saida < entrada) saida.setDate(saida.getDate() + 1);
                        const diffMilissegundos = saida - entrada;
                        const horasTrabalhadas = diffMilissegundos / (1000 * 60 * 60);
                        if (horasTrabalhadas > 11) {
                            const horasExtras = horasTrabalhadas - 11;
                            const valorHora = valorBase / 10;
                            horasExtrasValor = horasExtras * valorHora;
                        }
                    }
                    const pagamento = valorBase + adicional + horasExtrasValor; 
                    Object.assign(state.pagamentosMonitores[index], { data: getById('edit-data').value, valorBase, adicional, horasExtras: horasExtrasValor, pagamento, horaEntrada, horaSaida, statusPagamento: getById('edit-statusPagamento').value }); 
                } else if (tipo === 'contas') {
                    Object.assign(state.contas[index], { nome: getById('edit-conta-nome').value, banco: getById('edit-conta-banco').value, tipo: getById('edit-conta-tipo').value, agencia: getById('edit-conta-agencia').value, numero: getById('edit-conta-numero').value });
                } else if (tipo === 'funcionarios') {
                    Object.assign(state.funcionarios[index], { 
                        nome: getById('edit-func-nome').value, 
                        salarioFixo: parseFloat(getById('edit-func-salario').value),
                        va: parseFloat(getById('edit-func-va').value),
                        vt: parseFloat(getById('edit-func-vt').value)
                    });
                } else if (tipo === 'contasFixas') {
                    const anexoInput = getById('edit-cf-anexo');
                    const newFiles = anexoInput.files;
                    let newAnexos = [];
                    if (newFiles.length > 0) {
                        try {
                            const filePromises = Array.from(newFiles).map(readFileAsDataURL);
                            newAnexos = await Promise.all(filePromises);
                        } catch (error) { console.error("Erro ao ler arquivos:", error); showToast('Houve um erro ao processar os novos anexos.'); return; }
                    }
                    const anexoIndicesToRemove = Array.from(document.querySelectorAll('.remove-anexo-checkbox:checked')).map(cb => parseInt(cb.value));
                    const anexosAtuais = (item.anexos || []).filter((_, index) => !anexoIndicesToRemove.includes(index));
                    const tipoRecorrencia = getById('edit-cf-tipo-recorrencia').value;
                    const dataInicio = getById('edit-cf-data-inicio').value;
                    const numParcelas = parseInt(getById('edit-cf-num-parcelas').value);
                    if (tipoRecorrencia === 'parcelada' && (!dataInicio || isNaN(numParcelas) || numParcelas < 1)) {
                        showToast('Para contas parceladas, preencha o M√™s de In√≠cio e um N¬∫ de Parcelas v√°lido.');
                        return;
                    }
                    Object.assign(state.contasFixas[index], {
                        descricao: getById('edit-cf-descricao').value,
                        valor: parseFloat(getById('edit-cf-valor').value),
                        diaVencimento: parseInt(getById('edit-cf-dia').value),
                        categoria: getById('edit-cf-categoria').value,
                        anexos: [...anexosAtuais, ...newAnexos],
                        tipoRecorrencia: tipoRecorrencia,
                        dataInicio: tipoRecorrencia === 'parcelada' ? dataInicio : null,
                        numParcelas: tipoRecorrencia === 'parcelada' ? numParcelas : null
                    });
                } else if (tipo === 'gastoCategorias' || tipo === 'contaFixaCategorias') {
                    const novoNome = document.getElementById('modal-form-content').querySelector('input').value;
                    const nomeAntigo = item.nome;
                    if (novoNome && novoNome !== nomeAntigo) {
                        // Verifica se o novo nome j√° existe
                        if (state[tipo].some(c => c.nome.toLowerCase() === novoNome.toLowerCase() && c.id !== id)) {
                            showToast('J√° existe uma categoria com esse nome.'); return;
                        }
                        // Atualiza o nome na tabela de categoria
                        item.nome = novoNome;
                        // Atualiza o nome em todas as entradas relacionadas
                        if (tipo === 'gastoCategorias') {
                            state.gastos.forEach(g => { if (g.categoria === nomeAntigo) g.categoria = novoNome; });
                        } else {
                            state.contasFixas.forEach(cf => { if (cf.categoria === nomeAntigo) cf.categoria = novoNome; });
                            state.gastos.forEach(g => { if (g.categoria === nomeAntigo) g.categoria = novoNome; });
                        }
                    }
                }
                
                hideModal(editModal);
                renderAll();
                showToast('Altera√ß√µes salvas com sucesso!', false);
            };
            
            // L√≥gica de edi√ß√£o espec√≠fica para categorias (mais simples)
            if (tipo === 'gastoCategorias' || tipo === 'contaFixaCategorias') {
                getById('modal-title').textContent = `Editar Categoria`;
                formHtml = createFormGroup('Nome da Categoria', `<input type="text" value="${item.nome}" class="form-input w-full">`);
                modalContent.innerHTML = formHtml;
            }
            
            showModal(editModal);
        };
        
        // --- L√ìGICA DE LAN√áAMENTO DE CONTA FIXA ---
        const lancamentoModal = getById('lancamento-conta-fixa-modal');
        const formLancamento = getById('form-lancamento-conta-fixa');
        let contaFixaIdAtual = null;

        window.lancarGastoFixo = (id) => {
            contaFixaIdAtual = id;
            const contaFixa = state.contasFixas.find(cf => cf.id === id);
            if (!contaFixa) return;
            getById('lancamento-cf-descricao').value = contaFixa.descricao;
            getById('lancamento-cf-valor').value = contaFixa.valor;
            getById('lancamento-cf-data').value = new Date().toISOString().split('T')[0];
            showModal(lancamentoModal);
        };

        formLancamento.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!contaFixaIdAtual) return;
            const contaFixa = state.contasFixas.find(cf => cf.id === contaFixaIdAtual);
            const contaId = getById('lancamento-cf-conta').value;
            const contaSelecionada = state.contas.find(c => c.id === contaId);
            if (!contaSelecionada) { showToast('Por favor, selecione uma conta de sa√≠da v√°lida.'); return; }
            
            const anexoInput = getById('lancamento-cf-comprovante');
            const files = anexoInput.files;
            let comprovantes = [];
            if (files.length > 0) {
                try {
                    const filePromises = Array.from(files).map(readFileAsDataURL);
                    comprovantes = await Promise.all(filePromises);
                } catch (error) { console.error("Erro ao ler comprovantes:", error); showToast('Houve um erro ao processar os comprovantes.'); return; }
            }

            state.gastos.push({
                id: Date.now().toString(),
                data: getById('lancamento-cf-data').value,
                descricao: getById('lancamento-cf-descricao').value,
                categoria: contaFixa.categoria,
                contaId: contaSelecionada.id,
                conta: contaSelecionada.nome,
                pagamento: 'Boleto', // Default
                valor: parseFloat(getById('lancamento-cf-valor').value),
                contaFixaId: contaFixaIdAtual,
                comprovantes: comprovantes
            });
            formLancamento.reset();
            hideModal(lancamentoModal);
            renderAll();
            showToast('Conta fixa lan√ßada como gasto!', false);
        });
        
        // --- L√ìGICA DE AVALIA√á√ÉO DO MONITOR ---
        const checklistItems = [
            { name: "forca", label: "Ajudou no Carregamento (For√ßa)", points: 1.5 },
            { name: "agilidade", label: "Ajudou na Montagem (Agilidade)", points: 1.5 },
            { name: "proatividade", label: "Proatividade (Foi al√©m)", points: 2.0 },
            { name: "comunicacao", label: "Comunica√ß√£o (Cliente/Equipe)", points: 2.0 },
            { name: "disponibilidade", label: "Disponibilidade (Atento)", points: 1.5 },
            { name: "respeito", label: "Respeito (Cliente/Equipe/Local)", points: 1.5 }
        ];

        const checklistContainer = getById('pagamento-checklist-container');
        checklistContainer.innerHTML = checklistItems.map(item => `
            <div class="flex justify-between items-center py-1">
                <label for="pagamento-${item.name}" class="text-sm font-medium text-gray-700">${item.label}</label>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-1 cursor-pointer">
                        <input type="radio" name="pagamento-${item.name}" value="${item.points}" class="h-4 w-4 text-indigo-600" checked>
                        <span class="text-sm text-green-600 font-semibold">Sim</span>
                    </label>
                    <label class="flex items-center space-x-1 cursor-pointer">
                        <input type="radio" name="pagamento-${item.name}" value="0.0" class="h-4 w-4 text-indigo-600">
                        <span class="text-sm text-red-600 font-semibold">N√£o</span>
                    </label>
                </div>
            </div>
        `).join('');

        const calcularNota = () => {
            let total = 0;
            checklistItems.forEach(item => {
                const radioChecked = document.querySelector(`input[name="pagamento-${item.name}"]:checked`);
                if (radioChecked) { total += parseFloat(radioChecked.value); }
            });
            getById('pagamento-nota-calculada').textContent = total.toFixed(1);
        };
        document.querySelectorAll('#pagamento-checklist-container input[type="radio"]').forEach(radio => radio.addEventListener('change', calcularNota));
        calcularNota(); // Calcula nota inicial

        // --- L√ìGICA DO MENU DE MONITORES (Sidebar) ---
        const sidebar = getById('monitors-sidebar');
        const toggleBtn = getById('sidebar-toggle-btn');
        const mainContent = getById('monitors-main-content');
        
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
            // Ajusta o 'margin-left' do conte√∫do principal quando o menu est√° recolhido
            mainContent.classList.toggle('ml-[-1.5rem]', sidebar.classList.contains('collapsed'));
        });

        // --- L√ìGICA DOS MODAIS ---
        const openModalButtons = { '#open-entrada-modal-btn': '#add-entrada-modal', '#open-gasto-modal-btn': '#add-gasto-modal', '#add-monitor-btn': '#add-monitor-modal', '#open-salarios-config-modal-btn': '#salarios-config-modal' };
        Object.keys(openModalButtons).forEach(btnId => { const modalId = openModalButtons[btnId]; const btn = document.querySelector(btnId); const modal = document.querySelector(modalId); if(btn && modal) btn.addEventListener('click', () => showModal(modal)); });
        const closeButtons = document.querySelectorAll('.close-btn, .add-monitor-close-btn, .monitor-details-close-btn');
        closeButtons.forEach(btn => { btn.addEventListener('click', (e) => { hideModal(e.target.closest('.fixed')); }); });
        
        // --- L√ìGICA DAS ABAS DO MODAL DE CONFIGURA√á√ÉO DE SAL√ÅRIO ---
        const configTabs = document.querySelectorAll('.config-tab-btn');
        const configTabContents = document.querySelectorAll('.config-tab-content');
        configTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.target;
                configTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                configTabContents.forEach(c => c.classList.toggle('active', c.id === targetId));
            });
        });

        // --- L√ìGICA DOS FORMUL√ÅRIOS DO MODAL DE CONFIGURA√á√ÉO ---
        getById('form-add-funcionario').addEventListener('submit', e => {
            e.preventDefault();
            const nome = getById('funcionario-nome').value;
            const salarioFixo = parseFloat(getById('funcionario-salario').value);
            const va = parseFloat(getById('funcionario-va').value);
            const vt = parseFloat(getById('funcionario-vt').value);

            if (nome && !isNaN(salarioFixo)) {
                state.funcionarios.push({
                    id: `func-${Date.now()}`,
                    nome, salarioFixo, 
                    va: isNaN(va) ? 0 : va,
                    vt: isNaN(vt) ? 0 : vt
                });
                e.target.reset();
                renderAll();
                showToast('Funcion√°rio salvo!', false);
            } else {
                showToast('Preencha pelo menos o Nome e o Sal√°rio Fixo.');
            }
        });
        
        getById('form-add-comissao').addEventListener('submit', e => {
            e.preventDefault();
            const ateValor = parseFloat(getById('comissao-atevalor').value);
            const percentual = parseFloat(getById('comissao-percentual').value);

            if (!isNaN(ateValor) && !isNaN(percentual) && ateValor > 0 && percentual > 0) {
                 if (state.faixasComissao.some(f => f.ateValor === ateValor)) {
                    showToast('J√° existe uma faixa para este valor. Exclua a antiga primeiro.'); return;
                 }
                state.faixasComissao.push({
                    id: `com-${Date.now()}`,
                    ateValor: ateValor,
                    percentual: percentual / 100 // Salva como decimal (ex: 2.5% -> 0.025)
                });
                e.target.reset();
                renderAll();
                showToast('Faixa de comiss√£o salva!', false);
            } else {
                showToast('Valores inv√°lidos. Preencha corretamente.');
            }
        });

        // --- L√ìGICA DA IA (GEMINI) ---
        const API_KEY_STORAGE = 'geminiApiKey';
        let apiKey = localStorage.getItem(API_KEY_STORAGE);
        const apiKeyModal = getById('api-key-modal');
        const settingsBtn = getById('settings-btn');
        const chatFab = getById('chat-fab');
        const chatModal = getById('chat-modal');
        const chatMessages = getById('chat-messages');
        const chatInput = getById('chat-input');
        
        // Ajusta o bot√£o de settings para abrir o modal de API
        settingsBtn.addEventListener('click', () => {
            getById('api-key-input').value = apiKey || '';
            showModal(apiKeyModal);
        });
        getById('save-api-key-btn').addEventListener('click', () => {
            apiKey = getById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem(API_KEY_STORAGE, apiKey);
                hideModal(apiKeyModal);
                showToast('Chave de API salva!', false);
                chatFab.classList.remove('hidden');
            } else {
                showToast('Por favor, insira uma chave v√°lida.');
            }
        });
        getById('cancel-api-key-btn').addEventListener('click', () => hideModal(apiKeyModal));
        
        // Controla visibilidade do FAB
        if (!apiKey) chatFab.classList.add('hidden');
        
        // Abre o Chat
        chatFab.addEventListener('click', () => openChat());
        getById('chat-close-btn').addEventListener('click', () => hideModal(chatModal));
        getById('send-chat-btn').addEventListener('click', handleChatSend);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });

        let currentChatContext = 'dashboard';
        const getContextData = (context) => {
             const [year, month] = state.selectedMonth.split('-').map(Number);
             const dataFormatada = `${String(month).padStart(2, '0')}/${year}`;
             const filteredEventos = getFilteredData('eventos');
             const filteredGastos = getFilteredData('gastos');
             const filteredPagamentos = getFilteredData('pagamentosMonitores');
             const totalReceitas = filteredEventos.reduce((acc, ev) => acc + ev.valor, 0);
             const totalDespesas = filteredGastos.reduce((acc, g) => acc + g.valor, 0) + filteredPagamentos.reduce((acc, p) => acc + p.pagamento, 0);
             const saldo = totalReceitas - totalDespesas;
             
             let contextData = {
                mesSelecionado: dataFormatada,
                receitas: { total: totalReceitas, eventos: filteredEventos.map(e => ({ data: e.data, contratante: e.contratante, valor: e.valor, empresa: e.empresa })) },
                despesas: { total: totalDespesas, gastos: filteredGastos.map(g => ({ data: g.data, descricao: g.descricao, categoria: g.categoria, valor: g.valor })), pagamentos: filteredPagamentos.map(p => ({ data: p.data, monitor: p.nome, valor: p.pagamento })) },
                saldo: saldo
             };
             
             if (context === 'dashboard') {
                return { tipo: "Vis√£o Geral (Dashboard)", ...contextData };
             }
             if (context === 'gastos') {
                const gastosPorCategoria = filteredGastos.reduce((acc, g) => { acc[g.categoria] = (acc[g.categoria] || 0) + g.valor; return acc; }, {});
                return { tipo: "An√°lise de Gastos", mesSelecionado: dataFormatada, totalGastos: filteredGastos.reduce((acc, g) => acc + g.valor, 0), gastosPorCategoria, detalhesGastos: contextData.despesas.gastos };
             }
             return { tipo: "Contexto Desconhecido", ...contextData };
        };

        window.openChat = (context = 'dashboard') => {
            if (!apiKey) { showModal(apiKeyModal); return; }
            currentChatContext = context;
            const data = getContextData(context);
            getById('chat-title').textContent = `Assistente IA - ${data.tipo}`;
            chatMessages.innerHTML = '';
            addChatMessage('model', `Ol√°! Estou pronto para analisar os dados de **${data.tipo}** para o m√™s **${data.mesSelecionado}**. O que voc√™ gostaria de saber?`);
            showModal(chatModal);
        };

        function addChatMessage(role, text) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${role === 'user' ? 'bg-indigo-100 text-indigo-900 self-end' : 'bg-white/80'} p-3 rounded-lg max-w-[85%]`;
            
            // Simples conversor de Markdown
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Negrito
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // It√°lico
            html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-800 text-white p-2 rounded-md my-2 overflow-x-auto"><code>$1</code></pre>'); // Bloco de c√≥digo
            html = html.replace(/`(.*?)`/g, '<code class="bg-gray-200 text-red-600 px-1 rounded">$1</code>'); // C√≥digo inline
            html = html.replace(/\n/g, '<br>'); // Novas linhas
            
            messageEl.innerHTML = html;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

async function handleChatSend() {
            const prompt = chatInput.value.trim();
            if (!prompt) return;
            addChatMessage('user', prompt);
            chatInput.value = '';
            addChatMessage('model', '<span class="loader"></span>'); // Mostra loader
            
            const contextData = getContextData(currentChatContext);
            const fullPrompt = `**Contexto dos Dados (M√™s: ${contextData.mesSelecionado}):**
                - Receitas Totais: ${formatarMoeda(contextData.receitas.total)}
                - Despesas Totais: ${formatarMoeda(contextData.despesas.total)}
                - Saldo do M√™s: ${formatarMoeda(contextData.saldo)}
                - Detalhes (JSON): ${JSON.stringify(contextData)}

                **Hist√≥rico:**
                ${Array.from(chatMessages.children).map(el => el.textContent).join('\n')}

                **Pergunta do Usu√°rio:**
                ${prompt}
                
                **Instru√ß√£o:**
                Aja como um assistente financeiro s√™nior. Responda a pergunta do usu√°rio com base **apenas** nos dados de contexto fornecidos. Seja claro, objetivo e use formata√ß√£o (markdown) para melhorar a legibilidade. Se os dados n√£o forem suficientes, informe.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1024,
                        }
                    })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error.message || `Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                // Remove o loader e adiciona a resposta
                chatMessages.removeChild(chatMessages.lastChild);
                addChatMessage('model', text);
            } catch (error) {
                console.error("Erro na API Gemini:", error);
                chatMessages.removeChild(chatMessages.lastChild);
                addChatMessage('model', `Desculpe, houve um erro ao conectar com a IA. Verifique sua chave de API ou conex√£o.\n\n*Detalhe: ${error.message}*`);
            }
        }

        const exportarGastosPDF = () => {
            // Verifica√ß√£o 1: Biblioteca principal
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 showToast("Erro ao carregar a biblioteca principal (jsPDF). Tente recarregar a p√°gina.");
                 console.error("window.jspdf ou window.jspdf.jsPDF n√£o est√£o definidos.");
                 return;
            }
            
            // Verifica√ß√£o 2: Plugin autoTable (forma est√°tica)
            // O plugin (v3) n√£o consegue se anexar ao prot√≥tipo da jsPDF (v2)
            // Mas ele fica dispon√≠vel em window.jspdf.autoTable
            if (typeof window.jspdf.autoTable === 'undefined') {
                console.error("Falha ao checar window.jspdf.autoTable");
                showToast("Erro ao carregar o plugin da tabela (autoTable). Tente recarregar a p√°gina.");
                return;
            }
            // --- FIM DA CORRE√á√ÉO DE VERIFICA√á√ÉO ---

            const { jsPDF } = window.jspdf; // Pega o construtor
            const doc = new jsPDF(); // Cria o documento
            
            const gastosFiltrados = getFilteredData('gastos').sort((a,b) => new Date(a.data) - new Date(b.data));
            if (gastosFiltrados.length === 0) {
                showToast("N√£o h√° gastos neste m√™s para exportar.");
                return;
            }

            const [year, month] = state.selectedMonth.split('-');
            const mesFormatado = `${month}/${year}`;
            
            doc.setFontSize(18);
            doc.text(`Relat√≥rio de Gastos - ${mesFormatado}`, 14, 20);
            doc.setFontSize(11);
            doc.setTextColor(100);

            const tableColumn = ["Data", "Descri√ß√£o", "Categoria", "Conta", "Pagamento", "Valor (R$)"];
            const tableRows = [];

            let totalGastos = 0;

            gastosFiltrados.forEach(gasto => {
                const dataFormatada = formatarData(gasto.data);
                const valorNumerico = parseFloat(gasto.valor) || 0;
                const valorFormatado = valorNumerico.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                totalGastos += valorNumerico;

                // A API v3 aceita objetos de estilo diretamente nas c√©lulas
                const gastoData = [
                    dataFormatada,
                    gasto.descricao,
                    gasto.categoria,
                    gasto.conta,
                    gasto.pagamento,
                    { content: valorFormatado, styles: { halign: 'right' } } 
                ];
                tableRows.push(gastoData);
            });

            const totalFormatado = totalGastos.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            // A API v3 aceita objetos de estilo para a linha de total
            const totalRow = [
                { content: "Total de Gastos", colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },
                { content: totalFormatado, styles: { halign: 'right', fontStyle: 'bold' } }
            ];
            tableRows.push(totalRow);

            // --- CORRE√á√ÉO NA CHAMADA DA FUN√á√ÉO (API v3) ---
            // Usamos a chamada est√°tica (window.jspdf.autoTable) e a sintaxe da v3
            window.jspdf.autoTable(doc, {
                head: [tableColumn], // API v3 usa 'head'
                body: tableRows,     // API v3 usa 'body'
                startY: 28,
                headStyles: { fillColor: [79, 70, 229] }, 
                footStyles: { fillColor: [241, 245, 249] }, 
                didParseCell: (data) => {
                    // Na v3, precisamos checar o 'raw' da c√©lula
                    if (data.row.section === 'body' && data.row.cells[0].raw?.content === "Total de Gastos") {
                        data.cell.styles.fillColor = '#f1f5f9'; 
                        data.cell.styles.textColor = '#1f2937'; 
                    }
                }
            });
            // --- FIM DA CORRE√á√ÉO ---

            doc.save(`Relatorio_Gastos_${month}-${year}.pdf`);
            showToast("Relat√≥rio PDF gerado com sucesso!", false);
        };

        // Bot√£o "Criar PDF" na aba de Entradas
        document.getElementById("export-entradas-pdf-btn").addEventListener("click", () => {
            const tabela = document.getElementById("tabela-eventos");
            if (!tabela) return alert("Tabela de entradas n√£o encontrada");

            const doc = new jsPDF();
            doc.text("Relat√≥rio de Entradas", 14, 20);

            window.jspdf.autoTable(doc, { html: tabela });
            doc.save("Relatorio_Entradas.pdf");
        });

        // Bot√£o "Criar PDF" na aba Monitores
        document.getElementById("export-monitores-pdf-btn").addEventListener("click", () => {
        const tabela = document.getElementById("tabela-monitores-db");
        if (!tabela) return alert("Tabela de monitores n√£o encontrada");

        const doc = new jsPDF();
        doc.text("Relat√≥rio de Monitores", 14, 20);

        window.jspdf.autoTable(doc, { html: tabela });
        doc.save("Relatorio_Monitores.pdf");
        });

        // Bot√£o "Criar PDF" na se√ß√£o sal√°rios
        document.getElementById("export-salarios-pdf-btn").addEventListener("click", () => {
        const tabela = document.getElementById("tabela-pagamentos-monitores");
        if (!tabela) return alert("Tabela de sal√°rios n√£o encontrada");

        const doc = new jsPDF();
        doc.text("Relat√≥rio de Sal√°rios", 14, 20);

        window.jspdf.autoTable(doc, { html: tabela });
        doc.save("Relatorio_Salarios.pdf");
        });


        // --- INICIALIZA√á√ÉO ---
        migrateData();
        getById('month-filter-global').value = state.selectedMonth;
        setupMonthFilters();
        getById('export-gastos-pdf-btn').addEventListener('click', exportarGastosPDF);
        renderAll();
        
        // Bot√£o "Criar PDF" na aba de Entradas
        document.getElementById("export-entradas-pdf-btn").addEventListener("click", () => {
            const tabela = document.getElementById("tabela-eventos");
            if (!tabela) return alert("Tabela de entradas n√£o encontrada");

            const doc = new jsPDF();
            doc.text("Relat√≥rio de Entradas", 14, 20);
            window.jspdf.autoTable(doc, { html: tabela });
            doc.save("Relatorio_Entradas.pdf");
        });

        // Bot√£o "Criar PDF" na aba Monitores
        document.getElementById("export-monitores-pdf-btn").addEventListener("click", () => {
            const tabela = document.getElementById("tabela-monitores-db");
            if (!tabela) return alert("Tabela de monitores n√£o encontrada");

            const doc = new jsPDF();
            doc.text("Relat√≥rio de Monitores", 14, 20);
            window.jspdf.autoTable(doc, { html: tabela });
            doc.save("Relatorio_Monitores.pdf");
        });

        // Bot√£o "Criar PDF" na se√ß√£o Sal√°rios
        document.getElementById("export-salarios-pdf-btn").addEventListener("click", () => {
            const tabela = document.getElementById("tabela-pagamentos-monitores");
            if (!tabela) return alert("Tabela de sal√°rios n√£o encontrada");

            const doc = new jsPDF();
            doc.text("Relat√≥rio de Sal√°rios", 14, 20);
            window.jspdf.autoTable(doc, { html: tabela });
            doc.save("Relatorio_Salarios.pdf");
        });

    });
    </script>

<!-- Sistema de Autentica√ß√£o -->
<script src="js/protect.js"></script>

</body>
</html>