<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira v30 - Categorias Din√¢micas</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='20' cy='20' r='10' fill='%234f46e5'/><circle cx='80' cy='30' r='8' fill='%234f46e5'/><circle cx='50' cy='70' r='12' fill='%234f46e5'/><line x1='20' y1='20' x2='80' y2='30' stroke='%234f46e5' stroke-width='5'/><line x1='80' y1='30' x2='50' y2='70' stroke='%234f46e5' stroke-width='5'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { api, API_BASE_URL } from './js/api.js?v=1.1';
        import { getToken } from './js/auth.js?v=1.1';

        // Garante que o jsPDF esteja dispon√≠vel
        window.jsPDF = window.jspdf.jsPDF;

        // Vers√£o do c√≥digo para debug
        console.log("üîß Sistema Financeiro v1.1 - Carregado");

        // Torna api e fun√ß√µes acess√≠veis globalmente
        window.api = api;
        window.API_BASE_URL = API_BASE_URL;
        window.getToken = getToken;

        // Defini√ß√£o de vari√°veis e fun√ß√µes globais compartilhadas
        let loadDataFromCloud;
        let formLancamentoCF;
        const getById = id => document.getElementById(id);
        window.getById = getById;

        const showModal = (modalId) => {
            const modal = getById(modalId);
            if (modal) modal.classList.remove('hidden');
        };
        window.showModal = showModal;

        const hideModal = (modalId) => {
            const modal = getById(modalId);
            if (modal) modal.classList.add('hidden');
        };
        window.hideModal = hideModal;

        const showToastModal = (message, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            if (toast && toastMessage && toastIcon) {
                toastMessage.textContent = message;
                toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                toast.className = isError
                    ? 'fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3'
                    : 'fixed top-5 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3';

                setTimeout(() => {
                    toast.className = toast.className.replace('top-5', '-top-20');
                }, 3000);
            }
        };
        window.showToastModal = showToastModal;

        const validateForm = (form) => {
            let isValid = true;
            const inputs = form.querySelectorAll('input[required], select[required]');
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                }
            });
            return isValid;
        };
        window.validateForm = validateForm;

        document.addEventListener('DOMContentLoaded', async () => {
            // Alias global para showToast para evitar ReferenceError
            window.showToast = window.showToastModal || window.showIAToast || console.log;

            // Fun√ß√µes Auxiliares (Definidas no topo para evitar TDZ)
            const formatarMoeda = val => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
            window.formatarMoeda = formatarMoeda;
            const formatarData = str => { if (!str) return '-'; const p = str.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; };
            window.formatarData = formatarData;

            console.log("‚úÖ DOMContentLoaded iniciado");

            // Estado Inicial
            let state = {
                eventos: [],
                gastos: [],
                receitas: [], // üÜï Transa√ß√µes do tipo REVENUE (entradas manuais)
                contas: [],
                contasFixas: [],
                selectedMonth: new Date().toISOString().slice(0, 7) // YYYY-MM
            };

            // Torna o state acess√≠vel globalmente para os gr√°ficos
            window.state = state;

            // Atribui a fun√ß√£o √† vari√°vel global
            loadDataFromCloud = async function () {
                try {
                    console.log("‚òÅÔ∏è Sincronizando com o servidor...");

                    // 1. Busca primeiro o resumo do Dashboard para renderiza√ß√£o imediata (Velocidade)
                    const [ano, mes] = state.selectedMonth.split('-');
                    const dashboardData = await window.api.getFinanceiro(mes, ano);
                    if (dashboardData) {
                        state.dashboardSummary = dashboardData.summary;
                        console.log("üìä Resumo do Dashboard recebido");
                        renderAll(); // Chamada r√°pida para mostrar os cards
                    }

                    // 2. Busca o restante dos dados em paralelo
                    const [
                        eventosCloud,
                        transacoesCloud,
                        contasCloud,
                        fixasCloud,
                        catGastos,
                        catFixas,
                        monitoresCloud,
                        pagamentosCloud,
                        funcionariosCloud,
                        faixasCloud
                    ] = await Promise.all([
                        window.api.getEventos(),
                        window.api.getTransacoes(),
                        window.api.getContas(),
                        window.api.getContasFixas(),
                        window.api.getCategoriasGastos(),
                        window.api.getCategoriasFixas(),
                        window.api.getMonitores(),
                        window.api.getPagamentosMonitores(),
                        window.api.getFuncionarios(),
                        window.api.getFaixasComissao()
                    ]);

                    console.log("üìä Dados recebidos:", {
                        eventos: eventosCloud?.length || 0,
                        transacoes: transacoesCloud?.length || 0,
                        contas: contasCloud?.length || 0,
                        contasFixas: fixasCloud?.length || 0,
                        catGastos: catGastos?.length || 0,
                        catFixas: catFixas?.length || 0,
                        monitores: monitoresCloud?.length || 0,
                        pagamentos: pagamentosCloud?.length || 0,
                        funcionarios: funcionariosCloud?.length || 0,
                        faixas: faixasCloud?.length || 0
                    });

                    // 1. Mapeia Eventos
                    state.eventos = eventosCloud.map(evt => ({
                        id: evt.id.toString(),
                        data: evt.date,
                        empresa: evt.company ? evt.company.name : "Aero Festas",
                        contratante: evt.clientName,
                        local: "",
                        items: evt.items?.map(i => ({ nome: i.toy?.name, valor: 0 })) || [],
                        valor: evt.price || 0,
                        isSynced: true
                    }));

                    // 2. Mapeia Gastos e Pagamentos (Separando pelo tipo/categoria)
                    state.gastos = transacoesCloud
                        .filter(t => t.type === 'EXPENSE' && !t.category?.includes('Sal√°rio') && !t.description?.includes('Pgto Monitor'))
                        .map(t => {
                            const contaRef = contasCloud.find(c => c.id === t.accountId);
                            return {
                                id: t.id,
                                data: t.date,
                                descricao: t.description,
                                categoria: t.category || "Geral",
                                contaId: t.accountId,
                                conta: contaRef ? contaRef.name : "Caixa",
                                pagamento: t.paymentMethod || "Outro",
                                valor: t.amount,
                                comprovantes: []
                            };
                        });

                    // 2.5. Mapeia Receitas (Transa√ß√µes do tipo REVENUE - entradas manuais)
                    state.receitas = transacoesCloud
                        .filter(t => t.type === 'REVENUE')
                        .map(t => ({
                            id: t.id,
                            data: t.date,
                            descricao: t.description,
                            categoria: t.category || "Receita Avulsa",
                            valor: t.amount,
                            tipo: 'manual' // Flag para diferenciar de eventos
                        }));

                    // 3. Mapeia Contas Banc√°rias
                    state.contas = contasCloud.map(c => ({
                        id: c.id, nome: c.name, banco: c.bank, tipo: c.type, agencia: c.agency, numero: c.number
                    }));

                    // 4. Mapeia Contas Fixas (Cadastros)
                    state.contasFixas = fixasCloud.map(c => {
                        let anexos = [];
                        try {
                            if (c.attachments) {
                                anexos = typeof c.attachments === 'string' ? JSON.parse(c.attachments) : c.attachments;
                            }
                        } catch (e) {
                            console.warn('Erro ao parsear anexos da conta fixa:', c.id, e);
                            anexos = [];
                        }

                        return {
                            id: c.id,
                            descricao: c.description,
                            valor: c.amount,
                            diaVencimento: c.dueDay,
                            categoria: c.category,
                            tipoRecorrencia: c.recurrenceType || 'permanente',
                            dataInicio: c.startDate,
                            numParcelas: c.installments,
                            anexos: anexos
                        };
                    });

                    // 5. Mapeia Categorias de Gastos
                    state.gastoCategorias = catGastos.map(c => ({ id: c.id, nome: c.name }));

                    // 6. Mapeia Categorias de Contas Fixas
                    state.contaFixaCategorias = catFixas.map(c => ({ id: c.id, nome: c.name }));

                    // 7. Mapeia MONITORES
                    state.monitores = monitoresCloud.map(m => {
                        let habilidades = null;
                        try {
                            habilidades = m.habilidades ? JSON.parse(m.habilidades) : null;
                        } catch (e) {
                            console.warn('Erro ao parsear habilidades:', m.id, e);
                        }

                        return {
                            id: m.id,
                            nome: m.nome,
                            nascimento: m.nascimento,
                            telefone: m.telefone,
                            email: m.email,
                            endereco: m.endereco,
                            observacoes: m.observacoes,
                            cnh: m.cnh,
                            cnhCategoria: m.cnhCategoria,
                            fotoPerfil: m.fotoPerfil,
                            fotoDocumento: m.fotoDocumento,
                            habilidades: habilidades || { forca: 5, agilidade: 5, proatividade: 5, comunicacao: 5, disponibilidade: 5, respeito: 5 },
                            desempenho: m.desempenho || []
                        };
                    });

                    // 8. Mapeia PAGAMENTOS DE MONITORES
                    state.pagamentosMonitores = pagamentosCloud.map(p => ({
                        id: p.id,
                        data: p.data,
                        monitorId: p.monitorId,
                        nome: p.nome,
                        valorBase: p.valorBase,
                        adicional: p.adicional,
                        horasExtras: p.horasExtras,
                        pagamento: p.pagamento,
                        statusPagamento: p.statusPagamento,
                        horaEntrada: p.horaEntrada,
                        horaSaida: p.horaSaida,
                        numEventos: p.numEventos
                    }));

                    // 9. Mapeia FUNCION√ÅRIOS
                    state.funcionarios = funcionariosCloud.map(f => ({
                        id: f.id,
                        nome: f.nome,
                        salarioFixo: f.salarioFixo,
                        va: f.va,
                        vt: f.vt
                    }));

                    // 10. Mapeia FAIXAS DE COMISS√ÉO
                    state.faixasComissao = faixasCloud.map(fx => ({
                        id: fx.id,
                        ateValor: fx.ateValor,
                        percentual: fx.percentual
                    }));

                    // 11. Se categorias estiverem vazias, popular com dados padr√£o
                    if (catGastos.length === 0 || catFixas.length === 0) {
                        console.log("‚ö†Ô∏è Categorias vazias! Populando banco de dados...");
                        try {
                            const token = getToken ? getToken() : null;
                            const seedRes = await fetch(`${API_BASE_URL}/api/finance/seed-categories`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                }
                            });
                            if (seedRes.ok) {
                                console.log("‚úÖ Categorias padr√£o criadas! Recarregando...");
                                const [newCatGastos, newCatFixas] = await Promise.all([
                                    window.api.getCategoriasGastos(),
                                    window.api.getCategoriasFixas()
                                ]);
                                state.gastoCategorias = newCatGastos.map(c => ({ id: c.id, nome: c.name }));
                                state.contaFixaCategorias = newCatFixas.map(c => ({ id: c.id, nome: c.name }));
                            }
                        } catch (seedError) {
                            console.error("Erro ao popular categorias:", seedError);
                        }
                    }

                    // 12. Se funcion√°rios/faixas estiverem vazios, popular dados padr√£o
                    if (funcionariosCloud.length === 0 || faixasCloud.length === 0) {
                        console.log("‚ö†Ô∏è Dados de sal√°rio vazios! Populando banco...");
                        try {
                            const token = getToken ? getToken() : null;
                            const seedRes = await fetch(`${API_BASE_URL}/api/finance/seed-salarios`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                }
                            });
                            if (seedRes.ok) {
                                console.log("‚úÖ Dados de sal√°rio criados! Recarregando...");
                                const [newFunc, newFaixas] = await Promise.all([
                                    window.api.getFuncionarios(),
                                    window.api.getFaixasComissao()
                                ]);
                                state.funcionarios = newFunc.map(f => ({ id: f.id, nome: f.nome, salarioFixo: f.salarioFixo, va: f.va, vt: f.vt }));
                                state.faixasComissao = newFaixas.map(fx => ({ id: fx.id, ateValor: fx.ateValor, percentual: fx.percentual }));
                            }
                        } catch (seedError) {
                            console.error("Erro ao popular sal√°rios:", seedError);
                        }
                    }

                    console.log("üìã State final ap√≥s carregar tudo:", {
                        eventos: state.eventos.length,
                        gastos: state.gastos.length,
                        contas: state.contas.length,
                        contasFixas: state.contasFixas.length,
                        gastoCategorias: state.gastoCategorias.length,
                        contaFixaCategorias: state.contaFixaCategorias.length,
                        monitores: state.monitores.length,
                        pagamentosMonitores: state.pagamentosMonitores.length,
                        funcionarios: state.funcionarios.length,
                        faixasComissao: state.faixasComissao.length
                    });

                    console.log("‚úÖ Dados sincronizados!");
                    renderAll(); // Atualiza tudo (gr√°ficos, tabelas, etc.)

                } catch (error) {
                    console.error("‚ùå Erro ao carregar dados do servidor:", error);
                    console.error("Detalhes do erro:", error.message, error.stack);
                    showToast("Erro ao conectar com o servidor. Verifique o console.", true);
                }
            };

            // Torna a fun√ß√£o acess√≠vel globalmente tamb√©m via window
            window.loadDataFromCloud = loadDataFromCloud;

            // --- 2. RENDERIZA√á√ÉO ---
            const renderAll = () => {
                const monthInput = getById('month-filter-global');
                if (monthInput) monthInput.value = state.selectedMonth;

                // Filtra dados pelo m√™s selecionado
                const gastosMes = state.gastos.filter(g => g.data.startsWith(state.selectedMonth));
                const eventosMes = state.eventos.filter(e => e.data.startsWith(state.selectedMonth));
                const receitasMes = state.receitas?.filter(r => r.data.startsWith(state.selectedMonth)) || [];

                // C√°lculo M√™s Anterior para Compara√ß√£o
                const [currAno, currMes] = state.selectedMonth.split('-').map(Number);
                const prevDate = new Date(currAno, currMes - 2, 1);
                const prevMonthStr = prevDate.toISOString().slice(0, 7);

                const gastPrev = state.gastos.filter(g => g.data.startsWith(prevMonthStr));
                const evPrev = state.eventos.filter(e => e.data.startsWith(prevMonthStr));
                const recPrev = state.receitas?.filter(r => r.data.startsWith(prevMonthStr)) || [];

                const monitorPagamentosMes = (state.pagamentosMonitores || []).filter(p => p.data.startsWith(state.selectedMonth));
                const despMonitores = monitorPagamentosMes.reduce((acc, p) => {
                    const total = (parseFloat(p.valorBase) || 0) + (parseFloat(p.horasExtras) || 0) + (parseFloat(p.adicional) || 0);
                    return acc + total;
                }, 0);

                // Valores Atuais (Prioriza o resumo do backend para velocidade)
                const recAtual = state.dashboardSummary ? state.dashboardSummary.revenue : (eventosMes.reduce((acc, e) => acc + (e.valor || 0), 0) + receitasMes.reduce((acc, r) => acc + (r.valor || 0), 0));
                const despAtual = state.dashboardSummary ? state.dashboardSummary.expenses : (gastosMes.reduce((acc, g) => acc + (g.valor || 0), 0) + despMonitores);
                const saldoAtual = state.dashboardSummary ? state.dashboardSummary.balance : (recAtual - despAtual);

                // Valores Anteriores (C√°lculo local para compara√ß√£o hist√≥rica r√°pida)
                const monitorPagamentosPrev = (state.pagamentosMonitores || []).filter(p => p.data.startsWith(prevMonthStr));
                const despMonitoresPrev = monitorPagamentosPrev.reduce((acc, p) => {
                    const total = (parseFloat(p.valorBase) || 0) + (parseFloat(p.horasExtras) || 0) + (parseFloat(p.adicional) || 0);
                    return acc + total;
                }, 0);

                const recEvPrev = evPrev.reduce((acc, e) => acc + (e.valor || 0), 0);
                const recManPrev = recPrev.reduce((acc, r) => acc + (r.valor || 0), 0);
                const recAnterior = recEvPrev + recManPrev;
                const despAnterior = gastPrev.reduce((acc, g) => acc + (g.valor || 0), 0) + despMonitoresPrev;
                const saldoAnterior = recAnterior - despAnterior;

                const getChangeHTML = (atual, anterior, invert = false) => {
                    if (anterior === 0) return '<span class="text-gray-400">Sem dados do m√™s anterior</span>';
                    const diff = ((atual - anterior) / anterior) * 100;
                    const isPositive = diff >= 0;
                    const colorClass = (isPositive !== invert) ? 'text-emerald-600' : 'text-red-600';
                    const icon = isPositive ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
                    return `<span class="${colorClass} font-bold"><i class="fa-solid ${icon} mr-1"></i>${Math.abs(diff).toFixed(1)}%</span> vs m√™s anterior`;
                };

                // Atualiza Cards do Dashboard
                getById('total-receitas').textContent = formatarMoeda(recAtual);
                getById('receitas-comparison').innerHTML = getChangeHTML(recAtual, recAnterior);

                getById('total-despesas').textContent = formatarMoeda(despAtual);
                const despesasComparison = getById('despesas-comparison');
                despesasComparison.innerHTML = getChangeHTML(despAtual, despAnterior, true);

                // Adiciona Gastos Pendentes (Centralizado no Backend)
                if (state.dashboardSummary && state.dashboardSummary.pendingExpenses > 0) {
                    const pendingVal = state.dashboardSummary.pendingExpenses;
                    despesasComparison.innerHTML += `<div class="mt-2 p-2 bg-amber-50 rounded-lg border border-amber-200 flex flex-col gap-1 text-amber-800 animate-bounce-subtle">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left mr-1"></i> Gastos Pendentes:</span>
                            <span class="font-bold">${formatarMoeda(pendingVal)}</span>
                        </div>
                        <button onclick="window.showPendingDetailsModal()" class="text-[9px] text-amber-600 hover:text-amber-700 underline text-right transition-colors">
                            <i class="fa-solid fa-list-check mr-1"></i> Ver detalhes
                        </button>
                    </div>`;
                }

                const elSaldo = getById('saldo-total');
                elSaldo.textContent = formatarMoeda(saldoAtual);
                elSaldo.className = `text-4xl font-bold ${saldoAtual >= 0 ? 'text-blue-600' : 'text-red-600'}`;
                getById('saldo-comparison').innerHTML = getChangeHTML(saldoAtual, saldoAnterior);

                // Renderiza Tabela de Gastos
                const tbodyGastos = getById('tabela-gastos')?.querySelector('tbody');
                if (tbodyGastos) {
                    if (gastosMes.length === 0) {
                        tbodyGastos.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum gasto neste m√™s.</td></tr>';
                    } else {
                        tbodyGastos.innerHTML = gastosMes.sort((a, b) => new Date(a.data) - new Date(b.data)).map(g => `
                                <tr>
                                    <td>${formatarData(g.data)}</td>
                                    <td>${g.descricao}</td>
                                    <td>${g.categoria}</td>
                                    <td>${g.conta}</td>
                                    <td>${g.pagamento}</td>
                                    <td class="font-bold text-red-600">${formatarMoeda(g.valor)}</td>
                                    <td>
                                        <div class="flex space-x-2">
                                            <button onclick="editarGasto('${g.id}')" 
                                                    class="text-indigo-600 hover:text-indigo-900 transition-colors"
                                                    title="Editar Gasto">
                                                <i class="fa-solid fa-edit"></i>
                                            </button>
                                            <button onclick="deletarGasto('${g.id}')" 
                                                    class="text-red-600 hover:text-red-900 transition-colors"
                                                    title="Excluir Gasto">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                    }
                }

                // Renderiza Tabela de Entradas (Eventos + Receitas Manuais)
                const tbodyEventos = getById('tabela-eventos')?.querySelector('tbody');
                if (tbodyEventos) {
                    // Combina eventos e receitas manuais
                    const entradasEventos = eventosMes.map(e => ({
                        data: e.data,
                        tipo: 'üìÖ Evento',
                        empresa: e.empresa || '-',
                        descricao: e.contratante,
                        local: e.local || '-',
                        detalhes: 'Itens do Evento',
                        valor: e.valor,
                        deletavel: false,
                        editavel: true,
                        eventoId: e.id,
                        id: null
                    }));

                    const entradasManuais = receitasMes.map(r => ({
                        data: r.data,
                        tipo: 'üí∞ Entrada Avulsa',
                        empresa: '-',
                        descricao: r.descricao,
                        local: '-',
                        detalhes: r.categoria,
                        valor: r.valor,
                        deletavel: true,
                        editavel: false,
                        eventoId: null,
                        id: r.id
                    }));

                    const todasEntradas = [...entradasEventos, ...entradasManuais]
                        .sort((a, b) => new Date(a.data) - new Date(b.data));

                    if (todasEntradas.length === 0) {
                        tbodyEventos.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma entrada neste m√™s.</td></tr>';
                    } else {
                        tbodyEventos.innerHTML = todasEntradas.map(entry => `
                                <tr>
                                    <td>${formatarData(entry.data)}</td>
                                    <td>${entry.empresa}</td>
                                    <td>${entry.descricao}</td>
                                    <td>${entry.local}</td>
                                    <td>${entry.detalhes}</td>
                                    <td class="font-bold text-green-600">${formatarMoeda(entry.valor)}</td>
                                    <td>
                                        <div class="flex space-x-2">
                                            ${entry.editavel
                                ? `<button onclick="editarEvento('${entry.eventoId}')" 
                                                        class="text-indigo-600 hover:text-indigo-900 transition-colors"
                                                        title="Editar Evento">
                                                    <i class="fa-solid fa-edit"></i>
                                                </button>`
                                : ''
                            }
                                            ${entry.deletavel
                                ? `<button onclick="deletarEntradaManual('${entry.id}')" 
                                                        class="text-red-600 hover:text-red-900 transition-colors"
                                                        title="Deletar">
                                                    <i class="fa-solid fa-trash-can"></i>
                                                </button>`
                                : entry.editavel ? '' : '<span class="text-gray-400 text-xs">-</span>'
                            }
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                    }
                }

                // Renderiza Tabela de Contas Fixas (Cadastros)
                const tbodyContasFixas = getById('tabela-contas-fixas-db')?.querySelector('tbody');
                if (tbodyContasFixas && state.contasFixas) {
                    if (state.contasFixas.length === 0) {
                        tbodyContasFixas.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma conta fixa cadastrada.</td></tr>';
                    } else {
                        tbodyContasFixas.innerHTML = state.contasFixas.map(cf => `
                            <tr>
                                <td>${cf.descricao}</td>
                                <td>${formatarMoeda(cf.valor)}</td>
                                <td>${cf.diaVencimento}</td>
                                <td>${cf.categoria}</td>
                                <td>${cf.tipoRecorrencia === 'parcelada' ? `${cf.numParcelas}x` : 'Permanente'}</td>
                                <td class="text-center">${cf.anexos?.length || 0}</td>
                                <td>
                                    <div class="flex space-x-2">
                                        <button onclick="editarContaFixa('${cf.id}')" class="text-indigo-600 hover:text-indigo-900" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                        <button onclick="deletarContaFixa('${cf.id}')" class="text-red-600 hover:text-red-900" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza Tabela de Contas Banc√°rias
                const tbodyContas = getById('tabela-contas-db')?.querySelector('tbody');
                if (tbodyContas && state.contas) {
                    if (state.contas.length === 0) {
                        tbodyContas.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma conta banc√°ria cadastrada.</td></tr>';
                    } else {
                        tbodyContas.innerHTML = state.contas.map(c => `
                            <tr>
                                <td>${c.nome}</td>
                                <td>${c.banco}</td>
                                <td>${c.tipo}</td>
                                <td>${c.agencia || ''} / ${c.numero || ''}</td>
                                <td>
                                    <div class="flex space-x-2">
                                        <button onclick="editarContaBancaria('${c.id}')" class="text-indigo-600 hover:text-indigo-900" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                        <button onclick="deletarContaBancaria('${c.id}')" class="text-red-600 hover:text-red-900" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Popula Selects de Categorias
                const populateSelect = (selectId, items, placeholder, nameField = 'nome') => {
                    const select = getById(selectId);
                    if (select && items) {
                        select.innerHTML = `<option value="">-- ${placeholder} --</option>` +
                            items.map(item => `<option value="${item[nameField]}">${item[nameField]}</option>`).join('');
                    }
                };

                populateSelect('gasto-categoria', state.gastoCategorias, 'Selecione uma categoria');
                populateSelect('conta-fixa-categoria', state.contaFixaCategorias, 'Selecione uma categoria');

                // Popula Select de Contas Banc√°rias
                const selectConta = getById('gasto-conta');
                const selectContaCF = getById('lancamento-cf-conta');
                if (state.contas) {
                    const options = '<option value="">-- Selecione uma conta --</option>' +
                        state.contas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

                    if (selectConta) selectConta.innerHTML = options;
                    if (selectContaCF) selectContaCF.innerHTML = options;
                }

                // Renderiza Cards de Lan√ßamento de Contas Fixas do M√™s (VISUAL UPGRADE)
                const containerContasFixasMes = getById('tabela-contas-fixas-mes')?.closest('.table-wrapper');
                if (containerContasFixasMes) {
                    const contasDoMes = getContasFixasDoMes(state.selectedMonth);

                    if (contasDoMes.length === 0) {
                        containerContasFixasMes.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-4xl mb-2"></i><p>Nenhuma conta fixa ativa neste m√™s.</p></div>';
                    } else {
                        // Para cada conta, verifica status
                        const [anoMes, mesMes] = state.selectedMonth.split('-').map(Number);
                        const hoje = new Date();
                        const diaHoje = hoje.getDate();
                        const mesHoje = hoje.getMonth() + 1;
                        const anoHoje = hoje.getFullYear();
                        const ehMesAtual = (anoMes === anoHoje && mesMes === mesHoje);

                        const cardsHTML = contasDoMes.map(cf => {
                            // Calcula n√∫mero da parcela (se parcelada)
                            let parcelaAtual = null;
                            if (cf.tipoRecorrencia === 'parcelada' && cf.dataInicio && cf.numParcelas) {
                                const [anoInicio, mesInicio] = cf.dataInicio.split('-').map(Number);
                                const mesesPassados = (anoMes - anoInicio) * 12 + (mesMes - mesInicio);
                                parcelaAtual = mesesPassados + 1;
                            }

                            // Verifica se j√° foi lan√ßada (procura nos gastos)
                            const foiLancada = state.gastos.some(g =>
                                g.data.startsWith(state.selectedMonth) &&
                                g.descricao.includes(cf.descricao) &&
                                g.descricao.includes('[Conta Fixa]')
                            );

                            // Verifica se est√° atrasada
                            const estaAtrasada = ehMesAtual && diaHoje > cf.diaVencimento && !foiLancada;

                            // Define status e cores
                            let statusClass, statusIcon, statusText, statusBadge;
                            if (foiLancada) {
                                statusClass = 'border-l-4 border-green-500 bg-green-50/50';
                                statusIcon = 'fa-circle-check text-green-600';
                                statusText = 'Pago';
                                statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full">‚úì PAGO</span>';
                            } else if (estaAtrasada) {
                                statusClass = 'border-l-4 border-red-500 bg-red-50/50 animate-pulse';
                                statusIcon = 'fa-circle-exclamation text-red-600';
                                statusText = 'Atrasado';
                                statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full animate-pulse">‚ö† ATRASADA</span>';
                            } else {
                                statusClass = 'border-l-4 border-yellow-500 bg-yellow-50/50';
                                statusIcon = 'fa-clock text-yellow-600';
                                statusText = 'Pendente';
                                statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full">‚è≥ PENDENTE</span>';
                            }

                            return `
                                <div class="glassmorphism ${statusClass} p-4 rounded-lg mb-3 hover:shadow-lg transition-all duration-300">
                                    <!-- Cabe√ßalho do Card -->
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <i class="fa-solid ${statusIcon} text-lg"></i>
                                                <h4 class="font-bold text-gray-800 text-base">${cf.descricao}</h4>
                                            </div>
                                            <div class="flex items-center gap-2 flex-wrap mt-1">
                                                ${statusBadge}
                                                ${parcelaAtual ? `<span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-bold rounded-full">üìä Parcela ${parcelaAtual}/${cf.numParcelas}</span>` : '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-bold rounded-full">‚ôæÔ∏è PERMANENTE</span>'}
                                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${cf.categoria}</span>
                                            </div>
                                        </div>
                                        <div class="text-right ml-3">
                                            <p class="text-2xl font-bold ${estaAtrasada ? 'text-red-600' : 'text-gray-800'}">${formatarMoeda(cf.valor)}</p>
                                            <p class="text-xs text-gray-500">Venc: dia ${cf.diaVencimento}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Informa√ß√µes Adicionais -->
                                    <div class="flex items-center justify-between text-xs text-gray-600 mb-3 pb-3 border-b border-gray-200">
                                        <span><i class="fa-solid fa-calendar-days mr-1"></i> ${cf.tipoRecorrencia === 'parcelada' ? `Parcelada (${cf.numParcelas}x)` : 'Permanente'}</span>
                                        ${cf.anexos && cf.anexos.length > 0 ? `<span><i class="fa-solid fa-paperclip mr-1"></i> ${cf.anexos.length} anexo(s)</span>` : ''}
                                    </div>
                                    
                                    <!-- Bot√µes de A√ß√£o -->
                                    <div class="flex gap-2 flex-wrap">
                                        ${!foiLancada ? `
                                            <button class="shiny-btn px-3 py-1.5 rounded text-sm flex-1 min-w-[120px]" 
                                                    onclick="lancarGastoDeContaFixa('${cf.id}')" 
                                                    title="Lan√ßar como Gasto">
                                                <i class="fa-solid fa-money-bill-wave mr-1"></i> Lan√ßar Gasto
                                            </button>
                                        ` : `
                                            <div class="flex-1 px-3 py-1.5 bg-green-100 text-green-800 rounded text-sm text-center font-semibold">
                                                <i class="fa-solid fa-check-double mr-1"></i> J√° Lan√ßado
                                            </div>
                                        `}
                                        <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded text-sm transition-colors" 
                                                onclick="alert('Editar conta ID: ${cf.id}')" 
                                                title="Editar">
                                            <i class="fa-solid fa-pencil"></i>
                                        </button>
                                        <button class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded text-sm transition-colors" 
                                                onclick="if(confirm('Excluir esta conta?')) { deletarContaFixa('${cf.id}'); }" 
                                                title="Excluir">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        containerContasFixasMes.innerHTML = cardsHTML;
                    }
                }

                // Renderiza Tabela de Categorias de Gastos
                const tbodyGastoCategorias = getById('tabela-gasto-categorias-db')?.querySelector('tbody');
                if (tbodyGastoCategorias && state.gastoCategorias) {
                    if (state.gastoCategorias.length === 0) {
                        tbodyGastoCategorias.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhuma categoria cadastrada.</td></tr>';
                    } else {
                        tbodyGastoCategorias.innerHTML = state.gastoCategorias.map(cat => `
                            <tr>
                                <td>${cat.nome}</td>
                                <td>
                                    <button class="action-btn delete-btn" onclick="if(confirm('Excluir categoria ${cat.nome}?')) { deletarCategoriaGasto('${cat.id}'); }" title="Excluir">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza Tabela de Categorias de Contas Fixas
                const tbodyCFCategorias = getById('tabela-cf-categorias-db')?.querySelector('tbody');
                if (tbodyCFCategorias && state.contaFixaCategorias) {
                    if (state.contaFixaCategorias.length === 0) {
                        tbodyCFCategorias.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhuma categoria cadastrada.</td></tr>';
                    } else {
                        tbodyCFCategorias.innerHTML = state.contaFixaCategorias.map(cat => `
                            <tr>
                                <td>${cat.nome}</td>
                                <td>
                                    <button class="action-btn delete-btn" onclick="if(confirm('Excluir categoria ${cat.nome}?')) { deletarCategoriaContaFixa('${cat.id}'); }" title="Excluir">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza os gr√°ficos com os dados atualizados
                if (window.renderAllCharts && typeof window.renderAllCharts === 'function') {
                    console.log('üìä Atualizando gr√°ficos para o m√™s:', state.selectedMonth);
                    window.renderAllCharts(state);
                }

                // Renderiza Hist√≥rico de Pagamentos de Monitores (NOVO)
                renderPagamentosMonitores();

                console.log("‚úÖ Renderiza√ß√£o completa!");
            };

            // ========== LOGICA DA ABA MONITORES (REWORK MOBILE) ==========

            const renderMonitorCards = () => {
                const container = getById('monitor-cards-container');
                const countText = getById('monitor-count-text');
                if (!container) return;

                const monitores = state.monitores || [];
                countText.textContent = `${monitores.length} monitores ativos`;

                if (monitores.length === 0) {
                    container.innerHTML = '<div class="col-span-full py-10 text-center text-gray-500">Nenhum monitor cadastrado ainda.</div>';
                    return;
                }

                container.innerHTML = monitores.map(m => {
                    const iniciais = m.nome.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                    const cnhInfo = m.cnh !== 'N√£o possui' ? `<span class="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full font-bold">CNH ${m.cnh}</span>` : '';

                    // Avatar: foto ou iniciais
                    const avatarHTML = m.fotoPerfil
                        ? `<div class="monitor-avatar overflow-hidden"><img src="${m.fotoPerfil}" class="w-full h-full object-cover" alt="${m.nome}"></div>`
                        : `<div class="monitor-avatar">${iniciais}</div>`;

                    return `
                        <div class="monitor-card p-4 rounded-2xl flex flex-col gap-4 border border-white/50 relative group cursor-pointer hover:bg-white/40 transition-all" onclick="visualizarMonitor('${m.id}')">
                            <div class="flex items-center gap-4">
                                ${avatarHTML}
                                <div class="flex-grow min-w-0">
                                    <h4 class="font-bold text-gray-800 truncate">${m.nome}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        ${cnhInfo}
                                        <span class="text-xs text-gray-500">${m.telefone || 'Sem tel'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center pt-2 border-t border-gray-100/50">
                                <span class="text-xs font-medium text-gray-400">ID: #${m.id.slice(-4)}</span>
                                <div class="flex gap-2" onclick="event.stopPropagation()">
                                    <button onclick="editarMonitor('${m.id}')" class="btn-action-small bg-amber-50 text-amber-600 hover:bg-amber-100" title="Editar">
                                        <i class="fa-solid fa-pen-to-square text-sm"></i>
                                    </button>
                                    <button onclick="deletarMonitor('${m.id}')" class="btn-action-small bg-red-50 text-red-600 hover:bg-red-100" title="Excluir">
                                        <i class="fa-solid fa-trash-can text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderPagamentosMonitores = () => {
                const tbody = getById('tabela-pagamentos-monitores')?.querySelector('tbody');
                const tfoot = getById('tabela-pagamentos-monitores')?.querySelector('tfoot');
                if (!tbody) return;

                const pagamentos = (state.pagamentosMonitores || []).filter(p => p.data.startsWith(state.selectedMonth));

                if (pagamentos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-6 text-gray-500">Nenhum pagamento registrado neste m√™s.</td></tr>';
                    if (tfoot) tfoot.classList.add('hidden');
                    return;
                }

                if (tfoot) tfoot.classList.remove('hidden');

                let subtotalMes = 0;

                tbody.innerHTML = pagamentos.sort((a, b) => b.data.localeCompare(a.data)).map(p => {
                    const total = (parseFloat(p.valorBase) || 0) + (parseFloat(p.adicional) || 0) + (parseFloat(p.horasExtras) || 0);
                    subtotalMes += total;

                    const isPago = p.statusPagamento === 'Executado';
                    const statusClass = isPago ? 'text-emerald-700 bg-emerald-100 border-emerald-200' : 'text-amber-700 bg-amber-100 border-amber-200';
                    const statusText = isPago ? 'Pago' : 'Pendente';
                    const nota = p.numEventos || '-';

                    return `
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="py-4 border-b border-gray-100">
                                <input type="checkbox" 
                                       class="pagamento-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 cursor-pointer" 
                                       data-id="${p.id}" 
                                       data-valor="${total.toFixed(2)}">
                            </td>
                            <td class="text-sm py-4 border-b border-gray-100">${p.data.split('-').reverse().slice(0, 2).join('/')}</td>
                            <td class="font-bold text-gray-800 border-b border-gray-100">${p.nome}</td>
                            <td class="hidden sm:table-cell text-xs text-gray-500 border-b border-gray-100">R$ ${(parseFloat(p.valorBase) || 0).toFixed(2)}</td>
                            <td class="hidden sm:table-cell text-xs text-gray-500 border-b border-gray-100">R$ ${(parseFloat(p.horasExtras) || 0).toFixed(2)}</td>
                            <td class="font-bold text-indigo-600 border-b border-gray-100">R$ ${total.toFixed(2)}</td>
                            <td class="text-xs border-b border-gray-100">
                                <span class="px-2 py-1 rounded-full border ${statusClass} font-bold text-[10px] uppercase tracking-wider">${statusText}</span>
                            </td>
                            <td class="border-b border-gray-100">
                                <div class="flex items-center gap-2">
                                    <button onclick="editarPagamentoMonitor('${p.id}')" 
                                            class="w-8 h-8 rounded-lg flex items-center justify-center text-indigo-500 hover:bg-indigo-50 hover:text-indigo-700 transition-all" 
                                            title="Editar Pagamento">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button onclick="toggleStatusPagamentoMonitor('${p.id}', '${p.statusPagamento}')" 
                                            class="w-8 h-8 rounded-lg flex items-center justify-center transition-all ${isPago ? 'text-amber-500 hover:bg-amber-50' : 'text-emerald-500 hover:bg-emerald-50'}" 
                                            title="${isPago ? 'Marcar como Pendente' : 'Marcar como Pago'}">
                                        <i class="fa-solid ${isPago ? 'fa-clock-rotate-left' : 'fa-check-double'}"></i>
                                    </button>
                                    <button onclick="deletarPagamentoMonitor('${p.id}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-red-400 hover:bg-red-50 hover:text-red-600 transition-all">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                if (tfoot) {
                    tfoot.innerHTML = `
                        <tr class="bg-gray-50/50">
                            <td colspan="4" class="py-4 px-4 text-right font-semibold text-gray-600">Subtotal do M√™s:</td>
                            <td class="py-4 px-2 font-bold text-indigo-700 text-lg">R$ ${subtotalMes.toFixed(2)}</td>
                            <td colspan="2"></td>
                        </tr>
                    `;
                }
            };

            // ========== SELE√á√ÉO M√öLTIPLA DE PAGAMENTOS ==========

            // Fun√ß√£o para atualizar a barra de a√ß√µes
            function atualizarBarraAcoes() {
                const checkboxes = document.querySelectorAll('.pagamento-checkbox:checked');
                const bulkBar = getById('bulk-actions-bar');
                const countEl = getById('selected-count');
                const subtotalEl = getById('selected-subtotal');

                const count = checkboxes.length;

                if (count > 0) {
                    // Calcula subtotal
                    let subtotal = 0;
                    checkboxes.forEach(cb => {
                        subtotal += parseFloat(cb.dataset.valor);
                    });

                    // Atualiza UI
                    countEl.textContent = `${count} selecionado${count > 1 ? 's' : ''}`;
                    subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
                    bulkBar.classList.remove('hidden');
                    bulkBar.classList.add('flex');
                } else {
                    bulkBar.classList.add('hidden');
                    bulkBar.classList.remove('flex');
                }
            }

            // Select All & Individual Checkboxes
            document.addEventListener('change', function (e) {
                if (e.target.id === 'select-all-pagamentos') {
                    const checkboxes = document.querySelectorAll('.pagamento-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    atualizarBarraAcoes();
                }

                if (e.target.classList.contains('pagamento-checkbox')) {
                    atualizarBarraAcoes();

                    // Atualiza o checkbox "select all"
                    const allCheckboxes = document.querySelectorAll('.pagamento-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.pagamento-checkbox:checked');
                    const selectAll = getById('select-all-pagamentos');

                    if (selectAll) {
                        selectAll.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        selectAll.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
                    }
                }
            });

            // Cancelar sele√ß√£o
            getById('bulk-cancel-btn')?.addEventListener('click', function () {
                document.querySelectorAll('.pagamento-checkbox').forEach(cb => cb.checked = false);
                const selectAll = getById('select-all-pagamentos');
                if (selectAll) {
                    selectAll.checked = false;
                    selectAll.indeterminate = false;
                }
                atualizarBarraAcoes();
            });

            // Deletar selecionados
            getById('bulk-delete-btn')?.addEventListener('click', async function () {
                const checkboxes = document.querySelectorAll('.pagamento-checkbox:checked');
                const ids = Array.from(checkboxes).map(cb => cb.dataset.id);

                if (ids.length === 0) return;

                const confirmMsg = `Tem certeza que deseja deletar ${ids.length} pagamento${ids.length > 1 ? 's' : ''}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`;

                if (!confirm(confirmMsg)) return;

                // Desabilita bot√£o
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Deletando...';

                try {
                    // Deleta um por um
                    let deletados = 0;
                    for (const id of ids) {
                        const sucesso = await window.api.deletarPagamentoMonitor(id);
                        if (sucesso) deletados++;
                    }

                    if (deletados > 0) {
                        showToastModal(`‚úÖ ${deletados} pagamento${deletados > 1 ? 's deletados' : ' deletado'}!`);
                        await window.loadDataFromCloud();
                        renderPagamentosMonitores();

                        // Limpa sele√ß√£o
                        const selectAll = getById('select-all-pagamentos');
                        if (selectAll) {
                            selectAll.checked = false;
                            selectAll.indeterminate = false;
                        }
                        atualizarBarraAcoes();
                    } else {
                        showToastModal('‚ùå Erro ao deletar pagamentos.', true);
                    }
                } catch (error) {
                    console.error('Erro ao deletar pagamentos:', error);
                    showToastModal('‚ùå Erro ao deletar pagamentos.', true);
                }

                // Restaura bot√£o
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-trash-can mr-2"></i> Deletar Selecionados';
            });

            window.visualizarMonitor = (id) => {
                const m = state.monitores.find(mon => mon.id === id);
                if (!m) return;

                const body = getById('monitor-details-body');
                if (!body) return;

                // Busca pagamentos do monitor
                const pagamentosMonitor = (state.pagamentosMonitores || []).filter(p => p.monitorId === id || p.nome === m.nome);

                // Relaciona com eventos - prioriza eventoId, depois busca pela data
                const eventosRelacionados = pagamentosMonitor.map(pag => {
                    let evento = null;

                    // Primeiro tenta encontrar pelo eventoId (v√≠nculo direto)
                    if (pag.eventoId) {
                        evento = (state.eventos || []).find(e => e.id === pag.eventoId);
                    }

                    // Se n√£o encontrou pelo ID, tenta pela data (fallback para pagamentos antigos)
                    if (!evento) {
                        evento = (state.eventos || []).find(e => e.data === pag.data);
                    }

                    return {
                        pagamento: pag,
                        evento: evento || null
                    };
                }).sort((a, b) => b.pagamento.data.localeCompare(a.pagamento.data));

                const historicoHTML = eventosRelacionados.length > 0 ? `
                    <div class="mt-6 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-calendar-days"></i>
                            Hist√≥rico de Eventos (${eventosRelacionados.length})
                        </h4>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${eventosRelacionados.map(({ pagamento, evento }) => {
                    const total = (parseFloat(pagamento.valorBase) || 0) + (parseFloat(pagamento.adicional) || 0) + (parseFloat(pagamento.horasExtras) || 0);
                    const isPago = pagamento.statusPagamento === 'Executado';
                    const statusBadge = isPago
                        ? '<span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-[10px] font-bold rounded-full">PAGO</span>'
                        : '<span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-bold rounded-full">PENDENTE</span>';

                    const motoristaInfo = pagamento.foiMotorista
                        ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full"><i class="fa-solid fa-truck-fast"></i> MOTORISTA (${pagamento.numEventos || 0} eventos)</span>`
                        : '';

                    return `
                                    <div class="bg-white p-3 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex-grow">
                                                <p class="font-bold text-gray-800 text-sm">${pagamento.data.split('-').reverse().join('/')}</p>
                                                ${evento ? `
                                                    <p class="text-xs text-gray-600 mt-1">
                                                        <i class="fa-solid fa-map-pin text-indigo-500"></i> ${evento.local}
                                                    </p>
                                                    <p class="text-xs text-gray-500">
                                                        <i class="fa-solid fa-user"></i> ${evento.contratante}
                                                    </p>
                                                    <p class="text-xs text-gray-500">
                                                        <i class="fa-solid fa-building"></i> ${evento.empresa}
                                                    </p>
                                                ` : `
                                                    <p class="text-xs text-amber-600 italic mt-1">
                                                        <i class="fa-solid fa-triangle-exclamation"></i> Evento n√£o encontrado na agenda
                                                    </p>
                                                `}
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-indigo-600 text-sm">R$ ${total.toFixed(2)}</p>
                                                <div class="flex flex-col gap-1 mt-1">
                                                    ${statusBadge}
                                                    ${motoristaInfo}
                                                </div>
                                            </div>
                                        </div>
                                        ${pagamento.horasExtras > 0 || pagamento.adicional > 0 ? `
                                            <div class="flex gap-2 mt-2 text-[10px] text-gray-500 border-t border-gray-100 pt-2">
                                                <span><strong>Base:</strong> R$ ${(parseFloat(pagamento.valorBase) || 0).toFixed(2)}</span>
                                                ${pagamento.horasExtras > 0 ? `<span><strong>HE:</strong> R$ ${(parseFloat(pagamento.horasExtras) || 0).toFixed(2)}</span>` : ''}
                                                ${pagamento.adicional > 0 ? `<span><strong>Motorista:</strong> R$ ${(parseFloat(pagamento.adicional) || 0).toFixed(2)}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="mt-6 p-6 bg-gray-50 rounded-xl border border-gray-200 text-center">
                        <i class="fa-solid fa-calendar-xmark text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500 font-medium">Nenhum evento registrado ainda.</p>
                        <p class="text-xs text-gray-400 mt-1">Os eventos aparecer√£o aqui quando houver pagamentos lan√ßados.</p>
                    </div>
                `;

                body.innerHTML = `
                    <div class="flex flex-col gap-6">
                        <div class="flex items-center gap-6">
                            <div class="w-24 h-24 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-3xl font-bold shadow-inner">
                                ${m.nome.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">${m.nome}</h3>
                                <p class="text-gray-500 font-medium">${m.telefone || 'Sem telefone'}</p>
                                <span class="inline-block mt-2 px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm font-bold border border-indigo-100">
                                    ID: #${m.id}
                                </span>
                            </div>
                        </div>

                        ${m.fotoPerfil ? `
                        <div class="w-full flex justify-center">
                            <img src="${m.fotoPerfil}" class="max-w-[200px] h-auto rounded-2xl shadow-lg border-2 border-white">
                        </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <p class="text-gray-400 uppercase font-bold text-[10px] mb-1">Informa√ß√µes Pessoais</p>
                                <p><strong>Nascimento:</strong> ${m.nascimento ? m.nascimento.split('-').reverse().join('/') : 'N√£o informada'}</p>
                                <p><strong>Email:</strong> ${m.email || 'N√£o informado'}</p>
                                <p><strong>Endere√ßo:</strong> ${m.endereco || 'N√£o informado'}</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <p class="text-gray-400 uppercase font-bold text-[10px] mb-1">Habilita√ß√£o (CNH)</p>
                                <p><strong>Possui CNH?</strong> ${m.cnh ? 'Sim' : 'N√£o'}</p>
                                ${m.cnhCategoria ? `<p><strong>Categoria:</strong> ${m.cnhCategoria}</p>` : ''}
                            </div>
                            <div class="md:col-span-2 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <p class="text-gray-400 uppercase font-bold text-[10px] mb-1">Observa√ß√µes</p>
                                <p class="italic text-gray-600">${m.observacoes || 'Nenhuma observa√ß√£o registrada.'}</p>
                            </div>
                            ${m.fotoDocumento ? `
                                <div class="md:col-span-2 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100">
                                    <p class="text-indigo-700 uppercase font-bold text-[10px] mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-id-card"></i>
                                        ${m.cnh ? 'CNH - Carteira Nacional de Habilita√ß√£o' : 'RG - Documento de Identifica√ß√£o'}
                                    </p>
                                    <div class="flex justify-center">
                                        <img src="${m.fotoDocumento}" class="max-w-full max-h-64 rounded-lg shadow-md border-2 border-white object-contain" alt="Documento">
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${historicoHTML}
                    </div>
                `;

                getById('monitor-details-modal').classList.remove('hidden');
            };

            window.editarMonitor = (id) => {
                const m = state.monitores.find(mon => mon.id === id);
                if (!m) return;

                getById('monitor-id-edit').value = m.id;
                getById('monitor-nome').value = m.nome;
                getById('monitor-nascimento').value = m.nascimento || '';
                getById('monitor-telefone').value = m.telefone || '';
                getById('monitor-email').value = m.email || '';
                getById('monitor-endereco').value = m.endereco || '';
                getById('monitor-cnh').value = m.cnh ? 'Sim' : 'N√£o possui';
                getById('monitor-cnh-categoria').value = m.cnhCategoria || '';
                getById('monitor-observacoes').value = m.observacoes || '';

                // Foto Preview
                const photoImg = getById('monitor-photo-img');
                const photoIcon = getById('monitor-photo-preview').querySelector('i');
                if (m.fotoPerfil) {
                    photoImg.src = m.fotoPerfil;
                    photoImg.classList.remove('hidden');
                    photoIcon.classList.add('hidden');
                    getById('monitor-foto-base64').value = m.fotoPerfil;
                } else {
                    photoImg.classList.add('hidden');
                    photoIcon.classList.remove('hidden');
                    getById('monitor-foto-base64').value = '';
                }

                // Documento Preview
                const docImg = getById('monitor-doc-img');
                const docPlaceholder = getById('monitor-doc-preview').querySelector('div');
                if (m.fotoDocumento) {
                    docImg.src = m.fotoDocumento;
                    docImg.classList.remove('hidden');
                    if (docPlaceholder) docPlaceholder.classList.add('hidden');
                    getById('monitor-doc-base64').value = m.fotoDocumento;
                } else {
                    docImg.classList.add('hidden');
                    if (docPlaceholder) docPlaceholder.classList.remove('hidden');
                    getById('monitor-doc-base64').value = '';
                }

                getById('modal-monitor-title').textContent = 'Editar Monitor';
                getById('add-monitor-modal').classList.remove('hidden');
            };

            window.deletarMonitor = async (id) => {
                if (!confirm('Deseja realmente excluir este monitor? Isso n√£o afetar√° o hist√≥rico de pagamentos.')) return;
                const sucesso = await window.api.deletarMonitor(id);
                if (sucesso) {
                    showToastModal('‚úÖ Monitor exclu√≠do!');
                    await window.loadDataFromCloud();
                    renderMonitorCards();
                } else {
                    showToastModal('‚ùå Erro ao excluir monitor.', true);
                }
            };

            window.toggleStatusPagamentoMonitor = async (id, currentStatus) => {
                const newStatus = currentStatus === 'Executado' ? 'Pendente' : 'Executado';

                // Busca o pagamento completo no estado para evitar erro de "partial update" no backend
                const pagamentoExistente = state.pagamentosMonitores.find(p => String(p.id) === String(id));

                if (!pagamentoExistente) {
                    showToastModal('‚ùå Registro de pagamento n√£o encontrado.', true);
                    return;
                }

                // Cria o objeto completo com o status atualizado
                const dadosParaAtualizar = {
                    ...pagamentoExistente,
                    statusPagamento: newStatus
                };

                try {
                    const sucesso = await window.api.atualizarPagamentoMonitor(id, dadosParaAtualizar);

                    if (!sucesso) throw new Error('Falha ao atualizar status no servidor');

                    showToastModal(`‚úÖ Pagamento marcado como ${newStatus === 'Executado' ? 'Pago' : 'Pendente'}`);
                    await window.loadDataFromCloud();
                } catch (error) {
                    console.error('Erro ao alternar status:', error);
                    showToastModal('‚ùå Erro ao atualizar status. O servidor retornou um erro interno.', true);
                }
            };

            window.deletarPagamentoMonitor = async (id) => {
                if (!confirm('Deseja excluir este registro de pagamento?')) return;
                const sucesso = await window.api.deletarPagamentoMonitor(id);
                if (sucesso) {
                    showToastModal('‚úÖ Pagamento exclu√≠do!');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('‚ùå Erro ao excluir pagamento.', true);
                }
            };

            // Event Listeners dos Novos Bot√µes
            getById('open-monitores-modal-btn')?.addEventListener('click', () => {
                renderMonitorCards();
                getById('modal-lista-monitores').classList.remove('hidden');
            });
            getById('open-pagamento-modal-btn')?.addEventListener('click', () => {
                const select = getById('pag-monitor-select');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um monitor...</option>' +
                        state.monitores.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                }
                getById('pag-monitor-entrada').value = '';
                getById('pag-monitor-saida').value = '';
                getById('pag-monitor-he').value = '0.00';
                const statusLabel = getById('pag-monitor-he-status');
                if (statusLabel) {
                    statusLabel.textContent = '';
                }
                // Reset motorista fields
                getById('pag-monitor-motorista').checked = false;
                getById('pag-monitor-eventos').value = '0';
                getById('pag-monitor-eventos-container').classList.add('hidden');
                getById('pag-monitor-adicional-status').textContent = '';
                getById('modal-pagamento-monitor').classList.remove('hidden');
            });

            getById('add-new-monitor-btn')?.addEventListener('click', () => {
                getById('form-cadastro-monitor').reset();
                getById('monitor-id-edit').value = '';
                getById('monitor-foto-base64').value = '';
                getById('monitor-photo-img').classList.add('hidden');
                getById('monitor-photo-preview').querySelector('i').classList.remove('hidden');
                getById('monitor-doc-base64').value = '';
                getById('monitor-doc-img').classList.add('hidden');
                const docPlaceholder = getById('monitor-doc-preview').querySelector('div');
                if (docPlaceholder) docPlaceholder.classList.remove('hidden');
                getById('modal-monitor-title').textContent = 'Novo Monitor';
                getById('add-monitor-modal').classList.remove('hidden');
            });

            // L√≥gica de Foto do Monitor
            getById('monitor-photo-preview')?.addEventListener('click', () => getById('monitor-foto-input').click());
            getById('monitor-foto-input')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    const base64 = event.target.result;
                    getById('monitor-foto-base64').value = base64;
                    const photoImg = getById('monitor-photo-img');
                    photoImg.src = base64;
                    photoImg.classList.remove('hidden');
                    getById('monitor-photo-preview').querySelector('i').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            });

            // L√≥gica de Upload de Documento (RG/CNH)
            getById('monitor-doc-preview')?.addEventListener('click', () => getById('monitor-doc-input').click());
            getById('monitor-doc-input')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // Verifica tamanho (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToastModal('‚ùå Arquivo muito grande! M√°ximo: 5MB', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (event) {
                    const base64 = event.target.result;
                    getById('monitor-doc-base64').value = base64;
                    const docImg = getById('monitor-doc-img');
                    docImg.src = base64;
                    docImg.classList.remove('hidden');
                    docImg.previousElementSibling.classList.add('hidden'); // esconde o placeholder
                };
                reader.readAsDataURL(file);
            });

            // Muda label do documento quando seleciona/desseleciona CNH
            getById('monitor-cnh')?.addEventListener('change', function () {
                const temCNH = this.value === 'Sim';
                const docTitle = getById('monitor-doc-title');
                const docType = getById('monitor-doc-type');

                if (temCNH) {
                    docTitle.innerHTML = '<i class="fa-solid fa-id-card text-indigo-600"></i> Carteira Nacional de Habilita√ß√£o (CNH)';
                    docType.textContent = 'CNH';
                } else {
                    docTitle.innerHTML = '<i class="fa-solid fa-id-card text-indigo-600"></i> Documento de Identifica√ß√£o (RG)';
                    docType.textContent = 'RG';
                }
            });

            // L√≥gica de C√°lculo de Horas Extras
            const calcularHE = () => {
                const entrada = getById('pag-monitor-entrada').value;
                const saida = getById('pag-monitor-saida').value;
                const valorDiaria = parseFloat(getById('pag-monitor-valor').value) || 0;

                if (!entrada || !saida) return;

                const [hE, mE] = entrada.split(':').map(Number);
                const [hS, mS] = saida.split(':').map(Number);

                let minEntrada = hE * 60 + mE;
                let minSaida = hS * 60 + mS;

                // Se saiu no dia seguinte
                if (minSaida < minEntrada) minSaida += 24 * 60;

                const totalMin = minSaida - minEntrada;
                const totalHoras = totalMin / 60;

                // Di√°ria base cobre 11 horas. Valor da hora = Di√°ria / 11
                const valorHora = valorDiaria / 11;
                const horasExtras = Math.max(0, totalHoras - 11);
                const valorHE = (horasExtras * valorHora).toFixed(2);

                getById('pag-monitor-he').value = valorHE;

                // Feedback visual se houver HE
                const statusLabel = getById('pag-monitor-he-status');
                if (statusLabel) {
                    statusLabel.textContent = horasExtras > 0 ? `+${horasExtras.toFixed(2)}h extra (R$ ${valorHE})` : 'Sem extras';
                    statusLabel.className = horasExtras > 0 ? 'text-[10px] font-bold text-amber-600' : 'text-[10px] text-gray-400';
                }
            };

            getById('pag-monitor-entrada')?.addEventListener('change', calcularHE);
            getById('pag-monitor-saida')?.addEventListener('change', calcularHE);
            getById('pag-monitor-valor')?.addEventListener('input', calcularHE);

            // Popular select de eventos quando data √© selecionada
            getById('pag-monitor-data')?.addEventListener('change', function () {
                const dataSelecionada = this.value;
                const eventoSelect = getById('pag-monitor-evento');

                if (!dataSelecionada || !eventoSelect) return;

                // Filtra eventos da data selecionada
                const eventosNaData = (state.eventos || []).filter(e => e.data === dataSelecionada);

                // Popula o select
                eventoSelect.innerHTML = '<option value="">Sem v√≠nculo - Trabalho avulso</option>';

                if (eventosNaData.length > 0) {
                    eventosNaData.forEach(evento => {
                        const option = document.createElement('option');
                        option.value = evento.id;
                        option.textContent = `${evento.local} - ${evento.contratante} (${evento.empresa})`;
                        eventoSelect.appendChild(option);
                    });
                }
            });

            // L√≥gica de Adicional de Motorista
            const motoristaCheckbox = getById('pag-monitor-motorista');
            const eventosContainer = getById('pag-monitor-eventos-container');
            const eventosInput = getById('pag-monitor-eventos');
            const adicionalStatus = getById('pag-monitor-adicional-status');

            motoristaCheckbox?.addEventListener('change', function () {
                if (this.checked) {
                    eventosContainer.classList.remove('hidden');
                    calcularAdicionalMotorista();
                } else {
                    eventosContainer.classList.add('hidden');
                    eventosInput.value = '0';
                    adicionalStatus.textContent = '';
                }
            });

            const calcularAdicionalMotorista = () => {
                const numEventos = parseFloat(eventosInput.value) || 0;
                const valorPorEvento = 20.00;
                const adicional = numEventos * valorPorEvento;

                if (adicionalStatus) {
                    adicionalStatus.textContent = numEventos > 0
                        ? `= R$ ${adicional.toFixed(2)} adicional`
                        : '';
                }
            };

            eventosInput?.addEventListener('input', calcularAdicionalMotorista);

            // Listeners para fechar modais de monitores
            document.querySelector('.monitor-details-close-btn')?.addEventListener('click', () => {
                getById('monitor-details-modal').classList.add('hidden');
            });
            document.querySelector('#modal-lista-monitores .text-3xl')?.addEventListener('click', () => {
                getById('modal-lista-monitores').classList.add('hidden');
            });
            document.querySelector('#modal-pagamento-monitor .text-3xl')?.addEventListener('click', () => {
                getById('modal-pagamento-monitor').classList.add('hidden');
            });
            document.querySelector('#add-monitor-modal .text-3xl')?.addEventListener('click', () => {
                getById('add-monitor-modal').classList.add('hidden');
            });

            getById('export-monitores-pdf-btn')?.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const pagamentos = (state.pagamentosMonitores || [])
                    .filter(p => p.data.startsWith(state.selectedMonth))
                    .sort((a, b) => a.data.localeCompare(b.data));

                if (pagamentos.length === 0) {
                    showToastModal('N√£o h√° pagamentos neste m√™s para exportar.', true);
                    return;
                }

                doc.setFontSize(18);
                doc.text('Relat√≥rio de Pagamentos - Monitores', 14, 20);
                doc.setFontSize(10);
                doc.text(`Per√≠odo: ${state.selectedMonth}`, 14, 28);

                const data = pagamentos.map(p => {
                    const total = (parseFloat(p.valorBase) || 0) + (parseFloat(p.adicional) || 0) + (parseFloat(p.horasExtras) || 0);
                    return [p.data, p.nome, `R$ ${p.valorBase}`, `R$ ${p.horasExtras}`, `R$ ${total.toFixed(2)}`, p.numEventos || '-'];
                });

                doc.autoTable({
                    startY: 35,
                    head: [['Data', 'Monitor', 'Base', 'H.E.', 'Total', 'Nota']],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] }
                });

                doc.save(`Pagamentos_Monitores_${state.selectedMonth}.pdf`);
                showToastModal('‚úÖ PDF gerado com sucesso!');
            });

            // Handlers de Form
            const formCadastroMonitor = getById('form-cadastro-monitor');
            console.log('üìù Form cadastro monitor encontrado:', formCadastroMonitor);

            formCadastroMonitor?.addEventListener('submit', async (e) => {
                console.log('üöÄ Submit disparado!');
                e.preventDefault();
                console.log('‚úÖ preventDefault executado');

                // Desabilita bot√£o e mostra loading
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const btnOriginalHTML = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Salvando...';

                const id = getById('monitor-id-edit').value;
                console.log('üìã ID do monitor:', id || 'NOVO');

                const dados = {
                    nome: getById('monitor-nome').value,
                    nascimento: getById('monitor-nascimento').value,
                    telefone: getById('monitor-telefone').value,
                    email: getById('monitor-email').value,
                    endereco: getById('monitor-endereco').value,
                    cnh: getById('monitor-cnh').value === 'Sim',
                    cnhCategoria: getById('monitor-cnh-categoria').value,
                    observacoes: getById('monitor-observacoes').value,
                    fotoPerfil: getById('monitor-foto-base64').value,
                    fotoDocumento: getById('monitor-doc-base64').value,
                    habilidades: JSON.stringify({ forca: 10, agilidade: 10, proatividade: 10, comunicacao: 10, disponibilidade: 10, respeito: 10 })
                };

                console.log('üì¶ Dados coletados:', dados);
                console.log('üîå window.api dispon√≠vel?', !!window.api);

                let sucesso;
                if (id) {
                    console.log('üîÑ Atualizando monitor...');
                    sucesso = await window.api.atualizarMonitor(id, dados);
                } else {
                    console.log('‚ûï Salvando novo monitor...');
                    sucesso = await window.api.salvarMonitor(dados);
                }

                console.log('‚úîÔ∏è Resultado:', sucesso);

                // Restaura bot√£o
                submitBtn.disabled = false;
                submitBtn.innerHTML = btnOriginalHTML;

                if (sucesso) {
                    showToastModal(`‚úÖ Monitor ${id ? 'atualizado' : 'cadastrado'}!`);
                    getById('add-monitor-modal').classList.add('hidden');
                    await window.loadDataFromCloud();
                    renderMonitorCards();
                } else {
                    showToastModal('‚ùå Erro ao salvar monitor.', true);
                }
            });

            getById('form-pagamento-monitor')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const editId = getById('pag-monitor-edit-id')?.value; // ID do pagamento sendo editado
                const monitorId = getById('pag-monitor-select').value;
                const monitor = state.monitores.find(m => m.id === monitorId);

                // Calcula nota m√©dia das estrelas/ranges
                const notas = [
                    parseInt(getById('nota-proatividade').value),
                    parseInt(getById('nota-cordialidade').value),
                    parseInt(getById('nota-pontualidade').value),
                    parseInt(getById('nota-lideranca').value)
                ];
                const mediaNota = (notas.reduce((a, b) => a + b, 0) / notas.length).toFixed(1);


                const valorBase = parseFloat(getById('pag-monitor-valor').value) || 0;
                const horasExtras = parseFloat(getById('pag-monitor-he').value) || 0;

                // Calcula adicional de motorista
                const foiMotorista = getById('pag-monitor-motorista').checked;
                const eventosEntregues = foiMotorista ? (parseFloat(getById('pag-monitor-eventos').value) || 0) : 0;
                const adicionalMotorista = eventosEntregues * 20.00;

                const dados = {
                    data: getById('pag-monitor-data').value,
                    dataPagamento: getById('pag-monitor-data-pagamento').value,
                    eventoId: getById('pag-monitor-evento').value || null,
                    monitorId: monitorId,
                    nome: monitor ? monitor.nome : 'Monitor Desconhecido',
                    valorBase: valorBase,
                    adicional: adicionalMotorista,
                    horasExtras: horasExtras,
                    pagamento: valorBase + adicionalMotorista + horasExtras,
                    horaEntrada: getById('pag-monitor-entrada').value,
                    horaSaida: getById('pag-monitor-saida').value,
                    statusPagamento: getById('pag-monitor-status').value,
                    foiMotorista: foiMotorista,
                    numEventos: eventosEntregues,
                    observacoes: getById('pag-monitor-obs').value
                };

                let sucesso;
                if (editId) {
                    // Modo edi√ß√£o
                    sucesso = await window.api.atualizarPagamentoMonitor(editId, dados);
                } else {
                    // Modo cria√ß√£o
                    sucesso = await window.api.salvarPagamentoMonitor(dados);
                }

                if (sucesso) {
                    showToastModal(`‚úÖ Pagamento ${editId ? 'atualizado' : 'registrado'} com sucesso!`);
                    getById('modal-pagamento-monitor').classList.add('hidden');
                    getById('form-pagamento-monitor').reset();
                    // Limpa o ID de edi√ß√£o
                    if (getById('pag-monitor-edit-id')) {
                        getById('pag-monitor-edit-id').value = '';
                    }
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('‚ùå Erro ao salvar pagamento.', true);
                }
            });

            // ========== FUN√á√ïES GLOBAIS DE DELETE ==========

            window.deletarContaBancaria = async (id) => {
                if (!confirm('Deseja realmente excluir esta conta banc√°ria?')) return;
                const sucesso = await window.api.deletarItem(id, 'accounts');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Conta banc√°ria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir conta.', true);
                }
            };

            window.deletarContaFixa = async (id) => {
                if (!confirm('Deseja realmente excluir esta conta fixa?')) return;
                const sucesso = await window.api.deletarItem(id, 'fixed-expenses');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Conta fixa exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir conta fixa.', true);
                }
            };

            window.deletarCategoriaGasto = async (id) => {
                if (!confirm('Deseja realmente excluir esta categoria?')) return;
                const sucesso = await window.api.deletarItem(id, 'categories-expenses');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Categoria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir categoria.', true);
                }
            };

            window.deletarCategoriaContaFixa = async (id) => {
                if (!confirm('Deseja realmente excluir esta categoria?')) return;
                const sucesso = await window.api.deletarItem(id, 'categories-fixed');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Categoria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir categoria.', true);
                }
            };

            // Deletar Entrada Manual (Receita)
            window.deletarEntradaManual = async (id) => {
                if (!confirm('Deseja realmente excluir esta entrada manual?')) return;
                const sucesso = await window.api.deletarItem(id, 'transactions');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Entrada manual exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir entrada manual.', true);
                }
            };

            window.deletarGasto = async (id) => {
                if (!confirm('Deseja realmente excluir este gasto?')) return;
                const sucesso = await window.api.deletarItem(id, 'transactions');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Gasto exclu√≠do com sucesso!');
                } else {
                    showToastModal('‚ùå Erro ao excluir gasto.', true);
                }
            };

            window.editarGasto = (id) => {
                const gasto = state.gastos.find(g => g.id === id);
                if (!gasto) return;

                const form = getById('form-gasto');
                const modal = getById('add-gasto-modal');

                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                getById('gasto-data').value = gasto.data;
                getById('gasto-descricao').value = gasto.descricao;
                getById('gasto-valor').value = gasto.valor;
                getById('gasto-categoria').value = gasto.categoria;
                getById('gasto-pagamento').value = gasto.pagamento;
                getById('gasto-conta').value = gasto.contaId || '';

                const btnSubmit = form.querySelector('button[type="submit"]');
                if (btnSubmit) btnSubmit.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Gasto';

                modal.classList.remove('hidden');
            };

            // ========== FUN√á√ïES GLOBAIS DE EDI√á√ÉO ==========

            window.editarContaBancaria = (id) => {
                const conta = state.contas.find(c => c.id === id);
                if (!conta) return;

                const form = document.getElementById('form-cadastro-conta');
                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                document.getElementById('cadastro-conta-nome').value = conta.nome;
                document.getElementById('cadastro-conta-banco').value = conta.banco;
                document.getElementById('cadastro-conta-tipo').value = conta.tipo;
                document.getElementById('cadastro-conta-agencia').value = conta.agencia || '';
                document.getElementById('cadastro-conta-numero').value = conta.numero || '';

                const btnSalvar = form.querySelector('button[type="submit"]');
                btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Conta';

                document.getElementById('modal-contas-bancarias').classList.remove('hidden');
            };

            window.editarContaFixa = (id) => {
                const cf = state.contasFixas.find(c => c.id === id);
                if (!cf) return;

                const form = document.getElementById('form-conta-fixa');
                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                document.getElementById('conta-fixa-descricao').value = cf.descricao;
                document.getElementById('conta-fixa-valor').value = cf.valor;
                document.getElementById('conta-fixa-dia-vencimento').value = cf.diaVencimento;
                document.getElementById('conta-fixa-categoria').value = cf.categoria;
                document.getElementById('conta-fixa-tipo-recorrencia').value = cf.tipoRecorrencia;

                // For√ßa atualiza√ß√£o dos containers de parcelamento/permanente
                // (Assumindo que o listener de change tratar√° os campos hidden)
                const event = new Event('change');
                document.getElementById('conta-fixa-tipo-recorrencia').dispatchEvent(event);

                if (cf.tipoRecorrencia === 'parcelada') {
                    document.getElementById('conta-fixa-data-inicio').value = cf.dataInicio;
                    document.getElementById('conta-fixa-num-parcelas').value = cf.numParcelas;
                }

                const btnSalvar = form.querySelector('button[type="submit"]');
                btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Conta Fixa';

                document.getElementById('modal-conta-fixa').classList.remove('hidden');
            };

            // ========== FUN√á√ÉO DE LAN√áAR GASTO DE CONTA FIXA ==========

            // ========== FUN√á√ÉO DE LAN√áAR GASTO DE CONTA FIXA ==========

            window.lancarGastoDeContaFixa = (contaFixaId) => {
                const contaFixa = state.contasFixas.find(cf => cf.id === contaFixaId);
                if (!contaFixa) return showToastModal('Conta fixa n√£o encontrada!', true);

                const modal = getById('lancamento-conta-fixa-modal');
                const form = getById('form-lancamento-conta-fixa');

                getById('lancamento-cf-descricao').value = contaFixa.descricao;
                getById('lancamento-cf-valor').value = contaFixa.valor;
                getById('lancamento-cf-data').value = new Date().toISOString().split('T')[0];

                form.setAttribute('data-id', contaFixa.id);
                modal.classList.remove('hidden');
            };

            formLancamentoCF = getById('form-lancamento-conta-fixa');
            formLancamentoCF?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const cfId = formLancamentoCF.getAttribute('data-id');
                const cf = state.contasFixas.find(c => c.id === cfId);

                const dados = {
                    date: getById('lancamento-cf-data').value,
                    description: `${getById('lancamento-cf-descricao').value} [Conta Fixa]`,
                    amount: parseFloat(getById('lancamento-cf-valor').value),
                    category: cf ? cf.category : 'Outros',
                    accountId: getById('lancamento-cf-conta').value,
                    paymentMethod: 'Transfer√™ncia/D√©bito',
                    type: 'EXPENSE'
                };

                const sucesso = await window.api.salvarTransacao(dados);
                if (sucesso) {
                    showToastModal('‚úÖ Gasto de conta fixa lan√ßado!');
                    getById('lancamento-conta-fixa-modal').classList.add('hidden');
                    if (window.loadDataFromCloud) await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao lan√ßar gasto.', true);
                }
            });

            // ESC para fechar novo modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    getById('lancamento-conta-fixa-modal')?.classList.add('hidden');
                }
            });

            // Fechar ao clicar fora
            const modalLCF = getById('lancamento-conta-fixa-modal');
            modalLCF?.addEventListener('click', (e) => {
                if (e.target === modalLCF) modalLCF.classList.add('hidden');
            });

            // Close button de todos os modais (generic)
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.fixed')?.classList.add('hidden');
                    btn.closest('.modal-backdrop')?.classList.add('hidden');
                });
            });

            // NOTA: Fun√ß√£o auxiliar para filtrar contas fixas ativas em um m√™s
            const getContasFixasDoMes = (mesAno) => {
                if (!state.contasFixas || state.contasFixas.length === 0) return [];

                const [ano, mes] = mesAno.split('-').map(Number);

                return state.contasFixas.filter(cf => {
                    // Se for permanente, sempre aparece
                    if (cf.tipoRecorrencia === 'permanente') return true;

                    // Se for parcelada, verifica se est√° no intervalo
                    if (cf.tipoRecorrencia === 'parcelada' && cf.dataInicio && cf.numParcelas) {
                        const [anoInicio, mesInicio] = cf.dataInicio.split('-').map(Number);
                        const dataInicio = new Date(anoInicio, mesInicio - 1);
                        const dataFim = new Date(anoInicio, mesInicio - 1 + cf.numParcelas);
                        const dataAtual = new Date(ano, mes - 1);

                        return dataAtual >= dataInicio && dataAtual < dataFim;
                    }

                    return false;
                });
            };

            // --- 3. EXPORTAR PDF ELEGANTE (Integrado) ---
            const exportarGastosPDF = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

                    // Filtra dados do m√™s atual
                    const gastosFiltrados = state.gastos
                        .filter(g => g.data.startsWith(state.selectedMonth))
                        .sort((a, b) => new Date(a.data) - new Date(b.data));

                    if (gastosFiltrados.length === 0) {
                        showToast("N√£o h√° gastos neste m√™s para exportar.", true);
                        return;
                    }

                    // --- Cabe√ßalho Elegante ---
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(20);
                    doc.setTextColor(63, 81, 181);
                    doc.text('Relat√≥rio de Gastos', 40, 55);

                    doc.setDrawColor(79, 70, 229);
                    doc.setLineWidth(1);
                    doc.line(40, 65, 555, 65);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(90, 90, 90);
                    doc.text(`Empresa: Aero & ABC Festas`, 40, 80);

                    const [ano, mes] = state.selectedMonth.split('-');
                    doc.text(`Per√≠odo: ${mes}/${ano}`, 40, 95);

                    // Prepara dados para a tabela
                    const tableColumn = ["Data", "Descri√ß√£o", "Categoria", "Pgto", "Valor"];
                    const tableRows = [];
                    let total = 0;

                    gastosFiltrados.forEach(g => {
                        total += parseFloat(g.valor || 0);
                        tableRows.push([
                            formatarData(g.data),
                            g.descricao,
                            g.categoria,
                            g.pagamento,
                            { content: formatarMoeda(g.valor), styles: { halign: 'right', fontStyle: 'bold', textColor: [220, 38, 38] } } // Vermelho para gastos
                        ]);
                    });

                    // Linha de Total
                    tableRows.push([
                        { content: "TOTAL GERAL", colSpan: 4, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
                        { content: formatarMoeda(total), styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }
                    ]);

                    // --- Tabela Estilizada ---
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 115,
                        theme: 'grid',
                        styles: { fontSize: 10, cellPadding: 6, lineColor: [220, 220, 220], textColor: [40, 40, 40] },
                        headStyles: { fillColor: [63, 81, 181], textColor: 255, fontStyle: 'bold', halign: 'center' },
                        columnStyles: { 4: { halign: 'right' } }, // Alinha valor √† direita
                        alternateRowStyles: { fillColor: [250, 250, 255] },
                        margin: { left: 40, right: 40 },
                    });

                    // Rodap√©
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(9);
                        doc.setTextColor(150);
                        doc.text(`P√°gina ${i} de ${pageCount}`, doc.internal.pageSize.width - 80, doc.internal.pageSize.height - 20);
                    }

                    doc.save(`Relatorio_Gastos_${state.selectedMonth}.pdf`);
                    showToast("PDF gerado com sucesso!", false);

                } catch (err) {
                    console.error('Erro PDF:', err);
                    showToast('Erro ao gerar PDF.', true);
                }
            };

            // --- LISTENERS ---
            getById('export-gastos-pdf-btn').addEventListener('click', exportarGastosPDF);

            getById('month-filter-global').addEventListener('change', (e) => {
                state.selectedMonth = e.target.value;
                renderAll();
            });

            // Setas de navega√ß√£o de m√™s
            document.querySelectorAll('.month-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dir = parseInt(btn.dataset.direction);
                    const [y, m] = state.selectedMonth.split('-').map(Number);
                    const newDate = new Date(y, m - 1 + dir, 1);
                    state.selectedMonth = newDate.toISOString().slice(0, 7);
                    renderAll();
                });
            });

            // Fun√ß√µes Auxiliares j√° definidas no topo do script
            const showToast = (msg, isError) => {
                const toast = getById('toast');
                if (toast) {
                    getById('toast-message').textContent = msg;
                    toast.className = `fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
                    toast.classList.remove('hidden');
                    setTimeout(() => toast.classList.add('hidden'), 3000);
                }
            };

            // ========== NAVEGA√á√ÉO ENTRE ABAS ==========
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetPage = link.getAttribute('data-target');
                    navLinks.forEach(l => {
                        l.classList.remove('active', 'shiny-btn');
                        l.classList.add('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    });
                    link.classList.add('active', 'shiny-btn');
                    link.classList.remove('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    pages.forEach(page => page.classList.remove('active'));
                    const selectedPage = document.getElementById(`page-${targetPage}`);
                    if (selectedPage) selectedPage.classList.add('active');
                });
            });

            // Fechar modais ao clicar no X ou fora
            document.querySelectorAll('.close-btn, .modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    if (modal) modal.classList.add('hidden');
                });
            });

            // Limpar erros ao digitar
            const setupInputListeners = (form) => {
                if (!form) return;
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        input.classList.remove('error', 'border-red-500');
                    });
                });
            };

            // ========== HANDLER PARA ENTRADA MANUAL DE RECEITA (MODAL) ==========
            const btnEntrada = document.getElementById('open-entrada-modal-btn');
            const modalEntrada = document.getElementById('modal-entrada-manual');
            const formEntrada = document.getElementById('form-entrada-manual');

            if (btnEntrada && modalEntrada && formEntrada) {
                btnEntrada.addEventListener('click', () => {
                    modalEntrada.style.display = 'flex';
                    modalEntrada.classList.remove('hidden');
                    document.getElementById('entrada-data').value = new Date().toISOString().split('T')[0];
                    document.getElementById('entrada-descricao').value = '';
                    document.getElementById('entrada-valor').value = '';
                });

                formEntrada.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const data = document.getElementById('entrada-data').value;
                    const descricao = document.getElementById('entrada-descricao').value.trim();
                    const valor = parseFloat(document.getElementById('entrada-valor').value);

                    if (!data || !descricao || isNaN(valor) || valor <= 0) {
                        showToastModal('Por favor, preencha todos os campos corretamente.', true);
                        return;
                    }

                    const novaReceita = {
                        date: data,
                        description: descricao,
                        amount: valor,
                        type: 'REVENUE',
                        category: 'Receita Avulsa',
                        paymentMethod: 'Entrada Manual'
                    };

                    const sucesso = await window.api.salvarTransacao(novaReceita);
                    if (sucesso) {
                        modalEntrada.style.display = 'none';
                        modalEntrada.classList.add('hidden');
                        await window.loadDataFromCloud();
                        showToastModal(`‚úÖ Entrada registrada: ${descricao}`);
                    } else {
                        showToastModal('Erro ao salvar entrada.', true);
                    }
                });
            }

            // Elementos dos modais
            const modalContaFixa = document.getElementById('modal-conta-fixa');
            const modalCategoriasCF = document.getElementById('modal-categorias-cf');
            const btnAbrirContaFixa = document.getElementById('open-conta-fixa-modal-btn');
            const btnAbrirCategorias = document.getElementById('open-categorias-cf-modal-btn');
            const btnFecharContaFixa = document.getElementById('close-conta-fixa-modal');
            const btnFecharCategorias = document.getElementById('close-categorias-cf-modal');
            const btnLimparContaFixa = document.getElementById('limpar-conta-fixa-btn');
            const formContaFixa = document.getElementById('form-conta-fixa');
            const formCategoria = document.getElementById('form-conta-fixa-categoria');

            // Abrir modal de Cadastrar Conta Fixa
            btnAbrirContaFixa?.addEventListener('click', () => {
                formContaFixa.reset();
                formContaFixa.removeAttribute('data-mode');
                formContaFixa.removeAttribute('data-id');
                const btnSalvar = formContaFixa.querySelector('button[type="submit"]');
                if (btnSalvar) btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Salvar Conta Fixa';
                modalContaFixa.classList.remove('hidden');
            });

            // Bot√£o Limpar formul√°rio de Conta Fixa
            btnLimparContaFixa?.addEventListener('click', () => {
                if (confirm('Deseja limpar todos os campos do formul√°rio?')) {
                    formContaFixa.reset();
                    formContaFixa.querySelectorAll('.error, .border-red-500').forEach(input => {
                        input.classList.remove('error', 'border-red-500');
                    });
                    showToastModal('Formul√°rio limpo com sucesso!');
                }
            });

            // Valida√ß√£o ao submeter Conta Fixa
            formContaFixa?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formContaFixa)) {
                    showToastModal('Por favor, preencha todos os campos obrigat√≥rios', true);
                    return;
                }

                const mode = formContaFixa.getAttribute('data-mode');
                const id = formContaFixa.getAttribute('data-id');

                const dados = {
                    description: document.getElementById('conta-fixa-descricao').value,
                    amount: parseFloat(document.getElementById('conta-fixa-valor').value),
                    dueDay: parseInt(document.getElementById('conta-fixa-dia-vencimento').value),
                    category: document.getElementById('conta-fixa-categoria').value,
                    recurrenceType: document.getElementById('conta-fixa-tipo-recorrencia').value
                };

                if (dados.recurrenceType === 'parcelada') {
                    dados.startDate = document.getElementById('conta-fixa-data-inicio').value;
                    dados.installments = parseInt(document.getElementById('conta-fixa-num-parcelas').value);
                }

                let sucesso;
                if (mode === 'edit' && id) {
                    sucesso = await window.api.atualizarContaFixa(id, dados);
                } else {
                    sucesso = await window.api.salvarContaFixa(dados);
                }

                if (sucesso) {
                    showToastModal(mode === 'edit' ? 'Conta Fixa atualizada!' : 'Conta Fixa cadastrada com sucesso!');
                    formContaFixa.reset();
                    modalContaFixa.classList.add('hidden');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar Conta Fixa', true);
                }
            });

            // ========== HANDLER PARA NOVO GASTO (MODAL) ==========
            const formGasto = getById('form-gasto');
            if (formGasto) {
                formGasto.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const mode = formGasto.getAttribute('data-mode');
                    const id = formGasto.getAttribute('data-id');

                    const data = getById('gasto-data').value;
                    const descricao = getById('gasto-descricao').value.trim();
                    const valor = parseFloat(getById('gasto-valor').value);
                    const categoria = getById('gasto-categoria').value;
                    const metodo = getById('gasto-pagamento').value;
                    const contaId = getById('gasto-conta').value;

                    if (!data || !descricao || isNaN(valor) || valor <= 0) {
                        showToastModal('Preencha os campos obrigat√≥rios corretamente.', true);
                        return;
                    }

                    const dadosGasto = {
                        date: data,
                        description: descricao,
                        amount: valor,
                        type: 'EXPENSE',
                        category: categoria,
                        paymentMethod: metodo,
                        accountId: contaId
                    };

                    let sucesso;
                    if (mode === 'edit' && id) {
                        sucesso = await window.api.atualizarTransacao(id, dadosGasto);
                    } else {
                        sucesso = await window.api.salvarTransacao(dadosGasto);
                    }

                    if (sucesso) {
                        showToastModal(mode === 'edit' ? '‚úÖ Gasto atualizado!' : '‚úÖ Gasto registrado!');
                        formGasto.reset();
                        hideModal('add-gasto-modal');
                        await window.loadDataFromCloud();
                    } else {
                        showToastModal('Erro ao salvar gasto.', true);
                    }
                });
            }

            // ========== NOVOS MODAIS: Contas Banc√°rias e Categorias de Gastos ==========
            const modalContasBancarias = getById('modal-contas-bancarias');
            const modalCategoriasGastos = getById('modal-categorias-gastos');
            const btnAbrirContasBancarias = getById('open-contas-bancarias-modal-btn');
            const btnAbrirCategoriasGastos = getById('open-categorias-gastos-modal-btn');
            const btnLimparContaBancaria = getById('limpar-conta-bancaria-btn');
            const formContaBancaria = getById('form-cadastro-conta');
            const formCategoriaGasto = getById('form-gasto-categoria');

            btnAbrirContasBancarias?.addEventListener('click', () => {
                formContaBancaria.reset();
                formContaBancaria.removeAttribute('data-mode');
                formContaBancaria.removeAttribute('data-id');
                const btnSalvar = formContaBancaria.querySelector('button[type="submit"]');
                if (btnSalvar) btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Salvar Conta';
                showModal('modal-contas-bancarias');
            });

            btnAbrirCategoriasGastos?.addEventListener('click', () => showModal('modal-categorias-gastos'));

            btnLimparContaBancaria?.addEventListener('click', () => {
                if (confirm('Deseja limpar todos os campos do formul√°rio?')) {
                    formContaBancaria.reset();
                    formContaBancaria.querySelectorAll('.error, .border-red-500').forEach(input => {
                        input.classList.remove('error', 'border-red-500');
                    });
                    showToastModal('Formul√°rio limpo com sucesso!');
                }
            });

            // Valida√ß√£o Conta Banc√°ria
            formContaBancaria?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formContaBancaria)) {
                    showToastModal('Por favor, preencha todos os campos obrigat√≥rios', true);
                    return;
                }

                const mode = formContaBancaria.getAttribute('data-mode');
                const id = formContaBancaria.getAttribute('data-id');

                const dados = {
                    name: getById('cadastro-conta-nome').value,
                    bank: getById('cadastro-conta-banco').value,
                    type: getById('cadastro-conta-tipo').value,
                    agency: getById('cadastro-conta-agencia').value,
                    number: getById('cadastro-conta-numero').value
                };

                let sucesso;
                if (mode === 'edit' && id) {
                    sucesso = await window.api.atualizarConta(id, dados);
                } else {
                    sucesso = await window.api.salvarConta(dados);
                }

                if (sucesso) {
                    showToastModal(mode === 'edit' ? 'Conta banc√°ria atualizada!' : 'Conta banc√°ria cadastrada com sucesso!');
                    formContaBancaria.reset();
                    hideModal('modal-contas-bancarias');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar conta bancaria', true);
                }
            });



            // Handlers para categorias
            getById('form-conta-fixa-categoria')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = getById('cf-categoria-nome');
                if (!input.value.trim()) return;
                const sucesso = await window.api.salvarCategoriaFixa(input.value.trim());
                if (sucesso) {
                    showToastModal('Categoria criada!');
                    input.value = '';
                    await window.loadDataFromCloud();
                }
            });

            getById('form-gasto-categoria')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = getById('gasto-categoria-nome');
                if (!input.value.trim()) return;
                const sucesso = await window.api.salvarCategoriaGasto(input.value.trim());
                if (sucesso) {
                    showToastModal('Categoria criada!');
                    input.value = '';
                    await window.loadDataFromCloud();
                }
            });

            // ========== HANDLERS PARA CONFIGURA√á√ïES DE SAL√ÅRIOS ==========
            const formAddFuncionario = getById('form-add-funcionario');
            formAddFuncionario?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formAddFuncionario)) return;

                const dados = {
                    nome: getById('funcionario-nome').value,
                    salarioFixo: parseFloat(getById('funcionario-salario').value),
                    va: parseFloat(getById('funcionario-va').value),
                    vt: parseFloat(getById('funcionario-vt').value)
                };

                const sucesso = await window.api.salvarFuncionario(dados);
                if (sucesso) {
                    showToastModal('Funcion√°rio cadastrado!');
                    formAddFuncionario.reset();
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar funcion√°rio', true);
                }
            });

            const formAddComissao = getById('form-add-comissao');
            formAddComissao?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formAddComissao)) return;

                const dados = {
                    ateValor: parseFloat(getById('comissao-atevalor').value),
                    percentual: parseFloat(getById('comissao-percentual').value) / 100
                };

                const sucesso = await window.api.salvarFaixaComissao(dados);
                if (sucesso) {
                    showToastModal('Faixa de comiss√£o cadastrada!');
                    formAddComissao.reset();
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar faixa', true);
                }
            });

            // Setup listeners para remover erros
            setupInputListeners(formContaFixa);
            setupInputListeners(formContaBancaria);
            setupInputListeners(formGasto);
            setupInputListeners(getById('form-cadastro-monitor'));
            setupInputListeners(formAddFuncionario);
            setupInputListeners(formAddComissao);
            if (formLancamentoCF) setupInputListeners(formLancamentoCF);

            // Fechar ao clicar fora (modais espec√≠ficos)
            [modalContaFixa, modalCategoriasCF, modalContasBancarias, modalCategoriasGastos].forEach(modal => {
                modal?.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.add('hidden');
                });
            });

            // Toggle Menu de Configura√ß√µes de Gastos
            const btnToggleConfig = getById('gastos-config-toggle');
            const menuConfig = getById('gastos-config-menu');

            btnToggleConfig?.addEventListener('click', (e) => {
                e.stopPropagation();
                menuConfig.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                menuConfig?.classList.add('hidden');
            });

            // ESC para fechar tudo
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.fixed.z-50').forEach(m => m.classList.add('hidden'));
                    menuConfig?.classList.add('hidden');
                }
            });

            // INICIA TUDO
            loadDataFromCloud();
        });
    </script>



    <style>
        :root {
            --glow-color: hsl(224, 88%, 66%);
            --primary: #4f46e5;
            --secondary: #a855f7;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-muted: #6b7280;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1f2937;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .header-title {
            background: linear-gradient(to right, #4f46e5, #a855f7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .modal-box.glassmorphism {
            background: rgba(255, 255, 255, 0.85);
        }

        .shiny-btn {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 51%, #4f46e5 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(60, 78, 224, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(60, 78, 224, 0.6);
        }

        .shiny-btn-red {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #dc2626 0%, #ef4444 51%, #dc2626 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(239, 68, 68, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn-red:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(239, 68, 68, 0.6);
        }

        /* Estilos para controle de p√°ginas/abas */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .shiny-btn-red:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .shiny-btn:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .form-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #1f2937;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4f46e5;
            border-color: #4f46e5;
        }

        /* Page transitions */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom styles for tables */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(200, 200, 200, 0.5);
        }

        thead th {
            background-color: rgba(236, 240, 241, 0.5);
            font-weight: 600;
            color: #374151;
        }

        tbody tr:hover {
            background-color: rgba(243, 244, 246, 0.4);
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: color 0.2s;
            padding: 0;
        }

        .delete-btn {
            color: #ef4444;
        }

        .delete-btn:hover {
            color: #b91c1c;
        }

        .edit-btn {
            color: #f59e0b;
        }

        .edit-btn:hover {
            color: #b45309;
        }

        .action-btn:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Gemini Button Style Modernized */
        .gemini-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .gemini-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
            filter: brightness(1.1);
        }

        .gemini-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
            transition: 0.5s;
            pointer-events: none;
        }

        .gemini-btn:hover::after {
            left: 120%;
        }

        /* Dashboard Stat Cards Improvements */
        .dashboard-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .dashboard-card.receita {
            border-left-color: #10b981;
        }

        .dashboard-card.despesa {
            border-left-color: #ef4444;
        }

        .dashboard-card.saldo {
            border-left-color: #3b82f6;
        }

        .dashboard-card.ia {
            border-left-color: #8b5cf6;
        }

        .stat-icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover .stat-icon-bg {
            opacity: 0.1;
            transform: scale(1.1) rotate(0deg);
        }

        /* Anima√ß√£o de Digita√ß√£o para Placeholder */
        @keyframes typing-placeholder {

            0%,
            100% {
                placeholder: "Cole sua chave aqui";
            }

            20% {
                placeholder: "C";
            }

            25% {
                placeholder: "Co";
            }

            30% {
                placeholder: "Col";
            }

            35% {
                placeholder: "Cole";
            }

            40% {
                placeholder: "Cole ";
            }

            45% {
                placeholder: "Cole s";
            }

            50% {
                placeholder: "Cole su";
            }

            55% {
                placeholder: "Cole sua";
            }

            60% {
                placeholder: "Cole sua ";
            }

            70% {
                placeholder: "Cole sua ch";
            }

            80% {
                placeholder: "Cole sua cha";
            }

            90% {
                placeholder: "Cole sua chav";
            }

            95% {
                placeholder: "Cole sua chave";
            }
        }

        .form-input::placeholder {
            color: #d1d5db !important;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .form-input:focus::placeholder {
            opacity: 0;
        }

        .modal-backdrop {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        /* Valida√ß√£o de Formul√°rio */
        .form-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .form-input.error:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }


        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Animation */
        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-enter {
            animation: toast-in 0.5s ease-out forwards;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        /* Estilos do Menu de Monitores */
        #monitors-sidebar.collapsed {
            width: 0px;
            padding: 0;
            overflow: hidden;
            margin-left: -1.5rem;
            /* Compensa o gap */
        }

        #monitors-sidebar.collapsed .sidebar-content {
            opacity: 0;
        }

        #sidebar-toggle-btn.collapsed .fa-chevron-left {
            transform: rotate(180deg);
        }

        #monitors-sidebar-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: #374151;
        }

        #monitors-sidebar-list a:hover {
            background-color: rgba(230, 230, 245, 0.7);
        }

        /* Abas de Configura√ß√£o de Sal√°rio */
        .config-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .config-tab-btn.active {
            background-color: white;
            color: #4f46e5;
            border-color: #4f46e5;
        }

        .config-tab-btn:not(.active) {
            background-color: transparent;
            color: #4b5563;
        }

        .config-tab-content {
            display: none;
        }

        .config-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* [ULTRA-PREMIUM] Estilos para Bottom Navigation Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            height: 76px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 12px;
            z-index: 10000;
            border-radius: 28px;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.05),
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 20px 25px -5px rgba(0, 0, 0, 0.05),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        /* Efeito Hologr√°fico Shimmer */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: skewX(-25deg);
            animation: shimmer 6s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            30% {
                left: 200%;
            }

            100% {
                left: 200%;
            }
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
        }

        .nav-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #64748b;
            width: 70px;
            height: 100%;
            text-decoration: none;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* The Pill - Fundo do Item Ativo */
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: -1;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 16px rgba(79, 70, 229, 0.3);
        }

        .nav-item.active {
            color: white;
            transform: translateY(-8px);
        }

        .nav-item.active::before {
            transform: translate(-50%, -60%) scale(1);
            opacity: 1;
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 2px;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-item span {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .nav-item.active span {
            opacity: 1;
            transform: translateY(2px);
            color: var(--primary);
            /* Texto abaixo da p√≠lula */
            background: white;
            padding: 2px 6px;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item:active {
            transform: scale(0.9) translateY(0);
        }

        /* [NEW] Ajuste para Toast no Mobile n√£o sobrepor a Nav */
        @media (max-width: 1023px) {
            #gemini-toast {
                bottom: 100px !important;
            }
        }

        /* Monitor Cards Style */
        .monitor-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }

        .monitor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.7);
            border-color: var(--primary);
        }

        .monitor-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--primary);
            font-size: 1.25rem;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .btn-action-small {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-action-small:hover {
            transform: scale(1.1);
        }

        @media (max-width: 640px) {
            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }

            .grid-cols-1 {
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <canvas id="particles-js"></canvas>

    <div class="container mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl header-title">Gest√£o Financeira</h1>
            <p class="text-gray-500 mt-2">Aero & ABC Festas</p>
            <div class="absolute top-0 left-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Dashboard.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Dashboard">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
            <div class="absolute top-0 right-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Agenda de eventos.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Agenda de Eventos">
                    <i class="fa-solid fa-calendar-days"></i>
                </button>
                <button onclick="window.location.href='./Sistema Gest√£o Financeira.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Gest√£o Financeira">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button onclick="window.location.href='./Sistema de CRM.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar CRM">
                    <i class="fas fa-users"></i>
                </button>
                <button id="settings-btn"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Configura√ß√µes">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <nav class="flex justify-center mb-8 space-x-1 md:space-x-2 flex-wrap">
            <button data-target="dashboard"
                class="nav-link active shiny-btn px-4 py-2 rounded-md text-sm md:text-base mb-2"><i
                    class="fa-solid fa-chart-pie mr-2"></i> Dashboard</button>
            <button data-target="entradas"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-calendar-check mr-2"></i> Entradas</button>
            <button data-target="gastos"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-cart-shopping mr-2"></i> Gastos</button>
            <button data-target="contas-fixas"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-file-invoice-dollar mr-2"></i> Contas Fixas</button>
            <button data-target="monitores"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-users mr-2"></i> Monitores</button>
            <button data-target="salarios"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-money-bill-wave mr-2"></i> Sal√°rios</button>
        </nav>

        <div class="month-filter-container glassmorphism p-4 rounded-lg mb-8 flex justify-center items-center gap-4">
            <button
                class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg"
                data-direction="-1">&lt;</button>
            <input type="month"
                class="month-filter form-input text-center font-semibold text-indigo-600 border-none shadow-inner"
                id="month-filter-global">
            <button
                class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg"
                data-direction="1">&gt;</button>
        </div>

        <main>
            <div id="page-dashboard" class="page active">
                <section id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card receita">
                        <i class="fa-solid fa-arrow-up stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-arrow-up text-emerald-500"></i> Receitas do M√™s
                        </h3>
                        <p id="total-receitas" class="text-4xl font-bold text-emerald-600">R$ 0,00</p>
                        <div id="receitas-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card despesa">
                        <i class="fa-solid fa-arrow-down stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-arrow-down text-red-500"></i> Despesas do M√™s
                        </h3>
                        <p id="total-despesas" class="text-4xl font-bold text-red-500">R$ 0,00</p>
                        <div id="despesas-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card saldo">
                        <i class="fa-solid fa-scale-balanced stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-building-columns text-blue-500"></i> Saldo do M√™s
                        </h3>
                        <p id="saldo-total" class="text-4xl font-bold text-blue-600">R$ 0,00</p>
                        <div id="saldo-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div
                        class="glassmorphism p-6 rounded-lg text-center flex flex-col justify-center items-center dashboard-card ia">
                        <i class="fa-solid fa-wand-magic-sparkles stat-icon-bg"></i>
                        <h3 class="font-bold text-indigo-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-robot"></i> Intelig√™ncia Aero
                        </h3>
                        <button onclick="openChat('dashboard')" class="gemini-btn w-full">
                            <i class="fa-solid fa-sparkles"></i> Gerar Insights
                        </button>
                    </div>
                </section>
                <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Receita por Empresa (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="empresas-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Distribui√ß√£o de Despesas (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="despesas-gerais-chart"></canvas>
                        </div>
                    </div>
                    <!-- Gr√°fico de Gastos & Compras removido por ser desnecess√°rio -->
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Contas Fixas (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="contas-fixas-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Pagamentos Monitores (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="pagamentos-monitores-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg lg:col-span-2">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Fluxo de Caixa Di√°rio (M√™s)</h3>
                        <div style="position: relative; height: 400px;">
                            <canvas id="daily-chart"></canvas>
                        </div>
                    </div>
                </section>
            </div>

            <div id="page-entradas" class="page">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Entradas Registradas no M√™s</h2>
                        <button id="open-entrada-modal-btn" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-plus mr-2"></i> Nova Entrada Manual</button>
                        <button id="export-entradas-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md mr-2">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>

                    </div>
                    <p class="text-sm text-gray-500 mb-4">Entradas marcadas com üìÖ foram importadas automaticamente da
                        Agenda de Eventos.</p>
                    <div class="table-wrapper">
                        <table id="tabela-eventos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Empresa</th>
                                    <th>Contratante</th>
                                    <th>Local</th>
                                    <th>Itens</th>
                                    <th>Valor Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="page-gastos" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Gastos Registrados no M√™s</h2>
                        <div class="flex items-center gap-2">
                            <button id="open-gasto-modal-btn" class="shiny-btn px-4 py-2 rounded-md"><i
                                    class="fa-solid fa-plus mr-2"></i> Lan√ßar Novo Gasto</button>
                            <button id="export-gastos-pdf-btn"
                                class="shiny-btn-red px-4 py-2 rounded-md text-sm md:text-base">
                                <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                            </button>
                            <button onclick="openChat('gastos')" class="gemini-btn"><i
                                    class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analisar com IA</button>

                            <div class="relative inline-block text-left ml-2">
                                <button id="gastos-config-toggle"
                                    class="bg-white/40 hover:bg-white/60 text-gray-600 w-10 h-10 rounded-full transition-colors flex items-center justify-center"
                                    title="Configura√ß√µes de Gastos">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                                <div id="gastos-config-menu"
                                    class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-20 overflow-hidden transform transition-all duration-200 origin-top-right">
                                    <div class="py-1" role="menu">
                                        <button id="open-categorias-gastos-modal-btn"
                                            class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"
                                            role="menuitem">
                                            <i class="fa-solid fa-tags w-5 mr-2"></i> Categorias de Gastos
                                        </button>
                                        <button id="open-contas-bancarias-modal-btn"
                                            class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"
                                            role="menuitem">
                                            <i class="fa-solid fa-building-columns w-5 mr-2"></i> Contas Banc√°rias
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="tabela-gastos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Categoria</th>
                                    <th>Conta</th>
                                    <th>Pagamento</th>
                                    <th>Valor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Se√ß√£o de configura√ß√µes removida e movida para o √≠cone de engrenagem no cabe√ßalho -->
            </div>

            <div id="page-contas-fixas" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Contas Fixas</h2>
                        <div class="flex gap-2">
                            <button id="open-categorias-cf-modal-btn" class="shiny-btn-outline px-4 py-2 rounded-md"
                                title="Gerenciar Categorias">
                                <i class="fa-solid fa-gear mr-2"></i> Categorias
                            </button>
                            <button id="open-conta-fixa-modal-btn" class="shiny-btn px-4 py-2 rounded-md">
                                <i class="fa-solid fa-plus mr-2"></i> Cadastrar Conta Fixa
                            </button>
                        </div>
                    </div>
                </section>
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lan√ßamento de Contas Fixas do M√™s</h2>
                    <p class="text-sm text-gray-500 mb-4">Aqui s√£o listadas as contas (permanentes ou parcelas) ativas
                        para o m√™s selecionado.</p>
                    <div class="table-wrapper" id="contas-fixas-cards-container">
                        <!-- Os cards ser√£o gerados dinamicamente aqui -->
                        <table id="tabela-contas-fixas-mes" class="hidden">
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor Previsto</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Valor Pago</th>
                                    <th>Data Pag.</th>
                                    <th class="text-center"><i class="fa-solid fa-paperclip"></i></th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="page-monitores" class="page">
                <div class="space-y-6">
                    <!-- Cabe√ßalho Simplificado -->
                    <div class="glassmorphism p-6 rounded-lg text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Gest√£o de Monitores</h2>
                        <p class="text-gray-500 mb-6 font-medium">Gerencie sua equipe e realize pagamentos de forma
                            r√°pida.</p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
                            <!-- Bot√£o 1: Ver Monitores -->
                            <button id="open-monitores-modal-btn"
                                class="shiny-btn p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-transform hover:scale-105 active:scale-95">
                                <i class="fa-solid fa-users-viewfinder text-3xl"></i>
                                <span class="text-lg font-bold">Monitores Cadastrados</span>
                            </button>

                            <!-- Bot√£o 2: Lan√ßar Pagamento -->
                            <button id="open-pagamento-modal-btn"
                                class="gemini-btn p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-transform hover:scale-105 active:scale-95">
                                <i class="fa-solid fa-hand-holding-dollar text-3xl"></i>
                                <span class="text-lg font-bold">Lan√ßar Pagamento & Avalia√ß√£o</span>
                            </button>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Hist√≥rico (Vis√≠vel por padr√£o, mas compacta para mobile) -->
                    <section class="glassmorphism p-6 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fa-solid fa-history mr-2 text-indigo-500"></i>Hist√≥rico de Pagamentos
                            </h3>
                            <button id="export-monitores-pdf-btn"
                                class="shiny-btn-red px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-file-pdf"></i> Exportar Relat√≥rio
                            </button>
                        </div>

                        <div class="table-wrapper">
                            <table id="tabela-pagamentos-monitores" class="w-full">
                                <thead>
                                    <tr>
                                        <th class="w-10">
                                            <input type="checkbox" id="select-all-pagamentos"
                                                class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                        </th>
                                        <th>Data</th>
                                        <th>Monitor</th>
                                        <th class="hidden sm:table-cell">Base</th>
                                        <th class="hidden sm:table-cell">HE</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Preenchido via JS -->
                                </tbody>
                                <tfoot class="hidden border-t-2 border-indigo-100">
                                    <!-- Preenchido via JS -->
                                </tfoot>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
            <div id="page-salarios" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">C√°lculo de Sal√°rio</h2>
                        <button id="open-salarios-config-modal-btn" class="gemini-btn px-4 py-2 rounded-md">
                            <i class="fa-solid fa-gear mr-2"></i> Configura√ß√µes
                        </button>
                        <button id="export-salarios-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>
                    </div>

                    <div class="mb-6">
                        <label for="salario-funcionario-select"
                            class="block text-sm font-medium text-gray-700 mb-1">Selecionar
                            Funcion√°rio</label>
                        <select id="salario-funcionario-select" class="form-input w-full max-w-md"></select>
                    </div>

                    <div id="salario-calculo-container" class="hidden">
                        <h3 id="salario-nome-funcionario" class="text-xl font-bold text-gray-800 mb-6"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i
                                        class="fa-solid fa-arrow-up mr-2 text-emerald-500"></i>Entradas Totais (M√™s)
                                </h3>
                                <p id="salario-total-entradas" class="text-3xl font-bold text-emerald-600">R$ 0,00</p>
                            </div>

                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i
                                        class="fa-solid fa-percentage mr-2 text-indigo-500"></i>Comiss√£o Calculada</h3>
                                <p id="salario-comissao" class="text-3xl font-bold text-indigo-600">R$ 0,00</p>
                                <p id="salario-comissao-percentual" class="text-sm text-gray-500 mt-1">Faixa de 0%</p>
                            </div>

                            <div class="glassmorphism p-5 rounded-lg border-2 border-green-300 bg-green-50/30">
                                <h3 class="font-semibold text-gray-700 mb-2"><i
                                        class="fa-solid fa-sack-dollar mr-2 text-green-600"></i>Sal√°rio Total a Pagar
                                </h3>
                                <p id="salario-total-pagar" class="text-3xl font-bold text-green-700">R$ 0,00</p>
                            </div>
                        </div>

                        <div class="bg-white/50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Detalhamento do Sal√°rio</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Sal√°rio Fixo</span>
                                    <span id="salario-fixo" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Alimenta√ß√£o (VA)</span>
                                    <span id="salario-va" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Transporte (VT)</span>
                                    <span id="salario-vt" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div
                                    class="flex justify-between items-center p-3 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                                    <span class="text-blue-800">Comiss√£o (Baseada nas Entradas)</span>
                                    <span id="salario-comissao-detalhe" class="font-bold text-blue-800">R$ 0,00</span>
                                </div>
                                <div
                                    class="flex justify-between items-center p-4 bg-green-100 border-t-2 border-green-300 rounded-md mt-4">
                                    <span class="text-lg font-bold text-green-800">Total Bruto</span>
                                    <span id="salario-total-detalhe" class="text-xl font-extrabold text-green-800">R$
                                        0,00</span>
                                </div>
                            </div>

                            <div class="mt-8 text-center">
                                <button id="btn-lancar-salario"
                                    class="shiny-btn px-8 py-3 rounded-md text-lg font-semibold w-full md:w-auto">
                                    <i class="fa-solid fa-arrow-down-to-bracket mr-2"></i> Lan√ßar Sal√°rio como Despesa
                                </button>
                                <p id="salario-lancado-msg" class="text-green-600 font-semibold mt-4 hidden">
                                    <i class="fa-solid fa-check-circle mr-2"></i> Sal√°rio j√° lan√ßado como despesa para
                                    este m√™s.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="salario-selecione-msg" class="text-center p-10 bg-white/50 rounded-lg">
                        <i class="fa-solid fa-user-check text-4xl text-gray-400 mb-4"></i>
                        <p class="font-semibold text-gray-600">Selecione um funcion√°rio acima para calcular o sal√°rio.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">N√£o h√° funcion√°rios cadastrados? Use o bot√£o <i
                                class="fa-solid fa-gear"></i> Configura√ß√µes.</p>
                    </div>

                </section>
            </div>

            <!-- Barra de A√ß√µes para Sele√ß√£o M√∫ltipla -->
            <div id="bulk-actions-bar"
                class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 rounded-2xl shadow-2xl hidden z-50 items-center gap-6 animate-slide-up">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-check-circle text-xl"></i>
                    <span id="selected-count" class="font-bold text-lg">0 selecionados</span>
                </div>

                <div class="h-8 w-px bg-white/30"></div>

                <div class="flex items-center gap-2">
                    <span class="text-sm">Subtotal:</span>
                    <span id="selected-subtotal" class="font-bold text-xl">R$ 0,00</span>
                </div>

                <div class="h-8 w-px bg-white/30"></div>

                <div class="flex gap-3">
                    <button id="bulk-delete-btn"
                        class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-trash-can"></i>
                        Deletar Selecionados
                    </button>
                    <button id="bulk-cancel-btn"
                        class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="add-entrada-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Nova Entrada Manual</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-evento" class="space-y-4 pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label for="evento-data" class="block text-sm font-medium text-gray-700">Data</label><input
                            type="date" id="evento-data" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-empresa"
                            class="block text-sm font-medium text-gray-700">Empresa</label><select id="evento-empresa"
                            required class="form-input w-full mt-1">
                            <option>Aero Festas</option>
                            <option>ABC Festas</option>
                        </select></div>
                    <div><label for="evento-contratante"
                            class="block text-sm font-medium text-gray-700">Contratante</label><input type="text"
                            id="evento-contratante" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-local" class="block text-sm font-medium text-gray-700">Local</label><input
                            type="text" id="evento-local" required class="form-input w-full mt-1"></div>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-semibold mb-2">Itens do Evento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-7"><label for="item-nome"
                                class="block text-sm font-medium text-gray-700">Nome do Item</label><input type="text"
                                id="item-nome" class="form-input w-full mt-1"></div>
                        <div class="md:col-span-3"><label for="item-valor"
                                class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number"
                                id="item-valor" step="0.01" class="form-input w-full mt-1"></div>
                        <button type="button" id="btn-add-item" class="md:col-span-2 shiny-btn py-2 rounded-md"><i
                                class="fa-solid fa-plus mr-2"></i> Add</button>
                    </div>
                    <ul id="itens-temp-list" class="mt-4 space-y-2"></ul>
                </div>
                <button type="submit" class="w-full shiny-btn py-2.5 rounded-md font-bold"><i
                        class="fa-solid fa-save mr-2"></i> Salvar Evento Completo</button>
            </form>
        </div>
    </div>

    <div id="add-gasto-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Novo Gasto</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-gasto" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                <div><label for="gasto-data" class="block text-sm font-medium text-gray-700">Data</label><input
                        type="date" id="gasto-data" required class="form-input w-full mt-1"></div>
                <div><label for="gasto-descricao"
                        class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text"
                        id="gasto-descricao" required class="form-input w-full mt-1"></div>
                <div>
                    <label for="gasto-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="gasto-categoria" required class="form-input w-full mt-1">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>
                <div><label for="gasto-conta" class="block text-sm font-medium text-gray-700">Conta de
                        Sa√≠da</label><select id="gasto-conta" required class="form-input w-full mt-1"></select></div>
                <div><label for="gasto-pagamento" class="block text-sm font-medium text-gray-700">Forma de
                        Pagamento</label><select id="gasto-pagamento" required class="form-input w-full mt-1">
                        <option>PIX</option>
                        <option>Cart√£o de Cr√©dito</option>
                        <option>Dinheiro</option>
                        <option>Boleto</option>
                    </select></div>
                <div><label for="gasto-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input
                        type="number" id="gasto-valor" step="0.01" required class="form-input w-full mt-1"></div>
                <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-3"><i
                        class="fa-solid fa-plus mr-2"></i> Adicionar Gasto</button>
            </form>
        </div>
    </div>

    <div id="lancamento-conta-fixa-modal"
        class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Pagamento de Conta Fixa</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-lancamento-conta-fixa">
                <p class="text-gray-700 mb-4">Confirme ou altere os dados para o lan√ßamento.</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <input type="text" id="lancamento-cf-descricao" class="form-input w-full mt-1 bg-gray-200"
                            readonly>
                    </div>
                    <div>
                        <label for="lancamento-cf-data" class="block text-sm font-medium text-gray-700">Data do
                            Pagamento</label>
                        <input type="date" id="lancamento-cf-data" required class="form-input w-full mt-1">
                    </div>
                    <div>
                        <label for="lancamento-cf-valor" class="block text-sm font-medium text-gray-700">Valor Pago
                            (R$)</label>
                        <input type="number" step="0.01" id="lancamento-cf-valor" required
                            class="form-input w-full mt-1">
                    </div>
                    <div>
                        <label for="lancamento-cf-conta" class="block text-sm font-medium text-gray-700">Conta de
                            Sa√≠da</label>
                        <select id="lancamento-cf-conta" required class="form-input w-full mt-1"></select>
                    </div>
                    <div>
                        <label for="lancamento-cf-comprovante" class="block text-sm font-medium text-gray-700">Anexar
                            Comprovantes (Opcional)</label>
                        <input type="file" id="lancamento-cf-comprovante" multiple
                            class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                </div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i
                        class="fa-solid fa-check mr-2"></i>Confirmar Lan√ßamento</button>
            </form>
        </div>
    </div>



    <div id="edit-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Editar Item</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="modal-form">
                <div id="modal-form-content" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i
                        class="fa-solid fa-save mr-2"></i>Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div id="monitor-details-modal"
        class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-[70] p-4">
        <div
            class="modal-box glassmorphism p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="monitor-details-title" class="text-2xl font-bold text-gray-900">Detalhes do Monitor</h2>
                <button
                    class="monitor-details-close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="monitor-details-body" class="bg-white/60 p-4 rounded-md flex-grow overflow-y-auto">
            </div>
        </div>
    </div>

    <div id="attachment-viewer-modal"
        class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-6 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="attachment-viewer-title" class="text-2xl font-bold text-gray-900">Visualizar Anexos</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="attachment-viewer-content"
                class="flex-grow overflow-y-auto bg-white/50 rounded p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>
    </div>

    <div id="salarios-config-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Configura√ß√µes de Sal√°rios</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <div class="mb-4 border-b border-gray-300/50 flex space-x-2">
                <button class="config-tab-btn active" data-target="config-tab-funcionarios">
                    <i class="fa-solid fa-user-tie mr-2"></i> Funcion√°rios
                </button>
                <button class="config-tab-btn" data-target="config-tab-comissao">
                    <i class="fa-solid fa-percentage mr-2"></i> Faixas de Comiss√£o
                </button>
            </div>

            <div id="config-tab-funcionarios" class="config-tab-content active space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Novo Funcion√°rio</h3>
                    <form id="form-add-funcionario"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div><label for="funcionario-nome"
                                class="block text-sm font-medium text-gray-700">Nome</label><input type="text"
                                id="funcionario-nome" required class="form-input w-full mt-1"
                                placeholder="Nome do Funcion√°rio"></div>
                        <div><label for="funcionario-salario" class="block text-sm font-medium text-gray-700">Sal√°rio
                                Fixo (R$)</label><input type="number" id="funcionario-salario" step="0.01" required
                                class="form-input w-full mt-1" placeholder="2200.00"></div>
                        <div><label for="funcionario-va" class="block text-sm font-medium text-gray-700">Vale
                                Alimenta√ß√£o (R$)</label><input type="number" id="funcionario-va" step="0.01" required
                                class="form-input w-full mt-1" placeholder="390.00"></div>
                        <div><label for="funcionario-vt" class="block text-sm font-medium text-gray-700">Vale Transporte
                                (R$)</label><input type="number" id="funcionario-vt" step="0.01" required
                                class="form-input w-full mt-1" placeholder="223.60"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-4"><i
                                class="fa-solid fa-plus mr-2"></i> Adicionar Funcion√°rio</button>
                    </form>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Funcion√°rios Cadastrados</h3>
                    <div class="table-wrapper">
                        <table id="tabela-funcionarios-config">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Sal√°rio Fixo</th>
                                    <th>VA</th>
                                    <th>VT</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="config-tab-comissao" class="config-tab-content space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Adicionar Nova Faixa de Comiss√£o</h3>
                    <form id="form-add-comissao" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="comissao-atevalor" class="block text-sm font-medium text-gray-700">Faturamento
                                AT√â (R$)</label><input type="number" id="comissao-atevalor" step="0.01" required
                                class="form-input w-full mt-1" placeholder="45000"></div>
                        <div><label for="comissao-percentual" class="block text-sm font-medium text-gray-700">Percentual
                                (%)</label><input type="number" id="comissao-percentual" step="0.1" required
                                class="form-input w-full mt-1" placeholder="2.5"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i>
                            Adicionar Faixa</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Dica: Para "acima de R$ 95.000", cadastre uma faixa com valor
                        "At√©" muito alto (ex: 9999999).</p>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Faixas de Comiss√£o Atuais</h3>
                    <div class="table-wrapper">
                        <table id="tabela-comissao-config">
                            <thead>
                                <tr>
                                    <th>Faturamento At√© (R$)</th>
                                    <th>Percentual</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

        </div>
    </div>


    <!-- Event Listeners de Navega√ß√£o e Modais -->
    <script>
        // Este script agora √© vazio pois foi consolidado no script ao final do arquivo
    </script>

    <!-- Modal de Entrada Manual de Receita -->
    <div id="modal-entrada-manual"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50"
        style="display: none;">
        <div class="glassmorphism p-8 rounded-lg max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">üí∞ Nova Entrada de Receita</h3>
                <button onclick="document.getElementById('modal-entrada-manual').style.display='none'"
                    class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>

            <form id="form-entrada-manual" class="space-y-4">
                <div>
                    <label for="entrada-data" class="block text-sm font-medium text-gray-700 mb-1">
                        Data da Entrada
                    </label>
                    <input type="date" id="entrada-data" required
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="entrada-descricao" class="block text-sm font-medium text-gray-700 mb-1">
                        Descri√ß√£o
                    </label>
                    <input type="text" id="entrada-descricao" required
                        placeholder="Ex: Venda de Material, Servi√ßo Extra..."
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="entrada-valor" class="block text-sm font-medium text-gray-700 mb-1">
                        Valor (R$)
                    </label>
                    <input type="number" id="entrada-valor" step="0.01" min="0.01" required placeholder="0,00"
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="bg-indigo-50 p-3 rounded-md text-sm text-gray-600">
                    <i class="fa-solid fa-info-circle mr-2 text-indigo-600"></i>
                    Esta entrada ser√° registrada como receita avulsa, independente de eventos.
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="document.getElementById('modal-entrada-manual').style.display='none'"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn px-4 py-2 rounded-md">
                        <i class="fa-solid fa-check mr-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cadastrar Conta Fixa -->
    <div id="modal-conta-fixa"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Cadastrar Conta Fixa</h2>
                <button id="close-conta-fixa-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-conta-fixa" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div><label for="conta-fixa-descricao"
                        class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text"
                        id="conta-fixa-descricao" required class="form-input w-full mt-1"
                        placeholder="Ex: Aluguel do galp√£o"></div>
                <div><label for="conta-fixa-valor" class="block text-sm font-medium text-gray-700">Valor
                        (R$)</label><input type="number" id="conta-fixa-valor" step="0.01" required
                        class="form-input w-full mt-1" placeholder="750.00"></div>
                <div><label for="conta-fixa-dia-vencimento" class="block text-sm font-medium text-gray-700">Dia do
                        Vencimento</label><input type="number" id="conta-fixa-dia-vencimento" min="1" max="31" required
                        class="form-input w-full mt-1" placeholder="10"></div>
                <div>
                    <label for="conta-fixa-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="conta-fixa-categoria" required class="form-input w-full mt-1">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>

                <div>
                    <label for="conta-fixa-tipo-recorrencia" class="block text-sm font-medium text-gray-700">Tipo de
                        Recorr√™ncia</label>
                    <select id="conta-fixa-tipo-recorrencia" required class="form-input w-full mt-1">
                        <option value="permanente" selected>Permanente (Cont√≠nua)</option>
                        <option value="parcelada">Parcelada (Com Fim)</option>
                    </select>
                </div>

                <div id="conta-fixa-parcelamento-container"
                    class="hidden md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label for="conta-fixa-data-inicio" class="block text-sm font-medium text-gray-700">M√™s de
                            In√≠cio (YYYY-MM)</label><input type="month" id="conta-fixa-data-inicio"
                            class="form-input w-full mt-1"></div>
                    <div><label for="conta-fixa-num-parcelas" class="block text-sm font-medium text-gray-700">N¬∫ de
                            Parcelas</label><input type="number" id="conta-fixa-num-parcelas" min="1" step="1"
                            class="form-input w-full mt-1" placeholder="12"></div>
                    <div>
                        <label for="conta-fixa-periodicidade-parcelada"
                            class="block text-sm font-medium text-gray-700">Periodicidade</label>
                        <select id="conta-fixa-periodicidade-parcelada" class="form-input w-full mt-1">
                            <option value="mensal">Mensal</option>
                            <option value="quinzenal">Quinzenal</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>

                <div id="conta-fixa-permanente-container"
                    class="md:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="conta-fixa-periodicidade-permanente"
                            class="block text-sm font-medium text-gray-700">Periodicidade</label>
                        <select id="conta-fixa-periodicidade-permanente" class="form-input w-full mt-1">
                            <option value="mensal">Mensal</option>
                            <option value="quinzenal">Quinzenal</option>
                            <option value="bimestral">Bimestral</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>

                <div class="lg:col-span-4">
                    <label for="conta-fixa-anexo" class="block text-sm font-medium text-gray-700">Anexar Boletos/Faturas
                        (Opcional)</label>
                    <input type="file" id="conta-fixa-anexo" multiple
                        class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div class="lg:col-span-4 flex gap-3 pt-4">
                    <button type="button" id="limpar-conta-fixa-btn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-md transition-colors">
                        <i class="fa-solid fa-eraser mr-2"></i> Limpar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i>
                        Adicionar Conta Fixa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Gerenciar Categorias -->
    <div id="modal-categorias-cf"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-gear mr-2"></i> Categorias de Contas
                    Fixas</h2>
                <button id="close-categorias-cf-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-conta-fixa-categoria" class="space-y-4 mb-6">
                <div>
                    <label for="cf-categoria-nome" class="block text-sm font-medium text-gray-700 mb-2">Nome da Nova
                        Categoria</label>
                    <div class="flex gap-2">
                        <input type="text" id="cf-categoria-nome" placeholder="Ex: Impostos MEI" required
                            class="form-input flex-1">
                        <button type="submit" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-save mr-2"></i> Salvar</button>
                    </div>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Categorias Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-cf-categorias-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Contas Banc√°rias -->
    <div id="modal-contas-bancarias"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-building-columns mr-2"></i> Contas
                    Banc√°rias</h2>
                <button id="close-contas-bancarias-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-cadastro-conta" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="cadastro-conta-nome" class="block text-sm font-medium text-gray-700">Nome da
                            Conta</label><input type="text" id="cadastro-conta-nome" placeholder="Ex: Conta Principal"
                            required class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-conta-banco"
                            class="block text-sm font-medium text-gray-700">Institui√ß√£o/Banco</label><input type="text"
                            id="cadastro-conta-banco" placeholder="Ex: Banco Inter" required
                            class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-conta-tipo"
                            class="block text-sm font-medium text-gray-700">Tipo</label><select id="cadastro-conta-tipo"
                            required class="form-input w-full mt-1">
                            <option>Conta Corrente</option>
                            <option>Conta Poupan√ßa</option>
                            <option>Conta de Pagamentos</option>
                            <option>Outros</option>
                        </select></div>
                    <div><label for="cadastro-conta-agencia" class="block text-sm font-medium text-gray-700">Ag√™ncia
                            (Opcional)</label><input type="text" id="cadastro-conta-agencia" placeholder="0001"
                            class="form-input w-full mt-1"></div>
                    <div class="md:col-span-2"><label for="cadastro-conta-numero"
                            class="block text-sm font-medium text-gray-700">N¬∫ da Conta (Opcional)</label><input
                            type="text" id="cadastro-conta-numero" placeholder="12345-6" class="form-input w-full mt-1">
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="limpar-conta-bancaria-btn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-md transition-colors">
                        <i class="fa-solid fa-eraser mr-2"></i> Limpar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn py-2 rounded-md"><i class="fa-solid fa-save mr-2"></i>
                        Salvar Conta</button>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Contas Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-contas-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Institui√ß√£o</th>
                            <th>Tipo</th>
                            <th>Ag√™ncia/Conta</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Categorias de Gastos -->
    <div id="modal-categorias-gastos"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-tags mr-2"></i> Categorias de Gastos
                </h2>
                <button id="close-categorias-gastos-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-gasto-categoria" class="space-y-4 mb-6">
                <div>
                    <label for="gasto-categoria-nome" class="block text-sm font-medium text-gray-700 mb-2">Nome da Nova
                        Categoria</label>
                    <div class="flex gap-2">
                        <input type="text" id="gasto-categoria-nome" placeholder="Ex: Limpeza" required
                            class="form-input flex-1">
                        <button type="submit" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-save mr-2"></i> Salvar</button>
                    </div>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Categorias Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-gasto-categorias-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal API Key -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-[100]">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-4">Para usar os recursos de IA, voc√™ precisa de uma chave de API.</p>

            <div class="bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-100">
                <h3 class="text-indigo-800 font-bold text-sm mb-2 flex items-center">
                    <i class="fa-solid fa-circle-info mr-2"></i> Como conseguir a chave?
                </h3>
                <ol class="text-xs text-indigo-700 space-y-2 list-decimal ml-4">
                    <li>Clique no link azul abaixo (Google AI Studio).</li>
                    <li>Fa√ßa login com sua conta Google.</li>
                    <li>Clique no bot√£o azul <strong>"Create API key"</strong>.</li>
                    <li>Copie o c√≥digo gerado e cole no campo abaixo.</li>
                </ol>
                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                    class="block mt-3 text-center bg-white text-indigo-600 border border-indigo-200 py-1.5 rounded-md font-bold text-xs hover:bg-indigo-50 transition-colors">
                    <i class="fa-solid fa-external-link mr-1"></i> Ir para Google AI Studio
                </a>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium mb-1">Sua Chave da API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui"
                        class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gemini Principal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-[110]">
        <div id="gemini-modal-box"
            class="modal-box glassmorphism w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-modal-title" class="text-2xl font-semibold text-gray-800">‚ú® Assistente IA</h2>
                <button id="gemini-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto text-gray-700">
                <!-- Conte√∫do -->
            </div>
            <div id="gemini-modal-footer"
                class="p-4 bg-gray-50/50 border-t border-gray-200/50 flex justify-end space-x-4">
                <button id="gemini-copy-btn" class="shiny-btn py-2 px-4 rounded-lg">Copiar Texto</button>
            </div>
        </div>
    </div>

    <!-- Modal de Chat da IA -->
    <div id="gemini-chat-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-[120]">
        <div class="modal-box glassmorphism w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-chat-title" class="text-xl font-semibold text-gray-800"></h2>
                <button id="gemini-chat-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-chat-messages" class="p-6 flex-grow overflow-y-auto space-y-4 flex flex-col">
                <!-- Mensagens -->
            </div>
            <div class="p-4 bg-gray-50/50 border-t border-gray-200/50">
                <form id="gemini-chat-form" class="flex gap-2 items-center">
                    <input type="text" id="gemini-chat-input" placeholder="Digite sua pergunta..."
                        class="form-input w-full" required>
                    <button type="submit" id="gemini-chat-send-btn"
                        class="bg-indigo-500 text-white w-10 h-10 rounded-md hover:bg-indigo-600 transition-colors flex-shrink-0">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="gemini-toast"
        class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-[200]">
        <i id="gemini-toast-icon" class="text-lg"></i>
        <p id="gemini-toast-message" class="ml-3 font-medium"></p>
    </div>

    <!-- Modal: Lista de Monitores (Mobile-First Cards) -->
    <div id="modal-lista-monitores"
        class="modal-backdrop fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center hidden z-50">
        <div
            class="modal-content glassmorphism p-6 rounded-2xl shadow-2xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-users text-indigo-600"></i> Monitores Cadastrados
                </h2>
                <button onclick="document.getElementById('modal-lista-monitores').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-800 text-3xl font-bold transition-colors">&times;</button>
            </div>

            <div class="flex justify-between items-center mb-4 bg-indigo-50/50 p-3 rounded-xl border border-indigo-100">
                <span class="text-sm font-medium text-indigo-700" id="monitor-count-text">0 monitores ativos</span>
                <button id="add-new-monitor-btn"
                    class="shiny-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Novo Monitor
                </button>
            </div>

            <div id="monitor-cards-container"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pr-2 flex-grow">
                <!-- Cards renderizados via JS -->
            </div>
        </div>
    </div>

    <!-- Modal: Formul√°rio de Pagamento & Avalia√ß√£o -->
    <div id="modal-pagamento-monitor"
        class="modal-backdrop fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center hidden z-50">
        <div
            class="modal-content glassmorphism p-8 rounded-2xl shadow-2xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-hand-holding-dollar text-emerald-600"></i> Lan√ßar Pagamento
                </h2>
                <button onclick="document.getElementById('modal-pagamento-monitor').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-800 text-3xl font-bold transition-colors">&times;</button>
            </div>

            <form id="form-pagamento-monitor" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="space-y-1">
                        <label for="pag-monitor-data" class="block text-sm font-bold text-gray-700">Data do
                            Evento</label>
                        <input type="date" id="pag-monitor-data" required class="form-input w-full">
                    </div>

                    <div class="space-y-1 lg:col-span-2">
                        <label for="pag-monitor-evento" class="block text-sm font-bold text-gray-700">
                            <i class="fa-solid fa-link text-indigo-600 mr-1"></i>
                            Vincular a Evento da Agenda (opcional)
                        </label>
                        <select id="pag-monitor-evento" class="form-input w-full">
                            <option value="">Sem v√≠nculo - Trabalho avulso</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fa-solid fa-info-circle"></i>
                            Selecione a data acima para ver os eventos dispon√≠veis
                        </p>
                    </div>

                    <div class="space-y-1">
                        <label for="pag-monitor-data-pagamento" class="block text-sm font-bold text-gray-700">Data do
                            Pagamento</label>
                        <input type="date" id="pag-monitor-data-pagamento" class="form-input w-full">
                    </div>

                    <div class="space-y-1 lg:col-span-2">
                        <label for="pag-monitor-select" class="block text-sm font-bold text-gray-700">Monitor</label>
                        <select id="pag-monitor-select" required class="form-input w-full">
                            <option value="">Selecione um monitor...</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label for="pag-monitor-valor" class="block text-sm font-bold text-gray-700">Valor da Di√°ria
                            (R$)</label>
                        <input type="number" id="pag-monitor-valor" step="0.01" value="100.00" class="form-input w-full"
                            required>
                    </div>

                    <div class="space-y-1">
                        <label for="pag-monitor-entrada" class="block text-sm font-bold text-gray-700">Entrada</label>
                        <input type="time" id="pag-monitor-entrada" class="form-input w-full">
                    </div>

                    <div class="space-y-1">
                        <label for="pag-monitor-saida" class="block text-sm font-bold text-gray-700">Sa√≠da</label>
                        <input type="time" id="pag-monitor-saida" class="form-input w-full">
                        <span id="pag-monitor-he-status" class="text-[10px] text-gray-400"></span>
                    </div>

                    <input type="hidden" id="pag-monitor-he" value="0.00">

                    <div class="space-y-1">
                        <label for="pag-monitor-status" class="block text-sm font-bold text-gray-700">Status</label>
                        <select id="pag-monitor-status" class="form-input w-full">
                            <option value="Executado">Pago / Executado</option>
                            <option value="Pendente" selected>Pendente</option>
                        </select>
                    </div>

                    <!-- Adicional de Motorista -->
                    <div class="space-y-2 lg:col-span-2 bg-blue-50/50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pag-monitor-motorista"
                                class="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                            <label for="pag-monitor-motorista" class="text-sm font-bold text-gray-700 cursor-pointer">
                                <i class="fa-solid fa-truck-fast text-indigo-600 mr-1"></i>
                                Este monitor foi motorista no dia trabalhado?
                            </label>
                        </div>
                        <div id="pag-monitor-eventos-container" class="hidden ml-8 space-y-1">
                            <label for="pag-monitor-eventos" class="block text-xs font-medium text-gray-600">
                                Quantos eventos foram entregues? <span class="text-indigo-600 font-bold">(R$ 20,00 por
                                    evento)</span>
                            </label>
                            <input type="number" id="pag-monitor-eventos" step="0.5" min="0" value="0"
                                class="form-input w-full text-sm" placeholder="Ex: 2.5">
                            <span id="pag-monitor-adicional-status" class="text-xs font-bold text-indigo-600"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 space-y-4">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-star text-yellow-500"></i> Avalia√ß√£o do Monitor
                    </h3>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Proatividade</label>
                            <input type="range" min="0" max="10" value="10"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                id="nota-proatividade">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Cordialidade</label>
                            <input type="range" min="0" max="10" value="10"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                id="nota-cordialidade">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Pontualidade</label>
                            <input type="range" min="0" max="10" value="10"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                id="nota-pontualidade">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Lideran√ßa</label>
                            <input type="range" min="0" max="10" value="10"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                id="nota-lideranca">
                        </div>
                    </div>

                    <div class="pt-2">
                        <label for="pag-monitor-obs" class="block text-sm font-bold text-gray-700 mb-1">Observa√ß√µes do
                            Evento</label>
                        <textarea id="pag-monitor-obs" rows="2" class="form-input w-full"
                            placeholder="Ex: Monitor chegou cedo e foi muito atencioso com as crian√ßas."></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button"
                        onclick="document.getElementById('modal-pagamento-monitor').classList.add('hidden')"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-all">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-[2] shiny-btn font-bold py-3 rounded-xl transition-all">
                        <i class="fa-solid fa-check mr-2"></i> Confirmar Lan√ßamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Monitor -->
    <!-- (Reaproveitando o ID, mas com layout mobile-first) -->
    <div id="add-monitor-modal"
        class="modal-backdrop fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center hidden z-[60]">
        <div
            class="modal-content glassmorphism p-8 rounded-2xl shadow-2xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-monitor-title" class="text-2xl font-bold text-gray-800">Novo Monitor</h2>
                <button onclick="document.getElementById('add-monitor-modal').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>

            <form id="form-cadastro-monitor" class="space-y-4">
                <input type="hidden" id="monitor-id-edit">

                <!-- Foto de Perfil Preview -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div id="monitor-photo-preview"
                        class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden group relative cursor-pointer hover:border-indigo-500 transition-all">
                        <i
                            class="fa-solid fa-camera text-gray-400 group-hover:text-indigo-500 text-2xl transition-all"></i>
                        <img id="monitor-photo-img" class="hidden w-full h-full object-cover">
                        <div
                            class="absolute inset-0 bg-black/40 text-white text-[10px] items-center justify-center font-bold hidden group-hover:flex">
                            ALTERAR</div>
                    </div>
                    <input type="file" id="monitor-foto-input" accept="image/*" class="hidden">
                    <input type="hidden" id="monitor-foto-base64">
                    <p class="text-[10px] text-gray-400 mt-2 font-bold uppercase tracking-wider">Foto do Monitor</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1 md:col-span-2">
                        <label for="monitor-nome" class="block text-sm font-bold text-gray-700">Nome Completo</label>
                        <input type="text" id="monitor-nome" required class="form-input w-full">
                    </div>

                    <div class="space-y-1">
                        <label for="monitor-nascimento" class="block text-sm font-bold text-gray-700">Data de
                            Nascimento</label>
                        <input type="date" id="monitor-nascimento" class="form-input w-full">
                    </div>

                    <div class="space-y-1">
                        <label for="monitor-telefone" class="block text-sm font-bold text-gray-700">Telefone /
                            WhatsApp</label>
                        <input type="text" id="monitor-telefone" placeholder="(00) 00000-0000"
                            class="form-input w-full">
                    </div>

                    <div class="space-y-1">
                        <label for="monitor-email" class="block text-sm font-bold text-gray-700">Email</label>
                        <input type="email" id="monitor-email" placeholder="email@exemplo.com"
                            class="form-input w-full">
                    </div>

                    <div class="space-y-1">
                        <label for="monitor-cnh" class="block text-sm font-bold text-gray-700">Possui CNH?</label>
                        <select id="monitor-cnh" class="form-input w-full">
                            <option value="N√£o possui">N√£o possui</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label for="monitor-cnh-categoria" class="block text-sm font-bold text-gray-700">Categoria
                            CNH</label>
                        <input type="text" id="monitor-cnh-categoria" placeholder="Ex: AB" class="form-input w-full">
                    </div>

                    <div class="space-y-1 md:col-span-2">
                        <label for="monitor-endereco" class="block text-sm font-bold text-gray-700">Endere√ßo
                            Residencial</label>
                        <input type="text" id="monitor-endereco" placeholder="Rua, N√∫mero, Bairro, Cidade"
                            class="form-input w-full">
                    </div>

                    <div class="space-y-1 md:col-span-2">
                        <label for="monitor-observacoes" class="block text-sm font-bold text-gray-700">Observa√ß√µes
                            Internas</label>
                        <textarea id="monitor-observacoes" rows="2"
                            placeholder="Informa√ß√µes relevantes sobre o monitor..."
                            class="form-input w-full"></textarea>
                    </div>
                </div>

                <!-- Upload de Documento (RG/CNH) -->
                <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <h4 id="monitor-doc-title" class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-id-card text-indigo-600"></i>
                        Documento de Identifica√ß√£o (RG)
                    </h4>
                    <div class="flex flex-col items-center justify-center">
                        <div id="monitor-doc-preview"
                            class="w-full max-w-md h-48 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden group relative cursor-pointer hover:border-indigo-500 transition-all">
                            <div class="text-center">
                                <i
                                    class="fa-solid fa-file-image text-gray-400 group-hover:text-indigo-500 text-4xl transition-all"></i>
                                <p class="text-sm text-gray-500 mt-2 font-medium">Clique para fazer upload</p>
                                <p class="text-xs text-gray-400">Tamanho m√°ximo: 5MB</p>
                            </div>
                            <img id="monitor-doc-img" class="hidden w-full h-full object-contain">
                            <div
                                class="absolute inset-0 bg-black/40 text-white text-sm items-center justify-center font-bold hidden group-hover:flex">
                                ALTERAR DOCUMENTO
                            </div>
                        </div>
                        <input type="file" id="monitor-doc-input" accept="image/*" class="hidden">
                        <input type="hidden" id="monitor-doc-base64">
                        <p class="text-xs text-gray-400 mt-2 text-center">
                            <i class="fa-solid fa-info-circle"></i>
                            Upload de foto do <span id="monitor-doc-type">RG</span> (frente e verso)
                        </p>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="shiny-btn w-full py-3 rounded-xl font-bold">
                        <i class="fa-solid fa-save mr-2"></i> Salvar Monitor
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sistema de Autentica√ß√£o -->

    <script src="js/protect.js"></script>


    <!-- M√≥dulo de Gr√°ficos Financeiros (Estilo Bolsa de Valores) -->
    <script src="js/charts-financeiro.js"></script>

    <script>
        // --- GEMINI IA LOGIC ---
        const apiKeyModal = document.getElementById('api-key-modal');
        const geminiModal = document.getElementById('gemini-modal');
        const geminiChatModal = document.getElementById('gemini-chat-modal');
        const chatMessagesEl = document.getElementById('gemini-chat-messages');
        const chatForm = document.getElementById('gemini-chat-form');
        const chatInput = document.getElementById('gemini-chat-input');
        const chatSendBtn = document.getElementById('gemini-chat-send-btn');
        const chatModalTitle = document.getElementById('gemini-chat-title');

        let chatHistory = [];

        const openIAModal = (modalEl) => modalEl.classList.remove('hidden');
        const hideIAModal = (modalEl) => modalEl.classList.add('hidden');

        const showIAToast = (message, isError = true) => {
            const toast = document.getElementById('gemini-toast');
            const toastMessage = document.getElementById('gemini-toast-message');
            const toastIcon = document.getElementById('gemini-toast-icon');
            if (!toast || !toastMessage) return;
            toastMessage.textContent = message;
            toast.classList.toggle('bg-red-600', isError);
            toast.classList.toggle('bg-green-600', !isError);
            if (toastIcon) toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        };

        // Placeholder Animation for API Key
        const animatePlaceholder = () => {
            const input = document.getElementById('api-key-input');
            if (!input) return;
            const text = "Cole sua chave aqui...";
            let i = 0;

            function type() {
                if (i < text.length) {
                    i++;
                    input.placeholder = text.substring(0, i) + "|";
                    setTimeout(type, 100);
                } else {
                    // Final blink effect
                    let flashes = 0;
                    const interval = setInterval(() => {
                        input.placeholder = text + (flashes % 2 === 0 ? "" : "|");
                        flashes++;
                        if (flashes > 5) {
                            clearInterval(interval);
                            setTimeout(() => {
                                i = 0;
                                type();
                            }, 2000);
                        }
                    }, 500);
                }
            }
            type();
        };
        animatePlaceholder();

        const getApiKey = () => localStorage.getItem('gemini_api_key_v1');
        const saveApiKey = (key) => localStorage.setItem('gemini_api_key_v1', key);

        // API Key Modal Events
        if (document.getElementById('settings-btn')) {
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('api-key-input').value = getApiKey() || '';
                openIAModal(apiKeyModal);
            });
        }

        document.getElementById('cancel-api-key-btn').addEventListener('click', () => hideIAModal(apiKeyModal));
        document.getElementById('save-api-key-btn').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                saveApiKey(key);
                hideIAModal(apiKeyModal);
                showIAToast("Chave API salva com sucesso!", false);
            }
        });

        // Close Gemini Modals
        document.getElementById('gemini-close-btn').addEventListener('click', () => hideIAModal(geminiModal));
        document.getElementById('gemini-chat-close-btn').addEventListener('click', () => hideIAModal(geminiChatModal));

        async function callGeminiAPI(input, generationConfig = null) {
            const apiKey = getApiKey();
            if (!apiKey) {
                showIAToast("Por favor, configure sua chave de API do Gemini.");
                document.getElementById('api-key-input').value = '';
                openIAModal(apiKeyModal);
                return null;
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${apiKey}`;

            let payload = {
                contents: typeof input === 'string' ? [{ parts: [{ text: input }] }] : input
            };

            if (generationConfig) payload.generationConfig = generationConfig;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "Erro na chamada da API");
                }

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Error:", error);
                showIAToast("Erro ao falar com a IA: " + error.message);
                return null;
            }
        }

        function addChatMessage(message, sender = 'ia') {
            const messageEl = document.createElement('div');
            messageEl.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'break-words');

            // Simple markdown Bold
            let htmlMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Simple lists
            htmlMessage = htmlMessage.replace(/^\s*-\s(.*?)$/gm, '<li class="ml-4">$1</li>');

            if (sender === 'user') {
                messageEl.classList.add('bg-indigo-500', 'text-white', 'self-end', 'ml-auto');
                messageEl.innerHTML = htmlMessage;
            } else {
                messageEl.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto');
                if (message === '...') {
                    messageEl.innerHTML = '<div class="loader w-5 h-5 border-2 border-indigo-500 border-t-transparent"></div>';
                } else {
                    messageEl.innerHTML = htmlMessage;
                }
            }
            chatMessagesEl.appendChild(messageEl);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            return messageEl;
        }

        async function openChat(contextType) {
            // First, check for API key to avoid modal overlap
            const apiKey = getApiKey();
            if (!apiKey) {
                showIAToast("Por favor, configure sua chave de API do Gemini.");
                document.getElementById('api-key-input').value = '';
                openIAModal(apiKeyModal);
                return; // Stop here
            }

            let titleText = '‚ú® Intelig√™ncia Aero';
            let initialPrompt = '';

            // Get current financial data for context
            const totalReceitas = document.getElementById('total-receitas')?.textContent || 'R$ 0,00';
            const totalDespesas = document.getElementById('total-despesas')?.textContent || 'R$ 0,00';
            const saldoFinal = document.getElementById('saldo-total')?.textContent || 'R$ 0,00';

            if (contextType === 'dashboard') {
                titleText = '<i class="fa-solid fa-chart-line mr-2 text-indigo-500"></i> Insights do Dashboard';
                initialPrompt = `Analise meu resumo financeiro atual: Receitas: ${totalReceitas}, Despesas: ${totalDespesas}, Saldo: ${saldoFinal}. Me d√™ 3 insights r√°pidos ou avisos sobre esses n√∫meros.`;
            } else if (contextType === 'gastos') {
                titleText = '<i class="fa-solid fa-receipt mr-2 text-red-500"></i> An√°lise de Gastos';
                initialPrompt = "Gostaria de uma an√°lise sobre meus gastos deste m√™s. Quais as categorias mais pesadas e onde posso reduzir custos?";
            }

            chatModalTitle.innerHTML = titleText;
            chatMessagesEl.innerHTML = '';
            openIAModal(geminiChatModal);

            if (initialPrompt) {
                const loadingEl = addChatMessage('...');
                chatHistory = [{ role: 'user', parts: [{ text: initialPrompt }] }];
                const response = await callGeminiAPI(chatHistory);
                loadingEl.remove();
                if (response) {
                    addChatMessage(response, 'ia');
                    chatHistory.push({ role: 'model', parts: [{ text: response }] });
                }
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: userInput }] });
            chatInput.value = '';
            chatSendBtn.disabled = true;

            const loadingEl = addChatMessage('...');
            const response = await callGeminiAPI(chatHistory);
            loadingEl.remove();

            if (response) {
                addChatMessage(response, 'ia');
                chatHistory.push({ role: 'model', parts: [{ text: response }] });
            }
            chatSendBtn.disabled = false;
        });

        // Expose openChat to global scope for onclick events
        window.openChat = openChat;

        // Function to edit an event - redirects to Agenda de eventos
        window.editarEvento = function (eventoId) {
            if (!eventoId) {
                showToast('ID do evento inv√°lido', true);
                return;
            }
            // Redirect to Agenda de eventos with the event ID as a URL parameter
            window.location.href = `./Agenda de eventos.html?edit=${eventoId}`;
        };

        // Function to edit a monitor payment
        window.editarPagamentoMonitor = async function (pagamentoId) {
            if (!pagamentoId) {
                showToast('ID do pagamento inv√°lido', true);
                return;
            }

            // Find the payment in the state
            const pagamento = state.pagamentosMonitores.find(p => p.id === pagamentoId);
            if (!pagamento) {
                showToast('Pagamento n√£o encontrado', true);
                return;
            }

            // Populate the form fields
            getById('pag-monitor-data').value = pagamento.data;
            getById('pag-monitor-data-pagamento').value = pagamento.dataPagamento || '';
            getById('pag-monitor-select').value = pagamento.monitorId;
            getById('pag-monitor-valor').value = pagamento.valorBase || 0;
            getById('pag-monitor-he').value = pagamento.horasExtras || 0;
            getById('pag-monitor-entrada').value = pagamento.horaEntrada || '';
            getById('pag-monitor-saida').value = pagamento.horaSaida || '';
            getById('pag-monitor-status').value = pagamento.statusPagamento || 'Pendente';
            getById('pag-monitor-obs').value = pagamento.observacoes || '';

            // Motorista fields
            const isMotorista = pagamento.foiMotorista || false;
            getById('pag-monitor-motorista').checked = isMotorista;
            if (isMotorista) {
                getById('pag-monitor-eventos-container')?.classList.remove('hidden');
                getById('pag-monitor-eventos').value = pagamento.numEventos || 0;
            } else {
                getById('pag-monitor-eventos-container')?.classList.add('hidden');
            }

            // Evento vinculado (if exists)
            if (pagamento.eventoId) {
                getById('pag-monitor-evento').value = pagamento.eventoId;
            }

            // Set the edit ID so the form knows it's in edit mode
            let editIdField = getById('pag-monitor-edit-id');
            if (!editIdField) {
                // Create the hidden field if it doesn't exist
                const form = getById('form-pagamento-monitor');
                if (form) {
                    editIdField = document.createElement('input');
                    editIdField.type = 'hidden';
                    editIdField.id = 'pag-monitor-edit-id';
                    form.appendChild(editIdField);
                }
            }
            if (editIdField) {
                editIdField.value = pagamentoId;
            }

            // Show the modal
            getById('modal-pagamento-monitor')?.classList.remove('hidden');
            showToast('‚úèÔ∏è Editando pagamento', false);
        };

        // Fun√ß√µes para Modal de Gastos Pendentes
        window.showPendingDetailsModal = function () {
            const listEl = getById('lista-detalhes-pendentes');
            if (!listEl) return;

            listEl.innerHTML = '';
            const details = state.dashboardSummary?.pendingDetails || [];

            if (details.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum detalhe dispon√≠vel.</p>';
            } else {
                details.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'group flex items-center justify-between p-4 bg-gray-50 border border-gray-100 rounded-xl hover:bg-amber-50 hover:border-amber-200 transition-all cursor-pointer active:scale-[0.98]';
                    itemEl.onclick = () => window.navigateToPendingItem(item.id, item.type);

                    itemEl.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-gray-700 group-hover:text-amber-900">${item.description}</span>
                            <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">${item.type === 'monitor' ? 'Pagamento Monitor' : 'Conta Fixa'}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-extrabold text-gray-800">${formatarMoeda(item.amount)}</span>
                            <i class="fa-solid fa-chevron-right text-[10px] text-gray-300 group-hover:text-amber-400 transition-colors"></i>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            }

            const modal = getById('modal-detalhes-pendentes');
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content')?.classList.remove('scale-95', 'opacity-0');
                    modal.querySelector('.modal-content')?.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        };

        window.closePendingDetailsModal = function () {
            const modal = getById('modal-detalhes-pendentes');
            if (modal) {
                modal.querySelector('.modal-content')?.classList.remove('scale-100', 'opacity-100');
                modal.querySelector('.modal-content')?.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        };

        window.navigateToPendingItem = function (id, type) {
            window.closePendingDetailsModal();
            setTimeout(() => {
                let targetId = '';
                if (type === 'monitor') {
                    // Tenta rolar para a tabela de monitores
                    targetId = 'containerPagamentosMonitores';
                } else {
                    // Tenta rolar para a se√ß√£o de contas fixas
                    targetId = 'containerContasFixasMes';
                }

                const targetEl = getById(targetId);
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Adiciona um destaque tempor√°rio
                    targetEl.classList.add('ring-4', 'ring-amber-400/50', 'transition-all', 'duration-1000');
                    setTimeout(() => targetEl.classList.remove('ring-4', 'ring-amber-400/50'), 3000);
                } else {
                    showToast('Localizando item...', false);
                }
            }, 350);
        };
    </script>

    <!-- Modal Detalhes Gastos Pendentes -->
    <div id="modal-detalhes-pendentes"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[9999] p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-300 scale-95 opacity-0 modal-content border border-gray-100">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center text-amber-600">
                            <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">Gastos Pendentes</h3>
                    </div>
                    <button onclick="window.closePendingDetailsModal()"
                        class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>

                <div id="lista-detalhes-pendentes" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Itens inseridos via JS -->
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="window.closePendingDetailsModal()"
                        class="px-6 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all active:scale-95">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script de inicializa√ß√£o dos gr√°ficos (previne loop infinito) -->
    <script src="js/charts-financeiro.js"></script>
    <script src="js/charts-init.js"></script>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="bottom-nav">
        <a href="./Dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>In√≠cio</span>
        </a>
        <a href="./Agenda de eventos.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Agenda</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="fas fa-wallet"></i>
            <span>Financeiro</span>
        </a>
        <a href="./Sistema de CRM.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
    </nav>

</body>

</html>