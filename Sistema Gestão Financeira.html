<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira v30 - Categorias Din√¢micas</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='20' cy='20' r='10' fill='%234f46e5'/><circle cx='80' cy='30' r='8' fill='%234f46e5'/><circle cx='50' cy='70' r='12' fill='%234f46e5'/><line x1='20' y1='20' x2='80' y2='30' stroke='%234f46e5' stroke-width='5'/><line x1='80' y1='30' x2='50' y2='70' stroke='%234f46e5' stroke-width='5'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { api, API_BASE_URL } from './js/api.js?v=1.1';
        import { getToken } from './js/auth.js?v=1.1';

        // Garante que o jsPDF esteja dispon√≠vel
        window.jsPDF = window.jspdf.jsPDF;

        // Vers√£o do c√≥digo para debug
        console.log("üîß Sistema Financeiro v1.1 - Carregado");

        // Torna api e fun√ß√µes acess√≠veis globalmente
        window.api = api;
        window.API_BASE_URL = API_BASE_URL;
        window.getToken = getToken;

        // Defini√ß√£o de vari√°veis e fun√ß√µes globais compartilhadas
        let loadDataFromCloud;
        let formLancamentoCF;
        const getById = id => document.getElementById(id);
        window.getById = getById;

        const showModal = (modalId) => {
            const modal = getById(modalId);
            if (modal) modal.classList.remove('hidden');
        };
        window.showModal = showModal;

        const hideModal = (modalId) => {
            const modal = getById(modalId);
            if (modal) modal.classList.add('hidden');
        };
        window.hideModal = hideModal;

        const showToastModal = (message, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            if (toast && toastMessage && toastIcon) {
                toastMessage.textContent = message;
                toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                toast.className = isError
                    ? 'fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3'
                    : 'fixed top-5 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3';

                setTimeout(() => {
                    toast.className = toast.className.replace('top-5', '-top-20');
                }, 3000);
            }
        };
        window.showToastModal = showToastModal;

        const validateForm = (form) => {
            let isValid = true;
            const inputs = form.querySelectorAll('input[required], select[required]');
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                }
            });
            return isValid;
        };
        window.validateForm = validateForm;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("‚úÖ DOMContentLoaded iniciado");

            // Estado Inicial
            let state = {
                eventos: [],
                gastos: [],
                receitas: [], // üÜï Transa√ß√µes do tipo REVENUE (entradas manuais)
                contas: [],
                contasFixas: [],
                selectedMonth: new Date().toISOString().slice(0, 7) // YYYY-MM
            };

            // Torna o state acess√≠vel globalmente para os gr√°ficos
            window.state = state;

            // Atribui a fun√ß√£o √† vari√°vel global
            loadDataFromCloud = async function () {
                try {
                    console.log("‚òÅÔ∏è Sincronizando com o servidor...");
                    console.log("üìç URL da API:", api ? "API carregada" : "API n√£o carregada");

                    // Busca TUDO em paralelo para ser r√°pido
                    const [
                        eventosCloud,
                        transacoesCloud,
                        contasCloud,
                        fixasCloud,
                        catGastos,
                        catFixas,
                        monitoresCloud,
                        pagamentosCloud,
                        funcionariosCloud,
                        faixasCloud
                    ] = await Promise.all([
                        window.api.getEventos(),
                        window.api.getTransacoes(),
                        window.api.getContas(),
                        window.api.getContasFixas(),
                        window.api.getCategoriasGastos(),
                        window.api.getCategoriasFixas(),
                        window.api.getMonitores(),
                        window.api.getPagamentosMonitores(),
                        window.api.getFuncionarios(),
                        window.api.getFaixasComissao()
                    ]);

                    console.log("üìä Dados recebidos:", {
                        eventos: eventosCloud?.length || 0,
                        transacoes: transacoesCloud?.length || 0,
                        contas: contasCloud?.length || 0,
                        contasFixas: fixasCloud?.length || 0,
                        catGastos: catGastos?.length || 0,
                        catFixas: catFixas?.length || 0,
                        monitores: monitoresCloud?.length || 0,
                        pagamentos: pagamentosCloud?.length || 0,
                        funcionarios: funcionariosCloud?.length || 0,
                        faixas: faixasCloud?.length || 0
                    });

                    // 1. Mapeia Eventos
                    state.eventos = eventosCloud.map(evt => ({
                        id: evt.id.toString(),
                        data: evt.date,
                        empresa: evt.company ? evt.company.name : "Aero Festas",
                        contratante: evt.clientName,
                        local: "",
                        items: evt.items?.map(i => ({ nome: i.toy?.name, valor: 0 })) || [],
                        valor: evt.price || 0,
                        isSynced: true
                    }));

                    // 2. Mapeia Gastos e Pagamentos (Separando pelo tipo/categoria)
                    state.gastos = transacoesCloud
                        .filter(t => t.type === 'EXPENSE' && !t.category?.includes('Sal√°rio') && !t.description?.includes('Pgto Monitor'))
                        .map(t => {
                            const contaRef = contasCloud.find(c => c.id === t.accountId);
                            return {
                                id: t.id,
                                data: t.date,
                                descricao: t.description,
                                categoria: t.category || "Geral",
                                contaId: t.accountId,
                                conta: contaRef ? contaRef.name : "Caixa",
                                pagamento: t.paymentMethod || "Outro",
                                valor: t.amount,
                                comprovantes: []
                            };
                        });

                    // 2.5. Mapeia Receitas (Transa√ß√µes do tipo REVENUE - entradas manuais)
                    state.receitas = transacoesCloud
                        .filter(t => t.type === 'REVENUE')
                        .map(t => ({
                            id: t.id,
                            data: t.date,
                            descricao: t.description,
                            categoria: t.category || "Receita Avulsa",
                            valor: t.amount,
                            tipo: 'manual' // Flag para diferenciar de eventos
                        }));

                    // 3. Mapeia Contas Banc√°rias
                    state.contas = contasCloud.map(c => ({
                        id: c.id, nome: c.name, banco: c.bank, tipo: c.type, agencia: c.agency, numero: c.number
                    }));

                    // 4. Mapeia Contas Fixas (Cadastros)
                    state.contasFixas = fixasCloud.map(c => {
                        let anexos = [];
                        try {
                            if (c.attachments) {
                                anexos = typeof c.attachments === 'string' ? JSON.parse(c.attachments) : c.attachments;
                            }
                        } catch (e) {
                            console.warn('Erro ao parsear anexos da conta fixa:', c.id, e);
                            anexos = [];
                        }

                        return {
                            id: c.id,
                            descricao: c.description,
                            valor: c.amount,
                            diaVencimento: c.dueDay,
                            categoria: c.category,
                            tipoRecorrencia: c.recurrenceType || 'permanente',
                            dataInicio: c.startDate,
                            numParcelas: c.installments,
                            anexos: anexos
                        };
                    });

                    // 5. Mapeia Categorias de Gastos
                    state.gastoCategorias = catGastos.map(c => ({ id: c.id, nome: c.name }));

                    // 6. Mapeia Categorias de Contas Fixas
                    state.contaFixaCategorias = catFixas.map(c => ({ id: c.id, nome: c.name }));

                    // 7. Mapeia MONITORES
                    state.monitores = monitoresCloud.map(m => {
                        let habilidades = null;
                        try {
                            habilidades = m.habilidades ? JSON.parse(m.habilidades) : null;
                        } catch (e) {
                            console.warn('Erro ao parsear habilidades:', m.id, e);
                        }

                        return {
                            id: m.id,
                            nome: m.nome,
                            nascimento: m.nascimento,
                            telefone: m.telefone,
                            email: m.email,
                            endereco: m.endereco,
                            observacoes: m.observacoes,
                            cnh: m.cnh,
                            cnhCategoria: m.cnhCategoria,
                            fotoPerfil: m.fotoPerfil,
                            fotoDocumento: m.fotoDocumento,
                            habilidades: habilidades || { forca: 5, agilidade: 5, proatividade: 5, comunicacao: 5, disponibilidade: 5, respeito: 5 },
                            desempenho: m.desempenho || []
                        };
                    });

                    // 8. Mapeia PAGAMENTOS DE MONITORES
                    state.pagamentosMonitores = pagamentosCloud.map(p => ({
                        id: p.id,
                        data: p.data,
                        monitorId: p.monitorId,
                        nome: p.nome,
                        valorBase: p.valorBase,
                        adicional: p.adicional,
                        horasExtras: p.horasExtras,
                        pagamento: p.pagamento,
                        statusPagamento: p.statusPagamento,
                        horaEntrada: p.horaEntrada,
                        horaSaida: p.horaSaida,
                        numEventos: p.numEventos
                    }));

                    // 9. Mapeia FUNCION√ÅRIOS
                    state.funcionarios = funcionariosCloud.map(f => ({
                        id: f.id,
                        nome: f.nome,
                        salarioFixo: f.salarioFixo,
                        va: f.va,
                        vt: f.vt
                    }));

                    // 10. Mapeia FAIXAS DE COMISS√ÉO
                    state.faixasComissao = faixasCloud.map(fx => ({
                        id: fx.id,
                        ateValor: fx.ateValor,
                        percentual: fx.percentual
                    }));

                    // 11. Se categorias estiverem vazias, popular com dados padr√£o
                    if (catGastos.length === 0 || catFixas.length === 0) {
                        console.log("‚ö†Ô∏è Categorias vazias! Populando banco de dados...");
                        try {
                            const token = getToken ? getToken() : null;
                            const seedRes = await fetch(`${API_BASE_URL}/api/finance/seed-categories`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                }
                            });
                            if (seedRes.ok) {
                                console.log("‚úÖ Categorias padr√£o criadas! Recarregando...");
                                const [newCatGastos, newCatFixas] = await Promise.all([
                                    window.api.getCategoriasGastos(),
                                    window.api.getCategoriasFixas()
                                ]);
                                state.gastoCategorias = newCatGastos.map(c => ({ id: c.id, nome: c.name }));
                                state.contaFixaCategorias = newCatFixas.map(c => ({ id: c.id, nome: c.name }));
                            }
                        } catch (seedError) {
                            console.error("Erro ao popular categorias:", seedError);
                        }
                    }

                    // 12. Se funcion√°rios/faixas estiverem vazios, popular dados padr√£o
                    if (funcionariosCloud.length === 0 || faixasCloud.length === 0) {
                        console.log("‚ö†Ô∏è Dados de sal√°rio vazios! Populando banco...");
                        try {
                            const token = getToken ? getToken() : null;
                            const seedRes = await fetch(`${API_BASE_URL}/api/finance/seed-salarios`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                }
                            });
                            if (seedRes.ok) {
                                console.log("‚úÖ Dados de sal√°rio criados! Recarregando...");
                                const [newFunc, newFaixas] = await Promise.all([
                                    window.api.getFuncionarios(),
                                    window.api.getFaixasComissao()
                                ]);
                                state.funcionarios = newFunc.map(f => ({ id: f.id, nome: f.nome, salarioFixo: f.salarioFixo, va: f.va, vt: f.vt }));
                                state.faixasComissao = newFaixas.map(fx => ({ id: fx.id, ateValor: fx.ateValor, percentual: fx.percentual }));
                            }
                        } catch (seedError) {
                            console.error("Erro ao popular sal√°rios:", seedError);
                        }
                    }

                    console.log("üìã State final ap√≥s carregar tudo:", {
                        eventos: state.eventos.length,
                        gastos: state.gastos.length,
                        contas: state.contas.length,
                        contasFixas: state.contasFixas.length,
                        gastoCategorias: state.gastoCategorias.length,
                        contaFixaCategorias: state.contaFixaCategorias.length,
                        monitores: state.monitores.length,
                        pagamentosMonitores: state.pagamentosMonitores.length,
                        funcionarios: state.funcionarios.length,
                        faixasComissao: state.faixasComissao.length
                    });

                    console.log("‚úÖ Dados sincronizados!");
                    renderAll(); // Atualiza tudo (gr√°ficos, tabelas, etc.)

                } catch (error) {
                    console.error("‚ùå Erro ao carregar dados do servidor:", error);
                    console.error("Detalhes do erro:", error.message, error.stack);
                    showToast("Erro ao conectar com o servidor. Verifique o console.", true);
                }
            };

            // Torna a fun√ß√£o acess√≠vel globalmente tamb√©m via window
            window.loadDataFromCloud = loadDataFromCloud;

            // --- 2. RENDERIZA√á√ÉO ---
            const renderAll = () => {
                const monthInput = getById('month-filter-global');
                if (monthInput) monthInput.value = state.selectedMonth;

                // Filtra dados pelo m√™s selecionado
                const gastosMes = state.gastos.filter(g => g.data.startsWith(state.selectedMonth));
                const eventosMes = state.eventos.filter(e => e.data.startsWith(state.selectedMonth));
                const receitasMes = state.receitas?.filter(r => r.data.startsWith(state.selectedMonth)) || [];

                // C√°lculo M√™s Anterior para Compara√ß√£o
                const [currAno, currMes] = state.selectedMonth.split('-').map(Number);
                const prevDate = new Date(currAno, currMes - 2, 1);
                const prevMonthStr = prevDate.toISOString().slice(0, 7);

                const gastPrev = state.gastos.filter(g => g.data.startsWith(prevMonthStr));
                const evPrev = state.eventos.filter(e => e.data.startsWith(prevMonthStr));
                const recPrev = state.receitas?.filter(r => r.data.startsWith(prevMonthStr)) || [];

                // Valores Atuais
                const recEvAtual = eventosMes.reduce((acc, e) => acc + (e.valor || 0), 0);
                const recManAtual = receitasMes.reduce((acc, r) => acc + (r.valor || 0), 0);
                const recAtual = recEvAtual + recManAtual;
                const despAtual = gastosMes.reduce((acc, g) => acc + (g.valor || 0), 0);
                const saldoAtual = recAtual - despAtual;

                // Valores Anteriores
                const recEvPrev = evPrev.reduce((acc, e) => acc + (e.valor || 0), 0);
                const recManPrev = recPrev.reduce((acc, r) => acc + (r.valor || 0), 0);
                const recAnterior = recEvPrev + recManPrev;
                const despAnterior = gastPrev.reduce((acc, g) => acc + (g.valor || 0), 0);
                const saldoAnterior = recAnterior - despAnterior;

                const getChangeHTML = (atual, anterior, invert = false) => {
                    if (anterior === 0) return '<span class="text-gray-400">Sem dados do m√™s anterior</span>';
                    const diff = ((atual - anterior) / anterior) * 100;
                    const isPositive = diff >= 0;
                    const colorClass = (isPositive !== invert) ? 'text-emerald-600' : 'text-red-600';
                    const icon = isPositive ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
                    return `<span class="${colorClass} font-bold"><i class="fa-solid ${icon} mr-1"></i>${Math.abs(diff).toFixed(1)}%</span> vs m√™s anterior`;
                };

                // Atualiza Cards do Dashboard
                getById('total-receitas').textContent = formatarMoeda(recAtual);
                getById('receitas-comparison').innerHTML = getChangeHTML(recAtual, recAnterior);

                getById('total-despesas').textContent = formatarMoeda(despAtual);
                getById('despesas-comparison').innerHTML = getChangeHTML(despAtual, despAnterior, true);

                const elSaldo = getById('saldo-total');
                elSaldo.textContent = formatarMoeda(saldoAtual);
                elSaldo.className = `text-4xl font-bold ${saldoAtual >= 0 ? 'text-blue-600' : 'text-red-600'}`;
                getById('saldo-comparison').innerHTML = getChangeHTML(saldoAtual, saldoAnterior);

                // Renderiza Tabela de Gastos
                const tbodyGastos = getById('tabela-gastos')?.querySelector('tbody');
                if (tbodyGastos) {
                    if (gastosMes.length === 0) {
                        tbodyGastos.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum gasto neste m√™s.</td></tr>';
                    } else {
                        tbodyGastos.innerHTML = gastosMes.sort((a, b) => new Date(a.data) - new Date(b.data)).map(g => `
                                <tr>
                                    <td>${formatarData(g.data)}</td>
                                    <td>${g.descricao}</td>
                                    <td>${g.categoria}</td>
                                    <td>${g.conta}</td>
                                    <td>${g.pagamento}</td>
                                    <td class="font-bold text-red-600">${formatarMoeda(g.valor)}</td>
                                    <td>
                                        <div class="flex space-x-2">
                                            <button onclick="editarGasto('${g.id}')" 
                                                    class="text-indigo-600 hover:text-indigo-900 transition-colors"
                                                    title="Editar Gasto">
                                                <i class="fa-solid fa-edit"></i>
                                            </button>
                                            <button onclick="deletarGasto('${g.id}')" 
                                                    class="text-red-600 hover:text-red-900 transition-colors"
                                                    title="Excluir Gasto">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                    }
                }

                // Renderiza Tabela de Entradas (Eventos + Receitas Manuais)
                const tbodyEventos = getById('tabela-eventos')?.querySelector('tbody');
                if (tbodyEventos) {
                    // Combina eventos e receitas manuais
                    const entradasEventos = eventosMes.map(e => ({
                        data: e.data,
                        tipo: 'üìÖ Evento',
                        descricao: e.contratante,
                        detalhes: 'Itens do Evento',
                        valor: e.valor,
                        deletavel: false,
                        id: null
                    }));

                    const entradasManuais = receitasMes.map(r => ({
                        data: r.data,
                        tipo: 'üí∞ Entrada Avulsa',
                        descricao: r.descricao,
                        detalhes: r.categoria,
                        valor: r.valor,
                        deletavel: true,
                        id: r.id
                    }));

                    const todasEntradas = [...entradasEventos, ...entradasManuais]
                        .sort((a, b) => new Date(a.data) - new Date(b.data));

                    if (todasEntradas.length === 0) {
                        tbodyEventos.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma entrada neste m√™s.</td></tr>';
                    } else {
                        tbodyEventos.innerHTML = todasEntradas.map(entry => `
                                <tr>
                                    <td>${formatarData(entry.data)}</td>
                                    <td>${entry.tipo}</td>
                                    <td>${entry.descricao}</td>
                                    <td>-</td>
                                    <td>${entry.detalhes}</td>
                                    <td class="font-bold text-green-600">${formatarMoeda(entry.valor)}</td>
                                    <td>
                                        ${entry.deletavel
                                ? `<button onclick="deletarEntradaManual('${entry.id}')" 
                                                       class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-sm transition-colors"
                                                       title="Deletar">
                                                   <i class="fa-solid fa-trash-can"></i>
                                               </button>`
                                : '<span class="text-gray-400 text-xs">-</span>'
                            }
                                    </td>
                                </tr>
                            `).join('');
                    }
                }

                // Renderiza Tabela de Contas Fixas (Cadastros)
                const tbodyContasFixas = getById('tabela-contas-fixas-db')?.querySelector('tbody');
                if (tbodyContasFixas && state.contasFixas) {
                    if (state.contasFixas.length === 0) {
                        tbodyContasFixas.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma conta fixa cadastrada.</td></tr>';
                    } else {
                        tbodyContasFixas.innerHTML = state.contasFixas.map(cf => `
                            <tr>
                                <td>${cf.descricao}</td>
                                <td>${formatarMoeda(cf.valor)}</td>
                                <td>${cf.diaVencimento}</td>
                                <td>${cf.categoria}</td>
                                <td>${cf.tipoRecorrencia === 'parcelada' ? `${cf.numParcelas}x` : 'Permanente'}</td>
                                <td class="text-center">${cf.anexos?.length || 0}</td>
                                <td>
                                    <div class="flex space-x-2">
                                        <button onclick="editarContaFixa('${cf.id}')" class="text-indigo-600 hover:text-indigo-900" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                        <button onclick="deletarContaFixa('${cf.id}')" class="text-red-600 hover:text-red-900" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza Tabela de Contas Banc√°rias
                const tbodyContas = getById('tabela-contas-db')?.querySelector('tbody');
                if (tbodyContas && state.contas) {
                    if (state.contas.length === 0) {
                        tbodyContas.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma conta banc√°ria cadastrada.</td></tr>';
                    } else {
                        tbodyContas.innerHTML = state.contas.map(c => `
                            <tr>
                                <td>${c.nome}</td>
                                <td>${c.banco}</td>
                                <td>${c.tipo}</td>
                                <td>${c.agencia || ''} / ${c.numero || ''}</td>
                                <td>
                                    <div class="flex space-x-2">
                                        <button onclick="editarContaBancaria('${c.id}')" class="text-indigo-600 hover:text-indigo-900" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                        <button onclick="deletarContaBancaria('${c.id}')" class="text-red-600 hover:text-red-900" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Popula Selects de Categorias
                const populateSelect = (selectId, items, placeholder, nameField = 'nome') => {
                    const select = getById(selectId);
                    if (select && items) {
                        select.innerHTML = `<option value="">-- ${placeholder} --</option>` +
                            items.map(item => `<option value="${item[nameField]}">${item[nameField]}</option>`).join('');
                    }
                };

                populateSelect('gasto-categoria', state.gastoCategorias, 'Selecione uma categoria');
                populateSelect('conta-fixa-categoria', state.contaFixaCategorias, 'Selecione uma categoria');

                // Popula Select de Contas Banc√°rias
                const selectConta = getById('gasto-conta');
                const selectContaCF = getById('lancamento-cf-conta');
                if (state.contas) {
                    const options = '<option value="">-- Selecione uma conta --</option>' +
                        state.contas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

                    if (selectConta) selectConta.innerHTML = options;
                    if (selectContaCF) selectContaCF.innerHTML = options;
                }

                // Renderiza Cards de Lan√ßamento de Contas Fixas do M√™s (VISUAL UPGRADE)
                const containerContasFixasMes = getById('tabela-contas-fixas-mes')?.closest('.table-wrapper');
                if (containerContasFixasMes) {
                    const contasDoMes = getContasFixasDoMes(state.selectedMonth);

                    if (contasDoMes.length === 0) {
                        containerContasFixasMes.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-inbox text-4xl mb-2"></i><p>Nenhuma conta fixa ativa neste m√™s.</p></div>';
                    } else {
                        // Para cada conta, verifica status
                        const [anoMes, mesMes] = state.selectedMonth.split('-').map(Number);
                        const hoje = new Date();
                        const diaHoje = hoje.getDate();
                        const mesHoje = hoje.getMonth() + 1;
                        const anoHoje = hoje.getFullYear();
                        const ehMesAtual = (anoMes === anoHoje && mesMes === mesHoje);

                        const cardsHTML = contasDoMes.map(cf => {
                            // Calcula n√∫mero da parcela (se parcelada)
                            let parcelaAtual = null;
                            if (cf.tipoRecorrencia === 'parcelada' && cf.dataInicio && cf.numParcelas) {
                                const [anoInicio, mesInicio] = cf.dataInicio.split('-').map(Number);
                                const mesesPassados = (anoMes - anoInicio) * 12 + (mesMes - mesInicio);
                                parcelaAtual = mesesPassados + 1;
                            }

                            // Verifica se j√° foi lan√ßada (procura nos gastos)
                            const foiLancada = state.gastos.some(g =>
                                g.data.startsWith(state.selectedMonth) &&
                                g.descricao.includes(cf.descricao) &&
                                g.descricao.includes('[Conta Fixa]')
                            );

                            // Verifica se est√° atrasada
                            const estaAtrasada = ehMesAtual && diaHoje > cf.diaVencimento && !foiLancada;

                            // Define status e cores
                            let statusClass, statusIcon, statusText, statusBadge;
                            if (foiLancada) {
                                statusClass = 'border-l-4 border-green-500 bg-green-50/50';
                                statusIcon = 'fa-circle-check text-green-600';
                                statusText = 'Pago';
                                statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full">‚úì PAGO</span>';
                            } else if (estaAtrasada) {
                                statusClass = 'border-l-4 border-red-500 bg-red-50/50 animate-pulse';
                                statusIcon = 'fa-circle-exclamation text-red-600';
                                statusText = 'Atrasado';
                                statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full animate-pulse">‚ö† ATRASADA</span>';
                            } else {
                                statusClass = 'border-l-4 border-yellow-500 bg-yellow-50/50';
                                statusIcon = 'fa-clock text-yellow-600';
                                statusText = 'Pendente';
                                statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full">‚è≥ PENDENTE</span>';
                            }

                            return `
                                <div class="glassmorphism ${statusClass} p-4 rounded-lg mb-3 hover:shadow-lg transition-all duration-300">
                                    <!-- Cabe√ßalho do Card -->
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <i class="fa-solid ${statusIcon} text-lg"></i>
                                                <h4 class="font-bold text-gray-800 text-base">${cf.descricao}</h4>
                                            </div>
                                            <div class="flex items-center gap-2 flex-wrap mt-1">
                                                ${statusBadge}
                                                ${parcelaAtual ? `<span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-bold rounded-full">üìä Parcela ${parcelaAtual}/${cf.numParcelas}</span>` : '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-bold rounded-full">‚ôæÔ∏è PERMANENTE</span>'}
                                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${cf.categoria}</span>
                                            </div>
                                        </div>
                                        <div class="text-right ml-3">
                                            <p class="text-2xl font-bold ${estaAtrasada ? 'text-red-600' : 'text-gray-800'}">${formatarMoeda(cf.valor)}</p>
                                            <p class="text-xs text-gray-500">Venc: dia ${cf.diaVencimento}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Informa√ß√µes Adicionais -->
                                    <div class="flex items-center justify-between text-xs text-gray-600 mb-3 pb-3 border-b border-gray-200">
                                        <span><i class="fa-solid fa-calendar-days mr-1"></i> ${cf.tipoRecorrencia === 'parcelada' ? `Parcelada (${cf.numParcelas}x)` : 'Permanente'}</span>
                                        ${cf.anexos && cf.anexos.length > 0 ? `<span><i class="fa-solid fa-paperclip mr-1"></i> ${cf.anexos.length} anexo(s)</span>` : ''}
                                    </div>
                                    
                                    <!-- Bot√µes de A√ß√£o -->
                                    <div class="flex gap-2 flex-wrap">
                                        ${!foiLancada ? `
                                            <button class="shiny-btn px-3 py-1.5 rounded text-sm flex-1 min-w-[120px]" 
                                                    onclick="lancarGastoDeContaFixa('${cf.id}')" 
                                                    title="Lan√ßar como Gasto">
                                                <i class="fa-solid fa-money-bill-wave mr-1"></i> Lan√ßar Gasto
                                            </button>
                                        ` : `
                                            <div class="flex-1 px-3 py-1.5 bg-green-100 text-green-800 rounded text-sm text-center font-semibold">
                                                <i class="fa-solid fa-check-double mr-1"></i> J√° Lan√ßado
                                            </div>
                                        `}
                                        <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded text-sm transition-colors" 
                                                onclick="alert('Editar conta ID: ${cf.id}')" 
                                                title="Editar">
                                            <i class="fa-solid fa-pencil"></i>
                                        </button>
                                        <button class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded text-sm transition-colors" 
                                                onclick="if(confirm('Excluir esta conta?')) { deletarContaFixa('${cf.id}'); }" 
                                                title="Excluir">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        containerContasFixasMes.innerHTML = cardsHTML;
                    }
                }

                // Renderiza Tabela de Categorias de Gastos
                const tbodyGastoCategorias = getById('tabela-gasto-categorias-db')?.querySelector('tbody');
                if (tbodyGastoCategorias && state.gastoCategorias) {
                    if (state.gastoCategorias.length === 0) {
                        tbodyGastoCategorias.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhuma categoria cadastrada.</td></tr>';
                    } else {
                        tbodyGastoCategorias.innerHTML = state.gastoCategorias.map(cat => `
                            <tr>
                                <td>${cat.nome}</td>
                                <td>
                                    <button class="action-btn delete-btn" onclick="if(confirm('Excluir categoria ${cat.nome}?')) { deletarCategoriaGasto('${cat.id}'); }" title="Excluir">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza Tabela de Categorias de Contas Fixas
                const tbodyCFCategorias = getById('tabela-cf-categorias-db')?.querySelector('tbody');
                if (tbodyCFCategorias && state.contaFixaCategorias) {
                    if (state.contaFixaCategorias.length === 0) {
                        tbodyCFCategorias.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhuma categoria cadastrada.</td></tr>';
                    } else {
                        tbodyCFCategorias.innerHTML = state.contaFixaCategorias.map(cat => `
                            <tr>
                                <td>${cat.nome}</td>
                                <td>
                                    <button class="action-btn delete-btn" onclick="if(confirm('Excluir categoria ${cat.nome}?')) { deletarCategoriaContaFixa('${cat.id}'); }" title="Excluir">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // Renderiza os gr√°ficos com os dados atualizados
                if (window.renderAllCharts && typeof window.renderAllCharts === 'function') {
                    console.log('üìä Atualizando gr√°ficos para o m√™s:', state.selectedMonth);
                    window.renderAllCharts(state);
                }

                console.log("‚úÖ Renderiza√ß√£o completa!");
            };

            // ========== FUN√á√ïES GLOBAIS DE DELETE ==========

            window.deletarContaBancaria = async (id) => {
                if (!confirm('Deseja realmente excluir esta conta banc√°ria?')) return;
                const sucesso = await window.api.deletarItem(id, 'accounts');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Conta banc√°ria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir conta.', true);
                }
            };

            window.deletarContaFixa = async (id) => {
                if (!confirm('Deseja realmente excluir esta conta fixa?')) return;
                const sucesso = await window.api.deletarItem(id, 'fixed-expenses');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Conta fixa exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir conta fixa.', true);
                }
            };

            window.deletarCategoriaGasto = async (id) => {
                if (!confirm('Deseja realmente excluir esta categoria?')) return;
                const sucesso = await window.api.deletarItem(id, 'categories-expenses');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Categoria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir categoria.', true);
                }
            };

            window.deletarCategoriaContaFixa = async (id) => {
                if (!confirm('Deseja realmente excluir esta categoria?')) return;
                const sucesso = await window.api.deletarItem(id, 'categories-fixed');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Categoria exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir categoria.', true);
                }
            };

            // Deletar Entrada Manual (Receita)
            window.deletarEntradaManual = async (id) => {
                if (!confirm('Deseja realmente excluir esta entrada manual?')) return;
                const sucesso = await window.api.deletarItem(id, 'transactions');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Entrada manual exclu√≠da!');
                } else {
                    showToastModal('‚ùå Erro ao excluir entrada manual.', true);
                }
            };

            window.deletarGasto = async (id) => {
                if (!confirm('Deseja realmente excluir este gasto?')) return;
                const sucesso = await window.api.deletarItem(id, 'transactions');
                if (sucesso) {
                    await window.loadDataFromCloud();
                    showToastModal('‚úÖ Gasto exclu√≠do com sucesso!');
                } else {
                    showToastModal('‚ùå Erro ao excluir gasto.', true);
                }
            };

            window.editarGasto = (id) => {
                const gasto = state.gastos.find(g => g.id === id);
                if (!gasto) return;

                const form = getById('form-gasto');
                const modal = getById('add-gasto-modal');

                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                getById('gasto-data').value = gasto.data;
                getById('gasto-descricao').value = gasto.descricao;
                getById('gasto-valor').value = gasto.valor;
                getById('gasto-categoria').value = gasto.categoria;
                getById('gasto-pagamento').value = gasto.pagamento;
                getById('gasto-conta').value = gasto.contaId || '';

                const btnSubmit = form.querySelector('button[type="submit"]');
                if (btnSubmit) btnSubmit.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Gasto';

                modal.classList.remove('hidden');
            };

            // ========== FUN√á√ïES GLOBAIS DE EDI√á√ÉO ==========

            window.editarContaBancaria = (id) => {
                const conta = state.contas.find(c => c.id === id);
                if (!conta) return;

                const form = document.getElementById('form-cadastro-conta');
                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                document.getElementById('cadastro-conta-nome').value = conta.nome;
                document.getElementById('cadastro-conta-banco').value = conta.banco;
                document.getElementById('cadastro-conta-tipo').value = conta.tipo;
                document.getElementById('cadastro-conta-agencia').value = conta.agencia || '';
                document.getElementById('cadastro-conta-numero').value = conta.numero || '';

                const btnSalvar = form.querySelector('button[type="submit"]');
                btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Conta';

                document.getElementById('modal-contas-bancarias').classList.remove('hidden');
            };

            window.editarContaFixa = (id) => {
                const cf = state.contasFixas.find(c => c.id === id);
                if (!cf) return;

                const form = document.getElementById('form-conta-fixa');
                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-id', id);

                document.getElementById('conta-fixa-descricao').value = cf.descricao;
                document.getElementById('conta-fixa-valor').value = cf.valor;
                document.getElementById('conta-fixa-dia-vencimento').value = cf.diaVencimento;
                document.getElementById('conta-fixa-categoria').value = cf.categoria;
                document.getElementById('conta-fixa-tipo-recorrencia').value = cf.tipoRecorrencia;

                // For√ßa atualiza√ß√£o dos containers de parcelamento/permanente
                // (Assumindo que o listener de change tratar√° os campos hidden)
                const event = new Event('change');
                document.getElementById('conta-fixa-tipo-recorrencia').dispatchEvent(event);

                if (cf.tipoRecorrencia === 'parcelada') {
                    document.getElementById('conta-fixa-data-inicio').value = cf.dataInicio;
                    document.getElementById('conta-fixa-num-parcelas').value = cf.numParcelas;
                }

                const btnSalvar = form.querySelector('button[type="submit"]');
                btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Atualizar Conta Fixa';

                document.getElementById('modal-conta-fixa').classList.remove('hidden');
            };

            // ========== FUN√á√ÉO DE LAN√áAR GASTO DE CONTA FIXA ==========

            // ========== FUN√á√ÉO DE LAN√áAR GASTO DE CONTA FIXA ==========

            window.lancarGastoDeContaFixa = (contaFixaId) => {
                const contaFixa = state.contasFixas.find(cf => cf.id === contaFixaId);
                if (!contaFixa) return showToastModal('Conta fixa n√£o encontrada!', true);

                const modal = getById('lancamento-conta-fixa-modal');
                const form = getById('form-lancamento-conta-fixa');

                getById('lancamento-cf-descricao').value = contaFixa.descricao;
                getById('lancamento-cf-valor').value = contaFixa.valor;
                getById('lancamento-cf-data').value = new Date().toISOString().split('T')[0];

                form.setAttribute('data-id', contaFixa.id);
                modal.classList.remove('hidden');
            };

            formLancamentoCF = getById('form-lancamento-conta-fixa');
            formLancamentoCF?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const cfId = formLancamentoCF.getAttribute('data-id');
                const cf = state.contasFixas.find(c => c.id === cfId);

                const dados = {
                    date: getById('lancamento-cf-data').value,
                    description: `${getById('lancamento-cf-descricao').value} [Conta Fixa]`,
                    amount: parseFloat(getById('lancamento-cf-valor').value),
                    category: cf ? cf.category : 'Outros',
                    accountId: getById('lancamento-cf-conta').value,
                    paymentMethod: 'Transfer√™ncia/D√©bito',
                    type: 'EXPENSE'
                };

                const sucesso = await window.api.salvarTransacao(dados);
                if (sucesso) {
                    showToastModal('‚úÖ Gasto de conta fixa lan√ßado!');
                    getById('lancamento-conta-fixa-modal').classList.add('hidden');
                    if (window.loadDataFromCloud) await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao lan√ßar gasto.', true);
                }
            });

            // ESC para fechar novo modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    getById('lancamento-conta-fixa-modal')?.classList.add('hidden');
                }
            });

            // Fechar ao clicar fora
            const modalLCF = getById('lancamento-conta-fixa-modal');
            modalLCF?.addEventListener('click', (e) => {
                if (e.target === modalLCF) modalLCF.classList.add('hidden');
            });

            // Close button de todos os modais (generic)
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.fixed')?.classList.add('hidden');
                    btn.closest('.modal-backdrop')?.classList.add('hidden');
                });
            });

            // NOTA: Fun√ß√£o auxiliar para filtrar contas fixas ativas em um m√™s
            const getContasFixasDoMes = (mesAno) => {
                if (!state.contasFixas || state.contasFixas.length === 0) return [];

                const [ano, mes] = mesAno.split('-').map(Number);

                return state.contasFixas.filter(cf => {
                    // Se for permanente, sempre aparece
                    if (cf.tipoRecorrencia === 'permanente') return true;

                    // Se for parcelada, verifica se est√° no intervalo
                    if (cf.tipoRecorrencia === 'parcelada' && cf.dataInicio && cf.numParcelas) {
                        const [anoInicio, mesInicio] = cf.dataInicio.split('-').map(Number);
                        const dataInicio = new Date(anoInicio, mesInicio - 1);
                        const dataFim = new Date(anoInicio, mesInicio - 1 + cf.numParcelas);
                        const dataAtual = new Date(ano, mes - 1);

                        return dataAtual >= dataInicio && dataAtual < dataFim;
                    }

                    return false;
                });
            };

            // --- 3. EXPORTAR PDF ELEGANTE (Integrado) ---
            const exportarGastosPDF = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

                    // Filtra dados do m√™s atual
                    const gastosFiltrados = state.gastos
                        .filter(g => g.data.startsWith(state.selectedMonth))
                        .sort((a, b) => new Date(a.data) - new Date(b.data));

                    if (gastosFiltrados.length === 0) {
                        showToast("N√£o h√° gastos neste m√™s para exportar.", true);
                        return;
                    }

                    // --- Cabe√ßalho Elegante ---
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(20);
                    doc.setTextColor(63, 81, 181);
                    doc.text('Relat√≥rio de Gastos', 40, 55);

                    doc.setDrawColor(79, 70, 229);
                    doc.setLineWidth(1);
                    doc.line(40, 65, 555, 65);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(90, 90, 90);
                    doc.text(`Empresa: Aero & ABC Festas`, 40, 80);

                    const [ano, mes] = state.selectedMonth.split('-');
                    doc.text(`Per√≠odo: ${mes}/${ano}`, 40, 95);

                    // Prepara dados para a tabela
                    const tableColumn = ["Data", "Descri√ß√£o", "Categoria", "Pgto", "Valor"];
                    const tableRows = [];
                    let total = 0;

                    gastosFiltrados.forEach(g => {
                        total += parseFloat(g.valor || 0);
                        tableRows.push([
                            formatarData(g.data),
                            g.descricao,
                            g.categoria,
                            g.pagamento,
                            { content: formatarMoeda(g.valor), styles: { halign: 'right', fontStyle: 'bold', textColor: [220, 38, 38] } } // Vermelho para gastos
                        ]);
                    });

                    // Linha de Total
                    tableRows.push([
                        { content: "TOTAL GERAL", colSpan: 4, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
                        { content: formatarMoeda(total), styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }
                    ]);

                    // --- Tabela Estilizada ---
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 115,
                        theme: 'grid',
                        styles: { fontSize: 10, cellPadding: 6, lineColor: [220, 220, 220], textColor: [40, 40, 40] },
                        headStyles: { fillColor: [63, 81, 181], textColor: 255, fontStyle: 'bold', halign: 'center' },
                        columnStyles: { 4: { halign: 'right' } }, // Alinha valor √† direita
                        alternateRowStyles: { fillColor: [250, 250, 255] },
                        margin: { left: 40, right: 40 },
                    });

                    // Rodap√©
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(9);
                        doc.setTextColor(150);
                        doc.text(`P√°gina ${i} de ${pageCount}`, doc.internal.pageSize.width - 80, doc.internal.pageSize.height - 20);
                    }

                    doc.save(`Relatorio_Gastos_${state.selectedMonth}.pdf`);
                    showToast("PDF gerado com sucesso!", false);

                } catch (err) {
                    console.error('Erro PDF:', err);
                    showToast('Erro ao gerar PDF.', true);
                }
            };

            // --- LISTENERS ---
            getById('export-gastos-pdf-btn').addEventListener('click', exportarGastosPDF);

            getById('month-filter-global').addEventListener('change', (e) => {
                state.selectedMonth = e.target.value;
                renderAll();
            });

            // Setas de navega√ß√£o de m√™s
            document.querySelectorAll('.month-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dir = parseInt(btn.dataset.direction);
                    const [y, m] = state.selectedMonth.split('-').map(Number);
                    const newDate = new Date(y, m - 1 + dir, 1);
                    state.selectedMonth = newDate.toISOString().slice(0, 7);
                    renderAll();
                });
            });

            // Fun√ß√µes Auxiliares
            const formatarMoeda = val => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
            const formatarData = str => { if (!str) return '-'; const p = str.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; };
            const showToast = (msg, isError) => {
                const toast = getById('toast');
                if (toast) {
                    getById('toast-message').textContent = msg;
                    toast.className = `fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
                    toast.classList.remove('hidden');
                    setTimeout(() => toast.classList.add('hidden'), 3000);
                }
            };

            // ========== NAVEGA√á√ÉO ENTRE ABAS ==========
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetPage = link.getAttribute('data-target');
                    navLinks.forEach(l => {
                        l.classList.remove('active', 'shiny-btn');
                        l.classList.add('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    });
                    link.classList.add('active', 'shiny-btn');
                    link.classList.remove('bg-white/50', 'hover:bg-white/80', 'text-gray-700');
                    pages.forEach(page => page.classList.remove('active'));
                    const selectedPage = document.getElementById(`page-${targetPage}`);
                    if (selectedPage) selectedPage.classList.add('active');
                });
            });

            // Fechar modais ao clicar no X ou fora
            document.querySelectorAll('.close-btn, .modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    if (modal) modal.classList.add('hidden');
                });
            });

            // Limpar erros ao digitar
            const setupInputListeners = (form) => {
                if (!form) return;
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        input.classList.remove('error', 'border-red-500');
                    });
                });
            };

            // ========== HANDLER PARA ENTRADA MANUAL DE RECEITA (MODAL) ==========
            const btnEntrada = document.getElementById('open-entrada-modal-btn');
            const modalEntrada = document.getElementById('modal-entrada-manual');
            const formEntrada = document.getElementById('form-entrada-manual');

            if (btnEntrada && modalEntrada && formEntrada) {
                btnEntrada.addEventListener('click', () => {
                    modalEntrada.style.display = 'flex';
                    modalEntrada.classList.remove('hidden');
                    document.getElementById('entrada-data').value = new Date().toISOString().split('T')[0];
                    document.getElementById('entrada-descricao').value = '';
                    document.getElementById('entrada-valor').value = '';
                });

                formEntrada.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const data = document.getElementById('entrada-data').value;
                    const descricao = document.getElementById('entrada-descricao').value.trim();
                    const valor = parseFloat(document.getElementById('entrada-valor').value);

                    if (!data || !descricao || isNaN(valor) || valor <= 0) {
                        showToastModal('Por favor, preencha todos os campos corretamente.', true);
                        return;
                    }

                    const novaReceita = {
                        date: data,
                        description: descricao,
                        amount: valor,
                        type: 'REVENUE',
                        category: 'Receita Avulsa',
                        paymentMethod: 'Entrada Manual'
                    };

                    const sucesso = await window.api.salvarTransacao(novaReceita);
                    if (sucesso) {
                        modalEntrada.style.display = 'none';
                        modalEntrada.classList.add('hidden');
                        await window.loadDataFromCloud();
                        showToastModal(`‚úÖ Entrada registrada: ${descricao}`);
                    } else {
                        showToastModal('Erro ao salvar entrada.', true);
                    }
                });
            }

            // Elementos dos modais
            const modalContaFixa = document.getElementById('modal-conta-fixa');
            const modalCategoriasCF = document.getElementById('modal-categorias-cf');
            const btnAbrirContaFixa = document.getElementById('open-conta-fixa-modal-btn');
            const btnAbrirCategorias = document.getElementById('open-categorias-cf-modal-btn');
            const btnFecharContaFixa = document.getElementById('close-conta-fixa-modal');
            const btnFecharCategorias = document.getElementById('close-categorias-cf-modal');
            const btnLimparContaFixa = document.getElementById('limpar-conta-fixa-btn');
            const formContaFixa = document.getElementById('form-conta-fixa');
            const formCategoria = document.getElementById('form-conta-fixa-categoria');

            // Abrir modal de Cadastrar Conta Fixa
            btnAbrirContaFixa?.addEventListener('click', () => {
                formContaFixa.reset();
                formContaFixa.removeAttribute('data-mode');
                formContaFixa.removeAttribute('data-id');
                const btnSalvar = formContaFixa.querySelector('button[type="submit"]');
                if (btnSalvar) btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Salvar Conta Fixa';
                modalContaFixa.classList.remove('hidden');
            });

            // Bot√£o Limpar formul√°rio de Conta Fixa
            btnLimparContaFixa?.addEventListener('click', () => {
                if (confirm('Deseja limpar todos os campos do formul√°rio?')) {
                    formContaFixa.reset();
                    formContaFixa.querySelectorAll('.error, .border-red-500').forEach(input => {
                        input.classList.remove('error', 'border-red-500');
                    });
                    showToastModal('Formul√°rio limpo com sucesso!');
                }
            });

            // Valida√ß√£o ao submeter Conta Fixa
            formContaFixa?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formContaFixa)) {
                    showToastModal('Por favor, preencha todos os campos obrigat√≥rios', true);
                    return;
                }

                const mode = formContaFixa.getAttribute('data-mode');
                const id = formContaFixa.getAttribute('data-id');

                const dados = {
                    description: document.getElementById('conta-fixa-descricao').value,
                    amount: parseFloat(document.getElementById('conta-fixa-valor').value),
                    dueDay: parseInt(document.getElementById('conta-fixa-dia-vencimento').value),
                    category: document.getElementById('conta-fixa-categoria').value,
                    recurrenceType: document.getElementById('conta-fixa-tipo-recorrencia').value
                };

                if (dados.recurrenceType === 'parcelada') {
                    dados.startDate = document.getElementById('conta-fixa-data-inicio').value;
                    dados.installments = parseInt(document.getElementById('conta-fixa-num-parcelas').value);
                }

                let sucesso;
                if (mode === 'edit' && id) {
                    sucesso = await window.api.atualizarContaFixa(id, dados);
                } else {
                    sucesso = await window.api.salvarContaFixa(dados);
                }

                if (sucesso) {
                    showToastModal(mode === 'edit' ? 'Conta Fixa atualizada!' : 'Conta Fixa cadastrada com sucesso!');
                    formContaFixa.reset();
                    modalContaFixa.classList.add('hidden');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar Conta Fixa', true);
                }
            });

            // ========== HANDLER PARA NOVO GASTO (MODAL) ==========
            const formGasto = getById('form-gasto');
            if (formGasto) {
                formGasto.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const mode = formGasto.getAttribute('data-mode');
                    const id = formGasto.getAttribute('data-id');

                    const data = getById('gasto-data').value;
                    const descricao = getById('gasto-descricao').value.trim();
                    const valor = parseFloat(getById('gasto-valor').value);
                    const categoria = getById('gasto-categoria').value;
                    const metodo = getById('gasto-pagamento').value;
                    const contaId = getById('gasto-conta').value;

                    if (!data || !descricao || isNaN(valor) || valor <= 0) {
                        showToastModal('Preencha os campos obrigat√≥rios corretamente.', true);
                        return;
                    }

                    const dadosGasto = {
                        date: data,
                        description: descricao,
                        amount: valor,
                        type: 'EXPENSE',
                        category: categoria,
                        paymentMethod: metodo,
                        accountId: contaId
                    };

                    let sucesso;
                    if (mode === 'edit' && id) {
                        sucesso = await window.api.atualizarTransacao(id, dadosGasto);
                    } else {
                        sucesso = await window.api.salvarTransacao(dadosGasto);
                    }

                    if (sucesso) {
                        showToastModal(mode === 'edit' ? '‚úÖ Gasto atualizado!' : '‚úÖ Gasto registrado!');
                        formGasto.reset();
                        hideModal('add-gasto-modal');
                        await window.loadDataFromCloud();
                    } else {
                        showToastModal('Erro ao salvar gasto.', true);
                    }
                });
            }

            // ========== NOVOS MODAIS: Contas Banc√°rias e Categorias de Gastos ==========
            const modalContasBancarias = getById('modal-contas-bancarias');
            const modalCategoriasGastos = getById('modal-categorias-gastos');
            const btnAbrirContasBancarias = getById('open-contas-bancarias-modal-btn');
            const btnAbrirCategoriasGastos = getById('open-categorias-gastos-modal-btn');
            const btnLimparContaBancaria = getById('limpar-conta-bancaria-btn');
            const formContaBancaria = getById('form-cadastro-conta');
            const formCategoriaGasto = getById('form-gasto-categoria');

            btnAbrirContasBancarias?.addEventListener('click', () => {
                formContaBancaria.reset();
                formContaBancaria.removeAttribute('data-mode');
                formContaBancaria.removeAttribute('data-id');
                const btnSalvar = formContaBancaria.querySelector('button[type="submit"]');
                if (btnSalvar) btnSalvar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Salvar Conta';
                showModal('modal-contas-bancarias');
            });

            btnAbrirCategoriasGastos?.addEventListener('click', () => showModal('modal-categorias-gastos'));

            btnLimparContaBancaria?.addEventListener('click', () => {
                if (confirm('Deseja limpar todos os campos do formul√°rio?')) {
                    formContaBancaria.reset();
                    formContaBancaria.querySelectorAll('.error, .border-red-500').forEach(input => {
                        input.classList.remove('error', 'border-red-500');
                    });
                    showToastModal('Formul√°rio limpo com sucesso!');
                }
            });

            // Valida√ß√£o Conta Banc√°ria
            formContaBancaria?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formContaBancaria)) {
                    showToastModal('Por favor, preencha todos os campos obrigat√≥rios', true);
                    return;
                }

                const mode = formContaBancaria.getAttribute('data-mode');
                const id = formContaBancaria.getAttribute('data-id');

                const dados = {
                    name: getById('cadastro-conta-nome').value,
                    bank: getById('cadastro-conta-banco').value,
                    type: getById('cadastro-conta-tipo').value,
                    agency: getById('cadastro-conta-agencia').value,
                    number: getById('cadastro-conta-numero').value
                };

                let sucesso;
                if (mode === 'edit' && id) {
                    sucesso = await window.api.atualizarConta(id, dados);
                } else {
                    sucesso = await window.api.salvarConta(dados);
                }

                if (sucesso) {
                    showToastModal(mode === 'edit' ? 'Conta banc√°ria atualizada!' : 'Conta banc√°ria cadastrada com sucesso!');
                    formContaBancaria.reset();
                    hideModal('modal-contas-bancarias');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar conta bancaria', true);
                }
            });

            // ========== HANDLER PARA CADASTRAR MONITOR (MODAL) ==========
            const formMonitor = getById('form-cadastro-monitor');
            formMonitor?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formMonitor)) return;

                const dados = {
                    nome: getById('cadastro-monitor-nome').value,
                    nascimento: getById('cadastro-monitor-nascimento').value,
                    telefone: getById('cadastro-monitor-telefone').value,
                    email: getById('cadastro-monitor-email').value,
                    endereco: getById('cadastro-monitor-endereco').value,
                    observacoes: getById('cadastro-monitor-observacoes').value,
                    cnh: getById('cadastro-monitor-cnh').value === 'sim',
                    cnhCategoria: getById('cadastro-monitor-cnh-categoria').value,
                    habilidades: {
                        forca: parseInt(getById('habilidade-forca').value),
                        agilidade: parseInt(getById('habilidade-agilidade').value),
                        proatividade: parseInt(getById('habilidade-proatividade').value),
                        comunicacao: parseInt(getById('habilidade-comunicacao').value),
                        disponibilidade: parseInt(getById('habilidade-disponibilidade').value),
                        respeito: parseInt(getById('habilidade-respeito').value)
                    }
                };

                const sucesso = await window.api.salvarMonitor(dados);
                if (sucesso) {
                    showToastModal('‚úÖ Monitor cadastrado com sucesso!');
                    formMonitor.reset();
                    hideModal('add-monitor-modal');
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar monitor.', true);
                }
            });

            // Handlers para categorias
            getById('form-conta-fixa-categoria')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = getById('cf-categoria-nome');
                if (!input.value.trim()) return;
                const sucesso = await window.api.salvarCategoriaFixa(input.value.trim());
                if (sucesso) {
                    showToastModal('Categoria criada!');
                    input.value = '';
                    await window.loadDataFromCloud();
                }
            });

            getById('form-gasto-categoria')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = getById('gasto-categoria-nome');
                if (!input.value.trim()) return;
                const sucesso = await window.api.salvarCategoriaGasto(input.value.trim());
                if (sucesso) {
                    showToastModal('Categoria criada!');
                    input.value = '';
                    await window.loadDataFromCloud();
                }
            });

            // ========== HANDLERS PARA CONFIGURA√á√ïES DE SAL√ÅRIOS ==========
            const formAddFuncionario = getById('form-add-funcionario');
            formAddFuncionario?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formAddFuncionario)) return;

                const dados = {
                    nome: getById('funcionario-nome').value,
                    salarioFixo: parseFloat(getById('funcionario-salario').value),
                    va: parseFloat(getById('funcionario-va').value),
                    vt: parseFloat(getById('funcionario-vt').value)
                };

                const sucesso = await window.api.salvarFuncionario(dados);
                if (sucesso) {
                    showToastModal('Funcion√°rio cadastrado!');
                    formAddFuncionario.reset();
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar funcion√°rio', true);
                }
            });

            const formAddComissao = getById('form-add-comissao');
            formAddComissao?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm(formAddComissao)) return;

                const dados = {
                    ateValor: parseFloat(getById('comissao-atevalor').value),
                    percentual: parseFloat(getById('comissao-percentual').value) / 100
                };

                const sucesso = await window.api.salvarFaixaComissao(dados);
                if (sucesso) {
                    showToastModal('Faixa de comiss√£o cadastrada!');
                    formAddComissao.reset();
                    await window.loadDataFromCloud();
                } else {
                    showToastModal('Erro ao salvar faixa', true);
                }
            });

            // Setup listeners para remover erros
            setupInputListeners(formContaFixa);
            setupInputListeners(formContaBancaria);
            setupInputListeners(formGasto);
            setupInputListeners(formMonitor);
            setupInputListeners(formAddFuncionario);
            setupInputListeners(formAddComissao);
            if (formLancamentoCF) setupInputListeners(formLancamentoCF);

            // Fechar ao clicar fora (modais espec√≠ficos)
            [modalContaFixa, modalCategoriasCF, modalContasBancarias, modalCategoriasGastos].forEach(modal => {
                modal?.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.add('hidden');
                });
            });

            // Toggle Menu de Configura√ß√µes de Gastos
            const btnToggleConfig = getById('gastos-config-toggle');
            const menuConfig = getById('gastos-config-menu');

            btnToggleConfig?.addEventListener('click', (e) => {
                e.stopPropagation();
                menuConfig.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                menuConfig?.classList.add('hidden');
            });

            // ESC para fechar tudo
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.fixed.z-50').forEach(m => m.classList.add('hidden'));
                    menuConfig?.classList.add('hidden');
                }
            });

            // INICIA TUDO
            loadDataFromCloud();
        });
    </script>



    <style>
        :root {
            --glow-color: hsl(224, 88%, 66%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1f2937;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .header-title {
            background: linear-gradient(to right, #4f46e5, #a855f7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .modal-box.glassmorphism {
            background: rgba(255, 255, 255, 0.85);
        }

        .shiny-btn {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 51%, #4f46e5 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(60, 78, 224, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(60, 78, 224, 0.6);
        }

        .shiny-btn-red {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #dc2626 0%, #ef4444 51%, #dc2626 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(239, 68, 68, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn-red:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(239, 68, 68, 0.6);
        }

        /* Estilos para controle de p√°ginas/abas */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .shiny-btn-red:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .shiny-btn:disabled {
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .form-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #1f2937;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4f46e5;
            border-color: #4f46e5;
        }

        /* Page transitions */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom styles for tables */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(200, 200, 200, 0.5);
        }

        thead th {
            background-color: rgba(236, 240, 241, 0.5);
            font-weight: 600;
            color: #374151;
        }

        tbody tr:hover {
            background-color: rgba(243, 244, 246, 0.4);
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: color 0.2s;
            padding: 0;
        }

        .delete-btn {
            color: #ef4444;
        }

        .delete-btn:hover {
            color: #b91c1c;
        }

        .edit-btn {
            color: #f59e0b;
        }

        .edit-btn:hover {
            color: #b45309;
        }

        .action-btn:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Gemini Button Style Modernized */
        .gemini-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .gemini-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
            filter: brightness(1.1);
        }

        .gemini-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
            transition: 0.5s;
            pointer-events: none;
        }

        .gemini-btn:hover::after {
            left: 120%;
        }

        /* Dashboard Stat Cards Improvements */
        .dashboard-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .dashboard-card.receita {
            border-left-color: #10b981;
        }

        .dashboard-card.despesa {
            border-left-color: #ef4444;
        }

        .dashboard-card.saldo {
            border-left-color: #3b82f6;
        }

        .dashboard-card.ia {
            border-left-color: #8b5cf6;
        }

        .stat-icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover .stat-icon-bg {
            opacity: 0.1;
            transform: scale(1.1) rotate(0deg);
        }

        /* Anima√ß√£o de Digita√ß√£o para Placeholder */
        @keyframes typing-placeholder {

            0%,
            100% {
                placeholder: "Cole sua chave aqui";
            }

            20% {
                placeholder: "C";
            }

            25% {
                placeholder: "Co";
            }

            30% {
                placeholder: "Col";
            }

            35% {
                placeholder: "Cole";
            }

            40% {
                placeholder: "Cole ";
            }

            45% {
                placeholder: "Cole s";
            }

            50% {
                placeholder: "Cole su";
            }

            55% {
                placeholder: "Cole sua";
            }

            60% {
                placeholder: "Cole sua ";
            }

            70% {
                placeholder: "Cole sua ch";
            }

            80% {
                placeholder: "Cole sua cha";
            }

            90% {
                placeholder: "Cole sua chav";
            }

            95% {
                placeholder: "Cole sua chave";
            }
        }

        .form-input::placeholder {
            color: #d1d5db !important;
            /* Cinza claro */
            transition: color 0.3s ease;
        }

        .form-input:focus::placeholder {
            color: transparent !important;
        }

        .modal-backdrop {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        /* Valida√ß√£o de Formul√°rio */
        .form-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .form-input.error:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }


        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Animation */
        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-enter {
            animation: toast-in 0.5s ease-out forwards;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        /* Estilos do Menu de Monitores */
        #monitors-sidebar.collapsed {
            width: 0px;
            padding: 0;
            overflow: hidden;
            margin-left: -1.5rem;
            /* Compensa o gap */
        }

        #monitors-sidebar.collapsed .sidebar-content {
            opacity: 0;
        }

        #sidebar-toggle-btn.collapsed .fa-chevron-left {
            transform: rotate(180deg);
        }

        #monitors-sidebar-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: #374151;
        }

        #monitors-sidebar-list a:hover {
            background-color: rgba(230, 230, 245, 0.7);
        }

        /* Abas de Configura√ß√£o de Sal√°rio */
        .config-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .config-tab-btn.active {
            background-color: white;
            color: #4f46e5;
            border-color: #4f46e5;
        }

        .config-tab-btn:not(.active) {
            background-color: transparent;
            color: #4b5563;
        }

        .config-tab-content {
            display: none;
        }

        .config-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>

<body>
    <canvas id="particles-js"></canvas>

    <div class="container mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl header-title">Gest√£o Financeira</h1>
            <p class="text-gray-500 mt-2">Aero & ABC Festas</p>
            <div class="absolute top-0 left-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Dashboard.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Dashboard">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
            <div class="absolute top-0 right-0 flex space-x-2 p-2">
                <button onclick="window.location.href='./Agenda de eventos.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Agenda de Eventos">
                    <i class="fa-solid fa-calendar-days"></i>
                </button>
                <button onclick="window.location.href='./Sistema Gest√£o Financeira.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar Gest√£o Financeira">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button onclick="window.location.href='./Sistema de CRM.html'"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Acessar CRM">
                    <i class="fas fa-users"></i>
                </button>
                <button id="settings-btn"
                    class="bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors"
                    title="Configura√ß√µes">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <nav class="flex justify-center mb-8 space-x-1 md:space-x-2 flex-wrap">
            <button data-target="dashboard"
                class="nav-link active shiny-btn px-4 py-2 rounded-md text-sm md:text-base mb-2"><i
                    class="fa-solid fa-chart-pie mr-2"></i> Dashboard</button>
            <button data-target="entradas"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-calendar-check mr-2"></i> Entradas</button>
            <button data-target="gastos"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-cart-shopping mr-2"></i> Gastos</button>
            <button data-target="contas-fixas"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-file-invoice-dollar mr-2"></i> Contas Fixas</button>
            <button data-target="monitores"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-users mr-2"></i> Monitores</button>
            <button data-target="salarios"
                class="nav-link bg-white/50 hover:bg-white/80 text-gray-700 font-semibold px-4 py-2 rounded-md transition-all duration-300 text-sm md:text-base mb-2"><i
                    class="fa-solid fa-money-bill-wave mr-2"></i> Sal√°rios</button>
        </nav>

        <div class="month-filter-container glassmorphism p-4 rounded-lg mb-8 flex justify-center items-center gap-4">
            <button
                class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg"
                data-direction="-1">&lt;</button>
            <input type="month"
                class="month-filter form-input text-center font-semibold text-indigo-600 border-none shadow-inner"
                id="month-filter-global">
            <button
                class="month-nav-btn bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors font-bold text-lg"
                data-direction="1">&gt;</button>
        </div>

        <main>
            <div id="page-dashboard" class="page active">
                <section id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card receita">
                        <i class="fa-solid fa-arrow-up stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-arrow-up text-emerald-500"></i> Receitas do M√™s
                        </h3>
                        <p id="total-receitas" class="text-4xl font-bold text-emerald-600">R$ 0,00</p>
                        <div id="receitas-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card despesa">
                        <i class="fa-solid fa-arrow-down stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-arrow-down text-red-500"></i> Despesas do M√™s
                        </h3>
                        <p id="total-despesas" class="text-4xl font-bold text-red-500">R$ 0,00</p>
                        <div id="despesas-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg text-center dashboard-card saldo">
                        <i class="fa-solid fa-scale-balanced stat-icon-bg"></i>
                        <h3 class="font-semibold text-gray-600 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-building-columns text-blue-500"></i> Saldo do M√™s
                        </h3>
                        <p id="saldo-total" class="text-4xl font-bold text-blue-600">R$ 0,00</p>
                        <div id="saldo-comparison" class="text-xs mt-2 font-medium"></div>
                    </div>
                    <div
                        class="glassmorphism p-6 rounded-lg text-center flex flex-col justify-center items-center dashboard-card ia">
                        <i class="fa-solid fa-wand-magic-sparkles stat-icon-bg"></i>
                        <h3 class="font-bold text-indigo-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-robot"></i> Intelig√™ncia Aero
                        </h3>
                        <button onclick="openChat('dashboard')" class="gemini-btn w-full">
                            <i class="fa-solid fa-sparkles"></i> Gerar Insights
                        </button>
                    </div>
                </section>
                <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Receita por Empresa (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="empresas-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Distribui√ß√£o de Despesas (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="despesas-gerais-chart"></canvas>
                        </div>
                    </div>
                    <!-- Gr√°fico de Gastos & Compras removido por ser desnecess√°rio -->
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Contas Fixas (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="contas-fixas-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Pagamentos Monitores (M√™s)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="pagamentos-monitores-chart"></canvas>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-lg lg:col-span-2">
                        <h3 class="text-center font-bold text-gray-700 mb-4">Fluxo de Caixa Di√°rio (M√™s)</h3>
                        <div style="position: relative; height: 400px;">
                            <canvas id="daily-chart"></canvas>
                        </div>
                    </div>
                </section>
            </div>

            <div id="page-entradas" class="page">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Entradas Registradas no M√™s</h2>
                        <button id="open-entrada-modal-btn" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-plus mr-2"></i> Nova Entrada Manual</button>
                        <button id="export-entradas-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md mr-2">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>

                    </div>
                    <p class="text-sm text-gray-500 mb-4">Entradas marcadas com üìÖ foram importadas automaticamente da
                        Agenda de Eventos.</p>
                    <div class="table-wrapper">
                        <table id="tabela-eventos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Empresa</th>
                                    <th>Contratante</th>
                                    <th>Local</th>
                                    <th>Itens</th>
                                    <th>Valor Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="page-gastos" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Gastos Registrados no M√™s</h2>
                        <div class="flex items-center gap-2">
                            <button id="open-gasto-modal-btn" class="shiny-btn px-4 py-2 rounded-md"><i
                                    class="fa-solid fa-plus mr-2"></i> Lan√ßar Novo Gasto</button>
                            <button id="export-gastos-pdf-btn"
                                class="shiny-btn-red px-4 py-2 rounded-md text-sm md:text-base">
                                <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                            </button>
                            <button onclick="openChat('gastos')" class="gemini-btn"><i
                                    class="fa-solid fa-wand-magic-sparkles mr-2"></i>Analisar com IA</button>

                            <div class="relative inline-block text-left ml-2">
                                <button id="gastos-config-toggle"
                                    class="bg-white/40 hover:bg-white/60 text-gray-600 w-10 h-10 rounded-full transition-colors flex items-center justify-center"
                                    title="Configura√ß√µes de Gastos">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                                <div id="gastos-config-menu"
                                    class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-20 overflow-hidden transform transition-all duration-200 origin-top-right">
                                    <div class="py-1" role="menu">
                                        <button id="open-categorias-gastos-modal-btn"
                                            class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"
                                            role="menuitem">
                                            <i class="fa-solid fa-tags w-5 mr-2"></i> Categorias de Gastos
                                        </button>
                                        <button id="open-contas-bancarias-modal-btn"
                                            class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"
                                            role="menuitem">
                                            <i class="fa-solid fa-building-columns w-5 mr-2"></i> Contas Banc√°rias
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="tabela-gastos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Categoria</th>
                                    <th>Conta</th>
                                    <th>Pagamento</th>
                                    <th>Valor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Se√ß√£o de configura√ß√µes removida e movida para o √≠cone de engrenagem no cabe√ßalho -->
            </div>

            <div id="page-contas-fixas" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Contas Fixas</h2>
                        <div class="flex gap-2">
                            <button id="open-categorias-cf-modal-btn" class="shiny-btn-outline px-4 py-2 rounded-md"
                                title="Gerenciar Categorias">
                                <i class="fa-solid fa-gear mr-2"></i> Categorias
                            </button>
                            <button id="open-conta-fixa-modal-btn" class="shiny-btn px-4 py-2 rounded-md">
                                <i class="fa-solid fa-plus mr-2"></i> Cadastrar Conta Fixa
                            </button>
                        </div>
                    </div>
                </section>
                <section class="glassmorphism p-6 rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lan√ßamento de Contas Fixas do M√™s</h2>
                    <p class="text-sm text-gray-500 mb-4">Aqui s√£o listadas as contas (permanentes ou parcelas) ativas
                        para o m√™s selecionado.</p>
                    <div class="table-wrapper" id="contas-fixas-cards-container">
                        <!-- Os cards ser√£o gerados dinamicamente aqui -->
                        <table id="tabela-contas-fixas-mes" class="hidden">
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor Previsto</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Valor Pago</th>
                                    <th>Data Pag.</th>
                                    <th class="text-center"><i class="fa-solid fa-paperclip"></i></th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="page-monitores" class="page">
                <div class="flex gap-6 relative">
                    <button id="sidebar-toggle-btn"
                        class="absolute top-4 -left-3 z-20 bg-white/80 w-8 h-8 rounded-full shadow-md flex items-center justify-center text-indigo-600 transition-transform duration-300 hover:scale-110">
                        <i class="fas fa-chevron-left transition-transform duration-300"></i>
                    </button>

                    <aside id="monitors-sidebar"
                        class="glassmorphism p-4 rounded-lg h-fit transition-all duration-300 ease-in-out w-72 flex-shrink-0">
                        <div
                            class="flex justify-between items-center mb-4 transition-opacity duration-300 sidebar-content">
                            <h3 class="text-xl font-bold text-gray-800">Monitores</h3>
                            <button id="add-monitor-btn"
                                class="shiny-btn rounded-full w-10 h-10 flex items-center justify-center"
                                title="Adicionar Novo Monitor">
                                <i class="fa-solid fa-plus"></i>
                        </div>
                        <div id="monitors-sidebar-list"
                            class="space-y-1 transition-opacity duration-300 sidebar-content">
                        </div>
                    </aside>

                    <main id="monitors-main-content" class="flex-grow space-y-8 transition-all duration-300">
                        <section class="glassmorphism p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Monitores Cadastrados</h3>
                            <p class="text-sm text-gray-500 mb-4">Veja detalhes, edite ou exclua um monitor clicando em
                                sua foto/nome no menu √† esquerda ou usando os bot√µes de a√ß√£o abaixo.</p>
                            <div class="table-wrapper">
                                <table id="tabela-monitores-db">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Possui CNH?</th>
                                            <th>M√©dia Desempenho</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </section>
                        <section class="glassmorphism p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Desempenho dos Monitores (M√™s Selecionado)
                            </h3>
                            <div class="w-full h-80"><canvas id="monitor-event-performance-chart"></canvas></div>
                        </section>
                        <section class="glassmorphism p-6 rounded-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lan√ßar Pagamento & Avalia√ß√£o</h2>
                            <form id="form-pagamento-monitor" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div><label for="pagamento-monitor-data"
                                            class="block text-sm font-medium text-gray-700">Data do Evento</label><input
                                            type="date" id="pagamento-monitor-data" required
                                            class="form-input w-full mt-1">
                                    </div>
                                    <div class="lg:col-span-2"><label for="monitor-select"
                                            class="block text-sm font-medium text-gray-700">Selecione o
                                            Monitor</label><select id="monitor-select" required
                                            class="form-input w-full mt-1"></select></div>
                                    <div>
                                        <label for="pagamento-monitor-diaria"
                                            class="block text-sm font-medium text-gray-700">Valor da Di√°ria</label>
                                        <select id="pagamento-monitor-diaria" required class="form-input w-full mt-1">
                                            <option value="80">R$ 80,00</option>
                                            <option value="90">R$ 90,00</option>
                                            <option value="100" selected>R$ 100,00</option>
                                            <option value="120">R$ 120,00</option>
                                            <option value="outro">Outro Valor</option>
                                        </select>
                                        <div id="pagamento-monitor-diaria-outro-wrapper" class="hidden mt-2">
                                            <input type="number" id="pagamento-monitor-diaria-outro"
                                                placeholder="Digite o valor" step="0.01" class="form-input w-full">
                                        </div>
                                    </div>
                                    <div><label for="pagamento-monitor-entrada"
                                            class="block text-sm font-medium text-gray-700">Hora Entrada</label><input
                                            type="time" id="pagamento-monitor-entrada" required
                                            class="form-input w-full mt-1"></div>
                                    <div><label for="pagamento-monitor-saida"
                                            class="block text-sm font-medium text-gray-700">Hora Sa√≠da</label><input
                                            type="time" id="pagamento-monitor-saida" required
                                            class="form-input w-full mt-1"></div>
                                    <div class="lg:col-span-2"><label for="pagamento-monitor-status"
                                            class="block text-sm font-medium text-gray-700">Status do
                                            Pagamento</label><select id="pagamento-monitor-status" required
                                            class="form-input w-full mt-1">
                                            <option value="Executado" selected>Executado</option>
                                            <option value="Pendente">Pendente</option>
                                        </select></div>

                                    <div class="lg:col-span-2 flex items-center pt-4">
                                        <input type="checkbox" id="pagamento-monitor-motorista"
                                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <label for="pagamento-monitor-motorista"
                                            class="ml-2 block text-sm text-gray-900">Adicional de Motorista?</label>
                                    </div>
                                    <div id="motorista-adicional-fields"
                                        class="hidden lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                        <div><label for="pagamento-monitor-eventos"
                                                class="block text-sm font-medium text-gray-700">N¬∫ Eventos
                                                Entregues</label><input type="number" id="pagamento-monitor-eventos"
                                                min="0" step="0.1" class="form-input w-full mt-1" value="0"></div>
                                        <p class="text-sm text-gray-600 pt-5 font-medium">Adicional: <span
                                                id="valor-adicional-motorista">R$ 0,00</span></p>
                                    </div>
                                </div>

                                <div id="pagamento-avaliacao-container" class="hidden border-t pt-4 mt-4">
                                    <h4 class="font-semibold text-gray-800 mb-2">Avalia√ß√£o de Desempenho do Evento</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                                        <div><label for="pagamento-nota-descricao"
                                                class="text-xs">Evento/Descri√ß√£o</label><input type="text"
                                                id="pagamento-nota-descricao" class="form-input w-full text-sm p-1.5"
                                                placeholder="Ex: Festa da Maria"></div>
                                        <div id="pagamento-checklist-container"
                                            class="sm:col-span-2 border p-3 rounded-md bg-gray-50/50"></div>
                                        <div class="sm:col-span-2 text-right font-bold text-gray-700">Nota Calculada:
                                            <span id="pagamento-nota-calculada"
                                                class="text-indigo-600 text-lg">0.0</span> /
                                            10
                                        </div>
                                        <div class="sm:col-span-2"><label for="pagamento-nota-obs"
                                                class="text-xs">Observa√ß√µes</label><textarea id="pagamento-nota-obs"
                                                class="form-input w-full text-sm p-1.5" rows="2"></textarea></div>
                                    </div>
                                </div>

                                <button type="submit" class="shiny-btn py-2.5 rounded-md w-full mt-4"><i
                                        class="fa-solid fa-calculator mr-2"></i> Lan√ßar Pagamento e Salvar
                                    Avalia√ß√£o</button>
                            </form>
                            <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Hist√≥rico de Pagamentos (M√™s
                                Selecionado)</h3>
                            <div class="table-wrapper">
                                <table id="tabela-pagamentos-monitores">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Nome</th>
                                            <th>Valor Base</th>
                                            <th>Adicional Motorista</th>
                                            <th>Adicional HE</th>
                                            <th>Valor Total</th>
                                            <th>Status</th>
                                            <th>Nota Evento</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <button id="export-monitores-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md mr-2">
                                <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                            </button>

                        </section>
                    </main>
                </div>
            </div>
            <div id="page-salarios" class="page space-y-8">
                <section class="glassmorphism p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">C√°lculo de Sal√°rio</h2>
                        <button id="open-salarios-config-modal-btn" class="gemini-btn px-4 py-2 rounded-md">
                            <i class="fa-solid fa-gear mr-2"></i> Configura√ß√µes
                        </button>
                        <button id="export-salarios-pdf-btn" class="shiny-btn-red px-4 py-2 rounded-md">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                        </button>
                    </div>

                    <div class="mb-6">
                        <label for="salario-funcionario-select"
                            class="block text-sm font-medium text-gray-700 mb-1">Selecionar
                            Funcion√°rio</label>
                        <select id="salario-funcionario-select" class="form-input w-full max-w-md"></select>
                    </div>

                    <div id="salario-calculo-container" class="hidden">
                        <h3 id="salario-nome-funcionario" class="text-xl font-bold text-gray-800 mb-6"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i
                                        class="fa-solid fa-arrow-up mr-2 text-emerald-500"></i>Entradas Totais (M√™s)
                                </h3>
                                <p id="salario-total-entradas" class="text-3xl font-bold text-emerald-600">R$ 0,00</p>
                            </div>

                            <div class="glassmorphism p-5 rounded-lg border border-indigo-100">
                                <h3 class="font-semibold text-gray-600 mb-2"><i
                                        class="fa-solid fa-percentage mr-2 text-indigo-500"></i>Comiss√£o Calculada</h3>
                                <p id="salario-comissao" class="text-3xl font-bold text-indigo-600">R$ 0,00</p>
                                <p id="salario-comissao-percentual" class="text-sm text-gray-500 mt-1">Faixa de 0%</p>
                            </div>

                            <div class="glassmorphism p-5 rounded-lg border-2 border-green-300 bg-green-50/30">
                                <h3 class="font-semibold text-gray-700 mb-2"><i
                                        class="fa-solid fa-sack-dollar mr-2 text-green-600"></i>Sal√°rio Total a Pagar
                                </h3>
                                <p id="salario-total-pagar" class="text-3xl font-bold text-green-700">R$ 0,00</p>
                            </div>
                        </div>

                        <div class="bg-white/50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Detalhamento do Sal√°rio</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Sal√°rio Fixo</span>
                                    <span id="salario-fixo" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Alimenta√ß√£o (VA)</span>
                                    <span id="salario-va" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <span class="text-gray-700">Vale Transporte (VT)</span>
                                    <span id="salario-vt" class="font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div
                                    class="flex justify-between items-center p-3 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                                    <span class="text-blue-800">Comiss√£o (Baseada nas Entradas)</span>
                                    <span id="salario-comissao-detalhe" class="font-bold text-blue-800">R$ 0,00</span>
                                </div>
                                <div
                                    class="flex justify-between items-center p-4 bg-green-100 border-t-2 border-green-300 rounded-md mt-4">
                                    <span class="text-lg font-bold text-green-800">Total Bruto</span>
                                    <span id="salario-total-detalhe" class="text-xl font-extrabold text-green-800">R$
                                        0,00</span>
                                </div>
                            </div>

                            <div class="mt-8 text-center">
                                <button id="btn-lancar-salario"
                                    class="shiny-btn px-8 py-3 rounded-md text-lg font-semibold w-full md:w-auto">
                                    <i class="fa-solid fa-arrow-down-to-bracket mr-2"></i> Lan√ßar Sal√°rio como Despesa
                                </button>
                                <p id="salario-lancado-msg" class="text-green-600 font-semibold mt-4 hidden">
                                    <i class="fa-solid fa-check-circle mr-2"></i> Sal√°rio j√° lan√ßado como despesa para
                                    este m√™s.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="salario-selecione-msg" class="text-center p-10 bg-white/50 rounded-lg">
                        <i class="fa-solid fa-user-check text-4xl text-gray-400 mb-4"></i>
                        <p class="font-semibold text-gray-600">Selecione um funcion√°rio acima para calcular o sal√°rio.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">N√£o h√° funcion√°rios cadastrados? Use o bot√£o <i
                                class="fa-solid fa-gear"></i> Configura√ß√µes.</p>
                    </div>

                </section>
            </div>
        </main>
    </div>

    <div id="add-entrada-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Nova Entrada Manual</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-evento" class="space-y-4 pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label for="evento-data" class="block text-sm font-medium text-gray-700">Data</label><input
                            type="date" id="evento-data" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-empresa"
                            class="block text-sm font-medium text-gray-700">Empresa</label><select id="evento-empresa"
                            required class="form-input w-full mt-1">
                            <option>Aero Festas</option>
                            <option>ABC Festas</option>
                        </select></div>
                    <div><label for="evento-contratante"
                            class="block text-sm font-medium text-gray-700">Contratante</label><input type="text"
                            id="evento-contratante" required class="form-input w-full mt-1"></div>
                    <div><label for="evento-local" class="block text-sm font-medium text-gray-700">Local</label><input
                            type="text" id="evento-local" required class="form-input w-full mt-1"></div>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-semibold mb-2">Itens do Evento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-7"><label for="item-nome"
                                class="block text-sm font-medium text-gray-700">Nome do Item</label><input type="text"
                                id="item-nome" class="form-input w-full mt-1"></div>
                        <div class="md:col-span-3"><label for="item-valor"
                                class="block text-sm font-medium text-gray-700">Valor (R$)</label><input type="number"
                                id="item-valor" step="0.01" class="form-input w-full mt-1"></div>
                        <button type="button" id="btn-add-item" class="md:col-span-2 shiny-btn py-2 rounded-md"><i
                                class="fa-solid fa-plus mr-2"></i> Add</button>
                    </div>
                    <ul id="itens-temp-list" class="mt-4 space-y-2"></ul>
                </div>
                <button type="submit" class="w-full shiny-btn py-2.5 rounded-md font-bold"><i
                        class="fa-solid fa-save mr-2"></i> Salvar Evento Completo</button>
            </form>
        </div>
    </div>

    <div id="add-gasto-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Novo Gasto</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-gasto" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                <div><label for="gasto-data" class="block text-sm font-medium text-gray-700">Data</label><input
                        type="date" id="gasto-data" required class="form-input w-full mt-1"></div>
                <div><label for="gasto-descricao"
                        class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text"
                        id="gasto-descricao" required class="form-input w-full mt-1"></div>
                <div>
                    <label for="gasto-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="gasto-categoria" required class="form-input w-full mt-1">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>
                <div><label for="gasto-conta" class="block text-sm font-medium text-gray-700">Conta de
                        Sa√≠da</label><select id="gasto-conta" required class="form-input w-full mt-1"></select></div>
                <div><label for="gasto-pagamento" class="block text-sm font-medium text-gray-700">Forma de
                        Pagamento</label><select id="gasto-pagamento" required class="form-input w-full mt-1">
                        <option>PIX</option>
                        <option>Cart√£o de Cr√©dito</option>
                        <option>Dinheiro</option>
                        <option>Boleto</option>
                    </select></div>
                <div><label for="gasto-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label><input
                        type="number" id="gasto-valor" step="0.01" required class="form-input w-full mt-1"></div>
                <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-3"><i
                        class="fa-solid fa-plus mr-2"></i> Adicionar Gasto</button>
            </form>
        </div>
    </div>

    <div id="lancamento-conta-fixa-modal"
        class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Lan√ßar Pagamento de Conta Fixa</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-lancamento-conta-fixa">
                <p class="text-gray-700 mb-4">Confirme ou altere os dados para o lan√ßamento.</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <input type="text" id="lancamento-cf-descricao" class="form-input w-full mt-1 bg-gray-200"
                            readonly>
                    </div>
                    <div>
                        <label for="lancamento-cf-data" class="block text-sm font-medium text-gray-700">Data do
                            Pagamento</label>
                        <input type="date" id="lancamento-cf-data" required class="form-input w-full mt-1">
                    </div>
                    <div>
                        <label for="lancamento-cf-valor" class="block text-sm font-medium text-gray-700">Valor Pago
                            (R$)</label>
                        <input type="number" step="0.01" id="lancamento-cf-valor" required
                            class="form-input w-full mt-1">
                    </div>
                    <div>
                        <label for="lancamento-cf-conta" class="block text-sm font-medium text-gray-700">Conta de
                            Sa√≠da</label>
                        <select id="lancamento-cf-conta" required class="form-input w-full mt-1"></select>
                    </div>
                    <div>
                        <label for="lancamento-cf-comprovante" class="block text-sm font-medium text-gray-700">Anexar
                            Comprovantes (Opcional)</label>
                        <input type="file" id="lancamento-cf-comprovante" multiple
                            class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                </div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i
                        class="fa-solid fa-check mr-2"></i>Confirmar Lan√ßamento</button>
            </form>
        </div>
    </div>

    <div id="add-monitor-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Cadastrar Novo Monitor</h2>
                <button
                    class="add-monitor-close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="form-cadastro-monitor" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-start pt-4">
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label for="cadastro-monitor-nome" class="block text-sm font-medium text-gray-700">Nome
                            Completo</label><input type="text" id="cadastro-monitor-nome" required
                            class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-monitor-nascimento" class="block text-sm font-medium text-gray-700">Data
                            de Nascimento (Opcional)</label><input type="date" id="cadastro-monitor-nascimento"
                            class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-monitor-telefone" class="block text-sm font-medium text-gray-700">Telefone
                            (WhatsApp)</label><input type="tel" id="cadastro-monitor-telefone"
                            placeholder="(62) 99999-9999" class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-monitor-email"
                            class="block text-sm font-medium text-gray-700">Email</label><input type="email"
                            id="cadastro-monitor-email" placeholder="email@exemplo.com" class="form-input w-full mt-1">
                    </div>
                    <div class="md:col-span-2"><label for="cadastro-monitor-endereco"
                            class="block text-sm font-medium text-gray-700">Endere√ßo</label><input type="text"
                            id="cadastro-monitor-endereco" class="form-input w-full mt-1"></div>
                    <div>
                        <label for="cadastro-monitor-cnh" class="block text-sm font-medium text-gray-700">Possui
                            CNH?</label>
                        <select id="cadastro-monitor-cnh" class="form-input w-full mt-1">
                            <option value="nao" selected>N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                    <div id="cadastro-monitor-cnh-categoria-wrapper" class="hidden">
                        <label for="cadastro-monitor-cnh-categoria"
                            class="block text-sm font-medium text-gray-700">Categoria CNH</label>
                        <input type="text" id="cadastro-monitor-cnh-categoria" class="form-input w-full mt-1"
                            placeholder="Ex: AB">
                    </div>
                    <div class="md:col-span-2">
                        <label for="cadastro-monitor-observacoes"
                            class="block text-sm font-medium text-gray-700">Observa√ß√µes</label>
                        <textarea id="cadastro-monitor-observacoes" class="form-input w-full mt-1" rows="3"
                            placeholder="Anota√ß√µes sobre o monitor..."></textarea>
                    </div>
                </div>
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label for="cadastro-monitor-perfil-foto" class="block text-sm font-medium text-gray-700">Foto
                            de Perfil</label><input type="file" id="cadastro-monitor-perfil-foto" accept="image/*"
                            class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div><label for="cadastro-monitor-doc-foto" class="block text-sm font-medium text-gray-700">Foto do
                            Documento (CNH/RG)</label><input type="file" id="cadastro-monitor-doc-foto" accept="image/*"
                            class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div class="flex items-start space-x-4">
                        <div>
                            <p class="text-xs text-center text-gray-600 mb-1">Preview Perfil</p>
                            <img id="perfil-foto-preview" src="https://placehold.co/128x128/e0e0e0/757575?text=Perfil"
                                class="w-32 h-32 object-cover rounded-full border p-1 bg-gray-50"
                                alt="Pr√©-visualiza√ß√£o do perfil">
                        </div>
                        <div>
                            <p class="text-xs text-center text-gray-600 mb-1">Preview Doc</p>
                            <img id="doc-foto-preview" src="https://placehold.co/128x128/e0e0e0/757575?text=Doc"
                                class="w-32 h-32 object-cover rounded-md border p-1 bg-gray-50"
                                alt="Pr√©-visualiza√ß√£o do documento">
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <h4 class="font-semibold text-gray-800 mb-2">Habilidades Iniciais (0-10)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div><label for="habilidade-forca"
                                class="block text-sm font-medium text-gray-700">For√ßa</label><input type="number"
                                id="habilidade-forca" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-agilidade"
                                class="block text-sm font-medium text-gray-700">Agilidade</label><input type="number"
                                id="habilidade-agilidade" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-proatividade"
                                class="block text-sm font-medium text-gray-700">Proatividade</label><input type="number"
                                id="habilidade-proatividade" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-comunicacao"
                                class="block text-sm font-medium text-gray-700">Comunica√ß√£o</label><input type="number"
                                id="habilidade-comunicacao" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-disponibilidade"
                                class="block text-sm font-medium text-gray-700">Disponibilidade</label><input
                                type="number" id="habilidade-disponibilidade" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                        <div><label for="habilidade-respeito"
                                class="block text-sm font-medium text-gray-700">Respeito</label><input type="number"
                                id="habilidade-respeito" min="0" max="10" step="1" value="5"
                                class="form-input w-full mt-1"></div>
                    </div>
                </div>
                <button type="submit" class="md:col-span-2 shiny-btn py-2.5 rounded-md mt-2"><i
                        class="fa-solid fa-user-plus mr-2"></i> Salvar Monitor</button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Editar Item</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="modal-form">
                <div id="modal-form-content" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                <button type="submit" class="shiny-btn w-full px-6 py-2 rounded-md mt-8"><i
                        class="fa-solid fa-save mr-2"></i>Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div id="monitor-details-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div
            class="modal-box glassmorphism p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="monitor-details-title" class="text-2xl font-bold text-gray-900">Detalhes do Monitor</h2>
                <button
                    class="monitor-details-close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="monitor-details-body" class="bg-white/60 p-4 rounded-md flex-grow overflow-y-auto">
            </div>
        </div>
    </div>

    <div id="attachment-viewer-modal"
        class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-6 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="attachment-viewer-title" class="text-2xl font-bold text-gray-900">Visualizar Anexos</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="attachment-viewer-content"
                class="flex-grow overflow-y-auto bg-white/50 rounded p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>
    </div>

    <div id="salarios-config-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Configura√ß√µes de Sal√°rios</h2>
                <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <div class="mb-4 border-b border-gray-300/50 flex space-x-2">
                <button class="config-tab-btn active" data-target="config-tab-funcionarios">
                    <i class="fa-solid fa-user-tie mr-2"></i> Funcion√°rios
                </button>
                <button class="config-tab-btn" data-target="config-tab-comissao">
                    <i class="fa-solid fa-percentage mr-2"></i> Faixas de Comiss√£o
                </button>
            </div>

            <div id="config-tab-funcionarios" class="config-tab-content active space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Novo Funcion√°rio</h3>
                    <form id="form-add-funcionario"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div><label for="funcionario-nome"
                                class="block text-sm font-medium text-gray-700">Nome</label><input type="text"
                                id="funcionario-nome" required class="form-input w-full mt-1"
                                placeholder="Nome do Funcion√°rio"></div>
                        <div><label for="funcionario-salario" class="block text-sm font-medium text-gray-700">Sal√°rio
                                Fixo (R$)</label><input type="number" id="funcionario-salario" step="0.01" required
                                class="form-input w-full mt-1" placeholder="2200.00"></div>
                        <div><label for="funcionario-va" class="block text-sm font-medium text-gray-700">Vale
                                Alimenta√ß√£o (R$)</label><input type="number" id="funcionario-va" step="0.01" required
                                class="form-input w-full mt-1" placeholder="390.00"></div>
                        <div><label for="funcionario-vt" class="block text-sm font-medium text-gray-700">Vale Transporte
                                (R$)</label><input type="number" id="funcionario-vt" step="0.01" required
                                class="form-input w-full mt-1" placeholder="223.60"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md lg:col-span-4"><i
                                class="fa-solid fa-plus mr-2"></i> Adicionar Funcion√°rio</button>
                    </form>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Funcion√°rios Cadastrados</h3>
                    <div class="table-wrapper">
                        <table id="tabela-funcionarios-config">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Sal√°rio Fixo</th>
                                    <th>VA</th>
                                    <th>VT</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="config-tab-comissao" class="config-tab-content space-y-6">
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Adicionar Nova Faixa de Comiss√£o</h3>
                    <form id="form-add-comissao" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="comissao-atevalor" class="block text-sm font-medium text-gray-700">Faturamento
                                AT√â (R$)</label><input type="number" id="comissao-atevalor" step="0.01" required
                                class="form-input w-full mt-1" placeholder="45000"></div>
                        <div><label for="comissao-percentual" class="block text-sm font-medium text-gray-700">Percentual
                                (%)</label><input type="number" id="comissao-percentual" step="0.1" required
                                class="form-input w-full mt-1" placeholder="2.5"></div>
                        <button type="submit" class="shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i>
                            Adicionar Faixa</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Dica: Para "acima de R$ 95.000", cadastre uma faixa com valor
                        "At√©" muito alto (ex: 9999999).</p>
                </section>
                <section>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Faixas de Comiss√£o Atuais</h3>
                    <div class="table-wrapper">
                        <table id="tabela-comissao-config">
                            <thead>
                                <tr>
                                    <th>Faturamento At√© (R$)</th>
                                    <th>Percentual</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

        </div>
    </div>
    <div id="chat-fab"
        class="fixed bottom-6 right-6 shiny-btn rounded-full w-16 h-16 flex items-center justify-center cursor-pointer shadow-2xl transition-transform duration-300 hover:scale-110 z-40"
        title="Assistente IA">
        <i id="chat-fab-icon" class="fa-solid fa-chart-pie text-2xl"></i>
    </div>
    <div id="chat-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-box glassmorphism w-full max-w-lg h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200/50 pb-2">
                <h2 id="chat-title" class="text-xl font-bold text-gray-900">Assistente IA</h2>
                <button id="chat-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto p-2 space-y-4">
            </div>
            <div class="mt-4 flex space-x-2">
                <input type="text" id="chat-input" class="form-input w-full" placeholder="Fa√ßa uma pergunta...">
                <button id="send-chat-btn" class="shiny-btn px-4 rounded-md"><i
                        class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-900">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-6">Para usar os recursos de IA, voc√™ precisa de uma chave de API do
                Google AI Studio. A chave ser√° salva apenas no seu navegador.</p>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave da
                        API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui"
                        class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-50">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="ml-3"></p>
    </div>


    <!-- Event Listeners de Navega√ß√£o e Modais -->
    <script>
        // Este script agora √© vazio pois foi consolidado no script ao final do arquivo
    </script>

    <!-- Modal de Entrada Manual de Receita -->
    <div id="modal-entrada-manual"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50"
        style="display: none;">
        <div class="glassmorphism p-8 rounded-lg max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">üí∞ Nova Entrada de Receita</h3>
                <button onclick="document.getElementById('modal-entrada-manual').style.display='none'"
                    class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>

            <form id="form-entrada-manual" class="space-y-4">
                <div>
                    <label for="entrada-data" class="block text-sm font-medium text-gray-700 mb-1">
                        Data da Entrada
                    </label>
                    <input type="date" id="entrada-data" required
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="entrada-descricao" class="block text-sm font-medium text-gray-700 mb-1">
                        Descri√ß√£o
                    </label>
                    <input type="text" id="entrada-descricao" required
                        placeholder="Ex: Venda de Material, Servi√ßo Extra..."
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="entrada-valor" class="block text-sm font-medium text-gray-700 mb-1">
                        Valor (R$)
                    </label>
                    <input type="number" id="entrada-valor" step="0.01" min="0.01" required placeholder="0,00"
                        class="form-input w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="bg-indigo-50 p-3 rounded-md text-sm text-gray-600">
                    <i class="fa-solid fa-info-circle mr-2 text-indigo-600"></i>
                    Esta entrada ser√° registrada como receita avulsa, independente de eventos.
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="document.getElementById('modal-entrada-manual').style.display='none'"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn px-4 py-2 rounded-md">
                        <i class="fa-solid fa-check mr-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cadastrar Conta Fixa -->
    <div id="modal-conta-fixa"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Cadastrar Conta Fixa</h2>
                <button id="close-conta-fixa-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-conta-fixa" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div><label for="conta-fixa-descricao"
                        class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text"
                        id="conta-fixa-descricao" required class="form-input w-full mt-1"
                        placeholder="Ex: Aluguel do galp√£o"></div>
                <div><label for="conta-fixa-valor" class="block text-sm font-medium text-gray-700">Valor
                        (R$)</label><input type="number" id="conta-fixa-valor" step="0.01" required
                        class="form-input w-full mt-1" placeholder="750.00"></div>
                <div><label for="conta-fixa-dia-vencimento" class="block text-sm font-medium text-gray-700">Dia do
                        Vencimento</label><input type="number" id="conta-fixa-dia-vencimento" min="1" max="31" required
                        class="form-input w-full mt-1" placeholder="10"></div>
                <div>
                    <label for="conta-fixa-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="conta-fixa-categoria" required class="form-input w-full mt-1">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>

                <div>
                    <label for="conta-fixa-tipo-recorrencia" class="block text-sm font-medium text-gray-700">Tipo de
                        Recorr√™ncia</label>
                    <select id="conta-fixa-tipo-recorrencia" required class="form-input w-full mt-1">
                        <option value="permanente" selected>Permanente (Cont√≠nua)</option>
                        <option value="parcelada">Parcelada (Com Fim)</option>
                    </select>
                </div>

                <div id="conta-fixa-parcelamento-container"
                    class="hidden md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label for="conta-fixa-data-inicio" class="block text-sm font-medium text-gray-700">M√™s de
                            In√≠cio (YYYY-MM)</label><input type="month" id="conta-fixa-data-inicio"
                            class="form-input w-full mt-1"></div>
                    <div><label for="conta-fixa-num-parcelas" class="block text-sm font-medium text-gray-700">N¬∫ de
                            Parcelas</label><input type="number" id="conta-fixa-num-parcelas" min="1" step="1"
                            class="form-input w-full mt-1" placeholder="12"></div>
                    <div>
                        <label for="conta-fixa-periodicidade-parcelada"
                            class="block text-sm font-medium text-gray-700">Periodicidade</label>
                        <select id="conta-fixa-periodicidade-parcelada" class="form-input w-full mt-1">
                            <option value="mensal">Mensal</option>
                            <option value="quinzenal">Quinzenal</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>

                <div id="conta-fixa-permanente-container"
                    class="md:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="conta-fixa-periodicidade-permanente"
                            class="block text-sm font-medium text-gray-700">Periodicidade</label>
                        <select id="conta-fixa-periodicidade-permanente" class="form-input w-full mt-1">
                            <option value="mensal">Mensal</option>
                            <option value="quinzenal">Quinzenal</option>
                            <option value="bimestral">Bimestral</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>

                <div class="lg:col-span-4">
                    <label for="conta-fixa-anexo" class="block text-sm font-medium text-gray-700">Anexar Boletos/Faturas
                        (Opcional)</label>
                    <input type="file" id="conta-fixa-anexo" multiple
                        class="form-input w-full mt-1 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div class="lg:col-span-4 flex gap-3 pt-4">
                    <button type="button" id="limpar-conta-fixa-btn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-md transition-colors">
                        <i class="fa-solid fa-eraser mr-2"></i> Limpar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn py-2 rounded-md"><i class="fa-solid fa-plus mr-2"></i>
                        Adicionar Conta Fixa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Gerenciar Categorias -->
    <div id="modal-categorias-cf"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-gear mr-2"></i> Categorias de Contas
                    Fixas</h2>
                <button id="close-categorias-cf-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-conta-fixa-categoria" class="space-y-4 mb-6">
                <div>
                    <label for="cf-categoria-nome" class="block text-sm font-medium text-gray-700 mb-2">Nome da Nova
                        Categoria</label>
                    <div class="flex gap-2">
                        <input type="text" id="cf-categoria-nome" placeholder="Ex: Impostos MEI" required
                            class="form-input flex-1">
                        <button type="submit" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-save mr-2"></i> Salvar</button>
                    </div>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Categorias Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-cf-categorias-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Contas Banc√°rias -->
    <div id="modal-contas-bancarias"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-building-columns mr-2"></i> Contas
                    Banc√°rias</h2>
                <button id="close-contas-bancarias-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-cadastro-conta" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="cadastro-conta-nome" class="block text-sm font-medium text-gray-700">Nome da
                            Conta</label><input type="text" id="cadastro-conta-nome" placeholder="Ex: Conta Principal"
                            required class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-conta-banco"
                            class="block text-sm font-medium text-gray-700">Institui√ß√£o/Banco</label><input type="text"
                            id="cadastro-conta-banco" placeholder="Ex: Banco Inter" required
                            class="form-input w-full mt-1"></div>
                    <div><label for="cadastro-conta-tipo"
                            class="block text-sm font-medium text-gray-700">Tipo</label><select id="cadastro-conta-tipo"
                            required class="form-input w-full mt-1">
                            <option>Conta Corrente</option>
                            <option>Conta Poupan√ßa</option>
                            <option>Conta de Pagamentos</option>
                            <option>Outros</option>
                        </select></div>
                    <div><label for="cadastro-conta-agencia" class="block text-sm font-medium text-gray-700">Ag√™ncia
                            (Opcional)</label><input type="text" id="cadastro-conta-agencia" placeholder="0001"
                            class="form-input w-full mt-1"></div>
                    <div class="md:col-span-2"><label for="cadastro-conta-numero"
                            class="block text-sm font-medium text-gray-700">N¬∫ da Conta (Opcional)</label><input
                            type="text" id="cadastro-conta-numero" placeholder="12345-6" class="form-input w-full mt-1">
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="limpar-conta-bancaria-btn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-md transition-colors">
                        <i class="fa-solid fa-eraser mr-2"></i> Limpar
                    </button>
                    <button type="submit" class="flex-1 shiny-btn py-2 rounded-md"><i class="fa-solid fa-save mr-2"></i>
                        Salvar Conta</button>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Contas Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-contas-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Institui√ß√£o</th>
                            <th>Tipo</th>
                            <th>Ag√™ncia/Conta</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Categorias de Gastos -->
    <div id="modal-categorias-gastos"
        class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div
            class="modal-content modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-tags mr-2"></i> Categorias de Gastos
                </h2>
                <button id="close-categorias-gastos-modal"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <form id="form-gasto-categoria" class="space-y-4 mb-6">
                <div>
                    <label for="gasto-categoria-nome" class="block text-sm font-medium text-gray-700 mb-2">Nome da Nova
                        Categoria</label>
                    <div class="flex gap-2">
                        <input type="text" id="gasto-categoria-nome" placeholder="Ex: Limpeza" required
                            class="form-input flex-1">
                        <button type="submit" class="shiny-btn px-4 py-2 rounded-md"><i
                                class="fa-solid fa-save mr-2"></i> Salvar</button>
                    </div>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Categorias Cadastradas</h3>
            <div class="table-wrapper">
                <table id="tabela-gasto-categorias-db">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal API Key -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-[100]">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-4">Para usar os recursos de IA, voc√™ precisa de uma chave de API.</p>

            <div class="bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-100">
                <h3 class="text-indigo-800 font-bold text-sm mb-2 flex items-center">
                    <i class="fa-solid fa-circle-info mr-2"></i> Como conseguir a chave?
                </h3>
                <ol class="text-xs text-indigo-700 space-y-2 list-decimal ml-4">
                    <li>Clique no link azul abaixo (Google AI Studio).</li>
                    <li>Fa√ßa login com sua conta Google.</li>
                    <li>Clique no bot√£o azul <strong>"Create API key"</strong>.</li>
                    <li>Copie o c√≥digo gerado e cole no campo abaixo.</li>
                </ol>
                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                    class="block mt-3 text-center bg-white text-indigo-600 border border-indigo-200 py-1.5 rounded-md font-bold text-xs hover:bg-indigo-50 transition-colors">
                    <i class="fa-solid fa-external-link mr-1"></i> Ir para Google AI Studio
                </a>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium mb-1">Sua Chave da API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui"
                        class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gemini Principal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-[110]">
        <div id="gemini-modal-box"
            class="modal-box glassmorphism w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-modal-title" class="text-2xl font-semibold text-gray-800">‚ú® Assistente IA</h2>
                <button id="gemini-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto text-gray-700">
                <!-- Conte√∫do -->
            </div>
            <div id="gemini-modal-footer"
                class="p-4 bg-gray-50/50 border-t border-gray-200/50 flex justify-end space-x-4">
                <button id="gemini-copy-btn" class="shiny-btn py-2 px-4 rounded-lg">Copiar Texto</button>
            </div>
        </div>
    </div>

    <!-- Modal de Chat da IA -->
    <div id="gemini-chat-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-[120]">
        <div class="modal-box glassmorphism w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-chat-title" class="text-xl font-semibold text-gray-800"></h2>
                <button id="gemini-chat-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-chat-messages" class="p-6 flex-grow overflow-y-auto space-y-4 flex flex-col">
                <!-- Mensagens -->
            </div>
            <div class="p-4 bg-gray-50/50 border-t border-gray-200/50">
                <form id="gemini-chat-form" class="flex gap-2 items-center">
                    <input type="text" id="gemini-chat-input" placeholder="Digite sua pergunta..."
                        class="form-input w-full" required>
                    <button type="submit" id="gemini-chat-send-btn"
                        class="bg-indigo-500 text-white w-10 h-10 rounded-md hover:bg-indigo-600 transition-colors flex-shrink-0">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-[200]">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="ml-3 font-medium"></p>
    </div>

    <!-- Sistema de Autentica√ß√£o -->

    <script src="js/protect.js"></script>


    <!-- M√≥dulo de Gr√°ficos Financeiros (Estilo Bolsa de Valores) -->
    <script src="js/charts-financeiro.js"></script>

    <script>
        // --- GEMINI IA LOGIC ---
        const apiKeyModal = document.getElementById('api-key-modal');
        const geminiModal = document.getElementById('gemini-modal');
        const geminiChatModal = document.getElementById('gemini-chat-modal');
        const chatMessagesEl = document.getElementById('gemini-chat-messages');
        const chatForm = document.getElementById('gemini-chat-form');
        const chatInput = document.getElementById('gemini-chat-input');
        const chatSendBtn = document.getElementById('gemini-chat-send-btn');
        const chatModalTitle = document.getElementById('gemini-chat-title');

        let chatHistory = [];

        const openIAModal = (modalEl) => modalEl.classList.remove('hidden');
        const hideIAModal = (modalEl) => modalEl.classList.add('hidden');

        const showIAToast = (message, isError = true) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            if (!toast || !toastMessage) return;
            toastMessage.textContent = message;
            toast.classList.toggle('bg-red-600', isError);
            toast.classList.toggle('bg-green-600', !isError);
            if (toastIcon) toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        };

        const getApiKey = () => localStorage.getItem('gemini_api_key_v1');
        const saveApiKey = (key) => localStorage.setItem('gemini_api_key_v1', key);

        // API Key Modal Events
        if (document.getElementById('settings-btn')) {
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('api-key-input').value = getApiKey() || '';
                openIAModal(apiKeyModal);
            });
        }

        document.getElementById('cancel-api-key-btn').addEventListener('click', () => hideIAModal(apiKeyModal));
        document.getElementById('save-api-key-btn').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                saveApiKey(key);
                hideIAModal(apiKeyModal);
                showIAToast("Chave API salva com sucesso!", false);
            }
        });

        // Close Gemini Modals
        document.getElementById('gemini-close-btn').addEventListener('click', () => hideIAModal(geminiModal));
        document.getElementById('gemini-chat-close-btn').addEventListener('click', () => hideIAModal(geminiChatModal));

        async function callGeminiAPI(input, generationConfig = null) {
            const apiKey = getApiKey();
            if (!apiKey) {
                showIAToast("Por favor, configure sua chave de API do Gemini.");
                document.getElementById('api-key-input').value = '';
                openIAModal(apiKeyModal);
                return null;
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let payload = {
                contents: typeof input === 'string' ? [{ parts: [{ text: input }] }] : input
            };

            if (generationConfig) payload.generationConfig = generationConfig;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "Erro na chamada da API");
                }

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Error:", error);
                showIAToast("Erro ao falar com a IA: " + error.message);
                return null;
            }
        }

        function addChatMessage(message, sender = 'ia') {
            const messageEl = document.createElement('div');
            messageEl.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'break-words');

            // Simple markdown Bold
            let htmlMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Simple lists
            htmlMessage = htmlMessage.replace(/^\s*-\s(.*?)$/gm, '<li class="ml-4">$1</li>');

            if (sender === 'user') {
                messageEl.classList.add('bg-indigo-500', 'text-white', 'self-end', 'ml-auto');
                messageEl.innerHTML = htmlMessage;
            } else {
                messageEl.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto');
                if (message === '...') {
                    messageEl.innerHTML = '<div class="loader w-5 h-5 border-2 border-indigo-500 border-t-transparent"></div>';
                } else {
                    messageEl.innerHTML = htmlMessage;
                }
            }
            chatMessagesEl.appendChild(messageEl);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            return messageEl;
        }

        async function openChat(contextType) {
            // First, check for API key to avoid modal overlap
            const apiKey = getApiKey();
            if (!apiKey) {
                showIAToast("Por favor, configure sua chave de API do Gemini.");
                document.getElementById('api-key-input').value = '';
                openIAModal(apiKeyModal);
                return; // Stop here
            }

            let titleText = '‚ú® Intelig√™ncia Aero';
            let initialPrompt = '';

            // Get current financial data for context
            const totalReceitas = document.getElementById('total-receitas')?.textContent || 'R$ 0,00';
            const totalDespesas = document.getElementById('total-despesas')?.textContent || 'R$ 0,00';
            const saldoFinal = document.getElementById('saldo-final')?.textContent || 'R$ 0,00';

            if (contextType === 'dashboard') {
                titleText = '<i class="fa-solid fa-chart-line mr-2 text-indigo-500"></i> Insights do Dashboard';
                initialPrompt = `Analise meu resumo financeiro atual: Receitas: ${totalReceitas}, Despesas: ${totalDespesas}, Saldo: ${saldoFinal}. Me d√™ 3 insights r√°pidos ou avisos sobre esses n√∫meros.`;
            } else if (contextType === 'gastos') {
                titleText = '<i class="fa-solid fa-receipt mr-2 text-red-500"></i> An√°lise de Gastos';
                initialPrompt = "Gostaria de uma an√°lise sobre meus gastos deste m√™s. Quais as categorias mais pesadas e onde posso reduzir custos?";
            }

            chatModalTitle.innerHTML = titleText;
            chatMessagesEl.innerHTML = '';
            openIAModal(geminiChatModal);

            if (initialPrompt) {
                const loadingEl = addChatMessage('...');
                chatHistory = [{ role: 'user', parts: [{ text: initialPrompt }] }];
                const response = await callGeminiAPI(chatHistory);
                loadingEl.remove();
                if (response) {
                    addChatMessage(response, 'ia');
                    chatHistory.push({ role: 'model', parts: [{ text: response }] });
                }
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: userInput }] });
            chatInput.value = '';
            chatSendBtn.disabled = true;

            const loadingEl = addChatMessage('...');
            const response = await callGeminiAPI(chatHistory);
            loadingEl.remove();

            if (response) {
                addChatMessage(response, 'ia');
                chatHistory.push({ role: 'model', parts: [{ text: response }] });
            }
            chatSendBtn.disabled = false;
        });

        // Expose openChat to global scope for onclick events
        window.openChat = openChat;
    </script>

    <!-- Script de inicializa√ß√£o dos gr√°ficos (previne loop infinito) -->

    <script src="js/charts-init.js"></script>

</body>

</html>