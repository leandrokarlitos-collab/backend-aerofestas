<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Integrado</title>

    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="js/pwa-init.js"></script>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='20' cy='20' r='10' fill='%234f46e5'/><circle cx='80' cy='30' r='8' fill='%234f46e5'/><circle cx='50' cy='70' r='12' fill='%234f46e5'/><line x1='20' y1='20' x2='80' y2='30' stroke='%234f46e5' stroke-width='5'/><line x1='80' y1='30' x2='50' y2='70' stroke='%234f46e5' stroke-width='5'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: 'rgba(30, 41, 59, 0.7)',
                            border: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- [MODIFICADO] Adicionado Chart.js para os novos gráficos financeiros -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #a855f7;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;

            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-muted: #6b7280;

            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);

            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
            --particle-color-rgb: 100, 116, 139;

            /* [NOVO] Variáveis para Inputs e Formulários */
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --input-focus: #4f46e5;
            --input-text: #1e293b;
            --input-placeholder: #94a3b8;
        }

        .dark {
            --bg-color: #020617;
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --input-bg: #1e293b;
            --input-border: rgba(255, 255, 255, 0.1);
            --input-text: #f1f5f9;
            --input-placeholder: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        body.dark {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* Ajustes Glassmorphism para Dark Mode */
        .dark .glassmorphism {
            background: var(--glass-bg);
            border-color: var(--glass-border);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.02);
        }

        .dark .dashboard-card h2, .dark .dashboard-card h3, .dark .dashboard-card h4 {
            color: #f1f5f9;
        }

        .dark .text-slate-500, .dark .text-slate-600, .dark .text-slate-700 {
            color: #94a3b8;
        }

        .dark .bg-white\/50, .dark .bg-white\/60 {
            background-color: rgba(30, 41, 59, 0.5);
        }

        .dark .border-gray-200\/50, .dark .border-slate-100, .dark .border-slate-200 {
            border-color: rgba(255, 255, 255, 0.05);
        }

        .dark .sidebar-title {
            color: #f1f5f9;
        }

        .dark #task-sidebar {
            background: rgba(15, 23, 42, 0.8);
            border-left-color: rgba(255, 255, 255, 0.05);
        }

        .dark .bg-slate-50, .dark .bg-slate-100\/80 {
            background-color: rgba(30, 41, 59, 0.8);
        }

        .dark .tab-btn.bg-white {
            background-color: #334155;
            color: #818cf8;
        }

        .dark .sidebar-icon {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #818cf8;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .header-title {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.1);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.07),
                inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dark .glassmorphism {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            inset: 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .glassmorphism:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }

        .form-input {
            background-color: var(--input-bg);
            border: 1.5px solid var(--input-border);
            color: var(--input-text);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            font-size: 0.875rem;
        }

        .form-input::placeholder {
            color: var(--input-placeholder);
            opacity: 1;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            border-color: var(--input-focus);
            background-color: #ffffff;
        }

        .task-item label:has(input:checked) {
            text-decoration: line-through;
            color: var(--text-muted-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .verse-container {
            font-style: italic;
            border-left: 3px solid var(--header-grad-from);
            transition: border-color 0.5s ease;
        }

        .scrollable-widget {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            scrollbar-width: thin;
            scrollbar-color: #6366f1 transparent;
        }

        .scrollable-widget::-webkit-scrollbar {
            width: 5px;
        }

        .scrollable-widget::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 20px;
        }

        .gemini-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .gemini-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
            filter: brightness(1.1);
        }

        .modal-box.glassmorphism {
            background: var(--glass-bg);
        }

        .shiny-btn {
            position: relative;
            border: 2px solid transparent;
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 51%, #4f46e5 100%);
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(60, 78, 224, 0.4);
            transition: all 0.4s ease;
        }

        .shiny-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(60, 78, 224, 0.6);
        }

        .form-input::placeholder {
            color: #d1d5db !important;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .form-input:focus::placeholder {
            opacity: 0;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-enter {
            animation: toast-in 0.5s ease-out forwards;
        }

        /* Dashboard Stat Cards Improvements */
        .dashboard-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            pointer-events: none;
            transition: all 0.6s ease;
        }

        .dashboard-card:hover::before {
            left: -30%;
            top: -30%;
        }

        .dashboard-card.receita { border-bottom: 4px solid #10b981; }
        .dashboard-card.despesa { border-bottom: 4px solid #ef4444; }
        .dashboard-card.saldo { border-bottom: 4px solid #3b82f6; }
        .dashboard-card.ia { border-bottom: 4px solid #8b5cf6; }

        .stat-icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            transition: all 0.4s ease;
            pointer-events: none;
        }

        .dashboard-card:hover .stat-icon-bg {
            opacity: 0.1;
            transform: scale(1.1) rotate(0deg);
        }

        /* [AAA] Super-Premium Futuristic Loader */
        #page-loader {
            position: fixed;
            inset: 0;
            background: #f8fafc;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.8s, backdrop-filter 0.8s;
        }

        .dark #page-loader { background: #020617; }

        /* Mesh Gradient Background para o Loader */
        #page-loader::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
            filter: blur(100px);
            animation: mesh-move 15s ease infinite alternate;
            z-index: -1;
        }

        @keyframes mesh-move {
            0% { transform: scale(1) translate(0, 0); }
            100% { transform: scale(1.2) translate(5%, 5%); }
        }

        .loader-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .loader-logo-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader-logo-glow {
            position: absolute;
            inset: -10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            filter: blur(20px);
            opacity: 0.3;
            animation: morph 8s ease-in-out infinite alternate;
        }

        .loader-ring {
            position: absolute;
            inset: 0;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-bottom-color: var(--secondary);
            border-radius: 50%;
            animation: loader-spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            z-index: 2;
        }

        .loader-ring::after {
            content: '';
            position: absolute;
            inset: 8px;
            border: 3px solid transparent;
            border-left-color: #f093fb;
            border-right-color: #4f46e5;
            border-radius: 50%;
            animation: loader-spin 2s linear infinite reverse;
        }

        @keyframes loader-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes morph {
            0% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; transform: rotate(0deg); }
            100% { border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%; transform: rotate(180deg); }
        }

        .loader-logo-main {
            position: relative;
            width: 60px;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            z-index: 3;
            animation: loader-pulse 2s ease-in-out infinite;
        }

        @keyframes loader-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.1); }
        }

        .loader-text-aaa {
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            text-align: center;
            min-height: 1.5em;
            transition: opacity 0.5s ease;
        }

        .loader-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            transform: scale(1.1);
        }

        #main-container {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #main-container.content-ready {
            opacity: 1;
            transform: translateY(0);
        }

        .ai-badge {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .stat-icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(-15deg);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .glassmorphism:hover .stat-icon-bg {
            opacity: 0.1;
            transform: scale(1.1) rotate(0deg);
        }

        /* ESTILOS PARA RECOLHÍVEIS E DESCANSO DE TELA */
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            max-height: 1000px;
            /* Altura máxima grande o suficiente */
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: -1px;
            /* Evita borda dupla */
        }

        .collapsible-header i.fa-chevron-down {
            transition: transform 0.3s ease;
        }

        .collapsible-header i.fa-chevron-down.rotated {
            transform: rotate(180deg);
        }

        #screensaver {
            transition: opacity 0.5s ease-in-out;
        }

        /* [NOVO] ESTILOS PARA ABAS DO MODAL FINANCEIRO */
        .finance-modal-content {
            display: none;
        }

        .finance-modal-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .finance-tab-btn {
            background-color: #e5e7eb;
            /* bg-gray-200 */
            color: #4b5563;
            /* text-gray-600 */
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }

        .finance-tab-btn:hover {
            background-color: #f3f4f6;
            /* bg-gray-100 */
        }

        .finance-tab-btn.active {
            background-color: transparent;
            color: var(--primary);
            font-weight: 600;
            border-bottom-color: var(--primary);
        }

        /* [SUPER-PREMIUM] Unified Fluid Capsule Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 420px;
            height: 75px;
            background: rgba(255, 255, 255, 0.6);
            /* Translucidez premium */
            backdrop-filter: blur(30px) saturate(210%);
            -webkit-backdrop-filter: blur(30px) saturate(210%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 15px 0 15px;
            z-index: 10000;
            border-radius: 40px;
            box-shadow:
                0 20px 40px -10px rgba(0, 0, 0, 0.12),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
            transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            user-select: none;
            overflow: hidden;
        }

        /* O Handle Tátil Integrado */
        .bottom-nav-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .bottom-nav-handle::after {
            content: '';
            width: 40px;
            height: 4px;
            background: rgba(79, 70, 229, 0.2);
            border-radius: 10px;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* Ícone interno (escondido por padrão) */
        .bottom-nav-handle i {
            position: absolute;
            font-size: 1.2rem;
            color: #4f46e5;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* Morphing: Barra Inteira -> Pílula Compacta */
        .bottom-nav.collapsed {
            transform: translateX(-50%) translateY(15px);
            width: 80px;
            height: 48px;
            padding: 0;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .bottom-nav.collapsed .nav-item {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .bottom-nav.collapsed .bottom-nav-handle::after {
            opacity: 0;
            transform: scaleX(0);
        }

        .bottom-nav.collapsed .bottom-nav-handle i {
            opacity: 1;
            transform: translateY(0);
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
        }

        .nav-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #64748b;
            width: 65px;
            height: 100%;
            text-decoration: none;
            z-index: 1;
            transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* The Pill - Fundo do Item Ativo */
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: -1;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 16px rgba(79, 70, 229, 0.3);
        }

        .nav-item.active {
            color: white;
            transform: translateY(-8px);
        }

        .nav-item.active::before {
            transform: translate(-50%, -60%) scale(1);
            opacity: 1;
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 2px;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-item span {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .nav-item.active span {
            opacity: 1;
            transform: translateY(2px);
            color: #4f46e5;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.55rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .nav-item:active {
            transform: scale(0.9) translateY(0);
        }

        /* [SUPER-PREMIUM] Right Task Sidebar */
        #task-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #task-sidebar.open {
            transform: translateX(0);
        }

        @media (max-width: 640px) {
            #task-sidebar {
                width: 100%;
                z-index: 11000;
            }
        }

        /* Sidebar Toggle Button (Floating) */
        #sidebar-toggle {
            position: fixed;
            right: 20px;
            bottom: 115px;
            width: 64px;
            height: 64px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.45);
            cursor: pointer;
            z-index: 900;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #sidebar-toggle:hover {
            transform: translateY(-5px) scale(1.08);
            box-shadow: 0 18px 45px rgba(79, 70, 229, 0.6);
        }

        #sidebar-toggle i {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        #sidebar-toggle span {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        #sidebar-toggle.active {
            transform: rotate(180deg) scale(0.9);
            background: white;
            color: var(--primary);
            border: 1px solid rgba(79, 70, 229, 0.2);
        }

        /* Sidebar Header */
        .sidebar-header {
            padding: 45px 35px 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title-group {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .sidebar-icon {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.12);
        }

        .sidebar-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.03em;
        }

        /* Overlay */
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(10px);
            z-index: 950;
            opacity: 0;
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #sidebar-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.3);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- [AAA] Super-Premium Page Loader -->
    <div id="page-loader">
        <div class="loader-content">
            <div class="loader-logo-wrapper">
                <div class="loader-logo-glow"></div>
                <div class="loader-ring"></div>
                <div class="loader-logo-main">
                    <i class="fa-solid fa-rocket"></i>
                </div>
            </div>
            <div class="flex flex-col items-center gap-3">
                <div id="loader-message" class="loader-text-aaa">Sincronizando Aero Festas</div>
            </div>
        </div>
    </div>

    <script>
        // Lógica do micro-copy dinâmico do loader
        const loaderMessages = [
            "Sincronizando com a nuvem...",
            "Preparando seu dashboard...",
            "Otimizando fluxo de caixa...",
            "Calculando insights estratégicos...",
            "Organizando agenda de eventos...",
            "Carregando experiência premium..."
        ];
        let loaderMsgIndex = 0;
        const loaderMsgElement = document.getElementById('loader-message');
        if (loaderMsgElement) {
            setInterval(() => {
                loaderMsgElement.style.opacity = '0';
                setTimeout(() => {
                    loaderMsgIndex = (loaderMsgIndex + 1) % loaderMessages.length;
                    loaderMsgElement.textContent = loaderMessages[loaderMsgIndex];
                    loaderMsgElement.style.opacity = '1';
                }, 500);
            }, 2500);
        }
    </script>

    <canvas id="particles-js"></canvas>

    <div id="screensaver"
        class="fixed inset-0 z-20 flex items-center justify-center text-white bg-black/30 hidden opacity-0">
        <div id="screensaver-clock" class="text-8xl font-bold text-center"
            style="text-shadow: 0 0 20px rgba(0,0,0,0.5);">
        </div>
    </div>

    <div id="main-container" class="container mx-auto p-4 md:p-8 relative z-10 transition-opacity duration-500">
        <header class="flex flex-col items-center gap-6 mb-10">
            <div class="w-full flex justify-between items-center">
                <div>
                    <h1 id="greeting" class="text-3xl md:text-5xl header-title"></h1>
                    <p class="text-slate-500 text-sm font-medium mt-1">Resumo do dia • <span
                            id="current-date-header"></span></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="theme-toggle"
                        class="bg-white/60 dark:bg-slate-800/60 text-slate-400 dark:text-slate-300 w-12 h-12 rounded-2xl hover:bg-white/80 dark:hover:bg-slate-700/80 transition-all flex items-center justify-center border border-white/40 dark:border-white/10 shadow-sm"
                        title="Alternar Tema">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    <button id="backup-btn"
                        class="bg-white/60 dark:bg-slate-800/60 text-slate-400 dark:text-slate-300 w-12 h-12 rounded-2xl hover:bg-white/80 dark:hover:bg-slate-700/80 transition-all flex items-center justify-center border border-white/40 dark:border-white/10 shadow-sm"
                        title="Baixar Backup">
                        <i class="fas fa-download text-xl" id="backup-icon"></i>
                    </button>
                    <button id="settings-btn"
                        class="bg-white/60 dark:bg-slate-800/60 text-slate-400 dark:text-slate-300 w-12 h-12 rounded-2xl hover:bg-white/80 dark:hover:bg-slate-700/80 transition-all flex items-center justify-center border border-white/40 dark:border-white/10 shadow-sm"
                        title="Configurações">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>

            <div id="daily-verse"
                class="w-full max-w-3xl p-6 glassmorphism rounded-2xl border-l-4 border-indigo-500 self-start transition-all">
                <p id="verse-text" class="text-sm md:text-base text-slate-700 italic leading-relaxed"></p>
                <p id="verse-ref"
                    class="font-bold text-[10px] text-slate-400 mt-3 uppercase tracking-widest text-right"></p>
            </div>

            <!-- Navegação Desktop -->
            <div class="hidden lg:flex absolute top-0 right-16 space-x-3">
                <button onclick="window.location.href='./Agenda de eventos.html'"
                    class="bg-white/60 text-slate-600 px-5 py-2.5 rounded-xl hover:bg-white/80 transition-all border border-white/40 shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-calendar-days text-indigo-500"></i> <span
                        class="text-sm font-bold">Agenda</span>
                </button>
                <button onclick="window.location.href='./Sistema Gestão Financeira.html'"
                    class="bg-white/60 text-slate-600 px-5 py-2.5 rounded-xl hover:bg-white/80 transition-all border border-white/40 shadow-sm flex items-center gap-2">
                    <i class="fas fa-chart-line text-emerald-500"></i> <span class="text-sm font-bold">Financeiro</span>
                </button>
                <button onclick="window.location.href='./Sistema de CRM.html'"
                    class="bg-white/60 text-slate-600 px-5 py-2.5 rounded-xl hover:bg-white/80 transition-all border border-white/40 shadow-sm flex items-center gap-2">
                    <i class="fas fa-users text-blue-500"></i> <span class="text-sm font-bold">Clientes</span>
                </button>
                <button onclick="window.location.href='./WhatsApp.html'"
                    class="bg-white/60 text-slate-600 px-5 py-2.5 rounded-xl hover:bg-white/80 transition-all border border-white/40 shadow-sm flex items-center gap-2">
                    <i class="fab fa-whatsapp text-green-500"></i> <span class="text-sm font-bold">WhatsApp</span>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="lg:col-span-2 flex flex-col gap-8">
                <section id="widget-assistant"
                    class="glassmorphism rounded-2xl overflow-hidden dashboard-card ia">
                    <div
                        class="p-6 border-b border-white/20 flex justify-between items-center cursor-pointer collapsible-header">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-wand-magic-sparkles"></i>
                            </div>
                            <div class="flex flex-col">
                                <h2 class="text-xl font-bold">Assistente Inteligente</h2>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="ai-badge">Personalizado</span>
                                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">IA
                                        Ativa</span>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400"></i>
                    </div>

                    <div class="collapsible-content px-6 pb-8 pt-6">
                        <div id="assistant-initial-state" class="text-center py-4">
                            <p id="assistant-prompt-text" class="text-slate-600 mb-6 text-sm max-w-sm mx-auto">
                                Transforme seus eventos e tarefas em um plano de ação estratégico.
                            </p>
                            <div id="assistant-actions" class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button id="plan-day-btn"
                                    class="gemini-btn font-bold py-3.5 px-8 rounded-xl w-full sm:w-auto text-sm transition-all">
                                    <i class="fas fa-bolt mr-2"></i> Gerar Plano Diário
                                </button>
                                <button id="view-plan-history-btn"
                                    class="bg-white text-slate-700 border border-slate-200 font-bold py-3.5 px-8 rounded-xl w-full sm:w-auto text-sm hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-history"></i> Histórico
                                </button>
                            </div>
                        </div>
                        <div id="plan-display-area"></div>
                        <i class="fas fa-robot stat-icon-bg"></i>
                    </div>
                </section>

                <section id="widget-finance-summary"
                    class="glassmorphism rounded-2xl overflow-hidden dashboard-card receita">
                    <div
                        class="p-6 border-b border-white/20 flex justify-between items-center cursor-pointer collapsible-header">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h2 class="text-xl font-bold">Balanço Mensal</h2>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400"></i>
                    </div>

                    <div class="collapsible-content px-6 pb-6 pt-6">
                        <div id="finance-summary-loading" class="text-center text-slate-400 py-6">
                            <div
                                class="loader-sm inline-block w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin">
                            </div>
                            <p class="mt-2 text-xs font-medium">Sincronizando...</p>
                        </div>

                        <div id="finance-summary-content" class="hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Card: Receitas -->
                                <div
                                    class="bg-white/50 p-6 rounded-2xl border border-gray-200/50 shadow-sm flex flex-col justify-between">
                                    <div>
                                        <p
                                            class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mb-2">
                                            Receitas Totais</p>
                                        <p id="finance-summary-receitas"
                                            class="text-3xl font-extrabold text-gray-800 tracking-tight">R$ 0,00</p>
                                    </div>
                                    <div id="receitas-comparison" class="mt-4 text-[11px] text-gray-500">
                                        <!-- Preenchido via JS -->
                                    </div>
                                </div>

                                <!-- Card: Despesas -->
                                <div
                                    class="bg-white/50 p-6 rounded-2xl border border-gray-200/50 shadow-sm flex flex-col justify-between">
                                    <div>
                                        <p class="text-[10px] font-bold text-red-600 uppercase tracking-widest mb-2">
                                            Despesas Totais</p>
                                        <p id="finance-summary-despesas"
                                            class="text-3xl font-extrabold text-gray-800 tracking-tight">R$ 0,00</p>
                                    </div>
                                    <div id="despesas-comparison" class="mt-4 text-[11px] text-gray-500">
                                        <!-- Preenchido via JS (incluindo Gastos Pendentes) -->
                                    </div>
                                </div>

                                <!-- Card: Saldo -->
                                <div
                                    class="bg-white/50 p-6 rounded-2xl border border-gray-200/50 shadow-sm flex flex-col justify-between">
                                    <div>
                                        <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-2">
                                            Saldo Final</p>
                                        <p id="finance-summary-saldo"
                                            class="text-3xl font-extrabold text-blue-600 tracking-tight">R$ 0,00</p>
                                    </div>
                                    <div id="saldo-comparison" class="mt-4 text-[11px] text-gray-500">
                                        <!-- Preenchido via JS -->
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">Referência:
                                    <span id="finance-summary-month" class="text-slate-600">--</span></span>
                                <button onclick="window.location.href='./Sistema Gestão Financeira.html'"
                                    class="text-xs font-bold text-indigo-600 hover:text-indigo-800 transition-colors flex items-center gap-1">
                                    Ver Painel Completo <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                        <i class="fas fa-chart-line stat-icon-bg"></i>
                    </div>
                </section>

                <section id="widget-events" class="glassmorphism rounded-2xl overflow-hidden dashboard-card saldo">
                    <div
                        class="p-6 border-b border-white/20 flex justify-between items-center cursor-pointer collapsible-header">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h2 class="text-xl font-bold">Agenda Próxima</h2>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400"></i>
                    </div>
                    <div class="collapsible-content px-4 md:px-6 pb-6 pt-4">
                        <div id="upcoming-events-list" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                            <!-- Eventos serão carregados aqui -->
                        </div>
                    </div>
                    <i class="fas fa-calendar-alt stat-icon-bg"></i>
                </section>

                <section id="widget-dates" class="glassmorphism rounded-2xl overflow-hidden dashboard-card despesa">
                    <div
                        class="p-6 border-b border-white/20 flex justify-between items-center cursor-pointer collapsible-header">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center">
                                <i class="fas fa-gift"></i>
                            </div>
                            <h2 class="text-xl font-bold">Datas Especiais</h2>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400"></i>
                    </div>
                    <div class="collapsible-content px-4 md:px-6 pb-6 pt-4">
                        <div id="relevant-dates-list"
                            class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-1">
                            <!-- Datas relevantes serão carregadas aqui -->
                        </div>
                    </div>
                    <i class="fas fa-birthday-cake stat-icon-bg"></i>
                </section>
            </div>
        </main>
    </div>

    <!-- [NOVO] Sidebar de Tarefas - Lateral Direita (Design Ultra-Premium) -->
    <div id="sidebar-overlay"></div>
    <div id="task-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title-group">
                <div class="sidebar-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <div>
                    <h2 class="sidebar-title">Minhas Tarefas</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Organização Diária</p>
                </div>
            </div>
            <button id="close-sidebar"
                class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all sm:hidden">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="px-8 pb-8 flex-grow flex flex-col min-h-0">
            <div class="flex p-1.5 bg-slate-100/80 rounded-2xl mb-8">
                <button id="tab-today"
                    class="tab-btn flex-1 py-3 text-xs font-bold rounded-xl transition-all bg-white text-indigo-600 shadow-sm border border-indigo-100/50">Hoje</button>
                <button id="tab-general"
                    class="tab-btn flex-1 py-3 text-xs font-bold rounded-xl transition-all text-slate-500 hover:text-slate-700">Geral</button>
            </div>

            <div id="task-lists-container" class="flex-grow overflow-y-auto pr-2 space-y-4 custom-scrollbar">
                <div id="tasks-today-list" class="task-list space-y-4"></div>
                <div id="tasks-general-list" class="task-list space-y-4 hidden"></div>
            </div>

            <div class="mt-8 pt-8 border-t border-slate-100 relative z-10">
                <form id="add-task-form" class="space-y-4">
                    <div class="relative group">
                        <input type="text" id="new-task-input" placeholder="O que precisa ser feito?"
                            class="w-full pl-5 pr-12 py-4 rounded-2xl bg-slate-50 border border-transparent focus:bg-white focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-400 outline-none transition-all text-sm font-medium text-slate-700 placeholder:text-slate-400"
                            required>
                        <button type="button" id="breakdown-task-btn"
                            class="absolute right-4 top-1/2 -translate-y-1/2 w-9 h-9 flex items-center justify-center text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 rounded-xl transition-all"
                            title="✨ IA">
                            <i class="fas fa-wand-magic-sparkles text-sm"></i>
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <div class="relative flex-grow">
                            <i
                                class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="date" id="new-task-date"
                                class="w-full pl-10 pr-4 py-4 rounded-2xl bg-slate-50 border border-transparent text-xs font-bold text-slate-600 outline-none focus:bg-white focus:border-indigo-400 transition-all">
                        </div>
                        <button type="submit"
                            class="bg-indigo-600 text-white w-14 h-14 rounded-2xl hover:bg-indigo-700 transition-all flex items-center justify-center shadow-lg shadow-indigo-200 active:scale-95 flex-shrink-0">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <i class="fas fa-tasks stat-icon-bg opacity-[0.03]"></i>
    </div>

    <!-- [NOVO] Botão Flutuante para Abrir Sidebar (Mobile First) -->
    <div id="sidebar-toggle">
        <i class="fas fa-list-check"></i>
        <span>Tarefas</span>
    </div>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="bottom-nav active" id="main-bottom-nav">
        <!-- Handle Tátil (Puxador Integrado) -->
        <div class="bottom-nav-handle" id="bottom-nav-handle">
            <i class="fas fa-chevron-up"></i>
        </div>

        <a href="#" class="nav-item active">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </a>
        <a href="./Agenda de eventos.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Agenda</span>
        </a>
        <a href="./Sistema Gestão Financeira.html" class="nav-item">
            <i class="fas fa-wallet"></i>
            <span>Financeiro</span>
        </a>
        <a href="./Sistema de CRM.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
        <a href="./WhatsApp.html" class="nav-item" style="position:relative;">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
            <span id="wa-nav-badge" class="hidden" style="position:absolute;top:2px;right:8px;background:#ef4444;color:white;font-size:10px;font-weight:bold;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;"></span>
        </a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('main-bottom-nav');
            const handle = document.getElementById('bottom-nav-handle');

            if (bottomNav) {
                const toggleNav = (e) => {
                    e.stopPropagation();
                    bottomNav.classList.toggle('collapsed');
                };

                handle?.addEventListener('click', toggleNav);

                bottomNav.addEventListener('click', (e) => {
                    if (bottomNav.classList.contains('collapsed')) {
                        toggleNav(e);
                    }
                });
            }

            // --- LÓGICA DA SIDEBAR DE TAREFAS ---
            const taskSidebar = document.getElementById('task-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const closeSidebar = document.getElementById('close-sidebar');

            const toggleSidebar = () => {
                const isOpen = taskSidebar.classList.toggle('open');
                sidebarToggle.classList.toggle('active');
                sidebarOverlay.classList.toggle('visible');
                document.body.classList.toggle('overflow-hidden', isOpen);
            };

            sidebarToggle?.addEventListener('click', toggleSidebar);
            sidebarOverlay?.addEventListener('click', toggleSidebar);
            closeSidebar?.addEventListener('click', toggleSidebar);
        });
    </script>

    <!-- Modal API Key -->
    <!-- [MODIFICADO] z-index de z-50 para z-30 -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-30">
        <div class="modal-box glassmorphism p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Configurar API do Gemini</h2>
            <p class="text-sm text-gray-600 mb-4">Para usar os recursos de IA, você precisa de uma chave de API.</p>

            <div class="bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-100">
                <h3 class="text-indigo-800 font-bold text-sm mb-2 flex items-center">
                    <i class="fa-solid fa-circle-info mr-2"></i> Como conseguir a chave?
                </h3>
                <ol class="text-xs text-indigo-700 space-y-2 list-decimal ml-4">
                    <li>Clique no link azul abaixo (Google AI Studio).</li>
                    <li>Faça login com sua conta Google.</li>
                    <li>Clique no botão azul <strong>"Create API key"</strong>.</li>
                    <li>Copie o código gerado e cole no campo abaixo.</li>
                </ol>
                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                    class="block mt-3 text-center bg-white text-indigo-600 border border-indigo-200 py-1.5 rounded-md font-bold text-xs hover:bg-indigo-50 transition-colors">
                    <i class="fa-solid fa-external-link mr-1"></i> Ir para Google AI Studio
                </a>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium mb-1">Sua Chave da API</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave aqui"
                        class="form-input w-full px-3 py-2 rounded-md">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-api-key-btn"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="button" id="save-api-key-btn" class="shiny-btn px-6 py-2 rounded-md">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gemini (Plano do Dia / Quebrar Tarefa) -->
    <!-- [MODIFICADO] z-index de z-50 para z-40 -->
    <div id="gemini-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-40">
        <div id="gemini-modal-box"
            class="modal-box glassmorphism w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="gemini-modal-title" class="text-2xl font-semibold">✨ Assistente IA</h2>
                <button id="gemini-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto">
                <!-- O conteúdo será injetado aqui -->
            </div>
            <!-- [MODIFICADO] Removido 'hidden' para que o listener do botão de histórico possa mostrá-lo -->
            <div id="gemini-modal-footer"
                class="p-4 bg-gray-50/50 border-t border-gray-200/50 flex justify-end space-x-4">
                <button id="gemini-copy-btn" class="shiny-btn py-2 px-4 rounded-lg">Copiar Texto</button>
            </div>
        </div>
    </div>

    <!-- [NOVO] Modal de Chat da IA (Sobre o modal principal) -->
    <!-- [MODIFICADO] z-index de z-60 para z-50 -->
    <div id="gemini-chat-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-box glassmorphism w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <!-- [MODIFICADO] Título agora está vazio e será preenchido via JS -->
                <h2 id="gemini-chat-title" class="text-xl font-semibold"></h2>
                <button id="gemini-chat-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="gemini-chat-messages" class="p-6 flex-grow overflow-y-auto space-y-4">
                <!-- Mensagens do chat serão injetadas aqui -->
            </div>
            <div class="p-4 bg-gray-50/50 border-t border-gray-200/50">
                <form id="gemini-chat-form" class="flex gap-2 items-center">
                    <input type="text" id="gemini-chat-input" placeholder="Digite sua pergunta..."
                        class="form-input w-full" required>
                    <button type="submit" id="gemini-chat-send-btn"
                        class="bg-indigo-500 text-white w-10 h-10 rounded-md hover:bg-indigo-600 transition-colors flex-shrink-0"
                        title="Enviar">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <!-- [MODIFICADO] z-index de z-50 para z-60 (para ficar acima de tudo) -->
    <div id="toast"
        class="fixed bottom-5 right-5 flex items-center text-white px-5 py-3 rounded-lg shadow-xl hidden transition-all duration-300 z-60">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="ml-3"></p>
    </div>

    <!-- [NOVO] Modal de Detalhes Financeiros -->
    <div id="finance-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-40">
        <div id="finance-modal-box"
            class="modal-box glassmorphism w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col rounded-lg">
            <div class="p-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 id="finance-modal-title" class="text-2xl font-semibold">Detalhes Financeiros (Mês)</h2>
                <button id="finance-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <!-- Abas -->
            <div class="flex border-b border-gray-200/50" style="background-color: var(--input-bg);">
                <button id="finance-tab-1" class="finance-tab-btn flex-1 py-3 px-4 text-sm font-medium" data-tab="1">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Resumo
                </button>
                <button id="finance-tab-2" class="finance-tab-btn flex-1 py-3 px-4 text-sm font-medium" data-tab="2">
                    <i class="fas fa-chart-pie mr-2"></i>Gráficos
                </button>
                <button id="finance-tab-3" class="finance-tab-btn flex-1 py-3 px-4 text-sm font-medium" data-tab="3">
                    <i class="fas fa-calendar-check mr-2"></i>Contas Fixas
                </button>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="p-6 overflow-y-auto flex-grow" style="background-color: var(--card-bg)">
                <!-- Aba 1: Resumo -->
                <div id="finance-content-1" class="finance-modal-content">
                    <h3 class="text-xl font-semibold mb-4">Balanço do Mês (<span id="finance-modal-month-1">--</span>)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-lg font-semibold text-emerald-600">Receitas Totais</h4>
                            <p id="finance-modal-receitas" class="text-3xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-lg font-semibold text-red-600">Despesas Totais</h4>
                            <p id="finance-modal-despesas" class="text-3xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-lg font-semibold text-amber-600">Gastos Pendentes</h4>
                            <p id="finance-modal-pendentes" class="text-3xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-lg font-semibold text-blue-600">Saldo Final</h4>
                            <p id="finance-modal-saldo" class="text-3xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Aba 2: Gráficos -->
                <div id="finance-content-2" class="finance-modal-content">
                    <h3 class="text-xl font-semibold mb-4">Gráficos do Mês (<span id="finance-modal-month-2">--</span>)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-center font-semibold mb-2">Receita vs. Despesa</h4>
                            <canvas id="finance-chart-receita-despesa" class="max-h-64"></canvas>
                        </div>
                        <div class="bg-white/50 p-4 rounded-lg border border-gray-200/50">
                            <h4 class="text-center font-semibold mb-2">Composição das Despesas</h4>
                            <canvas id="finance-chart-despesa-comp" class="max-h-64"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Aba 3: Contas Fixas -->
                <div id="finance-content-3" class="finance-modal-content">
                    <h3 class="text-xl font-semibold mb-4">Status das Contas Fixas (<span
                            id="finance-modal-month-3">--</span>)</h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200/50">
                        <table class="min-w-full bg-white/50">
                            <thead class="bg-gray-50/50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider">
                                        Descrição</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider">Valor
                                        Previsto</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider">
                                        Vencimento</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider">Status
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="finance-modal-contas-fixas-tbody" class="divide-y divide-gray-200/50">
                                <!-- Conteúdo será injetado pelo JS -->
                                <tr>
                                    <td colspan="4" class="p-4 text-center text-gray-500">Carregando contas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { api } from './js/api.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // --- LOGICA DE TEMA (DARK MODE) ---
            const themeToggle = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;
            const bodyElement = document.body;

            // Carrega preferência salva
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                htmlElement.classList.add('dark');
                bodyElement.classList.add('dark');
            }

            themeToggle?.addEventListener('click', () => {
                const isDark = htmlElement.classList.toggle('dark');
                bodyElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // Atualiza cores dos gráficos se existirem
                if (window.Chart) {
                    Chart.helpers.each(Chart.instances, (instance) => {
                        const options = instance.options;
                        if (isDark) {
                            if (options.scales && options.scales.x) {
                                options.scales.x.grid.color = 'rgba(255, 255, 255, 0.1)';
                                options.scales.y.grid.color = 'rgba(255, 255, 255, 0.1)';
                            }
                            if (options.plugins && options.plugins.legend) {
                                options.plugins.legend.labels.color = '#94a3b8';
                            }
                        } else {
                            if (options.scales && options.scales.x) {
                                options.scales.x.grid.color = 'rgba(0, 0, 0, 0.05)';
                                options.scales.y.grid.color = 'rgba(0, 0, 0, 0.05)';
                            }
                            if (options.plugins && options.plugins.legend) {
                                options.plugins.legend.labels.color = '#64748b';
                            }
                        }
                        instance.update();
                    });
                }

                // Feedback visual
                if (window.showToast) showToast(isDark ? "Modo Escuro ativado" : "Modo Claro ativado", false);
            });

            // --- CONFIGURAÇÕES GLOBAIS E INICIALIZAÇÃO ---
            let currentContext = { events: [], tasks: [] }; // [NOVO] Armazena o contexto do plano
            let chatHistory = []; // [NOVO] Armazena o histórico do chat
            let currentDailyPlan = null; // [NOVO] Armazena o plano exibido no momento

            // --- [NOVO] Constantes do Widget Financeiro ---
            const financeWidgetLoading = document.getElementById('finance-summary-loading');
            const financeWidgetContent = document.getElementById('finance-summary-content');
            const financeWidgetReceitas = document.getElementById('finance-summary-receitas');
            const financeWidgetDespesas = document.getElementById('finance-summary-despesas');
            const financeWidgetPendentes = document.getElementById('finance-summary-pendentes');
            const financeWidgetSaldo = document.getElementById('finance-summary-saldo');
            const financeWidgetMonth = document.getElementById('finance-summary-month');

            const financeModal = document.getElementById('finance-modal');
            const financeCloseBtn = document.getElementById('finance-close-btn');
            const financeTabBtns = document.querySelectorAll('.finance-tab-btn');
            const financeTabContents = document.querySelectorAll('.finance-modal-content');

            const financeModalMonth1 = document.getElementById('finance-modal-month-1');
            const financeModalMonth2 = document.getElementById('finance-modal-month-2');
            const financeModalMonth3 = document.getElementById('finance-modal-month-3');

            const financeModalReceitas = document.getElementById('finance-modal-receitas');
            const financeModalDespesas = document.getElementById('finance-modal-despesas');
            const financeModalPendentes = document.getElementById('finance-modal-pendentes');
            const financeModalSaldo = document.getElementById('finance-modal-saldo');
            const financeModalContasTbody = document.getElementById('finance-modal-contas-fixas-tbody');

            let financeChart1 = null;
            let financeChart2 = null;
            let loadedFinancialData = null; // Cache para modal
            const FINANCE_STORAGE_KEY = 'financeDataV21'; // Chave do sistema financeiro
            // --- Fim das Constantes Financeiras ---


            const BIBLE_VERSES = [
                { text: "O Senhor é meu pastor, nada me faltará.", ref: "Salmo 22, 1" },
                { text: "Tudo posso naquele que me conforta.", ref: "Filipenses 4, 13" },
                { text: "O Senhor é minha luz e minha salvação, a quem temerei?", ref: "Salmo 26, 1" },
                { text: "Deem graças ao Senhor, porque ele é bom, porque o seu amor é para sempre.", ref: "Salmo 135, 1" },
                { text: "Pois é pela graça que fostes salvos, por meio da fé. E isto não vem de vós: é dom de Deus.", ref: "Efésios 2, 8" },
                { text: "O temor do Senhor é o princípio da sabedoria.", ref: "Provérbios 9, 10" },
                { text: "Vinde a mim, vós todos que estais aflitos sob o fardo, e eu vos aliviarei.", ref: "Mateus 11, 28" },
                { text: "A caridade é paciente, a caridade é bondosa. Não tem inveja. A caridade não é orgulhosa. Não é arrogante.", ref: "I Coríntios 13, 4" }
            ];

            // --- INÍCIO DA MODIFICAÇÃO: DEFINIÇÃO DE FERIADOS E ANIVERSÁRIOS ---
            const FIXED_HOLIDAYS_CITY_ANNIVERSARIES = [
                // Feriados Nacionais Fixos
                { name: 'Confraternização Universal', date: '01-01', type: 'holiday_nat' },
                { name: 'Tiradentes', date: '04-21', type: 'holiday_nat' },
                { name: 'Dia do Trabalho', date: '05-01', type: 'holiday_nat' },
                { name: 'Independência do Brasil', date: '09-07', type: 'holiday_nat' },
                { name: 'Nossa Senhora Aparecida', date: '10-12', type: 'holiday_nat' },
                { name: 'Finados', date: '11-02', type: 'holiday_nat' },
                { name: 'Proclamação da República', date: '11-15', type: 'holiday_nat' },
                { name: 'Natal', date: '12-25', type: 'holiday_nat' },
                // Feriados Móveis (Exemplo para 2025 - Idealmente calcular ou obter de API)
                { name: 'Carnaval (ponto facultativo)', date: '03-03', year: 2025, type: 'holiday_opt' }, // Segunda
                { name: 'Carnaval (ponto facultativo)', date: '03-04', year: 2025, type: 'holiday_opt' }, // Terça
                { name: 'Sexta-feira Santa', date: '04-18', year: 2025, type: 'holiday_nat' }, // Paixão de Cristo
                { name: 'Corpus Christi', date: '06-19', year: 2025, type: 'holiday_nat' },
                // Aniversários Cidades Goiás (Exemplos)
                { name: 'Aniversário de Goiânia', date: '10-24', type: 'city_anniversary_go' },
                { name: 'Aniversário de Aparecida de Goiânia', date: '05-11', type: 'city_anniversary_go' },
                { name: 'Aniversário de Anápolis', date: '07-31', type: 'city_anniversary_go' },
                // { name: 'Padroeira de Goiânia (N. Sra. Auxiliadora)', date: '05-24', type: 'holiday_mun_gyn' }, // Feriado Municipal Gyn
            ];
            // --- FIM DA MODIFICAÇÃO: DEFINIÇÃO DE FERIADOS E ANIVERSÁRIOS ---

            function displayRandomVerse() {
                const verse = BIBLE_VERSES[Math.floor(Math.random() * BIBLE_VERSES.length)];
                document.getElementById('verse-text').textContent = `"${verse.text}"`;
                document.getElementById('verse-ref').textContent = verse.ref;
            }

            function applyTheme() {
                const hour = new Date().getHours();
                const root = document.documentElement;

                if (hour >= 5 && hour < 12) { // Manhã
                    root.style.setProperty('--bg-color', '#e0f2fe');
                    root.style.setProperty('--text-color', '#0c4a6e');
                    root.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.7)');
                    root.style.setProperty('--header-grad-from', '#38bdf8');
                    root.style.setProperty('--header-grad-to', '#fb923c');
                } else if (hour >= 12 && hour < 18) { // Tarde
                    // Tema padrão (já definido no :root)
                } else { // Noite
                    root.style.setProperty('--bg-color', '#1e293b');
                    root.style.setProperty('--text-color', '#e2e8f0');
                    root.style.setProperty('--glass-bg', 'rgba(30, 41, 59, 0.7)');
                    root.style.setProperty('--header-grad-from', '#818cf8');
                    root.style.setProperty('--header-grad-to', '#c084fc');
                    root.style.setProperty('--card-bg', 'rgba(51, 65, 85, 0.6)');
                    root.style.setProperty('--border-color', 'rgba(71, 85, 105, 0.3)');
                    root.style.setProperty('--input-bg', '#334155');
                    root.style.setProperty('--input-border', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--input-text', '#f1f5f9');
                    root.style.setProperty('--input-placeholder', '#64748b');
                }
            }

            function setGreeting() {
                const greetingEl = document.getElementById('greeting');
                const hour = new Date().getHours();

                // Busca o nome do usuário do backend (salvo pelo protect.js)
                let userName = 'Usuário'; // Nome padrão caso não encontre
                try {
                    const userData = JSON.parse(localStorage.getItem('userData'));
                    if (userData && userData.name) {
                        // Pega só o primeiro nome
                        userName = userData.name.split(' ')[0];
                    }
                } catch (e) {
                    console.warn('Erro ao buscar nome do usuário:', e);
                }

                let greetingText = '';
                if (hour < 5) {
                    greetingText = `Boa madrugada, ${userName}`;
                } else if (hour < 12) {
                    greetingText = `Bom dia, ${userName}`;
                } else if (hour < 18) {
                    greetingText = `Boa tarde, ${userName}`;
                } else {
                    greetingText = `Boa noite, ${userName}`;
                }
                greetingEl.textContent = greetingText;

                // [NOVO] Define a data no header
                const dateHeader = document.getElementById('current-date-header');
                if (dateHeader) {
                    dateHeader.textContent = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
                }
            }

            // --- CARREGAMENTO DE DADOS (Eventos, Datas, Tarefas) ---

            async function loadUpcomingEvents() {
                const eventsListEl = document.getElementById('upcoming-events-list');
                const events = await api.getEventos();
                if (!events || events.length === 0) {
                    eventsListEl.innerHTML = '<p class="text-gray-500">Nenhum evento encontrado na agenda.</p>';
                    return;
                }
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const upcomingEvents = events
                    .filter(event => new Date(event.date + 'T00:00:00') >= today)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5);

                if (upcomingEvents.length === 0) {
                    eventsListEl.innerHTML = '<p class="text-gray-500">Nenhum evento futuro agendado.</p>';
                    return;
                }

                eventsListEl.innerHTML = upcomingEvents.map(event => {
                    const eventDate = new Date(event.date + 'T00:00:00');
                    const formattedDate = eventDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    const dayOfWeek = eventDate.toLocaleDateString('pt-BR', { weekday: 'long' });

                    // Link para editar evento na agenda
                    return `
                <a href="./Agenda de eventos.html?editEvent=${event.id}" class="block transition-transform transform hover:scale-[1.02] hover:shadow-lg rounded-lg" title="Clique para ver detalhes e editar na agenda">
                    <div class="flex items-center gap-4 p-3 bg-white/50 rounded-lg" style="background-color: var(--card-bg)">
                        <div class="text-center w-20 flex-shrink-0">
                            <p class="text-2xl font-bold text-indigo-600">${formattedDate.split(' ')[0]}</p>
                            <p class="text-sm text-gray-500 capitalize">${dayOfWeek.split('-')[0]}</p>
                        </div>
                        <div class="flex-grow border-l-2 border-indigo-200 pl-4">
                            <p class="font-semibold">${event.clientName}</p>
                            <p class="text-sm capitalize" style="color: var(--text-muted-color)"><i class="fas fa-map-marker-alt fa-fw mr-1"></i> ${event.clientAddress || 'Local a confirmar'}</p>
                            <p class="text-sm" style="color: var(--text-muted-color)"><i class="fas fa-clock fa-fw mr-1"></i> ${event.startTime || ''} - ${event.endTime || ''}</p>
                        </div>
                    </div>
                </a>
            `;
                }).join('');
            }

            // --- INÍCIO DA MODIFICAÇÃO: FUNÇÃO loadRelevantDates ---
            async function loadRelevantDates() {
                const datesListEl = document.getElementById('relevant-dates-list');
                const clients = await api.getClientes();
                let allDates = [];
                const currentYear = new Date().getFullYear();

                // 1. Adiciona aniversários (usuário e clientes)
                allDates.push({ name: 'Leandro (Aniversariante)', dateStr: '1990-10-25', type: 'user', id: null });
                if (clients && clients.length > 0) {
                    clients.forEach(client => {
                        if (client.dataNascimento) {
                            allDates.push({ name: client.nome, dateStr: client.dataNascimento, type: 'client', id: client.id });
                        }
                    });
                }

                // 2. Adiciona feriados e aniversários de cidades
                FIXED_HOLIDAYS_CITY_ANNIVERSARIES.forEach(item => {
                    // Se o item tem um ano específico e não é o ano atual, ignora
                    if (item.year && item.year !== currentYear) {
                        return;
                    }
                    allDates.push({
                        name: item.name,
                        dateStr: item.date, // Formato MM-DD ou YYYY-MM-DD para móveis
                        type: item.type,
                        id: null
                    });
                });

                // 3. Processa e filtra as datas
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const lookaheadLimit = new Date();
                lookaheadLimit.setDate(today.getDate() + 30); // Limite de 30 dias

                const upcomingDates = allDates
                    .map(item => {
                        let month, day, year;
                        let isRecurring = false;

                        // Tenta parsear a data (MM-DD, YYYY-MM-DD, DD/MM/YYYY)
                        if (item.dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) { // YYYY-MM-DD (aniversários CRM, feriados móveis específicos)
                            [year, month, day] = item.dateStr.split('-').map(Number);
                            if (item.type === 'client' || item.type === 'user') isRecurring = true; // Aniversários são recorrentes
                        } else if (item.dateStr.match(/^\d{2}-\d{2}$/)) { // MM-DD (feriados fixos, aniversários de cidades)
                            [month, day] = item.dateStr.split('-').map(Number);
                            isRecurring = true;
                        } else if (item.dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) { // DD/MM/YYYY (possível formato do CRM)
                            [day, month, year] = item.dateStr.split('/').map(Number);
                            if (item.type === 'client' || item.type === 'user') isRecurring = true;
                        } else {
                            console.warn(`Formato de data inválido para ${item.name}: ${item.dateStr}`);
                            return null; // Formato inválido
                        }

                        if (!month || !day) return null; // Mês ou dia inválido

                        let nextOccurrence;
                        if (isRecurring) {
                            // Calcula a próxima ocorrência para datas recorrentes
                            nextOccurrence = new Date(currentYear, month - 1, day);
                            if (nextOccurrence < today) {
                                nextOccurrence.setFullYear(currentYear + 1); // Se já passou este ano, calcula para o próximo
                            }
                        } else if (year) {
                            // Para datas não recorrentes com ano (feriados móveis)
                            nextOccurrence = new Date(year, month - 1, day);
                        } else {
                            return null; // Não é possível calcular
                        }

                        // Verifica se a data é válida
                        if (isNaN(nextOccurrence.getTime())) {
                            console.warn(`Data inválida calculada para ${item.name}: ${item.dateStr}`);
                            return null;
                        }

                        item.nextOccurrence = nextOccurrence;
                        return item;
                    })
                    .filter(item => item && item.nextOccurrence >= today && item.nextOccurrence <= lookaheadLimit) // Filtra para os próximos 30 dias
                    .sort((a, b) => a.nextOccurrence - b.nextOccurrence); // Ordena cronologicamente

                // 4. Renderiza a lista
                if (upcomingDates.length === 0) {
                    datesListEl.innerHTML = '<p class="text-gray-500">Nenhuma data relevante nos próximos 30 dias.</p>';
                    return;
                }

                datesListEl.innerHTML = upcomingDates.map(item => {
                    const formattedDate = item.nextOccurrence.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });
                    const isToday = item.nextOccurrence.toDateString() === today.toDateString();
                    const highlightClass = isToday ? 'bg-yellow-100 font-bold' : '';
                    let iconClass = 'fa-calendar-day text-gray-500'; // Default
                    let title = item.name;

                    // Define ícone e título com base no tipo
                    switch (item.type) {
                        case 'user':
                            iconClass = 'fa-star text-yellow-500';
                            title = `${item.name}`; // Já inclui (Aniversariante)
                            break;
                        case 'client':
                            iconClass = 'fa-user-friends text-green-500';
                            title = `Aniv. ${item.name}`;
                            break;
                        case 'holiday_nat':
                            iconClass = 'fa-flag text-red-500';
                            title = `${item.name} (Feriado Nac.)`;
                            break;
                        case 'holiday_opt':
                            iconClass = 'fa-flag text-orange-500';
                            title = `${item.name}`; // Já inclui (ponto facultativo)
                            break;
                        case 'city_anniversary_go':
                            iconClass = 'fa-map-pin text-blue-500';
                            title = `${item.name}`; // Já inclui Aniversário de...
                            break;
                        // Adicione outros tipos se necessário
                    }

                    // Cria link para clientes, div para os outros
                    if (item.type === 'client' && item.id) {
                        return `
                    <a href="./Sistema de CRM.html?clientId=${item.id}" class="block transition-transform transform hover:scale-[1.02] hover:shadow-sm rounded-md" title="Ver perfil de ${item.name} no CRM">
                        <div class="flex items-center gap-3 p-2 ${highlightClass} rounded-md" style="background-color: var(--card-bg)">
                            <i class="fas ${iconClass} fa-fw"></i>
                            <p class="flex-grow">${title}</p>
                            <p class="text-sm">${formattedDate}</p>
                        </div>
                    </a>
                `;
                    } else {
                        return `
                    <div class="flex items-center gap-3 p-2 ${highlightClass} rounded-md" style="background-color: var(--card-bg)">
                        <i class="fas ${iconClass} fa-fw"></i>
                        <p class="flex-grow">${title}</p>
                        <p class="text-sm">${formattedDate}</p>
                    </div>
                `;
                    }
                }).join('');
            }
            // --- FIM DA MODIFICAÇÃO: FUNÇÃO loadRelevantDates ---

            // --- GESTÃO DE TAREFAS (CLOUD) ---
            const taskState = {
                tasks: [],
                activeTab: 'today'
            };

            async function syncTasks() {
                taskState.tasks = await api.getTasks();
                renderTasks();
            }

            function renderTasks() {
                const todayListEl = document.getElementById('tasks-today-list');
                const generalListEl = document.getElementById('tasks-general-list');

                const today = new Date().toISOString().split('T')[0];

                // Mostra tarefas de hoje (com data de hoje)
                const todayTasks = taskState.tasks.filter(task => task.dueDate === today && !task.completed);
                // Mostra tarefas gerais (sem data OU com data passada E não concluídas)
                const generalTasks = taskState.tasks.filter(task => !task.completed && (!task.dueDate || task.dueDate < today));

                const renderList = (tasks, listEl) => {
                    // Ordena: primeiro as sem data, depois as com data mais antiga
                    tasks.sort((a, b) => {
                        if (!a.dueDate && b.dueDate) return -1;
                        if (a.dueDate && !b.dueDate) return 1;
                        if (!a.dueDate && !b.dueDate) return 0;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });

                    if (tasks.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-gray-500 pt-4">Nenhuma tarefa por aqui.</p>';
                    } else {
                        listEl.innerHTML = tasks.map(task => {
                            const isPastDue = task.dueDate && task.dueDate < today;
                            const dateClass = isPastDue ? 'bg-red-200 text-red-700' : 'bg-gray-200 text-gray-600';
                            const dateText = task.dueDate ? new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR') : '';

                            return `
                                <div class="task-item flex items-center gap-3 p-2 rounded-md" style="background-color: var(--card-bg)">
                                    <label class="flex-grow flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''} class="task-checkbox h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="${isPastDue ? 'text-red-700 font-medium' : ''}">${task.text}</span>
                                    </label>
                                    ${dateText ? `<span class="text-xs ${dateClass} px-2 py-1 rounded-full">${dateText}</span>` : ''}
                                    <button data-id="${task.id}" class="delete-task-btn text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `;
                        }).join('');
                    }
                };

                // Renderiza AMBAS as listas. A visibilidade é controlada pela função switchTab.
                renderList(todayTasks, todayListEl);
                renderList(generalTasks, generalListEl);

                addTaskListEventListeners();
            }

            async function addTask(text, dueDate = null) {
                const newTask = await api.salvarTarefa({ text, dueDate });
                if (newTask) {
                    taskState.tasks.push(newTask);
                    if (taskState.activeTab === 'today') {
                        switchTab('today');
                    } else {
                        switchTab('general');
                    }
                    showToast("Tarefa salva na nuvem!", false);
                } else {
                    showToast("Erro ao salvar tarefa na nuvem.");
                }
            }

            function addTaskListEventListeners() {
                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const taskId = e.target.dataset.id;
                        const completed = e.target.checked;

                        const updated = await api.atualizarTarefa(taskId, { completed });
                        if (updated) {
                            const task = taskState.tasks.find(t => t.id === taskId);
                            if (task) task.completed = completed;

                            setTimeout(() => {
                                renderTasks();
                                switchTab(taskState.activeTab);
                            }, 300);
                        } else {
                            showToast("Erro ao atualizar tarefa.");
                            e.target.checked = !completed;
                        }
                    });
                });

                document.querySelectorAll('.delete-task-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const taskId = e.currentTarget.dataset.id;
                        const ok = await api.deletarTarefa(taskId);
                        if (ok) {
                            taskState.tasks = taskState.tasks.filter(t => t.id !== taskId);
                            renderTasks();
                            switchTab(taskState.activeTab);
                            showToast("Tarefa removida!", false);
                        } else {
                            showToast("Erro ao remover tarefa.");
                        }
                    });
                });
            }

            document.getElementById('add-task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('new-task-input');
                const dateInput = document.getElementById('new-task-date');
                const text = input.value.trim();

                if (text) {
                    let dueDate = dateInput.value || null;
                    // Se a aba "Hoje" estiver ativa E nenhuma data foi selecionada, define como hoje
                    if (taskState.activeTab === 'today' && !dateInput.value) {
                        dueDate = new Date().toISOString().split('T')[0];
                    }

                    addTask(text, dueDate);
                    input.value = '';
                    // Define a data padrão baseada na aba ativa APÓS adicionar
                    dateInput.value = (taskState.activeTab === 'today') ? new Date().toISOString().split('T')[0] : '';
                }
            });

            const tabTodayBtn = document.getElementById('tab-today');
            const tabGeneralBtn = document.getElementById('tab-general');
            const todayListEl = document.getElementById('tasks-today-list');
            const generalListEl = document.getElementById('tasks-general-list');
            const taskDateInput = document.getElementById('new-task-date');

            function switchTab(tab) {
                taskState.activeTab = tab;
                const todayISO = new Date().toISOString().split('T')[0]; // Pega a data de hoje formatada

                if (tab === 'today') {
                    tabTodayBtn.classList.add('border-indigo-500', 'text-indigo-600');
                    tabTodayBtn.classList.remove('border-transparent', 'text-gray-500');
                    tabGeneralBtn.classList.add('border-transparent', 'text-gray-500');
                    tabGeneralBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                    todayListEl.classList.remove('hidden');
                    generalListEl.classList.add('hidden');
                    taskDateInput.value = todayISO; // Define o valor do input para hoje
                    taskDateInput.disabled = true; // Desabilita a data na aba "Hoje"
                } else { // Aba "Geral"
                    tabGeneralBtn.classList.add('border-indigo-500', 'text-indigo-600');
                    tabGeneralBtn.classList.remove('border-transparent', 'text-gray-500');
                    tabTodayBtn.classList.add('border-transparent', 'text-gray-500');
                    tabTodayBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                    generalListEl.classList.remove('hidden');
                    todayListEl.classList.add('hidden');
                    taskDateInput.value = ''; // Limpa a data na aba "Geral"
                    taskDateInput.disabled = false; // Permite selecionar data
                }
                renderTasks(); // Re-renderiza as tarefas para mostrar as corretas para a aba
            }

            tabTodayBtn.addEventListener('click', () => switchTab('today'));
            tabGeneralBtn.addEventListener('click', () => switchTab('general'));


            // --- [NOVO] LÓGICA DO WIDGET FINANCEIRO ---

            const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatarData = str => { if (!str) return '-'; const p = str.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; };

            /**
             * Busca e calcula os dados financeiros da API.
             */
            async function getFinancialData() {
                try {
                    // Busca mês atual
                    const now = new Date();
                    const year = now.getFullYear();
                    const monthNum = now.getMonth() + 1;
                    const currentMonth = `${year}-${String(monthNum).padStart(2, '0')}`;
                    const formattedMonth = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

                    // Busca dados da API
                    const [eventos, transacoes, contasFixas, pagamentosMonitores, funcionarios, faixasComissao] = await Promise.all([
                        api.getEventos().catch(() => []),
                        api.getTransacoes().catch(() => []),
                        api.getContasFixas().catch(() => []),
                        api.getPagamentosMonitores().catch(() => []),
                        api.getFuncionarios().catch(() => []),
                        api.getFaixasComissao().catch(() => [])
                    ]);

                    // Filtra por mês
                    const filterByMonth = (items, dateField = 'date') => {
                        return (items || []).filter(item => {
                            const itemDate = item[dateField] || item.data;
                            if (!itemDate) return false;
                            return itemDate.startsWith(currentMonth);
                        });
                    };

                    const filteredEventos = filterByMonth(eventos);
                    // Filtra apenas gastos (despesas)
                    const transacoesMes = filterByMonth(transacoes);
                    const filteredGastos = transacoesMes.filter(t => t.type === 'EXPENSE');

                    // Calcula receitas (soma dos eventos + entradas manuais de receita se houver)
                    const totalEventos = filteredEventos.reduce((acc, ev) => acc + (parseFloat(ev.totalPrice || ev.price) || 0), 0);
                    const totalReceitasManuais = transacoesMes.filter(t => t.type === 'REVENUE').reduce((acc, r) => acc + (parseFloat(r.amount) || 0), 0);
                    const totalReceitas = totalEventos + totalReceitasManuais;

                    // Calcula despesas
                    const totalDespesas = filteredGastos.reduce((acc, g) => acc + (parseFloat(g.amount) || 0), 0);

                    // Calcula saldo
                    const saldo = totalReceitas - totalDespesas;

                    // Lista para detalhes do modal de pendentes
                    let pendingDetails = [];
                    let totalPendentes = 0;

                    // 1. Contas Fixas Pendentes
                    const gastosFixosIds = new Set(filteredGastos.filter(g => g.contaFixaId).map(g => g.contaFixaId));
                    const descricoesGastos = filteredGastos.map(g => (g.description || "").toLowerCase());

                    const contasFixasDoMes = (contasFixas || []).filter(cf => {
                        const recType = cf.recurrenceType || cf.tipoRecorrencia || 'permanente';
                        if (recType === 'permanente') return true;
                        const startDate = cf.startDate || cf.dataInicio;
                        const numParc = cf.installments || cf.numParcelas;
                        if (recType === 'parcelada' && startDate && numParc) {
                            const [anoInicio, mesInicio] = startDate.split('-').map(Number);
                            const dInicio = new Date(anoInicio, mesInicio - 1);
                            const dFim = new Date(anoInicio, mesInicio - 1 + numParc);
                            const dAtual = new Date(year, monthNum - 1);
                            return dAtual >= dInicio && dAtual < dFim;
                        }
                        return false;
                    });

                    const contasFixasStatus = contasFixasDoMes.map(cf => {
                        const diaVenc = cf.dueDay || cf.diaVencimento || 0;
                        const vencimento = `${String(diaVenc).padStart(2, '0')}/${String(monthNum).padStart(2, '0')}/${year}`;
                        const descCF = (cf.description || cf.descricao || "").toLowerCase();
                        const idCF = cf.id;
                        const isPaid = gastosFixosIds.has(idCF) || (descCF && descricoesGastos.some(d => d.includes(descCF)));
                        const valor = parseFloat(cf.amount || cf.valor) || 0;

                        if (!isPaid) {
                            totalPendentes += valor;
                            pendingDetails.push({ id: cf.id, description: cf.description || cf.descricao, amount: valor, type: 'fixed' });
                        }

                        return {
                            descricao: cf.description || cf.descricao,
                            valor: valor,
                            vencimento: vencimento,
                            isPaid: isPaid,
                            status: isPaid ? "Lançado" : "Pendente"
                        };
                    });

                    // 2. Salários de Monitores Pendentes
                    const pagamentosMes = filterByMonth(pagamentosMonitores, 'data');
                    pagamentosMes.forEach(p => {
                        if (p.statusPagamento !== 'Executado') {
                            const totalPag = (parseFloat(p.valorBase) || 0) + (parseFloat(p.adicional) || 0) + (parseFloat(p.horasExtras) || 0);
                            totalPendentes += totalPag;
                            pendingDetails.push({ id: p.id, description: `Monitor: ${p.nome}`, amount: totalPag, type: 'monitor' });
                        }
                    });

                    // 3. Salários de Funcionários Pendentes
                    if (funcionarios.length > 0) {
                        const faixa = [...(faixasComissao || [])]
                            .sort((a, b) => a.ateValor - b.ateValor)
                            .find(f => totalReceitas <= f.ateValor) ||
                            (faixasComissao.length > 0 ? faixasComissao.sort((a, b) => b.ateValor - a.ateValor)[0] : { percentual: 0 });

                        const percentualComissao = faixa ? faixa.percentual : 0;
                        const valorComissao = totalReceitas * percentualComissao;

                        funcionarios.forEach(f => {
                            const jaLancado = filteredGastos.some(g => (g.description || "").includes(`Salário: ${f.nome}`));
                            if (!jaLancado) {
                                const totalSalario = (parseFloat(f.salarioFixo) || 0) + (parseFloat(f.va) || 0) + (parseFloat(f.vt) || 0) + valorComissao;
                                totalPendentes += totalSalario;
                                pendingDetails.push({ id: f.id, description: `Salário: ${f.nome}`, amount: totalSalario, type: 'salary' });
                            }
                        });
                    }

                    return {
                        currentMonth,
                        formattedMonth,
                        totalReceitas,
                        totalGastosGerais: totalDespesas,
                        totalDespesas,
                        totalPendentes,
                        saldo,
                        contasFixasStatus,
                        pendingDetails
                    };

                } catch (err) {
                    console.error("Erro ao carregar dados financeiros da API:", err);
                    return { error: "Erro ao carregar dados do servidor." };
                }
            }

            /**
             * Atualiza o widget do dashboard e pré-carrega o modal com dados.
             */
            /**
             * Atualiza o widget do dashboard e pré-carrega o modal com dados.
             * Sincronizado com o estilo do Sistema Financeiro.
             */
            async function loadFinancialSummary() {
                const data = await getFinancialData();
                loadedFinancialData = data; // Armazena em cache para o modal

                if (data.error) {
                    financeWidgetLoading.innerHTML = `<p class="text-gray-500">${data.error}</p>`;
                    financeWidgetLoading.classList.remove('hidden');
                    financeWidgetContent.classList.add('hidden');
                    return;
                }

                // Elementos de comparação/detalhes
                const recComp = document.getElementById('receitas-comparison');
                const despComp = document.getElementById('despesas-comparison');
                const saldoComp = document.getElementById('saldo-comparison');

                // Atualiza o widget no dashboard
                financeWidgetReceitas.textContent = formatarMoeda(data.totalReceitas);
                financeWidgetDespesas.textContent = formatarMoeda(data.totalDespesas);

                const saldoEl = financeWidgetSaldo;
                saldoEl.textContent = formatarMoeda(data.saldo);
                saldoEl.className = `text-3xl font-extrabold ${data.saldo >= 0 ? 'text-blue-600' : 'text-red-600'} tracking-tight`;

                financeWidgetMonth.textContent = data.formattedMonth;

                // Pendentes (replicando estilo do Sistema Financeiro)
                if (despComp && data.totalPendentes > 0) {
                    despComp.innerHTML = `<div class="mt-4 p-3 bg-amber-50 rounded-xl border border-amber-200 flex flex-col gap-2 text-amber-800 animate-bounce-subtle">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left mr-1"></i> Gastos Pendentes:</span>
                            <span class="font-bold text-sm">${formatarMoeda(data.totalPendentes)}</span>
                        </div>
                        <button onclick="window.showPendingDetailsModal()" class="text-[10px] text-amber-600 hover:text-amber-700 font-bold underline text-right transition-colors">
                            <i class="fa-solid fa-list-check mr-1"></i> Ver detalhes
                        </button>
                    </div>`;
                } else if (despComp) {
                    despComp.innerHTML = '<span class="text-emerald-600 font-medium text-[11px]"><i class="fa-solid fa-check-circle mr-1"></i> Tudo em dia</span>';
                }

                if (recComp) recComp.innerHTML = '<span class="text-gray-400 text-[11px]">Total acumulado no mês</span>';
                if (saldoComp) {
                    saldoComp.innerHTML = data.saldo >= 0 ?
                        '<span class="text-emerald-600 font-medium text-[11px]"><i class="fa-solid fa-arrow-up mr-1"></i> Balanço Positivo</span>' :
                        '<span class="text-red-600 font-medium text-[11px]"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Atenção ao Saldo</span>';
                }

                financeWidgetLoading.classList.add('hidden');
                financeWidgetContent.classList.remove('hidden');

                // Pré-preenche os dados do modal legado (opcional)
                if (financeModalMonth1) financeModalMonth1.textContent = data.formattedMonth;
                if (financeModalMonth2) financeModalMonth2.textContent = data.formattedMonth;
                if (financeModalMonth3) financeModalMonth3.textContent = data.formattedMonth;

                if (financeModalReceitas) financeModalReceitas.textContent = formatarMoeda(data.totalReceitas);
                if (financeModalDespesas) financeModalDespesas.textContent = formatarMoeda(data.totalDespesas);
                if (financeModalPendentes) financeModalPendentes.textContent = formatarMoeda(data.totalPendentes);
                if (financeModalSaldo) financeModalSaldo.textContent = formatarMoeda(data.saldo);

                if (financeModalContasTbody) {
                    financeModalContasTbody.innerHTML = data.contasFixasStatus.map(cf => {
                        const statusClass = cf.isPaid ? 'text-green-600 font-semibold' : 'text-yellow-600';
                        return `<tr>
                                    <td class="px-4 py-3">${cf.descricao}</td>
                                    <td class="px-4 py-3">${formatarMoeda(cf.valor)}</td>
                                    <td class="px-4 py-3">${cf.vencimento}</td>
                                    <td class="px-4 py-3 ${statusClass}">${cf.status}</td>
                                </tr>`;
                    }).join('');
                    if (data.contasFixasStatus.length === 0) {
                        financeModalContasTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhuma conta fixa cadastrada.</td></tr>';
                    }
                }
            }

            /**
             * Abre o modal de detalhes de gastos pendentes.
             * Sync com a lógica do Sistema Financeiro.
             */
            window.showPendingDetailsModal = function () {
                const data = loadedFinancialData;
                if (!data || !data.pendingDetails) return;

                const list = document.getElementById('pending-details-list');
                const totalEl = document.getElementById('pending-details-total');
                const modal = document.getElementById('modal-detalhes-pendentes');

                if (!list || !modal) return;

                list.innerHTML = data.pendingDetails.map(item => {
                    let icon = 'fa-file-invoice-dollar';
                    let bgColor = 'bg-gray-100';
                    let textColor = 'text-gray-600';

                    if (item.type === 'fixed') { icon = 'fa-calendar-day'; bgColor = 'bg-blue-50'; textColor = 'text-blue-600'; }
                    else if (item.type === 'monitor') { icon = 'fa-person-running'; bgColor = 'bg-emerald-50'; textColor = 'text-emerald-600'; }
                    else if (item.type === 'salary') { icon = 'fa-user-tie'; bgColor = 'bg-indigo-50'; textColor = 'text-indigo-600'; }

                    return `<div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-2xl shadow-sm hover:border-amber-200 transition-all group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 ${bgColor} ${textColor} rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${item.description}</p>
                                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">${item.type === 'fixed' ? 'Conta Fixa' : item.type === 'monitor' ? 'Monitor' : 'Funcionário'}</p>
                            </div>
                        </div>
                        <p class="font-extrabold text-gray-900">${formatarMoeda(item.amount)}</p>
                    </div>`;
                }).join('');

                totalEl.textContent = formatarMoeda(data.totalPendentes);
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            window.closePendingDetailsModal = function () {
                const modal = document.getElementById('modal-detalhes-pendentes');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            };

            /**
             * Renderiza os gráficos dentro do modal financeiro.
             */
            function renderFinancialCharts(data) {
                if (!data || data.error) return;

                // Gráfico 1: Receita vs. Despesa
                const ctx1 = document.getElementById('finance-chart-receita-despesa').getContext('2d');
                if (financeChart1) financeChart1.destroy();
                financeChart1 = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Receitas', 'Despesas'],
                        datasets: [{
                            data: [data.totalReceitas, data.totalDespesas],
                            backgroundColor: ['#10b981', '#ef4444'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                // Gráfico 2: Composição das Despesas
                const ctx2 = document.getElementById('finance-chart-despesa-comp').getContext('2d');
                if (financeChart2) financeChart2.destroy();
                financeChart2 = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Gastos Gerais/Compras', 'Pagamentos Monitores'],
                        datasets: [{
                            data: [data.totalGastosGerais, data.totalPagamentosMonitores],
                            backgroundColor: ['#f97316', '#8b5cf6'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            /**
             * Controla a troca de abas no modal financeiro.
             */
            function switchFinanceTab(tabNumber) {
                financeTabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `finance-content-${tabNumber}`);
                });
                financeTabBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabNumber);
                });

                if (tabNumber === '2') {
                    // Renderiza os gráficos apenas quando a aba é aberta
                    // Usamos um pequeno timeout para garantir que o canvas esteja visível
                    setTimeout(() => renderFinancialCharts(loadedFinancialData), 50);
                }
            }

            // O widget financeiro agora encaminha diretamente para o Sistema Gestão Financeira.html
            // a lógica de modal interno foi desativada conforme solicitação.
            if (financeCloseBtn) {
                financeCloseBtn.addEventListener('click', () => {
                    financeModal.classList.add('hidden');
                });
            }
            if (financeTabBtns) {
                financeTabBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        switchFinanceTab(e.currentTarget.dataset.tab);
                    });
                });
            }

            // --- FIM DA LÓGICA FINANCEIRA ---


            // --- GEMINI API & LÓGICA DOS MODAIS ---
            const settingsBtn = document.getElementById('settings-btn');
            const apiKeyModal = document.getElementById('api-key-modal');
            const geminiModal = document.getElementById('gemini-modal');
            const geminiChatModal = document.getElementById('gemini-chat-modal'); // [NOVO]

            const showModal = (modalEl) => modalEl.classList.remove('hidden');
            const hideModal = (modalEl) => modalEl.classList.add('hidden');

            const showToast = (message, isError = true) => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                const toastIcon = document.getElementById('toast-icon');
                if (!toast || !toastMessage) return;
                toastMessage.textContent = message;
                toast.classList.toggle('bg-red-600', isError);
                toast.classList.toggle('bg-green-600', !isError);
                if (toastIcon) toastIcon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                toast.classList.remove('hidden');
                toast.classList.add('toast-enter');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('toast-enter');
                }, 5000);
            };

            // Placeholder Animation for API Key
            const animatePlaceholder = () => {
                const input = document.getElementById('api-key-input');
                if (!input) return;
                const text = "Cole sua chave aqui...";
                let i = 0;

                function type() {
                    if (i < text.length) {
                        i++;
                        input.placeholder = text.substring(0, i) + "|";
                        setTimeout(type, 100);
                    } else {
                        // Final blink effect
                        let flashes = 0;
                        const interval = setInterval(() => {
                            input.placeholder = text + (flashes % 2 === 0 ? "" : "|");
                            flashes++;
                            if (flashes > 5) {
                                clearInterval(interval);
                                setTimeout(() => {
                                    i = 0;
                                    type();
                                }, 2000);
                            }
                        }, 500);
                    }
                }
                type();
            };
            animatePlaceholder();

            const getApiKey = () => {
                const key = ""; // A chave da API será injetada aqui em produção
                return key || localStorage.getItem('geminiApiKey');
            }

            // --- Configurações da API Key ---
            settingsBtn.addEventListener('click', () => {
                document.getElementById('api-key-input').value = localStorage.getItem('geminiApiKey') || '';
                showModal(apiKeyModal);
            });
            document.getElementById('cancel-api-key-btn').addEventListener('click', () => hideModal(apiKeyModal));
            document.getElementById('save-api-key-btn').addEventListener('click', () => {
                const key = document.getElementById('api-key-input').value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    hideModal(apiKeyModal);
                    showToast("Chave da API salva com sucesso!", false);
                } else {
                    showToast("Por favor, insira uma chave da API.");
                }
            });

            // --- Fechar Modal Gemini ---
            document.getElementById('gemini-close-btn').addEventListener('click', () => hideModal(geminiModal));
            document.getElementById('gemini-chat-close-btn').addEventListener('click', () => hideModal(geminiChatModal)); // [NOVO]

            // --- Função Principal da API Gemini ---
            // [MODIFICADO] para aceitar 'contents' (histórico) OU 'prompt' (string)
            async function callGeminiAPI(input, generationConfig = null) {
                const apiKey = getApiKey();
                if (!apiKey) {
                    showToast("Por favor, configure sua chave de API do Gemini nas configurações.");
                    showModal(apiKeyModal);
                    return null;
                }

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;

                let payload;
                if (typeof input === 'string') {
                    // Se for string (prompt único)
                    payload = {
                        contents: [{ parts: [{ text: input }] }],
                    };
                } else {
                    // Se for array (histórico de chat)
                    payload = {
                        contents: input,
                    };
                }

                if (generationConfig) {
                    payload.generationConfig = generationConfig;
                }

                try {
                    // Implementando retry com backoff exponencial simples
                    let response;
                    let retries = 0;
                    const maxRetries = 3;
                    let delay = 1000; // 1 segundo

                    while (retries < maxRetries) {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Sucesso, sair do loop
                        }

                        // Tratar erros 429 (Too Many Requests) ou 5xx (Server Errors)
                        if (response.status === 429 || response.status >= 500) {
                            retries++;
                            console.log(`API call failed with status ${response.status}. Retrying in ${delay / 1000}s... (${retries}/${maxRetries})`);
                            if (retries >= maxRetries) {
                                throw new Error(`Muitas tentativas (${maxRetries}). A API pode estar sobrecarregada ou indisponível. (Erro: ${response.status})`);
                            }
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Backoff exponencial
                        } else {
                            // Outros erros (ex: 400, 401) não devem ser retentados
                            const errorResult = await response.json();
                            console.error("Erro da API Gemini:", errorResult);
                            const errorMessage = errorResult.error?.message.includes("API key not valid")
                                ? "Sua chave da API é inválida. Verifique nas configurações."
                                : `Erro da API: ${errorResult.error?.message || response.statusText} (Status: ${response.status})`;
                            throw new Error(errorMessage);
                        }
                    }

                    const result = await response.json();
                    // Verifica se há candidatos e conteúdo válido
                    const candidate = result.candidates?.[0];
                    const textResponse = candidate?.content?.parts?.[0]?.text;

                    // Verifica safetyRatings e finishReason
                    if (candidate?.finishReason && candidate.finishReason !== "STOP") {
                        console.warn(`Gemini Finish Reason: ${candidate.finishReason}`, candidate.safetyRatings);
                        throw new Error(`Geração interrompida: ${candidate.finishReason}. Verifique o console para detalhes.`);
                    }

                    if (!textResponse) {
                        console.error("Resposta da API Gemini inválida ou vazia:", result);
                        throw new Error('Resposta da API vazia ou em formato inesperado.');
                    }

                    return textResponse;

                } catch (error) {
                    console.error("Erro ao chamar Gemini API:", error);
                    showToast(`Erro ao contactar a IA: ${error.message}`);
                    return null;
                }
            }

            // --- [MODIFICADO] Evento do Botão "Planejar meu dia" ---
            // A lógica foi movida para uma função separada (handlePlanDayClick)
            // para poder ser re-anexada após a limpeza do plano.

            // --- [NOVO] Função para renderizar o plano (reutilizável) ---
            function renderDailyPlan(plan, targetEl) {
                currentDailyPlan = plan; // [NOVO] Armazena globalmente
                document.getElementById('assistant-initial-state')?.classList.add('hidden');

                const mdToHtml = (str) => str ? str.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : '';

                const html = `
            <div class="animate-fadeIn space-y-8 scrollable-widget">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-black text-slate-800 tracking-tight mb-2">${plan.titulo}</h3>
                    <p class="text-slate-500 text-sm leading-relaxed max-w-lg mx-auto">${plan.introducao}</p>
                </div>

                <div class="flex justify-center">
                    <div class="px-6 py-2 bg-indigo-50 border border-indigo-100 rounded-full text-indigo-600 text-xs font-bold tracking-widest uppercase shadow-sm">
                        "${plan.lema}"
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${plan.prioridades.map(p => `
                        <div class="p-5 glassmorphism rounded-2xl border-l-4 border-indigo-500 transition-all">
                            <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Prioridade ${p.id}</p>
                            <h4 class="font-bold text-slate-800 text-sm mb-2">${mdToHtml(p.nome)}</h4>
                            <p class="text-xs text-slate-500 leading-relaxed">${mdToHtml(p.objetivo)}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="overflow-hidden rounded-2xl border border-slate-200 shadow-sm bg-white/40">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-indigo-50/50 text-indigo-700 font-bold uppercase text-[10px] tracking-widest">
                            <tr>
                                <th class="px-5 py-4">Foco</th>
                                <th class="px-5 py-4">Ação Estratégica</th>
                                <th class="px-5 py-4 text-center">Feito</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${plan.planoDeAcao.map((item, index) => `
                                <tr class="hover:bg-indigo-50/30 transition-colors">
                                    <td class="px-5 py-4 font-bold text-slate-400 text-[10px] uppercase whitespace-nowrap">${item.categoria}</td>
                                    <td class="px-5 py-4">
                                        <label for="plan-task-${index}" class="flex items-center gap-2 cursor-pointer interactive-task-label text-slate-700 font-medium transition-all" style="${item.completed ? 'text-decoration: line-through; color: var(--text-muted-color)' : ''}">
                                            ${mdToHtml(item.tarefa)}
                                        </label>
                                    </td>
                                    <td class="px-5 py-4 text-center">
                                        <input id="plan-task-${index}" type="checkbox" ${item.completed ? 'checked' : ''} class="h-5 w-5 rounded-lg border-slate-300 text-indigo-600 focus:ring-4 focus:ring-indigo-500/10 interactive-task-checkbox cursor-pointer transition-all">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100 relative overflow-hidden group">
                    <div class="relative z-10">
                        <h4 class="text-xs font-black text-amber-700 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fas fa-lightbulb"></i> Insight do Dia
                        </h4>
                        <p class="text-slate-700 text-sm leading-relaxed font-medium">${mdToHtml(plan.sugestaoRapida)}</p>
                    </div>
                    <i class="fas fa-magic absolute right-[-10px] bottom-[-10px] text-5xl text-amber-500 opacity-10 rotate-[-15deg] group-hover:scale-110 transition-transform"></i>
                </div>

                <div class="space-y-4 pt-6">
                    <div class="flex flex-col gap-3">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Revisão Executiva</label>
                        <textarea 
                            id="plan-review-textarea"
                            class="w-full p-5 rounded-2xl bg-white border border-slate-200 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none text-slate-700 text-sm font-medium" 
                            rows="4"
                            placeholder="Como foi o dia de hoje? Quais foram os desafios?"
                        >${plan.review || ''}</textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="analyze-review-btn" class="gemini-btn py-4 px-6 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-lg">
                            <i class="fas fa-brain mr-2"></i> Analisar Resultados
                        </button>
                        <button id="check-forgotten-btn" class="bg-slate-800 text-white font-bold py-4 px-6 rounded-2xl text-xs uppercase tracking-widest hover:bg-slate-900 transition-all">
                            <i class="fas fa-question mr-2"></i> Insights Ocultos?
                        </button>
                        <button id="plan-copy-btn" class="bg-white text-slate-700 border border-slate-200 font-bold py-4 px-6 rounded-2xl text-xs uppercase tracking-widest hover:bg-slate-50 transition-all">
                            <i class="fas fa-copy mr-2"></i> Copiar Plano
                        </button>
                        <button id="plan-reload-btn" class="bg-indigo-600 text-white font-bold py-4 px-6 rounded-2xl text-xs uppercase tracking-widest hover:bg-indigo-700 transition-all">
                            <i class="fas fa-sync-alt mr-2"></i> Atualizar Plano
                        </button>
                        <button id="plan-history-btn-inner" class="bg-slate-100 text-slate-600 font-bold py-4 px-6 rounded-2xl text-xs uppercase tracking-widest hover:bg-slate-200 transition-all sm:col-span-2">
                            <i class="fas fa-history mr-2"></i> Ver Histórico Completo
                        </button>
                    </div>
                </div>
            </div>
        `;

                targetEl.innerHTML = html;

                // Adicionar interatividade aos checkboxes recém-criados
                targetEl.querySelectorAll('.interactive-task-checkbox').forEach((checkbox, index) => {
                    checkbox.addEventListener('change', async (e) => {
                        const isChecked = e.target.checked;
                        const label = e.target.closest('tr').querySelector('.interactive-task-label');

                        // Atualiza UI
                        if (isChecked) {
                            label.style.textDecoration = 'line-through';
                            label.style.color = 'var(--text-muted-color)';
                        } else {
                            label.style.textDecoration = 'none';
                            label.style.color = 'var(--text-color)';
                        }

                        // [NOVO] Atualiza o objeto do plano e salva na nuvem
                        plan.planoDeAcao[index].completed = isChecked;
                        const todayISO = new Date().toISOString().split('T')[0];
                        try {
                            await api.salvarPlanoDiario(todayISO, plan);
                            console.log("✅ Estado da tarefa salvo!");
                        } catch (err) {
                            console.error("❌ Erro ao salvar estado da tarefa:", err);
                        }
                    });
                });

                // [NOVO] Adicionar listener para salvar a revisão do dia
                const reviewTextarea = targetEl.querySelector('#plan-review-textarea');
                if (reviewTextarea) {
                    reviewTextarea.addEventListener('input', async (e) => {
                        const todayISO = new Date().toISOString().split('T')[0];
                        
                        // Atualiza o objeto do plano e salva na nuvem
                        plan.review = e.target.value;
                        try {
                            await api.salvarPlanoDiario(todayISO, plan);
                        } catch (err) {
                            console.error("❌ Erro ao salvar revisão:", err);
                        }
                    });
                }
            }

            // --- [NOVO] Função para limpar o plano e restaurar o botão ---
            function clearDailyPlan() {
                // [MODIFICADO] Apenas limpa a área do plano e mostra o botão "Planejar"
                const planContainer = document.getElementById('plan-display-area');
                if (planContainer) {
                    planContainer.innerHTML = ''; // Limpa a área de exibição
                }

                const planButton = document.getElementById('plan-day-btn');
                if (planButton) {
                    planButton.style.display = 'block'; // Mostra o botão de planejar
                }

                // [MODIFICADO] Mostra o texto de prompt inicial
                document.getElementById('assistant-prompt-text')?.classList.remove('hidden');
            }

            // --- [NOVO] Função extraída do listener para gerar o plano ---
            async function handlePlanDayClick(e) {
                const btn = e.currentTarget;
                // [MODIFICADO] Esconde o botão "Planejar"
                btn.style.display = 'none';

                // [MODIFICADO] Define a área de exibição do plano como alvo
                const planContainer = document.getElementById('plan-display-area');

                planContainer.innerHTML = '<div class="flex justify-center items-center py-10"><div class="loader"></div></div>'; // Mostra o loader no novo container

                // [MODIFICADO] Esconde o texto de prompt inicial
                document.getElementById('assistant-prompt-text')?.classList.add('hidden');

                const today = new Date();
                const formattedDate = today.toLocaleDateString('pt-BR', { dateStyle: 'full' });
                const todayISO = today.toISOString().split('T')[0];

                // Pega eventos da API
                const eventsTodayRaw = await api.getEventos();
                const eventsToday = eventsTodayRaw
                    .filter(event => event.date === todayISO)
                    .map(event => event.clientName);

                // Pega tarefas do estado local
                const tasksToday = taskState.tasks
                    .filter(task => (task.dueDate === todayISO || !task.dueDate) && !task.completed) // Pega tarefas de hoje E tarefas gerais (sem data)
                    .map(task => task.text);

                currentContext = {
                    events: eventsToday,
                    tasks: tasksToday,
                    date: formattedDate
                };

                const prompt = `
        Aja como um assistente pessoal para Leandro, dono de uma empresa de festas.
        Hoje é ${currentContext.date}.
        Os eventos agendados para hoje são: ${currentContext.events.length > 0 ? currentContext.events.join(', ') : 'Nenhum evento agendado.'}
        As tarefas pendentes (de hoje e gerais) são: ${currentContext.tasks.length > 0 ? currentContext.tasks.join(', ') : 'Nenhuma tarefa pendente.'}

        Gere um "Plano de Ação Diário" para o Leandro. O resultado DEVE ser um objeto JSON, seguindo o schema fornecido.

        Instruções importantes:
        1.  Baseie as prioridades e o plano de ação nos eventos e tarefas fornecidos.
        2.  Categorize as tarefas de forma inteligente (ex: Operacional/Logística, Administrativo/Financeiro, Vendas, Marketing).
        3.  Se houver eventos, a logística deve ser alta prioridade.
        4.  Se não houver tarefas ou eventos, crie um plano focado em prospecção ou manutenção.
        5.  O JSON deve ser válido. Não inclua markdown ou qualquer texto fora do objeto JSON.
        `;

                const planSchemaConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "titulo": { "type": "STRING" },
                            "introducao": { "type": "STRING" },
                            "lema": { "type": "STRING" },
                            "prioridades": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "id": { "type": "STRING" },
                                        "nome": { "type": "STRING" },
                                        "objetivo": { "type": "STRING" }
                                    },
                                    "required": ["id", "nome", "objetivo"]
                                }
                            },
                            "planoDeAcao": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "categoria": { "type": "STRING" },
                                        "tarefa": { "type": "STRING" }
                                    },
                                    "required": ["categoria", "tarefa"]
                                }
                            },
                            "sugestaoRapida": { "type": "STRING" }
                        },
                        "required": ["titulo", "introducao", "lema", "prioridades", "planoDeAcao", "sugestaoRapida"]
                    }
                };

                const response = await callGeminiAPI(prompt, planSchemaConfig);

                if (response) {
                    try {
                        const plan = JSON.parse(response);

                        // [MODIFICADO] Salva na Nuvem
                        await api.salvarPlanoDiario(todayISO, plan);

                        // [NOVO] Limpa chaves locais antigas
                        localStorage.removeItem('dailyPlanHistory_v1');
                        localStorage.removeItem('dailyPlan_v1');
                        localStorage.removeItem('dailyPlanDate_v1');

                        // [NOVO] Chama a função de renderização no container correto
                        renderDailyPlan(plan, planContainer);

                    } catch (err) {
                        console.error("Erro ao parsear JSON do plano:", err);
                        console.error("Resposta recebida:", response);
                        clearDailyPlan(); // Limpa e restaura o botão
                        showToast("Erro ao processar o plano do dia.");
                    }
                } else {
                    clearDailyPlan(); // Limpa e restaura o botão
                    showToast("Não foi possível gerar o plano do dia.");
                }
            }

            // Anexa o handler ao botão inicial
            document.getElementById('plan-day-btn').addEventListener('click', handlePlanDayClick);

            // --- Evento do Botão "Quebrar Tarefa" ---
            document.getElementById('breakdown-task-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const input = document.getElementById('new-task-input');
                const mainTask = input.value.trim();

                if (!mainTask) {
                    showToast("Digite uma tarefa para quebrar em subtarefas.");
                    return;
                }

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                const prompt = `Divida a tarefa principal "${mainTask}" em 3 a 5 subtarefas acionáveis. Responda apenas com um array JSON de strings, como ["Subtarefa 1", "Subtarefa 2"].`;

                // [MODIFICADO] Define o schema config
                const subtaskSchemaConfig = {
                    responseMimeType: "application/json"
                };

                // [MODIFICADO] Solicita um JSON passando o schema config
                const response = await callGeminiAPI(prompt, subtaskSchemaConfig);

                document.getElementById('gemini-modal-title').textContent = "✨ Dividir Tarefa";
                const contentEl = document.getElementById('gemini-modal-content');
                const footerEl = document.getElementById('gemini-modal-footer');

                if (response) {
                    try {
                        const subtasks = JSON.parse(response);
                        contentEl.innerHTML = `
                    <p class="mb-4">Selecione as subtarefas que deseja adicionar:</p>
                    <div id="subtask-list" class="space-y-2">
                        ${subtasks.map((task, index) => `
                            <label class="flex items-center gap-3 p-2 rounded-md" style="background-color: var(--card-bg)">
                                <input type="checkbox" value="${task}" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span>${task}</span>
                            </label>
                        `).join('')}
                    </div>
                    <button id="add-subtasks-btn" class="shiny-btn w-full mt-6 py-2 rounded-md">Adicionar Tarefas SelecionADAS</button>
                `;

                        document.getElementById('add-subtasks-btn').onclick = () => {
                            const selectedTasks = document.querySelectorAll('#subtask-list input:checked');
                            // Usa a data do input (que é controlada pela aba ativa)
                            const date = document.getElementById('new-task-date').value || null;

                            selectedTasks.forEach(checkbox => {
                                addTask(`- ${checkbox.value}`, date);
                            });
                            showToast(`${selectedTasks.length} subtarefas adicionadas!`, false);
                            hideModal(geminiModal);
                            input.value = '';
                        };

                    } catch (err) {
                        console.error("Erro ao parsear JSON:", err);
                        contentEl.innerHTML = `<p>Ocorreu um erro ao processar as subtarefas. Tente novamente.</p><p class="text-xs mt-2 text-gray-400">${response}</p>`;
                    }
                } else {
                    contentEl.innerHTML = '<p>Não foi possível gerar as subtarefas.</p>';
                }

                footerEl.classList.add('hidden'); // Não precisa copiar no "Quebrar Tarefa"
                showModal(geminiModal); // Este ainda usa o modal principal

                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i>';
                btn.disabled = false;
            });

            // --- Evento do Botão "Copiar Texto" (do modal "Quebrar Tarefa") ---
            document.getElementById('gemini-copy-btn').addEventListener('click', () => {
                // Copia o texto puro, sem HTML
                const textToCopy = document.getElementById('gemini-modal-content').innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Texto copiado!', false);
                });
            });

            // --- [NOVA] Lógica do Chat IA ---

            const chatMessagesEl = document.getElementById('gemini-chat-messages');
            const chatForm = document.getElementById('gemini-chat-form');
            const chatInput = document.getElementById('gemini-chat-input');
            const chatSendBtn = document.getElementById('gemini-chat-send-btn');
            const chatModalTitle = document.getElementById('gemini-chat-title'); // [NOVO]

            // Adiciona mensagens ao modal de chat
            function addChatMessage(message, sender = 'ia') {
                const messageEl = document.createElement('div');
                messageEl.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'break-words'); // Adicionado break-words

                // Converte markdown simples (negrito, listas) para HTML
                let htmlMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Trata listas
                htmlMessage = htmlMessage.replace(/^\s*-\s(.*?)$/gm, '<li class="ml-4">$1</li>'); // Converte '- item' para '<li>item</li>'
                htmlMessage = htmlMessage.replace(/<li>/g, '<ul class="list-disc pl-5"><li>'); // Adiciona <ul> wrapper start
                htmlMessage = htmlMessage.replace(/<\/li>(?!<li)/g, '</li></ul>'); // Adiciona </ul> wrapper end


                if (sender === 'user') {
                    messageEl.classList.add('bg-indigo-500', 'text-white', 'self-end', 'ml-auto');
                    messageEl.innerHTML = htmlMessage;
                } else {
                    messageEl.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto');
                    if (message === '...') {
                        messageEl.innerHTML = '<div class="loader w-5 h-5 border-2 border-indigo-500 border-t-transparent"></div>';
                    } else {
                        messageEl.innerHTML = htmlMessage;
                    }
                }
                chatMessagesEl.appendChild(messageEl);
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; // Auto-scroll
                return messageEl;
            }

            // [NOVO] Adiciona uma lista de sugestões com botões
            function addChatSuggestions(introduction, suggestions) {
                const containerEl = document.createElement('div');
                containerEl.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto', 'w-full'); // w-full para botões alinharem

                let html = `<p class="font-semibold">${introduction}</p>`;
                html += '<ul class="list-none space-y-2 mt-2">';

                suggestions.forEach((taskText, index) => {
                    // Escapa aspas no atributo de dados
                    const escapedTaskText = taskText.replace(/"/g, '&quot;');
                    html += `
                <li class="flex items-center justify-between gap-2">
                    <span class="flex-grow break-words">- ${taskText}</span>
                    <button 
                        class="add-suggestion-btn bg-indigo-500 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-indigo-600 transition-colors flex-shrink-0"
                        data-task-text="${escapedTaskText}"
                    >
                        + Add
                    </button>
                </li>
            `;
                });
                html += '</ul>';

                containerEl.innerHTML = html;
                chatMessagesEl.appendChild(containerEl);
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; // Auto-scroll
                return containerEl;
            }


            // [MODIFICADO] Abre o chat E copia o texto (listeners delegados ao <body>)
            // Movido de '#widget-assistant' para 'document.body' para garantir que os cliques sejam capturados.
            document.body.addEventListener('click', async (e) => {
                // Listener para o botão "Estou esquecendo de algo?"
                if (e.target.id === 'check-forgotten-btn' || e.target.closest('#check-forgotten-btn')) {
                    // [MODIFICADO] Define o título do modal
                    chatModalTitle.innerHTML = '<i class="fas fa-lightbulb mr-2 text-yellow-400"></i> Estou esquecendo de algo?';

                    chatMessagesEl.innerHTML = ''; // Limpa a tela
                    showModal(geminiChatModal); // Abre o modal de chat (z-50)

                    const loadingEl = addChatMessage('...');

                    // [NOVO] Regenera o contexto para garantir que está atualizado
                    const today = new Date();
                    const formattedDate = today.toLocaleDateString('pt-BR', { dateStyle: 'full' });
                    const todayISO = today.toISOString().split('T')[0];
                    const eventsTodayRaw = await api.getEventos();
                    const eventsToday = eventsTodayRaw.filter(event => event.date === todayISO).map(event => event.clientName);
                    const tasksToday = taskState.tasks.filter(task => (task.dueDate === todayISO || !task.dueDate) && !task.completed).map(task => task.text);

                    currentContext = { events: eventsToday, tasks: tasksToday, date: formattedDate };
                    // Fim da regeneração de contexto

                    const prompt = `
            Contexto: Hoje é ${currentContext.date}. Leandro (dono de empresa de festas) tem estes eventos: [${currentContext.events.join(', ')}] e estas tarefas: [${currentContext.tasks.join(', ')}].
            
            Pergunta: Com base nesse contexto, o que mais o Leandro pode estar esquecendo? Pense em logística, comunicação com cliente, pagamentos pendentes, preparação de equipe, ou materiais.
            
            Responda com um objeto JSON no formato:
            {
              "introducao": "Analisando seu dia, talvez você deva checar:",
              "sugestoes": ["Sugestão 1", "Sugestão 2", "Sugestão 3"]
            }
            Onde "sugestoes" é um array de strings (máximo 3) das tarefas que ele pode estar esquecendo.
            Se não houver sugestões óbvias, retorne um array vazio.
            `;

                    // [MODIFICADO] Inicia o histórico
                    chatHistory = [
                        {
                            role: 'user',
                            parts: [{
                                text: `Contexto: Hoje é ${currentContext.date}. Eventos: [${currentContext.events.join(', ')}]. Tarefas: [${currentContext.tasks.join(', ')}].`
                            }]
                        },
                        {
                            role: 'model',
                            parts: [{
                                text: "Contexto entendido. O que devo fazer?"
                            }]
                        }
                    ];
                    // Adiciona a pergunta real como um turno separado
                    chatHistory.push({ role: 'user', parts: [{ text: prompt }] });

                    // [MODIFICADO] Adiciona generationConfig para JSON
                    const jsonConfig = { responseMimeType: "application/json" };

                    const response = await callGeminiAPI(chatHistory, jsonConfig); // Passa o config

                    if (response) {
                        loadingEl.remove(); // Remove o loader
                        try {
                            const data = JSON.parse(response);
                            if (data.introducao && data.sugestoes) {
                                if (data.sugestoes.length > 0) {
                                    addChatSuggestions(data.introducao, data.sugestoes);
                                } else {
                                    addChatMessage("Analisando seu dia, parece que você cobriu todos os pontos principais. Bom trabalho!", 'ia');
                                }
                                // Salva a resposta da IA no histórico
                                chatHistory.push({ role: 'model', parts: [{ text: response }] });
                            } else {
                                throw new Error("Formato JSON inesperado.");
                            }
                        } catch (err) {
                            console.error("Erro ao parsear sugestões JSON:", err);
                            console.error("Resposta recebida:", response);
                            addChatMessage("Não consegui verificar (erro de formato). Tente novamente.", 'ia');
                            chatHistory.pop(); // Remove o prompt com falha
                        }
                    } else {
                        loadingEl.innerHTML = "Não consegui verificar. Tente novamente.";
                        chatHistory.pop(); // Remove o prompt com falha
                    }
                }

                // [NOVO] Listener para o botão "Atualizar Plano"
                if (e.target.id === 'plan-reload-btn' || e.target.closest('#plan-reload-btn')) {
                    if (confirm("Deseja gerar um NOVO plano diário com base nas tarefas atuais? O plano de hoje será substituído.")) {
                        handlePlanDayClick({ currentTarget: document.getElementById('plan-day-btn') });
                    }
                }

                // [NOVO] Listener para o botão "Ver Histórico" (dentro do plano)
                if (e.target.id === 'plan-history-btn-inner' || e.target.closest('#plan-history-btn-inner')) {
                    const globalHistoryBtn = document.getElementById('view-plan-history-btn');
                    if (globalHistoryBtn) {
                        globalHistoryBtn.click();
                    }
                }

                // [NOVO] Listener para o botão "Copiar Plano"
                if (e.target.id === 'plan-copy-btn' || e.target.closest('#plan-copy-btn')) {
                    const planArea = document.getElementById('plan-display-area');
                    if (planArea) {
                        const text = planArea.innerText;
                        navigator.clipboard.writeText(text).then(() => {
                            showToast('Plano copiado para a área de transferência!', false);
                        });
                    }
                }

                // [NOVO] Listener para o botão "Ver Histórico"
                if (e.target.id === 'view-plan-history-btn' || e.target.closest('#view-plan-history-btn')) {
                    const history = await api.getDailyPlanHistory(); // [MODIFICADO] Pega da nuvem
                    const dates = Object.keys(history).sort().reverse(); // Mais recentes primeiro

                    const modalTitle = document.getElementById('gemini-modal-title');
                    const modalContent = document.getElementById('gemini-modal-content');
                    const modalFooter = document.getElementById('gemini-modal-footer');

                    modalTitle.textContent = "📜 Histórico de Planos Diários";

                    if (dates.length === 0) {
                        modalContent.innerHTML = '<p>Nenhum plano salvo encontrado no histórico.</p>';
                        modalFooter.classList.add('hidden');
                    } else {
                        // Criar um <select> para navegar pelos dias
                        const dateOptions = dates.map(date => {
                            const d = new Date(date + 'T00:00:00');
                            const formatted = d.toLocaleDateString('pt-BR', { dateStyle: 'full' });
                            return `<option value="${date}">${formatted}</option>`;
                        }).join('');

                        modalContent.innerHTML = `
                    <div class="mb-4">
                        <label for="history-date-select" class="block text-sm font-medium mb-1">Selecione um dia:</label>
                        <select id="history-date-select" class="form-input w-full">
                            ${dateOptions}
                        </select>
                    </div>
                    <!-- [NOVO] Botão de Análise de Desempenho -->
                    <button id="analyze-history-btn" class="gemini-btn w-full text-sm py-2 px-4 rounded-lg my-4">
                        <i class="fas fa-chart-line mr-2"></i> Analisar meu desempenho geral
                    </button>
                    <!-- Fim do Botão de Análise -->
                    <div id="history-plan-content" class="prose prose-sm max-w-none mt-4" style="color: var(--text-color)">
                        <!-- O plano será carregado aqui -->
                    </div>
                `;

                        // [INÍCIO DA CORREÇÃO - CÓDIGO RESTAURADO]
                        const selectEl = modalContent.querySelector('#history-date-select');
                        const planContentEl = modalContent.querySelector('#history-plan-content');

                        // Função para carregar o plano selecionado
                        const loadPlanForDate = (date) => {
                            const plan = history[date];
                            if (!plan) {
                                planContentEl.innerHTML = '<p>Erro ao carregar plano.</p>';
                                return;
                            }

                            // Reutiliza a lógica de formatação (simplificada)
                            const mdToHtml = (str) => str ? str.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : '';

                            planContentEl.innerHTML = `
                        <h2 class="text-2xl font-bold">${plan.titulo}</h2>
                        <p>${mdToHtml(plan.introducao)}</p>
                        <blockquote class="border-l-4 border-indigo-400 pl-4 py-2 my-4 italic">
                            <strong>Lema:</strong> "${plan.lema}"
                        </blockquote>
                        
                        <h3 class="text-xl font-semibold">Prioridades</h3>
                        <ul class="list-disc pl-5">
                            ${plan.prioridades.map(p => `<li><strong>${p.id}: ${mdToHtml(p.nome)}</strong> - ${mdToHtml(p.objetivo)}</li>`).join('')}
                        </ul>
                        
                        <h3 class="text-xl font-semibold">Plano de Ação</h3>
                        <ul class="list-disc pl-5">
                            ${plan.planoDeAcao.map(item => `<li><strong>${item.categoria}:</strong> ${mdToHtml(item.tarefa)}</li>`).join('')}
                        </ul>

                        <h3 class="text-xl font-semibold">Sugestão Rápida</h3>
                        <p>${mdToHtml(plan.sugestaoRapida)}</p>
                        
                        <h3 class="text-xl font-semibold mt-6">Revisão do Dia</h3>
                        <p class="border p-3 rounded-md" style="background-color: var(--input-bg)">
                            ${plan.review ? plan.review.replace(/\n/g, '<br>') : '<i>Nenhuma revisão registrada.</i>'}
                        </p>
                    `;
                        };

                        // Adiciona o listener para o <select>
                        selectEl.addEventListener('change', (e) => {
                            loadPlanForDate(e.target.value);
                        });

                        // Carrega o primeiro plano (o mais recente) por padrão
                        loadPlanForDate(dates[0]);

                        modalFooter.classList.remove('hidden'); // Mostra o footer (com botão de copiar)
                    }

                    showModal(geminiModal); // Usa o modal genérico
                }
                // [FIM DA CORREÇÃO]

                // [NOVO] Listener para o botão "O que poderia ter sido melhor?"
                if (e.target.id === 'analyze-review-btn' || e.target.closest('#analyze-review-btn')) {
                    // [MODIFICADO] Define o título do modal
                    chatModalTitle.innerHTML = '<i class="fas fa-search-plus mr-2 text-blue-400"></i> O que poderia ter sido melhor?';

                    const plan = currentDailyPlan; // [MODIFICADO] Usa a variável global
                    const reviewText = document.getElementById('plan-review-textarea')?.value || '';

                    if (!plan) {
                        showToast("Nenhum plano para hoje encontrado.");
                        return;
                    }

                    if (!reviewText.trim()) {
                        showToast("Por favor, escreva sua revisão do dia primeiro.");
                        return;
                    }

                    chatMessagesEl.innerHTML = ''; // Limpa a tela
                    showModal(geminiChatModal); // Abre o modal de chat
                    const loadingEl = addChatMessage('...');

                    const planContext = JSON.stringify(plan.planoDeAcao); // Envia só o plano de ação
                    const reviewContext = reviewText;

                    const prompt = `
            Contexto do Plano do Dia: ${planContext}
            Revisão do Usuário: "${reviewContext}"

            Pergunta: Aja como um coach de produtividade. Com base no plano de ação e na revisão do usuário, forneça um feedback construtivo (máximo 2-3 parágrafos).
            1.  Identifique pontos positivos (o que parece ter dado certo).
            2.  Identifique o que poderia ter sido melhor, sugerindo a causa raiz (ex: "Parece que as tarefas administrativas tomaram mais tempo que o esperado").
            3.  Faça uma sugestão acionável para amanhã.
            Responda em markdown.
            `;

                    chatHistory = [
                        { role: 'user', parts: [{ text: prompt }] }
                    ];

                    const response = await callGeminiAPI(chatHistory);

                    if (response) {
                        loadingEl.remove();
                        addChatMessage(response, 'ia');
                        chatHistory.push({ role: 'model', parts: [{ text: response }] });
                    } else {
                        loadingEl.innerHTML = "Não consegui analisar. Tente novamente.";
                    }
                }

                // [NOVO] Listener para o botão "Analisar desempenho" (do Histórico)
                if (e.target.id === 'analyze-history-btn' || e.target.closest('#analyze-history-btn')) {
                    // [MODIFICADO] Define o título do modal
                    chatModalTitle.innerHTML = '<i class="fas fa-chart-line mr-2 text-green-400"></i> Análise de Desempenho';

                    const history = await api.getDailyPlanHistory(); // [MODIFICADO] Pega da nuvem
                    const dates = Object.keys(history);

                    // [NOVO] Pega o histórico de análises anteriores
                    const analysesHistory = JSON.parse(localStorage.getItem('performanceAnalyses_v1')) || [];
                    const lastAnalysis = analysesHistory.length > 0 ? analysesHistory[analysesHistory.length - 1] : null;


                    if (dates.length < 2) {
                        showToast("É necessário ter pelo menos 2 dias de histórico para uma análise.");
                        return;
                    }

                    // Prepara o contexto para a IA
                    const summarizedHistory = dates.sort().map(date => {
                        const plan = history[date];
                        return {
                            data: date,
                            prioridades: plan.prioridades.map(p => p.nome),
                            revisao: plan.review || "Nenhuma revisão."
                        };
                    });

                    // Fecha o modal de histórico e abre o de chat
                    hideModal(geminiModal);
                    chatMessagesEl.innerHTML = '';
                    showModal(geminiChatModal);
                    const loadingEl = addChatMessage('...');

                    // [MODIFICADO] O prompt agora é dinâmico e inclui a análise anterior, se existir
                    let prompt;
                    if (lastAnalysis) {
                        prompt = `
                Contexto: Analise o seguinte histórico de planos diários e revisões de um dono de empresa de festas.
                Histórico de Planos/Revisões: ${JSON.stringify(summarizedHistory)}
                
                Análise Anterior (de ${new Date(lastAnalysis.date).toLocaleDateString('pt-BR')}):
                "${lastAnalysis.analysis}"

                Pergunta: Aja como um analista de desempenho sênior.
                1.  Revise a "Análise Anterior".
                2.  Com base no "Histórico de Planos/Revisões" (especialmente os mais recentes), avalie o progresso feito desde a análise anterior.
                3.  O que foi otimizado com sucesso?
                4.  Quais pontos da análise anterior ainda são problemas recorrentes?
                5.  Quais *novos* padrões ou gargalos surgiram?
                6.  Forneça 2-3 novas sugestões de otimização com base *nesta nova avaliação*.
                Responda em markdown, de forma concisa e acionável. Comece mencionando a análise anterior (ex: "Na nossa última análise...").
                `;
                    } else {
                        // Este é o prompt para a primeira análise
                        prompt = `
                Contexto: Analise o seguinte histórico de planos diários e revisões de um dono de empresa de festas.
                Histórico de Planos/Revisões: ${JSON.stringify(summarizedHistory)}

                Pergunta: Aja como um analista de desempenho. Esta é a *primeira* análise.
                1.  Identifique padrões de sucesso (o que ele faz bem consistentemente?).
                2.  Identifique gargalos ou problemas recorrentes (o que sempre falha ou é difícil?).
                3.  Forneça 2-3 sugestões de otimização de processo para ele melhorar a produtividade geral.
                Responda em markdown, de forma concisa e acionável.
                `;
                    }

                    chatHistory = [
                        { role: 'user', parts: [{ text: prompt }] }
                    ];

                    const response = await callGeminiAPI(chatHistory);

                    if (response) {
                        loadingEl.remove();
                        addChatMessage(response, 'ia');
                        chatHistory.push({ role: 'model', parts: [{ text: response }] });

                        // [NOVO] Salva a nova análise no histórico de análises
                        const newAnalysis = {
                            date: new Date().toISOString(),
                            analysis: response
                        };
                        analysesHistory.push(newAnalysis);
                        localStorage.setItem('performanceAnalyses_v1', JSON.stringify(analysesHistory));

                    } else {
                        loadingEl.innerHTML = "Não consegui analisar. Tente novamente.";
                    }
                }

                // Listener para o botão "Copiar Texto" do plano
                if (e.target.id === 'plan-copy-btn' || e.target.closest('#plan-copy-btn')) {
                    const contentToCopy = e.target.closest('.collapsible-content').querySelector('.prose');
                    if (contentToCopy) {
                        navigator.clipboard.writeText(contentToCopy.innerText).then(() => {
                            showToast('Plano copiado!', false);
                        });
                    }
                }

                // [NOVO] Listener para o botão "Limpar Plano"
                if (e.target.id === 'clear-plan-btn' || e.target.closest('#clear-plan-btn')) {
                    clearDailyPlan();
                }

                // [NOVO] Listener para o botão "+ Add" do chat
                if (e.target.classList.contains('add-suggestion-btn')) {
                    const btn = e.target;
                    const taskText = btn.dataset.taskText;

                    if (taskText) {
                        const todayISO = new Date().toISOString().split('T')[0];

                        // 1. Adiciona à lista de tarefas principal
                        addTask(taskText, todayISO); // Isso já salva e renderiza 'widget-tasks'

                        // 2. Mostra feedback
                        showToast('Tarefa adicionada ao dia de hoje!', false);
                        btn.textContent = '✔️';
                        btn.disabled = true;
                        btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                        btn.classList.add('bg-green-500');

                        // 3. Atualiza o Plano Diário (se existir)
                        const plan = currentDailyPlan; // [MODIFICADO]

                        if (plan) { 
                            try {
                                // Adiciona a nova tarefa ao plano
                                plan.planoDeAcao.push({
                                    categoria: 'Ponta Solta (IA)', 
                                    tarefa: taskText
                                });

                                // Salva na nuvem
                                await api.salvarPlanoDiario(todayISO, plan);
                                
                                // Re-renderiza o plano para mostrar a nova tarefa
                                const planContainer = document.getElementById('plan-display-area');
                                if (planContainer) {
                                    renderDailyPlan(plan, planContainer);
                                }
                            } catch (err) {
                                console.error("Erro ao atualizar o plano diário:", err);
                                showToast("Tarefa adicionada, mas falha ao atualizar o plano.");
                            }
                        }
                    }
                }
            });

            // Envia mensagem do chat
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = chatInput.value.trim();
                if (!userInput) return;

                addChatMessage(userInput, 'user');
                chatHistory.push({ role: 'user', parts: [{ text: userInput }] }); // Add pergunta
                chatInput.value = '';
                chatSendBtn.disabled = true;

                const loadingEl = addChatMessage('...');

                // [MODIFICADO] Envia o histórico
                const response = await callGeminiAPI(chatHistory);

                if (response) {
                    loadingEl.remove();
                    addChatMessage(response, 'ia');
                    chatHistory.push({ role: 'model', parts: [{ text: response }] }); // Add resposta
                } else {
                    loadingEl.innerHTML = "Erro. Tente novamente.";
                    chatHistory.pop(); // Remove a pergunta sem resposta
                }
                chatSendBtn.disabled = false;
            });


            // --- NOVA LÓGICA: MENUS RECOLHÍVEIS ---
            function setupCollapsibleWidgets() {
                const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
                const collapsedState = JSON.parse(localStorage.getItem('collapsedWidgets_v1')) || {};

                collapsibleHeaders.forEach(header => {
                    const widget = header.closest('section, div[id^="widget-"]');
                    const widgetId = widget.id;
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i.fa-chevron-down');

                    // Aplicar estado salvo no carregamento
                    if (widgetId && collapsedState[widgetId]) {
                        content.classList.add('collapsed');
                        icon.classList.add('rotated');
                    }

                    header.addEventListener('click', () => {
                        const isCollapsed = content.classList.toggle('collapsed');
                        icon.classList.toggle('rotated', isCollapsed);

                        // Salvar o estado
                        if (widgetId) {
                            collapsedState[widgetId] = isCollapsed;
                            localStorage.setItem('collapsedWidgets_v1', JSON.stringify(collapsedState));
                        }
                    });
                });
            }

            // --- NOVA LÓGICA: DESCANSO DE TELA ---
            function setupScreensaver() {
                let inactivityTimer;
                const mainContainer = document.getElementById('main-container');
                const screensaverContainer = document.getElementById('screensaver');
                const screensaverClock = document.getElementById('screensaver-clock');
                let clockInterval;

                const showScreensaver = () => {
                    mainContainer.classList.add('opacity-0');
                    screensaverContainer.classList.remove('hidden');
                    screensaverContainer.classList.remove('opacity-0');
                    updateClock();
                    clockInterval = setInterval(updateClock, 1000);
                };

                const hideScreensaver = () => {
                    if (!screensaverContainer.classList.contains('hidden')) {
                        mainContainer.classList.remove('opacity-0');
                        screensaverContainer.classList.add('opacity-0');
                        setTimeout(() => screensaverContainer.classList.add('hidden'), 500);
                        clearInterval(clockInterval);
                    }
                };

                const resetTimer = () => {
                    hideScreensaver();
                    clearTimeout(inactivityTimer);
                    inactivityTimer = setTimeout(showScreensaver, 3 * 60 * 1000); // 3 minutos
                };

                const updateClock = () => {
                    const now = new Date();
                    const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const date = now.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    screensaverClock.innerHTML = `${time}<div class="text-3xl mt-4 capitalize">${date}</div>`;
                };

                ['mousemove', 'keypress', 'mousedown', 'touchstart', 'scroll'].forEach(event => {
                    document.addEventListener(event, resetTimer, false);
                });

                resetTimer(); // Inicia o timer na carga da página
            }

            // --- [NOVO] Função para carregar o plano salvo ---
            async function loadDailyPlan() {
                const todayISO = new Date().toISOString().split('T')[0];

                // [MIGRAÇÃO] Verifica se há histórico local para subir para a nuvem (apenas uma vez)
                const localHistory = JSON.parse(localStorage.getItem('dailyPlanHistory_v1'));
                if (localHistory && Object.keys(localHistory).length > 0) {
                    console.log('🚀 Migrando histórico de planos para a nuvem...');
                    for (const [date, plan] of Object.entries(localHistory)) {
                        await api.salvarPlanoDiario(date, plan);
                    }
                    localStorage.removeItem('dailyPlanHistory_v1');
                    console.log('✅ Migração concluída.');
                }

                // [MODIFICADO] Pega da Nuvem
                const plan = await api.getDailyPlan(todayISO);

                // Se temos um plano salvo E ele é de hoje
                if (plan) {
                    try {
                        const planButton = document.getElementById('plan-day-btn');
                        if (planButton) planButton.style.display = 'none';

                        const planContainer = document.getElementById('plan-display-area');

                        const today = new Date();
                        const formattedDate = today.toLocaleDateString('pt-BR', { dateStyle: 'full' });
                        const eventsTodayRaw = JSON.parse(localStorage.getItem('events')) || [];
                        const eventsToday = eventsTodayRaw.filter(event => event.date === todayISO).map(event => event.clientName);
                        const tasksToday = taskState.tasks.filter(task => (task.dueDate === todayISO || !task.dueDate) && !task.completed).map(task => task.text);

                        currentContext = { events: eventsToday, tasks: tasksToday, date: formattedDate };

                        if (planContainer) {
                            renderDailyPlan(plan, planContainer);
                        } else {
                            clearDailyPlan();
                        }
                    } catch (err) {
                        console.error("Erro ao carregar plano salvo:", err);
                        clearDailyPlan();
                    }
                } else {
                    const planButton = document.getElementById('plan-day-btn');
                    if (planButton) planButton.style.display = 'block';

                    const planContainer = document.getElementById('plan-display-area');
                    if (planContainer) planContainer.innerHTML = '';

                    document.getElementById('assistant-prompt-text')?.classList.remove('hidden');
                }
            }


            // --- Função de Inicialização Principal ---
            async function init() {
                applyTheme();
                setGreeting();
                displayRandomVerse();
                await loadUpcomingEvents();
                await loadRelevantDates();

                // [NOVO] Carrega o resumo financeiro
                loadFinancialSummary();

                await syncTasks(); // Sincroniza tarefas da nuvem
                switchTab('today');

                // [MODIFICADO] Carrega o plano salvo DEPOIS que as tarefas foram carregadas (por switchTab)
                await loadDailyPlan();

                // Inicializar novas funcionalidades
                // Inicializar novas funcionalidades
                setupCollapsibleWidgets();
                setupScreensaver();

                // [PREMIUM] Finaliza o loader e mostra o conteúdo com animação
                const loader = document.getElementById('page-loader');
                const mainContainer = document.getElementById('main-container');
                if (loader && mainContainer) {
                    setTimeout(() => {
                        loader.classList.add('loader-hidden');
                        mainContainer.classList.add('content-ready');
                    }, 500); // Pequeno atraso para garantir o "feeling" lúdico
                }
            }

            init();

            // --- BACKUP: Botão manual + Verificação automática ---
            const backupBtn = document.getElementById('backup-btn');
            const backupIcon = document.getElementById('backup-icon');

            async function downloadBackupJSON() {
                if (!backupBtn) return;
                backupBtn.disabled = true;
                backupIcon.className = 'fas fa-spinner fa-spin text-xl';

                try {
                    const data = await api.getBackupFull();
                    if (!data) throw new Error('Resposta vazia');

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const dateStr = new Date().toISOString().split('T')[0];
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-aero-festas-${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    localStorage.setItem('lastLocalBackup', dateStr);
                    showToast('Backup baixado com sucesso!', false);
                } catch (err) {
                    console.error('Erro backup:', err);
                    showToast('Erro ao baixar backup. Tente novamente.', true);
                } finally {
                    backupBtn.disabled = false;
                    backupIcon.className = 'fas fa-download text-xl';
                }
            }

            backupBtn?.addEventListener('click', downloadBackupJSON);

            // Verificar status do último backup ao carregar
            (async () => {
                try {
                    const status = await api.getBackupStatus();
                    if (status && status.success === false) {
                        showToast(`Erro no backup automático: ${status.message}`, true);
                    } else if (status && status.timestamp) {
                        const lastBackup = new Date(status.timestamp);
                        const hoursAgo = (Date.now() - lastBackup.getTime()) / (1000 * 60 * 60);
                        if (hoursAgo > 48) {
                            showToast('Backup automático desatualizado (mais de 48h).', true);
                        }
                    }
                } catch (e) { /* silencioso */ }
            })();

            // Download local automático (1x por dia ao abrir Dashboard)
            (async () => {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const lastLocal = localStorage.getItem('lastLocalBackup');
                    if (lastLocal !== today) {
                        // Aguarda 5 segundos para não interferir no carregamento
                        await new Promise(r => setTimeout(r, 5000));
                        await downloadBackupJSON();
                    }
                } catch (e) { /* silencioso */ }
            })();

            // --- Lógica das Partículas (Plano de Fundo) ---
            const canvas = document.getElementById('particles-js'); const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particlesArray; let mouse = { x: null, y: null, radius: (canvas.height / 80) * (canvas.width / 80) };
            window.addEventListener('mousemove', (event) => { mouse.x = event.x; mouse.y = event.y; });
            class Particle { constructor(x, y, directionX, directionY, size) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); const particleColor = getComputedStyle(document.documentElement).getPropertyValue('--particle-color-rgb').trim(); ctx.fillStyle = `rgba(${particleColor}, 0.4)`; ctx.fill(); } update() { if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX; if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY; let dx = mouse.x - this.x; let dy = mouse.y - this.y; let distance = Math.sqrt(dx * dx + dy * dy); if (distance < mouse.radius + this.size) { if (mouse.x < this.x && this.x < canvas.width - this.size * 10) this.x += 1; if (mouse.x > this.x && this.x > this.size * 10) this.x -= 1; if (mouse.y < this.y && this.y < canvas.height - this.size * 10) this.y += 1; if (mouse.y > this.y && this.y > this.size * 10) this.y -= 1; } this.x += this.directionX; this.y += this.directionY; this.draw(); } }
            function initParticles() { particlesArray = []; let numberOfParticles = (canvas.height * canvas.width) / 9000; for (let i = 0; i < numberOfParticles; i++) { let size = (Math.random() * 2) + 1; let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2); let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2); let directionX = (Math.random() * .4) - .2; let directionY = (Math.random() * .4) - .2; particlesArray.push(new Particle(x, y, directionX, directionY, size)); } }
            function connectParticles() { let opacityValue = 1; for (let a = 0; a < particlesArray.length; a++) { for (let b = a; b < particlesArray.length; b++) { let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y)); if (distance < (canvas.width / 7) * (canvas.height / 7)) { opacityValue = 1 - (distance / 20000); const particleColor = getComputedStyle(document.documentElement).getPropertyValue('--particle-color-rgb').trim(); ctx.strokeStyle = `rgba(${particleColor}, ${opacityValue * 0.5})`; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke(); } } } }
            function animateParticles() { requestAnimationFrame(animateParticles); ctx.clearRect(0, 0, innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update(); connectParticles(); }
            window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; mouse.radius = ((canvas.height / 80) * (canvas.width / 80)); initParticles(); });
            window.addEventListener('mouseout', () => { mouse.x = undefined; mouse.y = undefined; });

            setTimeout(() => {
                initParticles();
                animateParticles();
            }, 100);
        });
    </script>

    <!-- MODAL: DETALHES PENDENTES (Sync com Sistema Financeiro) -->
    <div id="modal-detalhes-pendentes"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-amber-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center text-amber-600">
                        <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-amber-900">Gastos Pendentes</h3>
                        <p class="text-xs text-amber-700/70">Itens aguardando pagamento ou lançamento</p>
                    </div>
                </div>
                <button onclick="window.closePendingDetailsModal()"
                    class="w-10 h-10 rounded-xl hover:bg-amber-200/50 flex items-center justify-center text-amber-900 transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="pending-details-list" class="space-y-3">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Total Pendente</p>
                    <p id="pending-details-total" class="text-xl font-extrabold text-amber-600">R$ 0,00</p>
                </div>
                <button onclick="window.location.href='Sistema Gestão Financeira.html'"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-2xl font-bold text-sm shadow-lg shadow-indigo-200 transition-all active:scale-95">
                    Ir para Financeiro <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Badge Global -->
    <script src="js/whatsapp-badge.js"></script>

    <!-- Sistema de Autenticação -->
    <script src="js/protect.js"></script>

</body>

</html>