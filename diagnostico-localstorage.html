<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico LocalStorage</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">üîç Diagn√≥stico do LocalStorage</h1>
        
        <div class="mb-6">
            <button onclick="executarDiagnostico()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">
                Executar Diagn√≥stico Completo
            </button>
            <button onclick="copiarDados()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold ml-4">
                Copiar Dados para Clipboard
            </button>
        </div>

        <div id="resultados" class="space-y-4"></div>
    </div>

    <script>
        function executarDiagnostico() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '<div class="p-4 bg-blue-50 rounded-lg">Analisando...</div>';

            const dados = {};
            const todasChaves = Object.keys(localStorage);
            
            // Chaves esperadas
            const chavesEsperadas = ['toys', 'companies', 'events', 'clients', 'crmToyClients_v8', 'financeDataV30', 'dailyPlanHistory_v1'];
            
            // Analisar cada chave
            todasChaves.forEach(chave => {
                try {
                    const valor = localStorage.getItem(chave);
                    if (valor) {
                        try {
                            const parsed = JSON.parse(valor);
                            dados[chave] = {
                                tipo: Array.isArray(parsed) ? 'array' : typeof parsed,
                                tamanho: Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length,
                                valor: parsed,
                                tamanhoBytes: new Blob([valor]).size
                            };
                        } catch (e) {
                            dados[chave] = {
                                tipo: 'string',
                                tamanho: valor.length,
                                valor: valor.substring(0, 100),
                                tamanhoBytes: new Blob([valor]).size,
                                erro: 'N√£o √© JSON v√°lido'
                            };
                        }
                    }
                } catch (e) {
                    dados[chave] = { erro: e.message };
                }
            });

            // Gerar relat√≥rio
            let html = '<div class="space-y-4">';
            
            // Se√ß√£o: Chaves esperadas
            html += '<div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">';
            html += '<h2 class="font-bold text-lg mb-2">üìã Chaves Esperadas do Sistema</h2>';
            chavesEsperadas.forEach(chave => {
                const dado = dados[chave];
                if (dado) {
                    const status = dado.tipo === 'array' && dado.tamanho > 0 ? '‚úÖ' : dado.tipo === 'array' ? '‚ö†Ô∏è' : '‚ùå';
                    html += `<div class="mb-2">
                        <strong>${status} ${chave}:</strong> 
                        ${dado.tipo === 'array' ? `${dado.tamanho} itens` : dado.tipo === 'object' ? `${dado.tamanho} propriedades` : dado.tipo}
                        ${dado.tamanhoBytes ? `(${dado.tamanhoBytes} bytes)` : ''}
                    </div>`;
                } else {
                    html += `<div class="mb-2"><strong>‚ùå ${chave}:</strong> N√£o encontrada</div>`;
                }
            });
            html += '</div>';

            // Se√ß√£o: Todas as chaves
            html += '<div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">';
            html += '<h2 class="font-bold text-lg mb-2">üîë Todas as Chaves no LocalStorage</h2>';
            html += `<div class="text-sm mb-2">Total: ${todasChaves.length} chaves</div>`;
            todasChaves.forEach(chave => {
                const dado = dados[chave];
                if (dado && !chave.startsWith('auth') && !chave.startsWith('gemini')) {
                    html += `<div class="mb-2 p-2 bg-white rounded">
                        <strong>${chave}:</strong> 
                        ${dado.tipo === 'array' ? `${dado.tamanho} itens` : dado.tipo === 'object' ? `${dado.tamanho} propriedades` : dado.tipo}
                        ${dado.tamanhoBytes ? `(${dado.tamanhoBytes} bytes)` : ''}
                        ${dado.erro ? `<span class="text-red-600"> - ${dado.erro}</span>` : ''}
                    </div>`;
                }
            });
            html += '</div>';

            // Se√ß√£o: Dados de exemplo
            html += '<div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">';
            html += '<h2 class="font-bold text-lg mb-2">üìä Amostras de Dados</h2>';
            
            if (dados.toys && dados.toys.tipo === 'array' && dados.toys.valor.length > 0) {
                html += `<div class="mb-4">
                    <strong>Toys (primeiro item):</strong>
                    <pre class="bg-white p-2 rounded text-xs overflow-auto">${JSON.stringify(dados.toys.valor[0], null, 2)}</pre>
                </div>`;
            }
            
            if (dados.events && dados.events.tipo === 'array' && dados.events.valor.length > 0) {
                html += `<div class="mb-4">
                    <strong>Events (primeiro item):</strong>
                    <pre class="bg-white p-2 rounded text-xs overflow-auto">${JSON.stringify(dados.events.valor[0], null, 2)}</pre>
                </div>`;
            }
            
            if (dados.companies && dados.companies.tipo === 'array' && dados.companies.valor.length > 0) {
                html += `<div class="mb-4">
                    <strong>Companies (primeiro item):</strong>
                    <pre class="bg-white p-2 rounded text-xs overflow-auto">${JSON.stringify(dados.companies.valor[0], null, 2)}</pre>
                </div>`;
            }
            
            html += '</div>';

            // Se√ß√£o: Compara√ß√£o com exemplo
            html += '<div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">';
            html += '<h2 class="font-bold text-lg mb-2">üí° Recomenda√ß√µes</h2>';
            
            const temToys = dados.toys && dados.toys.tipo === 'array' && dados.toys.tamanho > 0;
            const temEvents = dados.events && dados.events.tipo === 'array' && dados.events.tamanho > 0;
            const temCompanies = dados.companies && dados.companies.tipo === 'array' && dados.companies.tamanho > 0;
            
            if (!temToys && !temEvents && !temCompanies) {
                html += '<div class="text-red-600 font-semibold mb-2">‚ö†Ô∏è Nenhum dado encontrado nas chaves principais!</div>';
                html += '<div class="text-sm">';
                html += '<p>Poss√≠veis causas:</p>';
                html += '<ul class="list-disc list-inside ml-4">';
                html += '<li>Os dados est√£o em chaves diferentes</li>';
                html += '<li>Os dados foram limpos do localStorage</li>';
                html += '<li>Voc√™ est√° em um navegador/perfil diferente</li>';
                html += '<li>Os dados est√£o no arquivo example/Agenda de eventos.html mas n√£o foram sincronizados</li>';
                html += '</ul>';
                html += '</div>';
            } else {
                html += '<div class="text-green-600 font-semibold mb-2">‚úÖ Dados encontrados!</div>';
                html += '<div class="text-sm">';
                html += '<p>Se os dados n√£o aparecem na p√°gina, verifique:</p>';
                html += '<ul class="list-disc list-inside ml-4">';
                html += '<li>Console do navegador (F12) para erros JavaScript</li>';
                html += '<li>Se a fun√ß√£o renderAll() est√° sendo chamada</li>';
                html += '<li>Se h√° erros de sintaxe nos dados JSON</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            html += '</div>';

            html += '</div>';
            resultados.innerHTML = html;
        }

        function copiarDados() {
            const dados = {
                toys: JSON.parse(localStorage.getItem('toys') || '[]'),
                companies: JSON.parse(localStorage.getItem('companies') || '[]'),
                events: JSON.parse(localStorage.getItem('events') || '[]'),
                clients: JSON.parse(localStorage.getItem('clients') || '[]')
            };
            
            const texto = JSON.stringify(dados, null, 2);
            navigator.clipboard.writeText(texto).then(() => {
                alert('Dados copiados para o clipboard!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar. Veja o console.');
            });
        }

        // Executar automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', executarDiagnostico);
    </script>
</body>
</html>

