<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - Aero Festas</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="js/pwa-init.js"></script>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>ðŸ’¬</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Core WhatsApp Greens */
            --wa-green: #25D366;
            --wa-dark-green: #075E54;
            --wa-teal: #128C7E;
            --wa-light-green: #d9fdd3;
            --wa-bg: #efeae2;

            /* Gradient endpoints */
            --wa-gradient-start: #25D366;
            --wa-gradient-end: #128C7E;
            --wa-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            --wa-gradient-subtle: linear-gradient(135deg, rgba(37,211,102,0.12) 0%, rgba(18,140,126,0.08) 100%);

            /* Sidebar deep tones */
            --sidebar-bg: #111b21;
            --sidebar-hover: rgba(255, 255, 255, 0.06);
            --sidebar-active-glow: rgba(37, 211, 102, 0.25);

            /* Glass refinements */
            --glass-bg: rgba(255, 255, 255, 0.72);
            --glass-bg-strong: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.35);
            --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);

            /* Bubble colors */
            --bubble-out-bg: #d9fdd3;
            --bubble-in-bg: #ffffff;

            /* Text hierarchy */
            --text-primary: #111b21;
            --text-secondary: #667781;
            --text-tertiary: #8696a0;

            /* System colors */
            --primary: #4f46e5;
            --secondary: #a855f7;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;

            /* Radius tokens */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-pill: 9999px;

            /* Animation timing */
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: cubic-bezier(0.0, 0, 0.2, 1);

            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .glassmorphism {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(200%);
            -webkit-backdrop-filter: blur(16px) saturate(200%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .form-input {
            background-color: #f0f2f5; border: 1px solid transparent; color: var(--text-primary);
            border-radius: 10px; padding: 0.5rem 0.75rem; transition: all 0.25s var(--ease-smooth);
            font-size: 0.875rem;
        }
        .form-input::placeholder { color: var(--text-tertiary); }
        .form-input:focus { outline: none; background-color: #ffffff; border-color: rgba(37, 211, 102, 0.3); box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.08); }

        .shiny-btn {
            position: relative; border: none;
            background: var(--wa-gradient); background-size: 200% auto; color: white;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.35); transition: all 0.3s var(--ease-smooth);
        }
        .shiny-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5); }
        .shiny-btn:active { transform: translateY(0) scale(0.98); box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3); }
        .shiny-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 10px; transition: background 0.2s; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.25); }
        #messages-area::-webkit-scrollbar { width: 4px; }
        #messages-area::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
        #conversation-list::-webkit-scrollbar { width: 3px; }
        #conversation-list::-webkit-scrollbar-thumb { background: rgba(37, 211, 102, 0.2); border-radius: 10px; }

        /* Chat bubbles */
        .bubble-received {
            background: var(--bubble-in-bg); border-radius: 0 12px 12px 12px; max-width: 75%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.02);
            position: relative; animation: bubble-in-left 0.25s var(--ease-spring);
        }
        .bubble-received::before {
            content: ''; position: absolute; top: 0; left: -8px;
            width: 0; height: 0;
            border-top: 0px solid transparent; border-bottom: 10px solid transparent;
            border-right: 8px solid var(--bubble-in-bg);
            filter: drop-shadow(-1px 0px 1px rgba(0, 0, 0, 0.04));
        }
        .bubble-sent {
            background: var(--bubble-out-bg); border-radius: 12px 0 12px 12px; max-width: 75%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(37, 211, 102, 0.05);
            position: relative; animation: bubble-in-right 0.25s var(--ease-spring);
        }
        .bubble-sent::before {
            content: ''; position: absolute; top: 0; right: -8px;
            width: 0; height: 0;
            border-top: 0px solid transparent; border-bottom: 10px solid transparent;
            border-left: 8px solid var(--bubble-out-bg);
            filter: drop-shadow(1px 0px 1px rgba(0, 0, 0, 0.04));
        }
        /* BotÃ£o encaminhar â€” sÃ³ aparece no hover da bolha */
        .forward-btn { pointer-events: none; transition: all 0.2s var(--ease-smooth) !important; }
        .group:hover .forward-btn { pointer-events: auto; }

        /* Conversation item */
        .conv-item { transition: all 0.2s var(--ease-smooth); position: relative; border-left: 3px solid transparent; }
        .conv-item:hover { background: rgba(37, 211, 102, 0.04); border-left-color: rgba(37, 211, 102, 0.3); }
        .conv-item.active {
            background: linear-gradient(90deg, rgba(37, 211, 102, 0.1) 0%, rgba(37, 211, 102, 0.03) 100%);
            border-left: 3px solid var(--wa-green);
        }
        .conv-item:hover .w-10.h-10.rounded-full { box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.3); transition: box-shadow 0.2s var(--ease-smooth); }

        /* Instance tabs */
        .instance-tab {
            padding: 0.5rem 1.25rem; border-radius: var(--radius-pill); font-weight: 600; font-size: 0.8rem;
            cursor: pointer; transition: all 0.3s var(--ease-spring); border: 2px solid transparent;
            position: relative; overflow: hidden; letter-spacing: 0.02em;
        }
        .instance-tab.active {
            background: var(--wa-gradient); color: white;
            box-shadow: 0 4px 14px rgba(37,211,102,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        .instance-tab.active::after {
            content: ''; position: absolute; top: -50%; left: -60%; width: 50%; height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }
        .instance-tab:not(.active) { background: rgba(0,0,0,0.04); color: var(--text-secondary); }
        .instance-tab:not(.active):hover { background: rgba(37,211,102,0.08); color: var(--wa-teal); transform: scale(1.02); }

        /* Unread badge */
        .unread-badge {
            background: var(--wa-gradient); color: white; font-size: 0.65rem; font-weight: 700;
            min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; padding: 0 6px;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.35); animation: badge-pop 0.3s var(--ease-spring);
        }

        /* Status indicator */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; transition: all 0.3s var(--ease-smooth); }
        .status-dot.connected { background: var(--wa-green); box-shadow: 0 0 0 2px rgba(37,211,102,0.2), 0 0 8px rgba(37,211,102,0.4); }
        .status-dot.disconnected { background: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.15); }
        .status-dot.connecting { background: #f59e0b; animation: pulse-dot 1.2s infinite; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15); }
        @keyframes pulse-dot { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.85); } }

        /* Bottom nav (same as CRM) */
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 480px; height: 75px; background: rgba(255,255,255,0.6); backdrop-filter: blur(30px) saturate(210%); -webkit-backdrop-filter: blur(30px) saturate(210%); border: 1px solid rgba(255,255,255,0.4); display: flex; justify-content: space-around; align-items: center; padding: 12px 10px 0 10px; z-index: 10000; border-radius: 40px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(255,255,255,0.8); transition: all 0.7s cubic-bezier(0.19,1,0.22,1); user-select: none; overflow: hidden; }
        .bottom-nav-handle { position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .bottom-nav-handle::after { content: ''; width: 40px; height: 4px; background: rgba(79,70,229,0.2); border-radius: 10px; transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav-handle i { position: absolute; font-size: 1.2rem; color: #4f46e5; opacity: 0; transform: translateY(10px); transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav.collapsed { transform: translateX(-50%) translateY(15px); width: 80px; height: 48px; padding: 0; border-radius: 100px; background: rgba(255,255,255,0.5); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .bottom-nav.collapsed .nav-item { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .bottom-nav.collapsed .bottom-nav-handle::after { opacity: 0; transform: scaleX(0); }
        .bottom-nav.collapsed .bottom-nav-handle i { opacity: 1; transform: translateY(0); }
        @media (min-width: 1024px) { .bottom-nav { display: none; } }
        .nav-item { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; width: 55px; height: 100%; text-decoration: none; z-index: 1; transition: all 0.6s cubic-bezier(0.19,1,0.22,1); }
        .nav-item::before { content: ''; position: absolute; top: 50%; left: 50%; width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 16px; transform: translate(-50%,-50%) scale(0); opacity: 0; z-index: -1; transition: all 0.5s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 8px 16px rgba(79,70,229,0.3); }
        .nav-item.active { color: white; transform: translateY(-8px); }
        .nav-item.active::before { transform: translate(-50%,-60%) scale(1); opacity: 1; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; }
        .nav-item.active span { opacity: 1; transform: translateY(2px); color: #4f46e5; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 8px; font-size: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        @media (max-width: 768px) { .container { padding-bottom: 100px; } }

        /* Toast */
        #toast { position: fixed; top: 20px; right: 20px; z-index: 99999; }
        .toast-enter { animation: toast-in-premium 0.5s var(--ease-spring) forwards; }

        /* QR Modal */
        #qr-modal.hidden { display: none; }
        .modal-hidden { display: none !important; }

        /* Attach menu item hover */
        .attach-menu-item:hover { background: #f3f4f6 !important; }

        /* Shortcuts popup */
        .shortcuts-popup {
            position: fixed;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: 14px; box-shadow: 0 12px 40px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.04);
            max-height: 200px; overflow-y: auto; z-index: 10000;
            width: 300px; border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .shortcut-item {
            padding: 10px 14px; cursor: pointer; transition: all 0.15s var(--ease-smooth);
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }
        .shortcut-item:hover { background: var(--wa-gradient-subtle); padding-left: 18px; }
        .shortcut-item:last-child { border-bottom: none; }

        /* Audio recording */
        .recording-indicator {
            display: flex; align-items: center; gap: 8px; color: #ef4444; font-size: 0.85rem;
            animation: recording-pulse 1.2s infinite;
        }
        @keyframes recording-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Media preview in messages â€” base rules (overridden below with transitions) */

        /* Catalog grid */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .catalog-item {
            background: white; border-radius: var(--radius-md); overflow: hidden; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s var(--ease-spring);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        .catalog-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 24px rgba(0,0,0,0.1); border-color: rgba(37, 211, 102, 0.2); }
        .catalog-item img { width: 100%; height: 120px; object-fit: cover; }

        /* Sidebar */
        .wa-sidebar {
            width: 56px; background: var(--sidebar-bg); display: flex; flex-direction: column;
            align-items: center; padding: 12px 0; gap: 4px; border-radius: 16px 0 0 16px;
            flex-shrink: 0; position: relative; overflow: hidden;
        }
        .wa-sidebar::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 120px;
            background: linear-gradient(180deg, rgba(37, 211, 102, 0.08) 0%, transparent 100%);
            pointer-events: none;
        }
        .wa-sidebar-btn {
            width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; color: #8696a0; cursor: pointer; transition: all 0.3s var(--ease-smooth);
            position: relative; border: none; background: transparent; font-size: 1rem; z-index: 1;
        }
        .wa-sidebar-btn:hover { background: var(--sidebar-hover); color: #d1d5db; transform: scale(1.05); }
        .wa-sidebar-btn.active {
            background: var(--wa-gradient); color: white;
            box-shadow: 0 4px 15px var(--sidebar-active-glow), 0 0 30px rgba(37, 211, 102, 0.15);
            transform: scale(1.05);
        }
        .wa-sidebar-btn.active::after {
            content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%);
            width: 3px; height: 20px; background: var(--wa-green); border-radius: 0 3px 3px 0;
        }
        .wa-sidebar-btn .sidebar-badge {
            position: absolute; top: 0px; right: 0px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;
            font-size: 0.55rem; min-width: 16px; height: 16px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-weight: 700;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4); animation: badge-pop 0.3s var(--ease-spring);
        }
        .wa-sidebar-spacer { flex: 1; }
        @media (max-width: 1023px) { .wa-sidebar { display: none; } }

        /* Main layout wrapper */
        .wa-main-wrapper {
            display: flex; height: calc(100vh - 140px); border-radius: var(--radius-lg); overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.04);
        }
        @media (max-width: 768px) {
            .wa-main-wrapper { height: calc(100vh - 180px); border-radius: var(--radius-md); }
        }

        /* Side panels */
        .wa-side-panel {
            width: 340px; flex-shrink: 0; display: flex; flex-direction: column;
            background: rgba(255,255,255,0.75); border-right: 1px solid rgba(0,0,0,0.06);
        }
        @media (max-width: 1023px) {
            .wa-side-panel { width: 100%; border-right: none; }
            .wa-side-panel.mobile-hidden { display: none; }
        }
        @media (min-width: 1024px) {
            .wa-side-panel { display: flex !important; }
        }

        /* Chat panel flex */
        .wa-chat-panel {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }
        @media (max-width: 1023px) {
            .wa-chat-panel.mobile-hidden { display: none; }
        }

        /* Contact details panel */
        .wa-details-panel {
            width: 320px; flex-shrink: 0; display: none; flex-direction: column;
            background: rgba(255,255,255,0.9); border-left: 1px solid rgba(0,0,0,0.06);
            overflow-y: auto;
        }
        .wa-details-panel.open { display: flex; animation: details-slide-in 0.3s var(--ease-smooth); }
        @media (max-width: 1280px) {
            .wa-details-panel.open {
                position: fixed; right: 0; top: 0; bottom: 0; z-index: 15000;
                width: 100%; max-width: 360px; box-shadow: -8px 0 32px rgba(0,0,0,0.12);
                background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            }
        }

        /* Status ring on avatar */
        .status-ring { box-shadow: 0 0 0 2px var(--wa-green); animation: status-ring-glow 2s ease-in-out infinite; }

        /* Archived bar */
        .archived-bar {
            display: flex; align-items: center; gap: 8px; padding: 12px 16px;
            cursor: pointer; transition: all 0.2s var(--ease-smooth); color: var(--wa-teal); font-weight: 600; font-size: 0.85rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }
        .archived-bar:hover { background: var(--wa-gradient-subtle); padding-left: 20px; }

        /* Muted icon in conv list */
        .muted-icon { color: #9ca3af; font-size: 0.7rem; }

        /* Messages area background */
        #messages-area {
            background-color: var(--wa-bg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'%3E%3Cg fill='%23d6cebf' fill-opacity='0.12'%3E%3Ccircle cx='10' cy='10' r='1.5'/%3E%3Ccircle cx='50' cy='30' r='1'/%3E%3Ccircle cx='30' cy='60' r='1.2'/%3E%3Ccircle cx='70' cy='70' r='0.8'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 80px 80px;
        }

        /* Input bar premium */
        #input-bar {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0, 0, 0, 0.06) !important;
            padding: 10px 16px !important;
        }
        #message-input {
            background: #f0f2f5 !important; border: 1px solid transparent !important;
            border-radius: 24px !important; padding: 10px 40px 10px 18px !important;
            font-size: 0.9rem !important; transition: all 0.25s var(--ease-smooth);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
        }
        #message-input:focus {
            background: #ffffff !important; border-color: rgba(37, 211, 102, 0.3) !important;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.08), inset 0 1px 2px rgba(0, 0, 0, 0.02) !important;
        }
        #attach-btn { color: #8696a0; transition: all 0.25s var(--ease-smooth); }
        #attach-btn:hover { color: var(--wa-teal); background: rgba(18, 140, 126, 0.08); transform: rotate(45deg); }
        #audio-btn { transition: all 0.25s var(--ease-smooth); }
        #audio-btn:hover { background: rgba(37, 211, 102, 0.1) !important; transform: scale(1.1); }

        /* Chat header premium */
        #chat-header {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06) !important; position: relative;
        }
        #chat-header::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 211, 102, 0.3), rgba(18, 140, 126, 0.3), transparent);
        }
        #side-panel-title {
            background: var(--wa-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            font-weight: 800; font-size: 1.1rem;
        }
        .wa-side-panel > .p-3.border-b {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }
        header.glassmorphism {
            background: rgba(255, 255, 255, 0.8) !important;
            border-bottom: 1px solid rgba(37, 211, 102, 0.15);
        }

        /* Search input premium */
        #search-conversations {
            border-radius: 20px !important; background: #f0f2f5 !important;
            border: 1px solid transparent !important; padding-left: 36px !important;
        }
        #search-conversations:focus {
            background: #ffffff !important; border-color: rgba(37, 211, 102, 0.25) !important;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.06) !important;
        }

        /* Filter unread button */
        #filter-unread-btn {
            transition: all 0.25s var(--ease-smooth) !important; border: 1px solid transparent;
        }
        #filter-unread-btn:hover {
            border-color: rgba(37, 211, 102, 0.2) !important;
            background: rgba(37, 211, 102, 0.06) !important; color: var(--wa-teal) !important;
        }

        /* Date separator in messages */
        #messages-area > .text-center > span {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06) !important;
            color: var(--text-secondary) !important; font-weight: 500;
            padding: 4px 14px !important; letter-spacing: 0.01em;
        }

        /* Sync banner */
        #sync-banner {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.04)) !important;
            border-bottom: 1px solid rgba(245, 158, 11, 0.15);
        }

        /* Chat welcome empty state */
        #chat-welcome { animation: empty-state-in 0.6s var(--ease-smooth); }
        #chat-welcome i.fab.fa-whatsapp {
            font-size: 5rem !important;
            background: var(--wa-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            animation: empty-icon-float 3s ease-in-out infinite; display: inline-block; opacity: 0.6;
        }
        #chat-welcome p.text-lg { color: var(--text-primary) !important; font-weight: 700 !important; margin-top: 16px !important; }
        #chat-welcome p.text-sm { color: var(--text-tertiary) !important; }

        /* Conversation list empty state */
        #conversation-list > .flex.items-center.justify-center i.fab.fa-whatsapp {
            background: var(--wa-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            animation: empty-icon-float 3s ease-in-out infinite; display: inline-block;
        }

        /* Toast premium */
        #toast {
            border-radius: 14px !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.04) !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5) !important; padding: 14px 18px !important;
        }

        /* Attach menu premium */
        #attach-menu {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important; -webkit-backdrop-filter: blur(20px) !important;
            border-radius: 18px !important;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.04) !important;
            border: 1px solid rgba(255, 255, 255, 0.5); padding: 14px !important;
            animation: modal-card-in 0.25s var(--ease-spring);
        }
        .attach-menu-item { transition: all 0.2s var(--ease-smooth) !important; border-radius: 14px !important; }
        .attach-menu-item:hover { background: rgba(0, 0, 0, 0.03) !important; transform: translateY(-2px); }
        .attach-menu-item > div:first-child {
            transition: all 0.25s var(--ease-spring); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .attach-menu-item:hover > div:first-child { transform: scale(1.1); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }

        /* Emoji picker premium */
        #emoji-picker {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important; -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.04) !important;
            border-radius: 18px !important;
        }

        /* Media bubble hover */
        .media-bubble img, .media-bubble video {
            max-width: 100%; border-radius: 10px; cursor: pointer;
            transition: all 0.2s var(--ease-smooth);
        }
        .media-bubble img:hover, .media-bubble video:hover { filter: brightness(0.95); transform: scale(1.01); }
        .media-bubble audio { width: 100%; max-width: 280px; border-radius: 20px; }

        /* Settings panel hover */
        #settings-panel button:hover, #settings-panel a:hover {
            transform: translateX(4px); transition: all 0.2s var(--ease-smooth);
        }

        /* Modal animations */
        #catalog-modal:not(.modal-hidden), #shortcuts-modal:not(.modal-hidden),
        #media-preview-modal:not(.modal-hidden), #edit-profile-modal:not(.modal-hidden),
        #send-contact-modal:not(.modal-hidden), #forward-modal:not(.modal-hidden),
        #mute-modal:not(.modal-hidden), #post-status-modal:not(.modal-hidden) {
            animation: modal-backdrop-in 0.3s var(--ease-out) forwards;
        }
        #catalog-modal:not(.modal-hidden) > div, #shortcuts-modal:not(.modal-hidden) > div,
        #media-preview-modal:not(.modal-hidden) > div, #edit-profile-modal:not(.modal-hidden) > div,
        #send-contact-modal:not(.modal-hidden) > div, #forward-modal:not(.modal-hidden) > div,
        #mute-modal:not(.modal-hidden) > div, #post-status-modal:not(.modal-hidden) > div {
            animation: modal-card-in 0.35s var(--ease-spring) forwards;
        }
        #qr-modal:not(.hidden) { animation: modal-backdrop-in 0.3s var(--ease-out) forwards; }
        #qr-modal:not(.hidden) > div { animation: modal-card-in 0.35s var(--ease-spring) forwards; }
        #catalog-modal > div, #shortcuts-modal > div, #edit-profile-modal > div,
        #send-contact-modal > div, #forward-modal > div, #mute-modal > div,
        #post-status-modal > div, #media-preview-modal > div {
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* ===== KEYFRAMES ===== */
        @keyframes bubble-in-left {
            from { opacity: 0; transform: translateX(-12px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        @keyframes bubble-in-right {
            from { opacity: 0; transform: translateX(12px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        @keyframes badge-pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes modal-backdrop-in {
            from { opacity: 0; } to { opacity: 1; }
        }
        @keyframes modal-card-in {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes empty-icon-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @keyframes empty-state-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes status-ring-glow {
            0%, 100% { box-shadow: 0 0 0 2px var(--wa-green); }
            50% { box-shadow: 0 0 0 2px var(--wa-green), 0 0 8px rgba(37, 211, 102, 0.4); }
        }
        @keyframes shimmer {
            0% { left: -60%; }
            50%, 100% { left: 120%; }
        }
        @keyframes details-slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toast-in-premium {
            from { transform: translateX(100%) translateY(-10px); opacity: 0; filter: blur(4px); }
            to { transform: translateX(0) translateY(0); opacity: 1; filter: blur(0); }
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto p-4 md:p-6 relative z-10 max-w-7xl">

        <!-- Header (compact) -->
        <header class="lg:hidden glassmorphism p-3 rounded-xl mb-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fab fa-whatsapp text-[var(--wa-green)] text-xl"></i>
                <h1 class="text-lg font-bold">WhatsApp</h1>
            </div>
            <div class="flex items-center gap-1">
                <span class="status-dot disconnected" id="connection-status-dot-mobile" style="width:6px;height:6px;"></span>
            </div>
        </header>

        <!-- Main Layout with Sidebar -->
        <div class="wa-main-wrapper glassmorphism">
            <!-- Sidebar -->
            <div class="wa-sidebar">
                <button class="wa-sidebar-btn active" data-panel="chats" title="Conversas"><i class="fas fa-comment-dots"></i></button>
                <button class="wa-sidebar-btn" data-panel="groups" title="Grupos"><i class="fas fa-users"></i></button>
                <button class="wa-sidebar-btn" data-panel="status" title="Status"><i class="fas fa-circle-notch"></i></button>
                <button class="wa-sidebar-btn" data-panel="catalog" title="CatÃ¡logo"><i class="fas fa-store"></i></button>
                <div class="wa-sidebar-spacer"></div>
                <button class="wa-sidebar-btn" data-panel="settings" title="ConfiguraÃ§Ãµes"><i class="fas fa-cog"></i></button>
            </div>

            <!-- Side Panel (Conversations / Groups / Status / Settings) -->
            <div id="conversation-panel" class="wa-side-panel">
                <!-- Side panel header -->
                <div class="p-3 border-b border-gray-200/50">
                    <div class="flex items-center justify-between mb-2">
                        <h2 id="side-panel-title" class="font-bold text-gray-900">Conversas</h2>
                        <div class="flex gap-1">
                            <button id="new-conversation-btn" class="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition" title="Nova conversa">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button id="sync-history-btn" class="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition" title="Sincronizar histÃ³rico">
                                <i class="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Instance Tabs -->
                    <div class="flex gap-1 mb-2" id="instance-tabs">
                        <button class="instance-tab active text-xs py-1.5 px-3" data-instance="aero-festas">
                            Aero <span class="ml-1 text-[10px]" id="badge-aero-festas"></span>
                        </button>
                        <button class="instance-tab text-xs py-1.5 px-3" data-instance="abc-festas">
                            ABC <span class="ml-1 text-[10px]" id="badge-abc-festas"></span>
                        </button>
                        <div class="flex items-center gap-1 ml-auto">
                            <span class="status-dot disconnected" id="connection-status-dot" style="width:6px;height:6px;"></span>
                            <span class="text-[10px] text-gray-400" id="connection-status-text">...</span>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="search-conversations" placeholder="Buscar conversa..."
                            class="form-input w-full pl-9 pr-4 py-2 rounded-xl text-sm">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search text-xs"></i>
                        </span>
                    </div>
                    <div class="flex gap-1 mt-2">
                        <button id="filter-unread-btn" onclick="toggleUnreadFilter()" class="flex-1 text-xs py-1.5 px-3 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 transition font-medium flex items-center justify-center gap-1">
                            <i class="fas fa-envelope text-[10px]"></i> NÃ£o lidas
                        </button>
                    </div>
                </div>

                <!-- Archived bar -->
                <div id="archived-bar" class="archived-bar hidden" onclick="toggleArchivedView()">
                    <i class="fas fa-archive"></i>
                    <span>Arquivados (<span id="archived-count">0</span>)</span>
                </div>

                <!-- Side panel content area -->
                <div id="conversation-list" class="flex-1 overflow-y-auto">
                    <div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                            <p>Carregando conversas...</p>
                        </div>
                    </div>
                </div>

                <!-- Groups panel (hidden by default) -->
                <div id="groups-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Status panel (hidden by default) -->
                <div id="status-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Catalog panel (hidden by default) -->
                <div id="catalog-side-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Settings panel (hidden by default) -->
                <div id="settings-panel" class="flex-1 overflow-y-auto hidden">
                    <div class="p-4 space-y-3">
                        <div id="profile-section" class="text-center py-4">
                            <div class="w-20 h-20 rounded-full bg-[var(--wa-green)] mx-auto mb-3 flex items-center justify-center text-white text-2xl font-bold overflow-hidden cursor-pointer" id="my-profile-pic">
                                <i class="fab fa-whatsapp text-3xl"></i>
                            </div>
                            <h3 id="my-profile-name" class="font-bold text-gray-900">...</h3>
                            <p id="my-profile-status" class="text-xs text-gray-500 mt-1">...</p>
                            <p id="my-profile-phone" class="text-xs text-gray-400 mt-1"></p>
                        </div>
                        <button onclick="openEditProfileModal()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-user-edit text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Editar perfil</span>
                        </button>
                        <button onclick="syncFullHistory()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-history text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Sincronizar histÃ³rico</span>
                        </button>
                        <button onclick="syncAllContacts()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-address-book text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Atualizar nomes dos contatos</span>
                        </button>
                        <button onclick="mergeDuplicates()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-compress-alt text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Corrigir conversas duplicadas</span>
                        </button>
                        <button onclick="cleanupOldConversations(90)" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 transition text-left">
                            <i class="fas fa-broom text-red-400 w-5 text-center"></i>
                            <span class="text-sm font-medium text-red-600">Limpar chats antigos</span>
                            <span class="text-xs text-gray-400 ml-auto">+90 dias</span>
                        </button>
                        <button onclick="cleanupLidConversations()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 transition text-left">
                            <i class="fas fa-clone text-red-400 w-5 text-center"></i>
                            <span class="text-sm font-medium text-red-600">Remover duplicatas @lid</span>
                        </button>
                        <button id="connect-btn" class="hidden w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-qrcode text-green-500 w-5 text-center"></i>
                            <span class="text-sm font-medium text-green-600">Conectar WhatsApp</span>
                        </button>
                        <button onclick="disconnectInstance()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 transition text-left text-red-500">
                            <i class="fas fa-sign-out-alt w-5 text-center"></i>
                            <span class="text-sm font-medium">Desconectar</span>
                        </button>
                        <a href="./Dashboard.html" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-home text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Voltar ao Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- New Conversation panel (hidden by default) -->
                <div id="new-conv-panel" class="flex-1 overflow-y-auto hidden">
                    <div class="p-3 border-b border-gray-200/50">
                        <div class="flex items-center gap-2 mb-2">
                            <button onclick="closeNewConvPanel()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-arrow-left"></i></button>
                            <h3 class="font-bold text-sm">Nova conversa</h3>
                        </div>
                        <input type="text" id="search-contacts" placeholder="Buscar contato ou digitar nÃºmero..." class="form-input w-full pl-9 pr-4 py-2 rounded-xl text-sm">
                        <!-- BotÃ£o aparece ao digitar um nÃºmero -->
                        <div id="new-conv-number-btn" class="hidden mt-2">
                            <button id="start-conv-number" class="w-full flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-xl hover:bg-green-100 transition text-left">
                                <div class="w-9 h-9 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white flex-shrink-0">
                                    <i class="fas fa-phone text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Iniciar conversa</p>
                                    <p class="text-xs text-gray-500" id="new-conv-number-display"></p>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div id="contacts-list" class="divide-y divide-gray-100"></div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div id="chat-panel" class="wa-chat-panel mobile-hidden">
                <!-- Chat Header -->
                <div id="chat-header" class="p-3 border-b border-gray-200/50 flex items-center justify-between bg-white/30">
                    <div class="flex items-center gap-3 min-w-0 flex-1 cursor-pointer" id="chat-header-contact" onclick="openContactDetails()">
                        <button id="back-to-list-btn" class="lg:hidden text-gray-500 hover:text-gray-700 p-1 flex-shrink-0">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </button>
                        <div class="w-10 h-10 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white font-bold overflow-hidden flex-shrink-0" id="chat-avatar">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 id="chat-contact-name" class="font-semibold text-gray-900 text-sm truncate"></h3>
                            <p id="chat-contact-phone" class="text-xs text-gray-500 truncate"></p>
                            <p id="chat-presence" class="text-[11px] text-green-600 font-medium hidden"></p>
                        </div>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button id="link-crm-btn" class="hidden text-xs bg-indigo-100 text-indigo-700 px-2.5 py-1.5 rounded-lg hover:bg-indigo-200 font-semibold transition">
                            <i class="fas fa-users mr-1"></i> CRM
                        </button>
                        <button id="mute-chat-btn" class="hidden text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center" title="Silenciar" onclick="toggleMuteChat()">
                            <i class="fas fa-bell text-sm"></i>
                        </button>
                        <button id="archive-chat-btn" class="hidden text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center" title="Arquivar" onclick="toggleArchiveChat()">
                            <i class="fas fa-archive text-sm"></i>
                        </button>
                        <button id="delete-chat-btn" class="hidden text-gray-400 hover:text-red-500 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center transition" title="Deletar conversa" onclick="deleteCurrentConversation()">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Sync banner (shown when no messages) -->
                <div id="sync-banner" class="hidden bg-amber-50 text-amber-700 text-xs text-center py-2 px-3 cursor-pointer hover:bg-amber-100 transition" onclick="syncCurrentConversation()">
                    <i class="fas fa-sync-alt mr-1"></i> Sem histÃ³rico. Toque para sincronizar mensagens.
                </div>

                <!-- Messages Area -->
                <div id="messages-area" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>
                </div>

                <!-- Loading more indicator -->
                <div id="loading-more" class="hidden text-center py-2 text-xs text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-1"></i> Carregando mais mensagens...
                </div>

                <!-- Input Bar -->
                <div id="input-bar" class="hidden p-3 border-t border-gray-200/50 bg-white/50">
                    <div class="relative flex items-end gap-2">
                        <button id="attach-btn" class="text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center flex-shrink-0 rounded-full hover:bg-gray-100 transition" title="Anexar">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        <div class="flex-1 relative">
                            <textarea id="message-input" rows="1" placeholder="Digite uma mensagem ou / para atalhos..."
                                class="form-input w-full resize-none text-sm rounded-2xl pl-4 pr-10 py-2.5 max-h-32"
                                style="field-sizing: content;"></textarea>
                            <button type="button" class="emoji-trigger absolute right-2 bottom-2 text-gray-400 hover:text-amber-500 transition" data-target="message-input" title="Emojis">
                                <i class="far fa-smile text-lg"></i>
                            </button>
                        </div>
                        <button id="send-btn" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="display:none;">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                        <button id="audio-btn" class="text-gray-400 hover:text-[var(--wa-green)] w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 hover:bg-green-50 transition" title="Gravar Ã¡udio">
                            <i class="fas fa-microphone text-lg"></i>
                        </button>
                    </div>
                    <!-- Recording UI (hidden by default) -->
                    <div id="recording-bar" class="items-center gap-3 py-2" style="display:none !important;">
                        <button id="cancel-recording" class="text-red-500 hover:text-red-700 w-10 h-10 flex items-center justify-center"><i class="fas fa-trash"></i></button>
                        <div class="recording-indicator flex-1"><i class="fas fa-circle text-xs"></i> <span id="recording-time">0:00</span> â€” Gravando...</div>
                        <button id="send-recording" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                    <!-- Hidden file inputs -->
                    <input type="file" id="file-input-image" accept="image/*" class="hidden">
                    <input type="file" id="file-input-video" accept="video/*" class="hidden">
                    <input type="file" id="file-input-document" accept="*/*" class="hidden">
                </div>
            </div>

            <!-- Contact Details Panel -->
            <div id="contact-details-panel" class="wa-details-panel">
                <div class="p-3 border-b border-gray-200/50 flex items-center gap-2">
                    <button onclick="closeContactDetails()" class="text-gray-500 hover:text-gray-700 w-8 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
                    <h3 class="font-bold text-sm">Dados do contato</h3>
                </div>
                <div id="contact-details-content" class="p-4 overflow-y-auto flex-1"></div>
            </div>
        </div>
    </div>

    <!-- Catalog Modal -->
    <div id="catalog-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-store text-green-600 mr-2"></i>CatÃ¡logo</h3>
                <button id="close-catalog-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="catalog-content" class="flex-1 overflow-y-auto">
                <div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando catÃ¡logo...</p></div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker (fixed, outside overflow containers) -->
    <div id="emoji-picker" style="display:none; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.18); z-index:99999; width:280px; max-height:320px; overflow:hidden; flex-direction:column;">
        <div style="padding:8px 10px; border-bottom:1px solid #eee;">
            <input type="text" id="emoji-search" placeholder="Buscar emoji..." style="width:100%; border:1px solid #e5e7eb; border-radius:20px; padding:6px 12px; font-size:0.8rem; outline:none;">
        </div>
        <div id="emoji-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px; padding:8px; overflow-y:auto; max-height:260px; font-size:1.4rem; text-align:center;"></div>
    </div>

    <!-- Shortcuts popup (fixed, outside overflow containers) -->
    <div id="shortcuts-popup" class="shortcuts-popup" style="display:none !important;"></div>

    <!-- Attach Menu (fixed, outside overflow containers) -->
    <div id="attach-menu" style="display:none; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.15); padding:12px; z-index:99999;">
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
            <div class="attach-menu-item" data-action="image" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#a855f7;"><i class="fas fa-image"></i></div>
                <span>Imagem</span>
            </div>
            <div class="attach-menu-item" data-action="video" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#ef4444;"><i class="fas fa-video"></i></div>
                <span>VÃ­deo</span>
            </div>
            <div class="attach-menu-item" data-action="document" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#3b82f6;"><i class="fas fa-file"></i></div>
                <span>Documento</span>
            </div>
            <div class="attach-menu-item" data-action="catalog" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#16a34a;"><i class="fas fa-store"></i></div>
                <span>CatÃ¡logo</span>
            </div>
            <div class="attach-menu-item" data-action="contact" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#0ea5e9;"><i class="fas fa-address-book"></i></div>
                <span>Contato</span>
            </div>
            <div class="attach-menu-item" data-action="shortcuts-manage" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#f59e0b;"><i class="fas fa-bolt"></i></div>
                <span>Atalhos</span>
            </div>
        </div>
    </div>

    <!-- Shortcuts Manager Modal -->
    <div id="shortcuts-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-bolt text-amber-500 mr-2"></i>Atalhos RÃ¡pidos</h3>
                <button id="close-shortcuts-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <button id="add-shortcut-btn" class="w-full mb-3 py-2 px-4 bg-amber-50 text-amber-700 rounded-xl text-sm font-semibold hover:bg-amber-100 transition">
                <i class="fas fa-plus mr-1"></i> Novo Atalho
            </button>
            <div id="shortcuts-list" class="flex-1 overflow-y-auto space-y-2">
                <p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>
            </div>
            <!-- Add/Edit form (hidden) -->
            <div id="shortcut-form" class="border-t border-gray-200 pt-3 mt-3" style="display:none;">
                <h4 class="text-sm font-bold mb-2" id="shortcut-form-title">Novo Atalho</h4>
                <input type="hidden" id="shortcut-edit-id">
                <div class="space-y-2">
                    <div>
                        <label class="text-xs text-gray-500">Comando (ex: futebol)</label>
                        <input type="text" id="shortcut-cmd" class="form-input w-full text-sm" placeholder="futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">TÃ­tulo</label>
                        <input type="text" id="shortcut-title" class="form-input w-full text-sm" placeholder="Pacote Futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Mensagem</label>
                        <textarea id="shortcut-content" rows="3" class="form-input w-full text-sm resize-none" placeholder="OlÃ¡! Temos o pacote futebol..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button id="save-shortcut" class="flex-1 shiny-btn py-2 rounded-lg text-sm font-bold">Salvar</button>
                        <button id="cancel-shortcut" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Preview Modal (before sending) -->
    <div id="media-preview-modal" class="modal-hidden fixed inset-0 bg-black/80 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-md w-full">
            <div id="media-preview-content" class="mb-3 flex justify-center max-h-[50vh] overflow-hidden rounded-xl bg-gray-100">
            </div>
            <div class="relative mb-3">
                <input type="text" id="media-caption" class="form-input w-full text-sm pr-10" placeholder="Legenda (opcional)">
                <button type="button" class="emoji-trigger absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-amber-500 transition" data-target="media-caption" title="Emojis">
                    <i class="far fa-smile text-lg"></i>
                </button>
            </div>
            <p class="text-xs text-gray-400 mb-3" id="media-file-info"></p>
            <div class="flex gap-2">
                <button id="confirm-send-media" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold"><i class="fas fa-paper-plane mr-1"></i> Enviar</button>
                <button id="cancel-send-media" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-modal" class="modal-hidden fixed inset-0 bg-black/80 z-[30000] flex flex-col">
        <div class="flex items-center justify-between p-3 bg-gray-900/90">
            <h3 class="text-white text-sm font-semibold truncate flex-1" id="pdf-title"><i class="fas fa-file-pdf text-red-400 mr-2"></i>PDF</h3>
            <div class="flex gap-2">
                <button onclick="window.open(document.getElementById('pdf-frame').src,'_blank')" class="text-gray-300 hover:text-white px-3 py-1 rounded-lg text-xs bg-white/10 hover:bg-white/20 transition"><i class="fas fa-external-link-alt mr-1"></i>Nova aba</button>
                <button onclick="document.getElementById('pdf-modal').classList.add('modal-hidden')" class="text-gray-300 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <iframe id="pdf-frame" class="flex-1 w-full bg-white" style="border:none;"></iframe>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4"><i class="fas fa-user-edit text-green-600 mr-2"></i>Editar Perfil</h3>
            <div class="text-center mb-4">
                <div class="w-20 h-20 rounded-full bg-gray-200 mx-auto mb-2 overflow-hidden flex items-center justify-center cursor-pointer" id="edit-profile-pic-preview" onclick="document.getElementById('edit-profile-pic-input').click()">
                    <i class="fas fa-camera text-gray-400 text-xl"></i>
                </div>
                <input type="file" id="edit-profile-pic-input" accept="image/*" class="hidden">
                <p class="text-xs text-gray-400">Toque para alterar</p>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-medium">Nome</label>
                    <input type="text" id="edit-profile-name" class="form-input w-full text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-medium">Recado</label>
                    <input type="text" id="edit-profile-about" class="form-input w-full text-sm" placeholder="DisponÃ­vel">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveProfile()" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold">Salvar</button>
                <button onclick="document.getElementById('edit-profile-modal').classList.add('modal-hidden')" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Send Contact Modal -->
    <div id="send-contact-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-sm w-full max-h-[70vh] flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold"><i class="fas fa-address-book text-sky-500 mr-2"></i>Enviar Contato</h3>
                <button onclick="document.getElementById('send-contact-modal').classList.add('modal-hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <input type="text" id="search-contacts-send" placeholder="Buscar contato..." class="form-input w-full text-sm mb-3">
            <div id="contacts-send-list" class="flex-1 overflow-y-auto divide-y divide-gray-100"></div>
        </div>
    </div>

    <!-- Forward Message Modal -->
    <div id="forward-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-sm w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold"><i class="fas fa-share text-green-500 mr-2"></i>Encaminhar para</h3>
                <button onclick="closeForwardModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <!-- Preview da mensagem -->
            <div id="forward-preview" class="bg-gray-50 border border-gray-200 rounded-xl p-3 mb-3 text-sm text-gray-600 max-h-20 overflow-hidden line-clamp-3"></div>
            <!-- Busca -->
            <input type="text" id="forward-search" placeholder="Buscar conversa..." class="form-input w-full text-sm mb-3" oninput="filterForwardList(this.value)">
            <!-- Lista de conversas -->
            <div id="forward-conv-list" class="flex-1 overflow-y-auto divide-y divide-gray-100 min-h-0"></div>
        </div>
    </div>

    <!-- Mute Options Modal -->
    <div id="mute-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-xs w-full">
            <h3 class="text-sm font-bold mb-3">Silenciar notificaÃ§Ãµes</h3>
            <div class="space-y-1">
                <button onclick="muteChat('8h')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">8 horas</button>
                <button onclick="muteChat('1w')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">1 semana</button>
                <button onclick="muteChat('forever')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">Sempre</button>
            </div>
            <button onclick="document.getElementById('mute-modal').classList.add('modal-hidden')" class="w-full mt-3 p-2 text-center text-gray-500 text-sm hover:bg-gray-50 rounded-lg">Cancelar</button>
        </div>
    </div>

    <!-- Status Viewer Modal -->
    <div id="status-viewer-modal" class="modal-hidden fixed inset-0 bg-black z-[25000] flex flex-col">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden flex items-center justify-center text-white font-bold" id="status-viewer-avatar"></div>
                <div>
                    <p class="text-white text-sm font-semibold" id="status-viewer-name"></p>
                    <p class="text-gray-400 text-xs" id="status-viewer-time"></p>
                </div>
            </div>
            <button onclick="document.getElementById('status-viewer-modal').classList.add('modal-hidden')" class="text-white w-8 h-8 flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
        </div>
        <!-- Progress bar -->
        <div class="px-4"><div class="h-0.5 bg-gray-700 rounded-full overflow-hidden"><div id="status-progress" class="h-full bg-white transition-all" style="width:0%;"></div></div></div>
        <!-- Status content -->
        <div id="status-viewer-content" class="flex-1 flex items-center justify-center p-4"></div>
    </div>

    <!-- Post Status Modal -->
    <div id="post-status-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-3"><i class="fas fa-circle-notch text-green-600 mr-2"></i>Postar Status</h3>
            <div class="space-y-3">
                <textarea id="status-text-input" rows="4" class="form-input w-full text-sm resize-none" placeholder="Digite seu status..."></textarea>
                <div class="flex gap-2">
                    <button onclick="postTextStatus()" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold"><i class="fas fa-paper-plane mr-1"></i>Publicar</button>
                    <button onclick="document.getElementById('post-status-modal').classList.add('modal-hidden')" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-8 rounded-2xl max-w-sm w-full text-center" style="background: rgba(255,255,255,0.95);">
            <h3 class="text-lg font-bold mb-2">
                <i class="fab fa-whatsapp text-[var(--wa-green)] mr-2"></i>Conectar WhatsApp
            </h3>
            <p class="text-sm text-gray-500 mb-4" id="qr-instance-name"></p>
            <div id="qr-container" class="mx-auto mb-4 flex items-center justify-center min-h-[264px]">
                <div class="text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Gerando QR Code...</p>
                </div>
            </div>
            <p class="text-xs text-gray-500">Abra o WhatsApp no celular &gt; Dispositivos conectados &gt; Conectar dispositivo</p>
            <button id="close-qr-modal" class="mt-4 text-gray-500 hover:text-gray-700 text-sm font-semibold">
                <i class="fas fa-times mr-1"></i> Fechar
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 z-[99999] bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center gap-3 toast-enter">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="text-sm"></p>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav active" id="main-bottom-nav">
        <div class="bottom-nav-handle" id="bottom-nav-handle"><i class="fas fa-chevron-up"></i></div>
        <a href="./Dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>InÃ­cio</span></a>
        <a href="./Agenda de eventos.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a>
        <a href="./Sistema GestÃ£o Financeira.html" class="nav-item"><i class="fas fa-wallet"></i><span>Financeiro</span></a>
        <a href="./Sistema de CRM.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
        <a href="#" class="nav-item active"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></a>
    </nav>

    <script type="module">
        import { getToken } from './js/auth.js';
        import { API_BASE_URL } from './js/api.js';

        const BASE = `${API_BASE_URL}/api/whatsapp`;
        const token = getToken();
        const headers = () => ({ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' });

        // --- STATE ---
        let currentInstance = new URLSearchParams(window.location.search).get('instance') || 'aero-festas';
        let conversations = [];
        let currentConversationId = null;
        let currentConversation = null;
        let messages = [];
        let messagesPage = 1;
        let isLoadingMore = false;
        let hasMoreMessages = true;
        let pollInterval = null;
        let pollTimer = null;
        let lastPollTime = new Date().toISOString();
        let instances = [];
        let userData = null;
        let filterUnreadOnly = false;

        try { userData = JSON.parse(localStorage.getItem('userData')); } catch(e) {}

        // --- API ---
        const api = {
            getInstances: async () => {
                try { const r = await fetch(`${BASE}/instances`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            getConversations: async (instance, search = '') => {
                try {
                    const params = new URLSearchParams({ instance, search, limit: '100' });
                    const r = await fetch(`${BASE}/conversations?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            getMessages: async (convId, page = 1, before = null) => {
                try {
                    let url = `${BASE}/conversations/${convId}/messages?limit=80`;
                    if (before) url += `&before=${encodeURIComponent(before)}`;
                    else if (page) url += `&page=${page}`;
                    const r = await fetch(url, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            getOlderMessages: async (convId, beforeTimestamp) => {
                try {
                    const r = await fetch(`${BASE}/conversations/${convId}/messages/older?before=${encodeURIComponent(beforeTimestamp)}&limit=30`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            poll: async (instance, since, conversationId) => {
                try {
                    const params = new URLSearchParams({ instance });
                    if (since) params.set('since', since);
                    if (conversationId) params.set('conversationId', conversationId);
                    const r = await fetch(`${BASE}/poll?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            send: async (instanceName, remoteJid, text) => {
                try {
                    const r = await fetch(`${BASE}/send`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, text })
                    });
                    return await r.json(); // Retorna sempre (erro ou sucesso)
                } catch(e) { return { error: e.message }; }
            },
            sendMedia: async (instanceName, remoteJid, mediaType, media, caption, fileName, mimetype) => {
                try {
                    const r = await fetch(`${BASE}/send-media`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, mediaType, media, caption, fileName, mimetype })
                    });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getCatalog: async (instanceName) => {
                try { const r = await fetch(`${BASE}/catalog/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            sendCatalog: async (data) => {
                try {
                    const r = await fetch(`${BASE}/send-catalog`, { method: 'POST', headers: headers(), body: JSON.stringify(data) });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getShortcuts: async () => {
                try { const r = await fetch(`${BASE}/shortcuts`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            createShortcut: async (data) => {
                try { const r = await fetch(`${BASE}/shortcuts`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateShortcut: async (id, data) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'PUT', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            deleteShortcut: async (id) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'DELETE', headers: headers() }); return r.ok; } catch(e) { return false; }
            },
            markRead: async (convId) => {
                try { await fetch(`${BASE}/conversations/${convId}/read`, { method: 'PUT', headers: headers() }); } catch(e) {}
            },
            getUnreadCount: async () => {
                try { const r = await fetch(`${BASE}/unread-count`, { headers: headers() }); return r.ok ? await r.json() : {}; } catch(e) { return {}; }
            },
            connect: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/connect`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getQR: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/qr`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getProfilePic: async (instanceName, number) => {
                try { const r = await fetch(`${BASE}/profile-pic/${instanceName}/${number}`, { headers: headers() }); return r.ok ? await r.json() : { profilePicUrl: null }; } catch(e) { return { profilePicUrl: null }; }
            },
            downloadMedia: async (messageId) => {
                try {
                    const r = await fetch(`${BASE}/download-media`, { method: 'POST', headers: headers(), body: JSON.stringify({ messageId }) });
                    return r.ok ? await r.json() : { mediaUrl: null };
                } catch(e) { return { mediaUrl: null }; }
            },
            getPresence: async (instanceName, remoteJid) => {
                try { const r = await fetch(`${BASE}/presence/${instanceName}/${encodeURIComponent(remoteJid)}`, { headers: headers() }); return r.ok ? await r.json() : { presence: null }; } catch(e) { return { presence: null }; }
            },
            // --- NEW v2.0 APIs ---
            getContacts: async (instanceName) => {
                try { const r = await fetch(`${BASE}/contacts/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            sendContact: async (data) => {
                try { const r = await fetch(`${BASE}/send-contact`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getGroups: async (instanceName) => {
                try {
                    const r = await fetch(`${BASE}/groups/${instanceName}`, { headers: headers() });
                    if (r.ok) return await r.json();
                    const err = await r.json().catch(() => ({}));
                    throw new Error(err.error || `Erro ${r.status}`);
                } catch(e) { throw e; }
            },
            getConversationsFiltered: async (instance, opts = {}) => {
                try {
                    const params = new URLSearchParams({ instance, limit: '100', ...opts });
                    const r = await fetch(`${BASE}/conversations?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            archiveConversation: async (convId, archive) => {
                try { const r = await fetch(`${BASE}/conversations/${convId}/archive`, { method: 'PUT', headers: headers(), body: JSON.stringify({ archive }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            muteConversation: async (convId, mute, duration) => {
                try { const r = await fetch(`${BASE}/conversations/${convId}/mute`, { method: 'PUT', headers: headers(), body: JSON.stringify({ mute, duration }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getProfile: async (instanceName) => {
                try { const r = await fetch(`${BASE}/profile/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateProfile: async (instanceName, data) => {
                try { const r = await fetch(`${BASE}/profile/${instanceName}`, { method: 'PUT', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getStatus: async (instanceName) => {
                try { const r = await fetch(`${BASE}/status/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            postStatus: async (instanceName, data) => {
                try { const r = await fetch(`${BASE}/status/${instanceName}`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            syncConversation: async (convId) => {
                try { const r = await fetch(`${BASE}/sync-conversation/${convId}`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            syncHistory: async (instanceName) => {
                try { const r = await fetch(`${BASE}/sync-history/${instanceName}`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            syncContacts: async (instanceName) => {
                try { const r = await fetch(`${BASE}/sync-contacts/${instanceName}`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            disconnect: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/disconnect`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            ensureConversation: async (instanceName, remoteJid, contactName, isGroup) => {
                try { const r = await fetch(`${BASE}/ensure-conversation`, { method: 'POST', headers: headers(), body: JSON.stringify({ instanceName, remoteJid, contactName, isGroup }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getGroupDetails: async (instanceName, groupJid) => {
                try { const r = await fetch(`${BASE}/groups/${instanceName}/${encodeURIComponent(groupJid)}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateGroupSubject: async (instanceName, groupJid, subject) => {
                try { const r = await fetch(`${BASE}/groups/${instanceName}/${encodeURIComponent(groupJid)}/subject`, { method: 'PUT', headers: headers(), body: JSON.stringify({ subject }) }); return r.ok; } catch(e) { return false; }
            },
            updateGroupDescription: async (instanceName, groupJid, description) => {
                try { const r = await fetch(`${BASE}/groups/${instanceName}/${encodeURIComponent(groupJid)}/description`, { method: 'PUT', headers: headers(), body: JSON.stringify({ description }) }); return r.ok; } catch(e) { return false; }
            },
            updateGroupParticipants: async (instanceName, groupJid, action, participants) => {
                try { const r = await fetch(`${BASE}/groups/${instanceName}/${encodeURIComponent(groupJid)}/participants`, { method: 'POST', headers: headers(), body: JSON.stringify({ action, participants }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            leaveGroup: async (instanceName, groupJid) => {
                try { const r = await fetch(`${BASE}/groups/${instanceName}/${encodeURIComponent(groupJid)}/leave`, { method: 'POST', headers: headers() }); return r.ok; } catch(e) { return false; }
            },
            deleteConversation: async (id) => {
                try { const r = await fetch(`${BASE}/conversations/${encodeURIComponent(id)}`, { method: 'DELETE', headers: headers() }); return r.ok ? await r.json() : { success: false }; } catch(e) { return { success: false }; }
            },
            bulkDeleteOld: async (instance, days = 90) => {
                try { const r = await fetch(`${BASE}/conversations/bulk-old?instance=${encodeURIComponent(instance)}&days=${days}`, { method: 'DELETE', headers: headers() }); return r.ok ? await r.json() : { success: false, deleted: 0 }; } catch(e) { return { success: false, deleted: 0 }; }
            },
            cleanupLid: async () => {
                try { const r = await fetch(`${BASE}/conversations/cleanup-lid`, { method: 'DELETE', headers: headers() }); return r.ok ? await r.json() : { success: false, deleted: 0 }; } catch(e) { return { success: false, deleted: 0 }; }
            }
        };

        // --- SHORTCUTS STATE ---
        let shortcuts = [];

        // --- PROFILE PIC CACHE ---
        const profilePicCache = {}; // { phoneNumber: url | null }

        // --- HELPERS ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatTime(dateStr) {
            return new Date(dateStr).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatRelative(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const diff = now - d;
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today - 86400000);

            if (d >= today) return formatTime(dateStr);
            if (d >= yesterday) return 'Ontem';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').filter(n => n).map(n => n[0]).slice(0, 2).join('').toUpperCase();
        }

        // showToast defined below after all features

        // --- RENDER: INSTANCE TABS ---
        function setupInstanceTabs() {
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentInstance = tab.dataset.instance;
                    document.querySelectorAll('.instance-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentConversationId = null;
                    currentConversation = null;
                    showChatWelcome();
                    loadConversations();
                    updateConnectionStatus();
                    // Atualiza URL sem recarregar
                    history.replaceState(null, '', `WhatsApp.html?instance=${currentInstance}`);
                    // Sync contatos ao trocar de instÃ¢ncia (background)
                    api.syncContacts(currentInstance).then(r => {
                        if (r?.created > 0 || r?.updated > 0) loadConversations();
                    }).catch(() => {});
                });
            });
        }

        // --- RENDER: CONNECTION STATUS ---
        function updateConnectionStatus() {
            const inst = instances.find(i => i.instanceName === currentInstance);
            const dot = document.getElementById('connection-status-dot');
            const dotMobile = document.getElementById('connection-status-dot-mobile');
            const text = document.getElementById('connection-status-text');
            const connectBtn = document.getElementById('connect-btn');

            if (!inst) {
                dot.className = 'status-dot disconnected';
                if (dotMobile) dotMobile.className = 'status-dot disconnected';
                text.textContent = 'NÃ£o configurado';
                connectBtn.classList.add('hidden');
                return;
            }

            dot.className = `status-dot ${inst.status}`;
            if (dotMobile) dotMobile.className = `status-dot ${inst.status}`;
            const statusMap = { connected: 'Conectado', disconnected: 'Desconectado', connecting: 'Conectando...', qr_pending: 'Aguardando QR...' };
            text.textContent = statusMap[inst.status] || inst.status;
            if (inst.phoneNumber) text.textContent += ` (${inst.phoneNumber})`;

            // Show connect button for admins when disconnected
            if (userData?.isAdmin && inst.status !== 'connected') {
                connectBtn.classList.remove('hidden');
                connectBtn.onclick = () => showQRModal(currentInstance);
            } else {
                connectBtn.classList.add('hidden');
            }
        }

        // --- RENDER: CONVERSATION LIST ---
        window.toggleUnreadFilter = function() {
            filterUnreadOnly = !filterUnreadOnly;
            const btn = document.getElementById('filter-unread-btn');
            if (btn) {
                btn.classList.toggle('bg-green-100', filterUnreadOnly);
                btn.classList.toggle('text-green-700', filterUnreadOnly);
                btn.classList.toggle('bg-gray-100', !filterUnreadOnly);
                btn.classList.toggle('text-gray-500', !filterUnreadOnly);
            }
            renderConversationList();
        };

        function renderConversationList() {
            const listEl = document.getElementById('conversation-list');
            const search = document.getElementById('search-conversations').value.toLowerCase().trim();

            // FILTRAR: grupos ficam SOMENTE no painel de grupos, nÃ£o na lista de chats
            let filtered = conversations.filter(c => !c.isGroup);

            if (search) {
                filtered = filtered.filter(c =>
                    (c.contactName || '').toLowerCase().includes(search) ||
                    c.phoneNumber.includes(search.replace(/\D/g, ''))
                );
            }
            if (filterUnreadOnly) {
                filtered = filtered.filter(c => c.unreadCount > 0);
            }

            // Update archived count
            if (!showingArchived) {
                const archivedBar = document.getElementById('archived-bar');
                const archivedCount = document.getElementById('archived-count');
                if (archivedBar && archivedCount) {
                    const archCount = conversations.filter(c => c.isArchived).length;
                    // We filter non-archived for display, but track archived count
                    archivedCount.textContent = archCount;
                    if (archCount > 0) archivedBar.classList.remove('hidden');
                    else archivedBar.classList.add('hidden');
                }
            }

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                    <div class="text-center">
                        <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                        <p>${search ? 'Nenhuma conversa encontrada' : 'Nenhuma conversa ainda'}</p>
                    </div>
                </div>`;
                return;
            }

            listEl.innerHTML = '';
            filtered.forEach(conv => {
                const div = document.createElement('div');
                const isActive = conv.id === currentConversationId;
                div.className = `conv-item p-3 cursor-pointer flex items-center gap-3 border-b border-gray-100/50 ${isActive ? 'active' : ''}`;

                const initials = getInitials(conv.contactName || conv.phoneNumber);
                const unread = conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount > 99 ? '99+' : conv.unreadCount}</span>` : '';
                const crmIcon = conv.clientId ? '<i class="fas fa-link text-indigo-400 text-[10px]" title="Vinculado ao CRM"></i>' : '';
                const mutedIcon = conv.isMuted ? ' <i class="fas fa-bell-slash muted-icon" title="Silenciado"></i>' : '';
                const groupIcon = conv.isGroup ? '<i class="fas fa-users text-teal-400 text-[10px] mr-0.5" title="Grupo"></i>' : '';
                const preview = conv.lastMessagePreview || '';
                const time = formatRelative(conv.lastMessageAt);
                // cachedPic: prioriza cache in-memory, depois banco, depois vazio
                const cachedPic = profilePicCache[conv.phoneNumber] || conv.profilePicUrl || '';
                const hasStatus = statusCache.some(s => (s.participant || '').includes(conv.phoneNumber.replace(/\D/g, '')));
                const statusRingClass = hasStatus ? 'status-ring' : '';

                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 overflow-hidden ${statusRingClass}" data-phone="${conv.phoneNumber}">
                        ${cachedPic ? `<img src="${cachedPic}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">` : initials}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm truncate ${conv.unreadCount > 0 ? 'text-gray-900' : 'text-gray-700'}">${groupIcon}${escapeHtml(conv.contactName || conv.phoneNumber)}${mutedIcon} ${crmIcon}</span>
                            <span class="text-[11px] text-gray-400 flex-shrink-0 ml-2">${time}</span>
                        </div>
                        <div class="flex justify-between items-center mt-0.5">
                            <p class="text-xs truncate ${conv.unreadCount > 0 ? 'text-gray-800 font-medium' : 'text-gray-500'}">${escapeHtml(preview)}</p>
                            ${unread}
                        </div>
                    </div>
                `;

                div.addEventListener('click', () => openConversation(conv));
                listEl.appendChild(div);
            });

            // Carregar fotos de perfil assincronamente
            loadProfilePics(filtered);
        }

        let _loadingPics = false;
        async function loadProfilePics(convList) {
            if (_loadingPics) return;
            _loadingPics = true;
            try {
                // Filtra: nÃ£o estÃ¡ no cache E nÃ£o tem foto salva no banco
                const pending = convList.filter(c => c.phoneNumber && !(c.phoneNumber in profilePicCache) && !c.profilePicUrl);
                // Processa em batches de 5 para velocidade sem sobrecarregar
                for (let i = 0; i < pending.length; i += 5) {
                    const batch = pending.slice(i, i + 5);
                    await Promise.allSettled(batch.map(async conv => {
                        profilePicCache[conv.phoneNumber] = ''; // marca como tentando
                        try {
                            const data = await api.getProfilePic(currentInstance, conv.phoneNumber);
                            if (data?.profilePicUrl) {
                                profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                                const avatarEl = document.querySelector(`[data-phone="${CSS.escape(conv.phoneNumber)}"]`);
                                if (avatarEl) {
                                    const initials = getInitials(conv.contactName || conv.phoneNumber);
                                    avatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                                }
                            }
                        } catch (e) { /* silenciar â€” mantÃ©m '' no cache */ }
                    }));
                }
            } finally {
                _loadingPics = false;
            }
        }

        // --- OPEN CONVERSATION ---
        async function openConversation(conv) {
            currentConversationId = conv.id;
            currentConversation = conv;
            messagesPage = 1;
            hasMoreMessages = true;
            messages = [];

            // === 1. UI IMEDIATA â€” sem await, usuÃ¡rio vÃª o chat na hora ===
            document.getElementById('chat-contact-name').textContent = conv.contactName || conv.phoneNumber;
            document.getElementById('chat-contact-phone').textContent = conv.phoneNumber;
            const chatAvatarEl = document.getElementById('chat-avatar');
            const initials = getInitials(conv.contactName || conv.phoneNumber);
            const pic = profilePicCache[conv.phoneNumber] || conv.profilePicUrl;
            if (pic) {
                chatAvatarEl.innerHTML = `<img src="${pic}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
            } else {
                chatAvatarEl.textContent = initials;
                // Foto de perfil em background â€” nÃ£o bloqueia abertura
                api.getProfilePic(currentInstance, conv.phoneNumber).then(data => {
                    if (data?.profilePicUrl) {
                        profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                        chatAvatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                    }
                });
            }

            // CRM link
            const crmBtn = document.getElementById('link-crm-btn');
            if (conv.clientId) {
                crmBtn.classList.remove('hidden');
                crmBtn.onclick = () => window.open(`Sistema de CRM.html?clientId=${conv.clientId}`, '_blank');
            } else {
                crmBtn.classList.add('hidden');
            }

            updateChatHeaderButtons();

            // Mostra painel imediatamente
            const chatPanel = document.getElementById('chat-panel');
            chatPanel.classList.remove('mobile-hidden');
            const welcomeEl = document.getElementById('chat-welcome');
            if (welcomeEl) welcomeEl.classList.add('hidden');
            document.getElementById('input-bar').classList.remove('hidden');

            const sidePanel = document.getElementById('conversation-panel');
            if (window.innerWidth < 1024) sidePanel.classList.add('mobile-hidden');

            closeContactDetails();

            // === 2. MENSAGENS + MARK READ em paralelo ===
            const syncBanner = document.getElementById('sync-banner');
            syncBanner.classList.add('hidden');

            const [,] = await Promise.all([
                loadMessages(),
                // markRead: fire-and-forget mas aguardado junto com loadMessages
                (conv.unreadCount > 0 && conv.id)
                    ? api.markRead(conv.id).then(() => { conv.unreadCount = 0; })
                    : Promise.resolve()
            ]);

            // Atualiza lista uma Ãºnica vez
            renderConversationList();

            // === 3. Banner informativo quando nÃ£o hÃ¡ mensagens ===
            if (messages.length === 0 && conv.id) {
                syncBanner.classList.remove('hidden');
                syncBanner.innerHTML = `
                    <span class="text-gray-500 text-xs">
                        <i class="fas fa-info-circle mr-1"></i>
                        Nenhuma mensagem salva. Novas mensagens aparecerÃ£o automaticamente.
                        <button onclick="syncCurrentConversation()" class="ml-2 text-green-600 font-semibold hover:underline">
                            <i class="fas fa-download mr-0.5"></i>Buscar histÃ³rico
                        </button>
                    </span>
                `;
            }

            // Reset poll baseline para pegar mensagens que cheguem agora
            lastPollTime = new Date().toISOString();
        }

        // --- LOAD MESSAGES ---
        async function loadMessages() {
            if (!currentConversationId) { messages = []; renderMessages(true); return; }
            const data = await api.getMessages(currentConversationId, messagesPage);
            if (data.length < 80) hasMoreMessages = false;

            // API returns newest first, reverse for display
            const newMsgs = data.reverse();

            if (messagesPage === 1) {
                messages = newMsgs;
            } else {
                messages = [...newMsgs, ...messages];
            }

            renderMessages(messagesPage === 1);
        }

        // --- RENDER MESSAGES ---
        function renderMediaContent(msg) {
            const url = msg.mediaUrl;
            const type = msg.messageType;
            const caption = msg.content && !msg.content.startsWith('[') ? msg.content : '';

            if (type === 'image' && url) {
                return `<div class="media-bubble"><img src="${escapeHtml(url)}" alt="imagem" loading="lazy" onclick="window.open('${escapeHtml(url)}','_blank')"></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'video' && url) {
                return `<div class="media-bubble"><video src="${escapeHtml(url)}" controls preload="metadata" style="max-height:300px;"></video></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'audio') {
                // Se for data URI (Ã¡udio enviado por nÃ³s, armazenado localmente), toca direto
                if (url && url.startsWith('data:')) {
                    return `<div class="media-bubble" style="min-width:220px;"><audio src="${escapeHtml(url)}" controls preload="metadata" style="width:100%;max-width:300px;"></audio></div>`;
                }
                // Para URLs CDN do WhatsApp (expiram) ou sem URL: sempre baixar sob demanda
                return `<div class="media-bubble" style="min-width:220px;" id="audio-${escapeHtml(msg.id)}">
                    <div class="flex items-center gap-2 cursor-pointer text-green-600 hover:text-green-700" onclick="loadAudioMedia('${escapeHtml(msg.id)}')">
                        <i class="fas fa-play-circle text-2xl"></i>
                        <div>
                            <p class="text-sm font-medium">Ãudio</p>
                            <p class="text-[10px] text-gray-400">Toque para ouvir</p>
                        </div>
                        <i class="fas fa-download text-xs text-gray-400 ml-auto"></i>
                    </div>
                </div>`;
            }
            if (type === 'document' && url) {
                const name = msg.mediaName || 'Documento';
                const isPdf = (msg.mediaMimetype || '').includes('pdf') || name.toLowerCase().endsWith('.pdf');
                if (isPdf) {
                    // PDF: botÃ£o para abrir viewer inline
                    return `<div style="min-width:220px;">
                        <div class="flex items-center gap-2 p-2 bg-white/50 rounded-lg">
                            <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                            <div class="min-w-0 flex-1"><p class="text-sm font-medium truncate">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">PDF</p></div>
                        </div>
                        <div class="flex gap-1 mt-1">
                            <button class="flex-1 text-[11px] bg-red-50 text-red-600 py-1.5 rounded-lg font-semibold hover:bg-red-100 transition" onclick="openPdfViewer('${escapeHtml(url)}','${escapeHtml(name)}')"><i class="fas fa-eye mr-1"></i>Visualizar</button>
                            <button class="flex-1 text-[11px] bg-gray-50 text-gray-600 py-1.5 rounded-lg font-semibold hover:bg-gray-100 transition" onclick="openPdfNewTab('${escapeHtml(url)}')"><i class="fas fa-external-link-alt mr-1"></i>Abrir</button>
                        </div>
                    </div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
                }
                return `<div class="flex items-center gap-2 p-2 bg-white/50 rounded-lg cursor-pointer" onclick="window.open('${escapeHtml(url)}','_blank')"><i class="fas fa-file-alt text-blue-500 text-lg"></i><div class="min-w-0"><p class="text-sm font-medium truncate">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">${msg.mediaMimetype || 'documento'}</p></div><i class="fas fa-download text-gray-400 text-xs ml-auto"></i></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            // Fallback: sem URL, apenas indicador
            const icon = type === 'image' ? 'image' : type === 'audio' ? 'microphone' : type === 'video' ? 'video' : type === 'sticker' ? 'note-sticky' : 'file';
            return `<p class="text-gray-400 italic text-xs"><i class="fas fa-${icon} mr-1"></i>${escapeHtml(msg.content)}</p>`;
        }

        // Carrega Ã¡udio sob demanda via Evolution API
        async function loadAudioMedia(messageId) {
            const container = document.getElementById(`audio-${messageId}`);
            if (!container) return;
            container.innerHTML = `<div class="flex items-center gap-2 text-gray-400"><i class="fas fa-spinner fa-spin"></i> <span class="text-xs">Carregando Ã¡udio...</span></div>`;

            try {
                const data = await api.downloadMedia(messageId);
                if (data.mediaUrl) {
                    container.innerHTML = `<audio src="${data.mediaUrl}" controls preload="auto" autoplay style="width:100%;max-width:300px;"></audio>`;
                    // Atualiza na lista local para nÃ£o precisar baixar de novo
                    const msg = messages.find(m => m.id === messageId);
                    if (msg) msg.mediaUrl = data.mediaUrl;
                } else {
                    container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>NÃ£o foi possÃ­vel carregar o Ã¡udio</p>`;
                }
            } catch (e) {
                container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>Erro ao carregar Ã¡udio</p>`;
            }
        }
        window.loadAudioMedia = loadAudioMedia;

        function renderMessages(scrollToBottom = true) {
            const area = document.getElementById('messages-area');
            area.innerHTML = '';

            let lastDate = null;

            messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString('pt-BR');

                if (msgDate !== lastDate) {
                    const sep = document.createElement('div');
                    sep.className = 'text-center my-3';
                    sep.innerHTML = `<span class="bg-white/80 text-gray-500 text-xs px-3 py-1 rounded-full shadow-sm">${msgDate}</span>`;
                    area.appendChild(sep);
                    lastDate = msgDate;
                }

                const bubble = document.createElement('div');
                bubble.className = `relative group p-2.5 ${msg.fromMe ? 'bubble-sent ml-auto' : 'bubble-received mr-auto'}`;
                bubble.dataset.msgId = msg.id;

                const time = formatTime(msg.timestamp);
                const statusIcon = msg.fromMe ? (
                    msg.status === 'played' ? '<i class="fas fa-check-double text-blue-400"></i> <span class="text-[9px] text-blue-400 font-medium">Reproduzido</span>' :
                    msg.status === 'read' ? '<i class="fas fa-check-double text-blue-400"></i>' :
                    msg.status === 'delivered' ? '<i class="fas fa-check-double text-gray-400"></i>' :
                    '<i class="fas fa-check text-gray-400"></i>'
                ) : '';

                const isMedia = msg.messageType !== 'text';
                const contentHtml = isMedia
                    ? renderMediaContent(msg)
                    : `<p class="whitespace-pre-wrap break-words text-sm">${escapeHtml(msg.content)}</p>`;

                // Show sender name in group messages
                const isGroup = currentConversation?.isGroup;
                const senderName = (isGroup && !msg.fromMe && msg.pushName) ? `<p class="text-[11px] font-semibold text-teal-600 mb-0.5">${escapeHtml(msg.pushName)}</p>` : '';

                // BotÃ£o de encaminhar (aparece no hover)
                const fwdBtnSide = msg.fromMe ? 'right-full mr-1' : 'left-full ml-1';
                bubble.innerHTML = `
                    ${senderName}
                    ${contentHtml}
                    <div class="text-right mt-1 flex items-center justify-end gap-1">
                        <span class="text-[10px] text-gray-400">${time}</span>
                        <span class="text-[10px]">${statusIcon}</span>
                    </div>
                    <button class="forward-btn absolute top-1/2 -translate-y-1/2 ${fwdBtnSide} opacity-0 group-hover:opacity-100 transition-opacity bg-white border border-gray-200 rounded-full w-7 h-7 flex items-center justify-center shadow-sm hover:bg-green-50 hover:border-green-300 text-gray-400 hover:text-green-600" title="Encaminhar" onclick="openForwardModal('${escapeHtml(msg.id)}')">
                        <i class="fas fa-share text-[11px]"></i>
                    </button>
                `;

                // Long-press para mobile
                let longPressTimer;
                bubble.addEventListener('touchstart', () => {
                    longPressTimer = setTimeout(() => openForwardModal(msg.id), 600);
                }, { passive: true });
                bubble.addEventListener('touchend', () => clearTimeout(longPressTimer));
                bubble.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                area.appendChild(bubble);
            });

            if (scrollToBottom) {
                area.scrollTop = area.scrollHeight;
            }
        }

        // --- INFINITE SCROLL (load older messages) ---
        document.getElementById('messages-area').addEventListener('scroll', async function() {
            if (this.scrollTop === 0 && hasMoreMessages && !isLoadingMore && currentConversationId) {
                isLoadingMore = true;
                document.getElementById('loading-more').classList.remove('hidden');

                const prevHeight = this.scrollHeight;
                const oldestTimestamp = messages.length > 0 ? messages[0].timestamp : null;

                if (oldestTimestamp) {
                    // 1. Tenta buscar do banco (cursor-based)
                    const dbOlder = await api.getMessages(currentConversationId, null, oldestTimestamp);
                    const olderMsgs = (Array.isArray(dbOlder) ? dbOlder : []).reverse();

                    if (olderMsgs.length > 0) {
                        // Filtra duplicatas
                        const existingIds = new Set(messages.map(m => m.id));
                        const newMsgs = olderMsgs.filter(m => !existingIds.has(m.id));
                        if (newMsgs.length > 0) {
                            messages = [...newMsgs, ...messages];
                            renderMessages(false);
                        } else {
                            // Banco retornou duplicatas â€” tenta Evolution API
                            const evoOlder = await api.getOlderMessages(currentConversationId, oldestTimestamp);
                            const evoMsgs = (Array.isArray(evoOlder) ? evoOlder : []).reverse();
                            const newEvoMsgs = evoMsgs.filter(m => !existingIds.has(m.id));
                            if (newEvoMsgs.length > 0) {
                                messages = [...newEvoMsgs, ...messages];
                                renderMessages(false);
                            } else {
                                hasMoreMessages = false;
                            }
                        }
                    } else {
                        // 2. Banco vazio â€” busca da Evolution API (salva automaticamente)
                        const evoOlder = await api.getOlderMessages(currentConversationId, oldestTimestamp);
                        const evoMsgs = (Array.isArray(evoOlder) ? evoOlder : []).reverse();
                        const existingIds = new Set(messages.map(m => m.id));
                        const newEvoMsgs = evoMsgs.filter(m => !existingIds.has(m.id));
                        if (newEvoMsgs.length > 0) {
                            messages = [...newEvoMsgs, ...messages];
                            renderMessages(false);
                        } else {
                            hasMoreMessages = false;
                        }
                    }
                } else {
                    hasMoreMessages = false;
                }

                // Manter scroll position
                this.scrollTop = this.scrollHeight - prevHeight;
                document.getElementById('loading-more').classList.add('hidden');
                isLoadingMore = false;
            }
        });

        // --- SEND MESSAGE ---
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentConversation) return;

            input.value = '';
            input.style.height = 'auto';
            toggleSendAudioBtn();

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(),
                fromMe: true,
                content: text,
                timestamp: new Date().toISOString(),
                messageType: 'text',
                status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            const result = await api.send(currentInstance, currentConversation.remoteJid, text);
            if (result && !result.error) {
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
                // If new conversation (no ID yet), refresh to get the conversation ID
                if (!currentConversationId) {
                    await loadConversations();
                    const conv = conversations.find(c => c.remoteJid === currentConversation.remoteJid);
                    if (conv) { currentConversationId = conv.id; currentConversation = conv; }
                }
            } else {
                const errMsg = result?.error || result?.details?.message || 'Erro ao enviar mensagem';
                showToast(errMsg, 'error');
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                input.value = text;
            }
        }

        // Toggle between send button and audio button
        function toggleSendAudioBtn() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const audioBtn = document.getElementById('audio-btn');
            const hasText = input.value.trim().length > 0;
            sendBtn.style.display = hasText ? 'flex' : 'none';
            audioBtn.style.display = hasText ? 'none' : 'flex';
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        document.getElementById('message-input').addEventListener('input', function() {
            toggleSendAudioBtn();
            handleShortcutPopup(this.value);
        });

        // --- ATTACH MENU ---
        const attachMenu = document.getElementById('attach-menu');
        let attachMenuOpen = false;
        function openAttachMenu() {
            const btn = document.getElementById('attach-btn');
            const rect = btn.getBoundingClientRect();
            attachMenu.style.cssText = `display:block; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.15); padding:12px; z-index:99999; left:${rect.left}px; bottom:${window.innerHeight - rect.top + 8}px;`;
            attachMenuOpen = true;
        }
        function closeAttachMenu() {
            attachMenu.style.display = 'none';
            attachMenuOpen = false;
        }

        document.getElementById('attach-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (attachMenuOpen) {
                closeAttachMenu();
            } else {
                openAttachMenu();
            }
        });
        document.addEventListener('click', () => closeAttachMenu());
        attachMenu.addEventListener('click', (e) => e.stopPropagation());

        document.querySelectorAll('.attach-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAttachMenu();
                const action = item.dataset.action;
                if (action === 'image') document.getElementById('file-input-image').click();
                else if (action === 'video') document.getElementById('file-input-video').click();
                else if (action === 'document') document.getElementById('file-input-document').click();
                else if (action === 'catalog') openCatalogModal();
                else if (action === 'contact') openSendContactModal();
                else if (action === 'shortcuts-manage') openShortcutsModal();
            });
        });

        // --- FILE INPUT HANDLERS ---
        let pendingMedia = null;

        function handleFileSelect(e, mediaType) {
            const file = e.target.files[0];
            if (!file) return;
            e.target.value = '';

            const maxSize = 16 * 1024 * 1024; // 16MB
            if (file.size > maxSize) {
                showToast('Arquivo muito grande (mÃ¡x 16MB)', true);
                return;
            }

            pendingMedia = { file, mediaType, fileName: file.name, mimetype: file.type };

            // Show preview modal
            const preview = document.getElementById('media-preview-content');
            const info = document.getElementById('media-file-info');
            const caption = document.getElementById('media-caption');
            caption.value = '';
            info.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

            if (mediaType === 'image') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<img src="${url}" style="max-height:50vh; object-fit:contain; border-radius:12px;">`;
            } else if (mediaType === 'video') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<video src="${url}" controls style="max-height:50vh; border-radius:12px;"></video>`;
            } else {
                const icon = file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-file-alt text-blue-500';
                preview.innerHTML = `<div class="flex flex-col items-center justify-center py-8"><i class="fas ${icon} text-5xl mb-3"></i><p class="text-sm text-gray-600">${escapeHtml(file.name)}</p></div>`;
            }

            document.getElementById('media-preview-modal').classList.remove('modal-hidden');
        }

        document.getElementById('file-input-image').addEventListener('change', (e) => handleFileSelect(e, 'image'));
        document.getElementById('file-input-video').addEventListener('change', (e) => handleFileSelect(e, 'video'));
        document.getElementById('file-input-document').addEventListener('change', (e) => handleFileSelect(e, 'document'));

        document.getElementById('cancel-send-media').addEventListener('click', () => {
            document.getElementById('media-preview-modal').classList.add('modal-hidden');
            pendingMedia = null;
        });

        document.getElementById('confirm-send-media').addEventListener('click', async () => {
            if (!pendingMedia || !currentConversation) return;
            document.getElementById('media-preview-modal').classList.add('modal-hidden');

            const caption = document.getElementById('media-caption').value.trim();
            const { file, mediaType, fileName, mimetype } = pendingMedia;
            pendingMedia = null;

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(), fromMe: true,
                content: caption || `[${mediaType}]`,
                timestamp: new Date().toISOString(), messageType: mediaType, status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            // Convert file to base64
            const base64 = await fileToBase64(file);

            const result = await api.sendMedia(
                currentInstance, currentConversation.remoteJid,
                mediaType, base64, caption || undefined, fileName, mimetype
            );

            if (result) {
                // Guardar mÃ­dia localmente para preview imediato
                if (!result.mediaUrl) result.mediaUrl = `data:${mimetype};base64,${base64}`;
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
                showToast('MÃ­dia enviada!');
            } else {
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                showToast('Erro ao enviar mÃ­dia', true);
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove o prefixo data:xxx;base64, â€” Evolution API quer raw base64
                    const result = reader.result.split(',')[1];
                    resolve(result);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- AUDIO RECORDING ---
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;

        document.getElementById('audio-btn').addEventListener('click', startRecording);

        async function startRecording() {
            if (!currentConversation) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => { stream.getTracks().forEach(t => t.stop()); };
                mediaRecorder.start();

                // Show recording UI
                document.querySelector('#input-bar .relative').style.setProperty('display', 'none', 'important');
                document.getElementById('recording-bar').style.setProperty('display', 'flex', 'important');
                recordingSeconds = 0;
                document.getElementById('recording-time').textContent = '0:00';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const m = Math.floor(recordingSeconds / 60);
                    const s = (recordingSeconds % 60).toString().padStart(2, '0');
                    document.getElementById('recording-time').textContent = `${m}:${s}`;
                }, 1000);
            } catch (err) {
                showToast('NÃ£o foi possÃ­vel acessar o microfone', true);
            }
        }

        document.getElementById('cancel-recording').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            stopRecordingUI();
        });

        document.getElementById('send-recording').addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

            mediaRecorder.onstop = async () => {
                mediaRecorder.stream?.getTracks().forEach(t => t.stop());
                stopRecordingUI();

                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const base64 = await blobToBase64(blob);

                // Optimistic UI
                const tempMsg = {
                    id: 'temp-' + Date.now(), fromMe: true,
                    content: '[audio]', timestamp: new Date().toISOString(),
                    messageType: 'audio', status: 'sending'
                };
                messages.push(tempMsg);
                renderMessages(true);

                const result = await api.sendMedia(
                    currentInstance, currentConversation.remoteJid,
                    'audio', base64, undefined, 'audio.ogg', 'audio/ogg'
                );

                if (result) {
                    // Guardar o Ã¡udio localmente para poder reproduzir
                    if (!result.mediaUrl) result.mediaUrl = `data:audio/webm;base64,${base64}`;
                    const idx = messages.findIndex(m => m.id === tempMsg.id);
                    if (idx >= 0) messages[idx] = result;
                    renderMessages(true);
                } else {
                    messages = messages.filter(m => m.id !== tempMsg.id);
                    renderMessages(true);
                    showToast('Erro ao enviar Ã¡udio', true);
                }
            };
            mediaRecorder.stop();
        });

        function stopRecordingUI() {
            clearInterval(recordingTimer);
            document.querySelector('#input-bar .relative').style.setProperty('display', 'flex', 'important');
            document.getElementById('recording-bar').style.setProperty('display', 'none', 'important');
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // --- SHORTCUTS POPUP (when typing /) ---
        function handleShortcutPopup(value) {
            const popup = document.getElementById('shortcuts-popup');
            if (!value.startsWith('/') || value.includes(' ')) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }
            const query = value.slice(1).toLowerCase();
            const filtered = shortcuts.filter(s => s.command.startsWith(query));

            if (filtered.length === 0 && query === '') {
                // Posicionar e mostrar dica
                const input = document.getElementById('message-input');
                const inputRect = input.getBoundingClientRect();
                popup.style.left = inputRect.left + 'px';
                popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
                popup.style.width = inputRect.width + 'px';
                popup.style.setProperty('display', 'block', 'important');
                popup.innerHTML = `<div class="p-3 text-center text-gray-400 text-xs">
                    <p>Nenhum atalho configurado.</p>
                    <p class="mt-1">Use o menu <i class="fas fa-paperclip"></i> â†’ <i class="fas fa-bolt"></i> Atalhos para criar.</p>
                </div>`;
                return;
            }
            if (filtered.length === 0) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }

            // Posicionar o popup acima do textarea
            const input = document.getElementById('message-input');
            const inputRect = input.getBoundingClientRect();
            popup.style.left = inputRect.left + 'px';
            popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
            popup.style.width = inputRect.width + 'px';

            popup.style.setProperty('display', 'block', 'important');
            popup.innerHTML = filtered.map(s => `
                <div class="shortcut-item" data-command="${escapeHtml(s.command)}">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-green-700">/${escapeHtml(s.command)}</span>
                        <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate mt-0.5">${escapeHtml(s.content.substring(0, 80))}</p>
                </div>
            `).join('');

            popup.querySelectorAll('.shortcut-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cmd = item.dataset.command;
                    const shortcut = shortcuts.find(s => s.command === cmd);
                    if (shortcut) {
                        document.getElementById('message-input').value = shortcut.content;
                        toggleSendAudioBtn();
                    }
                    popup.style.setProperty('display', 'none', 'important');
                });
            });
        }

        // --- CATALOG MODAL ---
        async function openCatalogModal() {
            if (!currentConversation) { showToast('Selecione uma conversa primeiro', true); return; }
            document.getElementById('catalog-modal').classList.remove('modal-hidden');
            const content = document.getElementById('catalog-content');
            content.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando catÃ¡logo...</p></div>';

            const catalog = await api.getCatalog(currentInstance);
            if (!catalog || (Array.isArray(catalog) && catalog.length === 0)) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto no catÃ¡logo.</p><p class="text-gray-400 text-xs mt-1">Configure o catÃ¡logo no WhatsApp Business do celular.</p></div>';
                return;
            }

            const products = Array.isArray(catalog) ? catalog : (catalog.products || catalog.data || [catalog]);
            if (products.length === 0) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto encontrado.</p></div>';
                return;
            }

            content.innerHTML = `<div class="catalog-grid">${products.map((p, i) => {
                const name = p.name || p.title || `Produto ${i+1}`;
                const img = p.imageUrl || p.image || p.thumbnailUrl || '';
                const price = p.price ? `R$ ${(p.price / 100).toFixed(2)}` : '';
                return `<div class="catalog-item" data-idx="${i}">
                    ${img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy">` : '<div class="h-[120px] bg-gray-100 flex items-center justify-center"><i class="fas fa-image text-2xl text-gray-300"></i></div>'}
                    <div class="p-2">
                        <p class="text-xs font-semibold truncate">${escapeHtml(name)}</p>
                        ${price ? `<p class="text-xs text-green-600 font-bold">${price}</p>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;

            content.querySelectorAll('.catalog-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const idx = parseInt(item.dataset.idx);
                    const p = products[idx];
                    document.getElementById('catalog-modal').classList.add('modal-hidden');

                    const tempMsg = {
                        id: 'temp-' + Date.now(), fromMe: true,
                        content: `ðŸ“¦ ${p.name || 'Produto'}`,
                        timestamp: new Date().toISOString(), messageType: 'text', status: 'sending'
                    };
                    messages.push(tempMsg);
                    renderMessages(true);

                    const result = await api.sendCatalog({
                        instanceName: currentInstance,
                        remoteJid: currentConversation.remoteJid,
                        productName: p.name || p.title,
                        productImage: p.imageUrl || p.image || p.thumbnailUrl,
                        productUrl: p.url || '',
                        caption: p.description || ''
                    });

                    if (result) {
                        const idx2 = messages.findIndex(m => m.id === tempMsg.id);
                        if (idx2 >= 0) messages[idx2] = result;
                        renderMessages(true);
                        showToast('Produto enviado!');
                    } else {
                        messages = messages.filter(m => m.id !== tempMsg.id);
                        renderMessages(true);
                        showToast('Erro ao enviar produto', true);
                    }
                });
            });
        }

        document.getElementById('close-catalog-modal').addEventListener('click', () => {
            document.getElementById('catalog-modal').classList.add('modal-hidden');
        });

        // --- SHORTCUTS MANAGER MODAL ---
        async function openShortcutsModal() {
            document.getElementById('shortcuts-modal').classList.remove('modal-hidden');
            document.getElementById('shortcut-form').style.display = 'none';
            await loadShortcuts();
            renderShortcutsList();
        }

        async function loadShortcuts() {
            shortcuts = await api.getShortcuts();
        }

        function renderShortcutsList() {
            const list = document.getElementById('shortcuts-list');
            if (shortcuts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>';
                return;
            }
            list.innerHTML = shortcuts.map(s => `
                <div class="bg-gray-50 rounded-xl p-3 flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-green-700">/${escapeHtml(s.command)}</span>
                            <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(s.content.substring(0, 100))}</p>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button class="text-blue-500 hover:text-blue-700 p-1" onclick="editShortcut('${s.id}')"><i class="fas fa-pen text-xs"></i></button>
                        <button class="text-red-400 hover:text-red-600 p-1" onclick="deleteShortcut('${s.id}')"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Expose to global scope for onclick
        window.editShortcut = function(id) {
            const s = shortcuts.find(x => x.id === id);
            if (!s) return;
            document.getElementById('shortcut-edit-id').value = id;
            document.getElementById('shortcut-cmd').value = s.command;
            document.getElementById('shortcut-title').value = s.title;
            document.getElementById('shortcut-content').value = s.content;
            document.getElementById('shortcut-form-title').textContent = 'Editar Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        };

        window.deleteShortcut = async function(id) {
            if (!confirm('Remover este atalho?')) return;
            const ok = await api.deleteShortcut(id);
            if (ok) { await loadShortcuts(); renderShortcutsList(); showToast('Atalho removido'); }
            else showToast('Erro ao remover', true);
        };

        document.getElementById('close-shortcuts-modal').addEventListener('click', () => {
            document.getElementById('shortcuts-modal').classList.add('modal-hidden');
        });

        document.getElementById('add-shortcut-btn').addEventListener('click', () => {
            document.getElementById('shortcut-edit-id').value = '';
            document.getElementById('shortcut-cmd').value = '';
            document.getElementById('shortcut-title').value = '';
            document.getElementById('shortcut-content').value = '';
            document.getElementById('shortcut-form-title').textContent = 'Novo Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        });

        document.getElementById('cancel-shortcut').addEventListener('click', () => {
            document.getElementById('shortcut-form').style.display = 'none';
        });

        document.getElementById('save-shortcut').addEventListener('click', async () => {
            const id = document.getElementById('shortcut-edit-id').value;
            const data = {
                command: document.getElementById('shortcut-cmd').value.trim(),
                title: document.getElementById('shortcut-title').value.trim(),
                content: document.getElementById('shortcut-content').value.trim()
            };
            if (!data.command || !data.title || !data.content) {
                showToast('Preencha todos os campos', true);
                return;
            }
            const result = id ? await api.updateShortcut(id, data) : await api.createShortcut(data);
            if (result) {
                await loadShortcuts();
                renderShortcutsList();
                document.getElementById('shortcut-form').style.display = 'none';
                showToast(id ? 'Atalho atualizado' : 'Atalho criado');
            } else {
                showToast('Erro ao salvar atalho', true);
            }
        });

        // --- BACK BUTTON (mobile) ---
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('conversation-panel').classList.remove('mobile-hidden');
            document.getElementById('chat-panel').classList.add('mobile-hidden');
            closeContactDetails();
            currentConversationId = null;
            currentConversation = null;
            renderConversationList();
        });

        // --- SHOW CHAT WELCOME ---
        function showChatWelcome() {
            const messagesArea = document.getElementById('messages-area');
            const welcomeEl = document.getElementById('chat-welcome');
            document.getElementById('input-bar').classList.add('hidden');
            document.getElementById('sync-banner').classList.add('hidden');
            document.getElementById('chat-contact-name').textContent = '';
            document.getElementById('chat-contact-phone').textContent = '';
            document.getElementById('mute-chat-btn')?.classList.add('hidden');
            document.getElementById('archive-chat-btn')?.classList.add('hidden');
            document.getElementById('delete-chat-btn')?.classList.add('hidden');

            // Preserve chat-welcome before clearing
            if (welcomeEl) {
                messagesArea.innerHTML = '';
                messagesArea.appendChild(welcomeEl);
                welcomeEl.classList.remove('hidden');
            } else {
                messagesArea.innerHTML = `
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>`;
            }

            // Close details panel
            closeContactDetails();
        }

        // --- QR CODE MODAL ---
        let qrPollInterval = null;

        async function showQRModal(instanceName) {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-container');
            document.getElementById('qr-instance-name').textContent = instanceName === 'aero-festas' ? 'Aero Festas' : 'ABC Festas';

            modal.classList.remove('hidden');
            container.innerHTML = '<div class="text-gray-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Gerando QR Code...</p></div>';

            const data = await api.connect(instanceName);
            if (data?.base64) {
                container.innerHTML = `<img src="${data.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else if (data?.code) {
                container.innerHTML = `<img src="data:image/png;base64,${data.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else {
                container.innerHTML = '<p class="text-red-500 text-sm">Erro ao gerar QR Code. Verifique se a Evolution API estÃ¡ ativa.</p>';
            }

            // Poll para QR atualizado
            qrPollInterval = setInterval(async () => {
                const inst = instances.find(i => i.instanceName === instanceName);
                if (inst) {
                    const refreshedInstances = await api.getInstances();
                    instances = refreshedInstances;
                    const updated = refreshedInstances.find(i => i.instanceName === instanceName);
                    if (updated?.status === 'connected') {
                        clearInterval(qrPollInterval);
                        modal.classList.add('hidden');
                        showToast('WhatsApp conectado com sucesso!');
                        updateConnectionStatus();
                        return;
                    }
                }
                // Atualiza QR
                const qrData = await api.getQR(instanceName);
                if (qrData?.base64) {
                    container.innerHTML = `<img src="${qrData.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
                } else if (qrData?.code) {
                    container.innerHTML = `<img src="data:image/png;base64,${qrData.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
                }
            }, 5000);
        }

        document.getElementById('close-qr-modal').addEventListener('click', () => {
            document.getElementById('qr-modal').classList.add('hidden');
            if (qrPollInterval) clearInterval(qrPollInterval);
        });

        // --- SEARCH ---
        document.getElementById('search-conversations').addEventListener('input', renderConversationList);

        // --- UNREAD BADGES ---
        async function updateUnreadBadges() {
            const counts = await api.getUnreadCount();
            ['aero-festas', 'abc-festas'].forEach(name => {
                const badge = document.getElementById(`badge-${name}`);
                if (badge) {
                    const count = counts[name] || 0;
                    badge.textContent = count > 0 ? `(${count > 99 ? '99+' : count})` : '';
                }
            });
        }

        // --- LOAD CONVERSATIONS ---
        async function loadConversations() {
            const all = await api.getConversations(currentInstance);
            // Ordenar: nÃ£o lidas PRIMEIRO, depois por lastMessageAt DESC, null por Ãºltimo
            all.sort((a, b) => {
                const aUnread = (a.unreadCount || 0) > 0;
                const bUnread = (b.unreadCount || 0) > 0;
                if (aUnread && !bUnread) return -1;
                if (!aUnread && bUnread) return 1;
                if (!a.lastMessageAt && !b.lastMessageAt) return 0;
                if (!a.lastMessageAt) return 1;
                if (!b.lastMessageAt) return -1;
                return new Date(b.lastMessageAt) - new Date(a.lastMessageAt);
            });
            if (showingArchived) {
                conversations = all.filter(c => c.isArchived);
            } else {
                conversations = all.filter(c => !c.isArchived);
                // Count archived for the bar
                const archCount = all.filter(c => c.isArchived).length;
                const archivedBar = document.getElementById('archived-bar');
                const archivedCount = document.getElementById('archived-count');
                if (archivedBar && archivedCount) {
                    archivedCount.textContent = archCount;
                    if (archCount > 0 && currentSidePanel === 'chats') archivedBar.classList.remove('hidden');
                    else archivedBar.classList.add('hidden');
                }
            }
            renderConversationList();
        }

        // --- SMART POLLING (unificado) ---
        let _pollCount = 0;
        const POLL_ACTIVE = 5000;     // 5s com conversa aberta
        const POLL_IDLE = 10000;      // 10s sem conversa
        const POLL_BG = 30000;        // 30s aba em background

        function startPolling() {
            pollLoop(); // Primeiro poll imediato
            schedulePoll();

            // Ajusta intervalo com visibilidade da aba
            document.addEventListener('visibilitychange', () => {
                clearTimeout(pollTimer);
                schedulePoll();
            });
        }

        function schedulePoll() {
            const interval = document.hidden
                ? POLL_BG
                : (currentConversationId ? POLL_ACTIVE : POLL_IDLE);
            pollTimer = setTimeout(async () => {
                await pollLoop();
                schedulePoll();
            }, interval);
        }

        async function pollLoop() {
            try {
                const data = await api.poll(currentInstance, lastPollTime, currentConversationId);
                if (!data) return;

                lastPollTime = data.serverTime;

                // 1. Merge conversas atualizadas
                if (data.conversations && data.conversations.length > 0) {
                    for (const updated of data.conversations) {
                        const idx = conversations.findIndex(c => c.id === updated.id);
                        if (idx >= 0) {
                            conversations[idx] = { ...conversations[idx], ...updated };
                        } else {
                            conversations.push(updated);
                        }
                    }
                    // Re-ordena: nÃ£o-lidas primeiro, depois por lastMessageAt desc
                    conversations.sort((a, b) => {
                        const aU = (a.unreadCount || 0) > 0;
                        const bU = (b.unreadCount || 0) > 0;
                        if (aU && !bU) return -1;
                        if (!aU && bU) return 1;
                        if (!a.lastMessageAt && !b.lastMessageAt) return 0;
                        if (!a.lastMessageAt) return 1;
                        if (!b.lastMessageAt) return -1;
                        return new Date(b.lastMessageAt) - new Date(a.lastMessageAt);
                    });
                    renderConversationList();
                    updateUnreadBadges();
                }

                // 2. Merge mensagens novas (conversa aberta)
                if (data.messages && data.messages.length > 0 && currentConversationId) {
                    let hasNew = false;
                    for (const newMsg of data.messages) {
                        const existing = messages.find(m => m.id === newMsg.id);
                        if (existing) {
                            // Atualiza status se mudou
                            if (existing.status !== newMsg.status) {
                                existing.status = newMsg.status;
                                hasNew = true;
                            }
                            // Preserva mediaUrl local (download feito pelo usuÃ¡rio)
                            if (existing.mediaUrl && !newMsg.mediaUrl) {
                                newMsg.mediaUrl = existing.mediaUrl;
                            }
                        } else {
                            // Mensagem realmente nova
                            messages.push(newMsg);
                            hasNew = true;
                        }
                    }
                    if (hasNew) {
                        messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        renderMessages(true);

                        // Auto mark read
                        const conv = conversations.find(c => c.id === currentConversationId);
                        if (conv?.unreadCount > 0) {
                            api.markRead(currentConversationId);
                            conv.unreadCount = 0;
                            renderConversationList();
                        }
                    }
                }

                // 3. Presence
                if (currentConversation) {
                    const el = document.getElementById('chat-presence');
                    const phone = document.getElementById('chat-contact-phone');
                    if (data.presence === 'composing' || data.presence === 'typing') {
                        el.textContent = 'digitando...';
                        el.classList.remove('hidden');
                        phone.classList.add('hidden');
                    } else if (data.presence === 'recording') {
                        el.textContent = 'gravando Ã¡udio...';
                        el.classList.remove('hidden');
                        phone.classList.add('hidden');
                    } else {
                        el.classList.add('hidden');
                        phone.classList.remove('hidden');
                    }
                }

                // 4. Refresh de instÃ¢ncias a cada ~5 polls
                _pollCount++;
                if (_pollCount % 5 === 0) {
                    instances = await api.getInstances();
                    updateConnectionStatus();
                }
            } catch (e) {
                console.error('[Poll] Erro:', e);
            }
        }

        // --- SIDEBAR NAVIGATION ---
        let currentSidePanel = 'chats';
        let showingArchived = false;
        let contactsCache = [];
        let statusCache = [];

        document.querySelectorAll('.wa-sidebar-btn[data-panel]').forEach(btn => {
            btn.addEventListener('click', () => {
                const panel = btn.dataset.panel;
                document.querySelectorAll('.wa-sidebar-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                switchSidePanel(panel);
            });
        });

        function switchSidePanel(panel) {
            currentSidePanel = panel;
            const title = document.getElementById('side-panel-title');
            const convList = document.getElementById('conversation-list');
            const groupsPanel = document.getElementById('groups-panel');
            const statusPanel = document.getElementById('status-panel');
            const catalogPanel = document.getElementById('catalog-side-panel');
            const settingsPanel = document.getElementById('settings-panel');
            const newConvPanel = document.getElementById('new-conv-panel');
            const archivedBar = document.getElementById('archived-bar');
            const newConvBtn = document.getElementById('new-conversation-btn');
            const syncBtn = document.getElementById('sync-history-btn');

            [convList, groupsPanel, statusPanel, catalogPanel, settingsPanel, newConvPanel].forEach(el => el.classList.add('hidden'));
            archivedBar?.classList.add('hidden');
            newConvBtn?.classList.add('hidden');
            syncBtn?.classList.add('hidden');

            switch (panel) {
                case 'chats':
                    title.textContent = 'Conversas';
                    convList.classList.remove('hidden');
                    archivedBar?.classList.remove('hidden');
                    newConvBtn?.classList.remove('hidden');
                    syncBtn?.classList.remove('hidden');
                    break;
                case 'groups':
                    title.textContent = 'Grupos';
                    groupsPanel.classList.remove('hidden');
                    loadGroups();
                    break;
                case 'status':
                    title.textContent = 'Status';
                    statusPanel.classList.remove('hidden');
                    loadStatusList();
                    break;
                case 'catalog':
                    title.textContent = 'CatÃ¡logo';
                    catalogPanel.classList.remove('hidden');
                    loadCatalogSidePanel();
                    break;
                case 'settings':
                    title.textContent = 'ConfiguraÃ§Ãµes';
                    settingsPanel.classList.remove('hidden');
                    loadMyProfile();
                    break;
            }
        }

        // --- NEW CONVERSATION ---
        document.getElementById('new-conversation-btn')?.addEventListener('click', openNewConvPanel);

        async function openNewConvPanel() {
            const newConvPanel = document.getElementById('new-conv-panel');
            const convList = document.getElementById('conversation-list');
            const archivedBar = document.getElementById('archived-bar');
            convList.classList.add('hidden');
            archivedBar?.classList.add('hidden');
            newConvPanel.classList.remove('hidden');

            newConvPanel.querySelector('#contacts-list').innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando contatos...</p></div>';
            contactsCache = await api.getContacts(currentInstance);
            renderContactsList(contactsCache, 'contacts-list', (contact) => {
                closeNewConvPanel();
                startConversationWith(contact);
            });

            const searchInput = document.getElementById('search-contacts');
            const numberBtn = document.getElementById('new-conv-number-btn');
            const numberDisplay = document.getElementById('new-conv-number-display');
            const startBtn = document.getElementById('start-conv-number');

            searchInput.addEventListener('input', (e) => {
                const q = e.target.value.trim();
                const qLower = q.toLowerCase();
                const digits = q.replace(/\D/g, '');

                // Mostra botÃ£o de nÃºmero se digitou pelo menos 8 dÃ­gitos
                if (digits.length >= 8) {
                    // Normaliza: adiciona 55 se nÃ£o tiver cÃ³digo de paÃ­s
                    const normalized = digits.startsWith('55') && digits.length >= 12
                        ? digits
                        : digits.length <= 11 ? '55' + digits : digits;
                    const jid = `${normalized}@s.whatsapp.net`;
                    numberDisplay.textContent = `+${normalized}`;
                    numberBtn.classList.remove('hidden');
                    startBtn.onclick = () => {
                        closeNewConvPanel();
                        startConversationWith({ remoteJid: jid, name: normalized, phoneNumber: normalized });
                    };
                } else {
                    numberBtn.classList.add('hidden');
                }

                // Filtra lista de contatos
                const filtered = contactsCache.filter(c =>
                    c.name.toLowerCase().includes(qLower) || c.phoneNumber.includes(digits)
                );
                renderContactsList(filtered, 'contacts-list', (contact) => {
                    closeNewConvPanel();
                    startConversationWith(contact);
                });
            });
        }
        window.closeNewConvPanel = function() {
            document.getElementById('new-conv-panel').classList.add('hidden');
            document.getElementById('conversation-list').classList.remove('hidden');
            document.getElementById('archived-bar')?.classList.remove('hidden');
        };

        function renderContactsList(contacts, containerId, onClick) {
            const container = document.getElementById(containerId);
            if (contacts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm py-8">Nenhum contato encontrado</p>';
                return;
            }
            container.innerHTML = contacts.map(c => {
                const initials = escapeHtml((c.name || '?')[0].toUpperCase());
                const cachedPic = profilePicCache[c.phoneNumber];
                const avatarContent = cachedPic
                    ? `<img src="${cachedPic}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`
                    : initials;
                return `<div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition" data-jid="${escapeHtml(c.remoteJid)}" data-name="${escapeHtml(c.name)}" data-phone="${escapeHtml(c.phoneNumber)}">
                    <div class="w-10 h-10 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white text-sm font-bold flex-shrink-0 overflow-hidden" data-contact-phone="${escapeHtml(c.phoneNumber)}">${avatarContent}</div>
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium truncate">${escapeHtml(c.name)}</p>
                        <p class="text-xs text-gray-400">${escapeHtml(c.phoneNumber)}</p>
                    </div>
                </div>`;
            }).join('');
            container.querySelectorAll('[data-jid]').forEach(el => {
                el.addEventListener('click', () => {
                    onClick({ remoteJid: el.dataset.jid, name: el.dataset.name, phoneNumber: el.dataset.phone });
                });
            });
            // Carregar fotos de perfil dos contatos que ainda nÃ£o estÃ£o no cache
            loadContactProfilePics(contacts, containerId);
        }

        async function loadContactProfilePics(contacts, containerId) {
            for (const c of contacts) {
                if (profilePicCache[c.phoneNumber] !== undefined) continue;
                profilePicCache[c.phoneNumber] = null; // marca como carregando
                try {
                    const data = await api.getProfilePic(currentInstance, c.phoneNumber);
                    if (data.profilePicUrl) {
                        profilePicCache[c.phoneNumber] = data.profilePicUrl;
                        const avatarEl = document.querySelector(`#${containerId} [data-contact-phone="${c.phoneNumber}"]`);
                        if (avatarEl) {
                            const initials = (c.name || '?')[0].toUpperCase();
                            avatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                        }
                    }
                } catch (e) { /* silenciar */ }
            }
        }

        async function startConversationWith(contact) {
            // Check if conversation already exists in local state
            const existing = conversations.find(c => c.remoteJid === contact.remoteJid);
            if (existing) { openConversation(existing); return; }

            // Persiste a conversa no banco imediatamente (evita desaparecer ao recarregar)
            const persisted = await api.ensureConversation(currentInstance, contact.remoteJid, contact.name, false);
            if (persisted) {
                // Adiciona Ã  lista local e abre
                conversations.unshift(persisted);
                renderConversationList();
                openConversation(persisted);
            } else {
                // Fallback: conversa temporÃ¡ria (sem conexÃ£o ou erro)
                const tempConv = {
                    id: null, remoteJid: contact.remoteJid, phoneNumber: contact.phoneNumber,
                    contactName: contact.name, instanceId: null, unreadCount: 0,
                    lastMessageAt: null, lastMessagePreview: null, isGroup: false
                };
                openConversation(tempConv);
            }
        }

        // --- SEND CONTACT ---
        async function openSendContactModal() {
            document.getElementById('send-contact-modal').classList.remove('modal-hidden');
            const list = document.getElementById('contacts-send-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin"></i></div>';
            if (contactsCache.length === 0) contactsCache = await api.getContacts(currentInstance);
            renderContactsList(contactsCache, 'contacts-send-list', async (contact) => {
                document.getElementById('send-contact-modal').classList.add('modal-hidden');
                const result = await api.sendContact({
                    instanceName: currentInstance, remoteJid: currentConversation.remoteJid,
                    contact: { fullName: contact.name, phoneNumber: contact.phoneNumber }
                });
                if (result) {
                    messages.push(result);
                    renderMessages();
                    showToast('Contato enviado', 'success');
                }
            });

            document.getElementById('search-contacts-send').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                const filtered = contactsCache.filter(c => c.name.toLowerCase().includes(q) || c.phoneNumber.includes(q));
                renderContactsList(filtered, 'contacts-send-list', async (contact) => {
                    document.getElementById('send-contact-modal').classList.add('modal-hidden');
                    const result = await api.sendContact({
                        instanceName: currentInstance, remoteJid: currentConversation.remoteJid,
                        contact: { fullName: contact.name, phoneNumber: contact.phoneNumber }
                    });
                    if (result) { messages.push(result); renderMessages(); }
                });
            });
        }

        // --- GROUPS ---
        const groupPicCache = {}; // { jid: url | null }

        async function loadGroups() {
            const panel = document.getElementById('groups-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando grupos...</p></div>';
            let groups;
            try {
                groups = await api.getGroups(currentInstance);
            } catch(e) {
                panel.innerHTML = `<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-circle text-3xl text-red-300 mb-2"></i><p class="text-sm font-medium">Erro ao carregar grupos</p><p class="text-xs text-gray-400 mt-1">${escapeHtml(e.message)}</p></div>`;
                return;
            }
            if (!groups || groups.length === 0) {
                panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-users text-3xl text-gray-300 mb-2"></i><p class="text-sm">Nenhum grupo encontrado</p><p class="text-xs text-gray-400 mt-1">Verifique se o WhatsApp estÃ¡ conectado</p></div>';
                return;
            }
            panel.innerHTML = groups.map(g => {
                const pic = groupPicCache[g.id];
                const avatarHtml = pic
                    ? `<img src="${escapeHtml(pic)}" class="w-full h-full object-cover" data-group-jid-pic="${escapeHtml(g.id)}">`
                    : `<i class="fas fa-users text-xs" data-group-jid-pic="${escapeHtml(g.id)}"></i>`;
                return `
                <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition conv-item" data-group-jid="${escapeHtml(g.id)}" data-group-name="${escapeHtml(g.subject)}">
                    <div class="w-10 h-10 rounded-full bg-teal-500 flex items-center justify-center text-white text-sm flex-shrink-0 overflow-hidden" data-group-avatar="${escapeHtml(g.id)}">
                        ${avatarHtml}
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium truncate">${escapeHtml(g.subject)}</p>
                        <p class="text-xs text-gray-400">${g.size} participantes</p>
                    </div>
                </div>`;
            }).join('');

            // Carregar fotos dos grupos assÃ­ncronamente
            for (const g of groups) {
                if (groupPicCache[g.id] !== undefined) continue;
                groupPicCache[g.id] = g.profilePicUrl || null;
                if (g.profilePicUrl) {
                    const avatarEl = panel.querySelector(`[data-group-avatar="${CSS.escape(g.id)}"]`);
                    if (avatarEl) avatarEl.innerHTML = `<img src="${escapeHtml(g.profilePicUrl)}" class="w-full h-full object-cover">`;
                }
            }

            panel.querySelectorAll('[data-group-jid]').forEach(el => {
                el.addEventListener('click', async () => {
                    const groupJid = el.dataset.groupJid;
                    const groupName = el.dataset.groupName || 'Grupo';
                    // Garantir que conversa existe no banco
                    let conv = conversations.find(c => c.remoteJid === groupJid);
                    if (!conv) {
                        const saved = await api.ensureConversation(currentInstance, groupJid, groupName, true);
                        if (saved) {
                            conv = { ...saved, contactName: saved.contactName || groupName };
                            conversations.unshift(conv);
                        } else {
                            conv = { id: null, remoteJid: groupJid, phoneNumber: groupJid.replace('@g.us', ''), contactName: groupName, isGroup: true, unreadCount: 0 };
                        }
                    }
                    openConversation(conv);
                });
            });
        }

        // --- ARCHIVED ---
        window.toggleArchivedView = async function() {
            showingArchived = !showingArchived;
            document.getElementById('side-panel-title').textContent = showingArchived ? 'Arquivados' : 'Conversas';
            await loadConversations();
        };

        // --- MUTE ---
        window.toggleMuteChat = function() {
            if (!currentConversation) return;
            if (currentConversation.isMuted) {
                unmuteChat();
            } else {
                document.getElementById('mute-modal').classList.remove('modal-hidden');
            }
        };
        window.muteChat = async function(duration) {
            document.getElementById('mute-modal').classList.add('modal-hidden');
            if (!currentConversation?.id) return;
            await api.muteConversation(currentConversation.id, true, duration);
            currentConversation.isMuted = true;
            updateChatHeaderButtons();
            showToast('Conversa silenciada', 'success');
            await loadConversations();
            renderConversationList();
        };
        async function unmuteChat() {
            if (!currentConversation?.id) return;
            await api.muteConversation(currentConversation.id, false);
            currentConversation.isMuted = false;
            updateChatHeaderButtons();
            showToast('NotificaÃ§Ãµes ativadas', 'success');
            await loadConversations();
            renderConversationList();
        }

        // --- ARCHIVE ---
        window.toggleArchiveChat = async function() {
            if (!currentConversation?.id) return;
            const newState = !currentConversation.isArchived;
            await api.archiveConversation(currentConversation.id, newState);
            showToast(newState ? 'Conversa arquivada' : 'Conversa desarquivada', 'success');
            await loadConversations();
            renderConversationList();
            if (newState) { currentConversationId = null; currentConversation = null; showChatWelcome(); }
        };

        function updateChatHeaderButtons() {
            if (!currentConversation) return;
            const muteBtn = document.getElementById('mute-chat-btn');
            const archiveBtn = document.getElementById('archive-chat-btn');
            const deleteBtn = document.getElementById('delete-chat-btn');
            muteBtn?.classList.remove('hidden');
            archiveBtn?.classList.remove('hidden');
            if (currentConversation.id) {
                deleteBtn?.classList.remove('hidden');
            } else {
                deleteBtn?.classList.add('hidden');
            }
            if (currentConversation.isMuted) {
                muteBtn.innerHTML = '<i class="fas fa-bell-slash text-sm text-amber-500"></i>';
                muteBtn.title = 'Dessilenciar';
            } else {
                muteBtn.innerHTML = '<i class="fas fa-bell text-sm"></i>';
                muteBtn.title = 'Silenciar';
            }
        }

        // --- DELETE CONVERSA ---
        window.deleteCurrentConversation = async function() {
            if (!currentConversation?.id) return;
            const name = currentConversation.contactName || currentConversation.phoneNumber || 'esta conversa';
            if (!confirm(`Deletar conversa com ${name}?\n\nTodas as mensagens serÃ£o removidas. Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;

            const btn = document.getElementById('delete-chat-btn');
            if (btn) btn.disabled = true;

            try {
                const result = await api.deleteConversation(currentConversation.id);
                if (result.success) {
                    conversations = conversations.filter(c => c.id !== currentConversation.id);
                    renderConversationList();
                    currentConversationId = null;
                    currentConversation = null;
                    showChatWelcome();
                    showToast('Conversa deletada', 'success');
                } else {
                    showToast('Erro ao deletar conversa', 'error');
                    if (btn) btn.disabled = false;
                }
            } catch (e) {
                console.error('Erro ao deletar conversa:', e);
                showToast('Erro ao deletar conversa', 'error');
                if (btn) btn.disabled = false;
            }
        };

        // --- CLEANUP CHATS ANTIGOS ---
        window.cleanupOldConversations = async function(days = 90) {
            if (!confirm(`Deletar todas as conversas sem atividade hÃ¡ mais de ${days} dias?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;

            showToast('Limpando conversas antigas...', 'info');
            try {
                const result = await api.bulkDeleteOld(currentInstance, days);
                if (result.success) {
                    showToast(`${result.deleted} conversa(s) removida(s)`, 'success');
                    await loadConversations();
                    renderConversationList();
                } else {
                    showToast('Erro ao limpar conversas', 'error');
                }
            } catch (e) {
                console.error('Erro ao limpar conversas antigas:', e);
                showToast('Erro ao limpar conversas', 'error');
            }
        };

        // --- CLEANUP @LID ---
        window.cleanupLidConversations = async function() {
            if (!confirm('Remover todas as conversas duplicadas com @lid?\n\nIsso remove conversas criadas com o formato interno do WhatsApp (Linked ID), que geram duplicatas.')) return;

            showToast('Removendo duplicatas @lid...', 'info');
            try {
                const result = await api.cleanupLid();
                if (result.success) {
                    showToast(`${result.deleted} duplicata(s) removida(s)`, 'success');
                    await loadConversations();
                    renderConversationList();
                } else {
                    showToast('Erro ao remover duplicatas', 'error');
                }
            } catch (e) {
                console.error('Erro ao remover duplicatas @lid:', e);
                showToast('Erro ao remover duplicatas', 'error');
            }
        };

        // --- CONTACT DETAILS (estilo WhatsApp nativo) ---
        window.openContactDetails = async function() {
            if (!currentConversation) return;
            const panel = document.getElementById('contact-details-panel');
            const content = document.getElementById('contact-details-content');
            const phone = currentConversation.phoneNumber || currentConversation.remoteJid?.replace(/@.*/, '');
            const name = currentConversation.contactName || phone;
            const picUrl = profilePicCache[phone] || groupPicCache[currentConversation.remoteJid];
            const isGroup = currentConversation.isGroup;

            // === CABEÃ‡ALHO â€” foto grande + nome + nÃºmero/tipo ===
            const avatarHtml = picUrl
                ? `<img src="${escapeHtml(picUrl)}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<span class=\\'text-4xl font-bold\\'>${escapeHtml(name[0]?.toUpperCase() || '?')}</span>'">`
                : (isGroup ? '<i class="fas fa-users text-4xl"></i>' : `<span class="text-4xl font-bold">${escapeHtml(name[0]?.toUpperCase() || '?')}</span>`);

            const headerHtml = `
                <div class="bg-gradient-to-b from-teal-600 to-teal-500 text-white px-4 pt-6 pb-8 text-center -mx-4 -mt-4 mb-2">
                    <div class="w-28 h-28 rounded-full bg-white/20 mx-auto mb-4 flex items-center justify-center text-white overflow-hidden shadow-lg ring-4 ring-white/30">
                        ${avatarHtml}
                    </div>
                    <h2 class="text-xl font-bold leading-tight">${escapeHtml(name)}</h2>
                    <p class="text-teal-100 text-sm mt-0.5">${isGroup ? '<i class="fas fa-users text-xs mr-1"></i>Grupo' : escapeHtml('+' + phone)}</p>
                </div>`;

            // === AÃ‡Ã•ES RÃPIDAS (Ã­cones circulares como no WhatsApp) ===
            const quickActionsHtml = `
                <div class="flex justify-around px-2 py-3 mb-2">
                    <button onclick="window.open('https://wa.me/${phone}','_blank')" class="flex flex-col items-center gap-1.5 group">
                        <div class="w-12 h-12 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 group-hover:bg-teal-100 transition">
                            <i class="fab fa-whatsapp text-xl"></i>
                        </div>
                        <span class="text-[10px] text-gray-500">WhatsApp</span>
                    </button>
                    ${currentConversation.clientId ? `
                    <a href="Sistema de CRM.html?clientId=${currentConversation.clientId}" class="flex flex-col items-center gap-1.5 group">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-100 transition">
                            <i class="fas fa-user-circle text-xl"></i>
                        </div>
                        <span class="text-[10px] text-gray-500">CRM</span>
                    </a>` : ''}
                    <button onclick="toggleMuteChat()" class="flex flex-col items-center gap-1.5 group">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 group-hover:bg-gray-200 transition">
                            <i class="fas fa-${currentConversation.isMuted ? 'bell' : 'bell-slash'} text-xl"></i>
                        </div>
                        <span class="text-[10px] text-gray-500">${currentConversation.isMuted ? 'Ativar' : 'Silenciar'}</span>
                    </button>
                </div>`;

            // === AÃ‡Ã•ES DE LISTA ===
            const listActionsHtml = `
                <div class="bg-white rounded-2xl shadow-sm divide-y divide-gray-100 mb-3">
                    <button onclick="toggleArchiveChat(); closeContactDetails();" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition text-left">
                        <i class="fas fa-archive text-gray-400 w-5 text-center"></i>
                        <span class="text-sm text-gray-700">${currentConversation.isArchived ? 'Desarquivar conversa' : 'Arquivar conversa'}</span>
                    </button>
                </div>`;

            if (!isGroup) {
                content.innerHTML = headerHtml + quickActionsHtml + listActionsHtml;
                panel.classList.add('open');
                return;
            }

            // === GRUPO: spinner enquanto carrega ===
            content.innerHTML = headerHtml + quickActionsHtml + `<div class="text-center py-6 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando detalhes...</div>`;
            panel.classList.add('open');

            const groupJid = currentConversation.remoteJid;
            const details = await api.getGroupDetails(currentInstance, groupJid);

            // DescriÃ§Ã£o do grupo
            const descHtml = details?.desc ? `
                <div class="bg-white rounded-2xl shadow-sm px-4 py-3.5 mb-3">
                    <p class="text-xs font-semibold text-teal-600 uppercase tracking-wide mb-1">DescriÃ§Ã£o</p>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(details.desc)}</p>
                </div>` : '';

            // Participantes
            let participantsHtml = '';
            if (details?.participants?.length > 0) {
                participantsHtml = `
                    <div class="bg-white rounded-2xl shadow-sm mb-3 overflow-hidden">
                        <p class="text-xs font-semibold text-teal-600 uppercase tracking-wide px-4 pt-3.5 pb-2">${details.participants.length} participantes</p>
                        <div class="divide-y divide-gray-100">
                            ${details.participants.map(p => {
                                const pPhone = p.id.replace(/@.*/, '');
                                const pName = p.pushName || p.notify || pPhone;
                                const pPic = profilePicCache[pPhone];
                                const isAdmin = p.admin === 'admin' || p.admin === 'superadmin';
                                const isSuperAdmin = p.admin === 'superadmin';
                                return `
                                <div class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 group">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm font-bold flex-shrink-0 overflow-hidden">
                                        ${pPic ? `<img src="${escapeHtml(pPic)}" class="w-full h-full object-cover">` : escapeHtml(pName[0]?.toUpperCase() || '?')}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium truncate text-gray-800">${escapeHtml(pName)}</p>
                                        <p class="text-xs text-gray-400">+${escapeHtml(pPhone)}</p>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        ${isAdmin ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${isSuperAdmin ? 'bg-amber-100 text-amber-700' : 'bg-teal-100 text-teal-700'}">${isSuperAdmin ? 'Dono' : 'Admin'}</span>` : ''}
                                        <div class="hidden group-hover:flex gap-1.5">
                                            ${!isAdmin ? `<button onclick="groupParticipantAction('promote','${escapeHtml(p.id)}')" class="text-xs text-teal-600 hover:underline font-medium">+Admin</button>` : ''}
                                            ${isAdmin && !isSuperAdmin ? `<button onclick="groupParticipantAction('demote','${escapeHtml(p.id)}')" class="text-xs text-orange-500 hover:underline font-medium">-Admin</button>` : ''}
                                            <button onclick="groupParticipantAction('remove','${escapeHtml(p.id)}')" class="text-xs text-red-500 hover:underline font-medium">Remover</button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            // AÃ§Ãµes do grupo
            const groupActionsHtml = `
                <div class="bg-white rounded-2xl shadow-sm divide-y divide-gray-100 mb-3">
                    <button onclick="editGroupSubject()" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition text-left">
                        <i class="fas fa-pencil-alt text-teal-500 w-5 text-center"></i>
                        <span class="text-sm text-gray-700">Editar nome do grupo</span>
                    </button>
                    <button onclick="editGroupDescription()" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition text-left">
                        <i class="fas fa-align-left text-teal-500 w-5 text-center"></i>
                        <span class="text-sm text-gray-700">Editar descriÃ§Ã£o</span>
                    </button>
                    ${currentConversation.isArchived !== undefined ? `
                    <button onclick="toggleArchiveChat(); closeContactDetails();" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-50 transition text-left">
                        <i class="fas fa-archive text-gray-400 w-5 text-center"></i>
                        <span class="text-sm text-gray-700">${currentConversation.isArchived ? 'Desarquivar' : 'Arquivar conversa'}</span>
                    </button>` : ''}
                    <button onclick="confirmLeaveGroup()" class="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-red-50 transition text-left">
                        <i class="fas fa-sign-out-alt text-red-500 w-5 text-center"></i>
                        <span class="text-sm text-red-500 font-medium">Sair do grupo</span>
                    </button>
                </div>`;

            content.innerHTML = headerHtml + quickActionsHtml + descHtml + participantsHtml + groupActionsHtml;
        };

        // AÃ§Ãµes de participantes do grupo
        window.groupParticipantAction = async function(action, participantJid) {
            if (!currentConversation?.remoteJid) return;
            const labels = { promote: 'promover a admin', demote: 'remover admin de', remove: 'remover do grupo' };
            if (!confirm(`Deseja ${labels[action]} este participante?`)) return;
            const result = await api.updateGroupParticipants(currentInstance, currentConversation.remoteJid, action, [participantJid]);
            if (result) {
                showToast('Participante atualizado', 'success');
                openContactDetails(); // Recarrega painel
            } else {
                showToast('Erro ao atualizar participante', 'error');
            }
        };

        window.editGroupSubject = async function() {
            const current = currentConversation?.contactName || '';
            const newName = prompt('Novo nome do grupo:', current);
            if (!newName || newName === current) return;
            const ok = await api.updateGroupSubject(currentInstance, currentConversation.remoteJid, newName);
            if (ok) {
                showToast('Nome do grupo atualizado', 'success');
                currentConversation.contactName = newName;
                document.getElementById('chat-contact-name').textContent = newName;
                await loadConversations();
            } else {
                showToast('Erro ao atualizar nome', 'error');
            }
        };

        window.editGroupDescription = async function() {
            const newDesc = prompt('Nova descriÃ§Ã£o do grupo:');
            if (newDesc === null) return;
            const ok = await api.updateGroupDescription(currentInstance, currentConversation.remoteJid, newDesc);
            showToast(ok ? 'DescriÃ§Ã£o atualizada' : 'Erro ao atualizar descriÃ§Ã£o', ok ? 'success' : 'error');
        };

        window.confirmLeaveGroup = async function() {
            if (!confirm('Tem certeza que deseja sair deste grupo?')) return;
            const ok = await api.leaveGroup(currentInstance, currentConversation.remoteJid);
            if (ok) {
                showToast('Saiu do grupo', 'success');
                closeContactDetails();
                currentConversationId = null;
                currentConversation = null;
                showChatWelcome();
                await loadConversations();
            } else {
                showToast('Erro ao sair do grupo', 'error');
            }
        };
        window.closeContactDetails = function() {
            document.getElementById('contact-details-panel').classList.remove('open');
        };

        // --- PROFILE ---
        async function loadMyProfile() {
            const profile = await api.getProfile(currentInstance);
            if (profile) {
                document.getElementById('my-profile-name').textContent = profile.name || '...';
                document.getElementById('my-profile-status').textContent = profile.status || 'DisponÃ­vel';
                document.getElementById('my-profile-phone').textContent = profile.phoneNumber || '';
                if (profile.profilePicUrl) {
                    document.getElementById('my-profile-pic').innerHTML = `<img src="${escapeHtml(profile.profilePicUrl)}" class="w-full h-full object-cover">`;
                }
            }
        }
        window.openEditProfileModal = async function() {
            const profile = await api.getProfile(currentInstance);
            if (profile) {
                document.getElementById('edit-profile-name').value = profile.name || '';
                document.getElementById('edit-profile-about').value = profile.status || '';
                if (profile.profilePicUrl) {
                    document.getElementById('edit-profile-pic-preview').innerHTML = `<img src="${escapeHtml(profile.profilePicUrl)}" class="w-full h-full object-cover">`;
                }
            }
            document.getElementById('edit-profile-modal').classList.remove('modal-hidden');
        };
        let editProfilePicBase64 = null;
        document.getElementById('edit-profile-pic-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                editProfilePicBase64 = reader.result;
                document.getElementById('edit-profile-pic-preview').innerHTML = `<img src="${reader.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        });
        window.saveProfile = async function() {
            const name = document.getElementById('edit-profile-name').value.trim();
            const status = document.getElementById('edit-profile-about').value.trim();
            const data = {};
            if (name) data.name = name;
            if (status !== undefined) data.status = status;
            if (editProfilePicBase64) data.picture = editProfilePicBase64;
            await api.updateProfile(currentInstance, data);
            editProfilePicBase64 = null;
            document.getElementById('edit-profile-modal').classList.add('modal-hidden');
            showToast('Perfil atualizado', 'success');
            loadMyProfile();
        };

        // --- MERGE DUPLICATES ---
        window.mergeDuplicates = async function() {
            if (!confirm('Isso vai mesclar conversas duplicadas (causadas por sufixo de dispositivo no JID). Continuar?')) return;
            showToast('Corrigindo conversas duplicadas...', 'info');
            try {
                const r = await fetch(`${BASE}/merge-duplicates`, { method: 'POST', headers: headers() });
                const data = await r.json();
                if (r.ok) {
                    showToast(`ConcluÃ­do: ${data.merged} mensagens movidas, ${data.deleted} conversas removidas`, 'success');
                    await loadConversations();
                    renderConversationList();
                } else {
                    showToast(data.error || 'Erro ao mesclar', 'error');
                }
            } catch(e) {
                showToast('Erro ao mesclar conversas', 'error');
            }
        };

        // --- DISCONNECT ---
        window.disconnectInstance = async function() {
            if (!confirm('Deseja realmente desconectar o WhatsApp?')) return;
            await api.disconnect(currentInstance);
            instances = await api.getInstances();
            showToast('WhatsApp desconectado', 'success');
            updateConnectionStatus();
        };

        // --- STATUS / STORIES ---
        async function loadStatusList() {
            const panel = document.getElementById('status-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando status...</p></div>';
            try {
                statusCache = await api.getStatus(currentInstance);
            } catch(e) {
                statusCache = [];
            }
            if (statusCache.length === 0) {
                panel.innerHTML = `
                    <div class="p-3">
                        <button onclick="document.getElementById('post-status-modal').classList.remove('modal-hidden')" class="w-full shiny-btn py-2.5 rounded-xl text-sm font-bold mb-4"><i class="fas fa-plus mr-1"></i>Postar Status</button>
                        <div class="text-center text-gray-400 text-sm py-4">
                            <i class="fas fa-circle-notch text-3xl text-gray-300 mb-3"></i>
                            <p>Nenhum status recente</p>
                            <p class="text-xs mt-1 text-gray-400">Os status aparecerÃ£o aqui quando seus contatos postarem atualizaÃ§Ãµes</p>
                        </div>
                    </div>`;
                return;
            }
            // Group by participant
            const byParticipant = {};
            statusCache.forEach(s => {
                const key = s.participant || s.pushName || 'Eu';
                if (!byParticipant[key]) byParticipant[key] = [];
                byParticipant[key].push(s);
            });
            let html = `<div class="p-3"><button onclick="document.getElementById('post-status-modal').classList.remove('modal-hidden')" class="w-full shiny-btn py-2.5 rounded-xl text-sm font-bold mb-3"><i class="fas fa-plus mr-1"></i>Postar Status</button></div>`;
            for (const [participant, statuses] of Object.entries(byParticipant)) {
                const name = statuses[0].pushName || participant.replace(/@.*/, '');
                const time = statuses[0].timestamp ? new Date(statuses[0].timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                html += `
                    <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition" data-status-participant="${escapeHtml(participant)}">
                        <div class="w-11 h-11 rounded-full status-ring bg-[var(--wa-green)] flex items-center justify-center text-white text-sm font-bold">${escapeHtml(name[0]?.toUpperCase() || '?')}</div>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium truncate">${escapeHtml(name)}</p>
                            <p class="text-xs text-gray-400">${time}</p>
                        </div>
                    </div>`;
            }
            panel.innerHTML = html;
            panel.querySelectorAll('[data-status-participant]').forEach(el => {
                el.addEventListener('click', () => viewStatus(el.dataset.statusParticipant));
            });
        }

        function viewStatus(participant) {
            const statuses = statusCache.filter(s => (s.participant || s.pushName || 'Eu') === participant);
            if (statuses.length === 0) return;
            const s = statuses[0];
            document.getElementById('status-viewer-name').textContent = s.pushName || participant.replace(/@.*/, '');
            document.getElementById('status-viewer-time').textContent = s.timestamp ? new Date(s.timestamp).toLocaleTimeString('pt-BR') : '';
            const content = document.getElementById('status-viewer-content');
            if (s.messageType === 'image' && s.mediaUrl) {
                content.innerHTML = `<img src="${escapeHtml(s.mediaUrl)}" class="max-h-[70vh] max-w-full rounded-lg">`;
            } else if (s.messageType === 'video' && s.mediaUrl) {
                content.innerHTML = `<video src="${escapeHtml(s.mediaUrl)}" controls autoplay class="max-h-[70vh] max-w-full rounded-lg"></video>`;
            } else {
                content.innerHTML = `<p class="text-white text-xl text-center px-8">${escapeHtml(s.content || '')}</p>`;
            }
            document.getElementById('status-viewer-modal').classList.remove('modal-hidden');
            // Progress bar
            const progress = document.getElementById('status-progress');
            progress.style.width = '0%';
            progress.style.transition = 'width 5s linear';
            setTimeout(() => { progress.style.width = '100%'; }, 50);
            setTimeout(() => { document.getElementById('status-viewer-modal').classList.add('modal-hidden'); }, 5000);
        }

        window.postTextStatus = async function() {
            const text = document.getElementById('status-text-input').value.trim();
            if (!text) return;
            await api.postStatus(currentInstance, { type: 'text', content: text });
            document.getElementById('post-status-modal').classList.add('modal-hidden');
            document.getElementById('status-text-input').value = '';
            showToast('Status publicado', 'success');
            loadStatusList();
        };

        // --- CATALOG SIDE PANEL ---
        async function loadCatalogSidePanel() {
            const panel = document.getElementById('catalog-side-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando catÃ¡logo...</p></div>';
            const catalog = await api.getCatalog(currentInstance);
            if (!catalog || (Array.isArray(catalog) && catalog.length === 0)) {
                panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-store text-3xl text-gray-300 mb-2"></i><p class="text-sm">CatÃ¡logo vazio</p></div>';
                return;
            }
            const items = Array.isArray(catalog) ? catalog : catalog.products || catalog.data || [];
            panel.innerHTML = '<div class="p-3 catalog-grid">' + items.map(item => `
                <div class="catalog-item">
                    ${item.imageUrl ? `<img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.name || '')}">` : '<div class="h-[120px] bg-gray-100 flex items-center justify-center"><i class="fas fa-box text-gray-300 text-2xl"></i></div>'}
                    <div class="p-2">
                        <p class="text-xs font-semibold truncate">${escapeHtml(item.name || 'Produto')}</p>
                        ${item.price ? `<p class="text-xs text-green-600 font-bold">${escapeHtml(item.price)}</p>` : ''}
                    </div>
                </div>
            `).join('') + '</div>';
        }

        // --- SYNC HISTORY ---
        async function syncCurrentConversation() {
            if (!currentConversation?.id) return;
            const syncBanner = document.getElementById('sync-banner');
            syncBanner.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sincronizando histÃ³rico...';
            try {
                const result = await api.syncConversation(currentConversation.id);
                if (result && result.alreadyInDb) {
                    // Mensagens jÃ¡ estÃ£o no banco (chegaram via webhook), sÃ³ carregar
                    await loadMessages();
                    syncBanner.classList.add('hidden');
                } else if (result && result.synced > 0) {
                    showToast(`${result.synced} mensagens sincronizadas`, 'success');
                    await loadMessages();
                    syncBanner.classList.add('hidden');
                } else if (result && result.total === 0 && result.dbCount === 0) {
                    syncBanner.innerHTML = '<i class="fas fa-info-circle mr-1"></i> Nenhum histÃ³rico disponÃ­vel. Mensagens aparecerÃ£o em tempo real.';
                    setTimeout(() => syncBanner.classList.add('hidden'), 4000);
                } else {
                    syncBanner.classList.add('hidden');
                }
            } catch(e) {
                syncBanner.innerHTML = '<i class="fas fa-exclamation-circle mr-1 text-red-500"></i> Erro ao sincronizar. Tente novamente.';
                setTimeout(() => syncBanner.classList.add('hidden'), 3000);
            }
        }
        window.syncCurrentConversation = syncCurrentConversation;

        window.syncAllContacts = async function() {
            showToast('Sincronizando contatos da agenda...', 'info');
            const result = await api.syncContacts(currentInstance);
            if (result) {
                const parts = [];
                if (result.created > 0) parts.push(`${result.created} novos`);
                if (result.updated > 0) parts.push(`${result.updated} atualizados`);
                showToast(parts.length ? `Contatos: ${parts.join(', ')}` : 'Contatos jÃ¡ atualizados', 'success');
                await loadConversations();
            } else {
                showToast('Erro ao sincronizar contatos', 'error');
            }
        };

        window.syncFullHistory = async function() {
            showToast('Sincronizando histÃ³rico...', 'info');
            const result = await api.syncHistory(currentInstance);
            if (result) {
                showToast(`${result.synced} mensagens sincronizadas de ${result.conversations} conversas`, 'success');
                await loadConversations();
                renderConversationList();
            } else {
                showToast('Erro ao sincronizar', 'error');
            }
        };

        document.getElementById('sync-history-btn')?.addEventListener('click', () => syncFullHistory());

        // --- TOAST HELPER ---
        function showToast(message, type = 'success') {
            // Backward compatibility: showToast('msg', true) â†’ error
            if (type === true) type = 'error';
            else if (type === false) type = 'success';
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            msg.textContent = message;
            icon.className = type === 'error' ? 'fas fa-exclamation-circle text-red-500 text-lg' :
                type === 'info' ? 'fas fa-info-circle text-blue-500 text-lg' :
                'fas fa-check-circle text-green-500 text-lg';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // --- ENCAMINHAR MENSAGEM ---
        let forwardMsgId = null;

        window.openForwardModal = function(msgId) {
            forwardMsgId = msgId;
            const msg = messages.find(m => m.id === msgId);
            if (!msg) return;

            // Preview do conteÃºdo
            const preview = document.getElementById('forward-preview');
            const isMedia = msg.messageType !== 'text';
            const mediaIcon = { image: 'ðŸ–¼ï¸', video: 'ðŸŽ¥', audio: 'ðŸŽµ', document: 'ðŸ“„', sticker: 'ðŸ˜Š' };
            if (isMedia) {
                const icon = mediaIcon[msg.messageType] || 'ðŸ“Ž';
                preview.textContent = `${icon} ${msg.mediaName || msg.content || msg.messageType}`;
            } else {
                preview.textContent = msg.content;
            }

            // Preenche lista de conversas (sem a atual)
            document.getElementById('forward-search').value = '';
            renderForwardList('');
            document.getElementById('forward-modal').classList.remove('modal-hidden');
            setTimeout(() => document.getElementById('forward-search').focus(), 100);
        };

        window.closeForwardModal = function() {
            document.getElementById('forward-modal').classList.add('modal-hidden');
            forwardMsgId = null;
        };

        window.filterForwardList = function(q) {
            renderForwardList(q.toLowerCase());
        };

        function renderForwardList(query) {
            const list = document.getElementById('forward-conv-list');
            const filtered = conversations.filter(c =>
                c.id !== currentConversationId &&
                (
                    (c.contactName || '').toLowerCase().includes(query) ||
                    c.phoneNumber.includes(query.replace(/\D/g, ''))
                )
            ).slice(0, 50);

            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-6">Nenhuma conversa encontrada</p>';
                return;
            }

            list.innerHTML = filtered.map(c => {
                const name = c.contactName || c.phoneNumber;
                const initials = escapeHtml((name)[0]?.toUpperCase() || '?');
                const preview = c.lastMessagePreview ? escapeHtml(c.lastMessagePreview.substring(0, 35)) : '';
                return `<div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-green-50 transition" onclick="executeForward('${escapeHtml(c.id)}','${escapeHtml(c.remoteJid)}','${escapeHtml(name)}')">
                    <div class="w-9 h-9 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white text-sm font-bold flex-shrink-0">${initials}</div>
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium truncate">${escapeHtml(name)}</p>
                        ${preview ? `<p class="text-xs text-gray-400 truncate">${preview}</p>` : ''}
                    </div>
                    <i class="fas fa-share text-green-400 text-sm flex-shrink-0"></i>
                </div>`;
            }).join('');
        }

        window.executeForward = async function(convId, remoteJid, convName) {
            const msg = messages.find(m => m.id === forwardMsgId);
            if (!msg) return;

            closeForwardModal();
            showToast(`Encaminhando para ${convName}...`, 'info');

            try {
                let result;
                if (msg.messageType === 'text') {
                    result = await api.send(currentInstance, remoteJid, msg.content);
                } else if (msg.mediaUrl && ['image', 'video', 'document', 'audio'].includes(msg.messageType)) {
                    result = await api.sendMedia(
                        currentInstance,
                        remoteJid,
                        msg.messageType,
                        msg.mediaUrl,
                        msg.content && !msg.content.startsWith('[') ? msg.content : '',
                        msg.mediaName || '',
                        msg.mediaMimetype || ''
                    );
                } else {
                    // Fallback: encaminha como texto
                    const fallback = msg.mediaName
                        ? `[${msg.messageType.toUpperCase()}] ${msg.mediaName}`
                        : msg.content;
                    result = await api.send(currentInstance, remoteJid, fallback);
                }

                if (result && !result.error) {
                    showToast(`Encaminhado para ${convName}`, 'success');
                } else {
                    showToast('Erro ao encaminhar mensagem', 'error');
                }
            } catch (e) {
                showToast('Erro ao encaminhar mensagem', 'error');
            }
        };

        // --- INIT ---
        async function init() {
            instances = await api.getInstances();
            shortcuts = await api.getShortcuts();

            // Set active tab based on URL
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.instance === currentInstance);
            });

            updateConnectionStatus();
            setupInstanceTabs();
            await loadConversations();
            await updateUnreadBadges();
            showChatWelcome();
            startPolling();

            // Sync de contatos em background (nÃ£o bloqueia a UI)
            // Atualiza nomes a partir da agenda do WhatsApp e cria conversas para novos contatos
            api.syncContacts(currentInstance).then(r => {
                if (r?.created > 0 || r?.updated > 0) {
                    const msg = [];
                    if (r.created > 0) msg.push(`${r.created} novos`);
                    if (r.updated > 0) msg.push(`${r.updated} atualizados`);
                    console.log(`[Init] Contatos sincronizados: ${msg.join(', ')}`);
                    loadConversations(); // recarrega lista com nomes novos
                }
            }).catch(() => {}); // silencioso se falhar

            // On desktop, show both panels; on mobile, hide chat panel
            if (window.innerWidth >= 1024) {
                document.getElementById('conversation-panel').classList.remove('mobile-hidden');
                document.getElementById('chat-panel').classList.remove('mobile-hidden');
            } else {
                document.getElementById('chat-panel').classList.add('mobile-hidden');
                document.getElementById('conversation-panel').classList.remove('mobile-hidden');
            }

            // Handle URL parameter for conversation
            const urlConv = new URLSearchParams(window.location.search).get('conversation');
            if (urlConv) {
                const conv = conversations.find(c => c.id === urlConv);
                if (conv) openConversation(conv);
            }

            document.title = `WhatsApp - ${currentInstance === 'aero-festas' ? 'Aero Festas' : 'ABC Festas'}`;
        }

        // --- PDF VIEWER ---
        function openPdfViewer(url, name) {
            document.getElementById('pdf-title').innerHTML = `<i class="fas fa-file-pdf text-red-400 mr-2"></i>${escapeHtml(name || 'PDF')}`;
            // data: URIs nÃ£o funcionam em iframes em alguns browsers, converter para Blob URL
            if (url.startsWith('data:')) {
                try {
                    const [header, b64] = url.split(',');
                    const mime = header.match(/data:(.*?);/)?.[1] || 'application/pdf';
                    const bin = atob(b64);
                    const arr = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    url = URL.createObjectURL(blob);
                } catch(e) { console.warn('PDF blob error:', e); }
            }
            document.getElementById('pdf-frame').src = url;
            document.getElementById('pdf-modal').classList.remove('modal-hidden');
        }
        window.openPdfViewer = openPdfViewer;

        // Abre PDF em nova aba (funciona com data: URI via Blob)
        function openPdfNewTab(url) {
            if (url.startsWith('data:')) {
                try {
                    const [header, b64] = url.split(',');
                    const mime = header.match(/data:(.*?);/)?.[1] || 'application/pdf';
                    const bin = atob(b64);
                    const arr = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    url = URL.createObjectURL(blob);
                } catch(e) { console.warn('PDF blob error:', e); }
            }
            window.open(url, '_blank');
        }
        window.openPdfNewTab = openPdfNewTab;

        // --- EMOJI PICKER ---
        const EMOJIS = {
            'Frequentes': 'ðŸ˜‚â¤ï¸ðŸ”¥ðŸ‘ðŸ˜ðŸ¥°ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ¥ºâœ¨ðŸ˜…ðŸ¤£ðŸ’œðŸ¤ðŸ’›ðŸ™ŒðŸ˜ðŸ’€ðŸ‘€ðŸ’—ðŸ¤”ðŸ˜³ðŸ˜ŽðŸ’™ðŸ¥²ðŸ’šðŸ˜‹ðŸ˜ðŸ˜¢ðŸ‘ðŸ¤—ðŸ’”ðŸ˜©ðŸ¤©ðŸ¥³ðŸ˜¤ðŸ˜¡ðŸ¤¯ðŸ˜±ðŸ¤®ðŸ‘‰ðŸ‘ˆðŸ’ªðŸ«¶ðŸŽ‰ðŸŽŠðŸŽ¶ðŸ‘‹ðŸ’°âœ…',
            'Rostos': 'ðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†ðŸ˜…ðŸ¤£ðŸ˜‚ðŸ™‚ðŸ™ƒðŸ˜‰ðŸ˜ŠðŸ˜‡ðŸ¥°ðŸ˜ðŸ¤©ðŸ˜˜ðŸ˜—â˜ºðŸ˜šðŸ˜™ðŸ¥²ðŸ˜‹ðŸ˜›ðŸ˜œðŸ¤ªðŸ˜ðŸ¤‘ðŸ¤—ðŸ¤­ðŸ¤«ðŸ¤”ðŸ«¡ðŸ¤ðŸ¤¨ðŸ˜ðŸ˜‘ðŸ˜¶ðŸ«¥ðŸ˜ðŸ˜’ðŸ™„ðŸ˜¬ðŸ˜®â€ðŸ’¨ðŸ¤¥ðŸ«¨ðŸ˜ŒðŸ˜”ðŸ˜ªðŸ¤¤ðŸ˜´ðŸ˜·ðŸ¤’ðŸ¤•ðŸ¤¢ðŸ¤®ðŸ¤§ðŸ¥µðŸ¥¶ðŸ¥´ðŸ˜µðŸ˜µâ€ðŸ’«ðŸ¤¯ðŸ¤ ðŸ¥³ðŸ¥¸ðŸ˜ŽðŸ¤“ðŸ§ðŸ˜•ðŸ«¤ðŸ˜ŸðŸ™â˜¹ðŸ˜®ðŸ˜¯ðŸ˜²ðŸ˜³ðŸ¥ºðŸ¥¹ðŸ˜¦ðŸ˜§ðŸ˜¨ðŸ˜°ðŸ˜¥ðŸ˜¢ðŸ˜­ðŸ˜±ðŸ˜–ðŸ˜£ðŸ˜žðŸ˜“ðŸ˜©ðŸ˜«ðŸ¥±ðŸ˜¤ðŸ˜¡ðŸ˜ ðŸ¤¬ðŸ˜ˆðŸ‘¿ðŸ’€â˜ ðŸ’©ðŸ¤¡ðŸ‘¹ðŸ‘ºðŸ‘»ðŸ‘½ðŸ‘¾ðŸ¤–ðŸ˜ºðŸ˜¸ðŸ˜¹ðŸ˜»ðŸ˜¼ðŸ˜½ðŸ™€ðŸ˜¿ðŸ˜¾ðŸ« ðŸ«£ðŸ«¢ðŸ«¡ðŸ«¥ðŸ«¤',
            'Gestos': 'ðŸ‘‹ðŸ¤šðŸ–âœ‹ðŸ––ðŸ«±ðŸ«²ðŸ«³ðŸ«´ðŸ‘ŒðŸ¤ŒðŸ¤âœŒðŸ¤žðŸ«°ðŸ¤ŸðŸ¤˜ðŸ¤™ðŸ‘ˆðŸ‘‰ðŸ‘†ðŸ–•ðŸ‘‡â˜ðŸ«µðŸ‘ðŸ‘ŽâœŠðŸ‘ŠðŸ¤›ðŸ¤œðŸ‘ðŸ™ŒðŸ«¶ðŸ‘ðŸ¤²ðŸ¤ðŸ™âœðŸ’…ðŸ¤³ðŸ’ªðŸ¦¾ðŸ¦¿ðŸ¦µðŸ¦¶ðŸ‘‚ðŸ¦»ðŸ‘ƒðŸ§ ðŸ«€ðŸ«ðŸ¦·ðŸ¦´ðŸ‘€ðŸ‘ðŸ‘…ðŸ‘„ðŸ«¦ðŸ’‹ðŸ«‚',
            'Pessoas': 'ðŸ‘¶ðŸ§’ðŸ‘¦ðŸ‘§ðŸ§‘ðŸ‘±ðŸ‘¨ðŸ§”ðŸ‘©ðŸ§“ðŸ‘´ðŸ‘µðŸ™ðŸ™ŽðŸ™…ðŸ™†ðŸ’ðŸ™‹ðŸ§ðŸ™‡ðŸ¤¦ðŸ¤·ðŸ‘®ðŸ•µðŸ’‚ðŸ¥·ðŸ‘·ðŸ«…ðŸ¤´ðŸ‘¸ðŸ‘³ðŸ‘²ðŸ§•ðŸ¤µðŸ‘°ðŸ¤°ðŸ«ƒðŸ«„ðŸ¤±ðŸ‘¼ðŸŽ…ðŸ¤¶ðŸ¦¸ðŸ¦¹ðŸ§™ðŸ§šðŸ§›ðŸ§œðŸ§ðŸ§žðŸ§ŸðŸ’†ðŸ’‡ðŸš¶ðŸ§ðŸ§ŽðŸƒðŸ’ƒðŸ•ºðŸ•´ðŸ‘¯ðŸ§–ðŸ§—ðŸ¤¸ðŸŒðŸ‡â›·ðŸ‚ðŸ‹ðŸ¤¼ðŸ¤½ðŸ¤¾ðŸ¤ºâ›¹ðŸŠðŸš£ðŸ§˜ðŸ›€ðŸ›ŒðŸ‘­ðŸ‘«ðŸ‘¬ðŸ’ðŸ’‘ðŸ‘ªðŸ‘¨â€ðŸ‘©â€ðŸ‘¦ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ðŸ—£ðŸ‘¤ðŸ‘¥ðŸ«‚',
            'Animais': 'ðŸ¶ðŸ±ðŸ­ðŸ¹ðŸ°ðŸ¦ŠðŸ»ðŸ¼ðŸ»â€â„ï¸ðŸ¨ðŸ¯ðŸ¦ðŸ®ðŸ·ðŸ½ðŸ¸ðŸµðŸ™ˆðŸ™‰ðŸ™ŠðŸ’ðŸ”ðŸ§ðŸ¦ðŸ¤ðŸ£ðŸ¥ðŸ¦†ðŸ¦…ðŸ¦‰ðŸ¦‡ðŸºðŸ—ðŸ´ðŸ¦„ðŸðŸª±ðŸ›ðŸ¦‹ðŸŒðŸžðŸœðŸª°ðŸª²ðŸª³ðŸ¦ŸðŸ¦—ðŸ•·ðŸ•¸ðŸ¦‚ðŸ¢ðŸðŸ¦ŽðŸ¦–ðŸ¦•ðŸ™ðŸ¦‘ðŸ¦ðŸ¦žðŸ¦€ðŸª¸ðŸ¡ðŸ ðŸŸðŸ¬ðŸ³ðŸ‹ðŸ¦ˆðŸ¦­ðŸŠðŸ…ðŸ†ðŸ¦“ðŸ¦ðŸ¦§ðŸ¦£ðŸ˜ðŸ¦›ðŸ¦ðŸªðŸ«ðŸ¦’ðŸ¦˜ðŸ¦¬ðŸƒðŸ‚ðŸ„ðŸŽðŸ–ðŸðŸ‘ðŸ¦™ðŸðŸ¦ŒðŸ•ðŸ©ðŸ¦®ðŸˆðŸˆâ€â¬›ðŸª¶ðŸ“ðŸ¦ƒðŸ¦¤ðŸ¦šðŸ¦œðŸ¦¢ðŸ¦©ðŸ•ŠðŸ‡ðŸ¦ðŸ¦¨ðŸ¦¡ðŸ¦«ðŸ¦¦ðŸ¦¥ðŸðŸ€ðŸ¿ðŸ¦”ðŸ¾ðŸ‰ðŸ²ðŸŒµðŸŽ„ðŸŒ²ðŸŒ³ðŸŒ´ðŸªµðŸŒ±ðŸŒ¿â˜˜ðŸ€ðŸŽðŸª´ðŸŽ‹ðŸƒðŸ‚ðŸðŸªºðŸª¹',
            'Natureza': 'ðŸŒ¸ðŸ’ðŸŒ·ðŸŒ¹ðŸ¥€ðŸŒºðŸŒ»ðŸŒ¼ðŸŒ±ðŸŒ²ðŸŒ³ðŸŒ´ðŸŒµðŸŒ¾ðŸ€â˜˜ðŸƒðŸ‚ðŸðŸ„ðŸšðŸª¨ðŸŒðŸŒŽðŸŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒ™ðŸŒšðŸŒ›ðŸŒœâ˜€ðŸŒðŸŒžâ­ðŸŒŸðŸŒ â˜â›…â›ˆðŸŒ¤ðŸŒ¥ðŸŒ¦ðŸŒ§ðŸŒ¨ðŸŒ©ðŸŒªðŸŒ«ðŸŒ¬ðŸŒ€ðŸŒˆðŸŒ‚â˜‚â˜”â›±âš¡â„â˜ƒâ›„ðŸ”¥ðŸ’§ðŸŒŠðŸŽ„âœ¨ðŸ’«ðŸª',
            'Comida': 'ðŸðŸŽðŸðŸŠðŸ‹ðŸŒðŸ‰ðŸ‡ðŸ“ðŸ«ðŸˆðŸ’ðŸ‘ðŸ¥­ðŸðŸ¥¥ðŸ¥ðŸ…ðŸ†ðŸ¥‘ðŸ¥¦ðŸ¥¬ðŸ¥’ðŸŒ¶ðŸ«‘ðŸŒ½ðŸ¥•ðŸ«’ðŸ§„ðŸ§…ðŸ¥”ðŸ ðŸ«˜ðŸ¥œðŸŒ°ðŸžðŸ¥ðŸ¥–ðŸ«“ðŸ¥¨ðŸ¥¯ðŸ¥žðŸ§‡ðŸ§€ðŸ–ðŸ—ðŸ¥©ðŸ¥“ðŸ”ðŸŸðŸ•ðŸŒ­ðŸ¥ªðŸŒ®ðŸŒ¯ðŸ«”ðŸ¥™ðŸ§†ðŸ¥šðŸ³ðŸ¥˜ðŸ²ðŸ«•ðŸ¥£ðŸ¥—ðŸ¿ðŸ§ˆðŸ§‚ðŸ¥«ðŸ±ðŸ˜ðŸ™ðŸšðŸ›ðŸœðŸðŸ¢ðŸ£ðŸ¤ðŸ¥ðŸ¥®ðŸ¡ðŸ¥ŸðŸ¥ ðŸ¥¡ðŸ¦€ðŸ¦žðŸ¦ðŸ¦‘ðŸ¦ªðŸ¦ðŸ§ðŸ¨ðŸ©ðŸªðŸŽ‚ðŸ°ðŸ§ðŸ¥§ðŸ«ðŸ¬ðŸ­ðŸ®ðŸ¯ðŸ¼ðŸ¥›â˜•ðŸ«–ðŸµðŸ¶ðŸ¾ðŸ·ðŸ¸ðŸ¹ðŸºðŸ»ðŸ¥‚ðŸ¥ƒðŸ«—ðŸ¥¤ðŸ§‹ðŸ§ƒðŸ§‰ðŸ§ŠðŸ¥¢ðŸ½ðŸ´ðŸ¥„ðŸ”ªðŸ«™ðŸº',
            'Atividades': 'âš½ðŸ€ðŸˆâš¾ðŸ¥ŽðŸŽ¾ðŸðŸ‰ðŸ¥ðŸŽ±ðŸª€ðŸ“ðŸ¸ðŸ’ðŸ‘ðŸ¥ðŸðŸªƒðŸ¥…â›³ðŸªðŸ¹ðŸŽ£ðŸ¤¿ðŸ¥ŠðŸ¥‹ðŸŽ½ðŸ›¹ðŸ›¼ðŸ›·â›¸ðŸ¥ŒðŸŽ¿â›·ðŸ‚ðŸ‹ðŸ¤¸ðŸ¤ºâ›¹ðŸ¤¾ðŸŒðŸ‡ðŸ§˜ðŸ„ðŸŠðŸ¤½ðŸš£ðŸ§—ðŸšµðŸš´ðŸ†ðŸ¥‡ðŸ¥ˆðŸ¥‰ðŸ…ðŸŽ–ðŸµðŸŽ—ðŸŽ«ðŸŽŸðŸŽªðŸ¤¹ðŸŽ­ðŸ©°ðŸŽ¨ðŸŽ¬ðŸŽ¤ðŸŽ§ðŸŽ¼ðŸŽ¹ðŸ¥ðŸª˜ðŸŽ·ðŸŽºðŸŽ¸ðŸª•ðŸŽ»ðŸª—ðŸŽ²â™ŸðŸŽ¯ðŸŽ³ðŸŽ®ðŸŽ°ðŸ§©',
            'Objetos': 'âŒšðŸ“±ðŸ“²ðŸ’»âŒ¨ðŸ–¥ðŸ–¨ðŸ–±ðŸ–²ðŸ•¹ðŸ—œðŸ’½ðŸ’¾ðŸ’¿ðŸ“€ðŸ“¼ðŸ“·ðŸ“¸ðŸ“¹ðŸŽ¥ðŸ“½ðŸŽžðŸ“žâ˜ŽðŸ“ŸðŸ“ ðŸ“ºðŸ“»ðŸŽ™ðŸŽšðŸŽ›ðŸ§­â±â²â°ðŸ•°âŒ›â³ðŸ“¡ðŸ”‹ðŸª«ðŸ”ŒðŸ’¡ðŸ”¦ðŸ•¯ðŸª”ðŸ§¯ðŸ›¢ðŸ’¸ðŸ’µðŸ’´ðŸ’¶ðŸ’·ðŸª™ðŸ’°ðŸ’³ðŸªªðŸ’Žâš–ðŸªœðŸ§°ðŸª›ðŸ”§ðŸ”©âš™ðŸª¤ðŸ§²ðŸ”«ðŸ’£ðŸª“ðŸ”ªðŸ—¡âš”ðŸ›¡ðŸš¬âš°ðŸª¦âš±ðŸºðŸ”®ðŸ“¿ðŸ§¿ðŸª¬ðŸ’ˆâš—ðŸ”­ðŸ”¬ðŸ•³ðŸª£ðŸ©¹ðŸ©ºðŸ©»ðŸ’ŠðŸ’‰ðŸ©¸ðŸ§¬ðŸ¦ ðŸ§«ðŸ§ªðŸŒ¡ðŸ§¹ðŸª ðŸ§ºðŸ§»ðŸš½ðŸš°ðŸš¿ðŸ›ðŸ›€ðŸ§¼ðŸª¥ðŸª’ðŸ§½ðŸª£ðŸªžðŸªŸðŸ›ðŸ›‹ðŸª‘ðŸšªðŸ§³',
            'Viagem': 'ðŸš—ðŸš•ðŸš™ðŸšŒðŸšŽðŸŽðŸš“ðŸš‘ðŸš’ðŸšðŸ›»ðŸššðŸš›ðŸšœðŸðŸ›µðŸš²ðŸ›´ðŸ›¹ðŸ›¼ðŸšðŸ›£ðŸ›¤ðŸ›žâ›½ðŸš¨ðŸš¥ðŸš¦ðŸ›‘ðŸš§âš“ðŸ›Ÿâ›µðŸ›¶ðŸš¤ðŸ›³â›´ðŸ›¥ðŸš¢âœˆðŸ›©ðŸ›«ðŸ›¬ðŸª‚ðŸ’ºðŸšðŸšŸðŸš ðŸš¡ðŸ›°ðŸš€ðŸ›¸ðŸ ðŸ¡ðŸ¢ðŸ£ðŸ¤ðŸ¥ðŸ¦ðŸ¨ðŸ©ðŸªðŸ«ðŸ¬ðŸ­ðŸ¯ðŸ°ðŸ’’ðŸ—¼ðŸ—½â›ªðŸ•ŒðŸ›•ðŸ•â›©ðŸ•‹â›²â›ºðŸŒðŸŒƒðŸ™ðŸŒ„ðŸŒ…ðŸŒ†ðŸŒ‡ðŸŒ‰â™¨ðŸŽ ðŸ›ðŸŽ¡ðŸŽ¢ðŸ’ˆðŸŽªðŸ—ºðŸ—¾ðŸ§­ðŸ”â›°ðŸŒ‹ðŸ—»ðŸ•ðŸ–ðŸœðŸðŸž',
            'CoraÃ§Ãµes': 'â¤ðŸ§¡ðŸ’›ðŸ’šðŸ’™ðŸ’œðŸ–¤ðŸ¤ðŸ¤ŽðŸ’”â¤â€ðŸ”¥â¤â€ðŸ©¹â£ðŸ’•ðŸ’žðŸ’“ðŸ’—ðŸ’–ðŸ’˜ðŸ’ðŸ’ŸðŸ«€â™¥ðŸ’ŒðŸ’’ðŸ’ðŸ’Ž',
            'Bandeiras': 'ðŸ³ðŸ´ðŸðŸš©ðŸ³ï¸â€ðŸŒˆðŸ³ï¸â€âš§ï¸ðŸ‡§ðŸ‡·ðŸ‡ºðŸ‡¸ðŸ‡µðŸ‡¹ðŸ‡¦ðŸ‡·ðŸ‡¨ðŸ‡±ðŸ‡¨ðŸ‡´ðŸ‡²ðŸ‡½ðŸ‡µðŸ‡ªðŸ‡ºðŸ‡¾ðŸ‡ªðŸ‡¸ðŸ‡«ðŸ‡·ðŸ‡©ðŸ‡ªðŸ‡®ðŸ‡¹ðŸ‡¬ðŸ‡§ðŸ‡¯ðŸ‡µðŸ‡¨ðŸ‡³ðŸ‡°ðŸ‡·ðŸ‡®ðŸ‡³ðŸ‡·ðŸ‡ºðŸ‡¨ðŸ‡¦ðŸ‡¦ðŸ‡ºðŸ‡¿ðŸ‡¦ðŸ‡³ðŸ‡¬ðŸ‡ªðŸ‡¬ðŸ‡¸ðŸ‡¦ðŸ‡¦ðŸ‡ªðŸ‡¹ðŸ‡·ðŸ‡®ðŸ‡±ðŸ‡µðŸ‡±ðŸ‡³ðŸ‡±ðŸ‡§ðŸ‡ªðŸ‡¨ðŸ‡­ðŸ‡¦ðŸ‡¹ðŸ‡¸ðŸ‡ªðŸ‡³ðŸ‡´ðŸ‡©ðŸ‡°ðŸ‡«ðŸ‡®ðŸ‡®ðŸ‡ªðŸ‡³ðŸ‡¿ðŸ‡¸ðŸ‡¬ðŸ‡¹ðŸ‡­ðŸ‡»ðŸ‡³ðŸ‡µðŸ‡­ðŸ‡®ðŸ‡©ðŸ‡²ðŸ‡¾ðŸ‡§ðŸ‡´ðŸ‡ªðŸ‡¨ðŸ‡µðŸ‡¾ðŸ‡µðŸ‡¦ðŸ‡¨ðŸ‡·ðŸ‡¬ðŸ‡¹ðŸ‡­ðŸ‡³ðŸ‡¸ðŸ‡»ðŸ‡³ðŸ‡®ðŸ‡¨ðŸ‡ºðŸ‡©ðŸ‡´ðŸ‡µðŸ‡·ðŸ‡­ðŸ‡¹ðŸ‡¯ðŸ‡²ðŸ‡§ðŸ‡¸ðŸ‡¹ðŸ‡¹ðŸ‡§ðŸ‡§ðŸ‡¬ðŸ‡¾ðŸ‡¸ðŸ‡·',
            'SÃ­mbolos': 'â˜®âœâ˜ªðŸ•‰â˜¸âœ¡ðŸ”¯ðŸ•Žâ˜¯â˜¦ðŸ›â›Žâ™ˆâ™‰â™Šâ™‹â™Œâ™â™Žâ™â™â™‘â™’â™“ðŸ†”âš›ðŸ‰‘â˜¢â˜£ðŸ“´ðŸ“³ðŸˆ¶ðŸˆšðŸˆ¸ðŸˆºðŸˆ·âœ´ðŸ†šðŸ’®ðŸ‰ãŠ™ãŠ—ðŸˆ´ðŸˆµðŸˆ¹ðŸˆ²ðŸ…°ðŸ…±ðŸ†ŽðŸ†‘ðŸ…¾ðŸ†˜âŒâ­•ðŸ›‘â›”ðŸ“›ðŸš«ðŸ’¯ðŸ’¢â™¨ðŸš·ðŸš¯ðŸš³ðŸš±ðŸ”žðŸ“µðŸš­â—â•â“â”â€¼â‰ðŸ”…ðŸ”†ã€½âš ðŸš¸ðŸ”±âšœðŸ”°â™»âœ…ðŸˆ¯ðŸ’¹â‡âœ³âŽðŸŒðŸ’ â“‚ðŸŒ€ðŸ’¤ðŸ§ðŸš¾â™¿ðŸ…¿ðŸ›—ðŸˆ³ðŸˆ‚ðŸ›‚ðŸ›ƒðŸ›„ðŸ›…ðŸš¹ðŸšºðŸš¼âš§ðŸš»ðŸš®ðŸŽ¦ðŸ“¶ðŸˆðŸ”£â„¹ðŸ”¤ðŸ”¡ðŸ” ðŸ†–ðŸ†—ðŸ†™ðŸ†’ðŸ†•ðŸ†“0ï¸âƒ£1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£9ï¸âƒ£ðŸ”ŸðŸ”¢#ï¸âƒ£*ï¸âƒ£ââ–¶â¸â¯â¹âºâ­â®â©âªâ«â¬â—€ðŸ”¼ðŸ”½âž¡â¬…â¬†â¬‡â†—â†˜â†™â†–â†•â†”â†©â†ªâ¤´â¤µðŸ”€ðŸ”ðŸ”‚ðŸ”„ðŸ”ƒðŸŽµðŸŽ¶âž•âž–âž—âœ–ðŸŸ°â™¾ðŸ’²ðŸ’±â„¢Â©Â®ðŸ”šðŸ”™ðŸ”›ðŸ”ðŸ”œã€°âž°âž¿âœ”â˜‘ðŸ”˜ðŸ”´ðŸŸ ðŸŸ¡ðŸŸ¢ðŸ”µðŸŸ£âš«âšªðŸŸ¤ðŸ”ºðŸ”»ðŸ”¸ðŸ”¹ðŸ”¶ðŸ”·ðŸ”³ðŸ”²â–ªâ–«â—¾â—½â—¼â—»ðŸŸ¥ðŸŸ§ðŸŸ¨ðŸŸ©ðŸŸ¦ðŸŸªâ¬›â¬œðŸ”ˆðŸ”‡ðŸ”‰ðŸ”ŠðŸ””ðŸ”•ðŸ“£ðŸ“¢ðŸ’¬ðŸ’­ðŸ—¯â™ â™£â™¥â™¦ðŸƒðŸŽ´ðŸ€„ðŸ•ðŸ•‘ðŸ•’ðŸ•“ðŸ•”ðŸ••ðŸ•–ðŸ•—ðŸ•˜ðŸ•™ðŸ•šðŸ•›ðŸ•œðŸ•ðŸ•žðŸ•ŸðŸ• ðŸ•¡ðŸ•¢ðŸ•£ðŸ•¤ðŸ•¥ðŸ•¦ðŸ•§'
        };
        let emojiTarget = null;
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');
        const emojiSearch = document.getElementById('emoji-search');

        function renderEmojiGrid(filter = '') {
            let html = '';
            for (const [cat, emojis] of Object.entries(EMOJIS)) {
                // Regex robusta: captura ZWJ sequences, flags, keycaps, skin tones, variation selectors
                const emojiList = emojis.match(/\p{RI}\p{RI}|\p{Emoji}(\p{EMod}|\uFE0F\u20E3?|[\u200d](\p{Emoji}|\uFE0F))*(\uFE0F)?/gu)?.filter(e => e.trim() && !/^[\d#*]$/.test(e)) || [];
                const filtered = filter ? emojiList.filter(e => e.includes(filter)) : emojiList;
                if (filtered.length === 0) continue;
                html += `<div style="grid-column:1/-1; font-size:0.65rem; color:#9ca3af; font-weight:700; padding:4px 2px; text-transform:uppercase;">${cat}</div>`;
                filtered.forEach(e => {
                    html += `<div class="emoji-cell" style="cursor:pointer; padding:4px; border-radius:8px; line-height:1; transition:background 0.1s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background=''">${e}</div>`;
                });
            }
            emojiGrid.innerHTML = html;
        }

        function openEmojiPicker(triggerBtn) {
            emojiTarget = document.getElementById(triggerBtn.dataset.target);
            const rect = triggerBtn.getBoundingClientRect();
            emojiPicker.style.display = 'flex';
            emojiPicker.style.left = Math.min(rect.right - 280, window.innerWidth - 290) + 'px';
            emojiPicker.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
            emojiSearch.value = '';
            renderEmojiGrid();
        }

        function closeEmojiPicker() {
            emojiPicker.style.display = 'none';
            emojiTarget = null;
        }

        // Event delegation for emoji triggers
        document.addEventListener('click', (e) => {
            const trigger = e.target.closest('.emoji-trigger');
            if (trigger) {
                e.stopPropagation();
                if (emojiPicker.style.display === 'flex') closeEmojiPicker();
                else openEmojiPicker(trigger);
                return;
            }
            if (!e.target.closest('#emoji-picker')) closeEmojiPicker();
        });

        emojiGrid.addEventListener('click', (e) => {
            const cell = e.target.closest('.emoji-cell');
            if (cell && emojiTarget) {
                const emoji = cell.textContent;
                // Insert emoji at cursor or at end
                if (emojiTarget.selectionStart !== undefined) {
                    const start = emojiTarget.selectionStart;
                    const end = emojiTarget.selectionEnd;
                    emojiTarget.value = emojiTarget.value.substring(0, start) + emoji + emojiTarget.value.substring(end);
                    emojiTarget.selectionStart = emojiTarget.selectionEnd = start + emoji.length;
                } else {
                    emojiTarget.value += emoji;
                }
                emojiTarget.focus();
                emojiTarget.dispatchEvent(new Event('input'));
            }
        });

        emojiSearch.addEventListener('input', () => renderEmojiGrid(emojiSearch.value));
        emojiPicker.addEventListener('click', (e) => e.stopPropagation());

        init();
    </script>

    <!-- Bottom Nav Collapse -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('main-bottom-nav');
            const handle = document.getElementById('bottom-nav-handle');
            if (bottomNav) {
                const toggleNav = (e) => { e.stopPropagation(); bottomNav.classList.toggle('collapsed'); };
                handle?.addEventListener('click', toggleNav);
                bottomNav.addEventListener('click', (e) => { if (bottomNav.classList.contains('collapsed')) toggleNav(e); });
            }
        });
    </script>

    <script src="js/protect.js"></script>
</body>
</html>
