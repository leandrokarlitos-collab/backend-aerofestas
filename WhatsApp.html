<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - Aero Festas</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="js/pwa-init.js"></script>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üí¨</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --wa-green: #25D366;
            --wa-dark-green: #128C7E;
            --wa-light-green: #dcf8c6;
            --wa-bg: #e5ddd5;
            --primary: #4f46e5;
            --secondary: #a855f7;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #1f2937; }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .form-input {
            background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937;
            border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: all 0.2s ease-in-out;
        }
        .form-input::placeholder { color: #6b7280; }
        .form-input:focus { outline: none; box-shadow: 0 0 0 2px var(--wa-green); border-color: var(--wa-green); }

        .shiny-btn {
            position: relative; border: 2px solid transparent;
            background-image: linear-gradient(to right, var(--wa-dark-green) 0%, var(--wa-green) 51%, var(--wa-dark-green) 100%);
            background-size: 200% auto; color: white;
            box-shadow: 0 4px 15px 0 rgba(37, 211, 102, 0.4); transition: all 0.4s ease;
        }
        .shiny-btn:hover { background-position: right center; transform: translateY(-2px); box-shadow: 0 8px 25px 0 rgba(37, 211, 102, 0.6); }
        .shiny-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }

        /* Chat bubbles */
        .bubble-received {
            background: white; border-radius: 0 12px 12px 12px; max-width: 75%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        .bubble-sent {
            background: var(--wa-light-green); border-radius: 12px 0 12px 12px; max-width: 75%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Conversation item */
        .conv-item { transition: background 0.15s ease; }
        .conv-item:hover { background: rgba(255,255,255,0.5); }
        .conv-item.active { background: rgba(37, 211, 102, 0.08); border-left: 3px solid var(--wa-green); }

        /* Instance tabs */
        .instance-tab {
            padding: 0.5rem 1.25rem; border-radius: 20px; font-weight: 600; font-size: 0.875rem;
            cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
        }
        .instance-tab.active { background: var(--wa-green); color: white; box-shadow: 0 4px 12px rgba(37,211,102,0.3); }
        .instance-tab:not(.active) { background: rgba(255,255,255,0.5); color: #6b7280; }
        .instance-tab:not(.active):hover { background: rgba(255,255,255,0.8); }

        /* Unread badge */
        .unread-badge {
            background: var(--wa-green); color: white; font-size: 0.7rem; font-weight: 700;
            min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; padding: 0 5px;
        }

        /* Status indicator */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-dot.connected { background: var(--wa-green); box-shadow: 0 0 6px rgba(37,211,102,0.5); }
        .status-dot.disconnected { background: #ef4444; }
        .status-dot.connecting { background: #f59e0b; animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Bottom nav (same as CRM) */
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 480px; height: 75px; background: rgba(255,255,255,0.6); backdrop-filter: blur(30px) saturate(210%); -webkit-backdrop-filter: blur(30px) saturate(210%); border: 1px solid rgba(255,255,255,0.4); display: flex; justify-content: space-around; align-items: center; padding: 12px 10px 0 10px; z-index: 10000; border-radius: 40px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(255,255,255,0.8); transition: all 0.7s cubic-bezier(0.19,1,0.22,1); user-select: none; overflow: hidden; }
        .bottom-nav-handle { position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .bottom-nav-handle::after { content: ''; width: 40px; height: 4px; background: rgba(79,70,229,0.2); border-radius: 10px; transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav-handle i { position: absolute; font-size: 1.2rem; color: #4f46e5; opacity: 0; transform: translateY(10px); transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav.collapsed { transform: translateX(-50%) translateY(15px); width: 80px; height: 48px; padding: 0; border-radius: 100px; background: rgba(255,255,255,0.5); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .bottom-nav.collapsed .nav-item { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .bottom-nav.collapsed .bottom-nav-handle::after { opacity: 0; transform: scaleX(0); }
        .bottom-nav.collapsed .bottom-nav-handle i { opacity: 1; transform: translateY(0); }
        @media (min-width: 1024px) { .bottom-nav { display: none; } }
        .nav-item { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; width: 55px; height: 100%; text-decoration: none; z-index: 1; transition: all 0.6s cubic-bezier(0.19,1,0.22,1); }
        .nav-item::before { content: ''; position: absolute; top: 50%; left: 50%; width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 16px; transform: translate(-50%,-50%) scale(0); opacity: 0; z-index: -1; transition: all 0.5s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 8px 16px rgba(79,70,229,0.3); }
        .nav-item.active { color: white; transform: translateY(-8px); }
        .nav-item.active::before { transform: translate(-50%,-60%) scale(1); opacity: 1; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; }
        .nav-item.active span { opacity: 1; transform: translateY(2px); color: #4f46e5; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 8px; font-size: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        @media (max-width: 768px) { .container { padding-bottom: 100px; } }

        /* Toast */
        #toast { position: fixed; top: 20px; right: 20px; z-index: 99999; }
        .toast-enter { animation: toast-in 0.5s ease-out forwards; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* QR Modal */
        #qr-modal.hidden { display: none; }
        .modal-hidden { display: none !important; }

        /* Attach menu item hover */
        .attach-menu-item:hover { background: #f3f4f6 !important; }

        /* Shortcuts popup */
        .shortcuts-popup {
            position: fixed;
            background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            max-height: 200px; overflow-y: auto; z-index: 10000;
            width: 300px;
        }
        .shortcut-item {
            padding: 10px 14px; cursor: pointer; transition: background 0.1s;
            border-bottom: 1px solid #f3f4f6;
        }
        .shortcut-item:hover { background: #f0fdf4; }
        .shortcut-item:last-child { border-bottom: none; }

        /* Audio recording */
        .recording-indicator {
            display: flex; align-items: center; gap: 8px; color: #ef4444; font-size: 0.85rem;
            animation: recording-pulse 1.2s infinite;
        }
        @keyframes recording-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Media preview in messages */
        .media-bubble img, .media-bubble video { max-width: 100%; border-radius: 8px; cursor: pointer; }
        .media-bubble audio { width: 100%; max-width: 280px; }

        /* Catalog grid */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .catalog-item {
            background: white; border-radius: 12px; overflow: hidden; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s;
        }
        .catalog-item:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .catalog-item img { width: 100%; height: 120px; object-fit: cover; }

        /* Sidebar */
        .wa-sidebar {
            width: 56px; background: #1f2937; display: flex; flex-direction: column;
            align-items: center; padding: 12px 0; gap: 4px; border-radius: 16px 0 0 16px;
            flex-shrink: 0;
        }
        .wa-sidebar-btn {
            width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; color: #9ca3af; cursor: pointer; transition: all 0.2s;
            position: relative; border: none; background: transparent; font-size: 1rem;
        }
        .wa-sidebar-btn:hover { background: rgba(255,255,255,0.1); color: #d1d5db; }
        .wa-sidebar-btn.active { background: var(--wa-green); color: white; box-shadow: 0 4px 12px rgba(37,211,102,0.4); }
        .wa-sidebar-btn .sidebar-badge {
            position: absolute; top: 2px; right: 2px; background: #ef4444; color: white;
            font-size: 0.55rem; min-width: 16px; height: 16px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-weight: 700;
        }
        .wa-sidebar-spacer { flex: 1; }
        @media (max-width: 1023px) { .wa-sidebar { display: none; } }

        /* Main layout wrapper */
        .wa-main-wrapper {
            display: flex; height: calc(100vh - 140px); border-radius: 16px; overflow: hidden;
        }
        @media (max-width: 768px) {
            .wa-main-wrapper { height: calc(100vh - 180px); border-radius: 12px; }
        }

        /* Side panels */
        .wa-side-panel {
            width: 340px; flex-shrink: 0; display: flex; flex-direction: column;
            background: rgba(255,255,255,0.6); border-right: 1px solid rgba(200,200,200,0.3);
        }
        @media (max-width: 1023px) {
            .wa-side-panel { width: 100%; border-right: none; }
            .wa-side-panel.mobile-hidden { display: none; }
        }
        @media (min-width: 1024px) {
            .wa-side-panel { display: flex !important; }
        }

        /* Chat panel flex */
        .wa-chat-panel {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }
        @media (max-width: 1023px) {
            .wa-chat-panel.mobile-hidden { display: none; }
        }

        /* Contact details panel */
        .wa-details-panel {
            width: 320px; flex-shrink: 0; display: none; flex-direction: column;
            background: rgba(255,255,255,0.8); border-left: 1px solid rgba(200,200,200,0.3);
            overflow-y: auto;
        }
        .wa-details-panel.open { display: flex; }
        @media (max-width: 1280px) {
            .wa-details-panel.open {
                position: fixed; right: 0; top: 0; bottom: 0; z-index: 15000;
                width: 100%; max-width: 360px; box-shadow: -4px 0 24px rgba(0,0,0,0.15);
                background: white;
            }
        }

        /* Status ring on avatar */
        .status-ring { box-shadow: 0 0 0 2px var(--wa-green); }

        /* Archived bar */
        .archived-bar {
            display: flex; align-items: center; gap: 8px; padding: 12px 16px;
            cursor: pointer; transition: background 0.15s; color: var(--wa-green); font-weight: 600; font-size: 0.85rem;
        }
        .archived-bar:hover { background: rgba(37,211,102,0.05); }

        /* Muted icon in conv list */
        .muted-icon { color: #9ca3af; font-size: 0.7rem; }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto p-4 md:p-6 relative z-10 max-w-7xl">

        <!-- Header (compact) -->
        <header class="lg:hidden glassmorphism p-3 rounded-xl mb-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fab fa-whatsapp text-[var(--wa-green)] text-xl"></i>
                <h1 class="text-lg font-bold">WhatsApp</h1>
            </div>
            <div class="flex items-center gap-1">
                <span class="status-dot disconnected" id="connection-status-dot-mobile" style="width:6px;height:6px;"></span>
            </div>
        </header>

        <!-- Main Layout with Sidebar -->
        <div class="wa-main-wrapper glassmorphism">
            <!-- Sidebar -->
            <div class="wa-sidebar">
                <button class="wa-sidebar-btn active" data-panel="chats" title="Conversas"><i class="fas fa-comment-dots"></i></button>
                <button class="wa-sidebar-btn" data-panel="groups" title="Grupos"><i class="fas fa-users"></i></button>
                <button class="wa-sidebar-btn" data-panel="status" title="Status"><i class="fas fa-circle-notch"></i></button>
                <button class="wa-sidebar-btn" data-panel="catalog" title="Cat√°logo"><i class="fas fa-store"></i></button>
                <div class="wa-sidebar-spacer"></div>
                <button class="wa-sidebar-btn" data-panel="settings" title="Configura√ß√µes"><i class="fas fa-cog"></i></button>
            </div>

            <!-- Side Panel (Conversations / Groups / Status / Settings) -->
            <div id="conversation-panel" class="wa-side-panel">
                <!-- Side panel header -->
                <div class="p-3 border-b border-gray-200/50">
                    <div class="flex items-center justify-between mb-2">
                        <h2 id="side-panel-title" class="font-bold text-gray-900">Conversas</h2>
                        <div class="flex gap-1">
                            <button id="new-conversation-btn" class="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition" title="Nova conversa">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button id="sync-history-btn" class="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition" title="Sincronizar hist√≥rico">
                                <i class="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Instance Tabs -->
                    <div class="flex gap-1 mb-2" id="instance-tabs">
                        <button class="instance-tab active text-xs py-1.5 px-3" data-instance="aero-festas">
                            Aero <span class="ml-1 text-[10px]" id="badge-aero-festas"></span>
                        </button>
                        <button class="instance-tab text-xs py-1.5 px-3" data-instance="abc-festas">
                            ABC <span class="ml-1 text-[10px]" id="badge-abc-festas"></span>
                        </button>
                        <div class="flex items-center gap-1 ml-auto">
                            <span class="status-dot disconnected" id="connection-status-dot" style="width:6px;height:6px;"></span>
                            <span class="text-[10px] text-gray-400" id="connection-status-text">...</span>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="search-conversations" placeholder="Buscar conversa..."
                            class="form-input w-full pl-9 pr-4 py-2 rounded-xl text-sm">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search text-xs"></i>
                        </span>
                    </div>
                </div>

                <!-- Archived bar -->
                <div id="archived-bar" class="archived-bar hidden" onclick="toggleArchivedView()">
                    <i class="fas fa-archive"></i>
                    <span>Arquivados (<span id="archived-count">0</span>)</span>
                </div>

                <!-- Side panel content area -->
                <div id="conversation-list" class="flex-1 overflow-y-auto">
                    <div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                            <p>Carregando conversas...</p>
                        </div>
                    </div>
                </div>

                <!-- Groups panel (hidden by default) -->
                <div id="groups-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Status panel (hidden by default) -->
                <div id="status-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Catalog panel (hidden by default) -->
                <div id="catalog-side-panel" class="flex-1 overflow-y-auto hidden"></div>

                <!-- Settings panel (hidden by default) -->
                <div id="settings-panel" class="flex-1 overflow-y-auto hidden">
                    <div class="p-4 space-y-3">
                        <div id="profile-section" class="text-center py-4">
                            <div class="w-20 h-20 rounded-full bg-[var(--wa-green)] mx-auto mb-3 flex items-center justify-center text-white text-2xl font-bold overflow-hidden cursor-pointer" id="my-profile-pic">
                                <i class="fab fa-whatsapp text-3xl"></i>
                            </div>
                            <h3 id="my-profile-name" class="font-bold text-gray-900">...</h3>
                            <p id="my-profile-status" class="text-xs text-gray-500 mt-1">...</p>
                            <p id="my-profile-phone" class="text-xs text-gray-400 mt-1"></p>
                        </div>
                        <button onclick="openEditProfileModal()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-user-edit text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Editar perfil</span>
                        </button>
                        <button onclick="syncFullHistory()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-history text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Sincronizar hist√≥rico</span>
                        </button>
                        <button onclick="mergeDuplicates()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-compress-alt text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Corrigir conversas duplicadas</span>
                        </button>
                        <button id="connect-btn" class="hidden w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-qrcode text-green-500 w-5 text-center"></i>
                            <span class="text-sm font-medium text-green-600">Conectar WhatsApp</span>
                        </button>
                        <button onclick="disconnectInstance()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 transition text-left text-red-500">
                            <i class="fas fa-sign-out-alt w-5 text-center"></i>
                            <span class="text-sm font-medium">Desconectar</span>
                        </button>
                        <a href="./Dashboard.html" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                            <i class="fas fa-home text-gray-400 w-5 text-center"></i>
                            <span class="text-sm font-medium">Voltar ao Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- New Conversation panel (hidden by default) -->
                <div id="new-conv-panel" class="flex-1 overflow-y-auto hidden">
                    <div class="p-3 border-b border-gray-200/50">
                        <div class="flex items-center gap-2 mb-2">
                            <button onclick="closeNewConvPanel()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-arrow-left"></i></button>
                            <h3 class="font-bold text-sm">Nova conversa</h3>
                        </div>
                        <input type="text" id="search-contacts" placeholder="Buscar contato..." class="form-input w-full pl-9 pr-4 py-2 rounded-xl text-sm">
                    </div>
                    <div id="contacts-list" class="divide-y divide-gray-100"></div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div id="chat-panel" class="wa-chat-panel mobile-hidden">
                <!-- Chat Header -->
                <div id="chat-header" class="p-3 border-b border-gray-200/50 flex items-center justify-between bg-white/30">
                    <div class="flex items-center gap-3 min-w-0 flex-1 cursor-pointer" id="chat-header-contact" onclick="openContactDetails()">
                        <button id="back-to-list-btn" class="lg:hidden text-gray-500 hover:text-gray-700 p-1 flex-shrink-0">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </button>
                        <div class="w-10 h-10 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white font-bold overflow-hidden flex-shrink-0" id="chat-avatar">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 id="chat-contact-name" class="font-semibold text-gray-900 text-sm truncate"></h3>
                            <p id="chat-contact-phone" class="text-xs text-gray-500 truncate"></p>
                            <p id="chat-presence" class="text-[11px] text-green-600 font-medium hidden"></p>
                        </div>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button id="link-crm-btn" class="hidden text-xs bg-indigo-100 text-indigo-700 px-2.5 py-1.5 rounded-lg hover:bg-indigo-200 font-semibold transition">
                            <i class="fas fa-users mr-1"></i> CRM
                        </button>
                        <button id="mute-chat-btn" class="hidden text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center" title="Silenciar" onclick="toggleMuteChat()">
                            <i class="fas fa-bell text-sm"></i>
                        </button>
                        <button id="archive-chat-btn" class="hidden text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center" title="Arquivar" onclick="toggleArchiveChat()">
                            <i class="fas fa-archive text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Sync banner (shown when no messages) -->
                <div id="sync-banner" class="hidden bg-amber-50 text-amber-700 text-xs text-center py-2 px-3 cursor-pointer hover:bg-amber-100 transition" onclick="syncCurrentConversation()">
                    <i class="fas fa-sync-alt mr-1"></i> Sem hist√≥rico. Toque para sincronizar mensagens.
                </div>

                <!-- Messages Area -->
                <div id="messages-area" class="flex-1 overflow-y-auto p-4 space-y-2" style="background: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22><rect fill=%22%23f0f2f5%22 width=%2220%22 height=%2220%22/><circle fill=%22%23e8e8e8%22 cx=%2210%22 cy=%2210%22 r=%221%22/></svg>') repeat;">
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>
                </div>

                <!-- Loading more indicator -->
                <div id="loading-more" class="hidden text-center py-2 text-xs text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-1"></i> Carregando mais mensagens...
                </div>

                <!-- Input Bar -->
                <div id="input-bar" class="hidden p-3 border-t border-gray-200/50 bg-white/50">
                    <div class="relative flex items-end gap-2">
                        <button id="attach-btn" class="text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center flex-shrink-0 rounded-full hover:bg-gray-100 transition" title="Anexar">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        <div class="flex-1 relative">
                            <textarea id="message-input" rows="1" placeholder="Digite uma mensagem ou / para atalhos..."
                                class="form-input w-full resize-none text-sm rounded-2xl pl-4 pr-10 py-2.5 max-h-32"
                                style="field-sizing: content;"></textarea>
                            <button type="button" class="emoji-trigger absolute right-2 bottom-2 text-gray-400 hover:text-amber-500 transition" data-target="message-input" title="Emojis">
                                <i class="far fa-smile text-lg"></i>
                            </button>
                        </div>
                        <button id="send-btn" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="display:none;">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                        <button id="audio-btn" class="text-gray-400 hover:text-[var(--wa-green)] w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 hover:bg-green-50 transition" title="Gravar √°udio">
                            <i class="fas fa-microphone text-lg"></i>
                        </button>
                    </div>
                    <!-- Recording UI (hidden by default) -->
                    <div id="recording-bar" class="items-center gap-3 py-2" style="display:none !important;">
                        <button id="cancel-recording" class="text-red-500 hover:text-red-700 w-10 h-10 flex items-center justify-center"><i class="fas fa-trash"></i></button>
                        <div class="recording-indicator flex-1"><i class="fas fa-circle text-xs"></i> <span id="recording-time">0:00</span> ‚Äî Gravando...</div>
                        <button id="send-recording" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                    <!-- Hidden file inputs -->
                    <input type="file" id="file-input-image" accept="image/*" class="hidden">
                    <input type="file" id="file-input-video" accept="video/*" class="hidden">
                    <input type="file" id="file-input-document" accept="*/*" class="hidden">
                </div>
            </div>

            <!-- Contact Details Panel -->
            <div id="contact-details-panel" class="wa-details-panel">
                <div class="p-3 border-b border-gray-200/50 flex items-center gap-2">
                    <button onclick="closeContactDetails()" class="text-gray-500 hover:text-gray-700 w-8 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
                    <h3 class="font-bold text-sm">Dados do contato</h3>
                </div>
                <div id="contact-details-content" class="p-4"></div>
            </div>
        </div>
    </div>

    <!-- Catalog Modal -->
    <div id="catalog-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-store text-green-600 mr-2"></i>Cat√°logo</h3>
                <button id="close-catalog-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="catalog-content" class="flex-1 overflow-y-auto">
                <div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando cat√°logo...</p></div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker (fixed, outside overflow containers) -->
    <div id="emoji-picker" style="display:none; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.18); z-index:99999; width:280px; max-height:320px; overflow:hidden; flex-direction:column;">
        <div style="padding:8px 10px; border-bottom:1px solid #eee;">
            <input type="text" id="emoji-search" placeholder="Buscar emoji..." style="width:100%; border:1px solid #e5e7eb; border-radius:20px; padding:6px 12px; font-size:0.8rem; outline:none;">
        </div>
        <div id="emoji-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px; padding:8px; overflow-y:auto; max-height:260px; font-size:1.4rem; text-align:center;"></div>
    </div>

    <!-- Shortcuts popup (fixed, outside overflow containers) -->
    <div id="shortcuts-popup" class="shortcuts-popup" style="display:none !important;"></div>

    <!-- Attach Menu (fixed, outside overflow containers) -->
    <div id="attach-menu" style="display:none; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.15); padding:12px; z-index:99999;">
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
            <div class="attach-menu-item" data-action="image" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#a855f7;"><i class="fas fa-image"></i></div>
                <span>Imagem</span>
            </div>
            <div class="attach-menu-item" data-action="video" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#ef4444;"><i class="fas fa-video"></i></div>
                <span>V√≠deo</span>
            </div>
            <div class="attach-menu-item" data-action="document" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#3b82f6;"><i class="fas fa-file"></i></div>
                <span>Documento</span>
            </div>
            <div class="attach-menu-item" data-action="catalog" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#16a34a;"><i class="fas fa-store"></i></div>
                <span>Cat√°logo</span>
            </div>
            <div class="attach-menu-item" data-action="contact" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#0ea5e9;"><i class="fas fa-address-book"></i></div>
                <span>Contato</span>
            </div>
            <div class="attach-menu-item" data-action="shortcuts-manage" style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px 10px; border-radius:12px; cursor:pointer; font-size:0.75rem; color:#6b7280; font-weight:600;">
                <div style="width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.1rem; background:#f59e0b;"><i class="fas fa-bolt"></i></div>
                <span>Atalhos</span>
            </div>
        </div>
    </div>

    <!-- Shortcuts Manager Modal -->
    <div id="shortcuts-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-bolt text-amber-500 mr-2"></i>Atalhos R√°pidos</h3>
                <button id="close-shortcuts-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <button id="add-shortcut-btn" class="w-full mb-3 py-2 px-4 bg-amber-50 text-amber-700 rounded-xl text-sm font-semibold hover:bg-amber-100 transition">
                <i class="fas fa-plus mr-1"></i> Novo Atalho
            </button>
            <div id="shortcuts-list" class="flex-1 overflow-y-auto space-y-2">
                <p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>
            </div>
            <!-- Add/Edit form (hidden) -->
            <div id="shortcut-form" class="border-t border-gray-200 pt-3 mt-3" style="display:none;">
                <h4 class="text-sm font-bold mb-2" id="shortcut-form-title">Novo Atalho</h4>
                <input type="hidden" id="shortcut-edit-id">
                <div class="space-y-2">
                    <div>
                        <label class="text-xs text-gray-500">Comando (ex: futebol)</label>
                        <input type="text" id="shortcut-cmd" class="form-input w-full text-sm" placeholder="futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">T√≠tulo</label>
                        <input type="text" id="shortcut-title" class="form-input w-full text-sm" placeholder="Pacote Futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Mensagem</label>
                        <textarea id="shortcut-content" rows="3" class="form-input w-full text-sm resize-none" placeholder="Ol√°! Temos o pacote futebol..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button id="save-shortcut" class="flex-1 shiny-btn py-2 rounded-lg text-sm font-bold">Salvar</button>
                        <button id="cancel-shortcut" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Preview Modal (before sending) -->
    <div id="media-preview-modal" class="modal-hidden fixed inset-0 bg-black/80 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-md w-full">
            <div id="media-preview-content" class="mb-3 flex justify-center max-h-[50vh] overflow-hidden rounded-xl bg-gray-100">
            </div>
            <div class="relative mb-3">
                <input type="text" id="media-caption" class="form-input w-full text-sm pr-10" placeholder="Legenda (opcional)">
                <button type="button" class="emoji-trigger absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-amber-500 transition" data-target="media-caption" title="Emojis">
                    <i class="far fa-smile text-lg"></i>
                </button>
            </div>
            <p class="text-xs text-gray-400 mb-3" id="media-file-info"></p>
            <div class="flex gap-2">
                <button id="confirm-send-media" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold"><i class="fas fa-paper-plane mr-1"></i> Enviar</button>
                <button id="cancel-send-media" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-modal" class="modal-hidden fixed inset-0 bg-black/80 z-[30000] flex flex-col">
        <div class="flex items-center justify-between p-3 bg-gray-900/90">
            <h3 class="text-white text-sm font-semibold truncate flex-1" id="pdf-title"><i class="fas fa-file-pdf text-red-400 mr-2"></i>PDF</h3>
            <div class="flex gap-2">
                <button onclick="window.open(document.getElementById('pdf-frame').src,'_blank')" class="text-gray-300 hover:text-white px-3 py-1 rounded-lg text-xs bg-white/10 hover:bg-white/20 transition"><i class="fas fa-external-link-alt mr-1"></i>Nova aba</button>
                <button onclick="document.getElementById('pdf-modal').classList.add('modal-hidden')" class="text-gray-300 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <iframe id="pdf-frame" class="flex-1 w-full bg-white" style="border:none;"></iframe>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4"><i class="fas fa-user-edit text-green-600 mr-2"></i>Editar Perfil</h3>
            <div class="text-center mb-4">
                <div class="w-20 h-20 rounded-full bg-gray-200 mx-auto mb-2 overflow-hidden flex items-center justify-center cursor-pointer" id="edit-profile-pic-preview" onclick="document.getElementById('edit-profile-pic-input').click()">
                    <i class="fas fa-camera text-gray-400 text-xl"></i>
                </div>
                <input type="file" id="edit-profile-pic-input" accept="image/*" class="hidden">
                <p class="text-xs text-gray-400">Toque para alterar</p>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-medium">Nome</label>
                    <input type="text" id="edit-profile-name" class="form-input w-full text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-medium">Recado</label>
                    <input type="text" id="edit-profile-about" class="form-input w-full text-sm" placeholder="Dispon√≠vel">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveProfile()" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold">Salvar</button>
                <button onclick="document.getElementById('edit-profile-modal').classList.add('modal-hidden')" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Send Contact Modal -->
    <div id="send-contact-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-sm w-full max-h-[70vh] flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold"><i class="fas fa-address-book text-sky-500 mr-2"></i>Enviar Contato</h3>
                <button onclick="document.getElementById('send-contact-modal').classList.add('modal-hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <input type="text" id="search-contacts-send" placeholder="Buscar contato..." class="form-input w-full text-sm mb-3">
            <div id="contacts-send-list" class="flex-1 overflow-y-auto divide-y divide-gray-100"></div>
        </div>
    </div>

    <!-- Mute Options Modal -->
    <div id="mute-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-xs w-full">
            <h3 class="text-sm font-bold mb-3">Silenciar notifica√ß√µes</h3>
            <div class="space-y-1">
                <button onclick="muteChat('8h')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">8 horas</button>
                <button onclick="muteChat('1w')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">1 semana</button>
                <button onclick="muteChat('forever')" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-sm">Sempre</button>
            </div>
            <button onclick="document.getElementById('mute-modal').classList.add('modal-hidden')" class="w-full mt-3 p-2 text-center text-gray-500 text-sm hover:bg-gray-50 rounded-lg">Cancelar</button>
        </div>
    </div>

    <!-- Status Viewer Modal -->
    <div id="status-viewer-modal" class="modal-hidden fixed inset-0 bg-black z-[25000] flex flex-col">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden flex items-center justify-center text-white font-bold" id="status-viewer-avatar"></div>
                <div>
                    <p class="text-white text-sm font-semibold" id="status-viewer-name"></p>
                    <p class="text-gray-400 text-xs" id="status-viewer-time"></p>
                </div>
            </div>
            <button onclick="document.getElementById('status-viewer-modal').classList.add('modal-hidden')" class="text-white w-8 h-8 flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
        </div>
        <!-- Progress bar -->
        <div class="px-4"><div class="h-0.5 bg-gray-700 rounded-full overflow-hidden"><div id="status-progress" class="h-full bg-white transition-all" style="width:0%;"></div></div></div>
        <!-- Status content -->
        <div id="status-viewer-content" class="flex-1 flex items-center justify-center p-4"></div>
    </div>

    <!-- Post Status Modal -->
    <div id="post-status-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-3"><i class="fas fa-circle-notch text-green-600 mr-2"></i>Postar Status</h3>
            <div class="space-y-3">
                <textarea id="status-text-input" rows="4" class="form-input w-full text-sm resize-none" placeholder="Digite seu status..."></textarea>
                <div class="flex gap-2">
                    <button onclick="postTextStatus()" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold"><i class="fas fa-paper-plane mr-1"></i>Publicar</button>
                    <button onclick="document.getElementById('post-status-modal').classList.add('modal-hidden')" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-8 rounded-2xl max-w-sm w-full text-center" style="background: rgba(255,255,255,0.95);">
            <h3 class="text-lg font-bold mb-2">
                <i class="fab fa-whatsapp text-[var(--wa-green)] mr-2"></i>Conectar WhatsApp
            </h3>
            <p class="text-sm text-gray-500 mb-4" id="qr-instance-name"></p>
            <div id="qr-container" class="mx-auto mb-4 flex items-center justify-center min-h-[264px]">
                <div class="text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Gerando QR Code...</p>
                </div>
            </div>
            <p class="text-xs text-gray-500">Abra o WhatsApp no celular &gt; Dispositivos conectados &gt; Conectar dispositivo</p>
            <button id="close-qr-modal" class="mt-4 text-gray-500 hover:text-gray-700 text-sm font-semibold">
                <i class="fas fa-times mr-1"></i> Fechar
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 z-[99999] bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center gap-3 toast-enter">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="text-sm"></p>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav active" id="main-bottom-nav">
        <div class="bottom-nav-handle" id="bottom-nav-handle"><i class="fas fa-chevron-up"></i></div>
        <a href="./Dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>In√≠cio</span></a>
        <a href="./Agenda de eventos.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a>
        <a href="./Sistema Gest√£o Financeira.html" class="nav-item"><i class="fas fa-wallet"></i><span>Financeiro</span></a>
        <a href="./Sistema de CRM.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
        <a href="#" class="nav-item active"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></a>
    </nav>

    <script type="module">
        import { getToken } from './js/auth.js';
        import { API_BASE_URL } from './js/api.js';

        const BASE = `${API_BASE_URL}/api/whatsapp`;
        const token = getToken();
        const headers = () => ({ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' });

        // --- STATE ---
        let currentInstance = new URLSearchParams(window.location.search).get('instance') || 'aero-festas';
        let conversations = [];
        let currentConversationId = null;
        let currentConversation = null;
        let messages = [];
        let messagesPage = 1;
        let isLoadingMore = false;
        let hasMoreMessages = true;
        let pollInterval = null;
        let instances = [];
        let userData = null;

        try { userData = JSON.parse(localStorage.getItem('userData')); } catch(e) {}

        // --- API ---
        const api = {
            getInstances: async () => {
                try { const r = await fetch(`${BASE}/instances`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            getConversations: async (instance, search = '') => {
                try {
                    const params = new URLSearchParams({ instance, search, limit: '100' });
                    const r = await fetch(`${BASE}/conversations?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            getMessages: async (convId, page = 1) => {
                try {
                    const r = await fetch(`${BASE}/conversations/${convId}/messages?page=${page}&limit=50`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            send: async (instanceName, remoteJid, text) => {
                try {
                    const r = await fetch(`${BASE}/send`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, text })
                    });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            sendMedia: async (instanceName, remoteJid, mediaType, media, caption, fileName, mimetype) => {
                try {
                    const r = await fetch(`${BASE}/send-media`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, mediaType, media, caption, fileName, mimetype })
                    });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getCatalog: async (instanceName) => {
                try { const r = await fetch(`${BASE}/catalog/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            sendCatalog: async (data) => {
                try {
                    const r = await fetch(`${BASE}/send-catalog`, { method: 'POST', headers: headers(), body: JSON.stringify(data) });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getShortcuts: async () => {
                try { const r = await fetch(`${BASE}/shortcuts`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            createShortcut: async (data) => {
                try { const r = await fetch(`${BASE}/shortcuts`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateShortcut: async (id, data) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'PUT', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            deleteShortcut: async (id) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'DELETE', headers: headers() }); return r.ok; } catch(e) { return false; }
            },
            markRead: async (convId) => {
                try { await fetch(`${BASE}/conversations/${convId}/read`, { method: 'PUT', headers: headers() }); } catch(e) {}
            },
            getUnreadCount: async () => {
                try { const r = await fetch(`${BASE}/unread-count`, { headers: headers() }); return r.ok ? await r.json() : {}; } catch(e) { return {}; }
            },
            connect: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/connect`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getQR: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/qr`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getProfilePic: async (instanceName, number) => {
                try { const r = await fetch(`${BASE}/profile-pic/${instanceName}/${number}`, { headers: headers() }); return r.ok ? await r.json() : { profilePicUrl: null }; } catch(e) { return { profilePicUrl: null }; }
            },
            downloadMedia: async (messageId) => {
                try {
                    const r = await fetch(`${BASE}/download-media`, { method: 'POST', headers: headers(), body: JSON.stringify({ messageId }) });
                    return r.ok ? await r.json() : { mediaUrl: null };
                } catch(e) { return { mediaUrl: null }; }
            },
            getPresence: async (instanceName, remoteJid) => {
                try { const r = await fetch(`${BASE}/presence/${instanceName}/${encodeURIComponent(remoteJid)}`, { headers: headers() }); return r.ok ? await r.json() : { presence: null }; } catch(e) { return { presence: null }; }
            },
            // --- NEW v2.0 APIs ---
            getContacts: async (instanceName) => {
                try { const r = await fetch(`${BASE}/contacts/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            sendContact: async (data) => {
                try { const r = await fetch(`${BASE}/send-contact`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getGroups: async (instanceName) => {
                try {
                    const r = await fetch(`${BASE}/groups/${instanceName}`, { headers: headers() });
                    if (r.ok) return await r.json();
                    const err = await r.json().catch(() => ({}));
                    throw new Error(err.error || `Erro ${r.status}`);
                } catch(e) { throw e; }
            },
            getConversationsFiltered: async (instance, opts = {}) => {
                try {
                    const params = new URLSearchParams({ instance, limit: '100', ...opts });
                    const r = await fetch(`${BASE}/conversations?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            archiveConversation: async (convId, archive) => {
                try { const r = await fetch(`${BASE}/conversations/${convId}/archive`, { method: 'PUT', headers: headers(), body: JSON.stringify({ archive }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            muteConversation: async (convId, mute, duration) => {
                try { const r = await fetch(`${BASE}/conversations/${convId}/mute`, { method: 'PUT', headers: headers(), body: JSON.stringify({ mute, duration }) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getProfile: async (instanceName) => {
                try { const r = await fetch(`${BASE}/profile/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateProfile: async (instanceName, data) => {
                try { const r = await fetch(`${BASE}/profile/${instanceName}`, { method: 'PUT', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getStatus: async (instanceName) => {
                try { const r = await fetch(`${BASE}/status/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            postStatus: async (instanceName, data) => {
                try { const r = await fetch(`${BASE}/status/${instanceName}`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            syncConversation: async (convId) => {
                try { const r = await fetch(`${BASE}/sync-conversation/${convId}`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            syncHistory: async (instanceName) => {
                try { const r = await fetch(`${BASE}/sync-history/${instanceName}`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            disconnect: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/disconnect`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            }
        };

        // --- SHORTCUTS STATE ---
        let shortcuts = [];

        // --- PROFILE PIC CACHE ---
        const profilePicCache = {}; // { phoneNumber: url | null }

        // --- HELPERS ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatTime(dateStr) {
            return new Date(dateStr).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatRelative(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const diff = now - d;
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today - 86400000);

            if (d >= today) return formatTime(dateStr);
            if (d >= yesterday) return 'Ontem';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').filter(n => n).map(n => n[0]).slice(0, 2).join('').toUpperCase();
        }

        // showToast defined below after all features

        // --- RENDER: INSTANCE TABS ---
        function setupInstanceTabs() {
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentInstance = tab.dataset.instance;
                    document.querySelectorAll('.instance-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentConversationId = null;
                    currentConversation = null;
                    showChatWelcome();
                    loadConversations();
                    updateConnectionStatus();
                    // Atualiza URL sem recarregar
                    history.replaceState(null, '', `WhatsApp.html?instance=${currentInstance}`);
                });
            });
        }

        // --- RENDER: CONNECTION STATUS ---
        function updateConnectionStatus() {
            const inst = instances.find(i => i.instanceName === currentInstance);
            const dot = document.getElementById('connection-status-dot');
            const dotMobile = document.getElementById('connection-status-dot-mobile');
            const text = document.getElementById('connection-status-text');
            const connectBtn = document.getElementById('connect-btn');

            if (!inst) {
                dot.className = 'status-dot disconnected';
                if (dotMobile) dotMobile.className = 'status-dot disconnected';
                text.textContent = 'N√£o configurado';
                connectBtn.classList.add('hidden');
                return;
            }

            dot.className = `status-dot ${inst.status}`;
            if (dotMobile) dotMobile.className = `status-dot ${inst.status}`;
            const statusMap = { connected: 'Conectado', disconnected: 'Desconectado', connecting: 'Conectando...', qr_pending: 'Aguardando QR...' };
            text.textContent = statusMap[inst.status] || inst.status;
            if (inst.phoneNumber) text.textContent += ` (${inst.phoneNumber})`;

            // Show connect button for admins when disconnected
            if (userData?.isAdmin && inst.status !== 'connected') {
                connectBtn.classList.remove('hidden');
                connectBtn.onclick = () => showQRModal(currentInstance);
            } else {
                connectBtn.classList.add('hidden');
            }
        }

        // --- RENDER: CONVERSATION LIST ---
        function renderConversationList() {
            const listEl = document.getElementById('conversation-list');
            const search = document.getElementById('search-conversations').value.toLowerCase().trim();

            let filtered = conversations;
            if (search) {
                filtered = conversations.filter(c =>
                    (c.contactName || '').toLowerCase().includes(search) ||
                    c.phoneNumber.includes(search.replace(/\D/g, ''))
                );
            }

            // Update archived count
            if (!showingArchived) {
                const archivedBar = document.getElementById('archived-bar');
                const archivedCount = document.getElementById('archived-count');
                if (archivedBar && archivedCount) {
                    const archCount = conversations.filter(c => c.isArchived).length;
                    // We filter non-archived for display, but track archived count
                    archivedCount.textContent = archCount;
                    if (archCount > 0) archivedBar.classList.remove('hidden');
                    else archivedBar.classList.add('hidden');
                }
            }

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                    <div class="text-center">
                        <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                        <p>${search ? 'Nenhuma conversa encontrada' : 'Nenhuma conversa ainda'}</p>
                    </div>
                </div>`;
                return;
            }

            listEl.innerHTML = '';
            filtered.forEach(conv => {
                const div = document.createElement('div');
                const isActive = conv.id === currentConversationId;
                div.className = `conv-item p-3 cursor-pointer flex items-center gap-3 border-b border-gray-100/50 ${isActive ? 'active' : ''}`;

                const initials = getInitials(conv.contactName || conv.phoneNumber);
                const unread = conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount > 99 ? '99+' : conv.unreadCount}</span>` : '';
                const crmIcon = conv.clientId ? '<i class="fas fa-link text-indigo-400 text-[10px]" title="Vinculado ao CRM"></i>' : '';
                const mutedIcon = conv.isMuted ? ' <i class="fas fa-bell-slash muted-icon" title="Silenciado"></i>' : '';
                const groupIcon = conv.isGroup ? '<i class="fas fa-users text-teal-400 text-[10px] mr-0.5" title="Grupo"></i>' : '';
                const preview = conv.lastMessagePreview || '';
                const time = formatRelative(conv.lastMessageAt);
                const cachedPic = profilePicCache[conv.phoneNumber];
                // Status ring: check if this contact has status posted
                const hasStatus = statusCache.some(s => (s.participant || '').includes(conv.phoneNumber.replace(/\D/g, '')));
                const statusRingClass = hasStatus ? 'status-ring' : '';

                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${conv.isGroup ? 'bg-teal-500' : 'bg-gradient-to-br from-green-400 to-emerald-600'} flex items-center justify-center text-white text-sm font-bold flex-shrink-0 overflow-hidden ${statusRingClass}" data-phone="${conv.phoneNumber}">
                        ${conv.isGroup ? '<i class="fas fa-users text-xs"></i>' : (cachedPic ? `<img src="${cachedPic}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">` : initials)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm truncate ${conv.unreadCount > 0 ? 'text-gray-900' : 'text-gray-700'}">${groupIcon}${escapeHtml(conv.contactName || conv.phoneNumber)}${mutedIcon} ${crmIcon}</span>
                            <span class="text-[11px] text-gray-400 flex-shrink-0 ml-2">${time}</span>
                        </div>
                        <div class="flex justify-between items-center mt-0.5">
                            <p class="text-xs truncate ${conv.unreadCount > 0 ? 'text-gray-800 font-medium' : 'text-gray-500'}">${escapeHtml(preview)}</p>
                            ${unread}
                        </div>
                    </div>
                `;

                div.addEventListener('click', () => openConversation(conv));
                listEl.appendChild(div);
            });

            // Carregar fotos de perfil assincronamente
            loadProfilePics(filtered);
        }

        async function loadProfilePics(conversations) {
            for (const conv of conversations) {
                if (profilePicCache[conv.phoneNumber] !== undefined) continue; // j√° carregou (ou falhou)
                profilePicCache[conv.phoneNumber] = null; // marca como "carregando"
                try {
                    const data = await api.getProfilePic(currentInstance, conv.phoneNumber);
                    if (data.profilePicUrl) {
                        profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                        // Atualizar o avatar na lista
                        const avatarEl = document.querySelector(`[data-phone="${conv.phoneNumber}"]`);
                        if (avatarEl) {
                            const initials = getInitials(conv.contactName || conv.phoneNumber);
                            avatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                        }
                    }
                } catch (e) { /* silenciar */ }
            }
        }

        // --- OPEN CONVERSATION ---
        async function openConversation(conv) {
            currentConversationId = conv.id;
            currentConversation = conv;
            messagesPage = 1;
            hasMoreMessages = true;
            messages = [];

            // Update header
            document.getElementById('chat-contact-name').textContent = conv.contactName || conv.phoneNumber;
            document.getElementById('chat-contact-phone').textContent = conv.phoneNumber;
            const chatAvatarEl = document.getElementById('chat-avatar');
            const initials = getInitials(conv.contactName || conv.phoneNumber);
            const pic = profilePicCache[conv.phoneNumber];
            if (pic) {
                chatAvatarEl.innerHTML = `<img src="${pic}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
            } else {
                chatAvatarEl.textContent = initials;
                // Tentar carregar foto de perfil
                api.getProfilePic(currentInstance, conv.phoneNumber).then(data => {
                    if (data.profilePicUrl) {
                        profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                        chatAvatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                    }
                });
            }

            // CRM link
            const crmBtn = document.getElementById('link-crm-btn');
            if (conv.clientId) {
                crmBtn.classList.remove('hidden');
                crmBtn.onclick = () => window.open(`Sistema de CRM.html?clientId=${conv.clientId}`, '_blank');
            } else {
                crmBtn.classList.add('hidden');
            }

            // Show mute/archive buttons
            updateChatHeaderButtons();

            // Show chat panel, hide welcome
            const chatPanel = document.getElementById('chat-panel');
            chatPanel.classList.remove('mobile-hidden');
            const welcomeEl = document.getElementById('chat-welcome');
            if (welcomeEl) welcomeEl.classList.add('hidden');
            document.getElementById('input-bar').classList.remove('hidden');

            // Mobile: hide side panel, show chat
            const sidePanel = document.getElementById('conversation-panel');
            if (window.innerWidth < 1024) {
                sidePanel.classList.add('mobile-hidden');
            }

            // Close contact details if open
            closeContactDetails();

            // Load messages
            await loadMessages();

            // Show sync banner if no messages and conversation has an ID
            const syncBanner = document.getElementById('sync-banner');
            if (messages.length === 0 && conv.id) {
                syncBanner.classList.remove('hidden');
                syncBanner.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Sem hist√≥rico. Toque para sincronizar mensagens.';
            } else {
                syncBanner.classList.add('hidden');
            }

            // Mark as read
            if (conv.unreadCount > 0 && conv.id) {
                await api.markRead(conv.id);
                conv.unreadCount = 0;
                renderConversationList();
            }

            renderConversationList();
        }

        // --- LOAD MESSAGES ---
        async function loadMessages() {
            if (!currentConversationId) { messages = []; renderMessages(true); return; }
            const data = await api.getMessages(currentConversationId, messagesPage);
            if (data.length < 50) hasMoreMessages = false;

            // API returns newest first, reverse for display
            const newMsgs = data.reverse();

            if (messagesPage === 1) {
                messages = newMsgs;
            } else {
                messages = [...newMsgs, ...messages];
            }

            renderMessages(messagesPage === 1);
        }

        // --- RENDER MESSAGES ---
        function renderMediaContent(msg) {
            const url = msg.mediaUrl;
            const type = msg.messageType;
            const caption = msg.content && !msg.content.startsWith('[') ? msg.content : '';

            if (type === 'image' && url) {
                return `<div class="media-bubble"><img src="${escapeHtml(url)}" alt="imagem" loading="lazy" onclick="window.open('${escapeHtml(url)}','_blank')"></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'video' && url) {
                return `<div class="media-bubble"><video src="${escapeHtml(url)}" controls preload="metadata" style="max-height:300px;"></video></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'audio') {
                // Se for data URI (√°udio enviado por n√≥s, armazenado localmente), toca direto
                if (url && url.startsWith('data:')) {
                    return `<div class="media-bubble" style="min-width:220px;"><audio src="${escapeHtml(url)}" controls preload="metadata" style="width:100%;max-width:300px;"></audio></div>`;
                }
                // Para URLs CDN do WhatsApp (expiram) ou sem URL: sempre baixar sob demanda
                return `<div class="media-bubble" style="min-width:220px;" id="audio-${escapeHtml(msg.id)}">
                    <div class="flex items-center gap-2 cursor-pointer text-green-600 hover:text-green-700" onclick="loadAudioMedia('${escapeHtml(msg.id)}')">
                        <i class="fas fa-play-circle text-2xl"></i>
                        <div>
                            <p class="text-sm font-medium">√Åudio</p>
                            <p class="text-[10px] text-gray-400">Toque para ouvir</p>
                        </div>
                        <i class="fas fa-download text-xs text-gray-400 ml-auto"></i>
                    </div>
                </div>`;
            }
            if (type === 'document' && url) {
                const name = msg.mediaName || 'Documento';
                const isPdf = (msg.mediaMimetype || '').includes('pdf') || name.toLowerCase().endsWith('.pdf');
                if (isPdf) {
                    // PDF: bot√£o para abrir viewer inline
                    return `<div style="min-width:220px;">
                        <div class="flex items-center gap-2 p-2 bg-white/50 rounded-lg">
                            <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                            <div class="min-w-0 flex-1"><p class="text-sm font-medium truncate">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">PDF</p></div>
                        </div>
                        <div class="flex gap-1 mt-1">
                            <button class="flex-1 text-[11px] bg-red-50 text-red-600 py-1.5 rounded-lg font-semibold hover:bg-red-100 transition" onclick="openPdfViewer('${escapeHtml(url)}','${escapeHtml(name)}')"><i class="fas fa-eye mr-1"></i>Visualizar</button>
                            <button class="flex-1 text-[11px] bg-gray-50 text-gray-600 py-1.5 rounded-lg font-semibold hover:bg-gray-100 transition" onclick="openPdfNewTab('${escapeHtml(url)}')"><i class="fas fa-external-link-alt mr-1"></i>Abrir</button>
                        </div>
                    </div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
                }
                return `<div class="flex items-center gap-2 p-2 bg-white/50 rounded-lg cursor-pointer" onclick="window.open('${escapeHtml(url)}','_blank')"><i class="fas fa-file-alt text-blue-500 text-lg"></i><div class="min-w-0"><p class="text-sm font-medium truncate">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">${msg.mediaMimetype || 'documento'}</p></div><i class="fas fa-download text-gray-400 text-xs ml-auto"></i></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            // Fallback: sem URL, apenas indicador
            const icon = type === 'image' ? 'image' : type === 'audio' ? 'microphone' : type === 'video' ? 'video' : type === 'sticker' ? 'note-sticky' : 'file';
            return `<p class="text-gray-400 italic text-xs"><i class="fas fa-${icon} mr-1"></i>${escapeHtml(msg.content)}</p>`;
        }

        // Carrega √°udio sob demanda via Evolution API
        async function loadAudioMedia(messageId) {
            const container = document.getElementById(`audio-${messageId}`);
            if (!container) return;
            container.innerHTML = `<div class="flex items-center gap-2 text-gray-400"><i class="fas fa-spinner fa-spin"></i> <span class="text-xs">Carregando √°udio...</span></div>`;

            try {
                const data = await api.downloadMedia(messageId);
                if (data.mediaUrl) {
                    container.innerHTML = `<audio src="${data.mediaUrl}" controls preload="auto" autoplay style="width:100%;max-width:300px;"></audio>`;
                    // Atualiza na lista local para n√£o precisar baixar de novo
                    const msg = messages.find(m => m.id === messageId);
                    if (msg) msg.mediaUrl = data.mediaUrl;
                } else {
                    container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>N√£o foi poss√≠vel carregar o √°udio</p>`;
                }
            } catch (e) {
                container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>Erro ao carregar √°udio</p>`;
            }
        }
        window.loadAudioMedia = loadAudioMedia;

        function renderMessages(scrollToBottom = true) {
            const area = document.getElementById('messages-area');
            area.innerHTML = '';

            let lastDate = null;

            messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString('pt-BR');

                if (msgDate !== lastDate) {
                    const sep = document.createElement('div');
                    sep.className = 'text-center my-3';
                    sep.innerHTML = `<span class="bg-white/80 text-gray-500 text-xs px-3 py-1 rounded-full shadow-sm">${msgDate}</span>`;
                    area.appendChild(sep);
                    lastDate = msgDate;
                }

                const bubble = document.createElement('div');
                bubble.className = `p-2.5 ${msg.fromMe ? 'bubble-sent ml-auto' : 'bubble-received mr-auto'}`;

                const time = formatTime(msg.timestamp);
                const statusIcon = msg.fromMe ? (
                    msg.status === 'played' ? '<i class="fas fa-check-double text-blue-400"></i> <span class="text-[9px] text-blue-400 font-medium">Reproduzido</span>' :
                    msg.status === 'read' ? '<i class="fas fa-check-double text-blue-400"></i>' :
                    msg.status === 'delivered' ? '<i class="fas fa-check-double text-gray-400"></i>' :
                    '<i class="fas fa-check text-gray-400"></i>'
                ) : '';

                const isMedia = msg.messageType !== 'text';
                const contentHtml = isMedia
                    ? renderMediaContent(msg)
                    : `<p class="whitespace-pre-wrap break-words text-sm">${escapeHtml(msg.content)}</p>`;

                // Show sender name in group messages
                const isGroup = currentConversation?.isGroup;
                const senderName = (isGroup && !msg.fromMe && msg.pushName) ? `<p class="text-[11px] font-semibold text-teal-600 mb-0.5">${escapeHtml(msg.pushName)}</p>` : '';

                bubble.innerHTML = `
                    ${senderName}
                    ${contentHtml}
                    <div class="text-right mt-1 flex items-center justify-end gap-1">
                        <span class="text-[10px] text-gray-400">${time}</span>
                        <span class="text-[10px]">${statusIcon}</span>
                    </div>
                `;

                area.appendChild(bubble);
            });

            if (scrollToBottom) {
                area.scrollTop = area.scrollHeight;
            }
        }

        // --- INFINITE SCROLL (load older messages) ---
        document.getElementById('messages-area').addEventListener('scroll', async function() {
            if (this.scrollTop === 0 && hasMoreMessages && !isLoadingMore && currentConversationId) {
                isLoadingMore = true;
                document.getElementById('loading-more').classList.remove('hidden');

                const prevHeight = this.scrollHeight;
                messagesPage++;
                await loadMessages();

                // Manter scroll position
                this.scrollTop = this.scrollHeight - prevHeight;
                document.getElementById('loading-more').classList.add('hidden');
                isLoadingMore = false;
            }
        });

        // --- SEND MESSAGE ---
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentConversation) return;

            input.value = '';
            input.style.height = 'auto';
            toggleSendAudioBtn();

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(),
                fromMe: true,
                content: text,
                timestamp: new Date().toISOString(),
                messageType: 'text',
                status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            const result = await api.send(currentInstance, currentConversation.remoteJid, text);
            if (result) {
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
                // If new conversation (no ID yet), refresh to get the conversation ID
                if (!currentConversationId) {
                    await loadConversations();
                    const conv = conversations.find(c => c.remoteJid === currentConversation.remoteJid);
                    if (conv) { currentConversationId = conv.id; currentConversation = conv; }
                }
            } else {
                showToast('Erro ao enviar mensagem', true);
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                input.value = text;
            }
        }

        // Toggle between send button and audio button
        function toggleSendAudioBtn() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const audioBtn = document.getElementById('audio-btn');
            const hasText = input.value.trim().length > 0;
            sendBtn.style.display = hasText ? 'flex' : 'none';
            audioBtn.style.display = hasText ? 'none' : 'flex';
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        document.getElementById('message-input').addEventListener('input', function() {
            toggleSendAudioBtn();
            handleShortcutPopup(this.value);
        });

        // --- ATTACH MENU ---
        const attachMenu = document.getElementById('attach-menu');
        let attachMenuOpen = false;
        function openAttachMenu() {
            const btn = document.getElementById('attach-btn');
            const rect = btn.getBoundingClientRect();
            attachMenu.style.cssText = `display:block; position:fixed; background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.15); padding:12px; z-index:99999; left:${rect.left}px; bottom:${window.innerHeight - rect.top + 8}px;`;
            attachMenuOpen = true;
        }
        function closeAttachMenu() {
            attachMenu.style.display = 'none';
            attachMenuOpen = false;
        }

        document.getElementById('attach-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (attachMenuOpen) {
                closeAttachMenu();
            } else {
                openAttachMenu();
            }
        });
        document.addEventListener('click', () => closeAttachMenu());
        attachMenu.addEventListener('click', (e) => e.stopPropagation());

        document.querySelectorAll('.attach-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAttachMenu();
                const action = item.dataset.action;
                if (action === 'image') document.getElementById('file-input-image').click();
                else if (action === 'video') document.getElementById('file-input-video').click();
                else if (action === 'document') document.getElementById('file-input-document').click();
                else if (action === 'catalog') openCatalogModal();
                else if (action === 'contact') openSendContactModal();
                else if (action === 'shortcuts-manage') openShortcutsModal();
            });
        });

        // --- FILE INPUT HANDLERS ---
        let pendingMedia = null;

        function handleFileSelect(e, mediaType) {
            const file = e.target.files[0];
            if (!file) return;
            e.target.value = '';

            const maxSize = 16 * 1024 * 1024; // 16MB
            if (file.size > maxSize) {
                showToast('Arquivo muito grande (m√°x 16MB)', true);
                return;
            }

            pendingMedia = { file, mediaType, fileName: file.name, mimetype: file.type };

            // Show preview modal
            const preview = document.getElementById('media-preview-content');
            const info = document.getElementById('media-file-info');
            const caption = document.getElementById('media-caption');
            caption.value = '';
            info.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

            if (mediaType === 'image') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<img src="${url}" style="max-height:50vh; object-fit:contain; border-radius:12px;">`;
            } else if (mediaType === 'video') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<video src="${url}" controls style="max-height:50vh; border-radius:12px;"></video>`;
            } else {
                const icon = file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-file-alt text-blue-500';
                preview.innerHTML = `<div class="flex flex-col items-center justify-center py-8"><i class="fas ${icon} text-5xl mb-3"></i><p class="text-sm text-gray-600">${escapeHtml(file.name)}</p></div>`;
            }

            document.getElementById('media-preview-modal').classList.remove('modal-hidden');
        }

        document.getElementById('file-input-image').addEventListener('change', (e) => handleFileSelect(e, 'image'));
        document.getElementById('file-input-video').addEventListener('change', (e) => handleFileSelect(e, 'video'));
        document.getElementById('file-input-document').addEventListener('change', (e) => handleFileSelect(e, 'document'));

        document.getElementById('cancel-send-media').addEventListener('click', () => {
            document.getElementById('media-preview-modal').classList.add('modal-hidden');
            pendingMedia = null;
        });

        document.getElementById('confirm-send-media').addEventListener('click', async () => {
            if (!pendingMedia || !currentConversation) return;
            document.getElementById('media-preview-modal').classList.add('modal-hidden');

            const caption = document.getElementById('media-caption').value.trim();
            const { file, mediaType, fileName, mimetype } = pendingMedia;
            pendingMedia = null;

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(), fromMe: true,
                content: caption || `[${mediaType}]`,
                timestamp: new Date().toISOString(), messageType: mediaType, status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            // Convert file to base64
            const base64 = await fileToBase64(file);

            const result = await api.sendMedia(
                currentInstance, currentConversation.remoteJid,
                mediaType, base64, caption || undefined, fileName, mimetype
            );

            if (result) {
                // Guardar m√≠dia localmente para preview imediato
                if (!result.mediaUrl) result.mediaUrl = `data:${mimetype};base64,${base64}`;
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
                showToast('M√≠dia enviada!');
            } else {
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                showToast('Erro ao enviar m√≠dia', true);
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove o prefixo data:xxx;base64, ‚Äî Evolution API quer raw base64
                    const result = reader.result.split(',')[1];
                    resolve(result);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- AUDIO RECORDING ---
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;

        document.getElementById('audio-btn').addEventListener('click', startRecording);

        async function startRecording() {
            if (!currentConversation) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => { stream.getTracks().forEach(t => t.stop()); };
                mediaRecorder.start();

                // Show recording UI
                document.querySelector('#input-bar .relative').style.setProperty('display', 'none', 'important');
                document.getElementById('recording-bar').style.setProperty('display', 'flex', 'important');
                recordingSeconds = 0;
                document.getElementById('recording-time').textContent = '0:00';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const m = Math.floor(recordingSeconds / 60);
                    const s = (recordingSeconds % 60).toString().padStart(2, '0');
                    document.getElementById('recording-time').textContent = `${m}:${s}`;
                }, 1000);
            } catch (err) {
                showToast('N√£o foi poss√≠vel acessar o microfone', true);
            }
        }

        document.getElementById('cancel-recording').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            stopRecordingUI();
        });

        document.getElementById('send-recording').addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

            mediaRecorder.onstop = async () => {
                mediaRecorder.stream?.getTracks().forEach(t => t.stop());
                stopRecordingUI();

                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const base64 = await blobToBase64(blob);

                // Optimistic UI
                const tempMsg = {
                    id: 'temp-' + Date.now(), fromMe: true,
                    content: '[audio]', timestamp: new Date().toISOString(),
                    messageType: 'audio', status: 'sending'
                };
                messages.push(tempMsg);
                renderMessages(true);

                const result = await api.sendMedia(
                    currentInstance, currentConversation.remoteJid,
                    'audio', base64, undefined, 'audio.ogg', 'audio/ogg'
                );

                if (result) {
                    // Guardar o √°udio localmente para poder reproduzir
                    if (!result.mediaUrl) result.mediaUrl = `data:audio/webm;base64,${base64}`;
                    const idx = messages.findIndex(m => m.id === tempMsg.id);
                    if (idx >= 0) messages[idx] = result;
                    renderMessages(true);
                } else {
                    messages = messages.filter(m => m.id !== tempMsg.id);
                    renderMessages(true);
                    showToast('Erro ao enviar √°udio', true);
                }
            };
            mediaRecorder.stop();
        });

        function stopRecordingUI() {
            clearInterval(recordingTimer);
            document.querySelector('#input-bar .relative').style.setProperty('display', 'flex', 'important');
            document.getElementById('recording-bar').style.setProperty('display', 'none', 'important');
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // --- SHORTCUTS POPUP (when typing /) ---
        function handleShortcutPopup(value) {
            const popup = document.getElementById('shortcuts-popup');
            if (!value.startsWith('/') || value.includes(' ')) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }
            const query = value.slice(1).toLowerCase();
            const filtered = shortcuts.filter(s => s.command.startsWith(query));

            if (filtered.length === 0 && query === '') {
                // Posicionar e mostrar dica
                const input = document.getElementById('message-input');
                const inputRect = input.getBoundingClientRect();
                popup.style.left = inputRect.left + 'px';
                popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
                popup.style.width = inputRect.width + 'px';
                popup.style.setProperty('display', 'block', 'important');
                popup.innerHTML = `<div class="p-3 text-center text-gray-400 text-xs">
                    <p>Nenhum atalho configurado.</p>
                    <p class="mt-1">Use o menu <i class="fas fa-paperclip"></i> ‚Üí <i class="fas fa-bolt"></i> Atalhos para criar.</p>
                </div>`;
                return;
            }
            if (filtered.length === 0) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }

            // Posicionar o popup acima do textarea
            const input = document.getElementById('message-input');
            const inputRect = input.getBoundingClientRect();
            popup.style.left = inputRect.left + 'px';
            popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
            popup.style.width = inputRect.width + 'px';

            popup.style.setProperty('display', 'block', 'important');
            popup.innerHTML = filtered.map(s => `
                <div class="shortcut-item" data-command="${escapeHtml(s.command)}">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-green-700">/${escapeHtml(s.command)}</span>
                        <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate mt-0.5">${escapeHtml(s.content.substring(0, 80))}</p>
                </div>
            `).join('');

            popup.querySelectorAll('.shortcut-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cmd = item.dataset.command;
                    const shortcut = shortcuts.find(s => s.command === cmd);
                    if (shortcut) {
                        document.getElementById('message-input').value = shortcut.content;
                        toggleSendAudioBtn();
                    }
                    popup.style.setProperty('display', 'none', 'important');
                });
            });
        }

        // --- CATALOG MODAL ---
        async function openCatalogModal() {
            if (!currentConversation) { showToast('Selecione uma conversa primeiro', true); return; }
            document.getElementById('catalog-modal').classList.remove('modal-hidden');
            const content = document.getElementById('catalog-content');
            content.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando cat√°logo...</p></div>';

            const catalog = await api.getCatalog(currentInstance);
            if (!catalog || (Array.isArray(catalog) && catalog.length === 0)) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto no cat√°logo.</p><p class="text-gray-400 text-xs mt-1">Configure o cat√°logo no WhatsApp Business do celular.</p></div>';
                return;
            }

            const products = Array.isArray(catalog) ? catalog : (catalog.products || catalog.data || [catalog]);
            if (products.length === 0) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto encontrado.</p></div>';
                return;
            }

            content.innerHTML = `<div class="catalog-grid">${products.map((p, i) => {
                const name = p.name || p.title || `Produto ${i+1}`;
                const img = p.imageUrl || p.image || p.thumbnailUrl || '';
                const price = p.price ? `R$ ${(p.price / 100).toFixed(2)}` : '';
                return `<div class="catalog-item" data-idx="${i}">
                    ${img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy">` : '<div class="h-[120px] bg-gray-100 flex items-center justify-center"><i class="fas fa-image text-2xl text-gray-300"></i></div>'}
                    <div class="p-2">
                        <p class="text-xs font-semibold truncate">${escapeHtml(name)}</p>
                        ${price ? `<p class="text-xs text-green-600 font-bold">${price}</p>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;

            content.querySelectorAll('.catalog-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const idx = parseInt(item.dataset.idx);
                    const p = products[idx];
                    document.getElementById('catalog-modal').classList.add('modal-hidden');

                    const tempMsg = {
                        id: 'temp-' + Date.now(), fromMe: true,
                        content: `üì¶ ${p.name || 'Produto'}`,
                        timestamp: new Date().toISOString(), messageType: 'text', status: 'sending'
                    };
                    messages.push(tempMsg);
                    renderMessages(true);

                    const result = await api.sendCatalog({
                        instanceName: currentInstance,
                        remoteJid: currentConversation.remoteJid,
                        productName: p.name || p.title,
                        productImage: p.imageUrl || p.image || p.thumbnailUrl,
                        productUrl: p.url || '',
                        caption: p.description || ''
                    });

                    if (result) {
                        const idx2 = messages.findIndex(m => m.id === tempMsg.id);
                        if (idx2 >= 0) messages[idx2] = result;
                        renderMessages(true);
                        showToast('Produto enviado!');
                    } else {
                        messages = messages.filter(m => m.id !== tempMsg.id);
                        renderMessages(true);
                        showToast('Erro ao enviar produto', true);
                    }
                });
            });
        }

        document.getElementById('close-catalog-modal').addEventListener('click', () => {
            document.getElementById('catalog-modal').classList.add('modal-hidden');
        });

        // --- SHORTCUTS MANAGER MODAL ---
        async function openShortcutsModal() {
            document.getElementById('shortcuts-modal').classList.remove('modal-hidden');
            document.getElementById('shortcut-form').style.display = 'none';
            await loadShortcuts();
            renderShortcutsList();
        }

        async function loadShortcuts() {
            shortcuts = await api.getShortcuts();
        }

        function renderShortcutsList() {
            const list = document.getElementById('shortcuts-list');
            if (shortcuts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>';
                return;
            }
            list.innerHTML = shortcuts.map(s => `
                <div class="bg-gray-50 rounded-xl p-3 flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-green-700">/${escapeHtml(s.command)}</span>
                            <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(s.content.substring(0, 100))}</p>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button class="text-blue-500 hover:text-blue-700 p-1" onclick="editShortcut('${s.id}')"><i class="fas fa-pen text-xs"></i></button>
                        <button class="text-red-400 hover:text-red-600 p-1" onclick="deleteShortcut('${s.id}')"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Expose to global scope for onclick
        window.editShortcut = function(id) {
            const s = shortcuts.find(x => x.id === id);
            if (!s) return;
            document.getElementById('shortcut-edit-id').value = id;
            document.getElementById('shortcut-cmd').value = s.command;
            document.getElementById('shortcut-title').value = s.title;
            document.getElementById('shortcut-content').value = s.content;
            document.getElementById('shortcut-form-title').textContent = 'Editar Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        };

        window.deleteShortcut = async function(id) {
            if (!confirm('Remover este atalho?')) return;
            const ok = await api.deleteShortcut(id);
            if (ok) { await loadShortcuts(); renderShortcutsList(); showToast('Atalho removido'); }
            else showToast('Erro ao remover', true);
        };

        document.getElementById('close-shortcuts-modal').addEventListener('click', () => {
            document.getElementById('shortcuts-modal').classList.add('modal-hidden');
        });

        document.getElementById('add-shortcut-btn').addEventListener('click', () => {
            document.getElementById('shortcut-edit-id').value = '';
            document.getElementById('shortcut-cmd').value = '';
            document.getElementById('shortcut-title').value = '';
            document.getElementById('shortcut-content').value = '';
            document.getElementById('shortcut-form-title').textContent = 'Novo Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        });

        document.getElementById('cancel-shortcut').addEventListener('click', () => {
            document.getElementById('shortcut-form').style.display = 'none';
        });

        document.getElementById('save-shortcut').addEventListener('click', async () => {
            const id = document.getElementById('shortcut-edit-id').value;
            const data = {
                command: document.getElementById('shortcut-cmd').value.trim(),
                title: document.getElementById('shortcut-title').value.trim(),
                content: document.getElementById('shortcut-content').value.trim()
            };
            if (!data.command || !data.title || !data.content) {
                showToast('Preencha todos os campos', true);
                return;
            }
            const result = id ? await api.updateShortcut(id, data) : await api.createShortcut(data);
            if (result) {
                await loadShortcuts();
                renderShortcutsList();
                document.getElementById('shortcut-form').style.display = 'none';
                showToast(id ? 'Atalho atualizado' : 'Atalho criado');
            } else {
                showToast('Erro ao salvar atalho', true);
            }
        });

        // --- BACK BUTTON (mobile) ---
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('conversation-panel').classList.remove('mobile-hidden');
            document.getElementById('chat-panel').classList.add('mobile-hidden');
            closeContactDetails();
            currentConversationId = null;
            currentConversation = null;
            renderConversationList();
        });

        // --- SHOW CHAT WELCOME ---
        function showChatWelcome() {
            const messagesArea = document.getElementById('messages-area');
            const welcomeEl = document.getElementById('chat-welcome');
            document.getElementById('input-bar').classList.add('hidden');
            document.getElementById('sync-banner').classList.add('hidden');
            document.getElementById('chat-contact-name').textContent = '';
            document.getElementById('chat-contact-phone').textContent = '';
            document.getElementById('mute-chat-btn')?.classList.add('hidden');
            document.getElementById('archive-chat-btn')?.classList.add('hidden');

            // Preserve chat-welcome before clearing
            if (welcomeEl) {
                messagesArea.innerHTML = '';
                messagesArea.appendChild(welcomeEl);
                welcomeEl.classList.remove('hidden');
            } else {
                messagesArea.innerHTML = `
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>`;
            }

            // Close details panel
            closeContactDetails();
        }

        // --- QR CODE MODAL ---
        let qrPollInterval = null;

        async function showQRModal(instanceName) {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-container');
            document.getElementById('qr-instance-name').textContent = instanceName === 'aero-festas' ? 'Aero Festas' : 'ABC Festas';

            modal.classList.remove('hidden');
            container.innerHTML = '<div class="text-gray-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Gerando QR Code...</p></div>';

            const data = await api.connect(instanceName);
            if (data?.base64) {
                container.innerHTML = `<img src="${data.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else if (data?.code) {
                container.innerHTML = `<img src="data:image/png;base64,${data.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else {
                container.innerHTML = '<p class="text-red-500 text-sm">Erro ao gerar QR Code. Verifique se a Evolution API est√° ativa.</p>';
            }

            // Poll para QR atualizado
            qrPollInterval = setInterval(async () => {
                const inst = instances.find(i => i.instanceName === instanceName);
                if (inst) {
                    const refreshedInstances = await api.getInstances();
                    instances = refreshedInstances;
                    const updated = refreshedInstances.find(i => i.instanceName === instanceName);
                    if (updated?.status === 'connected') {
                        clearInterval(qrPollInterval);
                        modal.classList.add('hidden');
                        showToast('WhatsApp conectado com sucesso!');
                        updateConnectionStatus();
                        return;
                    }
                }
                // Atualiza QR
                const qrData = await api.getQR(instanceName);
                if (qrData?.base64) {
                    container.innerHTML = `<img src="${qrData.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
                } else if (qrData?.code) {
                    container.innerHTML = `<img src="data:image/png;base64,${qrData.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
                }
            }, 5000);
        }

        document.getElementById('close-qr-modal').addEventListener('click', () => {
            document.getElementById('qr-modal').classList.add('hidden');
            if (qrPollInterval) clearInterval(qrPollInterval);
        });

        // --- SEARCH ---
        document.getElementById('search-conversations').addEventListener('input', renderConversationList);

        // --- UNREAD BADGES ---
        async function updateUnreadBadges() {
            const counts = await api.getUnreadCount();
            ['aero-festas', 'abc-festas'].forEach(name => {
                const badge = document.getElementById(`badge-${name}`);
                if (badge) {
                    const count = counts[name] || 0;
                    badge.textContent = count > 0 ? `(${count > 99 ? '99+' : count})` : '';
                }
            });
        }

        // --- LOAD CONVERSATIONS ---
        async function loadConversations() {
            const all = await api.getConversations(currentInstance);
            if (showingArchived) {
                conversations = all.filter(c => c.isArchived);
            } else {
                conversations = all.filter(c => !c.isArchived);
                // Count archived for the bar
                const archCount = all.filter(c => c.isArchived).length;
                const archivedBar = document.getElementById('archived-bar');
                const archivedCount = document.getElementById('archived-count');
                if (archivedBar && archivedCount) {
                    archivedCount.textContent = archCount;
                    if (archCount > 0 && currentSidePanel === 'chats') archivedBar.classList.remove('hidden');
                    else archivedBar.classList.add('hidden');
                }
            }
            renderConversationList();
        }

        // --- POLLING ---
        function startPolling() {
            pollInterval = setInterval(async () => {
                await loadConversations();
                await updateUnreadBadges();

                // Refresh current conversation messages
                if (currentConversationId && messagesPage === 1) {
                    const freshMsgs = await api.getMessages(currentConversationId, 1);
                    const newMsgs = freshMsgs.reverse();
                    if (newMsgs.length > 0 && messages.length > 0) {
                        const lastKnown = messages[messages.length - 1];
                        const hasNew = newMsgs.some(m => m.id !== lastKnown.id && new Date(m.timestamp) > new Date(lastKnown.timestamp));
                        // Check status changes (delivered, read)
                        const hasStatusChange = messages.some(m => {
                            const fresh = newMsgs.find(f => f.id === m.id);
                            return fresh && fresh.status !== m.status;
                        });
                        if (hasNew || hasStatusChange) {
                            // Preserve locally-stored mediaUrl for sent media
                            for (const nm of newMsgs) {
                                if (!nm.mediaUrl) {
                                    const existing = messages.find(m => m.id === nm.id);
                                    if (existing?.mediaUrl) nm.mediaUrl = existing.mediaUrl;
                                }
                            }
                            messages = newMsgs;
                            renderMessages(hasNew); // scroll only if new msg
                            if (hasNew) {
                                const conv = conversations.find(c => c.id === currentConversationId);
                                if (conv?.unreadCount > 0) {
                                    await api.markRead(currentConversationId);
                                    conv.unreadCount = 0;
                                    renderConversationList();
                                }
                            }
                        }
                    } else if (messages.length === 0 && newMsgs.length > 0) {
                        messages = newMsgs;
                        renderMessages(true);
                    }
                }

                // Update instance status
                instances = await api.getInstances();
                updateConnectionStatus();
            }, 5000);

            // Presence polling (mais r√°pido - 2s)
            setInterval(async () => {
                if (!currentConversation) return;
                try {
                    const data = await api.getPresence(currentInstance, currentConversation.remoteJid);
                    const el = document.getElementById('chat-presence');
                    const phone = document.getElementById('chat-contact-phone');
                    if (data.presence === 'composing' || data.presence === 'typing') {
                        el.textContent = 'digitando...';
                        el.classList.remove('hidden');
                        phone.classList.add('hidden');
                    } else if (data.presence === 'recording') {
                        el.textContent = 'gravando √°udio...';
                        el.classList.remove('hidden');
                        phone.classList.add('hidden');
                    } else {
                        el.classList.add('hidden');
                        phone.classList.remove('hidden');
                    }
                } catch(e) {}
            }, 2000);
        }

        // --- SIDEBAR NAVIGATION ---
        let currentSidePanel = 'chats';
        let showingArchived = false;
        let contactsCache = [];
        let statusCache = [];

        document.querySelectorAll('.wa-sidebar-btn[data-panel]').forEach(btn => {
            btn.addEventListener('click', () => {
                const panel = btn.dataset.panel;
                document.querySelectorAll('.wa-sidebar-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                switchSidePanel(panel);
            });
        });

        function switchSidePanel(panel) {
            currentSidePanel = panel;
            const title = document.getElementById('side-panel-title');
            const convList = document.getElementById('conversation-list');
            const groupsPanel = document.getElementById('groups-panel');
            const statusPanel = document.getElementById('status-panel');
            const catalogPanel = document.getElementById('catalog-side-panel');
            const settingsPanel = document.getElementById('settings-panel');
            const newConvPanel = document.getElementById('new-conv-panel');
            const archivedBar = document.getElementById('archived-bar');
            const newConvBtn = document.getElementById('new-conversation-btn');
            const syncBtn = document.getElementById('sync-history-btn');

            [convList, groupsPanel, statusPanel, catalogPanel, settingsPanel, newConvPanel].forEach(el => el.classList.add('hidden'));
            archivedBar?.classList.add('hidden');
            newConvBtn?.classList.add('hidden');
            syncBtn?.classList.add('hidden');

            switch (panel) {
                case 'chats':
                    title.textContent = 'Conversas';
                    convList.classList.remove('hidden');
                    archivedBar?.classList.remove('hidden');
                    newConvBtn?.classList.remove('hidden');
                    syncBtn?.classList.remove('hidden');
                    break;
                case 'groups':
                    title.textContent = 'Grupos';
                    groupsPanel.classList.remove('hidden');
                    loadGroups();
                    break;
                case 'status':
                    title.textContent = 'Status';
                    statusPanel.classList.remove('hidden');
                    loadStatusList();
                    break;
                case 'catalog':
                    title.textContent = 'Cat√°logo';
                    catalogPanel.classList.remove('hidden');
                    loadCatalogSidePanel();
                    break;
                case 'settings':
                    title.textContent = 'Configura√ß√µes';
                    settingsPanel.classList.remove('hidden');
                    loadMyProfile();
                    break;
            }
        }

        // --- NEW CONVERSATION ---
        document.getElementById('new-conversation-btn')?.addEventListener('click', openNewConvPanel);

        async function openNewConvPanel() {
            const newConvPanel = document.getElementById('new-conv-panel');
            const convList = document.getElementById('conversation-list');
            const archivedBar = document.getElementById('archived-bar');
            convList.classList.add('hidden');
            archivedBar?.classList.add('hidden');
            newConvPanel.classList.remove('hidden');

            newConvPanel.querySelector('#contacts-list').innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando contatos...</p></div>';
            contactsCache = await api.getContacts(currentInstance);
            renderContactsList(contactsCache, 'contacts-list', (contact) => {
                closeNewConvPanel();
                startConversationWith(contact);
            });

            document.getElementById('search-contacts').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                const filtered = contactsCache.filter(c => c.name.toLowerCase().includes(q) || c.phoneNumber.includes(q));
                renderContactsList(filtered, 'contacts-list', (contact) => {
                    closeNewConvPanel();
                    startConversationWith(contact);
                });
            });
        }
        window.closeNewConvPanel = function() {
            document.getElementById('new-conv-panel').classList.add('hidden');
            document.getElementById('conversation-list').classList.remove('hidden');
            document.getElementById('archived-bar')?.classList.remove('hidden');
        };

        function renderContactsList(contacts, containerId, onClick) {
            const container = document.getElementById(containerId);
            if (contacts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm py-8">Nenhum contato encontrado</p>';
                return;
            }
            container.innerHTML = contacts.map(c => {
                const initials = escapeHtml((c.name || '?')[0].toUpperCase());
                const cachedPic = profilePicCache[c.phoneNumber];
                const avatarContent = cachedPic
                    ? `<img src="${cachedPic}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`
                    : initials;
                return `<div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition" data-jid="${escapeHtml(c.remoteJid)}" data-name="${escapeHtml(c.name)}" data-phone="${escapeHtml(c.phoneNumber)}">
                    <div class="w-10 h-10 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white text-sm font-bold flex-shrink-0 overflow-hidden" data-contact-phone="${escapeHtml(c.phoneNumber)}">${avatarContent}</div>
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium truncate">${escapeHtml(c.name)}</p>
                        <p class="text-xs text-gray-400">${escapeHtml(c.phoneNumber)}</p>
                    </div>
                </div>`;
            }).join('');
            container.querySelectorAll('[data-jid]').forEach(el => {
                el.addEventListener('click', () => {
                    onClick({ remoteJid: el.dataset.jid, name: el.dataset.name, phoneNumber: el.dataset.phone });
                });
            });
            // Carregar fotos de perfil dos contatos que ainda n√£o est√£o no cache
            loadContactProfilePics(contacts, containerId);
        }

        async function loadContactProfilePics(contacts, containerId) {
            for (const c of contacts) {
                if (profilePicCache[c.phoneNumber] !== undefined) continue;
                profilePicCache[c.phoneNumber] = null; // marca como carregando
                try {
                    const data = await api.getProfilePic(currentInstance, c.phoneNumber);
                    if (data.profilePicUrl) {
                        profilePicCache[c.phoneNumber] = data.profilePicUrl;
                        const avatarEl = document.querySelector(`#${containerId} [data-contact-phone="${c.phoneNumber}"]`);
                        if (avatarEl) {
                            const initials = (c.name || '?')[0].toUpperCase();
                            avatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                        }
                    }
                } catch (e) { /* silenciar */ }
            }
        }

        async function startConversationWith(contact) {
            // Check if conversation already exists
            const existing = conversations.find(c => c.remoteJid === contact.remoteJid);
            if (existing) { openConversation(existing); return; }
            // Create a temporary conversation object
            const tempConv = {
                id: null, remoteJid: contact.remoteJid, phoneNumber: contact.phoneNumber,
                contactName: contact.name, instanceId: null, unreadCount: 0,
                lastMessageAt: null, lastMessagePreview: null, isGroup: false
            };
            openConversation(tempConv);
        }

        // --- SEND CONTACT ---
        async function openSendContactModal() {
            document.getElementById('send-contact-modal').classList.remove('modal-hidden');
            const list = document.getElementById('contacts-send-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin"></i></div>';
            if (contactsCache.length === 0) contactsCache = await api.getContacts(currentInstance);
            renderContactsList(contactsCache, 'contacts-send-list', async (contact) => {
                document.getElementById('send-contact-modal').classList.add('modal-hidden');
                const result = await api.sendContact({
                    instanceName: currentInstance, remoteJid: currentConversation.remoteJid,
                    contact: { fullName: contact.name, phoneNumber: contact.phoneNumber }
                });
                if (result) {
                    messages.push(result);
                    renderMessages();
                    showToast('Contato enviado', 'success');
                }
            });

            document.getElementById('search-contacts-send').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                const filtered = contactsCache.filter(c => c.name.toLowerCase().includes(q) || c.phoneNumber.includes(q));
                renderContactsList(filtered, 'contacts-send-list', async (contact) => {
                    document.getElementById('send-contact-modal').classList.add('modal-hidden');
                    const result = await api.sendContact({
                        instanceName: currentInstance, remoteJid: currentConversation.remoteJid,
                        contact: { fullName: contact.name, phoneNumber: contact.phoneNumber }
                    });
                    if (result) { messages.push(result); renderMessages(); }
                });
            });
        }

        // --- GROUPS ---
        async function loadGroups() {
            const panel = document.getElementById('groups-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando grupos...</p></div>';
            let groups;
            try {
                groups = await api.getGroups(currentInstance);
            } catch(e) {
                panel.innerHTML = `<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-circle text-3xl text-red-300 mb-2"></i><p class="text-sm font-medium">Erro ao carregar grupos</p><p class="text-xs text-gray-400 mt-1">${escapeHtml(e.message)}</p></div>`;
                return;
            }
            if (!groups || groups.length === 0) {
                panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-users text-3xl text-gray-300 mb-2"></i><p class="text-sm">Nenhum grupo encontrado</p><p class="text-xs text-gray-400 mt-1">Verifique se o WhatsApp est√° conectado</p></div>';
                return;
            }
            panel.innerHTML = groups.map(g => `
                <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition conv-item" data-group-jid="${escapeHtml(g.id)}">
                    <div class="w-10 h-10 rounded-full bg-teal-500 flex items-center justify-center text-white text-sm flex-shrink-0">
                        <i class="fas fa-users text-xs"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium truncate">${escapeHtml(g.subject)}</p>
                        <p class="text-xs text-gray-400">${g.size} participantes</p>
                    </div>
                </div>
            `).join('');
            panel.querySelectorAll('[data-group-jid]').forEach(el => {
                el.addEventListener('click', async () => {
                    const groupJid = el.dataset.groupJid;
                    // Find existing conversation or create temp
                    let conv = conversations.find(c => c.remoteJid === groupJid);
                    if (!conv) {
                        const name = el.querySelector('.text-sm.font-medium')?.textContent || 'Grupo';
                        conv = { id: null, remoteJid: groupJid, phoneNumber: groupJid.replace('@g.us', ''), contactName: name, isGroup: true, unreadCount: 0 };
                    }
                    openConversation(conv);
                });
            });
        }

        // --- ARCHIVED ---
        window.toggleArchivedView = async function() {
            showingArchived = !showingArchived;
            document.getElementById('side-panel-title').textContent = showingArchived ? 'Arquivados' : 'Conversas';
            await loadConversations();
        };

        // --- MUTE ---
        window.toggleMuteChat = function() {
            if (!currentConversation) return;
            if (currentConversation.isMuted) {
                unmuteChat();
            } else {
                document.getElementById('mute-modal').classList.remove('modal-hidden');
            }
        };
        window.muteChat = async function(duration) {
            document.getElementById('mute-modal').classList.add('modal-hidden');
            if (!currentConversation?.id) return;
            await api.muteConversation(currentConversation.id, true, duration);
            currentConversation.isMuted = true;
            updateChatHeaderButtons();
            showToast('Conversa silenciada', 'success');
            await loadConversations();
            renderConversationList();
        };
        async function unmuteChat() {
            if (!currentConversation?.id) return;
            await api.muteConversation(currentConversation.id, false);
            currentConversation.isMuted = false;
            updateChatHeaderButtons();
            showToast('Notifica√ß√µes ativadas', 'success');
            await loadConversations();
            renderConversationList();
        }

        // --- ARCHIVE ---
        window.toggleArchiveChat = async function() {
            if (!currentConversation?.id) return;
            const newState = !currentConversation.isArchived;
            await api.archiveConversation(currentConversation.id, newState);
            showToast(newState ? 'Conversa arquivada' : 'Conversa desarquivada', 'success');
            await loadConversations();
            renderConversationList();
            if (newState) { currentConversationId = null; currentConversation = null; showChatWelcome(); }
        };

        function updateChatHeaderButtons() {
            if (!currentConversation) return;
            const muteBtn = document.getElementById('mute-chat-btn');
            const archiveBtn = document.getElementById('archive-chat-btn');
            muteBtn?.classList.remove('hidden');
            archiveBtn?.classList.remove('hidden');
            if (currentConversation.isMuted) {
                muteBtn.innerHTML = '<i class="fas fa-bell-slash text-sm text-amber-500"></i>';
                muteBtn.title = 'Dessilenciar';
            } else {
                muteBtn.innerHTML = '<i class="fas fa-bell text-sm"></i>';
                muteBtn.title = 'Silenciar';
            }
        }

        // --- CONTACT DETAILS ---
        window.openContactDetails = function() {
            if (!currentConversation) return;
            const panel = document.getElementById('contact-details-panel');
            const content = document.getElementById('contact-details-content');
            const phone = currentConversation.phoneNumber || currentConversation.remoteJid?.replace(/@.*/, '');
            const name = currentConversation.contactName || phone;
            const picUrl = profilePicCache[phone];
            const isGroup = currentConversation.isGroup;

            content.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-24 h-24 rounded-full ${isGroup ? 'bg-teal-500' : 'bg-[var(--wa-green)]'} mx-auto mb-3 flex items-center justify-center text-white text-3xl font-bold overflow-hidden">
                        ${picUrl ? `<img src="${escapeHtml(picUrl)}" class="w-full h-full object-cover">` : (isGroup ? '<i class="fas fa-users text-2xl"></i>' : escapeHtml(name[0]?.toUpperCase() || '?'))}
                    </div>
                    <h3 class="font-bold text-lg">${escapeHtml(name)}</h3>
                    <p class="text-sm text-gray-500">${isGroup ? 'Grupo' : escapeHtml(phone)}</p>
                </div>
                <div class="space-y-1">
                    ${currentConversation.clientId ? `<a href="Sistema de CRM.html?client=${currentConversation.clientId}" class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition"><i class="fas fa-users text-indigo-500 w-5 text-center"></i><span class="text-sm">Ver no CRM</span></a>` : ''}
                    <button onclick="toggleMuteChat(); closeContactDetails();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                        <i class="fas fa-${currentConversation.isMuted ? 'bell' : 'bell-slash'} text-gray-400 w-5 text-center"></i>
                        <span class="text-sm">${currentConversation.isMuted ? 'Dessilenciar' : 'Silenciar notifica√ß√µes'}</span>
                    </button>
                    <button onclick="toggleArchiveChat(); closeContactDetails();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition text-left">
                        <i class="fas fa-archive text-gray-400 w-5 text-center"></i>
                        <span class="text-sm">${currentConversation.isArchived ? 'Desarquivar' : 'Arquivar conversa'}</span>
                    </button>
                </div>
            `;
            panel.classList.add('open');
        };
        window.closeContactDetails = function() {
            document.getElementById('contact-details-panel').classList.remove('open');
        };

        // --- PROFILE ---
        async function loadMyProfile() {
            const profile = await api.getProfile(currentInstance);
            if (profile) {
                document.getElementById('my-profile-name').textContent = profile.name || '...';
                document.getElementById('my-profile-status').textContent = profile.status || 'Dispon√≠vel';
                document.getElementById('my-profile-phone').textContent = profile.phoneNumber || '';
                if (profile.profilePicUrl) {
                    document.getElementById('my-profile-pic').innerHTML = `<img src="${escapeHtml(profile.profilePicUrl)}" class="w-full h-full object-cover">`;
                }
            }
        }
        window.openEditProfileModal = async function() {
            const profile = await api.getProfile(currentInstance);
            if (profile) {
                document.getElementById('edit-profile-name').value = profile.name || '';
                document.getElementById('edit-profile-about').value = profile.status || '';
                if (profile.profilePicUrl) {
                    document.getElementById('edit-profile-pic-preview').innerHTML = `<img src="${escapeHtml(profile.profilePicUrl)}" class="w-full h-full object-cover">`;
                }
            }
            document.getElementById('edit-profile-modal').classList.remove('modal-hidden');
        };
        let editProfilePicBase64 = null;
        document.getElementById('edit-profile-pic-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                editProfilePicBase64 = reader.result;
                document.getElementById('edit-profile-pic-preview').innerHTML = `<img src="${reader.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        });
        window.saveProfile = async function() {
            const name = document.getElementById('edit-profile-name').value.trim();
            const status = document.getElementById('edit-profile-about').value.trim();
            const data = {};
            if (name) data.name = name;
            if (status !== undefined) data.status = status;
            if (editProfilePicBase64) data.picture = editProfilePicBase64;
            await api.updateProfile(currentInstance, data);
            editProfilePicBase64 = null;
            document.getElementById('edit-profile-modal').classList.add('modal-hidden');
            showToast('Perfil atualizado', 'success');
            loadMyProfile();
        };

        // --- MERGE DUPLICATES ---
        window.mergeDuplicates = async function() {
            if (!confirm('Isso vai mesclar conversas duplicadas (causadas por sufixo de dispositivo no JID). Continuar?')) return;
            showToast('Corrigindo conversas duplicadas...', 'info');
            try {
                const r = await fetch(`${BASE}/merge-duplicates`, { method: 'POST', headers: headers() });
                const data = await r.json();
                if (r.ok) {
                    showToast(`Conclu√≠do: ${data.merged} mensagens movidas, ${data.deleted} conversas removidas`, 'success');
                    await loadConversations();
                    renderConversationList();
                } else {
                    showToast(data.error || 'Erro ao mesclar', 'error');
                }
            } catch(e) {
                showToast('Erro ao mesclar conversas', 'error');
            }
        };

        // --- DISCONNECT ---
        window.disconnectInstance = async function() {
            if (!confirm('Deseja realmente desconectar o WhatsApp?')) return;
            await api.disconnect(currentInstance);
            instances = await api.getInstances();
            showToast('WhatsApp desconectado', 'success');
            updateConnectionStatus();
        };

        // --- STATUS / STORIES ---
        async function loadStatusList() {
            const panel = document.getElementById('status-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando status...</p></div>';
            try {
                statusCache = await api.getStatus(currentInstance);
            } catch(e) {
                statusCache = [];
            }
            if (statusCache.length === 0) {
                panel.innerHTML = `
                    <div class="p-3">
                        <button onclick="document.getElementById('post-status-modal').classList.remove('modal-hidden')" class="w-full shiny-btn py-2.5 rounded-xl text-sm font-bold mb-4"><i class="fas fa-plus mr-1"></i>Postar Status</button>
                        <div class="text-center text-gray-400 text-sm py-4">
                            <i class="fas fa-circle-notch text-3xl text-gray-300 mb-3"></i>
                            <p>Nenhum status recente</p>
                            <p class="text-xs mt-1 text-gray-400">Os status aparecer√£o aqui quando seus contatos postarem atualiza√ß√µes</p>
                        </div>
                    </div>`;
                return;
            }
            // Group by participant
            const byParticipant = {};
            statusCache.forEach(s => {
                const key = s.participant || s.pushName || 'Eu';
                if (!byParticipant[key]) byParticipant[key] = [];
                byParticipant[key].push(s);
            });
            let html = `<div class="p-3"><button onclick="document.getElementById('post-status-modal').classList.remove('modal-hidden')" class="w-full shiny-btn py-2.5 rounded-xl text-sm font-bold mb-3"><i class="fas fa-plus mr-1"></i>Postar Status</button></div>`;
            for (const [participant, statuses] of Object.entries(byParticipant)) {
                const name = statuses[0].pushName || participant.replace(/@.*/, '');
                const time = statuses[0].timestamp ? new Date(statuses[0].timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                html += `
                    <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition" data-status-participant="${escapeHtml(participant)}">
                        <div class="w-11 h-11 rounded-full status-ring bg-[var(--wa-green)] flex items-center justify-center text-white text-sm font-bold">${escapeHtml(name[0]?.toUpperCase() || '?')}</div>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium truncate">${escapeHtml(name)}</p>
                            <p class="text-xs text-gray-400">${time}</p>
                        </div>
                    </div>`;
            }
            panel.innerHTML = html;
            panel.querySelectorAll('[data-status-participant]').forEach(el => {
                el.addEventListener('click', () => viewStatus(el.dataset.statusParticipant));
            });
        }

        function viewStatus(participant) {
            const statuses = statusCache.filter(s => (s.participant || s.pushName || 'Eu') === participant);
            if (statuses.length === 0) return;
            const s = statuses[0];
            document.getElementById('status-viewer-name').textContent = s.pushName || participant.replace(/@.*/, '');
            document.getElementById('status-viewer-time').textContent = s.timestamp ? new Date(s.timestamp).toLocaleTimeString('pt-BR') : '';
            const content = document.getElementById('status-viewer-content');
            if (s.messageType === 'image' && s.mediaUrl) {
                content.innerHTML = `<img src="${escapeHtml(s.mediaUrl)}" class="max-h-[70vh] max-w-full rounded-lg">`;
            } else if (s.messageType === 'video' && s.mediaUrl) {
                content.innerHTML = `<video src="${escapeHtml(s.mediaUrl)}" controls autoplay class="max-h-[70vh] max-w-full rounded-lg"></video>`;
            } else {
                content.innerHTML = `<p class="text-white text-xl text-center px-8">${escapeHtml(s.content || '')}</p>`;
            }
            document.getElementById('status-viewer-modal').classList.remove('modal-hidden');
            // Progress bar
            const progress = document.getElementById('status-progress');
            progress.style.width = '0%';
            progress.style.transition = 'width 5s linear';
            setTimeout(() => { progress.style.width = '100%'; }, 50);
            setTimeout(() => { document.getElementById('status-viewer-modal').classList.add('modal-hidden'); }, 5000);
        }

        window.postTextStatus = async function() {
            const text = document.getElementById('status-text-input').value.trim();
            if (!text) return;
            await api.postStatus(currentInstance, { type: 'text', content: text });
            document.getElementById('post-status-modal').classList.add('modal-hidden');
            document.getElementById('status-text-input').value = '';
            showToast('Status publicado', 'success');
            loadStatusList();
        };

        // --- CATALOG SIDE PANEL ---
        async function loadCatalogSidePanel() {
            const panel = document.getElementById('catalog-side-panel');
            panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-xl mb-2"></i><p class="text-sm">Carregando cat√°logo...</p></div>';
            const catalog = await api.getCatalog(currentInstance);
            if (!catalog || (Array.isArray(catalog) && catalog.length === 0)) {
                panel.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-store text-3xl text-gray-300 mb-2"></i><p class="text-sm">Cat√°logo vazio</p></div>';
                return;
            }
            const items = Array.isArray(catalog) ? catalog : catalog.products || catalog.data || [];
            panel.innerHTML = '<div class="p-3 catalog-grid">' + items.map(item => `
                <div class="catalog-item">
                    ${item.imageUrl ? `<img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.name || '')}">` : '<div class="h-[120px] bg-gray-100 flex items-center justify-center"><i class="fas fa-box text-gray-300 text-2xl"></i></div>'}
                    <div class="p-2">
                        <p class="text-xs font-semibold truncate">${escapeHtml(item.name || 'Produto')}</p>
                        ${item.price ? `<p class="text-xs text-green-600 font-bold">${escapeHtml(item.price)}</p>` : ''}
                    </div>
                </div>
            `).join('') + '</div>';
        }

        // --- SYNC HISTORY ---
        async function syncCurrentConversation() {
            if (!currentConversation?.id) return;
            const syncBanner = document.getElementById('sync-banner');
            syncBanner.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sincronizando hist√≥rico...';
            try {
                const result = await api.syncConversation(currentConversation.id);
                if (result && result.synced > 0) {
                    showToast(`${result.synced} mensagens sincronizadas`, 'success');
                    await loadMessages();
                    syncBanner.classList.add('hidden');
                } else if (result && result.total === 0) {
                    syncBanner.innerHTML = '<i class="fas fa-info-circle mr-1"></i> Nenhum hist√≥rico dispon√≠vel na Evolution API. Mensagens aparecer√£o em tempo real.';
                    setTimeout(() => syncBanner.classList.add('hidden'), 4000);
                } else {
                    syncBanner.classList.add('hidden');
                    showToast('Nenhuma mensagem nova encontrada', 'info');
                }
            } catch(e) {
                syncBanner.innerHTML = '<i class="fas fa-exclamation-circle mr-1 text-red-500"></i> Erro ao sincronizar. Tente novamente.';
                setTimeout(() => syncBanner.classList.add('hidden'), 3000);
            }
        }
        window.syncCurrentConversation = syncCurrentConversation;

        window.syncFullHistory = async function() {
            showToast('Sincronizando hist√≥rico...', 'info');
            const result = await api.syncHistory(currentInstance);
            if (result) {
                showToast(`${result.synced} mensagens sincronizadas de ${result.conversations} conversas`, 'success');
                await loadConversations();
                renderConversationList();
            } else {
                showToast('Erro ao sincronizar', 'error');
            }
        };

        document.getElementById('sync-history-btn')?.addEventListener('click', () => syncFullHistory());

        // --- TOAST HELPER ---
        function showToast(message, type = 'success') {
            // Backward compatibility: showToast('msg', true) ‚Üí error
            if (type === true) type = 'error';
            else if (type === false) type = 'success';
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            msg.textContent = message;
            icon.className = type === 'error' ? 'fas fa-exclamation-circle text-red-500 text-lg' :
                type === 'info' ? 'fas fa-info-circle text-blue-500 text-lg' :
                'fas fa-check-circle text-green-500 text-lg';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // --- INIT ---
        async function init() {
            instances = await api.getInstances();
            shortcuts = await api.getShortcuts();

            // Set active tab based on URL
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.instance === currentInstance);
            });

            updateConnectionStatus();
            setupInstanceTabs();
            await loadConversations();
            await updateUnreadBadges();
            showChatWelcome();
            startPolling();

            // On desktop, show both panels; on mobile, hide chat panel
            if (window.innerWidth >= 1024) {
                document.getElementById('conversation-panel').classList.remove('mobile-hidden');
                document.getElementById('chat-panel').classList.remove('mobile-hidden');
            } else {
                document.getElementById('chat-panel').classList.add('mobile-hidden');
                document.getElementById('conversation-panel').classList.remove('mobile-hidden');
            }

            // Handle URL parameter for conversation
            const urlConv = new URLSearchParams(window.location.search).get('conversation');
            if (urlConv) {
                const conv = conversations.find(c => c.id === urlConv);
                if (conv) openConversation(conv);
            }

            document.title = `WhatsApp - ${currentInstance === 'aero-festas' ? 'Aero Festas' : 'ABC Festas'}`;
        }

        // --- PDF VIEWER ---
        function openPdfViewer(url, name) {
            document.getElementById('pdf-title').innerHTML = `<i class="fas fa-file-pdf text-red-400 mr-2"></i>${escapeHtml(name || 'PDF')}`;
            // data: URIs n√£o funcionam em iframes em alguns browsers, converter para Blob URL
            if (url.startsWith('data:')) {
                try {
                    const [header, b64] = url.split(',');
                    const mime = header.match(/data:(.*?);/)?.[1] || 'application/pdf';
                    const bin = atob(b64);
                    const arr = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    url = URL.createObjectURL(blob);
                } catch(e) { console.warn('PDF blob error:', e); }
            }
            document.getElementById('pdf-frame').src = url;
            document.getElementById('pdf-modal').classList.remove('modal-hidden');
        }
        window.openPdfViewer = openPdfViewer;

        // Abre PDF em nova aba (funciona com data: URI via Blob)
        function openPdfNewTab(url) {
            if (url.startsWith('data:')) {
                try {
                    const [header, b64] = url.split(',');
                    const mime = header.match(/data:(.*?);/)?.[1] || 'application/pdf';
                    const bin = atob(b64);
                    const arr = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    url = URL.createObjectURL(blob);
                } catch(e) { console.warn('PDF blob error:', e); }
            }
            window.open(url, '_blank');
        }
        window.openPdfNewTab = openPdfNewTab;

        // --- EMOJI PICKER ---
        const EMOJIS = {
            'Frequentes': 'üòÇ‚ù§Ô∏èüî•üëçüòçü•∞üòäüôèüíïüò≠üòòü•∫‚ú®üòÖü§£üíúü§çüíõüôåüòÅüíÄüëÄüíóü§îüò≥üòéüíôü•≤üíöüòãüòèüò¢üëèü§óüíîüò©ü§©ü•≥üò§üò°ü§Øüò±ü§Æüëâüëàüí™ü´∂üéâüéäüé∂üëãüí∞‚úÖ',
            'Rostos': 'üòÄüòÉüòÑüòÅüòÜüòÖü§£üòÇüôÇüôÉüòâüòäüòáü•∞üòçü§©üòòüòó‚ò∫üòöüòôü•≤üòãüòõüòúü§™üòùü§ëü§óü§≠ü§´ü§îü´°ü§êü§®üòêüòëüò∂ü´•üòèüòíüôÑüò¨üòÆ‚Äçüí®ü§•ü´®üòåüòîüò™ü§§üò¥üò∑ü§íü§ïü§¢ü§Æü§ßü•µü•∂ü•¥üòµüòµ‚Äçüí´ü§Øü§†ü•≥ü•∏üòéü§ìüßêüòïü´§üòüüôÅ‚òπüòÆüòØüò≤üò≥ü•∫ü•πüò¶üòßüò®üò∞üò•üò¢üò≠üò±üòñüò£üòûüòìüò©üò´ü•±üò§üò°üò†ü§¨üòàüëøüíÄ‚ò†üí©ü§°üëπüë∫üëªüëΩüëæü§ñüò∫üò∏üòπüòªüòºüòΩüôÄüòøüòæü´†ü´£ü´¢ü´°ü´•ü´§',
            'Gestos': 'üëãü§öüñê‚úãüññü´±ü´≤ü´≥ü´¥üëåü§åü§è‚úåü§ûü´∞ü§üü§òü§ôüëàüëâüëÜüñïüëá‚òùü´µüëçüëé‚úäüëäü§õü§úüëèüôåü´∂üëêü§≤ü§ùüôè‚úçüíÖü§≥üí™ü¶æü¶øü¶µü¶∂üëÇü¶ªüëÉüß†ü´Äü´Åü¶∑ü¶¥üëÄüëÅüëÖüëÑü´¶üíãü´Ç',
            'Pessoas': 'üë∂üßíüë¶üëßüßëüë±üë®üßîüë©üßìüë¥üëµüôçüôéüôÖüôÜüíÅüôãüßèüôáü§¶ü§∑üëÆüïµüíÇü•∑üë∑ü´Öü§¥üë∏üë≥üë≤üßïü§µüë∞ü§∞ü´Éü´Ñü§±üëºüéÖü§∂ü¶∏ü¶πüßôüßöüßõüßúüßùüßûüßüüíÜüíáüö∂üßçüßéüèÉüíÉüï∫üï¥üëØüßñüßóü§∏üèåüèá‚õ∑üèÇüèãü§ºü§Ωü§æü§∫‚õπüèäüö£üßòüõÄüõåüë≠üë´üë¨üíèüíëüë™üë®‚Äçüë©‚Äçüë¶üë®‚Äçüë©‚Äçüëßüë®‚Äçüë©‚Äçüëß‚Äçüë¶üë®‚Äçüë©‚Äçüë¶‚Äçüë¶üë®‚Äçüë©‚Äçüëß‚Äçüëßüó£üë§üë•ü´Ç',
            'Animais': 'üê∂üê±üê≠üêπüê∞ü¶äüêªüêºüêª‚Äç‚ùÑÔ∏èüê®üêØü¶ÅüêÆüê∑üêΩüê∏üêµüôàüôâüôäüêíüêîüêßüê¶üê§üê£üê•ü¶Üü¶Öü¶âü¶áüê∫üêóüê¥ü¶Ñüêùü™±üêõü¶ãüêåüêûüêúü™∞ü™≤ü™≥ü¶üü¶óüï∑üï∏ü¶Çüê¢üêçü¶éü¶ñü¶ïüêôü¶ëü¶êü¶ûü¶Äü™∏üê°üê†üêüüê¨üê≥üêãü¶àü¶≠üêäüêÖüêÜü¶ìü¶çü¶ßü¶£üêòü¶õü¶èüê™üê´ü¶íü¶òü¶¨üêÉüêÇüêÑüêéüêñüêèüêëü¶ôüêêü¶åüêïüê©ü¶Æüêàüêà‚Äç‚¨õü™∂üêìü¶Éü¶§ü¶öü¶úü¶¢ü¶©üïäüêáü¶ùü¶®ü¶°ü¶´ü¶¶ü¶•üêÅüêÄüêøü¶îüêæüêâüê≤üåµüéÑüå≤üå≥üå¥ü™µüå±üåø‚òòüçÄüéçü™¥üéãüçÉüçÇüçÅü™∫ü™π',
            'Natureza': 'üå∏üíêüå∑üåπü•Äüå∫üåªüåºüå±üå≤üå≥üå¥üåµüåæüçÄ‚òòüçÉüçÇüçÅüçÑüêöü™®üåçüåéüåèüåëüåíüåìüåîüåïüåñüåóüåòüåôüåöüåõüåú‚òÄüåùüåû‚≠êüåüüå†‚òÅ‚õÖ‚õàüå§üå•üå¶üåßüå®üå©üå™üå´üå¨üåÄüåàüåÇ‚òÇ‚òî‚õ±‚ö°‚ùÑ‚òÉ‚õÑüî•üíßüåäüéÑ‚ú®üí´ü™ê',
            'Comida': 'üçèüçéüçêüçäüçãüçåüçâüçáüçìü´êüçàüçíüçëü•≠üççü••ü•ùüçÖüçÜü•ëü•¶ü•¨ü•íüå∂ü´ëüåΩü•ïü´íüßÑüßÖü•îüç†ü´òü•úüå∞üçûü•êü•ñü´ìü•®ü•Øü•ûüßáüßÄüçñüçóü•©ü•ìüçîüçüüçïüå≠ü•™üåÆüåØü´îü•ôüßÜü•öüç≥ü•òüç≤ü´ïü•£ü•óüçøüßàüßÇü•´üç±üçòüçôüçöüçõüçúüçùüç¢üç£üç§üç•ü•Æüç°ü•üü•†ü•°ü¶Äü¶ûü¶êü¶ëü¶™üç¶üçßüç®üç©üç™üéÇüç∞üßÅü•ßüç´üç¨üç≠üçÆüçØüçºü•õ‚òïü´ñüçµüç∂üçæüç∑üç∏üçπüç∫üçªü•Çü•Éü´óü•§üßãüßÉüßâüßäü•¢üçΩüç¥ü•Ñüî™ü´ôüè∫',
            'Atividades': '‚öΩüèÄüèà‚öæü•éüéæüèêüèâü•èüé±ü™Äüèìüè∏üèíüèëü•çüèèü™Éü•Ö‚õ≥ü™Åüèπüé£ü§øü•äü•ãüéΩüõπüõºüõ∑‚õ∏ü•åüéø‚õ∑üèÇüèãü§∏ü§∫‚õπü§æüèåüèáüßòüèÑüèäü§Ωüö£üßóüöµüö¥üèÜü•áü•àü•âüèÖüéñüèµüéóüé´üéüüé™ü§πüé≠ü©∞üé®üé¨üé§üéßüéºüéπü•Åü™òüé∑üé∫üé∏ü™ïüéªü™óüé≤‚ôüüéØüé≥üéÆüé∞üß©',
            'Objetos': '‚åöüì±üì≤üíª‚å®üñ•üñ®üñ±üñ≤üïπüóúüíΩüíæüíøüìÄüìºüì∑üì∏üìπüé•üìΩüéûüìû‚òéüìüüì†üì∫üìªüéôüéöüéõüß≠‚è±‚è≤‚è∞üï∞‚åõ‚è≥üì°üîãü™´üîåüí°üî¶üïØü™îüßØüõ¢üí∏üíµüí¥üí∂üí∑ü™ôüí∞üí≥ü™™üíé‚öñü™úüß∞ü™õüîßüî©‚öôü™§üß≤üî´üí£ü™ìüî™üó°‚öîüõ°üö¨‚ö∞ü™¶‚ö±üè∫üîÆüìøüßøü™¨üíà‚öóüî≠üî¨üï≥ü™£ü©πü©∫ü©ªüíäüíâü©∏üß¨ü¶†üß´üß™üå°üßπü™†üß∫üßªüöΩüö∞üöøüõÅüõÄüßºü™•ü™íüßΩü™£ü™ûü™üüõèüõãü™ëüö™üß≥',
            'Viagem': 'üöóüöïüöôüöåüöéüèéüöìüöëüöíüöêüõªüööüöõüöúüèçüõµüö≤üõ¥üõπüõºüöèüõ£üõ§üõû‚õΩüö®üö•üö¶üõëüöß‚öìüõü‚õµüõ∂üö§üõ≥‚õ¥üõ•üö¢‚úàüõ©üõ´üõ¨ü™Çüí∫üöÅüöüüö†üö°üõ∞üöÄüõ∏üè†üè°üè¢üè£üè§üè•üè¶üè®üè©üè™üè´üè¨üè≠üèØüè∞üííüóºüóΩ‚õ™üïåüõïüïç‚õ©üïã‚õ≤‚õ∫üåÅüåÉüèôüåÑüåÖüåÜüåáüåâ‚ô®üé†üõùüé°üé¢üíàüé™üó∫üóæüß≠üèî‚õ∞üåãüóªüèïüèñüèúüèùüèû',
            'Cora√ß√µes': '‚ù§üß°üíõüíöüíôüíúüñ§ü§çü§éüíî‚ù§‚Äçüî•‚ù§‚Äçü©π‚ù£üíïüíûüíìüíóüíñüíòüíùüíüü´Ä‚ô•üíåüííüíçüíé',
            'Bandeiras': 'üè≥üè¥üèÅüö©üè≥Ô∏è‚Äçüåàüè≥Ô∏è‚Äç‚ößÔ∏èüáßüá∑üá∫üá∏üáµüáπüá¶üá∑üá®üá±üá®üá¥üá≤üáΩüáµüá™üá∫üáæüá™üá∏üá´üá∑üá©üá™üáÆüáπüá¨üáßüáØüáµüá®üá≥üá∞üá∑üáÆüá≥üá∑üá∫üá®üá¶üá¶üá∫üáøüá¶üá≥üá¨üá™üá¨üá∏üá¶üá¶üá™üáπüá∑üáÆüá±üáµüá±üá≥üá±üáßüá™üá®üá≠üá¶üáπüá∏üá™üá≥üá¥üá©üá∞üá´üáÆüáÆüá™üá≥üáøüá∏üá¨üáπüá≠üáªüá≥üáµüá≠üáÆüá©üá≤üáæüáßüá¥üá™üá®üáµüáæüáµüá¶üá®üá∑üá¨üáπüá≠üá≥üá∏üáªüá≥üáÆüá®üá∫üá©üá¥üáµüá∑üá≠üáπüáØüá≤üáßüá∏üáπüáπüáßüáßüá¨üáæüá∏üá∑',
            'S√≠mbolos': '‚òÆ‚úù‚ò™üïâ‚ò∏‚ú°üîØüïé‚òØ‚ò¶üõê‚õé‚ôà‚ôâ‚ôä‚ôã‚ôå‚ôç‚ôé‚ôè‚ôê‚ôë‚ôí‚ôìüÜî‚öõüâë‚ò¢‚ò£üì¥üì≥üà∂üàöüà∏üà∫üà∑‚ú¥üÜöüíÆüâê„äô„äóüà¥üàµüàπüà≤üÖ∞üÖ±üÜéüÜëüÖæüÜò‚ùå‚≠ïüõë‚õîüìõüö´üíØüí¢‚ô®üö∑üöØüö≥üö±üîûüìµüö≠‚ùó‚ùï‚ùì‚ùî‚Äº‚ÅâüîÖüîÜ„ÄΩ‚ö†üö∏üî±‚öúüî∞‚ôª‚úÖüàØüíπ‚ùá‚ú≥‚ùéüåêüí†‚ìÇüåÄüí§üèßüöæ‚ôøüÖøüõóüà≥üàÇüõÇüõÉüõÑüõÖüöπüö∫üöº‚ößüöªüöÆüé¶üì∂üàÅüî£‚Ñπüî§üî°üî†üÜñüÜóüÜôüÜíüÜïüÜì0Ô∏è‚É£1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£9Ô∏è‚É£üîüüî¢#Ô∏è‚É£*Ô∏è‚É£‚èè‚ñ∂‚è∏‚èØ‚èπ‚è∫‚è≠‚èÆ‚è©‚è™‚è´‚è¨‚óÄüîºüîΩ‚û°‚¨Ö‚¨Ü‚¨á‚Üó‚Üò‚Üô‚Üñ‚Üï‚Üî‚Ü©‚Ü™‚§¥‚§µüîÄüîÅüîÇüîÑüîÉüéµüé∂‚ûï‚ûñ‚ûó‚úñüü∞‚ôæüí≤üí±‚Ñ¢¬©¬Æüîöüîôüîõüîùüîú„Ä∞‚û∞‚ûø‚úî‚òëüîòüî¥üü†üü°üü¢üîµüü£‚ö´‚ö™üü§üî∫üîªüî∏üîπüî∂üî∑üî≥üî≤‚ñ™‚ñ´‚óæ‚óΩ‚óº‚óªüü•üüßüü®üü©üü¶üü™‚¨õ‚¨úüîàüîáüîâüîäüîîüîïüì£üì¢üí¨üí≠üóØ‚ô†‚ô£‚ô•‚ô¶üÉèüé¥üÄÑüïêüïëüïíüïìüïîüïïüïñüïóüïòüïôüïöüïõüïúüïùüïûüïüüï†üï°üï¢üï£üï§üï•üï¶üïß'
        };
        let emojiTarget = null;
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');
        const emojiSearch = document.getElementById('emoji-search');

        function renderEmojiGrid(filter = '') {
            let html = '';
            for (const [cat, emojis] of Object.entries(EMOJIS)) {
                // Regex robusta: captura ZWJ sequences, flags, keycaps, skin tones, variation selectors
                const emojiList = emojis.match(/\p{RI}\p{RI}|\p{Emoji}(\p{EMod}|\uFE0F\u20E3?|[\u200d](\p{Emoji}|\uFE0F))*(\uFE0F)?/gu)?.filter(e => e.trim() && !/^[\d#*]$/.test(e)) || [];
                const filtered = filter ? emojiList.filter(e => e.includes(filter)) : emojiList;
                if (filtered.length === 0) continue;
                html += `<div style="grid-column:1/-1; font-size:0.65rem; color:#9ca3af; font-weight:700; padding:4px 2px; text-transform:uppercase;">${cat}</div>`;
                filtered.forEach(e => {
                    html += `<div class="emoji-cell" style="cursor:pointer; padding:4px; border-radius:8px; line-height:1; transition:background 0.1s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background=''">${e}</div>`;
                });
            }
            emojiGrid.innerHTML = html;
        }

        function openEmojiPicker(triggerBtn) {
            emojiTarget = document.getElementById(triggerBtn.dataset.target);
            const rect = triggerBtn.getBoundingClientRect();
            emojiPicker.style.display = 'flex';
            emojiPicker.style.left = Math.min(rect.right - 280, window.innerWidth - 290) + 'px';
            emojiPicker.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
            emojiSearch.value = '';
            renderEmojiGrid();
        }

        function closeEmojiPicker() {
            emojiPicker.style.display = 'none';
            emojiTarget = null;
        }

        // Event delegation for emoji triggers
        document.addEventListener('click', (e) => {
            const trigger = e.target.closest('.emoji-trigger');
            if (trigger) {
                e.stopPropagation();
                if (emojiPicker.style.display === 'flex') closeEmojiPicker();
                else openEmojiPicker(trigger);
                return;
            }
            if (!e.target.closest('#emoji-picker')) closeEmojiPicker();
        });

        emojiGrid.addEventListener('click', (e) => {
            const cell = e.target.closest('.emoji-cell');
            if (cell && emojiTarget) {
                const emoji = cell.textContent;
                // Insert emoji at cursor or at end
                if (emojiTarget.selectionStart !== undefined) {
                    const start = emojiTarget.selectionStart;
                    const end = emojiTarget.selectionEnd;
                    emojiTarget.value = emojiTarget.value.substring(0, start) + emoji + emojiTarget.value.substring(end);
                    emojiTarget.selectionStart = emojiTarget.selectionEnd = start + emoji.length;
                } else {
                    emojiTarget.value += emoji;
                }
                emojiTarget.focus();
                emojiTarget.dispatchEvent(new Event('input'));
            }
        });

        emojiSearch.addEventListener('input', () => renderEmojiGrid(emojiSearch.value));
        emojiPicker.addEventListener('click', (e) => e.stopPropagation());

        init();
    </script>

    <!-- Bottom Nav Collapse -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('main-bottom-nav');
            const handle = document.getElementById('bottom-nav-handle');
            if (bottomNav) {
                const toggleNav = (e) => { e.stopPropagation(); bottomNav.classList.toggle('collapsed'); };
                handle?.addEventListener('click', toggleNav);
                bottomNav.addEventListener('click', (e) => { if (bottomNav.classList.contains('collapsed')) toggleNav(e); });
            }
        });
    </script>

    <script src="js/protect.js"></script>
</body>
</html>
