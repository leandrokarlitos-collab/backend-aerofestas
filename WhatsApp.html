<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - Aero Festas</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="js/pwa-init.js"></script>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üí¨</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --wa-green: #25D366;
            --wa-dark-green: #128C7E;
            --wa-light-green: #dcf8c6;
            --wa-bg: #e5ddd5;
            --primary: #4f46e5;
            --secondary: #a855f7;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #1f2937; }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .form-input {
            background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937;
            border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: all 0.2s ease-in-out;
        }
        .form-input::placeholder { color: #6b7280; }
        .form-input:focus { outline: none; box-shadow: 0 0 0 2px var(--wa-green); border-color: var(--wa-green); }

        .shiny-btn {
            position: relative; border: 2px solid transparent;
            background-image: linear-gradient(to right, var(--wa-dark-green) 0%, var(--wa-green) 51%, var(--wa-dark-green) 100%);
            background-size: 200% auto; color: white;
            box-shadow: 0 4px 15px 0 rgba(37, 211, 102, 0.4); transition: all 0.4s ease;
        }
        .shiny-btn:hover { background-position: right center; transform: translateY(-2px); box-shadow: 0 8px 25px 0 rgba(37, 211, 102, 0.6); }
        .shiny-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }

        /* Chat bubbles */
        .bubble-received {
            background: white; border-radius: 0 12px 12px 12px; max-width: 75%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        .bubble-sent {
            background: var(--wa-light-green); border-radius: 12px 0 12px 12px; max-width: 75%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Conversation item */
        .conv-item { transition: background 0.15s ease; }
        .conv-item:hover { background: rgba(255,255,255,0.5); }
        .conv-item.active { background: rgba(37, 211, 102, 0.08); border-left: 3px solid var(--wa-green); }

        /* Instance tabs */
        .instance-tab {
            padding: 0.5rem 1.25rem; border-radius: 20px; font-weight: 600; font-size: 0.875rem;
            cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
        }
        .instance-tab.active { background: var(--wa-green); color: white; box-shadow: 0 4px 12px rgba(37,211,102,0.3); }
        .instance-tab:not(.active) { background: rgba(255,255,255,0.5); color: #6b7280; }
        .instance-tab:not(.active):hover { background: rgba(255,255,255,0.8); }

        /* Unread badge */
        .unread-badge {
            background: var(--wa-green); color: white; font-size: 0.7rem; font-weight: 700;
            min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; padding: 0 5px;
        }

        /* Status indicator */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-dot.connected { background: var(--wa-green); box-shadow: 0 0 6px rgba(37,211,102,0.5); }
        .status-dot.disconnected { background: #ef4444; }
        .status-dot.connecting { background: #f59e0b; animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Bottom nav (same as CRM) */
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 480px; height: 75px; background: rgba(255,255,255,0.6); backdrop-filter: blur(30px) saturate(210%); -webkit-backdrop-filter: blur(30px) saturate(210%); border: 1px solid rgba(255,255,255,0.4); display: flex; justify-content: space-around; align-items: center; padding: 12px 10px 0 10px; z-index: 10000; border-radius: 40px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(255,255,255,0.8); transition: all 0.7s cubic-bezier(0.19,1,0.22,1); user-select: none; overflow: hidden; }
        .bottom-nav-handle { position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .bottom-nav-handle::after { content: ''; width: 40px; height: 4px; background: rgba(79,70,229,0.2); border-radius: 10px; transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav-handle i { position: absolute; font-size: 1.2rem; color: #4f46e5; opacity: 0; transform: translateY(10px); transition: all 0.5s cubic-bezier(0.19,1,0.22,1); }
        .bottom-nav.collapsed { transform: translateX(-50%) translateY(15px); width: 80px; height: 48px; padding: 0; border-radius: 100px; background: rgba(255,255,255,0.5); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .bottom-nav.collapsed .nav-item { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .bottom-nav.collapsed .bottom-nav-handle::after { opacity: 0; transform: scaleX(0); }
        .bottom-nav.collapsed .bottom-nav-handle i { opacity: 1; transform: translateY(0); }
        @media (min-width: 1024px) { .bottom-nav { display: none; } }
        .nav-item { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; width: 55px; height: 100%; text-decoration: none; z-index: 1; transition: all 0.6s cubic-bezier(0.19,1,0.22,1); }
        .nav-item::before { content: ''; position: absolute; top: 50%; left: 50%; width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 16px; transform: translate(-50%,-50%) scale(0); opacity: 0; z-index: -1; transition: all 0.5s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 8px 16px rgba(79,70,229,0.3); }
        .nav-item.active { color: white; transform: translateY(-8px); }
        .nav-item.active::before { transform: translate(-50%,-60%) scale(1); opacity: 1; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; }
        .nav-item.active span { opacity: 1; transform: translateY(2px); color: #4f46e5; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 8px; font-size: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        @media (max-width: 768px) { .container { padding-bottom: 100px; } }

        /* Toast */
        #toast { position: fixed; top: 20px; right: 20px; z-index: 99999; }
        .toast-enter { animation: toast-in 0.5s ease-out forwards; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* QR Modal */
        #qr-modal.hidden { display: none; }
        .modal-hidden { display: none !important; }

        /* Attach menu */
        .attach-menu {
            display: none;
            position: fixed;
            background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 8px; grid-template-columns: repeat(3, 1fr); gap: 4px;
            min-width: 200px; z-index: 10000;
        }
        .attach-menu.open { display: grid !important; }
        .attach-menu-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 10px 8px; border-radius: 12px; cursor: pointer; transition: background 0.15s;
            font-size: 0.7rem; color: #6b7280; font-weight: 600;
        }
        .attach-menu-item:hover { background: #f3f4f6; }
        .attach-menu-item .icon-circle {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 1rem;
        }

        /* Shortcuts popup */
        .shortcuts-popup {
            position: fixed;
            background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            max-height: 200px; overflow-y: auto; z-index: 10000;
            width: 300px;
        }
        .shortcut-item {
            padding: 10px 14px; cursor: pointer; transition: background 0.1s;
            border-bottom: 1px solid #f3f4f6;
        }
        .shortcut-item:hover { background: #f0fdf4; }
        .shortcut-item:last-child { border-bottom: none; }

        /* Audio recording */
        .recording-indicator {
            display: flex; align-items: center; gap: 8px; color: #ef4444; font-size: 0.85rem;
            animation: recording-pulse 1.2s infinite;
        }
        @keyframes recording-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Media preview in messages */
        .media-bubble img, .media-bubble video { max-width: 100%; border-radius: 8px; cursor: pointer; }
        .media-bubble audio { width: 100%; max-width: 280px; }

        /* Catalog grid */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .catalog-item {
            background: white; border-radius: 12px; overflow: hidden; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s;
        }
        .catalog-item:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .catalog-item img { width: 100%; height: 120px; object-fit: cover; }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto p-4 md:p-6 relative z-10 max-w-7xl">

        <!-- Header -->
        <header class="glassmorphism p-4 rounded-xl mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            <div class="flex items-center gap-3">
                <!-- Desktop back -->
                <button onclick="window.location.href='./Dashboard.html'" class="hidden lg:flex bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-colors items-center justify-center" title="Dashboard">
                    <i class="fa-solid fa-house"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fab fa-whatsapp text-[var(--wa-green)]"></i>
                        <span>WhatsApp</span>
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="status-dot disconnected" id="connection-status-dot"></span>
                        <span class="text-xs text-gray-500" id="connection-status-text">Verificando...</span>
                    </div>
                </div>
            </div>

            <!-- Instance Tabs -->
            <div class="flex items-center gap-2" id="instance-tabs">
                <button class="instance-tab active" data-instance="aero-festas">
                    Aero Festas <span class="ml-1 text-xs" id="badge-aero-festas"></span>
                </button>
                <button class="instance-tab" data-instance="abc-festas">
                    ABC Festas <span class="ml-1 text-xs" id="badge-abc-festas"></span>
                </button>
            </div>

            <!-- Admin connect button -->
            <button id="connect-btn" class="hidden shiny-btn text-sm py-2 px-4 rounded-lg font-bold">
                <i class="fas fa-qrcode mr-1"></i> Conectar
            </button>
        </header>

        <!-- Main Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4" style="height: calc(100vh - 220px);">

            <!-- Conversation List -->
            <div id="conversation-panel" class="lg:col-span-4 glassmorphism rounded-xl overflow-hidden flex flex-col">
                <div class="p-3 border-b border-gray-200/50">
                    <div class="relative">
                        <input type="text" id="search-conversations" placeholder="Buscar conversa..."
                            class="form-input w-full pl-10 pr-4 py-2.5 rounded-xl text-sm">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div id="conversation-list" class="flex-1 overflow-y-auto">
                    <div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                            <p>Carregando conversas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div id="chat-panel" class="lg:col-span-8 glassmorphism rounded-xl overflow-hidden flex-col hidden lg:flex">
                <!-- Chat Header -->
                <div id="chat-header" class="p-3 border-b border-gray-200/50 flex items-center justify-between bg-white/30">
                    <div class="flex items-center gap-3">
                        <button id="back-to-list-btn" class="lg:hidden text-gray-500 hover:text-gray-700 p-1">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </button>
                        <div class="w-10 h-10 rounded-full bg-[var(--wa-green)] flex items-center justify-center text-white font-bold overflow-hidden" id="chat-avatar">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div>
                            <h3 id="chat-contact-name" class="font-semibold text-gray-900 text-sm"></h3>
                            <p id="chat-contact-phone" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="link-crm-btn" class="hidden text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 font-semibold transition">
                            <i class="fas fa-users mr-1"></i> CRM
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-area" class="flex-1 overflow-y-auto p-4 space-y-2" style="background: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22><rect fill=%22%23f0f2f5%22 width=%2220%22 height=%2220%22/><circle fill=%22%23e8e8e8%22 cx=%2210%22 cy=%2210%22 r=%221%22/></svg>') repeat;">
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>
                </div>

                <!-- Loading more indicator -->
                <div id="loading-more" class="hidden text-center py-2 text-xs text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-1"></i> Carregando mais mensagens...
                </div>

                <!-- Input Bar -->
                <div id="input-bar" class="hidden p-3 border-t border-gray-200/50 bg-white/50">
                    <div class="relative flex items-end gap-2">
                        <button id="attach-btn" class="text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center flex-shrink-0 rounded-full hover:bg-gray-100 transition" title="Anexar">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        <textarea id="message-input" rows="1" placeholder="Digite uma mensagem ou / para atalhos..."
                            class="form-input flex-1 resize-none text-sm rounded-2xl px-4 py-2.5 max-h-32"
                            style="field-sizing: content;"></textarea>
                        <button id="send-btn" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="display:none;">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                        <button id="audio-btn" class="text-gray-400 hover:text-[var(--wa-green)] w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 hover:bg-green-50 transition" title="Gravar √°udio">
                            <i class="fas fa-microphone text-lg"></i>
                        </button>
                    </div>
                    <!-- Recording UI (hidden by default) -->
                    <div id="recording-bar" class="items-center gap-3 py-2" style="display:none !important;">
                        <button id="cancel-recording" class="text-red-500 hover:text-red-700 w-10 h-10 flex items-center justify-center"><i class="fas fa-trash"></i></button>
                        <div class="recording-indicator flex-1"><i class="fas fa-circle text-xs"></i> <span id="recording-time">0:00</span> ‚Äî Gravando...</div>
                        <button id="send-recording" class="shiny-btn w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                    <!-- Hidden file inputs -->
                    <input type="file" id="file-input-image" accept="image/*" class="hidden">
                    <input type="file" id="file-input-video" accept="video/*" class="hidden">
                    <input type="file" id="file-input-document" accept="*/*" class="hidden">
                </div>
            </div>
        </main>
    </div>

    <!-- Catalog Modal -->
    <div id="catalog-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-store text-green-600 mr-2"></i>Cat√°logo</h3>
                <button id="close-catalog-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="catalog-content" class="flex-1 overflow-y-auto">
                <div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando cat√°logo...</p></div>
            </div>
        </div>
    </div>

    <!-- Shortcuts popup (fixed, outside overflow containers) -->
    <div id="shortcuts-popup" class="shortcuts-popup" style="display:none !important;"></div>

    <!-- Attach Menu (fixed, outside overflow containers) -->
    <div id="attach-menu" class="attach-menu">
        <div class="attach-menu-item" data-action="image">
            <div class="icon-circle bg-purple-500"><i class="fas fa-image"></i></div>
            <span>Imagem</span>
        </div>
        <div class="attach-menu-item" data-action="video">
            <div class="icon-circle bg-red-500"><i class="fas fa-video"></i></div>
            <span>V√≠deo</span>
        </div>
        <div class="attach-menu-item" data-action="document">
            <div class="icon-circle bg-blue-500"><i class="fas fa-file"></i></div>
            <span>Documento</span>
        </div>
        <div class="attach-menu-item" data-action="catalog">
            <div class="icon-circle bg-green-600"><i class="fas fa-store"></i></div>
            <span>Cat√°logo</span>
        </div>
        <div class="attach-menu-item" data-action="shortcuts-manage">
            <div class="icon-circle bg-amber-500"><i class="fas fa-bolt"></i></div>
            <span>Atalhos</span>
        </div>
    </div>

    <!-- Shortcuts Manager Modal -->
    <div id="shortcuts-modal" class="modal-hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col" style="background: rgba(255,255,255,0.95);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold"><i class="fas fa-bolt text-amber-500 mr-2"></i>Atalhos R√°pidos</h3>
                <button id="close-shortcuts-modal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <button id="add-shortcut-btn" class="w-full mb-3 py-2 px-4 bg-amber-50 text-amber-700 rounded-xl text-sm font-semibold hover:bg-amber-100 transition">
                <i class="fas fa-plus mr-1"></i> Novo Atalho
            </button>
            <div id="shortcuts-list" class="flex-1 overflow-y-auto space-y-2">
                <p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>
            </div>
            <!-- Add/Edit form (hidden) -->
            <div id="shortcut-form" class="border-t border-gray-200 pt-3 mt-3" style="display:none;">
                <h4 class="text-sm font-bold mb-2" id="shortcut-form-title">Novo Atalho</h4>
                <input type="hidden" id="shortcut-edit-id">
                <div class="space-y-2">
                    <div>
                        <label class="text-xs text-gray-500">Comando (ex: futebol)</label>
                        <input type="text" id="shortcut-cmd" class="form-input w-full text-sm" placeholder="futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">T√≠tulo</label>
                        <input type="text" id="shortcut-title" class="form-input w-full text-sm" placeholder="Pacote Futebol">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Mensagem</label>
                        <textarea id="shortcut-content" rows="3" class="form-input w-full text-sm resize-none" placeholder="Ol√°! Temos o pacote futebol..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button id="save-shortcut" class="flex-1 shiny-btn py-2 rounded-lg text-sm font-bold">Salvar</button>
                        <button id="cancel-shortcut" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Preview Modal (before sending) -->
    <div id="media-preview-modal" class="modal-hidden fixed inset-0 bg-black/80 z-[20000] flex items-center justify-center p-4">
        <div class="bg-white p-5 rounded-2xl max-w-md w-full">
            <div id="media-preview-content" class="mb-3 flex justify-center max-h-[50vh] overflow-hidden rounded-xl bg-gray-100">
            </div>
            <input type="text" id="media-caption" class="form-input w-full text-sm mb-3" placeholder="Legenda (opcional)">
            <p class="text-xs text-gray-400 mb-3" id="media-file-info"></p>
            <div class="flex gap-2">
                <button id="confirm-send-media" class="flex-1 shiny-btn py-2.5 rounded-xl text-sm font-bold"><i class="fas fa-paper-plane mr-1"></i> Enviar</button>
                <button id="cancel-send-media" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold hover:bg-gray-200">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black/50 z-[20000] flex items-center justify-center p-4">
        <div class="glassmorphism p-8 rounded-2xl max-w-sm w-full text-center" style="background: rgba(255,255,255,0.95);">
            <h3 class="text-lg font-bold mb-2">
                <i class="fab fa-whatsapp text-[var(--wa-green)] mr-2"></i>Conectar WhatsApp
            </h3>
            <p class="text-sm text-gray-500 mb-4" id="qr-instance-name"></p>
            <div id="qr-container" class="mx-auto mb-4 flex items-center justify-center min-h-[264px]">
                <div class="text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Gerando QR Code...</p>
                </div>
            </div>
            <p class="text-xs text-gray-500">Abra o WhatsApp no celular &gt; Dispositivos conectados &gt; Conectar dispositivo</p>
            <button id="close-qr-modal" class="mt-4 text-gray-500 hover:text-gray-700 text-sm font-semibold">
                <i class="fas fa-times mr-1"></i> Fechar
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 z-[99999] bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center gap-3 toast-enter">
        <i id="toast-icon" class="text-lg"></i>
        <p id="toast-message" class="text-sm"></p>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav active" id="main-bottom-nav">
        <div class="bottom-nav-handle" id="bottom-nav-handle"><i class="fas fa-chevron-up"></i></div>
        <a href="./Dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>In√≠cio</span></a>
        <a href="./Agenda de eventos.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a>
        <a href="./Sistema Gest√£o Financeira.html" class="nav-item"><i class="fas fa-wallet"></i><span>Financeiro</span></a>
        <a href="./Sistema de CRM.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
        <a href="#" class="nav-item active"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></a>
    </nav>

    <script type="module">
        import { getToken } from './js/auth.js';
        import { API_BASE_URL } from './js/api.js';

        const BASE = `${API_BASE_URL}/api/whatsapp`;
        const token = getToken();
        const headers = () => ({ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' });

        // --- STATE ---
        let currentInstance = new URLSearchParams(window.location.search).get('instance') || 'aero-festas';
        let conversations = [];
        let currentConversationId = null;
        let currentConversation = null;
        let messages = [];
        let messagesPage = 1;
        let isLoadingMore = false;
        let hasMoreMessages = true;
        let pollInterval = null;
        let instances = [];
        let userData = null;

        try { userData = JSON.parse(localStorage.getItem('userData')); } catch(e) {}

        // --- API ---
        const api = {
            getInstances: async () => {
                try { const r = await fetch(`${BASE}/instances`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            getConversations: async (instance, search = '') => {
                try {
                    const params = new URLSearchParams({ instance, search, limit: '100' });
                    const r = await fetch(`${BASE}/conversations?${params}`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            getMessages: async (convId, page = 1) => {
                try {
                    const r = await fetch(`${BASE}/conversations/${convId}/messages?page=${page}&limit=50`, { headers: headers() });
                    return r.ok ? await r.json() : [];
                } catch(e) { return []; }
            },
            send: async (instanceName, remoteJid, text) => {
                try {
                    const r = await fetch(`${BASE}/send`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, text })
                    });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            sendMedia: async (instanceName, remoteJid, mediaType, media, caption, fileName, mimetype) => {
                try {
                    const r = await fetch(`${BASE}/send-media`, {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ instanceName, remoteJid, mediaType, media, caption, fileName, mimetype })
                    });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getCatalog: async (instanceName) => {
                try { const r = await fetch(`${BASE}/catalog/${instanceName}`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            sendCatalog: async (data) => {
                try {
                    const r = await fetch(`${BASE}/send-catalog`, { method: 'POST', headers: headers(), body: JSON.stringify(data) });
                    return r.ok ? await r.json() : null;
                } catch(e) { return null; }
            },
            getShortcuts: async () => {
                try { const r = await fetch(`${BASE}/shortcuts`, { headers: headers() }); return r.ok ? await r.json() : []; } catch(e) { return []; }
            },
            createShortcut: async (data) => {
                try { const r = await fetch(`${BASE}/shortcuts`, { method: 'POST', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            updateShortcut: async (id, data) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'PUT', headers: headers(), body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            deleteShortcut: async (id) => {
                try { const r = await fetch(`${BASE}/shortcuts/${id}`, { method: 'DELETE', headers: headers() }); return r.ok; } catch(e) { return false; }
            },
            markRead: async (convId) => {
                try { await fetch(`${BASE}/conversations/${convId}/read`, { method: 'PUT', headers: headers() }); } catch(e) {}
            },
            getUnreadCount: async () => {
                try { const r = await fetch(`${BASE}/unread-count`, { headers: headers() }); return r.ok ? await r.json() : {}; } catch(e) { return {}; }
            },
            connect: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/connect`, { method: 'POST', headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getQR: async (name) => {
                try { const r = await fetch(`${BASE}/instances/${name}/qr`, { headers: headers() }); return r.ok ? await r.json() : null; } catch(e) { return null; }
            },
            getProfilePic: async (instanceName, number) => {
                try { const r = await fetch(`${BASE}/profile-pic/${instanceName}/${number}`, { headers: headers() }); return r.ok ? await r.json() : { profilePicUrl: null }; } catch(e) { return { profilePicUrl: null }; }
            },
            downloadMedia: async (messageId) => {
                try {
                    const r = await fetch(`${BASE}/download-media`, { method: 'POST', headers: headers(), body: JSON.stringify({ messageId }) });
                    return r.ok ? await r.json() : { mediaUrl: null };
                } catch(e) { return { mediaUrl: null }; }
            }
        };

        // --- SHORTCUTS STATE ---
        let shortcuts = [];

        // --- PROFILE PIC CACHE ---
        const profilePicCache = {}; // { phoneNumber: url | null }

        // --- HELPERS ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatTime(dateStr) {
            return new Date(dateStr).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatRelative(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const diff = now - d;
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today - 86400000);

            if (d >= today) return formatTime(dateStr);
            if (d >= yesterday) return 'Ontem';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').filter(n => n).map(n => n[0]).slice(0, 2).join('').toUpperCase();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            const icon = document.getElementById('toast-icon');
            icon.className = isError ? 'fas fa-exclamation-circle text-red-500 text-lg' : 'fas fa-check-circle text-green-500 text-lg';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // --- RENDER: INSTANCE TABS ---
        function setupInstanceTabs() {
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentInstance = tab.dataset.instance;
                    document.querySelectorAll('.instance-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentConversationId = null;
                    currentConversation = null;
                    showChatWelcome();
                    loadConversations();
                    updateConnectionStatus();
                    // Atualiza URL sem recarregar
                    history.replaceState(null, '', `WhatsApp.html?instance=${currentInstance}`);
                });
            });
        }

        // --- RENDER: CONNECTION STATUS ---
        function updateConnectionStatus() {
            const inst = instances.find(i => i.instanceName === currentInstance);
            const dot = document.getElementById('connection-status-dot');
            const text = document.getElementById('connection-status-text');
            const connectBtn = document.getElementById('connect-btn');

            if (!inst) {
                dot.className = 'status-dot disconnected';
                text.textContent = 'N√£o configurado';
                connectBtn.classList.add('hidden');
                return;
            }

            dot.className = `status-dot ${inst.status}`;
            const statusMap = { connected: 'Conectado', disconnected: 'Desconectado', connecting: 'Conectando...', qr_pending: 'Aguardando QR...' };
            text.textContent = statusMap[inst.status] || inst.status;
            if (inst.phoneNumber) text.textContent += ` (${inst.phoneNumber})`;

            // Show connect button for admins when disconnected
            if (userData?.isAdmin && inst.status !== 'connected') {
                connectBtn.classList.remove('hidden');
                connectBtn.onclick = () => showQRModal(currentInstance);
            } else {
                connectBtn.classList.add('hidden');
            }
        }

        // --- RENDER: CONVERSATION LIST ---
        function renderConversationList() {
            const listEl = document.getElementById('conversation-list');
            const search = document.getElementById('search-conversations').value.toLowerCase().trim();

            let filtered = conversations;
            if (search) {
                filtered = conversations.filter(c =>
                    (c.contactName || '').toLowerCase().includes(search) ||
                    c.phoneNumber.includes(search.replace(/\D/g, ''))
                );
            }

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 text-sm p-4">
                    <div class="text-center">
                        <i class="fab fa-whatsapp text-4xl text-gray-300 mb-2"></i>
                        <p>${search ? 'Nenhuma conversa encontrada' : 'Nenhuma conversa ainda'}</p>
                    </div>
                </div>`;
                return;
            }

            listEl.innerHTML = '';
            filtered.forEach(conv => {
                const div = document.createElement('div');
                const isActive = conv.id === currentConversationId;
                div.className = `conv-item p-3 cursor-pointer flex items-center gap-3 border-b border-gray-100/50 ${isActive ? 'active' : ''}`;

                const initials = getInitials(conv.contactName || conv.phoneNumber);
                const unread = conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount > 99 ? '99+' : conv.unreadCount}</span>` : '';
                const crmIcon = conv.clientId ? '<i class="fas fa-link text-indigo-400 text-[10px]" title="Vinculado ao CRM"></i>' : '';
                const preview = conv.lastMessagePreview || '';
                const time = formatRelative(conv.lastMessageAt);
                const cachedPic = profilePicCache[conv.phoneNumber];

                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0 overflow-hidden" data-phone="${conv.phoneNumber}">
                        ${cachedPic ? `<img src="${cachedPic}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">` : initials}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm truncate ${conv.unreadCount > 0 ? 'text-gray-900' : 'text-gray-700'}">${escapeHtml(conv.contactName || conv.phoneNumber)} ${crmIcon}</span>
                            <span class="text-[11px] text-gray-400 flex-shrink-0 ml-2">${time}</span>
                        </div>
                        <div class="flex justify-between items-center mt-0.5">
                            <p class="text-xs truncate ${conv.unreadCount > 0 ? 'text-gray-800 font-medium' : 'text-gray-500'}">${escapeHtml(preview)}</p>
                            ${unread}
                        </div>
                    </div>
                `;

                div.addEventListener('click', () => openConversation(conv));
                listEl.appendChild(div);
            });

            // Carregar fotos de perfil assincronamente
            loadProfilePics(filtered);
        }

        async function loadProfilePics(conversations) {
            for (const conv of conversations) {
                if (profilePicCache[conv.phoneNumber] !== undefined) continue; // j√° carregou (ou falhou)
                profilePicCache[conv.phoneNumber] = null; // marca como "carregando"
                try {
                    const data = await api.getProfilePic(currentInstance, conv.phoneNumber);
                    if (data.profilePicUrl) {
                        profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                        // Atualizar o avatar na lista
                        const avatarEl = document.querySelector(`[data-phone="${conv.phoneNumber}"]`);
                        if (avatarEl) {
                            const initials = getInitials(conv.contactName || conv.phoneNumber);
                            avatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                        }
                    }
                } catch (e) { /* silenciar */ }
            }
        }

        // --- OPEN CONVERSATION ---
        async function openConversation(conv) {
            currentConversationId = conv.id;
            currentConversation = conv;
            messagesPage = 1;
            hasMoreMessages = true;
            messages = [];

            // Update header
            document.getElementById('chat-contact-name').textContent = conv.contactName || conv.phoneNumber;
            document.getElementById('chat-contact-phone').textContent = conv.phoneNumber;
            const chatAvatarEl = document.getElementById('chat-avatar');
            const initials = getInitials(conv.contactName || conv.phoneNumber);
            const pic = profilePicCache[conv.phoneNumber];
            if (pic) {
                chatAvatarEl.innerHTML = `<img src="${pic}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
            } else {
                chatAvatarEl.textContent = initials;
                // Tentar carregar foto de perfil
                api.getProfilePic(currentInstance, conv.phoneNumber).then(data => {
                    if (data.profilePicUrl) {
                        profilePicCache[conv.phoneNumber] = data.profilePicUrl;
                        chatAvatarEl.innerHTML = `<img src="${data.profilePicUrl}" class="w-full h-full object-cover rounded-full" onerror="this.remove();this.parentElement.textContent='${initials}'">`;
                    }
                });
            }

            // CRM link
            const crmBtn = document.getElementById('link-crm-btn');
            if (conv.clientId) {
                crmBtn.classList.remove('hidden');
                crmBtn.onclick = () => window.open(`Sistema de CRM.html?clientId=${conv.clientId}`, '_blank');
            } else {
                crmBtn.classList.add('hidden');
            }

            // Show chat panel, hide welcome
            document.getElementById('chat-panel').classList.remove('hidden');
            document.getElementById('chat-panel').classList.add('flex');
            const welcomeEl = document.getElementById('chat-welcome');
            if (welcomeEl) welcomeEl.classList.add('hidden');
            document.getElementById('input-bar').classList.remove('hidden');

            // Mobile: hide conversation list
            document.getElementById('conversation-panel').classList.add('hidden');
            document.getElementById('conversation-panel').classList.remove('lg:flex');

            // Load messages
            await loadMessages();

            // Mark as read
            if (conv.unreadCount > 0) {
                await api.markRead(conv.id);
                conv.unreadCount = 0;
                renderConversationList();
            }

            renderConversationList();
        }

        // --- LOAD MESSAGES ---
        async function loadMessages() {
            const data = await api.getMessages(currentConversationId, messagesPage);
            if (data.length < 50) hasMoreMessages = false;

            // API returns newest first, reverse for display
            const newMsgs = data.reverse();

            if (messagesPage === 1) {
                messages = newMsgs;
            } else {
                messages = [...newMsgs, ...messages];
            }

            renderMessages(messagesPage === 1);
        }

        // --- RENDER MESSAGES ---
        function renderMediaContent(msg) {
            const url = msg.mediaUrl;
            const type = msg.messageType;
            const caption = msg.content && !msg.content.startsWith('[') ? msg.content : '';

            if (type === 'image' && url) {
                return `<div class="media-bubble"><img src="${escapeHtml(url)}" alt="imagem" loading="lazy" onclick="window.open('${escapeHtml(url)}','_blank')"></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'video' && url) {
                return `<div class="media-bubble"><video src="${escapeHtml(url)}" controls preload="metadata" style="max-height:300px;"></video></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            if (type === 'audio') {
                if (url) {
                    return `<div class="media-bubble" style="min-width:220px;"><audio src="${escapeHtml(url)}" controls preload="metadata" style="width:100%;max-width:300px;"></audio></div>`;
                }
                // Sem URL: mostra bot√£o para carregar √°udio
                return `<div class="media-bubble" style="min-width:220px;" id="audio-${escapeHtml(msg.id)}">
                    <div class="flex items-center gap-2 cursor-pointer text-green-600 hover:text-green-700" onclick="loadAudioMedia('${escapeHtml(msg.id)}')">
                        <i class="fas fa-play-circle text-2xl"></i>
                        <div>
                            <p class="text-sm font-medium">√Åudio</p>
                            <p class="text-[10px] text-gray-400">Toque para ouvir</p>
                        </div>
                        <i class="fas fa-download text-xs text-gray-400 ml-auto"></i>
                    </div>
                </div>`;
            }
            if (type === 'document' && url) {
                const name = msg.mediaName || 'Documento';
                return `<div class="flex items-center gap-2 p-2 bg-white/50 rounded-lg cursor-pointer" onclick="window.open('${escapeHtml(url)}','_blank')"><i class="fas fa-file-alt text-blue-500 text-lg"></i><div class="min-w-0"><p class="text-sm font-medium truncate">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">${msg.mediaMimetype || 'documento'}</p></div><i class="fas fa-download text-gray-400 text-xs ml-auto"></i></div>${caption ? `<p class="whitespace-pre-wrap break-words text-sm mt-1">${escapeHtml(caption)}</p>` : ''}`;
            }
            // Fallback: sem URL, apenas indicador
            const icon = type === 'image' ? 'image' : type === 'audio' ? 'microphone' : type === 'video' ? 'video' : type === 'sticker' ? 'note-sticky' : 'file';
            return `<p class="text-gray-400 italic text-xs"><i class="fas fa-${icon} mr-1"></i>${escapeHtml(msg.content)}</p>`;
        }

        // Carrega √°udio sob demanda via Evolution API
        async function loadAudioMedia(messageId) {
            const container = document.getElementById(`audio-${messageId}`);
            if (!container) return;
            container.innerHTML = `<div class="flex items-center gap-2 text-gray-400"><i class="fas fa-spinner fa-spin"></i> <span class="text-xs">Carregando √°udio...</span></div>`;

            try {
                const data = await api.downloadMedia(messageId);
                if (data.mediaUrl) {
                    container.innerHTML = `<audio src="${data.mediaUrl}" controls preload="auto" autoplay style="width:100%;max-width:300px;"></audio>`;
                    // Atualiza na lista local para n√£o precisar baixar de novo
                    const msg = messages.find(m => m.id === messageId);
                    if (msg) msg.mediaUrl = data.mediaUrl;
                } else {
                    container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>N√£o foi poss√≠vel carregar o √°udio</p>`;
                }
            } catch (e) {
                container.innerHTML = `<p class="text-red-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>Erro ao carregar √°udio</p>`;
            }
        }

        function renderMessages(scrollToBottom = true) {
            const area = document.getElementById('messages-area');
            area.innerHTML = '';

            let lastDate = null;

            messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString('pt-BR');

                if (msgDate !== lastDate) {
                    const sep = document.createElement('div');
                    sep.className = 'text-center my-3';
                    sep.innerHTML = `<span class="bg-white/80 text-gray-500 text-xs px-3 py-1 rounded-full shadow-sm">${msgDate}</span>`;
                    area.appendChild(sep);
                    lastDate = msgDate;
                }

                const bubble = document.createElement('div');
                bubble.className = `p-2.5 ${msg.fromMe ? 'bubble-sent ml-auto' : 'bubble-received mr-auto'}`;

                const time = formatTime(msg.timestamp);
                const statusIcon = msg.fromMe ? (
                    msg.status === 'read' ? '<i class="fas fa-check-double text-blue-400"></i>' :
                    msg.status === 'delivered' ? '<i class="fas fa-check-double text-gray-400"></i>' :
                    '<i class="fas fa-check text-gray-400"></i>'
                ) : '';

                const isMedia = msg.messageType !== 'text';
                const contentHtml = isMedia
                    ? renderMediaContent(msg)
                    : `<p class="whitespace-pre-wrap break-words text-sm">${escapeHtml(msg.content)}</p>`;

                bubble.innerHTML = `
                    ${contentHtml}
                    <div class="text-right mt-1 flex items-center justify-end gap-1">
                        <span class="text-[10px] text-gray-400">${time}</span>
                        <span class="text-[10px]">${statusIcon}</span>
                    </div>
                `;

                area.appendChild(bubble);
            });

            if (scrollToBottom) {
                area.scrollTop = area.scrollHeight;
            }
        }

        // --- INFINITE SCROLL (load older messages) ---
        document.getElementById('messages-area').addEventListener('scroll', async function() {
            if (this.scrollTop === 0 && hasMoreMessages && !isLoadingMore && currentConversationId) {
                isLoadingMore = true;
                document.getElementById('loading-more').classList.remove('hidden');

                const prevHeight = this.scrollHeight;
                messagesPage++;
                await loadMessages();

                // Manter scroll position
                this.scrollTop = this.scrollHeight - prevHeight;
                document.getElementById('loading-more').classList.add('hidden');
                isLoadingMore = false;
            }
        });

        // --- SEND MESSAGE ---
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentConversation) return;

            input.value = '';
            input.style.height = 'auto';
            toggleSendAudioBtn();

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(),
                fromMe: true,
                content: text,
                timestamp: new Date().toISOString(),
                messageType: 'text',
                status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            const result = await api.send(currentInstance, currentConversation.remoteJid, text);
            if (result) {
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
            } else {
                showToast('Erro ao enviar mensagem', true);
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                input.value = text;
            }
        }

        // Toggle between send button and audio button
        function toggleSendAudioBtn() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const audioBtn = document.getElementById('audio-btn');
            const hasText = input.value.trim().length > 0;
            sendBtn.style.display = hasText ? 'flex' : 'none';
            audioBtn.style.display = hasText ? 'none' : 'flex';
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        document.getElementById('message-input').addEventListener('input', function() {
            toggleSendAudioBtn();
            handleShortcutPopup(this.value);
        });

        // --- ATTACH MENU ---
        document.getElementById('attach-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('attach-menu');
            const btn = document.getElementById('attach-btn');
            const rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
            menu.classList.toggle('open');
        });
        document.addEventListener('click', () => {
            const menu = document.getElementById('attach-menu');
            menu.classList.remove('open');
        });

        document.querySelectorAll('.attach-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('attach-menu');
                menu.classList.remove('open');
                const action = item.dataset.action;
                if (action === 'image') document.getElementById('file-input-image').click();
                else if (action === 'video') document.getElementById('file-input-video').click();
                else if (action === 'document') document.getElementById('file-input-document').click();
                else if (action === 'catalog') openCatalogModal();
                else if (action === 'shortcuts-manage') openShortcutsModal();
            });
        });

        // --- FILE INPUT HANDLERS ---
        let pendingMedia = null;

        function handleFileSelect(e, mediaType) {
            const file = e.target.files[0];
            if (!file) return;
            e.target.value = '';

            const maxSize = 16 * 1024 * 1024; // 16MB
            if (file.size > maxSize) {
                showToast('Arquivo muito grande (m√°x 16MB)', true);
                return;
            }

            pendingMedia = { file, mediaType, fileName: file.name, mimetype: file.type };

            // Show preview modal
            const preview = document.getElementById('media-preview-content');
            const info = document.getElementById('media-file-info');
            const caption = document.getElementById('media-caption');
            caption.value = '';
            info.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

            if (mediaType === 'image') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<img src="${url}" style="max-height:50vh; object-fit:contain; border-radius:12px;">`;
            } else if (mediaType === 'video') {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<video src="${url}" controls style="max-height:50vh; border-radius:12px;"></video>`;
            } else {
                const icon = file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-file-alt text-blue-500';
                preview.innerHTML = `<div class="flex flex-col items-center justify-center py-8"><i class="fas ${icon} text-5xl mb-3"></i><p class="text-sm text-gray-600">${escapeHtml(file.name)}</p></div>`;
            }

            document.getElementById('media-preview-modal').classList.remove('modal-hidden');
        }

        document.getElementById('file-input-image').addEventListener('change', (e) => handleFileSelect(e, 'image'));
        document.getElementById('file-input-video').addEventListener('change', (e) => handleFileSelect(e, 'video'));
        document.getElementById('file-input-document').addEventListener('change', (e) => handleFileSelect(e, 'document'));

        document.getElementById('cancel-send-media').addEventListener('click', () => {
            document.getElementById('media-preview-modal').classList.add('modal-hidden');
            pendingMedia = null;
        });

        document.getElementById('confirm-send-media').addEventListener('click', async () => {
            if (!pendingMedia || !currentConversation) return;
            document.getElementById('media-preview-modal').classList.add('modal-hidden');

            const caption = document.getElementById('media-caption').value.trim();
            const { file, mediaType, fileName, mimetype } = pendingMedia;
            pendingMedia = null;

            // Optimistic UI
            const tempMsg = {
                id: 'temp-' + Date.now(), fromMe: true,
                content: caption || `[${mediaType}]`,
                timestamp: new Date().toISOString(), messageType: mediaType, status: 'sending'
            };
            messages.push(tempMsg);
            renderMessages(true);

            // Convert file to base64
            const base64 = await fileToBase64(file);

            const result = await api.sendMedia(
                currentInstance, currentConversation.remoteJid,
                mediaType, base64, caption || undefined, fileName, mimetype
            );

            if (result) {
                // Guardar m√≠dia localmente para preview imediato
                if (!result.mediaUrl) result.mediaUrl = `data:${mimetype};base64,${base64}`;
                const idx = messages.findIndex(m => m.id === tempMsg.id);
                if (idx >= 0) messages[idx] = result;
                renderMessages(true);
                showToast('M√≠dia enviada!');
            } else {
                messages = messages.filter(m => m.id !== tempMsg.id);
                renderMessages(true);
                showToast('Erro ao enviar m√≠dia', true);
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove o prefixo data:xxx;base64, ‚Äî Evolution API quer raw base64
                    const result = reader.result.split(',')[1];
                    resolve(result);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- AUDIO RECORDING ---
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;

        document.getElementById('audio-btn').addEventListener('click', startRecording);

        async function startRecording() {
            if (!currentConversation) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => { stream.getTracks().forEach(t => t.stop()); };
                mediaRecorder.start();

                // Show recording UI
                document.querySelector('#input-bar .relative').style.setProperty('display', 'none', 'important');
                document.getElementById('recording-bar').style.setProperty('display', 'flex', 'important');
                recordingSeconds = 0;
                document.getElementById('recording-time').textContent = '0:00';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const m = Math.floor(recordingSeconds / 60);
                    const s = (recordingSeconds % 60).toString().padStart(2, '0');
                    document.getElementById('recording-time').textContent = `${m}:${s}`;
                }, 1000);
            } catch (err) {
                showToast('N√£o foi poss√≠vel acessar o microfone', true);
            }
        }

        document.getElementById('cancel-recording').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            stopRecordingUI();
        });

        document.getElementById('send-recording').addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

            mediaRecorder.onstop = async () => {
                mediaRecorder.stream?.getTracks().forEach(t => t.stop());
                stopRecordingUI();

                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const base64 = await blobToBase64(blob);

                // Optimistic UI
                const tempMsg = {
                    id: 'temp-' + Date.now(), fromMe: true,
                    content: '[audio]', timestamp: new Date().toISOString(),
                    messageType: 'audio', status: 'sending'
                };
                messages.push(tempMsg);
                renderMessages(true);

                const result = await api.sendMedia(
                    currentInstance, currentConversation.remoteJid,
                    'audio', base64, undefined, 'audio.ogg', 'audio/ogg'
                );

                if (result) {
                    // Guardar o √°udio localmente para poder reproduzir
                    if (!result.mediaUrl) result.mediaUrl = `data:audio/webm;base64,${base64}`;
                    const idx = messages.findIndex(m => m.id === tempMsg.id);
                    if (idx >= 0) messages[idx] = result;
                    renderMessages(true);
                } else {
                    messages = messages.filter(m => m.id !== tempMsg.id);
                    renderMessages(true);
                    showToast('Erro ao enviar √°udio', true);
                }
            };
            mediaRecorder.stop();
        });

        function stopRecordingUI() {
            clearInterval(recordingTimer);
            document.querySelector('#input-bar .relative').style.setProperty('display', 'flex', 'important');
            document.getElementById('recording-bar').style.setProperty('display', 'none', 'important');
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // --- SHORTCUTS POPUP (when typing /) ---
        function handleShortcutPopup(value) {
            const popup = document.getElementById('shortcuts-popup');
            if (!value.startsWith('/') || value.includes(' ')) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }
            const query = value.slice(1).toLowerCase();
            const filtered = shortcuts.filter(s => s.command.startsWith(query));

            if (filtered.length === 0 && query === '') {
                // Posicionar e mostrar dica
                const input = document.getElementById('message-input');
                const inputRect = input.getBoundingClientRect();
                popup.style.left = inputRect.left + 'px';
                popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
                popup.style.width = inputRect.width + 'px';
                popup.style.setProperty('display', 'block', 'important');
                popup.innerHTML = `<div class="p-3 text-center text-gray-400 text-xs">
                    <p>Nenhum atalho configurado.</p>
                    <p class="mt-1">Use o menu <i class="fas fa-paperclip"></i> ‚Üí <i class="fas fa-bolt"></i> Atalhos para criar.</p>
                </div>`;
                return;
            }
            if (filtered.length === 0) {
                popup.style.setProperty('display', 'none', 'important');
                return;
            }

            // Posicionar o popup acima do textarea
            const input = document.getElementById('message-input');
            const inputRect = input.getBoundingClientRect();
            popup.style.left = inputRect.left + 'px';
            popup.style.bottom = (window.innerHeight - inputRect.top + 4) + 'px';
            popup.style.width = inputRect.width + 'px';

            popup.style.setProperty('display', 'block', 'important');
            popup.innerHTML = filtered.map(s => `
                <div class="shortcut-item" data-command="${escapeHtml(s.command)}">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-green-700">/${escapeHtml(s.command)}</span>
                        <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate mt-0.5">${escapeHtml(s.content.substring(0, 80))}</p>
                </div>
            `).join('');

            popup.querySelectorAll('.shortcut-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cmd = item.dataset.command;
                    const shortcut = shortcuts.find(s => s.command === cmd);
                    if (shortcut) {
                        document.getElementById('message-input').value = shortcut.content;
                        toggleSendAudioBtn();
                    }
                    popup.style.setProperty('display', 'none', 'important');
                });
            });
        }

        // --- CATALOG MODAL ---
        async function openCatalogModal() {
            if (!currentConversation) { showToast('Selecione uma conversa primeiro', true); return; }
            document.getElementById('catalog-modal').classList.remove('modal-hidden');
            const content = document.getElementById('catalog-content');
            content.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Carregando cat√°logo...</p></div>';

            const catalog = await api.getCatalog(currentInstance);
            if (!catalog || (Array.isArray(catalog) && catalog.length === 0)) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto no cat√°logo.</p><p class="text-gray-400 text-xs mt-1">Configure o cat√°logo no WhatsApp Business do celular.</p></div>';
                return;
            }

            const products = Array.isArray(catalog) ? catalog : (catalog.products || catalog.data || [catalog]);
            if (products.length === 0) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-store text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 text-sm">Nenhum produto encontrado.</p></div>';
                return;
            }

            content.innerHTML = `<div class="catalog-grid">${products.map((p, i) => {
                const name = p.name || p.title || `Produto ${i+1}`;
                const img = p.imageUrl || p.image || p.thumbnailUrl || '';
                const price = p.price ? `R$ ${(p.price / 100).toFixed(2)}` : '';
                return `<div class="catalog-item" data-idx="${i}">
                    ${img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy">` : '<div class="h-[120px] bg-gray-100 flex items-center justify-center"><i class="fas fa-image text-2xl text-gray-300"></i></div>'}
                    <div class="p-2">
                        <p class="text-xs font-semibold truncate">${escapeHtml(name)}</p>
                        ${price ? `<p class="text-xs text-green-600 font-bold">${price}</p>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;

            content.querySelectorAll('.catalog-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const idx = parseInt(item.dataset.idx);
                    const p = products[idx];
                    document.getElementById('catalog-modal').classList.add('modal-hidden');

                    const tempMsg = {
                        id: 'temp-' + Date.now(), fromMe: true,
                        content: `üì¶ ${p.name || 'Produto'}`,
                        timestamp: new Date().toISOString(), messageType: 'text', status: 'sending'
                    };
                    messages.push(tempMsg);
                    renderMessages(true);

                    const result = await api.sendCatalog({
                        instanceName: currentInstance,
                        remoteJid: currentConversation.remoteJid,
                        productName: p.name || p.title,
                        productImage: p.imageUrl || p.image || p.thumbnailUrl,
                        productUrl: p.url || '',
                        caption: p.description || ''
                    });

                    if (result) {
                        const idx2 = messages.findIndex(m => m.id === tempMsg.id);
                        if (idx2 >= 0) messages[idx2] = result;
                        renderMessages(true);
                        showToast('Produto enviado!');
                    } else {
                        messages = messages.filter(m => m.id !== tempMsg.id);
                        renderMessages(true);
                        showToast('Erro ao enviar produto', true);
                    }
                });
            });
        }

        document.getElementById('close-catalog-modal').addEventListener('click', () => {
            document.getElementById('catalog-modal').classList.add('modal-hidden');
        });

        // --- SHORTCUTS MANAGER MODAL ---
        async function openShortcutsModal() {
            document.getElementById('shortcuts-modal').classList.remove('modal-hidden');
            document.getElementById('shortcut-form').style.display = 'none';
            await loadShortcuts();
            renderShortcutsList();
        }

        async function loadShortcuts() {
            shortcuts = await api.getShortcuts();
        }

        function renderShortcutsList() {
            const list = document.getElementById('shortcuts-list');
            if (shortcuts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">Nenhum atalho configurado</p>';
                return;
            }
            list.innerHTML = shortcuts.map(s => `
                <div class="bg-gray-50 rounded-xl p-3 flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-green-700">/${escapeHtml(s.command)}</span>
                            <span class="text-xs text-gray-400">${escapeHtml(s.title)}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(s.content.substring(0, 100))}</p>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button class="text-blue-500 hover:text-blue-700 p-1" onclick="editShortcut('${s.id}')"><i class="fas fa-pen text-xs"></i></button>
                        <button class="text-red-400 hover:text-red-600 p-1" onclick="deleteShortcut('${s.id}')"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Expose to global scope for onclick
        window.editShortcut = function(id) {
            const s = shortcuts.find(x => x.id === id);
            if (!s) return;
            document.getElementById('shortcut-edit-id').value = id;
            document.getElementById('shortcut-cmd').value = s.command;
            document.getElementById('shortcut-title').value = s.title;
            document.getElementById('shortcut-content').value = s.content;
            document.getElementById('shortcut-form-title').textContent = 'Editar Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        };

        window.deleteShortcut = async function(id) {
            if (!confirm('Remover este atalho?')) return;
            const ok = await api.deleteShortcut(id);
            if (ok) { await loadShortcuts(); renderShortcutsList(); showToast('Atalho removido'); }
            else showToast('Erro ao remover', true);
        };

        document.getElementById('close-shortcuts-modal').addEventListener('click', () => {
            document.getElementById('shortcuts-modal').classList.add('modal-hidden');
        });

        document.getElementById('add-shortcut-btn').addEventListener('click', () => {
            document.getElementById('shortcut-edit-id').value = '';
            document.getElementById('shortcut-cmd').value = '';
            document.getElementById('shortcut-title').value = '';
            document.getElementById('shortcut-content').value = '';
            document.getElementById('shortcut-form-title').textContent = 'Novo Atalho';
            document.getElementById('shortcut-form').style.display = 'block';
        });

        document.getElementById('cancel-shortcut').addEventListener('click', () => {
            document.getElementById('shortcut-form').style.display = 'none';
        });

        document.getElementById('save-shortcut').addEventListener('click', async () => {
            const id = document.getElementById('shortcut-edit-id').value;
            const data = {
                command: document.getElementById('shortcut-cmd').value.trim(),
                title: document.getElementById('shortcut-title').value.trim(),
                content: document.getElementById('shortcut-content').value.trim()
            };
            if (!data.command || !data.title || !data.content) {
                showToast('Preencha todos os campos', true);
                return;
            }
            const result = id ? await api.updateShortcut(id, data) : await api.createShortcut(data);
            if (result) {
                await loadShortcuts();
                renderShortcutsList();
                document.getElementById('shortcut-form').style.display = 'none';
                showToast(id ? 'Atalho atualizado' : 'Atalho criado');
            } else {
                showToast('Erro ao salvar atalho', true);
            }
        });

        // --- BACK BUTTON (mobile) ---
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('conversation-panel').classList.remove('hidden');
            document.getElementById('conversation-panel').classList.add('lg:flex');
            document.getElementById('chat-panel').classList.add('hidden');
            document.getElementById('chat-panel').classList.remove('flex');
            currentConversationId = null;
        });

        // --- SHOW CHAT WELCOME ---
        function showChatWelcome() {
            const messagesArea = document.getElementById('messages-area');
            const welcomeEl = document.getElementById('chat-welcome');
            document.getElementById('input-bar').classList.add('hidden');
            document.getElementById('chat-contact-name').textContent = '';
            document.getElementById('chat-contact-phone').textContent = '';

            // Preserve chat-welcome before clearing
            if (welcomeEl) {
                messagesArea.innerHTML = '';
                messagesArea.appendChild(welcomeEl);
                welcomeEl.classList.remove('hidden');
            } else {
                messagesArea.innerHTML = `
                    <div id="chat-welcome" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fab fa-whatsapp text-6xl text-gray-200 mb-4"></i>
                            <p class="text-lg font-medium">Selecione uma conversa</p>
                            <p class="text-sm mt-1">As mensagens aparecem aqui</p>
                        </div>
                    </div>`;
            }

            // Desktop: show chat panel but with welcome
            document.getElementById('chat-panel').classList.remove('hidden');
            document.getElementById('chat-panel').classList.add('flex');
        }

        // --- QR CODE MODAL ---
        let qrPollInterval = null;

        async function showQRModal(instanceName) {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-container');
            document.getElementById('qr-instance-name').textContent = instanceName === 'aero-festas' ? 'Aero Festas' : 'ABC Festas';

            modal.classList.remove('hidden');
            container.innerHTML = '<div class="text-gray-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-sm">Gerando QR Code...</p></div>';

            const data = await api.connect(instanceName);
            if (data?.base64) {
                container.innerHTML = `<img src="${data.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else if (data?.code) {
                container.innerHTML = `<img src="data:image/png;base64,${data.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
            } else {
                container.innerHTML = '<p class="text-red-500 text-sm">Erro ao gerar QR Code. Verifique se a Evolution API est√° ativa.</p>';
            }

            // Poll para QR atualizado
            qrPollInterval = setInterval(async () => {
                const inst = instances.find(i => i.instanceName === instanceName);
                if (inst) {
                    const refreshedInstances = await api.getInstances();
                    instances = refreshedInstances;
                    const updated = refreshedInstances.find(i => i.instanceName === instanceName);
                    if (updated?.status === 'connected') {
                        clearInterval(qrPollInterval);
                        modal.classList.add('hidden');
                        showToast('WhatsApp conectado com sucesso!');
                        updateConnectionStatus();
                        return;
                    }
                }
                // Atualiza QR
                const qrData = await api.getQR(instanceName);
                if (qrData?.base64) {
                    container.innerHTML = `<img src="${qrData.base64}" class="mx-auto" style="width: 264px; height: 264px;">`;
                } else if (qrData?.code) {
                    container.innerHTML = `<img src="data:image/png;base64,${qrData.code}" class="mx-auto" style="width: 264px; height: 264px;">`;
                }
            }, 5000);
        }

        document.getElementById('close-qr-modal').addEventListener('click', () => {
            document.getElementById('qr-modal').classList.add('hidden');
            if (qrPollInterval) clearInterval(qrPollInterval);
        });

        // --- SEARCH ---
        document.getElementById('search-conversations').addEventListener('input', renderConversationList);

        // --- UNREAD BADGES ---
        async function updateUnreadBadges() {
            const counts = await api.getUnreadCount();
            ['aero-festas', 'abc-festas'].forEach(name => {
                const badge = document.getElementById(`badge-${name}`);
                if (badge) {
                    const count = counts[name] || 0;
                    badge.textContent = count > 0 ? `(${count > 99 ? '99+' : count})` : '';
                }
            });
        }

        // --- LOAD CONVERSATIONS ---
        async function loadConversations() {
            conversations = await api.getConversations(currentInstance);
            renderConversationList();
        }

        // --- POLLING ---
        function startPolling() {
            pollInterval = setInterval(async () => {
                await loadConversations();
                await updateUnreadBadges();

                // Refresh current conversation messages
                if (currentConversationId && messagesPage === 1) {
                    const freshMsgs = await api.getMessages(currentConversationId, 1);
                    const newMsgs = freshMsgs.reverse();
                    if (newMsgs.length > 0 && messages.length > 0) {
                        const lastKnown = messages[messages.length - 1];
                        const hasNew = newMsgs.some(m => m.id !== lastKnown.id && new Date(m.timestamp) > new Date(lastKnown.timestamp));
                        // Check status changes (delivered, read)
                        const hasStatusChange = messages.some(m => {
                            const fresh = newMsgs.find(f => f.id === m.id);
                            return fresh && fresh.status !== m.status;
                        });
                        if (hasNew || hasStatusChange) {
                            // Preserve locally-stored mediaUrl for sent media
                            for (const nm of newMsgs) {
                                if (!nm.mediaUrl) {
                                    const existing = messages.find(m => m.id === nm.id);
                                    if (existing?.mediaUrl) nm.mediaUrl = existing.mediaUrl;
                                }
                            }
                            messages = newMsgs;
                            renderMessages(hasNew); // scroll only if new msg
                            if (hasNew) {
                                const conv = conversations.find(c => c.id === currentConversationId);
                                if (conv?.unreadCount > 0) {
                                    await api.markRead(currentConversationId);
                                    conv.unreadCount = 0;
                                    renderConversationList();
                                }
                            }
                        }
                    } else if (messages.length === 0 && newMsgs.length > 0) {
                        messages = newMsgs;
                        renderMessages(true);
                    }
                }

                // Update instance status
                instances = await api.getInstances();
                updateConnectionStatus();
            }, 5000);
        }

        // --- INIT ---
        async function init() {
            instances = await api.getInstances();
            shortcuts = await api.getShortcuts();

            // Set active tab based on URL
            document.querySelectorAll('.instance-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.instance === currentInstance);
            });

            updateConnectionStatus();
            setupInstanceTabs();
            await loadConversations();
            await updateUnreadBadges();
            showChatWelcome();
            startPolling();

            // Handle URL parameter for conversation
            const urlConv = new URLSearchParams(window.location.search).get('conversation');
            if (urlConv) {
                const conv = conversations.find(c => c.id === urlConv);
                if (conv) openConversation(conv);
            }

            document.title = `WhatsApp - ${currentInstance === 'aero-festas' ? 'Aero Festas' : 'ABC Festas'}`;
        }

        init();
    </script>

    <!-- Bottom Nav Collapse -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNav = document.getElementById('main-bottom-nav');
            const handle = document.getElementById('bottom-nav-handle');
            if (bottomNav) {
                const toggleNav = (e) => { e.stopPropagation(); bottomNav.classList.toggle('collapsed'); };
                handle?.addEventListener('click', toggleNav);
                bottomNav.addEventListener('click', (e) => { if (bottomNav.classList.contains('collapsed')) toggleNav(e); });
            }
        });
    </script>

    <script src="js/protect.js"></script>
</body>
</html>
